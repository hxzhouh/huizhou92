<!DOCTYPE html>
<html lang="en" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name="baidu-site-verification" content="codeva-3VTxLtnqFP" /><meta name='description' content="Practical Tips and Best Practices for Enhancing Reflection Performance">
<title>Golang High-Performance Programming EP4 : reflect</title>

<link rel='canonical' href='https://huizhou92.com/p/golang-high-performance-programming-ep4-reflect/'>

<link rel="stylesheet" href="/scss/style.min.0304c6baf04e01a8fe70693791cb744d56a3578a3120a8796cefc66825aa39c7.css"><meta property='og:title' content="Golang High-Performance Programming EP4 : reflect">
<meta property='og:description' content="Practical Tips and Best Practices for Enhancing Reflection Performance">
<meta property='og:url' content='https://huizhou92.com/p/golang-high-performance-programming-ep4-reflect/'>
<meta property='og:site_name' content='huizhou92&#39;s Blog'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='go' /><meta property='article:published_time' content='2024-07-11T11:03:15&#43;08:00'/><meta property='article:modified_time' content='2024-07-11T11:03:04&#43;08:00'/><meta property='og:image' content='https://images.hxzhouh.com/blog-images/2024/07/fafe2d9c964dbdd44c76d86834fd745b.png' />
<meta name="twitter:site" content="@https://x.com/piaopiaopig">
    <meta name="twitter:creator" content="@https://x.com/piaopiaopig"><meta name="twitter:title" content="Golang High-Performance Programming EP4 : reflect">
<meta name="twitter:description" content="Practical Tips and Best Practices for Enhancing Reflection Performance"><meta name="twitter:card" content="summary">
    <meta name="twitter:image" content='https://images.hxzhouh.com/blog-images/2024/07/fafe2d9c964dbdd44c76d86834fd745b.png' />
    <link rel="shortcut icon" href="/favicon.ico" />

  
    
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-JMPMQ2QREG"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-JMPMQ2QREG');
        }
      </script>
    
  

<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9000447749076746"
crossorigin="anonymous"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  <meta name="referrer" content="no-referrer-when-downgrade">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9000447749076746"
     crossorigin="anonymous"></script>

<script defer src="https://cloud.umami.is/script.js" data-website-id="e4ee8ffe-fb88-4635-9953-715598461baa"></script>
    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="Toggle Menu">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hu82a0a27be0be6253ef292d06d582a6ab_94926_300x0_resize_q75_box.jpeg" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">ðŸ˜„</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">huizhou92&#39;s Blog</a></h1>
            <h2 class="site-description">Backend Engineer With A Focus On Golang, Cloud Computing, Data Storage And Efficiency Tools. Lifelong Learner.</h2>
        </div>
    </header><ol class="menu-social">
            
                <li>
                    <a 
                        href='https://github.com/hxzhouh'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://x.com/piaopiaopig'
                        target="_blank"
                        title="Twitter"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M22 4.01c-1 .49 -1.98 .689 -3 .99c-1.121 -1.265 -2.783 -1.335 -4.38 -.737s-2.643 2.06 -2.62 3.737v1c-3.245 .083 -6.135 -1.395 -8 -4c0 0 -4.182 7.433 4 11c-1.872 1.247 -3.739 2.088 -6 2c3.308 1.803 6.913 2.423 10.034 1.517c3.58 -1.04 6.522 -3.723 7.651 -7.742a13.84 13.84 0 0 0 .497 -3.753c-.002 -.249 1.51 -2.772 1.818 -4.013z" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>Home</span>
            </a>
        </li>
        
        
        <li >
            <a href='/about/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>About</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>Archives</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>Search</span>
            </a>
        </li>
        
        
        <li >
            <a href='/links/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>Links</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">
                    
                        <li id="i18n-switch">  
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M4 5h7" />
  <path d="M9 3v2c0 4.418 -2.239 8 -5 8" />
  <path d="M5 9c-.003 2.144 2.952 3.908 6.7 4" />
  <path d="M12 20l4 -9l4 9" />
  <path d="M19.1 18h-6.2" />
</svg>



                            <select name="language" title="language" onchange="window.location.href = this.selectedOptions[0].value">
                                
                                    <option value="https://huizhou92.com/" selected>English</option>
                                
                                    <option value="https://huizhou92.com/zh-cn/" >ä¸­æ–‡</option>
                                
                            </select>
                        </li>
                    
                

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>Dark Mode</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

<ins class="adsbygoogle"
   style="display:block"
   data-ad-client="ca-pub-9000447749076746"
   data-ad-slot="5063552270"
   data-ad-format="auto"
   data-full-width-responsive="true"></ins>
<script>
   (adsbygoogle = window.adsbygoogle || []).push({});
</script>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">Table of contents</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li>
      <ol>
        <li><a href="#how-to-simplify-code-using-reflection">How to Simplify Code Using Reflection</a></li>
        <li><a href="#footguns">Footguns</a></li>
        <li><a href="#reflection-performance">Reflection Performance</a></li>
        <li><a href="#how-to-improve-performance">How to Improve Performance</a>
          <ol>
            <li><a href="#avoid-using-reflect-whenever-possible">Avoid Using Reflect Whenever Possible</a></li>
            <li><a href="#use-field-index-mode-whenever-possible">Use <code>Field</code> Index Mode Whenever Possible</a></li>
          </ol>
        </li>
        <li><a href="#conclusion">Conclusion</a></li>
      </ol>
    </li>
  </ol>
</nav>
        </div>
    </section>


<ins class="adsbygoogle"
   style="display:block"
   data-ad-client="ca-pub-9000447749076746"
   data-ad-slot="5063552270"
   data-ad-format="auto"
   data-full-width-responsive="true"></ins>
<script>
   (adsbygoogle = window.adsbygoogle || []).push({});
</script>
            
        
    </aside>


            <main class="main full-width">
    <article class="has-image main-article">
    <header class="article-header">
        <div class="article-image">
            <a href="/p/golang-high-performance-programming-ep4-reflect/">
                
                    <img src="https://images.hxzhouh.com/blog-images/2024/07/fafe2d9c964dbdd44c76d86834fd745b.png" loading="lazy" alt="Featured image of post Golang High-Performance Programming EP4 : reflect" />
                
            </a>
        </div>
    

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/tech/" style="background-color: #2a9d8f; color: #ffff;">
                tech
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/golang-high-performance-programming-ep4-reflect/">Golang High-Performance Programming EP4 : reflect</a>
        </h2>
    
        
        <h3 class="article-subtitle">
            Practical Tips and Best Practices for Enhancing Reflection Performance
        </h3>
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Jul 11, 2024</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    8 minute read
                </time>
            </div>
        
         
        <div class="article-analysic">&nbsp
    
            <?xml version="1.0" encoding="utf-8"?>

<!-- Uploaded to: SVG Repo, www.svgrepo.com, Generator: SVG Repo Mixer Tools -->
<svg fill="#000000" width="800px" height="800px" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
  
  <g id="read">
    <g>
      <path  d="M12,18.883a10.8,10.8,0,0,1-9.675-5.728,2.6,2.6,0,0,1,0-2.31A10.8,10.8,0,0,1,12,5.117a10.8,10.8,0,0,1,9.675,5.728h0a2.6,2.6,0,0,1,0,2.31A10.8,10.8,0,0,1,12,18.883ZM12,6.117a9.787,9.787,0,0,0-8.78,5.176,1.586,1.586,0,0,0,0,1.415A9.788,9.788,0,0,0,12,17.883a9.787,9.787,0,0,0,8.78-5.176,1.584,1.584,0,0,0,0-1.414h0A9.787,9.787,0,0,0,12,6.117Z"/>
      <path  d="M12,16.049A4.049,4.049,0,1,1,16.049,12,4.054,4.054,0,0,1,12,16.049Zm0-7.1A3.049,3.049,0,1,0,15.049,12,3.052,3.052,0,0,0,12,8.951Z"/>
      <circle  cx="12" cy="12" r="2.028"/>
    </g>
  </g>
</svg>
            <time class="article-words">
                <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv"></span> &nbspReads</span>
            </time>
        </div>
    </footer>
    

    
        <footer class="article-translations">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M4 5h7" />
  <path d="M9 3v2c0 4.418 -2.239 8 -5 8" />
  <path d="M5 9c-.003 2.144 2.952 3.908 6.7 4" />
  <path d="M12 20l4 -9l4 9" />
  <path d="M19.1 18h-6.2" />
</svg>



            <div>
                
                    <a href="https://huizhou92.com/zh-cn/p/go%E9%AB%98%E6%80%A7%E8%83%BD%E7%BC%96%E7%A8%8B-ep4-%E5%8F%8D%E5%B0%84/" class="link">ä¸­æ–‡</a>
                
            </div>
        </footer>
    
</div>

</header>

    <section class="article-content">
    
    
    <p><a class="link" href="https://golang.org/pkg/reflect/"  target="_blank" rel="noopener"
    >reflect</a> provides Go with the ability to dynamically obtain the types and values of objects at runtime and create objects dynamically. Reflection can help abstract and simplify code, enhancing development efficiency. The Go standard library and many open-source projects utilize Go&rsquo;s reflection capabilities, such as the <code>json</code> package for serialization and deserialization, and ORM frameworks like <code>gorm/xorm</code>. This article aims to explore <code>reflect</code> and how to improve its performance.</p>
<!-- more -->



<ins class="adsbygoogle"
   style="display:block"
   data-ad-client="ca-pub-9000447749076746"
   data-ad-slot="5063552270"
   data-ad-format="auto"
   data-full-width-responsive="true"></ins>
<script>
   (adsbygoogle = window.adsbygoogle || []).push({});
</script>

<blockquote>
<p>This article was first published in the Medium MPP plan. If you are a Medium user, please follow me on <a class="link" href="https://medium.huizhou92.com/"  target="_blank" rel="noopener"
    >Medium</a>. Thank you very much.</p>
</blockquote>
<p><a class="link" href="https://github.com/hxzhouh/blog-example/tree/main/go/go_reflect"  target="_blank" rel="noopener"
    >Example Code</a></p>
<h3 id="how-to-simplify-code-using-reflection">How to Simplify Code Using Reflection
</h3><p>Let&rsquo;s implement a simple functionality using reflection to see how it can help us simplify the code.<br>
Suppose we have a configuration class <code>Config</code>, with each field representing a configuration item. We need to read environment variables prefixed with CONFIG_xxxx and initialize <code>Config</code> accordingly.</p>
<p>List 1: MySQL config</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// https://github.com/go-sql-driver/mysql/blob/v1.8.1/dsn.go#L37  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">Config</span> <span class="kd">struct</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">    <span class="nx">User</span>   <span class="kt">string</span> <span class="s">`json:&#34;user&#34;`</span>    <span class="c1">// Username  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">Passwd</span> <span class="kt">string</span> <span class="s">`json:&#34;passwd&#34;`</span>  <span class="c1">// Password (requires User)  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">Net</span>    <span class="kt">string</span> <span class="s">`json:&#34;net&#34;`</span>     <span class="c1">// Network (e.g. &#34;tcp&#34;, &#34;tcp6&#34;, &#34;unix&#34;. default: &#34;tcp&#34;)  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">Addr</span>   <span class="kt">string</span> <span class="s">`json:&#34;addr&#34;`</span>    <span class="c1">// Address (default: &#34;127.0.0.1:3306&#34; for &#34;tcp&#34; and &#34;/tmp/mysql.sock&#34; for &#34;unix&#34;)  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">DBName</span> <span class="kt">string</span> <span class="s">`json:&#34;db_name&#34;`</span> <span class="c1">// Database name  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ã€‚ã€‚ã€‚ã€‚ã€‚  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="footguns">Footguns
</h3><p>It&rsquo;s easy to write code like this:</p>
<p>List 2: Initializing <code>Config</code> using a for loop</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">InitConfig</span><span class="p">()</span> <span class="o">*</span><span class="nx">Config</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">    <span class="nx">cfg</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Config</span><span class="p">{}</span>  
</span></span><span class="line"><span class="cl">    <span class="nx">keys</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;CONFIG_MYSQL_USER&#34;</span><span class="p">,</span> <span class="s">&#34;CONFIG_MYSQL_PASSWD&#34;</span><span class="p">,</span> <span class="s">&#34;CONFIG_MYSQL_NET&#34;</span><span class="p">,</span> <span class="s">&#34;CONFIG_MYSQL_ADDR&#34;</span><span class="p">,</span> <span class="s">&#34;CONFIG_MYSQL_DB_NAME&#34;</span><span class="p">}</span>  
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">key</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">keys</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">       <span class="k">if</span> <span class="nx">env</span><span class="p">,</span> <span class="nx">exist</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">LookupEnv</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span> <span class="nx">exist</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">          <span class="k">switch</span> <span class="nx">key</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">          <span class="k">case</span> <span class="s">&#34;CONFIG_MYSQL_USER&#34;</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">             <span class="nx">cfg</span><span class="p">.</span><span class="nx">User</span> <span class="p">=</span> <span class="nx">env</span>  
</span></span><span class="line"><span class="cl">          <span class="k">case</span> <span class="s">&#34;CONFIG_MYSQL_PASSWORD&#34;</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">             <span class="nx">cfg</span><span class="p">.</span><span class="nx">Passwd</span> <span class="p">=</span> <span class="nx">env</span>  
</span></span><span class="line"><span class="cl">          <span class="k">case</span> <span class="s">&#34;CONFIG_MYSQL_NET&#34;</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">             <span class="nx">cfg</span><span class="p">.</span><span class="nx">Net</span> <span class="p">=</span> <span class="nx">env</span>  
</span></span><span class="line"><span class="cl">          <span class="k">case</span> <span class="s">&#34;CONFIG_MYSQL_ADDR&#34;</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">             <span class="nx">cfg</span><span class="p">.</span><span class="nx">Addr</span> <span class="p">=</span> <span class="nx">env</span>  
</span></span><span class="line"><span class="cl">          <span class="k">case</span> <span class="s">&#34;CONFIG_MYSQL_DB_NAME&#34;</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">             <span class="nx">cfg</span><span class="p">.</span><span class="nx">DBName</span> <span class="p">=</span> <span class="nx">env</span>  
</span></span><span class="line"><span class="cl">          <span class="p">}</span>  
</span></span><span class="line"><span class="cl">       <span class="p">}</span>  
</span></span><span class="line"><span class="cl">    <span class="p">}</span>  
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">cfg</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>However, using hardcoding means that if the <code>Config</code> structure changes, such as modifying the corresponding <code>json</code> fields, deleting, or adding a configuration item, this logic also needs to change. A bigger problem is that it&rsquo;s very error-prone and hard to test.</p>
<p>If we switch to using reflection, the implementation code would look like this:</p>
<p>List 3: Initializing <code>Config</code> using <code>reflect</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">InitConfig2</span><span class="p">()</span> <span class="o">*</span><span class="nx">Config</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">    <span class="nx">config</span> <span class="o">:=</span> <span class="nx">Config</span><span class="p">{}</span>  
</span></span><span class="line"><span class="cl">    <span class="nx">typ</span> <span class="o">:=</span> <span class="nx">reflect</span><span class="p">.</span><span class="nf">TypeOf</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="nx">value</span> <span class="o">:=</span> <span class="nx">reflect</span><span class="p">.</span><span class="nf">Indirect</span><span class="p">(</span><span class="nx">reflect</span><span class="p">.</span><span class="nf">ValueOf</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">config</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">typ</span><span class="p">.</span><span class="nf">NumField</span><span class="p">();</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">       <span class="nx">f</span> <span class="o">:=</span> <span class="nx">typ</span><span class="p">.</span><span class="nf">Field</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">       <span class="k">if</span> <span class="nx">v</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">f</span><span class="p">.</span><span class="nx">Tag</span><span class="p">.</span><span class="nf">Lookup</span><span class="p">(</span><span class="s">&#34;json&#34;</span><span class="p">);</span> <span class="nx">ok</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">          <span class="nx">key</span> <span class="o">:=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;CONFIG_MYSQL_%s&#34;</span><span class="p">,</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">ToUpper</span><span class="p">(</span><span class="nx">v</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl">          <span class="k">if</span> <span class="nx">env</span><span class="p">,</span> <span class="nx">exist</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">LookupEnv</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span> <span class="nx">exist</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">             <span class="nx">value</span><span class="p">.</span><span class="nf">FieldByName</span><span class="p">(</span><span class="nx">f</span><span class="p">.</span><span class="nx">Name</span><span class="p">).</span><span class="nf">Set</span><span class="p">(</span><span class="nx">reflect</span><span class="p">.</span><span class="nf">ValueOf</span><span class="p">(</span><span class="nx">env</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl">          <span class="p">}</span>  
</span></span><span class="line"><span class="cl">       <span class="p">}</span>  
</span></span><span class="line"><span class="cl">    <span class="p">}</span>  
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="o">&amp;</span><span class="nx">config</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The implementation logic is quite simple:</p>
<ul>
<li>At runtime, use reflection to obtain the <code>Tag</code> property of each field in <code>Config</code> and concatenate the corresponding environment variable names.</li>
<li>Check if the environment variable exists. If it does, assign its value to the field.<br>
This way, regardless of adding or deleting fields in <code>Config</code>, the <code>InitConfig</code> function doesn&rsquo;t need modification. Isn&rsquo;t it much simpler than using a for loop?</li>
</ul>
<h3 id="reflection-performance">Reflection Performance
</h3><p>We&rsquo;ve often heard that the performance of reflection is poor. When comparing <a class="link" href="https://medium.com/faun/analyze-various-high-performance-json-parsing-libraries-in-go-4c699fc12cba"  target="_blank" rel="noopener"
    >JSON parsing libraries</a>, we also verified that the official <code>JSON Unmarshal</code> library performs relatively poorly because it needs to execute more instructions. So, how poor is the performance of reflection exactly? Let&rsquo;s perform a benchmark to find out.</p>
<p>List 4: Benchmark test for New and Reflect Performance</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">BenchmarkNew</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">config</span> <span class="o">*</span><span class="nx">Config</span>  
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">b</span><span class="p">.</span><span class="nx">N</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">       <span class="nx">config</span> <span class="p">=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">Config</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="p">}</span>  
</span></span><span class="line"><span class="cl">    <span class="nx">_</span> <span class="p">=</span> <span class="nx">config</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">BenchmarkReflectNew</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">config</span> <span class="o">*</span><span class="nx">Config</span>  
</span></span><span class="line"><span class="cl">    <span class="nx">typ</span> <span class="o">:=</span> <span class="nx">reflect</span><span class="p">.</span><span class="nf">TypeOf</span><span class="p">(</span><span class="nx">Config</span><span class="p">{})</span>  
</span></span><span class="line"><span class="cl">    <span class="nx">b</span><span class="p">.</span><span class="nf">ResetTimer</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">b</span><span class="p">.</span><span class="nx">N</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">       <span class="nx">config</span><span class="p">,</span> <span class="nx">_</span> <span class="p">=</span> <span class="nx">reflect</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">typ</span><span class="p">).</span><span class="nf">Interface</span><span class="p">().(</span><span class="o">*</span><span class="nx">Config</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="p">}</span>  
</span></span><span class="line"><span class="cl">    <span class="nx">_</span> <span class="p">=</span> <span class="nx">config</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="o">----</span>
</span></span><span class="line"><span class="cl"><span class="err">âžœ</span>  <span class="nx">go_reflect</span> <span class="nx">git</span><span class="p">:(</span><span class="nx">main</span><span class="p">)</span> <span class="err">âœ—</span> <span class="k">go</span> <span class="nx">test</span> <span class="o">--</span><span class="nx">bench</span> <span class="p">.</span> 
</span></span><span class="line"><span class="cl"><span class="nx">goos</span><span class="p">:</span> <span class="nx">darwin</span>
</span></span><span class="line"><span class="cl"><span class="nx">goarch</span><span class="p">:</span> <span class="nx">arm64</span>
</span></span><span class="line"><span class="cl"><span class="nx">pkg</span><span class="p">:</span> <span class="nx">blog</span><span class="o">-</span><span class="nx">example</span><span class="o">/</span><span class="k">go</span><span class="o">/</span><span class="nx">go_reflect</span>
</span></span><span class="line"><span class="cl"><span class="nx">BenchmarkNew</span><span class="o">-</span><span class="mi">10</span>                 <span class="mi">47675076</span>                <span class="mf">25.40</span> <span class="nx">ns</span><span class="o">/</span><span class="nx">op</span>
</span></span><span class="line"><span class="cl"><span class="nx">BenchmarkReflectNew</span><span class="o">-</span><span class="mi">10</span>          <span class="mi">36163776</span>                <span class="mf">32.51</span> <span class="nx">ns</span><span class="o">/</span><span class="nx">op</span>
</span></span><span class="line"><span class="cl"><span class="nx">PASS</span>
</span></span><span class="line"><span class="cl"><span class="nx">ok</span>      <span class="nx">blog</span><span class="o">-</span><span class="nx">example</span><span class="o">/</span><span class="k">go</span><span class="o">/</span><span class="nx">go_reflect</span>      <span class="mf">3.895</span><span class="nx">s</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>If it&rsquo;s just a creation scenario, the performance gap between the two isn&rsquo;t very significant.<br>
Let&rsquo;s test the field modification scenario. There are two ways to modify fields using reflection:<br>
<code>FieldByName</code> and <code>Field index mode.</code><br>
We&rsquo;ll test the performance of both modes separately.</p>
<p>List 5: Testing the performance of modifying fields</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">BenchmarkFieldSet</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">    <span class="nx">config</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">Config</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="nx">b</span><span class="p">.</span><span class="nf">ResetTimer</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">b</span><span class="p">.</span><span class="nx">N</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">       <span class="nx">config</span><span class="p">.</span><span class="nx">Net</span> <span class="p">=</span> <span class="s">&#34;tcp4&#34;</span>  
</span></span><span class="line"><span class="cl">       <span class="nx">config</span><span class="p">.</span><span class="nx">Addr</span> <span class="p">=</span> <span class="s">&#34;127.0.0.1:3306&#34;</span>  
</span></span><span class="line"><span class="cl">       <span class="nx">config</span><span class="p">.</span><span class="nx">Passwd</span> <span class="p">=</span> <span class="s">&#34;123456&#34;</span>  
</span></span><span class="line"><span class="cl">       <span class="nx">config</span><span class="p">.</span><span class="nx">User</span> <span class="p">=</span> <span class="s">&#34;admin&#34;</span>  
</span></span><span class="line"><span class="cl">    <span class="p">}</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">BenchmarkFieldSetFieldByName</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">    <span class="nx">config</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">Config</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="nx">value</span> <span class="o">:=</span> <span class="nx">reflect</span><span class="p">.</span><span class="nf">ValueOf</span><span class="p">(</span><span class="nx">config</span><span class="p">).</span><span class="nf">Elem</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">    <span class="nx">b</span><span class="p">.</span><span class="nf">ResetTimer</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">b</span><span class="p">.</span><span class="nx">N</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">       <span class="nx">value</span><span class="p">.</span><span class="nf">FieldByName</span><span class="p">(</span><span class="s">&#34;Net&#34;</span><span class="p">).</span><span class="nf">SetString</span><span class="p">(</span><span class="s">&#34;tcp4&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">       <span class="nx">value</span><span class="p">.</span><span class="nf">FieldByName</span><span class="p">(</span><span class="s">&#34;Addr&#34;</span><span class="p">).</span><span class="nf">SetString</span><span class="p">(</span><span class="s">&#34;127.0.0.1:3306&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">       <span class="nx">value</span><span class="p">.</span><span class="nf">FieldByName</span><span class="p">(</span><span class="s">&#34;Passwd&#34;</span><span class="p">).</span><span class="nf">SetString</span><span class="p">(</span><span class="s">&#34;123456&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">       <span class="nx">value</span><span class="p">.</span><span class="nf">FieldByName</span><span class="p">(</span><span class="s">&#34;User&#34;</span><span class="p">).</span><span class="nf">SetString</span><span class="p">(</span><span class="s">&#34;admin&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="p">}</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span>  
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">BenchmarkFieldSetField</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">    <span class="nx">config</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">Config</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="nx">value</span> <span class="o">:=</span> <span class="nx">reflect</span><span class="p">.</span><span class="nf">Indirect</span><span class="p">(</span><span class="nx">reflect</span><span class="p">.</span><span class="nf">ValueOf</span><span class="p">(</span><span class="nx">config</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl">    <span class="nx">b</span><span class="p">.</span><span class="nf">ResetTimer</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">b</span><span class="p">.</span><span class="nx">N</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">       <span class="nx">value</span><span class="p">.</span><span class="nf">Field</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nf">SetString</span><span class="p">(</span><span class="s">&#34;tcp4&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">       <span class="nx">value</span><span class="p">.</span><span class="nf">Field</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nf">SetString</span><span class="p">(</span><span class="s">&#34;127.0.0.1:3306&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">       <span class="nx">value</span><span class="p">.</span><span class="nf">Field</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="nf">SetString</span><span class="p">(</span><span class="s">&#34;123456&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">       <span class="nx">value</span><span class="p">.</span><span class="nf">Field</span><span class="p">(</span><span class="mi">3</span><span class="p">).</span><span class="nf">SetString</span><span class="p">(</span><span class="s">&#34;admin&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="p">}</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="o">----</span>
</span></span><span class="line"><span class="cl"><span class="err">âžœ</span>  <span class="nx">go_reflect</span> <span class="nx">git</span><span class="p">:(</span><span class="nx">main</span><span class="p">)</span> <span class="err">âœ—</span> <span class="k">go</span> <span class="nx">test</span> <span class="o">--</span><span class="nx">bench</span><span class="p">=</span><span class="s">&#34;BenchmarkFieldSet*&#34;</span>          
</span></span><span class="line"><span class="cl"><span class="nx">goos</span><span class="p">:</span> <span class="nx">darwin</span>
</span></span><span class="line"><span class="cl"><span class="nx">goarch</span><span class="p">:</span> <span class="nx">arm64</span>
</span></span><span class="line"><span class="cl"><span class="nx">pkg</span><span class="p">:</span> <span class="nx">blog</span><span class="o">-</span><span class="nx">example</span><span class="o">/</span><span class="k">go</span><span class="o">/</span><span class="nx">go_reflect</span>
</span></span><span class="line"><span class="cl"><span class="nx">BenchmarkFieldSet</span><span class="o">-</span><span class="mi">10</span>                    <span class="mi">1000000000</span>               <span class="mf">0.3282</span> <span class="nx">ns</span><span class="o">/</span><span class="nx">op</span>
</span></span><span class="line"><span class="cl"><span class="nx">BenchmarkFieldSetFieldByName</span><span class="o">-</span><span class="mi">10</span>          <span class="mi">6471114</span>               <span class="mf">185.3</span> <span class="nx">ns</span><span class="o">/</span><span class="nx">op</span>
</span></span><span class="line"><span class="cl"><span class="nx">BenchmarkFieldSetField</span><span class="o">-</span><span class="mi">10</span>               <span class="mi">100000000</span>               <span class="mf">11.88</span> <span class="nx">ns</span><span class="o">/</span><span class="nx">op</span>
</span></span><span class="line"><span class="cl"><span class="nx">PASS</span>
</span></span><span class="line"><span class="cl"><span class="nx">ok</span>      <span class="nx">blog</span><span class="o">-</span><span class="nx">example</span><span class="o">/</span><span class="k">go</span><span class="o">/</span><span class="nx">go_reflect</span>      <span class="mf">3.910</span><span class="nx">s</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The performance difference is significant. Non-reflective methods compared to the <code>reflect</code> <code>Field</code> index mode have a gap of two orders of magnitude. Compared to the <code>reflect</code> <code>FieldByName</code> mode, the gap reaches three orders of magnitude. One puzzling point is that the <code>FieldByName</code> mode and the <code>Field</code> index mode also have an order of magnitude difference. However, we can find the answer in the source code.</p>
<p>List 6: <a class="link" href="https://go.googlesource.com/go/blob/82c371a307116450e9ab4dbce1853da3e69f4061/src/reflect/value.go#L1345"  target="_blank" rel="noopener"
    >reflect/value.go</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">v</span> <span class="nx">Value</span><span class="p">)</span> <span class="nf">FieldByName</span><span class="p">(</span><span class="nx">name</span> <span class="kt">string</span><span class="p">)</span> <span class="nx">Value</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">    <span class="nx">v</span><span class="p">.</span><span class="nf">mustBe</span><span class="p">(</span><span class="nx">Struct</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">f</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nf">toRType</span><span class="p">(</span><span class="nx">v</span><span class="p">.</span><span class="nf">typ</span><span class="p">()).</span><span class="nf">FieldByName</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span> <span class="nx">ok</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">       <span class="k">return</span> <span class="nx">v</span><span class="p">.</span><span class="nf">FieldByIndex</span><span class="p">(</span><span class="nx">f</span><span class="p">.</span><span class="nx">Index</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="p">}</span>  
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">Value</span><span class="p">{}</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// FieldByIndex returns the nested field corresponding to index.// It panics if evaluation requires stepping through a nil  
</span></span></span><span class="line"><span class="cl"><span class="c1">// pointer or a field that is not a struct.  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">v</span> <span class="nx">Value</span><span class="p">)</span> <span class="nf">FieldByIndex</span><span class="p">(</span><span class="nx">index</span> <span class="p">[]</span><span class="kt">int</span><span class="p">)</span> <span class="nx">Value</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">index</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">       <span class="k">return</span> <span class="nx">v</span><span class="p">.</span><span class="nf">Field</span><span class="p">(</span><span class="nx">index</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>  
</span></span><span class="line"><span class="cl">    <span class="p">}</span>  
</span></span><span class="line"><span class="cl">    <span class="nx">v</span><span class="p">.</span><span class="nf">mustBe</span><span class="p">(</span><span class="nx">Struct</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">x</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">index</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">       <span class="k">if</span> <span class="nx">i</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">          <span class="k">if</span> <span class="nx">v</span><span class="p">.</span><span class="nf">Kind</span><span class="p">()</span> <span class="o">==</span> <span class="nx">Pointer</span> <span class="o">&amp;&amp;</span> <span class="nx">v</span><span class="p">.</span><span class="nf">typ</span><span class="p">().</span><span class="nf">Elem</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">().</span><span class="nf">Kind</span><span class="p">()</span> <span class="o">==</span> <span class="nx">abi</span><span class="p">.</span><span class="nx">Struct</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">             <span class="k">if</span> <span class="nx">v</span><span class="p">.</span><span class="nf">IsNil</span><span class="p">()</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">                <span class="nb">panic</span><span class="p">(</span><span class="s">&#34;reflect: indirection through nil pointer to embedded struct&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">             <span class="p">}</span>  
</span></span><span class="line"><span class="cl">             <span class="nx">v</span> <span class="p">=</span> <span class="nx">v</span><span class="p">.</span><span class="nf">Elem</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">          <span class="p">}</span>  
</span></span><span class="line"><span class="cl">       <span class="p">}</span>  
</span></span><span class="line"><span class="cl">       <span class="nx">v</span> <span class="p">=</span> <span class="nx">v</span><span class="p">.</span><span class="nf">Field</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="p">}</span>  
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">v</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>List 7: <a class="link" href="https://go.googlesource.com/go/blob/82c371a307116450e9ab4dbce1853da3e69f4061/src/reflect/type.go#L760"  target="_blank" rel="noopener"
    >reflect/type.go</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">rtype</span><span class="p">)</span> <span class="nf">FieldByName</span><span class="p">(</span><span class="nx">name</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">StructField</span><span class="p">,</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">t</span><span class="p">.</span><span class="nf">Kind</span><span class="p">()</span> <span class="o">!=</span> <span class="nx">Struct</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">       <span class="nb">panic</span><span class="p">(</span><span class="s">&#34;reflect: FieldByName of non-struct type &#34;</span> <span class="o">+</span> <span class="nx">t</span><span class="p">.</span><span class="nf">String</span><span class="p">())</span>  
</span></span><span class="line"><span class="cl">    <span class="p">}</span>  
</span></span><span class="line"><span class="cl">    <span class="nx">tt</span> <span class="o">:=</span> <span class="p">(</span><span class="o">*</span><span class="nx">structType</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">t</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">tt</span><span class="p">.</span><span class="nf">FieldByName</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// FieldByName returns the struct field with the given name// and a boolean to indicate if the field was found.  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">structType</span><span class="p">)</span> <span class="nf">FieldByName</span><span class="p">(</span><span class="nx">name</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">f</span> <span class="nx">StructField</span><span class="p">,</span> <span class="nx">present</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">    <span class="c1">// Quick check for top-level name, or struct without embedded fields.  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">hasEmbeds</span> <span class="o">:=</span> <span class="kc">false</span>  
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">name</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">       <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">t</span><span class="p">.</span><span class="nx">Fields</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">          <span class="nx">tf</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">t</span><span class="p">.</span><span class="nx">Fields</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl">          <span class="k">if</span> <span class="nx">tf</span><span class="p">.</span><span class="nx">Name</span><span class="p">.</span><span class="nf">Name</span><span class="p">()</span> <span class="o">==</span> <span class="nx">name</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">             <span class="k">return</span> <span class="nx">t</span><span class="p">.</span><span class="nf">Field</span><span class="p">(</span><span class="nx">i</span><span class="p">),</span> <span class="kc">true</span>  
</span></span><span class="line"><span class="cl">          <span class="p">}</span>  
</span></span><span class="line"><span class="cl">          <span class="k">if</span> <span class="nx">tf</span><span class="p">.</span><span class="nf">Embedded</span><span class="p">()</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">             <span class="nx">hasEmbeds</span> <span class="p">=</span> <span class="kc">true</span>  
</span></span><span class="line"><span class="cl">          <span class="p">}</span>  
</span></span><span class="line"><span class="cl">       <span class="p">}</span>  
</span></span><span class="line"><span class="cl">    <span class="p">}</span>  
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">!</span><span class="nx">hasEmbeds</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">       <span class="k">return</span>  
</span></span><span class="line"><span class="cl">    <span class="p">}</span>  
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">t</span><span class="p">.</span><span class="nf">FieldByNameFunc</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">s</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">s</span> <span class="o">==</span> <span class="nx">name</span> <span class="p">})</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Internally, fields are stored sequentially, so accessing them by index has an O(1) efficiency, while accessing by <code>Name</code> requires traversing all fields, which has an O(N) efficiency. The more fields (including methods) a struct contains, the greater the efficiency difference between the two methods. However, remembering the order of fields can be error-prone.</p>
<h3 id="how-to-improve-performance">How to Improve Performance
</h3><h4 id="avoid-using-reflect-whenever-possible">Avoid Using Reflect Whenever Possible
</h4><p>Using reflection for assignments is highly inefficient. If there are alternative methods, avoid using reflection, especially in repeatedly called hotspots. For example, in an RPC protocol, where structures need to be serialized and deserialized, avoid using Go&rsquo;s built-in <code>json</code> <code>Marshal</code> and <code>Unmarshal</code> methods because the standard library&rsquo;s JSON serialization and deserialization are implemented using reflection. Using <code>fastjson</code> instead of the standard library can yield a performance improvement of about ten times.</p>
<h4 id="use-field-index-mode-whenever-possible">Use <code>Field</code> Index Mode Whenever Possible
</h4><p>From the previous benchmark, the <code>Field</code> index mode is nearly an order of magnitude faster than the <code>FieldByName</code> method. This difference becomes more evident when there are more fields. However, using the <code>Field</code> index mode can be cumbersome because you need to remember the indexes, making it difficult to modify. In this case, you can use a map to cache the names and indexes.</p>
<p>For example:</p>
<p>List 8: Cache FieldByName and Field Index</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">BenchmarkFieldSetFieldByNameCache</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">    <span class="nx">config</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">Config</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="nx">typ</span> <span class="o">:=</span> <span class="nx">reflect</span><span class="p">.</span><span class="nf">TypeOf</span><span class="p">(</span><span class="nx">Config</span><span class="p">{})</span>  
</span></span><span class="line"><span class="cl">    <span class="nx">value</span> <span class="o">:=</span> <span class="nx">reflect</span><span class="p">.</span><span class="nf">ValueOf</span><span class="p">(</span><span class="nx">config</span><span class="p">).</span><span class="nf">Elem</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">    <span class="nx">cache</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">int</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">typ</span><span class="p">.</span><span class="nf">NumField</span><span class="p">();</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">       <span class="nx">cache</span><span class="p">[</span><span class="nx">typ</span><span class="p">.</span><span class="nf">Field</span><span class="p">(</span><span class="nx">i</span><span class="p">).</span><span class="nx">Name</span><span class="p">]</span> <span class="p">=</span> <span class="nx">i</span>  
</span></span><span class="line"><span class="cl">    <span class="p">}</span>  
</span></span><span class="line"><span class="cl">    <span class="nx">b</span><span class="p">.</span><span class="nf">ResetTimer</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">b</span><span class="p">.</span><span class="nx">N</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">       <span class="nx">value</span><span class="p">.</span><span class="nf">Field</span><span class="p">(</span><span class="nx">cache</span><span class="p">[</span><span class="s">&#34;Net&#34;</span><span class="p">]).</span><span class="nf">SetString</span><span class="p">(</span><span class="s">&#34;tcp4&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">       <span class="nx">value</span><span class="p">.</span><span class="nf">Field</span><span class="p">(</span><span class="nx">cache</span><span class="p">[</span><span class="s">&#34;Addr&#34;</span><span class="p">]).</span><span class="nf">SetString</span><span class="p">(</span><span class="s">&#34;127.0.0.1:3306&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">       <span class="nx">value</span><span class="p">.</span><span class="nf">Field</span><span class="p">(</span><span class="nx">cache</span><span class="p">[</span><span class="s">&#34;Passwd&#34;</span><span class="p">]).</span><span class="nf">SetString</span><span class="p">(</span><span class="s">&#34;123456&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">       <span class="nx">value</span><span class="p">.</span><span class="nf">Field</span><span class="p">(</span><span class="nx">cache</span><span class="p">[</span><span class="s">&#34;User&#34;</span><span class="p">]).</span><span class="nf">SetString</span><span class="p">(</span><span class="s">&#34;admin&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="p">}</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="o">----</span>
</span></span><span class="line"><span class="cl"><span class="nx">BenchmarkFieldSetFieldByNameCache</span><span class="o">-</span><span class="mi">10</span>            <span class="mi">32121740</span>                <span class="mf">36.85</span> <span class="nx">ns</span><span class="o">/</span><span class="nx">op</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>This method shows a fourfold improvement over directly using <code>FieldByName</code>, which is quite significant.</p>
<h3 id="conclusion">Conclusion
</h3><ol>
<li>This article does not delve into the details of <code>reflect</code>. If you want to learn more about <code>reflect</code>, you can refer to the following articles:
<ol>
<li><a class="link" href="https://medium.com/capital-one-tech/learning-to-use-go-reflection-822a0aed74b7"  target="_blank" rel="noopener"
    >Learning to Use Go Reflection</a></li>
<li><a class="link" href="https://go101.org/article/reflection.html"  target="_blank" rel="noopener"
    >Go101: Reflection</a></li>
</ol>
</li>
<li>Reflect is used extensively in various foundational libraries. Using reflect appropriately can simplify code, but it comes with performance costs, potentially reducing performance by up to three orders of magnitude in extreme cases.</li>
<li>You can optimize performance using Field index + cache.</li>
</ol>
<p>Do you have any other thoughts on reflection? Leave a comment and discuss it with me.</p>

</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/go/">Go</a>
        
    </section>


    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>true</span>
    </section>
    <section class="article-lastmod">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



        <span>
            Last updated on Jul 11, 2024 11:03 CST
        </span>
    </section></footer>


    
</article>

    

    

<ins class="adsbygoogle"
   style="display:block"
   data-ad-client="ca-pub-9000447749076746"
   data-ad-slot="5063552270"
   data-ad-format="auto"
   data-full-width-responsive="true"></ins>
<script>
   (adsbygoogle = window.adsbygoogle || []).push({});
</script>
<aside class="related-content--wrapper">
    <h2 class="section-title">Related content</h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="">
    <a href="/p/common-causes-of-memory-leaks-in-go-how-to-avoid-them/">
        
        

        <div class="article-details">
            <h2 class="article-title">Common Causes of Memory Leaks in Go: How to Avoid Them</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/common-rate-limiting-algorithms-analysis-and-implementation/">
        
        
            <div class="article-image">
                
                    <img src="https://images.hxzhouh.com/blog-images/2024/09/f146e1aedafc425732135df81c5cd244.png" loading="lazy" data-key="" data-hash="https://images.hxzhouh.com/blog-images/2024/09/f146e1aedafc425732135df81c5cd244.png"/>
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">Common Rate Limiting Algorithms: Analysis and Implementation</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/go-proposal-a-new-json-lib-ep1/">
        
        
            <div class="article-image">
                
                    <img src="https://images.hxzhouh.com/blog-images/2024/09/5cfcc61c5e45994e3e35ceb82bfa6bc8.png" loading="lazy" data-key="" data-hash="https://images.hxzhouh.com/blog-images/2024/09/5cfcc61c5e45994e3e35ceb82bfa6bc8.png"/>
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">Go Proposal: A New Json Lib Ep1</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/decrypt-go-varint/">
        
        
            <div class="article-image">
                
                    <img src="https://images.hxzhouh.com/blog-images/2024/09/8f70bb43e8ae963c5655a667adf6b88d.png" loading="lazy" data-key="" data-hash="https://images.hxzhouh.com/blog-images/2024/09/8f70bb43e8ae963c5655a667adf6b88d.png"/>
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">Decrypt Go:Â varint</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/decrypt-go-runtime.setfinalizer/">
        
        
            <div class="article-image">
                
                    <img src="https://images.hxzhouh.com/blog-images/2024/09/44dc3c5b905dd33169c691b6ec42b4cf.png" loading="lazy" data-key="" data-hash="https://images.hxzhouh.com/blog-images/2024/09/44dc3c5b905dd33169c691b6ec42b4cf.png"/>
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">Decrypt Go: `runtime.SetFinalizer`</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>


    
        
    <script src="//cdn.jsdelivr.net/npm/twikoo@1.6.21/dist/twikoo.all.min.js"></script>
<div id="tcomment"></div>
<style>
    .twikoo {
        background-color: var(--card-background);
        border-radius: var(--card-border-radius);
        box-shadow: var(--shadow-l1);
        padding: var(--card-padding);
    }
    :root[data-scheme="dark"] {
        --twikoo-body-text-color-main: rgba(255, 255, 255, 0.9);
        --twikoo-body-text-color: rgba(255, 255, 255, 0.7);
    }
    .twikoo .el-input-group__prepend,
    .twikoo .tk-action-icon,
    .twikoo .tk-submit-action-icon,
    .twikoo .tk-time,
    .twikoo .tk-comments-no,
    .twikoo .tk-comments-count {
        color: var(--twikoo-body-text-color);
    }
    .twikoo .el-input__inner,
    .twikoo .el-textarea__inner,
    .twikoo .tk-preview-container,
    .twikoo .tk-content,
    .twikoo .tk-nick,
    .twikoo .tk-send {
        color: var(--twikoo-body-text-color-main);
    }
    .twikoo .el-button{
        color: var(--twikoo-body-text-color)!important;
    }
    .twikoo .el-input__count {
        color: var(--twikoo-body-text-color) !important;
    }
    .OwO .OwO-body {
        background-color: var(--body-background) !important;
        color: var(--body-text-color) !important;
    }
</style><script>
    twikoo.init({
        envId: 'https:\/\/twikoo.yixiao9206.cn',
        el: '#tcomment',lang: 'en',})
</script>

    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2023 - 
        
        2024 Copyright Â© 2023 huizhou92
    </section>
    
    <section class="powerby">
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        Theme <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.26.0">Stack</a></b> designed by <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a>
    </section>
     
	
	<div class="busuanzi-footer">
	<span id="busuanzi_container_site_pv">
		Total site visits: <span id="busuanzi_value_site_pv"></span>
	</span>
	<span id="busuanzi_container_site_uv">
		Total Visitors: <span id="busuanzi_value_site_uv"></span>
	</span>
	</div></footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
