<!DOCTYPE html>
<html lang="en" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name="baidu-site-verification" content="codeva-3VTxLtnqFP" /><meta name='description' content="A Deep Dive into Efficient Network Programming">
<meta name="keywords" content="golang, nbio"><title>Analyzing High-Performance Network Framework nbio in Go</title>

<link rel='canonical' href='https://huizhou92.com/p/analyzing-high-performance-network-framework-nbio-in-go/'>

<link rel="stylesheet" href="/scss/style.min.0304c6baf04e01a8fe70693791cb744d56a3578a3120a8796cefc66825aa39c7.css"><meta property='og:title' content="Analyzing High-Performance Network Framework nbio in Go">
<meta property='og:description' content="A Deep Dive into Efficient Network Programming">
<meta property='og:url' content='https://huizhou92.com/p/analyzing-high-performance-network-framework-nbio-in-go/'>
<meta property='og:site_name' content='huizhou92&#39;s Blog'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='golang' /><meta property='article:published_time' content='2024-05-05T12:24:00&#43;00:00'/><meta property='article:modified_time' content='2024-05-05T12:24:00&#43;00:00'/><meta property='og:image' content='https://images.yixiao9206.cn/blog-images/2024/05/8876d50feac67c7fe0d47c28960064e5.png' />
<meta name="twitter:site" content="@https://x.com/piaopiaopig">
    <meta name="twitter:creator" content="@https://x.com/piaopiaopig"><meta name="twitter:title" content="Analyzing High-Performance Network Framework nbio in Go">
<meta name="twitter:description" content="A Deep Dive into Efficient Network Programming"><meta name="twitter:card" content="summary">
    <meta name="twitter:image" content='https://images.yixiao9206.cn/blog-images/2024/05/8876d50feac67c7fe0d47c28960064e5.png' />
    <link rel="shortcut icon" href="/favicon.ico" />

  
    
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-JMPMQ2QREG"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-JMPMQ2QREG');
        }
      </script>
    
  

<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9000447749076746"
crossorigin="anonymous"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  <meta name="referrer" content="no-referrer-when-downgrade">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9000447749076746"
     crossorigin="anonymous"></script>

<script defer src="https://cloud.umami.is/script.js" data-website-id="e4ee8ffe-fb88-4635-9953-715598461baa"></script>
    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="Toggle Menu">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hu82a0a27be0be6253ef292d06d582a6ab_94926_300x0_resize_q75_box.jpeg" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">huizhou92&#39;s Blog</a></h1>
            <h2 class="site-description">Backend Engineer With A Focus On Golang, Cloud Computing, Data Storage And Efficiency Tools. Lifelong Learner.</h2>
        </div>
    </header><ol class="menu-social">
            
                <li>
                    <a 
                        href='https://github.com/hxzhouh'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://x.com/piaopiaopig'
                        target="_blank"
                        title="Twitter"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M22 4.01c-1 .49 -1.98 .689 -3 .99c-1.121 -1.265 -2.783 -1.335 -4.38 -.737s-2.643 2.06 -2.62 3.737v1c-3.245 .083 -6.135 -1.395 -8 -4c0 0 -4.182 7.433 4 11c-1.872 1.247 -3.739 2.088 -6 2c3.308 1.803 6.913 2.423 10.034 1.517c3.58 -1.04 6.522 -3.723 7.651 -7.742a13.84 13.84 0 0 0 .497 -3.753c-.002 -.249 1.51 -2.772 1.818 -4.013z" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>Home</span>
            </a>
        </li>
        
        
        <li >
            <a href='/about/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>About</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>Archives</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>Search</span>
            </a>
        </li>
        
        
        <li >
            <a href='/links/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>Links</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">
                    
                        <li id="i18n-switch">  
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M4 5h7" />
  <path d="M9 3v2c0 4.418 -2.239 8 -5 8" />
  <path d="M5 9c-.003 2.144 2.952 3.908 6.7 4" />
  <path d="M12 20l4 -9l4 9" />
  <path d="M19.1 18h-6.2" />
</svg>



                            <select name="language" title="language" onchange="window.location.href = this.selectedOptions[0].value">
                                
                                    <option value="https://huizhou92.com/" selected>English</option>
                                
                                    <option value="https://huizhou92.com/zh-cn/" >中文</option>
                                
                            </select>
                        </li>
                    
                

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>Dark Mode</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>


<ins class="adsbygoogle"
   style="display:block"
   data-ad-client="ca-pub-9000447749076746"
   data-ad-slot="5063552270"
   data-ad-format="auto"
   data-full-width-responsive="true"></ins>
<script>
   (adsbygoogle = window.adsbygoogle || []).push({});
</script>


    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">Table of contents</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#introduction">Introduction</a></li>
    <li><a href="#server">Server:</a></li>
    <li><a href="#client">Client:</a></li>
    <li><a href="#summary">Summary</a></li>
  </ol>
</nav>
        </div>
    </section>


<ins class="adsbygoogle"
   style="display:block"
   data-ad-client="ca-pub-9000447749076746"
   data-ad-slot="5063552270"
   data-ad-format="auto"
   data-full-width-responsive="true"></ins>
<script>
   (adsbygoogle = window.adsbygoogle || []).push({});
</script>
            
        
    </aside>


            <main class="main full-width">
    <article class="has-image main-article">
    <header class="article-header">
        <div class="article-image">
            <a href="/p/analyzing-high-performance-network-framework-nbio-in-go/">
                
                    <img src="https://images.yixiao9206.cn/blog-images/2024/05/8876d50feac67c7fe0d47c28960064e5.png" loading="lazy" alt="Featured image of post Analyzing High-Performance Network Framework nbio in Go" />
                
            </a>
        </div>
    

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/tech/" style="background-color: #2a9d8f; color: #ffff;">
                tech
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/analyzing-high-performance-network-framework-nbio-in-go/">Analyzing High-Performance Network Framework nbio in Go</a>
        </h2>
    
        
        <h3 class="article-subtitle">
            A Deep Dive into Efficient Network Programming
        </h3>
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">May 05, 2024</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    15 minute read
                </time>
            </div>
        
         
        <div class="article-analysic">&nbsp
    
            <?xml version="1.0" encoding="utf-8"?>

<!-- Uploaded to: SVG Repo, www.svgrepo.com, Generator: SVG Repo Mixer Tools -->
<svg fill="#000000" width="800px" height="800px" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
  
  <g id="read">
    <g>
      <path  d="M12,18.883a10.8,10.8,0,0,1-9.675-5.728,2.6,2.6,0,0,1,0-2.31A10.8,10.8,0,0,1,12,5.117a10.8,10.8,0,0,1,9.675,5.728h0a2.6,2.6,0,0,1,0,2.31A10.8,10.8,0,0,1,12,18.883ZM12,6.117a9.787,9.787,0,0,0-8.78,5.176,1.586,1.586,0,0,0,0,1.415A9.788,9.788,0,0,0,12,17.883a9.787,9.787,0,0,0,8.78-5.176,1.584,1.584,0,0,0,0-1.414h0A9.787,9.787,0,0,0,12,6.117Z"/>
      <path  d="M12,16.049A4.049,4.049,0,1,1,16.049,12,4.054,4.054,0,0,1,12,16.049Zm0-7.1A3.049,3.049,0,1,0,15.049,12,3.052,3.052,0,0,0,12,8.951Z"/>
      <circle  cx="12" cy="12" r="2.028"/>
    </g>
  </g>
</svg>
            <time class="article-words">
                <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv"></span> &nbspReads</span>
            </time>
        </div>
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <h2 id="introduction">Introduction
</h2><p>In this article, we’ll continue our in-depth analysis of another high-performance network programming framework: <code>nbio</code>.<br>
The <code>nbio</code> project also includes <code>nbhttp</code> built on top of <code>nbio</code>, but that&rsquo;s outside the scope of our discussion.<br>
Like <code>evio</code>, <code>nbio</code> adopts the classic Reactor pattern. In fact, many asynchronous network frameworks in Go are designed based on this pattern.<br>
Let’s start by running the <code>nbio</code> program code.</p>
<h2 id="server">Server:
</h2><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl"> <span class="err">​</span>
</span></span><span class="line"><span class="cl"> <span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">     <span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">     <span class="s">&#34;github.com/lesismal/nbio&#34;</span>
</span></span><span class="line"><span class="cl"> <span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="err">​</span>
</span></span><span class="line"><span class="cl"> <span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="nx">g</span> <span class="o">:=</span> <span class="nx">nbio</span><span class="p">.</span><span class="nf">NewGopher</span><span class="p">(</span><span class="nx">nbio</span><span class="p">.</span><span class="nx">Config</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="nx">Network</span><span class="p">:</span>            <span class="s">&#34;tcp&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="nx">Addrs</span><span class="p">:</span>              <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;:8888&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">         <span class="nx">MaxWriteBufferSize</span><span class="p">:</span> <span class="mi">6</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">     <span class="p">})</span>
</span></span><span class="line"><span class="cl"> <span class="err">​</span>
</span></span><span class="line"><span class="cl">     <span class="nx">g</span><span class="p">.</span><span class="nf">OnData</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">nbio</span><span class="p">.</span><span class="nx">Conn</span><span class="p">,</span> <span class="nx">data</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="nx">c</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="nb">append</span><span class="p">([]</span><span class="kt">byte</span><span class="p">{},</span> <span class="nx">data</span><span class="o">...</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">     <span class="p">})</span>
</span></span><span class="line"><span class="cl"> <span class="err">​</span>
</span></span><span class="line"><span class="cl">     <span class="nx">err</span> <span class="o">:=</span> <span class="nx">g</span><span class="p">.</span><span class="nf">Start</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">     <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;nbio.Start failed: %v\n&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">         <span class="k">return</span>
</span></span><span class="line"><span class="cl">     <span class="p">}</span>
</span></span><span class="line"><span class="cl"> <span class="err">​</span>
</span></span><span class="line"><span class="cl">     <span class="k">defer</span> <span class="nx">g</span><span class="p">.</span><span class="nf">Stop</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">     <span class="nx">g</span><span class="p">.</span><span class="nf">Wait</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Here, we create a new Engine instance using the <code>nbio.NewGopher()</code> function. We pass a <code>nbio.Config</code> struct to configure the Engine instance, including:</p>
<ul>
<li><code>Network</code>: The type of network to use, which is &ldquo;TCP&rdquo; in this case.</li>
<li><code>Addrs</code>: The addresses and ports the server should listen to, here it&rsquo;s &ldquo;:8888&rdquo; (listening on port 8888 of the local machine).</li>
<li><code>MaxWriteBufferSize</code>: The maximum size of the write buffer, is set to 6MB here.</li>
</ul>
<p>Other configurations can be explored further. Then, we register a data reception callback function using <code>g.OnData()</code> the Engine instance. This callback function is invoked when data is received. It takes two parameters: the connection object <code>c</code> and the received data <code>data</code>. Inside the callback function, we use <code>c.Write()</code> a method to write the received data back to the client.</p>
<h2 id="client">Client:
</h2><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl"> <span class="err">​</span>
</span></span><span class="line"><span class="cl"> <span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">     <span class="s">&#34;bytes&#34;</span>
</span></span><span class="line"><span class="cl">     <span class="s">&#34;context&#34;</span>
</span></span><span class="line"><span class="cl">     <span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">     <span class="s">&#34;math/rand&#34;</span>
</span></span><span class="line"><span class="cl">     <span class="s">&#34;time&#34;</span>
</span></span><span class="line"><span class="cl">     <span class="s">&#34;github.com/lesismal/nbio&#34;</span>
</span></span><span class="line"><span class="cl">     <span class="s">&#34;github.com/lesismal/nbio/logging&#34;</span>
</span></span><span class="line"><span class="cl"> <span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="err">​</span>
</span></span><span class="line"><span class="cl"> <span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="kd">var</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">         <span class="nx">ret</span>  <span class="p">[]</span><span class="kt">byte</span>
</span></span><span class="line"><span class="cl">         <span class="nx">buf</span>  <span class="p">=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">         <span class="nx">addr</span> <span class="p">=</span> <span class="s">&#34;localhost:8888&#34;</span>
</span></span><span class="line"><span class="cl">         <span class="nx">ctx</span><span class="p">,</span> <span class="nx">_</span> <span class="p">=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">WithTimeout</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="mi">60</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">     <span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="err">​</span>
</span></span><span class="line"><span class="cl">     <span class="nx">logging</span><span class="p">.</span><span class="nf">SetLevel</span><span class="p">(</span><span class="nx">logging</span><span class="p">.</span><span class="nx">LevelInfo</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">     <span class="nx">rand</span><span class="p">.</span><span class="nf">Read</span><span class="p">(</span><span class="nx">buf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="err">​</span>
</span></span><span class="line"><span class="cl">     <span class="nx">g</span> <span class="o">:=</span> <span class="nx">nbio</span><span class="p">.</span><span class="nf">NewGopher</span><span class="p">(</span><span class="nx">nbio</span><span class="p">.</span><span class="nx">Config</span><span class="p">{})</span>
</span></span><span class="line"><span class="cl">     <span class="nx">done</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">int</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="err">​</span>
</span></span><span class="line"><span class="cl">     <span class="nx">g</span><span class="p">.</span><span class="nf">OnData</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">nbio</span><span class="p">.</span><span class="nx">Conn</span><span class="p">,</span> <span class="nx">data</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="nx">ret</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">ret</span><span class="p">,</span> <span class="nx">data</span><span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">         <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">ret</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="nx">buf</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">             <span class="k">if</span> <span class="nx">bytes</span><span class="p">.</span><span class="nf">Equal</span><span class="p">(</span><span class="nx">buf</span><span class="p">,</span> <span class="nx">ret</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                 <span class="nb">close</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">             <span class="p">}</span>
</span></span><span class="line"><span class="cl">         <span class="p">}</span>
</span></span><span class="line"><span class="cl">     <span class="p">})</span>
</span></span><span class="line"><span class="cl"> <span class="err">​</span>
</span></span><span class="line"><span class="cl">     <span class="nx">err</span> <span class="o">:=</span> <span class="nx">g</span><span class="p">.</span><span class="nf">Start</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">     <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;Start failed: %v\n&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">     <span class="p">}</span>
</span></span><span class="line"><span class="cl"> <span class="err">​</span>
</span></span><span class="line"><span class="cl">     <span class="k">defer</span> <span class="nx">g</span><span class="p">.</span><span class="nf">Stop</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"> <span class="err">​</span>
</span></span><span class="line"><span class="cl">     <span class="nx">c</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">nbio</span><span class="p">.</span><span class="nf">Dial</span><span class="p">(</span><span class="s">&#34;tcp&#34;</span><span class="p">,</span> <span class="nx">addr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">     <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;Dial failed: %v\n&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">     <span class="p">}</span>
</span></span><span class="line"><span class="cl"> <span class="err">​</span>
</span></span><span class="line"><span class="cl">     <span class="nx">g</span><span class="p">.</span><span class="nf">AddConn</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">     <span class="nx">c</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="nx">buf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="err">​</span>
</span></span><span class="line"><span class="cl">     <span class="k">select</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="k">case</span> <span class="o">&lt;-</span><span class="nx">ctx</span><span class="p">.</span><span class="nf">Done</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">         <span class="nx">logging</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="s">&#34;timeout&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">     <span class="k">case</span> <span class="o">&lt;-</span><span class="nx">done</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">         <span class="nx">logging</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;success&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">     <span class="p">}</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>At first glance, it might seem a bit cumbersome. Actually, the server and client share the same set of structures.</p>
<p>The client connects to the server through <code>nbio.Dial</code>, and upon successful connection, it encapsulates into <code>nbio.Conn</code>. Here, <code>nbio.Conn</code> implements the <code>net.Conn</code> interface of the standard library. Finally, it adds this connection via <code>g.AddConn(c)</code> and writes data to the server. When the server receives the data, its handling logic is to send the data back to the client as is. When the client receives the data, the <code>OnData</code> callback is triggered. This callback checks if the received data length matches the sent data length, and if so, it closes the connection.</p>
<p>Now, let’s delve into a few key structures.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">Engine</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="c1">//...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>     <span class="nx">sync</span><span class="p">.</span><span class="nx">WaitGroup</span>
</span></span><span class="line"><span class="cl">     <span class="c1">//...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>     <span class="nx">mux</span>                        <span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span>
</span></span><span class="line"><span class="cl">     <span class="nx">wgConn</span>                     <span class="nx">sync</span><span class="p">.</span><span class="nx">WaitGroup</span>
</span></span><span class="line"><span class="cl">     <span class="nx">network</span>                    <span class="kt">string</span>
</span></span><span class="line"><span class="cl">     <span class="nx">addrs</span>                      <span class="p">[]</span><span class="kt">string</span>
</span></span><span class="line"><span class="cl">     <span class="c1">//...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>     <span class="nx">connsStd</span>                   <span class="kd">map</span><span class="p">[</span><span class="o">*</span><span class="nx">Conn</span><span class="p">]</span><span class="kd">struct</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">     <span class="nx">connsUnix</span>                  <span class="p">[]</span><span class="o">*</span><span class="nx">Conn</span>
</span></span><span class="line"><span class="cl">     <span class="nx">listeners</span>                  <span class="p">[]</span><span class="o">*</span><span class="nx">poller</span>
</span></span><span class="line"><span class="cl">     <span class="nx">pollers</span>                    <span class="p">[]</span><span class="o">*</span><span class="nx">poller</span>
</span></span><span class="line"><span class="cl">     <span class="nx">onOpen</span>                     <span class="kd">func</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Conn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">     <span class="nx">onClose</span>                    <span class="kd">func</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Conn</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">     <span class="nx">onRead</span>                     <span class="kd">func</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Conn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">     <span class="nx">onData</span>                     <span class="kd">func</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Conn</span><span class="p">,</span> <span class="nx">data</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">     <span class="nx">onReadBufferAlloc</span>          <span class="kd">func</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Conn</span><span class="p">)</span> <span class="p">[]</span><span class="kt">byte</span>
</span></span><span class="line"><span class="cl">     <span class="nx">onReadBufferFree</span>           <span class="kd">func</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Conn</span><span class="p">,</span> <span class="nx">buffer</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">     <span class="c1">//...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The <code>Engine</code> is essentially the core manager, responsible for managing all listeners, pollers, and worker pollers.</p>
<p>What’s the difference between these two types of pollers?</p>
<p>The difference lies in their responsibilities.</p>
<p>The listener poller is responsible only for accepting new connections. When a new client <code>conn</code> arrives, it selects a worker poller from <code>pollers</code> and adds <code>conn</code> to the corresponding worker poller. Subsequently, the worker poller is responsible for handling the read/write events of this <code>conn</code>.</p>
<p>Therefore, when we start the program, if only one address is being listened to, the number of polls in the program equals 1 (listener poller) + <code>pollerNum</code>.</p>
<p>From the fields above, you can customize some configurations and callbacks. For example, you can set a callback function <code>onOpen</code> when a new connection arrives, or set a callback function <code>onData</code> when data arrives, etc.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">Conn</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="nx">mux</span>                   <span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span>
</span></span><span class="line"><span class="cl">     <span class="nx">p</span>                     <span class="o">*</span><span class="nx">poller</span>
</span></span><span class="line"><span class="cl">     <span class="nx">fd</span>                    <span class="kt">int</span>
</span></span><span class="line"><span class="cl">     <span class="c1">//...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>     <span class="nx">writeBuffer</span>           <span class="p">[]</span><span class="kt">byte</span>
</span></span><span class="line"><span class="cl">     <span class="c1">//...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>     <span class="nx">DataHandler</span>           <span class="kd">func</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Conn</span><span class="p">,</span> <span class="nx">data</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The <code>Conn</code> structure represents a network connection. Each <code>conn</code> belongs to only one poller. <code>writeBuffer</code>: When data is not completely written at once, the remaining data is first stored in <code>writeBuffer</code> and waits for the next writable event to continue writing.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">poller</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="nx">g</span>             <span class="o">*</span><span class="nx">Engine</span>
</span></span><span class="line"><span class="cl">     <span class="nx">epfd</span>          <span class="kt">int</span>
</span></span><span class="line"><span class="cl">     <span class="nx">evtfd</span>         <span class="kt">int</span>
</span></span><span class="line"><span class="cl">     <span class="nx">index</span>         <span class="kt">int</span>
</span></span><span class="line"><span class="cl">     <span class="nx">shutdown</span>      <span class="kt">bool</span>
</span></span><span class="line"><span class="cl">     <span class="nx">listener</span>      <span class="nx">net</span><span class="p">.</span><span class="nx">Listener</span>
</span></span><span class="line"><span class="cl">     <span class="nx">isListener</span>    <span class="kt">bool</span>
</span></span><span class="line"><span class="cl">     <span class="nx">unixSockAddr</span>  <span class="kt">string</span>
</span></span><span class="line"><span class="cl">     <span class="nx">ReadBuffer</span>    <span class="p">[]</span><span class="kt">byte</span>
</span></span><span class="line"><span class="cl">     <span class="nx">pollType</span>      <span class="kt">string</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>As for the <code>poller</code> structure, it&rsquo;s an abstract concept used to manage underlying multiplexed I/O operations (such as epoll on Linux, kqueue on Darwin, etc.).</p>
<p>Pay attention to <code>pollType</code>, nbio defaults to epoll using level-triggered (LT) mode, but users can also set it to edge-triggered (ET) mode.</p>
<p>After introducing the basic structures, let’s move on to the code flow.</p>
<p>When you start the server code provided above, when you call <code>Start</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">g</span> <span class="o">*</span><span class="nx">Engine</span><span class="p">)</span> <span class="nf">Start</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="c1">//...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>     <span class="k">switch</span> <span class="nx">g</span><span class="p">.</span><span class="nx">network</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="c1">// First part: initialize listener
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>     <span class="k">case</span> <span class="s">&#34;unix&#34;</span><span class="p">,</span> <span class="s">&#34;tcp&#34;</span><span class="p">,</span> <span class="s">&#34;tcp4&#34;</span><span class="p">,</span> <span class="s">&#34;tcp6&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">         <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">g</span><span class="p">.</span><span class="nx">addrs</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">             <span class="nx">ln</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">newPoller</span><span class="p">(</span><span class="nx">g</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">             <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                 <span class="k">for</span> <span class="nx">j</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="p">&lt;</span> <span class="nx">i</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                     <span class="nx">g</span><span class="p">.</span><span class="nx">listeners</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nf">stop</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                 <span class="p">}</span>
</span></span><span class="line"><span class="cl">                 <span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">             <span class="p">}</span>
</span></span><span class="line"><span class="cl">             <span class="nx">g</span><span class="p">.</span><span class="nx">addrs</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nx">ln</span><span class="p">.</span><span class="nx">listener</span><span class="p">.</span><span class="nf">Addr</span><span class="p">().</span><span class="nf">String</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">             <span class="nx">g</span><span class="p">.</span><span class="nx">listeners</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">g</span><span class="p">.</span><span class="nx">listeners</span><span class="p">,</span> <span class="nx">ln</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">         <span class="p">}</span>
</span></span><span class="line"><span class="cl">     <span class="c1">//...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>     <span class="c1">// Second part: initialize a certain number of pollers
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>     <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">g</span><span class="p">.</span><span class="nx">pollerNum</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="nx">p</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">newPoller</span><span class="p">(</span><span class="nx">g</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">         <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">             <span class="k">for</span> <span class="nx">j</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="p">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="nx">g</span><span class="p">.</span><span class="nx">listeners</span><span class="p">);</span> <span class="nx">j</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                 <span class="nx">g</span><span class="p">.</span><span class="nx">listeners</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nf">stop</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">             <span class="p">}</span>
</span></span><span class="line"><span class="cl">             <span class="k">for</span> <span class="nx">j</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="p">&lt;</span> <span class="nx">i</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                 <span class="nx">g</span><span class="p">.</span><span class="nx">pollers</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nf">stop</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">             <span class="p">}</span>
</span></span><span class="line"><span class="cl">             <span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">         <span class="p">}</span>
</span></span><span class="line"><span class="cl">         <span class="nx">g</span><span class="p">.</span><span class="nx">pollers</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nx">p</span>
</span></span><span class="line"><span class="cl">     <span class="p">}</span>
</span></span><span class="line"><span class="cl">     <span class="c1">//...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>     <span class="c1">// Third part: start all worker pollers
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>     <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">g</span><span class="p">.</span><span class="nx">pollerNum</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="nx">g</span><span class="p">.</span><span class="nx">pollers</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">ReadBuffer</span> <span class="p">=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">g</span><span class="p">.</span><span class="nx">readBufferSize</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">         <span class="nx">g</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">         <span class="k">go</span> <span class="nx">g</span><span class="p">.</span><span class="nx">pollers</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nf">start</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">     <span class="p">}</span>
</span></span><span class="line"><span class="cl">     <span class="c1">// Fourth part: start all listeners
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>     <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">l</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">g</span><span class="p">.</span><span class="nx">listeners</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="nx">g</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">         <span class="k">go</span> <span class="nx">l</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">     <span class="p">}</span>
</span></span><span class="line"><span class="cl">     <span class="c1">//... (ignore UDP)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>     <span class="c1">//...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The code is understandable. It’s divided into four parts:</p>
<p><strong>First part: initialize listener</strong></p>
<p>Based on the <code>g.network</code> value (e.g., &ldquo;unix&rdquo;, &ldquo;tcp&rdquo;, &ldquo;tcp4&rdquo;, &ldquo;tcp6&rdquo;), create a new poller for each address to listen on. This poller mainly manages events on the listening socket. If an error occurs during creation, stop all previously created listeners and return an error.</p>
<p><strong>Second part: initialize a certain number of pollers</strong></p>
<p>Create the specified number of worker pollers ( <code>pollerNum</code>). These pollers handle read/write events on connected sockets. If an error occurs during creation, stop all listeners and previously created worker pollers, and then return an error.</p>
<p><strong>Third part: start all worker pollers</strong></p>
<p>Assign a read buffer for each worker poller concurrently and start these pollers.</p>
<p><strong>Fourth part: start all listeners</strong></p>
<p>Start all previously created listeners and begin listening for connection requests on respective addresses.</p>
<p>Regarding the startup of pollers:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">poller</span><span class="p">)</span> <span class="nf">start</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="k">defer</span> <span class="nx">p</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nf">Done</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">     <span class="c1">//...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>     <span class="k">if</span> <span class="nx">p</span><span class="p">.</span><span class="nx">isListener</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="nx">p</span><span class="p">.</span><span class="nf">acceptorLoop</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">     <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">             <span class="nx">syscall</span><span class="p">.</span><span class="nf">Close</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">epfd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">             <span class="nx">syscall</span><span class="p">.</span><span class="nf">Close</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">evtfd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">         <span class="p">}()</span>
</span></span><span class="line"><span class="cl">         <span class="nx">p</span><span class="p">.</span><span class="nf">readWriteLoop</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">     <span class="p">}</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>It’s divided into two cases. If it’s a listener poller:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">poller</span><span class="p">)</span> <span class="nf">acceptorLoop</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="c1">// If you want the current goroutine not to be scheduled to other operation threads.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>     <span class="k">if</span> <span class="nx">p</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nx">lockListener</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="nx">runtime</span><span class="p">.</span><span class="nf">LockOSThread</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">         <span class="k">defer</span> <span class="nx">runtime</span><span class="p">.</span><span class="nf">UnlockOSThread</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">     <span class="p">}</span>
</span></span><span class="line"><span class="cl">     <span class="nx">p</span><span class="p">.</span><span class="nx">shutdown</span> <span class="p">=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">     <span class="k">for</span> <span class="p">!</span><span class="nx">p</span><span class="p">.</span><span class="nx">shutdown</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="nx">conn</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">listener</span><span class="p">.</span><span class="nf">Accept</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">         <span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">             <span class="kd">var</span> <span class="nx">c</span> <span class="o">*</span><span class="nx">Conn</span>
</span></span><span class="line"><span class="cl">             <span class="nx">c</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nf">NBConn</span><span class="p">(</span><span class="nx">conn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">             <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                 <span class="nx">conn</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                 <span class="k">continue</span>
</span></span><span class="line"><span class="cl">             <span class="p">}</span>
</span></span><span class="line"><span class="cl">             <span class="c1">// p.g.pollers[c.Hash()%len(p.g.pollers)].addConn(c)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">             <span class="kd">var</span> <span class="nx">ne</span> <span class="nx">net</span><span class="p">.</span><span class="nx">Error</span>
</span></span><span class="line"><span class="cl">             <span class="k">if</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">As</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">ne</span><span class="p">);</span> <span class="nx">ok</span> <span class="o">&amp;&amp;</span> <span class="nx">ne</span><span class="p">.</span><span class="nf">Timeout</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                 <span class="nx">logging</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="s">&#34;NBIO[%v][%v_%v] Accept failed: temporary error, retrying...&#34;</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">pollType</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">index</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                 <span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span> <span class="o">/</span> <span class="mi">20</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">             <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                 <span class="k">if</span> <span class="p">!</span><span class="nx">p</span><span class="p">.</span><span class="nx">shutdown</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                     <span class="nx">logging</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="s">&#34;NBIO[%v][%v_%v] Accept failed: %v, exit...&#34;</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">pollType</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">index</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                 <span class="p">}</span>
</span></span><span class="line"><span class="cl">                 <span class="k">break</span>
</span></span><span class="line"><span class="cl">             <span class="p">}</span>
</span></span><span class="line"><span class="cl">         <span class="p">}</span>
</span></span><span class="line"><span class="cl">     <span class="p">}</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The listener poller waits for new connections and, upon arrival, encapsulates them into <code>nbio.Conn</code> after acceptance. Then, it adds the <code>conn</code> to the corresponding worker poller.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">poller</span><span class="p">)</span> <span class="nf">addConn</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Conn</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="nx">c</span><span class="p">.</span><span class="nx">p</span> <span class="p">=</span> <span class="nx">p</span>
</span></span><span class="line"><span class="cl">     <span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">typ</span> <span class="o">!=</span> <span class="nx">ConnTypeUDPServer</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="nx">p</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nf">onOpen</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">     <span class="p">}</span>
</span></span><span class="line"><span class="cl">     <span class="nx">fd</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">fd</span>
</span></span><span class="line"><span class="cl">     <span class="nx">p</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nx">connsUnix</span><span class="p">[</span><span class="nx">fd</span><span class="p">]</span> <span class="p">=</span> <span class="nx">c</span>
</span></span><span class="line"><span class="cl">     <span class="nx">err</span> <span class="o">:=</span> <span class="nx">p</span><span class="p">.</span><span class="nf">addRead</span><span class="p">(</span><span class="nx">fd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">     <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="nx">p</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nx">connsUnix</span><span class="p">[</span><span class="nx">fd</span><span class="p">]</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">         <span class="nx">c</span><span class="p">.</span><span class="nf">closeWithError</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">         <span class="nx">logging</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="s">&#34;[%v] add read event failed: %v&#34;</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">fd</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">     <span class="p">}</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>An interesting design here is the management of <code>conns</code>. The structure is a slice, and the author directly uses <code>conn</code>&rsquo;s <code>fd</code> as the index. This has its benefits:</p>
<ul>
<li>With a large number of connections, the burden during garbage collection is smaller compared to using a map.</li>
<li>It prevents serial number issues.</li>
</ul>
<p>Finally, the corresponding <code>conn</code> fd is added to epoll by calling <code>addRead</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">poller</span><span class="p">)</span> <span class="nf">addRead</span><span class="p">(</span><span class="nx">fd</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="k">switch</span> <span class="nx">p</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nx">epollMod</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="k">case</span> <span class="nx">EPOLLET</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">         <span class="k">return</span> <span class="nx">syscall</span><span class="p">.</span><span class="nf">EpollCtl</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">epfd</span><span class="p">,</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">EPOLL_CTL_ADD</span><span class="p">,</span> <span class="nx">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">syscall</span><span class="p">.</span><span class="nx">EpollEvent</span><span class="p">{</span><span class="nx">Fd</span><span class="p">:</span> <span class="nb">int32</span><span class="p">(</span><span class="nx">fd</span><span class="p">),</span> <span class="nx">Events</span><span class="p">:</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">EPOLLERR</span> <span class="p">|</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">EPOLLHUP</span> <span class="p">|</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">EPOLLRDHUP</span> <span class="p">|</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">EPOLLPRI</span> <span class="p">|</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">EPOLLIN</span> <span class="p">|</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">EPOLLET</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">     <span class="k">default</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">         <span class="k">return</span> <span class="nx">syscall</span><span class="p">.</span><span class="nf">EpollCtl</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">epfd</span><span class="p">,</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">EPOLL_CTL_ADD</span><span class="p">,</span> <span class="nx">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">syscall</span><span class="p">.</span><span class="nx">E</span>
</span></span><span class="line"><span class="cl"> <span class="err">​</span>
</span></span><span class="line"><span class="cl"> <span class="nx">pollEvent</span><span class="p">{</span><span class="nx">Fd</span><span class="p">:</span> <span class="nb">int32</span><span class="p">(</span><span class="nx">fd</span><span class="p">),</span> <span class="nx">Events</span><span class="p">:</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">EPOLLERR</span> <span class="p">|</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">EPOLLHUP</span> <span class="p">|</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">EPOLLRDHUP</span> <span class="p">|</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">EPOLLPRI</span> <span class="p">|</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">EPOLLIN</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">     <span class="p">}</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>It’s reasonable not to register the write event here because there’s no data to send on a new connection. This approach avoids some unnecessary system calls, thereby enhancing program performance.</p>
<p>If it’s a worker poller’s startup, its job is to wait for events from the added <code>conns</code> and handle them accordingly.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">poller</span><span class="p">)</span> <span class="nf">readWriteLoop</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="c1">//...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>     <span class="nx">msec</span> <span class="o">:=</span> <span class="o">-</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">     <span class="nx">events</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="nx">syscall</span><span class="p">.</span><span class="nx">EpollEvent</span><span class="p">,</span> <span class="mi">1024</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">     <span class="c1">//...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>     <span class="k">for</span> <span class="p">!</span><span class="nx">p</span><span class="p">.</span><span class="nx">shutdown</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="nx">n</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">syscall</span><span class="p">.</span><span class="nf">EpollWait</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">epfd</span><span class="p">,</span> <span class="nx">events</span><span class="p">,</span> <span class="nx">msec</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">         <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">errors</span><span class="p">.</span><span class="nf">Is</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">EINTR</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">             <span class="k">return</span>
</span></span><span class="line"><span class="cl">         <span class="p">}</span>
</span></span><span class="line"><span class="cl">         <span class="k">if</span> <span class="nx">n</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">             <span class="nx">msec</span> <span class="p">=</span> <span class="o">-</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">             <span class="k">continue</span>
</span></span><span class="line"><span class="cl">         <span class="p">}</span>
</span></span><span class="line"><span class="cl">         <span class="nx">msec</span> <span class="p">=</span> <span class="mi">20</span>
</span></span><span class="line"><span class="cl">         <span class="c1">// Traverse events
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>         <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">ev</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">events</span><span class="p">[:</span><span class="nx">n</span><span class="p">]</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">             <span class="nx">fd</span> <span class="o">:=</span> <span class="nb">int</span><span class="p">(</span><span class="nx">ev</span><span class="p">.</span><span class="nx">Fd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">             <span class="k">switch</span> <span class="nx">fd</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">             <span class="k">case</span> <span class="nx">p</span><span class="p">.</span><span class="nx">evtfd</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">             <span class="k">default</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                 <span class="nx">c</span> <span class="o">:=</span> <span class="nx">p</span><span class="p">.</span><span class="nf">getConn</span><span class="p">(</span><span class="nx">fd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                 <span class="k">if</span> <span class="nx">c</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                     <span class="k">if</span> <span class="nx">ev</span><span class="p">.</span><span class="nx">Events</span><span class="o">&amp;</span><span class="nx">epollEventsError</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                         <span class="nx">c</span><span class="p">.</span><span class="nf">closeWithError</span><span class="p">(</span><span class="nx">io</span><span class="p">.</span><span class="nx">EOF</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                         <span class="k">continue</span>
</span></span><span class="line"><span class="cl">                     <span class="p">}</span>
</span></span><span class="line"><span class="cl">                     <span class="c1">// If it&#39;s writable, flush the data
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                     <span class="k">if</span> <span class="nx">ev</span><span class="p">.</span><span class="nx">Events</span><span class="o">&amp;</span><span class="nx">epollEventsWrite</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                         <span class="nx">c</span><span class="p">.</span><span class="nf">flush</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                     <span class="p">}</span>
</span></span><span class="line"><span class="cl">                     <span class="c1">// Read event
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                     <span class="k">if</span> <span class="nx">ev</span><span class="p">.</span><span class="nx">Events</span><span class="o">&amp;</span><span class="nx">epollEventsRead</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                         <span class="k">if</span> <span class="nx">p</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nx">onRead</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                             <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">p</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nx">maxConnReadTimesPerEventLoop</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                 <span class="nx">buffer</span> <span class="o">:=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nf">borrow</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                 <span class="nx">rc</span><span class="p">,</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">ReadAndGetConn</span><span class="p">(</span><span class="nx">buffer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                 <span class="k">if</span> <span class="nx">n</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                     <span class="nx">p</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nf">onData</span><span class="p">(</span><span class="nx">rc</span><span class="p">,</span> <span class="nx">buffer</span><span class="p">[:</span><span class="nx">n</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">                                 <span class="p">}</span>
</span></span><span class="line"><span class="cl">                                 <span class="nx">p</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nf">payback</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">buffer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                 <span class="c1">//...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                                 <span class="k">if</span> <span class="nx">n</span> <span class="p">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="nx">buffer</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                     <span class="k">break</span>
</span></span><span class="line"><span class="cl">                                 <span class="p">}</span>
</span></span><span class="line"><span class="cl">                             <span class="p">}</span>
</span></span><span class="line"><span class="cl">                         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                             <span class="nx">p</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nf">onRead</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                         <span class="p">}</span>
</span></span><span class="line"><span class="cl">                     <span class="p">}</span>
</span></span><span class="line"><span class="cl">                 <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                     <span class="nx">syscall</span><span class="p">.</span><span class="nf">Close</span><span class="p">(</span><span class="nx">fd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                 <span class="p">}</span>
</span></span><span class="line"><span class="cl">             <span class="p">}</span>
</span></span><span class="line"><span class="cl">         <span class="p">}</span>
</span></span><span class="line"><span class="cl">     <span class="p">}</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>This piece of code is also straightforward. It waits for events to arrive, traverses the event list, and handles each event accordingly.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">EpollWait</span><span class="p">(</span><span class="nx">epfd</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">events</span> <span class="p">[]</span><span class="nx">EpollEvent</span><span class="p">,</span> <span class="nx">msec</span> <span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="nx">n</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>In <code>EpollWait</code>, only <code>msec</code> is user-modifiable. Usually, we set <code>msec = -1</code> to make the function block until at least one event occurs; otherwise, it blocks indefinitely. This method is very useful when there are few events because it minimizes CPU usage.</p>
<p>If you want to respond to events as quickly as possible, you can set <code>msec = 0</code>. This makes <code>EpollWait</code> return immediately without waiting for any events. In this case, your program may call <code>EpollWait</code> more frequently, but it can process events immediately after they occur, leading to higher CPU usage.</p>
<p>If your program can tolerate some delay and you want to reduce CPU usage, you can set <code>msec</code> it to a positive number. This makes <code>EpollWait</code> waiting for events for the specified time. If no events occur during this time, the function returns, and you can choose to call <code>EpollWait</code> again later. This method can reduce CPU usage but may result in longer response times.</p>
<p>Nbio adjusts the value <code>msec</code> according to event counts. If the count is greater than 0, <code>msec</code> is set to 20.</p>
<p>The code for ByteDance’s netpoll is similar; if the event count is greater than 0, <code>msec</code> it is set to 0. If the event count is less than or equal to 0, <code>msec</code> it is set to -1, and then <code>Gosched()</code> is called to voluntarily yield the current Goroutine.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">msec</span> <span class="p">=</span> <span class="o">-</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"> <span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="nx">n</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">syscall</span><span class="p">.</span><span class="nf">EpollWait</span><span class="p">(</span><span class="nx">epfd</span><span class="p">,</span> <span class="nx">events</span><span class="p">,</span> <span class="nx">msec</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">     <span class="k">if</span> <span class="nx">n</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="nx">msec</span> <span class="p">=</span> <span class="o">-</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">         <span class="nx">runtime</span><span class="p">.</span><span class="nf">Gosched</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">         <span class="k">continue</span>
</span></span><span class="line"><span class="cl">     <span class="p">}</span>
</span></span><span class="line"><span class="cl">     <span class="nx">msec</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">     <span class="o">...</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>However, the code for voluntary switching in nbio has been commented out. According to the author’s explanation in the issue, initially, he referred to ByteDance’s method and added voluntary switching.</p>
<p>However, during performance testing of nbio, it was found that adding or not adding voluntary switching did not significantly affect performance. Therefore, it was ultimately decided to remove it.</p>
<p><strong>The processing part of the event.</strong></p>
<p>If it is a readable event, you can obtain the corresponding buffer through built-in or custom memory allocators, and then call ReadAndGetConn to read the data without needing to allocate a buffer every time.</p>
<p>If it is a writable event, flush will be called to send out the unsent data in the buffer.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Conn</span><span class="p">)</span> <span class="nf">flush</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="c1">//.....
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">old</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">writeBuffer</span>
</span></span><span class="line"><span class="cl">   <span class="nx">n</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">doWrite</span><span class="p">(</span><span class="nx">old</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">errors</span><span class="p">.</span><span class="nf">Is</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">EINTR</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">errors</span><span class="p">.</span><span class="nf">Is</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">EAGAIN</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="c1">//.....
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="p">}</span>
</span></span><span class="line"><span class="cl"> <span class="err">​</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="nx">n</span> <span class="p">&lt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="nx">n</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="nx">left</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="nx">old</span><span class="p">)</span> <span class="o">-</span> <span class="nx">n</span>
</span></span><span class="line"><span class="cl">   <span class="c1">// The description is not finished, so store the rest in writeBuffer for next writing.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="k">if</span> <span class="nx">left</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="k">if</span> <span class="nx">n</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">       <span class="nx">c</span><span class="p">.</span><span class="nx">writeBuffer</span> <span class="p">=</span> <span class="nx">mempool</span><span class="p">.</span><span class="nf">Malloc</span><span class="p">(</span><span class="nx">left</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">       <span class="nb">copy</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">writeBuffer</span><span class="p">,</span> <span class="nx">old</span><span class="p">[</span><span class="nx">n</span><span class="p">:])</span>
</span></span><span class="line"><span class="cl">       <span class="nx">mempool</span><span class="p">.</span><span class="nf">Free</span><span class="p">(</span><span class="nx">old</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">     <span class="p">}</span>
</span></span><span class="line"><span class="cl">     <span class="c1">// c.modWrite()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="nx">mempool</span><span class="p">.</span><span class="nf">Free</span><span class="p">(</span><span class="nx">old</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">     <span class="nx">c</span><span class="p">.</span><span class="nx">writeBuffer</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">     <span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">wTimer</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">       <span class="nx">c</span><span class="p">.</span><span class="nx">wTimer</span><span class="p">.</span><span class="nf">Stop</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">       <span class="nx">c</span><span class="p">.</span><span class="nx">wTimer</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">     <span class="p">}</span>
</span></span><span class="line"><span class="cl">     <span class="c1">// The explanation is finished, reset the conn to only have read events first.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>     <span class="nx">c</span><span class="p">.</span><span class="nf">resetRead</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">     <span class="c1">//...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="p">}</span>
</span></span><span class="line"><span class="cl"> <span class="err">​</span>
</span></span><span class="line"><span class="cl">   <span class="nx">c</span><span class="p">.</span><span class="nx">mux</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">   <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The logic is also very simple, write as much as there is, if it cannot be written, put the remaining data back into the writeBuffer and write again when epollWait triggers.</p>
<p>If writing is completed, then there is no more data to be written, reset the event of this connection to a read event.</p>
<p>That’s basically how the main logic works.</p>
<p>Wait a minute, when we initially mentioned that a new connection comes in, we only registered a read event for the connection and didn’t register a write event. When was the write event registered?</p>
<p>Of course, it is registered when you call conn.Write.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">g</span> <span class="o">:=</span> <span class="nx">nbio</span><span class="p">.</span><span class="nf">NewGopher</span><span class="p">(</span><span class="nx">nbio</span><span class="p">.</span><span class="nx">Config</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="nx">Network</span><span class="p">:</span>            <span class="s">&#34;tcp&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">     <span class="nx">Addrs</span><span class="p">:</span>              <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;:8888&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">     <span class="nx">MaxWriteBufferSize</span><span class="p">:</span> <span class="mi">6</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">   <span class="p">})</span>
</span></span><span class="line"><span class="cl"> <span class="err">​</span>
</span></span><span class="line"><span class="cl">   <span class="nx">g</span><span class="p">.</span><span class="nf">OnData</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">nbio</span><span class="p">.</span><span class="nx">Conn</span><span class="p">,</span> <span class="nx">data</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="nx">c</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="nb">append</span><span class="p">([]</span><span class="kt">byte</span><span class="p">{},</span> <span class="nx">data</span><span class="o">...</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">   <span class="p">})</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>When conn data arrives, the bottom layer will call back the OnData function after reading the data. At this time, you can call Write to send data to the other end.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">g</span> <span class="o">:=</span> <span class="nx">nbio</span><span class="p">.</span><span class="nf">NewGopher</span><span class="p">(</span><span class="nx">nbio</span><span class="p">.</span><span class="nx">Config</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="nx">Network</span><span class="p">:</span>            <span class="s">&#34;tcp&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">     <span class="nx">Addrs</span><span class="p">:</span>              <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;:8888&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">     <span class="nx">MaxWriteBufferSize</span><span class="p">:</span> <span class="mi">6</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">   <span class="p">})</span>
</span></span><span class="line"><span class="cl"> <span class="err">​</span>
</span></span><span class="line"><span class="cl">   <span class="nx">g</span><span class="p">.</span><span class="nf">OnData</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">nbio</span><span class="p">.</span><span class="nx">Conn</span><span class="p">,</span> <span class="nx">data</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="nx">c</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="nb">append</span><span class="p">([]</span><span class="kt">byte</span><span class="p">{},</span> <span class="nx">data</span><span class="o">...</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">   <span class="p">})</span>
</span></span><span class="line"><span class="cl"> <span class="c1">// When data arrives on conn, the underlying layer will read the data and callback the OnData function. At this time, you can call Write to send data to the other end.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="err">​</span>
</span></span><span class="line"><span class="cl"> <span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Conn</span><span class="p">)</span> <span class="nf">Write</span><span class="p">(</span><span class="nx">b</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="c1">//....
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">n</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">errors</span><span class="p">.</span><span class="nf">Is</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">EINTR</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">errors</span><span class="p">.</span><span class="nf">Is</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">EAGAIN</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="c1">//.....
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>     <span class="k">return</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl"> <span class="err">​</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">writeBuffer</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">wTimer</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">       <span class="nx">c</span><span class="p">.</span><span class="nx">wTimer</span><span class="p">.</span><span class="nf">Stop</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">       <span class="nx">c</span><span class="p">.</span><span class="nx">wTimer</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">     <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="c1">// There is still data that has not been written, add a write event.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>     <span class="nx">c</span><span class="p">.</span><span class="nf">modWrite</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="c1">//.....
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="k">return</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span><span class="line"><span class="cl"> <span class="err">​</span>
</span></span><span class="line"><span class="cl"> <span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Conn</span><span class="p">)</span> <span class="nf">write</span><span class="p">(</span><span class="nx">b</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="c1">//...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">writeBuffer</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="nx">n</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">doWrite</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">     <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">errors</span><span class="p">.</span><span class="nf">Is</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">EINTR</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">errors</span><span class="p">.</span><span class="nf">Is</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">EAGAIN</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">       <span class="k">return</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">     <span class="p">}</span>
</span></span><span class="line"><span class="cl">     <span class="c1">//.....
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">     <span class="nx">left</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span> <span class="o">-</span> <span class="nx">n</span>
</span></span><span class="line"><span class="cl"> <span class="c1">// Not finished yet, put the remaining into writeBuffer.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>     <span class="k">if</span> <span class="nx">left</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">c</span><span class="p">.</span><span class="nx">typ</span> <span class="o">==</span> <span class="nx">ConnTypeTCP</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">       <span class="nx">c</span><span class="p">.</span><span class="nx">writeBuffer</span> <span class="p">=</span> <span class="nx">mempool</span><span class="p">.</span><span class="nf">Malloc</span><span class="p">(</span><span class="nx">left</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">       <span class="nb">copy</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">writeBuffer</span><span class="p">,</span> <span class="nx">b</span><span class="p">[</span><span class="nx">n</span><span class="p">:])</span>
</span></span><span class="line"><span class="cl">       <span class="nx">c</span><span class="p">.</span><span class="nf">modWrite</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">     <span class="p">}</span>
</span></span><span class="line"><span class="cl">     <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="nx">b</span><span class="p">),</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl"> <span class="c1">// If there is still unwritten data in the writeBuffer, the new data will also be appended.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">c</span><span class="p">.</span><span class="nx">writeBuffer</span> <span class="p">=</span> <span class="nx">mempool</span><span class="p">.</span><span class="nf">Append</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">writeBuffer</span><span class="p">,</span> <span class="nx">b</span><span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="err">​</span>
</span></span><span class="line"><span class="cl">   <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="nx">b</span><span class="p">),</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>When the data is not completely written, the remaining data is put into writeBuffer, which will trigger the execution of modWrite and register the write event of conn to epoll.</p>
<h2 id="summary">Summary
</h2><p>Compared to Evio, nbio does not have a thundering herd effect.<br>
Evio achieves logical correctness by constantly waking up epoll invalidly. Nbio tries to minimize system calls and reduce unnecessary overhead.</p>
<p>In terms of usability, nbio implements a standard library net.Conn and many settings are configurable, allowing users to customize with high flexibility.<br>
Pre-allocated buffers are used for reading and writing to improve application performance.<br>
In conclusion, nbio is a good high-performance non-blocking network framework.</p>

</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/golang/">Golang</a>
        
    </section>


    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    </footer>


    
</article>

    

    

<ins class="adsbygoogle"
   style="display:block"
   data-ad-client="ca-pub-9000447749076746"
   data-ad-slot="5063552270"
   data-ad-format="auto"
   data-full-width-responsive="true"></ins>
<script>
   (adsbygoogle = window.adsbygoogle || []).push({});
</script>
<aside class="related-content--wrapper">
    <h2 class="section-title">Related content</h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="">
    <a href="/p/go-high-performance-programming-ep10-two-useful-golang-lock-free-programming-tips/">
        
        

        <div class="article-details">
            <h2 class="article-title">Go High-Performance Programming EP10: Two Useful Golang Lock-Free Programming Tips</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/swisstable-a-high-performance-hash-table-implementation/">
        
        
            <div class="article-image">
                
                    <img src="https://images.hxzhouh.com/blog-images/2024/09/f08c74aea8485d51d461d18494df416e.png" loading="lazy" data-key="" data-hash="https://images.hxzhouh.com/blog-images/2024/09/f08c74aea8485d51d461d18494df416e.png"/>
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">SwissTable: A High-Performance Hash Table Implementation</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/go-high-performance-programming-ep9-escape-analysis/">
        
        
            <div class="article-image">
                
                    <img src="https://images.hxzhouh.com/blog-images/2024/08/317a5c9d3df72bec002eb7c0bd64c06d.png" loading="lazy" data-key="" data-hash="https://images.hxzhouh.com/blog-images/2024/08/317a5c9d3df72bec002eb7c0bd64c06d.png"/>
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">Go High-Performance Programming EP9: Escape Analysis</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/performance-profiling-of-golangs-biggest-killers-pprof/">
        
        
            <div class="article-image">
                
                    <img src="https://images.yixiao9206.cn/blog-images/2024/05/acdc34e1b74e3daad61599c01f949411.png" loading="lazy" data-key="" data-hash="https://images.yixiao9206.cn/blog-images/2024/05/acdc34e1b74e3daad61599c01f949411.png"/>
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">Performance Profiling of Golang&#39;s Biggest Killers: PProf</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/how-to-analyze-go-code-in-assembly/">
        
        

        <div class="article-details">
            <h2 class="article-title">How to analyze Go code in assembly</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>


    
        
    <script src="//cdn.jsdelivr.net/npm/twikoo@1.6.21/dist/twikoo.all.min.js"></script>
<div id="tcomment"></div>
<style>
    .twikoo {
        background-color: var(--card-background);
        border-radius: var(--card-border-radius);
        box-shadow: var(--shadow-l1);
        padding: var(--card-padding);
    }
    :root[data-scheme="dark"] {
        --twikoo-body-text-color-main: rgba(255, 255, 255, 0.9);
        --twikoo-body-text-color: rgba(255, 255, 255, 0.7);
    }
    .twikoo .el-input-group__prepend,
    .twikoo .tk-action-icon,
    .twikoo .tk-submit-action-icon,
    .twikoo .tk-time,
    .twikoo .tk-comments-no,
    .twikoo .tk-comments-count {
        color: var(--twikoo-body-text-color);
    }
    .twikoo .el-input__inner,
    .twikoo .el-textarea__inner,
    .twikoo .tk-preview-container,
    .twikoo .tk-content,
    .twikoo .tk-nick,
    .twikoo .tk-send {
        color: var(--twikoo-body-text-color-main);
    }
    .twikoo .el-button{
        color: var(--twikoo-body-text-color)!important;
    }
    .twikoo .el-input__count {
        color: var(--twikoo-body-text-color) !important;
    }
    .OwO .OwO-body {
        background-color: var(--body-background) !important;
        color: var(--body-text-color) !important;
    }
</style><script>
    twikoo.init({
        envId: 'https:\/\/twikoo.yixiao9206.cn',
        el: '#tcomment',lang: 'en',})
</script>

    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2023 - 
        
        2024 Copyright © 2023 huizhou92
    </section>
    
    <section class="powerby">
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        Theme <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.26.0">Stack</a></b> designed by <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a>
    </section>
    <script src="/js/adblock-detection.js" defer></script>
     
	
	<div class="busuanzi-footer">
	<span id="busuanzi_container_site_pv">
		Total site visits: <span id="busuanzi_value_site_pv"></span>
	</span>
	<span id="busuanzi_container_site_uv">
		Total Visitors: <span id="busuanzi_value_site_uv"></span>
	</span>
	</div></footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
