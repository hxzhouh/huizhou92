<!DOCTYPE html>
<html lang="en" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name="baidu-site-verification" content="codeva-3VTxLtnqFP" /><meta name='description' content="What&rsquo;s consistent hashing First, let me quote a definition from Wikipedia: In computer science, consistent hashing is a special kind of hashing technique such that when a hash table is resized, only 𝑛/𝑚 keys need to be remapped on average where 𝑛 is the number of keys and 𝑚 is the number of slots. In contrast, in most traditional hash tables, a change in the number of array slots causes nearly all keys to be remapped because the mapping between the keys and the slots is defined by a modular operation.">
<title>Distributed cornerstone algorithm: consistent hash</title>

<link rel='canonical' href='https://huizhou92.com/p/distributed-cornerstone-algorithm-consistent-hash/'>

<link rel="stylesheet" href="/scss/style.min.7a8650e463f7bf12cc86f69675ab60349b39aa794883f0c4ba0547d9e71cd5b5.css"><meta property='og:title' content="Distributed cornerstone algorithm: consistent hash">
<meta property='og:description' content="What&rsquo;s consistent hashing First, let me quote a definition from Wikipedia: In computer science, consistent hashing is a special kind of hashing technique such that when a hash table is resized, only 𝑛/𝑚 keys need to be remapped on average where 𝑛 is the number of keys and 𝑚 is the number of slots. In contrast, in most traditional hash tables, a change in the number of array slots causes nearly all keys to be remapped because the mapping between the keys and the slots is defined by a modular operation.">
<meta property='og:url' content='https://huizhou92.com/p/distributed-cornerstone-algorithm-consistent-hash/'>
<meta property='og:site_name' content='huizhou92&#39;s Blog'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='golang' /><meta property='article:tag' content='hash' /><meta property='article:published_time' content='2024-06-20T10:40:37&#43;08:00'/><meta property='article:modified_time' content='2024-06-20T10:40:36&#43;08:00'/><meta property='og:image' content='https://images.yixiao9206.cn/blog-images/2024/06/f3b53488c2407a75d85406be58526010.png' />
<meta name="twitter:site" content="@piaopiaopig">
    <meta name="twitter:creator" content="@piaopiaopig"><meta name="twitter:title" content="Distributed cornerstone algorithm: consistent hash">
<meta name="twitter:description" content="What&rsquo;s consistent hashing First, let me quote a definition from Wikipedia: In computer science, consistent hashing is a special kind of hashing technique such that when a hash table is resized, only 𝑛/𝑚 keys need to be remapped on average where 𝑛 is the number of keys and 𝑚 is the number of slots. In contrast, in most traditional hash tables, a change in the number of array slots causes nearly all keys to be remapped because the mapping between the keys and the slots is defined by a modular operation."><meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content='https://images.yixiao9206.cn/blog-images/2024/06/f3b53488c2407a75d85406be58526010.png' />
    <link rel="shortcut icon" href="/favicon.ico" />

  
    
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-JMPMQ2QREG"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-JMPMQ2QREG');
        }
      </script>
    
  

<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9000447749076746"
crossorigin="anonymous"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  <meta name="referrer" content="no-referrer-when-downgrade">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9000447749076746"
     crossorigin="anonymous"></script>

<script defer src="https://cloud.umami.is/script.js" data-website-id="e4ee8ffe-fb88-4635-9953-715598461baa"></script>
    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="Toggle Menu">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hu82a0a27be0be6253ef292d06d582a6ab_94926_300x0_resize_q75_box.jpeg" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">huizhou92&#39;s Blog</a></h1>
            <h2 class="site-description">Backend Engineer With A Focus On Golang, Cloud Computing, Data Storage And Efficiency Tools. Lifelong Learner.</h2>
        </div>
    </header><ol class="menu-social">
            
                <li>
                    <a 
                        href='https://github.com/hxzhouh'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://x.com/piaopiaopig'
                        target="_blank"
                        title="Twitter"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M22 4.01c-1 .49 -1.98 .689 -3 .99c-1.121 -1.265 -2.783 -1.335 -4.38 -.737s-2.643 2.06 -2.62 3.737v1c-3.245 .083 -6.135 -1.395 -8 -4c0 0 -4.182 7.433 4 11c-1.872 1.247 -3.739 2.088 -6 2c3.308 1.803 6.913 2.423 10.034 1.517c3.58 -1.04 6.522 -3.723 7.651 -7.742a13.84 13.84 0 0 0 .497 -3.753c-.002 -.249 1.51 -2.772 1.818 -4.013z" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>Home</span>
            </a>
        </li>
        
        
        <li >
            <a href='/about/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>About</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>Archives</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>Search</span>
            </a>
        </li>
        
        
        <li >
            <a href='/links/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>Links</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">
                    
                        <li id="i18n-switch">  
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M4 5h7" />
  <path d="M9 3v2c0 4.418 -2.239 8 -5 8" />
  <path d="M5 9c-.003 2.144 2.952 3.908 6.7 4" />
  <path d="M12 20l4 -9l4 9" />
  <path d="M19.1 18h-6.2" />
</svg>



                            <select name="language" title="language" onchange="window.location.href = this.selectedOptions[0].value">
                                
                                    <option value="https://huizhou92.com/" selected>English</option>
                                
                                    <option value="https://huizhou92.com/zh-cn/" >中文</option>
                                
                            </select>
                        </li>
                    
                

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>Dark Mode</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>


<ins class="adsbygoogle"
   style="display:block"
   data-ad-client="ca-pub-9000447749076746"
   data-ad-slot="5063552270"
   data-ad-format="auto"
   data-full-width-responsive="true"></ins>
<script>
   (adsbygoogle = window.adsbygoogle || []).push({});
</script>


    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">Table of contents</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li>
      <ol>
        <li><a href="#whats-consistent-hashing">What&rsquo;s consistent hashing</a></li>
        <li><a href="#principle-of-consistent-hashing-algorithm">Principle of Consistent Hashing Algorithm</a>
          <ol>
            <li><a href="#basic-consistent-hashing-algorithm">Basic Consistent Hashing Algorithm</a></li>
            <li><a href="#virtual-nodes">Virtual Nodes</a></li>
          </ol>
        </li>
      </ol>
    </li>
  </ol>
</nav>
        </div>
    </section>


<ins class="adsbygoogle"
   style="display:block"
   data-ad-client="ca-pub-9000447749076746"
   data-ad-slot="5063552270"
   data-ad-format="auto"
   data-full-width-responsive="true"></ins>
<script>
   (adsbygoogle = window.adsbygoogle || []).push({});
</script>
            
        
    </aside>


            <main class="main full-width">
    <article class="has-image main-article">
    <header class="article-header">
        <div class="article-image">
            <a href="/p/distributed-cornerstone-algorithm-consistent-hash/">
                
                    <img src="https://images.yixiao9206.cn/blog-images/2024/06/f3b53488c2407a75d85406be58526010.png" loading="lazy" alt="Featured image of post Distributed cornerstone algorithm: consistent hash" />
                
            </a>
        </div>
    

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/tech/" style="background-color: #2a9d8f; color: #ffff;">
                tech
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/distributed-cornerstone-algorithm-consistent-hash/">Distributed cornerstone algorithm: consistent hash</a>
        </h2>
    
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Jun 20, 2024</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    6 minute read
                </time>
            </div>
        
         
        <div class="article-analysic">&nbsp
    
            <?xml version="1.0" encoding="utf-8"?>

<!-- Uploaded to: SVG Repo, www.svgrepo.com, Generator: SVG Repo Mixer Tools -->
<svg fill="#000000" width="800px" height="800px" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
  
  <g id="read">
    <g>
      <path  d="M12,18.883a10.8,10.8,0,0,1-9.675-5.728,2.6,2.6,0,0,1,0-2.31A10.8,10.8,0,0,1,12,5.117a10.8,10.8,0,0,1,9.675,5.728h0a2.6,2.6,0,0,1,0,2.31A10.8,10.8,0,0,1,12,18.883ZM12,6.117a9.787,9.787,0,0,0-8.78,5.176,1.586,1.586,0,0,0,0,1.415A9.788,9.788,0,0,0,12,17.883a9.787,9.787,0,0,0,8.78-5.176,1.584,1.584,0,0,0,0-1.414h0A9.787,9.787,0,0,0,12,6.117Z"/>
      <path  d="M12,16.049A4.049,4.049,0,1,1,16.049,12,4.054,4.054,0,0,1,12,16.049Zm0-7.1A3.049,3.049,0,1,0,15.049,12,3.052,3.052,0,0,0,12,8.951Z"/>
      <circle  cx="12" cy="12" r="2.028"/>
    </g>
  </g>
</svg>
            <time class="article-words">
                <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv"></span> &nbspReads</span>
            </time>
        </div>
    </footer>
    

    
        <footer class="article-translations">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M4 5h7" />
  <path d="M9 3v2c0 4.418 -2.239 8 -5 8" />
  <path d="M5 9c-.003 2.144 2.952 3.908 6.7 4" />
  <path d="M12 20l4 -9l4 9" />
  <path d="M19.1 18h-6.2" />
</svg>



            <div>
                
                    <a href="https://huizhou92.com/zh-cn/p/%E5%88%86%E5%B8%83%E5%BC%8F%E5%9F%BA%E7%9F%B3%E7%AE%97%E6%B3%951-%E4%B8%80%E8%87%B4%E6%80%A7hash/" class="link">中文</a>
                
            </div>
        </footer>
    
</div>

</header>

    <section class="article-content">
    
    
    <h3 id="whats-consistent-hashing">What&rsquo;s consistent hashing
</h3><p>First, let me quote a definition from Wikipedia:</p>
<blockquote>
<p>In computer science, consistent hashing is a special kind of hashing technique such that when a hash table is resized, only <code>𝑛/𝑚</code> keys need to be remapped on average where 𝑛 is the number of keys and 𝑚 is the number of slots. In contrast, in most traditional hash tables, a change in the number of array slots causes nearly all keys to be remapped because the mapping between the keys and the slots is defined by a modular operation.</p>
<p>Consistent hashing evenly distributes cache keys across shards, even if some of the shards crash or become unavailable.</p>
</blockquote>
<p>In distributed systems, consistency hash is everywhere. CDN, KV, load balancing, and other places have their shadows. Consistency hash is one of the cornerstone algorithms of distributed systems. It has the following advantages.</p>
<ul>
<li><strong>Balanced load:</strong> Consistency hash algorithm can evenly distribute data on nodes.</li>
<li><strong>Scalability:</strong>  In the consistency hash algorithm, only part of the data needs to be re-mapped when the number of nodes increases or decreases. It is easier for the system to expand horizontally, and the number of nodes can be increased to meet greater load requirements;</li>
<li><strong>Reduce data migration:</strong> Compared with the traditional hash algorithm, the consistent hash algorithm has less data that needs to be re-mapped when nodes increase or decrease, which can greatly reduce the cost of data migration and reduce the instability and delay of the system;</li>
</ul>
<p>This article aims to learn the consistency hash algorithm and its simple implementation.</p>
<!-- more -->
<blockquote>
<p>This article is first published in the medium MPP plan. If you are a medium user, please follow me in <a class="link" href="https://medium.huizhou92.com/"  target="_blank" rel="noopener"
    >medium</a>. Thank you very much.</p>
</blockquote>
<h3 id="principle-of-consistent-hashing-algorithm">Principle of Consistent Hashing Algorithm
</h3><h4 id="basic-consistent-hashing-algorithm">Basic Consistent Hashing Algorithm
</h4><p>The most basic consistent hashing algorithm is to distribute nodes directly on a ring, thus dividing the value range. After the key goes through <code>hash(x)</code>, it falls into different value ranges and is processed by the corresponding node. The most common size of the value range space is: <code>2^32 - 1</code>. Nodes fall into this space to divide the value ranges belonging to different nodes. As shown in the figure.</p>
<p><img src="https://images.yixiao9206.cn/blog-images/2024/06/e1d987029e77819ff66e67a87b04fd97.png"
	
	
	
	loading="lazy"
	
		alt="figure1: simple consistent hash "
	
	
><br>
Node</p>
<p>The hash range stored by Node A is [0,2^12).</p>
<p>The hash range stored by Node B is [2^12,2^28).</p>
<p>The hash range stored by Node C is [2^28,0).</p>
<p>The basic consistent hashing algorithm mentioned above has obvious drawbacks:</p>
<ol>
<li>The random distribution of nodes makes it difficult to distribute the hash value domain evenly. As can be seen from above, the data stored by the three nodes is uneven.</li>
<li>After dynamically adding nodes, it is difficult to continue ensuring uniformity even if the original distribution was uniform.</li>
<li>One serious drawback caused by adding or removing nodes is:
<ol>
<li>When a node becomes abnormal, all its load will be transferred to an adjacent node.</li>
<li>When a new node joins, it can only share the load with one adjacent node.</li>
</ol>
</li>
</ol>
<h4 id="virtual-nodes">Virtual Nodes
</h4><p>Rob Pike said: &ldquo;In computer science, there are no problems that cannot be solved with another layer of indirection.&rdquo; Consistent hashing follows this principle as well.</p>
<p>If the three nodes are imbalanced, we can virtualize them into N virtual nodes: A[a1,a2&hellip;.a1024]. Then, we map them onto a hash ring in this way.<br>
<img src="https://images.yixiao9206.cn/blog-images/2024/06/b7f4809e8c3eab33d93cdb841f452508.png"
	
	
	
	loading="lazy"
	
		alt="Hash_ring with virtual node"
	
	
><br>
Each virtual node has a corresponding hash range. It is responsible for a segment of keys and then reads and writes data based on the virtual node&rsquo;s name to find the corresponding physical node.</p>
<p>The above three problems are perfectly solved with the introduction of virtual nodes.</p>
<ol>
<li>As long as we have enough virtual nodes, the data of each node can be balanced (⚠️: this comes at a cost in engineering).</li>
<li>If a node goes down, its data will be evenly distributed among all nodes in the cluster. Similarly, newly added nodes can also handle the load of all nodes.<br>
<img src="https://images.yixiao9206.cn/blog-images/2024/06/12ffda6dc50ce16f33c9fb48076af264.png"
	
	
	
	loading="lazy"
	
		alt="From three nodes to two nodes"
	
	
><br>
Go language implementation</li>
</ol>
<p><a class="link" href="https://github.com/hxzhouh/blog-example/tree/main/Distributed/consistent_hashing"  target="_blank" rel="noopener"
    >Complete code</a></p>
<p>First, define a hash_ring and use <code>crc32.ChecksumIEEE</code> as the default hash function.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">VirtualNode</span> <span class="kd">struct</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl">    <span class="nx">Hash</span> <span class="kt">uint32</span>  
</span></span><span class="line"><span class="cl">    <span class="nx">Node</span> <span class="o">*</span><span class="nx">Node</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">Node</span> <span class="kd">struct</span> <span class="p">{</span>   <span class="c1">// Physics Node
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">ID</span>   <span class="kt">string</span>  
</span></span><span class="line"><span class="cl">    <span class="nx">Addr</span> <span class="kt">string</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">HashRing</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Nodes</span>        <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="o">*</span><span class="nx">Node</span>
</span></span><span class="line"><span class="cl">	<span class="nx">VirtualNodes</span> <span class="p">[]</span><span class="nx">VirtualNode</span><span class="p">.</span> 
</span></span><span class="line"><span class="cl">	<span class="nx">mu</span>           <span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span>
</span></span><span class="line"><span class="cl">	<span class="nx">hash</span>         <span class="nx">HashFunc</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">NewHashRing</span><span class="p">(</span><span class="nx">hash</span> <span class="nx">HashFunc</span><span class="p">)</span> <span class="o">*</span><span class="nx">HashRing</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">hash</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">       <span class="nx">hash</span> <span class="p">=</span> <span class="nx">crc32</span><span class="p">.</span><span class="nx">ChecksumIEEE</span>  
</span></span><span class="line"><span class="cl">    <span class="p">}</span>  
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="o">&amp;</span><span class="nx">HashRing</span><span class="p">{</span>  
</span></span><span class="line"><span class="cl">       <span class="nx">Nodes</span><span class="p">:</span>        <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="o">*</span><span class="nx">Node</span><span class="p">),</span>  
</span></span><span class="line"><span class="cl">       <span class="nx">VirtualNodes</span><span class="p">:</span> <span class="nb">make</span><span class="p">([]</span><span class="nx">VirtualNode</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>  
</span></span><span class="line"><span class="cl">       <span class="nx">hash</span><span class="p">:</span>         <span class="nx">hash</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">    <span class="p">}</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Let&rsquo;s take a look at how to add a physics node:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">hr</span> <span class="o">*</span><span class="nx">HashRing</span><span class="p">)</span> <span class="nf">AddNode</span><span class="p">(</span><span class="nx">node</span> <span class="o">*</span><span class="nx">Node</span><span class="p">)</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">    <span class="nx">hr</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">    <span class="k">defer</span> <span class="nx">hr</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="nx">hr</span><span class="p">.</span><span class="nx">Nodes</span><span class="p">[</span><span class="nx">node</span><span class="p">.</span><span class="nx">ID</span><span class="p">]</span> <span class="p">=</span> <span class="nx">node</span>  
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">VirtualNodesPerNode</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">       <span class="nx">virtualNodeID</span> <span class="o">:=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;%s-%d&#34;</span><span class="p">,</span> <span class="nx">node</span><span class="p">.</span><span class="nx">ID</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">       <span class="nx">hash</span> <span class="o">:=</span> <span class="nx">hr</span><span class="p">.</span><span class="nf">hash</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">virtualNodeID</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl">       <span class="nx">hr</span><span class="p">.</span><span class="nx">VirtualNodes</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">hr</span><span class="p">.</span><span class="nx">VirtualNodes</span><span class="p">,</span> <span class="nx">VirtualNode</span><span class="p">{</span><span class="nx">Hash</span><span class="p">:</span> <span class="nx">hash</span><span class="p">,</span> <span class="nx">Node</span><span class="p">:</span> <span class="nx">node</span><span class="p">})</span>  
</span></span><span class="line"><span class="cl">    <span class="p">}</span>  
</span></span><span class="line"><span class="cl">    <span class="nx">sort</span><span class="p">.</span><span class="nf">Slice</span><span class="p">(</span><span class="nx">hr</span><span class="p">.</span><span class="nx">VirtualNodes</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">j</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">       <span class="k">return</span> <span class="nx">hr</span><span class="p">.</span><span class="nx">VirtualNodes</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">Hash</span> <span class="p">&lt;</span> <span class="nx">hr</span><span class="p">.</span><span class="nx">VirtualNodes</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">Hash</span>  
</span></span><span class="line"><span class="cl">    <span class="p">})</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>For each added node, the corresponding number of virtual nodes must be created, and it is necessary to ensure that the virtual nodes are ordered (so that they can be searched).</p>
<p>Similarly, when removing, virtual nodes also need to be deleted.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">hr</span> <span class="o">*</span><span class="nx">HashRing</span><span class="p">)</span> <span class="nf">RemoveNode</span><span class="p">(</span><span class="nx">nodeID</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">    <span class="nx">hr</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">    <span class="k">defer</span> <span class="nx">hr</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="nb">delete</span><span class="p">(</span><span class="nx">hr</span><span class="p">.</span><span class="nx">Nodes</span><span class="p">,</span> <span class="nx">nodeID</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="nx">virtualNodes</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="nx">VirtualNode</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">vn</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">hr</span><span class="p">.</span><span class="nx">VirtualNodes</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">       <span class="k">if</span> <span class="nx">vn</span><span class="p">.</span><span class="nx">Node</span><span class="p">.</span><span class="nx">ID</span> <span class="o">!=</span> <span class="nx">nodeID</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">          <span class="nx">virtualNodes</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">virtualNodes</span><span class="p">,</span> <span class="nx">vn</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">       <span class="p">}</span>  
</span></span><span class="line"><span class="cl">    <span class="p">}</span>  
</span></span><span class="line"><span class="cl">    <span class="nx">hr</span><span class="p">.</span><span class="nx">VirtualNodes</span> <span class="p">=</span> <span class="nx">virtualNodes</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>When querying, we first locate the corresponding virtual node, and then find the corresponding physical node based on the virtual node.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">hr</span> <span class="o">*</span><span class="nx">HashRing</span><span class="p">)</span> <span class="nf">GetNode</span><span class="p">(</span><span class="nx">key</span> <span class="kt">string</span><span class="p">)</span> <span class="o">*</span><span class="nx">Node</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">    <span class="nx">hr</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">    <span class="k">defer</span> <span class="nx">hr</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">hr</span><span class="p">.</span><span class="nx">VirtualNodes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">       <span class="k">return</span> <span class="kc">nil</span>  
</span></span><span class="line"><span class="cl">    <span class="p">}</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="nx">hash</span> <span class="o">:=</span> <span class="nx">hr</span><span class="p">.</span><span class="nf">hash</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">key</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl">    <span class="nx">idx</span> <span class="o">:=</span> <span class="nx">sort</span><span class="p">.</span><span class="nf">Search</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">hr</span><span class="p">.</span><span class="nx">VirtualNodes</span><span class="p">),</span> <span class="kd">func</span><span class="p">(</span><span class="nx">i</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">       <span class="k">return</span> <span class="nx">hr</span><span class="p">.</span><span class="nx">VirtualNodes</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">Hash</span> <span class="o">&gt;=</span> <span class="nx">hash</span>  
</span></span><span class="line"><span class="cl">    <span class="p">})</span>  
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">idx</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="nx">hr</span><span class="p">.</span><span class="nx">VirtualNodes</span><span class="p">)</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">       <span class="nx">idx</span> <span class="p">=</span> <span class="mi">0</span>  
</span></span><span class="line"><span class="cl">    <span class="p">}</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">hr</span><span class="p">.</span><span class="nx">VirtualNodes</span><span class="p">[</span><span class="nx">idx</span><span class="p">].</span><span class="nx">Node</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Finally, let&rsquo;s take a look at how the business uses this hash_ring</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">KVSystem</span> <span class="kd">struct</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">    <span class="nx">hashRing</span> <span class="o">*</span><span class="nx">HashRing</span>  
</span></span><span class="line"><span class="cl">    <span class="nx">kvStores</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="o">*</span><span class="nx">kvstorage</span><span class="p">.</span><span class="nx">KVStore</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">NewKVSystem</span><span class="p">(</span><span class="nx">nodes</span> <span class="kt">int</span><span class="p">)</span> <span class="o">*</span><span class="nx">KVSystem</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">    <span class="nx">hashRing</span> <span class="o">:=</span> <span class="nf">NewHashRing</span><span class="p">(</span><span class="nx">crc32</span><span class="p">.</span><span class="nx">ChecksumIEEE</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">nodes</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>  <span class="c1">// init node
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>       <span class="nx">node</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Node</span><span class="p">{</span>  
</span></span><span class="line"><span class="cl">          <span class="nx">ID</span><span class="p">:</span>   <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;Node%d&#34;</span><span class="p">,</span> <span class="nx">i</span><span class="p">),</span>  
</span></span><span class="line"><span class="cl">          <span class="nx">Addr</span><span class="p">:</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;192.168.1.%d&#34;</span><span class="p">,</span> <span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span>  
</span></span><span class="line"><span class="cl">       <span class="p">}</span>  
</span></span><span class="line"><span class="cl">       <span class="nx">hashRing</span><span class="p">.</span><span class="nf">AddNode</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="p">}</span>  
</span></span><span class="line"><span class="cl">    <span class="nx">kvStores</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="o">*</span><span class="nx">kvstorage</span><span class="p">.</span><span class="nx">KVStore</span><span class="p">)</span>   <span class="c1">//init storage
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="nx">id</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">hashRing</span><span class="p">.</span><span class="nx">Nodes</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">       <span class="nx">kvStores</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="p">=</span> <span class="nx">kvstorage</span><span class="p">.</span><span class="nf">NewKVStore</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">    <span class="p">}</span>  
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="o">&amp;</span><span class="nx">KVSystem</span><span class="p">{</span>  
</span></span><span class="line"><span class="cl">       <span class="nx">hashRing</span><span class="p">:</span> <span class="nx">hashRing</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">       <span class="nx">kvStores</span><span class="p">:</span> <span class="nx">kvStores</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">    <span class="p">}</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">kv</span> <span class="o">*</span><span class="nx">KVSystem</span><span class="p">)</span> <span class="nf">Get</span><span class="p">(</span><span class="nx">key</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>   <span class="c1">//get value
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">node</span> <span class="o">:=</span> <span class="nx">kv</span><span class="p">.</span><span class="nx">hashRing</span><span class="p">.</span><span class="nf">GetNode</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">kv</span><span class="p">.</span><span class="nx">kvStores</span><span class="p">[</span><span class="nx">node</span><span class="p">.</span><span class="nx">ID</span><span class="p">].</span><span class="nf">Get</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">kv</span> <span class="o">*</span><span class="nx">KVSystem</span><span class="p">)</span> <span class="nf">Set</span><span class="p">(</span><span class="nx">key</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">value</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>  <span class="c1">// set value 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">node</span> <span class="o">:=</span> <span class="nx">kv</span><span class="p">.</span><span class="nx">hashRing</span><span class="p">.</span><span class="nf">GetNode</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="nx">kv</span><span class="p">.</span><span class="nx">kvStores</span><span class="p">[</span><span class="nx">node</span><span class="p">.</span><span class="nx">ID</span><span class="p">].</span><span class="nf">Set</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">kv</span> <span class="o">*</span><span class="nx">KVSystem</span><span class="p">)</span> <span class="nf">Delete</span><span class="p">(</span><span class="nx">key</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">    <span class="nx">node</span> <span class="o">:=</span> <span class="nx">kv</span><span class="p">.</span><span class="nx">hashRing</span><span class="p">.</span><span class="nf">GetNode</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="nx">kv</span><span class="p">.</span><span class="nx">kvStores</span><span class="p">[</span><span class="nx">node</span><span class="p">.</span><span class="nx">ID</span><span class="p">].</span><span class="nf">Delete</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span>  
</span></span><span class="line"><span class="cl"><span class="c1">// DeleteNode requires reallocating the data stored on the node.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">kv</span> <span class="o">*</span><span class="nx">KVSystem</span><span class="p">)</span> <span class="nf">DeleteNode</span><span class="p">(</span><span class="nx">nodeID</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>   
</span></span><span class="line"><span class="cl">    <span class="nx">allData</span> <span class="o">:=</span> <span class="nx">kv</span><span class="p">.</span><span class="nx">kvStores</span><span class="p">[</span><span class="nx">nodeID</span><span class="p">].</span><span class="nf">GetAll</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">    <span class="nx">kv</span><span class="p">.</span><span class="nx">hashRing</span><span class="p">.</span><span class="nf">RemoveNode</span><span class="p">(</span><span class="nx">nodeID</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="nb">delete</span><span class="p">(</span><span class="nx">kv</span><span class="p">.</span><span class="nx">kvStores</span><span class="p">,</span> <span class="nx">nodeID</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">allData</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">       <span class="nx">kv</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="p">}</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span>  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">kv</span> <span class="o">*</span><span class="nx">KVSystem</span><span class="p">)</span> <span class="nf">AddNode</span><span class="p">()</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">    <span class="nx">node</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Node</span><span class="p">{</span>  
</span></span><span class="line"><span class="cl">       <span class="nx">ID</span><span class="p">:</span>   <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;Node%d&#34;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">kv</span><span class="p">.</span><span class="nx">hashRing</span><span class="p">.</span><span class="nx">Nodes</span><span class="p">)),</span>  
</span></span><span class="line"><span class="cl">       <span class="nx">Addr</span><span class="p">:</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;192.168.1.%d&#34;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">kv</span><span class="p">.</span><span class="nx">hashRing</span><span class="p">.</span><span class="nx">Nodes</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span>  
</span></span><span class="line"><span class="cl">    <span class="p">}</span>  
</span></span><span class="line"><span class="cl">    <span class="nx">kv</span><span class="p">.</span><span class="nx">hashRing</span><span class="p">.</span><span class="nf">AddNode</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="nx">kv</span><span class="p">.</span><span class="nx">kvStores</span><span class="p">[</span><span class="nx">node</span><span class="p">.</span><span class="nx">ID</span><span class="p">]</span> <span class="p">=</span> <span class="nx">kvstorage</span><span class="p">.</span><span class="nf">NewKVStore</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>In this way, we have achieved the simplest key-value storage based on consistent hashing. Isn&rsquo;t it very simple? But it supports the operation of our entire network world.</p>

</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/golang/">Golang</a>
        
            <a href="/tags/hash/">Hash</a>
        
    </section>


    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    <section class="article-lastmod">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



        <span>
            Last updated on Jun 20, 2024 10:40 CST
        </span>
    </section></footer>


    
</article>

    

    

<ins class="adsbygoogle"
   style="display:block"
   data-ad-client="ca-pub-9000447749076746"
   data-ad-slot="5063552270"
   data-ad-format="auto"
   data-full-width-responsive="true"></ins>
<script>
   (adsbygoogle = window.adsbygoogle || []).push({});
</script>
<aside class="related-content--wrapper">
    <h2 class="section-title">Related content</h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="has-image">
    <a href="/p/go-1.24-new-std-lib-synctest/">
        
        
            <div class="article-image">
                
                    <img src="https://images.hxzhouh.com/blog-images/2024/12/260aeb6207be4b765d34328515c144dc.png" loading="lazy" data-key="" data-hash="https://images.hxzhouh.com/blog-images/2024/12/260aeb6207be4b765d34328515c144dc.png"/>
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">Go 1.24: New STD-lib synctest</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/go1.24-new-std-lib-os.root/">
        
        

        <div class="article-details">
            <h2 class="article-title">GO1.24: New Std-Lib os.Root</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/bigcache-high-performance-memory-caching-in-go/">
        
        
            <div class="article-image">
                
                    <img src="https://images.hxzhouh.com/blog-images/2024/12/d1288ea91074f2a22a8ac4fec04d8b90.png" loading="lazy" data-key="" data-hash="https://images.hxzhouh.com/blog-images/2024/12/d1288ea91074f2a22a8ac4fec04d8b90.png"/>
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">BigCache: High-Performance Memory Caching in Go</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/go-high-performance-programming-ep10-two-useful-golang-lock-free-programming-tips/">
        
        

        <div class="article-details">
            <h2 class="article-title">Go High-Performance Programming EP10: Two Useful Golang Lock-Free Programming Tips</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/swisstable-a-high-performance-hash-table-implementation/">
        
        
            <div class="article-image">
                
                    <img src="https://images.hxzhouh.com/blog-images/2024/09/f08c74aea8485d51d461d18494df416e.png" loading="lazy" data-key="" data-hash="https://images.hxzhouh.com/blog-images/2024/09/f08c74aea8485d51d461d18494df416e.png"/>
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">SwissTable: A High-Performance Hash Table Implementation</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>


    
        
    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2023 - 
        
        2025 Copyright © 2023 huizhou92
    </section>
    
    <section class="powerby">
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        Theme <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.26.0">Stack</a></b> designed by <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a>
    </section>
    <script src="/js/adblock-detection.js" defer></script>
     
	
	<div class="busuanzi-footer">
	<span id="busuanzi_container_site_pv">
		Total site visits: <span id="busuanzi_value_site_pv"></span>
	</span>
	<span id="busuanzi_container_site_uv">
		Total Visitors: <span id="busuanzi_value_site_uv"></span>
	</span>
	</div></footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
