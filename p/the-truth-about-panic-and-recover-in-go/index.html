<!DOCTYPE html>
<html lang="en" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name="baidu-site-verification" content="codeva-3VTxLtnqFP" /><meta name='description' content="Background In the previous article, we learned that panic can occur in three ways: Initiated by developers: by calling the panic() function. Generated by the compiler: for example, in the case of division by zero. Sent to the process by the kernel: for example, in the case of an illegal memory access. This article is first published in the medium MPP plan. If you are a medium user, please follow me in medium.">
<title>The Truth About Panic And Recover In Go</title>

<link rel='canonical' href='https://huizhou92.com/p/the-truth-about-panic-and-recover-in-go/'>

<link rel="stylesheet" href="/scss/style.min.0304c6baf04e01a8fe70693791cb744d56a3578a3120a8796cefc66825aa39c7.css"><meta property='og:title' content="The Truth About Panic And Recover In Go">
<meta property='og:description' content="Background In the previous article, we learned that panic can occur in three ways: Initiated by developers: by calling the panic() function. Generated by the compiler: for example, in the case of division by zero. Sent to the process by the kernel: for example, in the case of an illegal memory access. This article is first published in the medium MPP plan. If you are a medium user, please follow me in medium.">
<meta property='og:url' content='https://huizhou92.com/p/the-truth-about-panic-and-recover-in-go/'>
<meta property='og:site_name' content='huizhou92&#39;s Blog'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='golang' /><meta property='article:published_time' content='2024-05-26T09:17:40&#43;08:00'/><meta property='article:modified_time' content='2024-05-26T09:17:38&#43;08:00'/>
<meta name="twitter:site" content="@https://x.com/piaopiaopig">
    <meta name="twitter:creator" content="@https://x.com/piaopiaopig"><meta name="twitter:title" content="The Truth About Panic And Recover In Go">
<meta name="twitter:description" content="Background In the previous article, we learned that panic can occur in three ways: Initiated by developers: by calling the panic() function. Generated by the compiler: for example, in the case of division by zero. Sent to the process by the kernel: for example, in the case of an illegal memory access. This article is first published in the medium MPP plan. If you are a medium user, please follow me in medium.">
    <link rel="shortcut icon" href="/favicon.ico" />

  
    
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-JMPMQ2QREG"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-JMPMQ2QREG');
        }
      </script>
    
  

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  <meta name="referrer" content="no-referrer-when-downgrade">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9000447749076746"
     crossorigin="anonymous"></script>
    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="Toggle Menu">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hu82a0a27be0be6253ef292d06d582a6ab_94926_300x0_resize_q75_box.jpeg" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">ðŸ˜„</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">huizhou92&#39;s Blog</a></h1>
            <h2 class="site-description">Backend Engineer With A Focus On Golang, Cloud Computing, Data Storage And Efficiency Tools. Lifelong Learner.</h2>
        </div>
    </header><ol class="menu-social">
            
                <li>
                    <a 
                        href='https://github.com/hxzhouh'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://x.com/piaopiaopig'
                        target="_blank"
                        title="Twitter"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M22 4.01c-1 .49 -1.98 .689 -3 .99c-1.121 -1.265 -2.783 -1.335 -4.38 -.737s-2.643 2.06 -2.62 3.737v1c-3.245 .083 -6.135 -1.395 -8 -4c0 0 -4.182 7.433 4 11c-1.872 1.247 -3.739 2.088 -6 2c3.308 1.803 6.913 2.423 10.034 1.517c3.58 -1.04 6.522 -3.723 7.651 -7.742a13.84 13.84 0 0 0 .497 -3.753c-.002 -.249 1.51 -2.772 1.818 -4.013z" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>Home</span>
            </a>
        </li>
        
        
        <li >
            <a href='/about/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>About</span>
            </a>
        </li>
        
        
        <li >
            <a href='/categories/newsletter/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>NewsLetter</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>Archives</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>Search</span>
            </a>
        </li>
        
        
        <li >
            <a href='/links/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>Links</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">
                    
                        <li id="i18n-switch">  
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M4 5h7" />
  <path d="M9 3v2c0 4.418 -2.239 8 -5 8" />
  <path d="M5 9c-.003 2.144 2.952 3.908 6.7 4" />
  <path d="M12 20l4 -9l4 9" />
  <path d="M19.1 18h-6.2" />
</svg>



                            <select name="language" title="language" onchange="window.location.href = this.selectedOptions[0].value">
                                
                                    <option value="https://huizhou92.com/" selected>English</option>
                                
                                    <option value="https://huizhou92.com/zh-cn/" >ä¸­æ–‡</option>
                                
                            </select>
                        </li>
                    
                

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>Dark Mode</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">Table of contents</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#background">Background</a></li>
    <li><a href="#the-_panic-data-structure">The <code>_panic</code> Data Structure</a></li>
    <li><a href="#the-recover-function">The <code>recover()</code> Function</a>
      <ol>
        <li><a href="#the-gorecover-function">The <code>gorecover</code> Function</a></li>
      </ol>
    </li>
    <li><a href="#the-panic-function">The <code>panic()</code> Function</a>
      <ol>
        <li><a href="#the-gopanic-function">The <code>gopanic</code> Function</a>
          <ol>
            <li><a href="#inside-the-loop">Inside the Loop</a></li>
            <li><a href="#questions-to-consider">Questions to Consider</a></li>
          </ol>
        </li>
        <li><a href="#the-recovery-function">The <code>recovery</code> Function</a></li>
      </ol>
    </li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/go/" style="background-color: #2a9d8f; color: #ffff;">
                go
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/the-truth-about-panic-and-recover-in-go/">The Truth About Panic And Recover In Go</a>
        </h2>
    
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">May 26, 2024</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    11 minute read
                </time>
            </div>
        
         
        <div class="article-analysic">&nbsp
    
            <?xml version="1.0" encoding="utf-8"?>

<!-- Uploaded to: SVG Repo, www.svgrepo.com, Generator: SVG Repo Mixer Tools -->
<svg fill="#000000" width="800px" height="800px" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
  
  <g id="read">
    <g>
      <path  d="M12,18.883a10.8,10.8,0,0,1-9.675-5.728,2.6,2.6,0,0,1,0-2.31A10.8,10.8,0,0,1,12,5.117a10.8,10.8,0,0,1,9.675,5.728h0a2.6,2.6,0,0,1,0,2.31A10.8,10.8,0,0,1,12,18.883ZM12,6.117a9.787,9.787,0,0,0-8.78,5.176,1.586,1.586,0,0,0,0,1.415A9.788,9.788,0,0,0,12,17.883a9.787,9.787,0,0,0,8.78-5.176,1.584,1.584,0,0,0,0-1.414h0A9.787,9.787,0,0,0,12,6.117Z"/>
      <path  d="M12,16.049A4.049,4.049,0,1,1,16.049,12,4.054,4.054,0,0,1,12,16.049Zm0-7.1A3.049,3.049,0,1,0,15.049,12,3.052,3.052,0,0,0,12,8.951Z"/>
      <circle  cx="12" cy="12" r="2.028"/>
    </g>
  </g>
</svg>
            <time class="article-words">
                <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv"></span> &nbspReads</span>
            </time>
        </div>
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <h2 id="background">Background
</h2><p>In the previous article, we learned that panic can occur in three ways:</p>
<ul>
<li>Initiated by developers: by calling the <code>panic()</code> function.</li>
<li>Generated by the compiler: for example, in the case of division by zero.</li>
<li>Sent to the process by the kernel: for example, in the case of an illegal memory access.</li>
</ul>
<!-- more-->
<blockquote>
<p>This article is first published in the medium MPP plan. If you are a medium user, please follow me in <a class="link" href="https://medium.hxzhouh.com/"  target="_blank" rel="noopener"
    >medium</a>. Thank you very much.</p>
</blockquote>
<p>All three cases can be categorized as calls to the <code>panic()</code> function, indicating that panic in Go is just a special function call and is handled at the language level. Now that we know how panic is triggered, the next step is to understand how panic is handled. When I first started learning Go, I often had some questions in my mind:</p>
<ul>
<li>What exactly is panic? Is it a struct or a function?</li>
<li>Why does panic cause the Go process to exit?</li>
<li>Why does recover need to be placed inside a defer statement to take effect?</li>
<li>Even if recover is placed inside a defer statement, why doesn&rsquo;t the process recover?</li>
<li>Why is it possible to panic again after a panic? What are the implications?</li>
</ul>
<p>Today, we will delve into the code to clarify these questions.</p>
<blockquote>
<p>Based on Go 1.21.4</p>
</blockquote>
<h2 id="the-_panic-data-structure">The <code>_panic</code> Data Structure
</h2><p>Let&rsquo;s start by looking at an example of an actively triggered panic. Through the assembly code, we can see that the panic call is made to the <a class="link" href="https://github.com/golang/go/blob/ed817f1c4055a559a94afffecbb91c78e4f39942/src/runtime/panic.go#L826"  target="_blank" rel="noopener"
    ><code>runtime.gopanic</code></a> function, which contains a crucial data structure called <a class="link" href="https://github.com/golang/go/blob/ed817f1c4055a559a94afffecbb91c78e4f39942/src/runtime/runtime2.go#L1035"  target="_blank" rel="noopener"
    ><code>_panic</code></a>.</p>
<p>Let&rsquo;s take a look at the <code>_panic</code> data structure:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">_panic</span> <span class="kd">struct</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">    <span class="nx">argp</span>      <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span> <span class="c1">// pointer to arguments of deferred call run during panic; cannot move - known to liblink  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">arg</span>       <span class="nx">any</span>            <span class="c1">// argument to panic  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">link</span>      <span class="o">*</span><span class="nx">_panic</span>        <span class="c1">// link to earlier panic    pc        uintptr        // where to return to in runtime if this panic is bypassed  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">sp</span>        <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span> <span class="c1">// where to return to in runtime if this panic is bypassed  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">recovered</span> <span class="kt">bool</span>           <span class="c1">// whether this panic is over  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">aborted</span>   <span class="kt">bool</span>           <span class="c1">// the panic was aborted  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">goexit</span>    <span class="kt">bool</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Key Fields to Focus On</strong>:</p>
<ul>
<li><code>link</code>: A pointer to the <code>_panic</code> structure, indicating that <code>_panic</code> can form a unidirectional linked list, similar to the <code>_defer</code> list.</li>
<li><code>recovered</code> field: The recovery of the so-called <code>_panic</code> depends on whether this field is set to true. <code>recover()</code> actually modifies this field.</li>
</ul>
<p><img src="https://images.hxzhouh.com/blog-images/2024/02/9d5208d45a60e46284b441a06e10a633.png"
	
	
	
	loading="lazy"
	
		alt="9d5208d45a60e46284b441a06e10a633.png"
	
	
></p>
<p>Now let&rsquo;s take a look at two important fields in the <a class="link" href="https://github.com/golang/go/blob/ed817f1c4055a559a94afffecbb91c78e4f39942/src/runtime/runtime2.go#L414"  target="_blank" rel="noopener"
    ><code>g</code></a> structure:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">g</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">_panic</span> <span class="o">*</span><span class="nx">_panic</span> <span class="c1">// panic linked list, the innermost one
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">_defer</span> <span class="o">*</span><span class="nx">_defer</span> <span class="c1">// defer linked list, the innermost one
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>From here, we can see that both the <code>_defer</code> and <code>_panic</code> linked lists are attached to the goroutine. When can there be multiple elements on the <code>_panic</code> linked list? The answer is when a <code>panic()</code> call is made within a defer function. Only in a defer function can an <code>_panic</code> linked list be formed because the <code>panic()</code> function only executes <code>_defer</code> functions!</p>
<h2 id="the-recover-function">The <code>recover()</code> Function
</h2><p>For the sake of explanation, let&rsquo;s start with a simple analysis of what the <code>recover()</code> function does:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nb">recover</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The <code>recover()</code> function corresponds to the <a class="link" href="https://github.com/golang/go/blob/ed817f1c4055a559a94afffecbb91c78e4f39942/src/runtime/panic.go#L1038"  target="_blank" rel="noopener"
    ><code>gorecover</code></a> function implementation in the <code>runtime/panic.go</code> file.</p>
<h3 id="the-gorecover-function">The <code>gorecover</code> Function
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">gorecover</span><span class="p">(</span><span class="nx">argp</span> <span class="kt">uintptr</span><span class="p">)</span> <span class="nx">any</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Must be in a function running as part of a deferred call during the panic.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Must be called from the topmost function of the call
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// (the function used in the defer statement).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// p.argp is the argument pointer of that topmost deferred function call.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Compare against argp reported by caller.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// If they match, the caller is the one who can recover.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">gp</span> <span class="o">:=</span> <span class="nf">getg</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">p</span> <span class="o">:=</span> <span class="nx">gp</span><span class="p">.</span><span class="nx">_panic</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">p</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">p</span><span class="p">.</span><span class="nx">goexit</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">p</span><span class="p">.</span><span class="nx">recovered</span> <span class="o">&amp;&amp;</span> <span class="nx">argp</span> <span class="o">==</span> <span class="nb">uintptr</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">argp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">p</span><span class="p">.</span><span class="nx">recovered</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">p</span><span class="p">.</span><span class="nx">arg</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>This function is quite simple:</p>
<ol>
<li>Retrieve the current goroutine structure.</li>
<li>Get the latest <code>_panic</code> from the <code>_panic</code> linked list of the current goroutine. If it is not <code>nil</code>, proceed with the processing.</li>
<li>Set the <code>recovered</code> field of the <code>_panic</code> structure to true and return the <code>arg</code> field.</li>
</ol>
<p>That&rsquo;s all there is to the <code>recover()</code> function. It simply sets the value of the <code>recovered</code> field in the <code>_panic</code> structure and does not involve any magical code jumps. The assignment of <code>recovered</code> is effective within the logic of the <code>panic()</code> function.</p>
<h2 id="the-panic-function">The <code>panic()</code> Function
</h2><p>Based on the previous assembly code, we know that the panic call is made to the <a class="link" href="https://github.com/golang/go/blob/ed817f1c4055a559a94afffecbb91c78e4f39942/src/runtime/panic.go#L826"  target="_blank" rel="noopener"
    ><code>runtime.gopanic</code></a> function.</p>
<h3 id="the-gopanic-function">The <code>gopanic</code> Function
</h3><p>The most important part of the panic mechanism is the <code>gopanic</code> function. All the details about panic are in this function. The complexity of understanding panic lies in two points:</p>
<ol>
<li>Recursive execution of <code>gopanic</code> when panic is nested.</li>
<li>The program counter (pc) and stack pointer (sp) are not manipulated in the usual way of function call and return. During recovery, the instruction registers are modified directly, bypassing the remaining logic of <code>gopanic</code> and even the recursive logic of multiple <code>gopanic</code> calls.</li>
</ol>
<p>We can understand the logic of <code>gopanic</code> by dividing it into two parts: inside the loop and outside the loop.</p>
<h4 id="inside-the-loop">Inside the Loop
</h4><p>The actions inside the loop can be divided into the following steps:</p>
<ol>
<li>Iterate through the defer linked list of the goroutine and retrieve a <code>_defer</code> deferred function.</li>
<li>Set the <code>d.started</code> flag and bind the current <code>d._panic</code> (used for recursive detection).</li>
<li>Execute the <code>_defer</code> deferred function.</li>
<li>Remove the executed <code>_defer</code> function from the linked list.</li>
<li>Check if the <code>recovered</code> field of the <code>_panic</code> structure is set to true and take appropriate action.
<ul>
<li>If it is true, reset the pc and sp registers (usually starting from the deferreturn instruction) and enqueue the goroutine in the scheduler for execution.</li>
</ul>
</li>
<li>Repeat the above steps.</li>
</ol>
<h4 id="questions-to-consider">Questions to Consider
</h4><p>You may notice that the <code>recovered</code> field is only modified during the third step. It cannot be modified anywhere else.<br>
<strong>Question 1: Why does recover need to be placed inside a defer statement to take effect?</strong><br>
Because that&rsquo;s the only opportunity!</p>
<p>Let&rsquo;s consider a few straightforward examples:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nb">panic</span><span class="p">(</span><span class="s">&#34;test&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nb">recover</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>In the above example, <code>recover()</code> is called after <code>panic()</code>. Why does it still panic? Because the <code>recover()</code> function is never executed. The execution order is as follows:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">panic
</span></span><span class="line"><span class="cl">  -&gt; gopanic
</span></span><span class="line"><span class="cl">     -&gt; Execute the defer linked list
</span></span><span class="line"><span class="cl">        -&gt; <span class="nb">exit</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Someone might argue, &ldquo;What if I put <code>recover()</code> before <code>panic('test')</code>?&rdquo;</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nb">recover</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nb">panic</span><span class="p">(</span><span class="s">&#34;test&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>No, it won&rsquo;t work because when <code>recover()</code> is executed, the <code>_panic</code> is not attached to the goroutine yet. So <code>recover()</code> is useless in this case.</p>
<p><strong>Question 2: Even if recover is placed inside a defer statement, why doesn&rsquo;t the process recover?</strong><br>
Let&rsquo;s recall the operations in the for loop:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Step: Iterate through the _defer linked list
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">d</span> <span class="o">:=</span> <span class="nx">gp</span><span class="p">.</span><span class="nx">_defer</span>
</span></span><span class="line"><span class="cl"><span class="c1">// Step: Execute the defer function
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">reflectcall</span><span class="p">(</span><span class="kc">nil</span><span class="p">,</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">fn</span><span class="p">),</span> <span class="nf">deferArgs</span><span class="p">(</span><span class="nx">d</span><span class="p">),</span> <span class="nb">uint32</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">siz</span><span class="p">),</span> <span class="nb">uint32</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">siz</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="c1">// Step: Remove the executed defer function
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">gp</span><span class="p">.</span><span class="nx">_defer</span> <span class="p">=</span> <span class="nx">d</span><span class="p">.</span><span class="nx">link</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Key Point: In the <code>gopanic</code> function, only the <code>_defer</code> functions of the current goroutine are executed. Therefore, if a <code>recover()</code> is performed in a defer function attached to another goroutine, it will have no effect.</strong></p>
<p>Let&rsquo;s consider an example:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span> <span class="c1">// g1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span> <span class="c1">// g2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nb">recover</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="p">}()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}()</span>
</span></span><span class="line"><span class="cl">    <span class="nb">panic</span><span class="p">(</span><span class="s">&#34;test&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Since the <code>panic</code> and <code>recover</code> are in two different goroutines, the <code>_panic</code> is attached to g1, and the <code>recover</code> in g2&rsquo;s <code>_defer</code> chain cannot access the <code>_panic</code> structure of g1. Therefore, it cannot set the <code>recovered</code> field to true, and the program still crashes.</p>
<p><strong>Question 3: Why is it possible to panic again after a panic? What are the implications?</strong><br>
This is actually quite easy to understand. Some people might overthink it. Can we call <code>panic()</code> recursively? Yes, we can.<br>
The scenario is usually as follows:</p>
<ul>
<li>The <code>gopanic</code> function calls a <code>_defer</code> function.</li>
<li>The <code>_defer</code> function calls <code>panic()</code> or <code>gopanic()</code>.</li>
</ul>
<p>This is just a simple function recursion, and there&rsquo;s nothing special about it. In this scenario, an <code>_panic</code> linked list will be formed starting from <code>gp._panic</code>. The instructions executed by <code>gopanic</code> are special in two ways:</p>
<ol>
<li>If the <code>_panic</code> structure is set to recovered, the pc and sp registers are reset, bypassing <code>gopanic</code> (including nested function stacks), and jumping directly to the instruction to be executed after the defer function (deferreturn).</li>
<li>If there is no handler for the <code>_panic</code> data, exit the process and terminate the execution of subsequent instructions.</li>
</ol>
<p>Let&rsquo;s look at an example of nested panic:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span> <span class="c1">// defer_0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nb">panic</span><span class="p">(</span><span class="s">&#34;panic again&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}()</span>
</span></span><span class="line"><span class="cl">    <span class="nb">panic</span><span class="p">(</span><span class="s">&#34;first&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The function execution is as follows:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl">    <span class="nx">gopanic</span> <span class="c1">// First panic
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">defer_0</span> <span class="nx">is</span> <span class="nx">executed</span>
</span></span><span class="line"><span class="cl">            <span class="nx">gopanic</span> <span class="c1">// Second panic
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nx">defer_0</span> <span class="nx">is</span> <span class="nx">removed</span> <span class="nx">from</span> <span class="nx">the</span> <span class="nx">linked</span> <span class="nf">list</span> <span class="p">(</span><span class="nx">recursive</span> <span class="nx">call</span><span class="p">),</span> <span class="nx">termination</span> <span class="nx">condition</span> <span class="nx">is</span> <span class="nx">met</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">    <span class="c1">// Print stack trace and exit the program
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">fatalpanic</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Here&rsquo;s another example for comparison:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">println</span><span class="p">(</span><span class="s">&#34;=== begin ===&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span> <span class="c1">// defer_0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nb">println</span><span class="p">(</span><span class="s">&#34;=== come in defer_0 ===&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}()</span>
</span></span><span class="line"><span class="cl">    <span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span> <span class="c1">// defer_1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nb">recover</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}()</span>
</span></span><span class="line"><span class="cl">    <span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span> <span class="c1">// defer_2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nb">panic</span><span class="p">(</span><span class="s">&#34;panic 2&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}()</span>
</span></span><span class="line"><span class="cl">    <span class="nb">panic</span><span class="p">(</span><span class="s">&#34;panic 1&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">println</span><span class="p">(</span><span class="s">&#34;=== end ===&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Will this function print the stack trace and exit?<br>
<strong>The answer is no.</strong> The output will be:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">âžœ panic ./test_panic <span class="o">===</span> <span class="nv">begin</span> <span class="o">===</span> <span class="o">===</span> come in <span class="nv">defer_0</span> <span class="o">===</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Did you guess it correctly? Let me explain the complete route:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">main</span>
</span></span><span class="line"><span class="cl">    <span class="nx">gopanic</span> <span class="c1">// First panic
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="mf">1.</span> <span class="nx">Retrieve</span> <span class="nx">defer_2</span><span class="p">,</span> <span class="nx">set</span> <span class="nx">started</span>
</span></span><span class="line"><span class="cl">        <span class="mf">2.</span> <span class="nx">Execute</span> <span class="nx">defer_2</span>
</span></span><span class="line"><span class="cl">            <span class="nx">gopanic</span> <span class="c1">// Second panic
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="mf">1.</span> <span class="nx">Retrieve</span> <span class="nx">defer_2</span><span class="p">,</span> <span class="nx">set</span> <span class="nx">panic</span> <span class="nx">as</span> <span class="nx">aborted</span>
</span></span><span class="line"><span class="cl">                <span class="mf">2.</span> <span class="nx">Remove</span> <span class="nx">defer_2</span> <span class="nx">from</span> <span class="nx">the</span> <span class="nx">linked</span> <span class="nx">list</span>
</span></span><span class="line"><span class="cl">                <span class="mf">3.</span> <span class="nx">Execute</span> <span class="nx">defer_1</span>
</span></span><span class="line"><span class="cl">                    <span class="o">-</span> <span class="nx">Execute</span> <span class="nx">recover</span>
</span></span><span class="line"><span class="cl">                <span class="mf">4.</span> <span class="nx">Remove</span> <span class="nx">defer_1</span>
</span></span><span class="line"><span class="cl">                <span class="mf">5.</span> <span class="nx">Execute</span> <span class="nx">recovery</span><span class="p">,</span> <span class="nx">reset</span> <span class="nx">pc</span> <span class="nx">register</span><span class="p">,</span> <span class="nx">jump</span> <span class="nx">to</span> <span class="nx">the</span> <span class="nx">instruction</span> <span class="nx">registered</span> <span class="nx">in</span> <span class="nf">defer_1</span> <span class="p">(</span><span class="nx">usually</span> <span class="nx">deferreturn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Jump out of the recursive call of gopanic, directly to the execution of deferreturn;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">defereturn</span>
</span></span><span class="line"><span class="cl">        <span class="mf">1.</span> <span class="nx">Iterate</span> <span class="nx">through</span> <span class="nx">the</span> <span class="k">defer</span> <span class="nx">function</span> <span class="nx">chain</span><span class="p">,</span> <span class="nx">there</span> <span class="nx">is</span> <span class="nx">still</span> <span class="nx">defer_0</span> <span class="nx">left</span><span class="p">,</span> <span class="nx">retrieve</span> <span class="nx">defer_0</span>
</span></span><span class="line"><span class="cl">        <span class="mf">2.</span> <span class="nx">Execute</span> <span class="nx">defer_0</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// End of the main function
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Here&rsquo;s another example:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">println</span><span class="p">(</span><span class="s">&#34;=== begin ===&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span> <span class="c1">// defer_0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nb">println</span><span class="p">(</span><span class="s">&#34;=== come in defer_0 ===&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}()</span>
</span></span><span class="line"><span class="cl">    <span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span> <span class="c1">// defer_1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nb">panic</span><span class="p">(</span><span class="s">&#34;panic 2&#34;</span><span class="p">)</span>    
</span></span><span class="line"><span class="cl">    <span class="p">}()</span>
</span></span><span class="line"><span class="cl">    <span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span> <span class="c1">// defer_2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nb">recover</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}()</span>
</span></span><span class="line"><span class="cl">    <span class="nb">panic</span><span class="p">(</span><span class="s">&#34;panic 1&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">println</span><span class="p">(</span><span class="s">&#34;=== end ===&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Will this function print the stack trace and exit?<br>
<strong>The answer is yes.</strong><br>
The output will be:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">âžœ panic ./test_panic <span class="o">===</span> <span class="nv">begin</span> <span class="o">===</span> <span class="o">===</span> come in <span class="nv">defer_0</span> <span class="o">===</span> panic: panic <span class="m">2</span> goroutine <span class="m">1</span> <span class="o">[</span>running<span class="o">]</span>: main.main.func2<span class="o">()</span> /Users/code/gopher/src/panic/test_panic.go:9 +0x39 main.main<span class="o">()</span> /Users/code/gopher/src/panic/test_panic.go:11 +0xf7
</span></span></code></pre></td></tr></table>
</div>
</div><p>The execution path is as follows:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">main</span>
</span></span><span class="line"><span class="cl">    <span class="nx">gopanic</span> <span class="c1">// First panic
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="mf">1.</span> <span class="nx">Retrieve</span> <span class="nx">defer_2</span><span class="p">,</span> <span class="nx">set</span> <span class="nx">started</span>
</span></span><span class="line"><span class="cl">        <span class="mf">2.</span> <span class="nx">Execute</span> <span class="nx">defer_2</span> 
</span></span><span class="line"><span class="cl">            <span class="o">-</span> <span class="nx">Execute</span> <span class="nx">recover</span><span class="p">,</span> <span class="nx">set</span> <span class="nx">panic_1</span> <span class="nx">as</span> <span class="nx">recovered</span>
</span></span><span class="line"><span class="cl">        <span class="mf">3.</span> <span class="nx">Remove</span> <span class="nx">defer_2</span> <span class="nx">from</span> <span class="nx">the</span> <span class="nx">linked</span> <span class="nx">list</span>
</span></span><span class="line"><span class="cl">        <span class="mf">4.</span> <span class="nx">Execute</span> <span class="nx">recovery</span><span class="p">,</span> <span class="nx">reset</span> <span class="nx">pc</span> <span class="nx">register</span><span class="p">,</span> <span class="nx">jump</span> <span class="nx">to</span> <span class="nx">the</span> <span class="nx">instruction</span> <span class="nx">registered</span> <span class="nx">in</span> <span class="nf">defer_1</span> <span class="p">(</span><span class="nx">usually</span> <span class="nx">deferreturn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Jump out of the recursive call of gopanic, execute deferreturn;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">defereturn</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="mf">1.</span> <span class="nx">Iterate</span> <span class="nx">through</span> <span class="nx">the</span> <span class="k">defer</span> <span class="nx">function</span> <span class="nx">chain</span><span class="p">,</span> <span class="nx">retrieve</span> <span class="nx">defer_1</span>
</span></span><span class="line"><span class="cl">        <span class="mf">2.</span> <span class="nx">Remove</span> <span class="nx">defer_1</span>
</span></span><span class="line"><span class="cl">        <span class="mf">2.</span> <span class="nx">Execute</span> <span class="nx">defer_1</span>
</span></span><span class="line"><span class="cl">            <span class="nx">gopanic</span> <span class="c1">// Second panic
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="mf">1.</span> <span class="nx">There</span> <span class="nx">is</span> <span class="nx">a</span> <span class="nx">defer_0</span> <span class="nx">on</span> <span class="nx">the</span> <span class="k">defer</span> <span class="nx">chain</span>
</span></span><span class="line"><span class="cl">                <span class="mf">2.</span> <span class="nx">Execute</span> <span class="nf">defer_0</span> <span class="p">(</span><span class="nx">defer_0</span> <span class="nx">does</span> <span class="nx">not</span> <span class="nx">recover</span><span class="p">,</span> <span class="nx">only</span> <span class="nx">prints</span> <span class="nx">one</span> <span class="nx">line</span> <span class="nx">of</span> <span class="nx">output</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="mf">3.</span> <span class="nx">Remove</span> <span class="nx">defer_0</span><span class="p">,</span> <span class="nx">the</span> <span class="nx">chain</span> <span class="nx">is</span> <span class="nx">empty</span><span class="p">,</span> <span class="nx">exit</span> <span class="nx">the</span> <span class="k">for</span> <span class="nx">loop</span>
</span></span><span class="line"><span class="cl">                <span class="mf">3.</span> <span class="nx">Execute</span> <span class="nx">fatalpanic</span>
</span></span><span class="line"><span class="cl">                    <span class="o">-</span> <span class="nf">exit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="nx">terminates</span> <span class="nx">the</span> <span class="nx">process</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Did you guess correctly?</p>
<h3 id="the-recovery-function">The <code>recovery</code> Function
</h3><p>Finally, let&rsquo;s take a look at the crucial <code>recovery</code> function. In the <code>gopanic</code> function, when executing the defer functions in the loop, if the <code>recovered</code> field of the <code>_panic</code> structure is set to true, the <code>mcall(recovery)</code> function is called to perform the so-called &ldquo;recovery.&rdquo;</p>
<p>Let&rsquo;s take a look at the implementation of the <code>recovery</code> function. It&rsquo;s a very simple function that resets the pc and sp registers and reschedules the Goroutine for execution.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// runtime/panic.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">recovery</span><span class="p">(</span><span class="nx">gp</span> <span class="o">*</span><span class="nx">g</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Retrieve the values of the stack pointer and program counter
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">sp</span> <span class="o">:=</span> <span class="nx">gp</span><span class="p">.</span><span class="nx">sigcode0</span>
</span></span><span class="line"><span class="cl">    <span class="nx">pc</span> <span class="o">:=</span> <span class="nx">gp</span><span class="p">.</span><span class="nx">sigcode1</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Reset the pc and sp registers of the Goroutine
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">gp</span><span class="p">.</span><span class="nx">sched</span><span class="p">.</span><span class="nx">sp</span> <span class="p">=</span> <span class="nx">sp</span>
</span></span><span class="line"><span class="cl">    <span class="nx">gp</span><span class="p">.</span><span class="nx">sched</span><span class="p">.</span><span class="nx">pc</span> <span class="p">=</span> <span class="nx">pc</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Reschedule the Goroutine
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">gogo</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">gp</span><span class="p">.</span><span class="nx">sched</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Resetting the pc and sp registers means what? The pc register points to the address of the instruction, in other words, it jumps to another location to execute instructions. It no longer executes the instructions sequentially after <code>gopanic</code>. The <code>_defer.pc</code> is the instruction line of the executed code, and where is this instruction?</p>
<p>For this, let&rsquo;s recall the chapter on <code>defer</code>. When a deferred function is registered, it corresponds to a <code>_defer</code> structure. When creating this structure, the <code>_defer.pc</code> field is assigned the instruction on the next line after the <code>new</code> function. This was explained in detail in the chapter on &ldquo;In-Depth Analysis of Defer&rdquo;.</p>
<p>Here&rsquo;s an example: if it&rsquo;s allocated on the stack, it will be in <code>deferprocStack</code>. So, <code>mcall(recovery)</code> jumps to this position, and the subsequent logic follows the <code>deferreturn</code> logic, executing the remaining <code>_defer</code> function chain.</p>
<p>That concludes the explanation of panic. It&rsquo;s just a special function call, nothing special. The only thing that makes it special is the special instruction jumps it performs.</p>

</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/golang/">Golang</a>
        
    </section>


    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    <section class="article-lastmod">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



        <span>
            Last updated on May 26, 2024 09:17 CST
        </span>
    </section></footer>


    
</article>

    

    

     
    
        
    <script src="//cdn.jsdelivr.net/npm/twikoo@1.6.21/dist/twikoo.all.min.js"></script>
<div id="tcomment"></div>
<style>
    .twikoo {
        background-color: var(--card-background);
        border-radius: var(--card-border-radius);
        box-shadow: var(--shadow-l1);
        padding: var(--card-padding);
    }
    :root[data-scheme="dark"] {
        --twikoo-body-text-color-main: rgba(255, 255, 255, 0.9);
        --twikoo-body-text-color: rgba(255, 255, 255, 0.7);
    }
    .twikoo .el-input-group__prepend,
    .twikoo .tk-action-icon,
    .twikoo .tk-submit-action-icon,
    .twikoo .tk-time,
    .twikoo .tk-comments-no,
    .twikoo .tk-comments-count {
        color: var(--twikoo-body-text-color);
    }
    .twikoo .el-input__inner,
    .twikoo .el-textarea__inner,
    .twikoo .tk-preview-container,
    .twikoo .tk-content,
    .twikoo .tk-nick,
    .twikoo .tk-send {
        color: var(--twikoo-body-text-color-main);
    }
    .twikoo .el-button{
        color: var(--twikoo-body-text-color)!important;
    }
    .twikoo .el-input__count {
        color: var(--twikoo-body-text-color) !important;
    }
    .OwO .OwO-body {
        background-color: var(--body-background) !important;
        color: var(--body-text-color) !important;
    }
</style><script>
    twikoo.init({
        envId: 'https:\/\/twikoo.yixiao9206.cn',
        el: '#tcomment',lang: 'en',})
</script>

    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2023 - 
        
        2024 Copyright Â© 2023 huizhou92
    </section>
    
    <section class="powerby">
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        Theme <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.26.0">Stack</a></b> designed by <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a>
    </section>
    
     	
	
	<div class="busuanzi-footer">
	<span id="busuanzi_container_site_pv">
		Total site visits: <span id="busuanzi_value_site_pv"></span>
	</span>
	<span id="busuanzi_container_site_uv">
		Total Visitors: <span id="busuanzi_value_site_uv"></span>
	</span>
	</div></footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
