[{"content":"reflectÂ ä¸º Go è¯­è¨€æä¾›äº†è¿è¡Œæ—¶åŠ¨æ€è·å–å¯¹è±¡çš„ç±»å‹å’Œå€¼ä»¥åŠåŠ¨æ€åˆ›å»ºå¯¹è±¡çš„èƒ½åŠ›ã€‚åå°„å¯ä»¥å¸®åŠ©æŠ½è±¡å’Œç®€åŒ–ä»£ç ï¼Œæé«˜å¼€å‘æ•ˆç‡ã€‚Go è¯­è¨€æ ‡å‡†åº“ä»¥åŠå¾ˆå¤šå¼€æºè½¯ä»¶ä¸­éƒ½ä½¿ç”¨äº† Go è¯­è¨€çš„åå°„èƒ½åŠ›ï¼Œä¾‹å¦‚ç”¨äºåºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„Â jsonã€ORM æ¡†æ¶Â gorm/xormÂ ç­‰ã€‚æœ¬æ–‡çš„ç›®æ ‡æ˜¯å­¦ä¹ reflectï¼Œä»¥åŠå¦‚ä½•æé«˜reflectçš„æ€§èƒ½ã€‚\nThis article was first published in the Medium MPP plan. If you are a Medium user, please follow me on Medium. Thank you very much.\nExample Code å¦‚ä½•ä½¿ç”¨åå°„ç®€åŒ–ä»£ç  æˆ‘ä»¬åˆ©ç”¨åå°„å®ç°ä¸€ä¸ªç®€å•çš„åŠŸèƒ½ï¼Œæ¥çœ‹çœ‹åå°„å¦‚ä½•å¸®åŠ©æˆ‘ä»¬ç®€åŒ–ä»£ç çš„ã€‚\nå‡è®¾æœ‰ä¸€ä¸ªé…ç½®ç±» Configï¼Œæ¯ä¸ªå­—æ®µæ˜¯ä¸€ä¸ªé…ç½®é¡¹ã€‚æˆ‘ä»¬éœ€è¦ä»ç¯å¢ƒå˜é‡ä¸­ è¯»å– CONFIG_xxxx ã€‚ç„¶ååˆå§‹åŒ–Configã€‚\nlist 1 ï¼šMySQL config\n1 2 3 4 5 6 7 8 9 // https://github.com/go-sql-driver/mysql/blob/v1.8.1/dsn.go#L37 type Config struct { User string `json:\u0026#34;user\u0026#34;` // Username Passwd string `json:\u0026#34;passwd\u0026#34;` // Password (requires User) Net string `json:\u0026#34;net\u0026#34;` // Network (e.g. \u0026#34;tcp\u0026#34;, \u0026#34;tcp6\u0026#34;, \u0026#34;unix\u0026#34;. default: \u0026#34;tcp\u0026#34;) Addr string `json:\u0026#34;addr\u0026#34;` // Address (default: \u0026#34;127.0.0.1:3306\u0026#34; for \u0026#34;tcp\u0026#34; and \u0026#34;/tmp/mysql.sock\u0026#34; for \u0026#34;unix\u0026#34;) DBName string `json:\u0026#34;db_name\u0026#34;` // Database name // ã€‚ã€‚ã€‚ã€‚ã€‚ } Footguns æˆ‘ä»¬å¾ˆå®¹æ˜“å†™å‡ºè¿™æ ·çš„ä»£ç ï¼Œ\nlist2: ä½¿ç”¨ for å¾ªç¯åˆå§‹åŒ– Config\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 func InitConfig() *Config { cfg := \u0026amp;Config{} keys := []string{\u0026#34;CONFIG_MYSQL_USER\u0026#34;, \u0026#34;CONFIG_MYSQL_PASSWD\u0026#34;, \u0026#34;CONFIG_MYSQL_NET\u0026#34;, \u0026#34;CONFIG_MYSQL_ADDR\u0026#34;, \u0026#34;CONFIG_MYSQL_DB_NAME\u0026#34;} for _, key := range keys { if env, exist := os.LookupEnv(key); exist { switch key { case \u0026#34;CONFIG_MYSQL_USER\u0026#34;: cfg.User = env case \u0026#34;CONFIG_MYSQL_PASSWORD\u0026#34;: cfg.Passwd = env case \u0026#34;CONFIG_MYSQL_NET\u0026#34;: cfg.Net = env case \u0026#34;CONFIG_MYSQL_ADDR\u0026#34;: cfg.Addr = env case \u0026#34;CONFIG_MYSQL_DB_NAME\u0026#34;: cfg.DBName = env } } } return cfg } ä½†æ˜¯ä½¿ç”¨ç¡¬ç¼–ç çš„è¯ï¼Œå¦‚æœConfigÂ ç»“æ„å‘ç”Ÿæ”¹å˜ï¼Œæ¯”å¦‚äº†ä¿®æ”¹Â jsonÂ å¯¹åº”çš„å­—æ®µã€åˆ é™¤æˆ–æ–°å¢äº†ä¸€ä¸ªé…ç½®é¡¹ç­‰ï¼Œè¿™å—çš„é€»è¾‘ä¹Ÿéœ€è¦å‘ç”Ÿæ”¹å˜ã€‚è€Œæ›´å¤§çš„é—®é¢˜åœ¨äºï¼šéå¸¸å®¹æ˜“å‡ºé”™ï¼Œä¸å¥½æµ‹è¯•ã€‚\nå¦‚æœæˆ‘ä»¬æ”¹æˆä½¿ç”¨ åå°„å®ç°ï¼Œå®ç°çš„ä»£ç å°±æ˜¯è¿™æ ·çš„:\nlist3: ä½¿ç”¨reflect å®ç°åˆå§‹åŒ–Config\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 func InitConfig2() *Config { config := Config{} typ := reflect.TypeOf(config) value := reflect.Indirect(reflect.ValueOf(\u0026amp;config)) for i := 0; i \u0026lt; typ.NumField(); i++ { f := typ.Field(i) if v, ok := f.Tag.Lookup(\u0026#34;json\u0026#34;); ok { key := fmt.Sprintf(\u0026#34;CONFIG_MYSQL_%s\u0026#34;, strings.ToUpper(v)) if env, exist := os.LookupEnv(key); exist { value.FieldByName(f.Name).Set(reflect.ValueOf(env)) } } } return \u0026amp;config } å®ç°é€»è¾‘å…¶å®æ˜¯éå¸¸ç®€å•çš„ï¼š\nåœ¨è¿è¡Œæ—¶ï¼Œåˆ©ç”¨åå°„è·å–åˆ°Â ConfigÂ çš„æ¯ä¸ªå­—æ®µçš„Â TagÂ å±æ€§ï¼Œæ‹¼æ¥å‡ºå¯¹åº”çš„ç¯å¢ƒå˜é‡çš„åç§°ã€‚ æŸ¥çœ‹è¯¥ç¯å¢ƒå˜é‡æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨å°±å°†ç¯å¢ƒå˜é‡çš„å€¼èµ‹å€¼ç»™è¯¥å­—æ®µã€‚\nè¿™æ ·ï¼Œæ— è®ºConfig æ·»åŠ è¿˜æ˜¯åˆ é™¤å­—æ®µï¼ŒInitConfig å‡½æ•°éƒ½ä¸éœ€è¦ä¿®æ”¹ï¼Œæ˜¯ä¸æ˜¯æ¯”ä½¿ç”¨forå¾ªç¯çš„æ–¹å¼ç®€æ´å¤šäº†ï¼Ÿ åå°„çš„æ€§èƒ½ æˆ‘ä»¬åœ¨å¾ˆå¤šåœ°æ–¹éƒ½å¬è¯´è¿‡:åå°„çš„æ€§èƒ½å¾ˆå·®ï¼Œå¹¶ä¸”æˆ‘ä»¬åœ¨å¯¹æ¯”jsonè§£æåº“çš„æ—¶å€™ä¹ŸéªŒè¯äº†å®˜æ–¹åº“JSON Unmarshal çš„æ€§èƒ½æ¯”è¾ƒä½.å› ä¸ºä»–éœ€è¦æ‰§è¡Œæ›´å¤šçš„æŒ‡ä»¤ã€‚é‚£ä¹ˆåå°„çš„æ€§èƒ½åˆ°åº•æœ‰å¤šå·®å‘¢ï¼Ÿ æˆ‘ä»¬åšä¸€æ¬¡benchmarkå°±çŸ¥é“äº†ã€‚\nlist 4 : benchmark test New And Reflect Performance\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 func BenchmarkNew(b *testing.B) { var config *Config for i := 0; i \u0026lt; b.N; i++ { config = new(Config) } _ = config } func BenchmarkReflectNew(b *testing.B) { var config *Config typ := reflect.TypeOf(Config{}) b.ResetTimer() for i := 0; i \u0026lt; b.N; i++ { config, _ = reflect.New(typ).Interface().(*Config) } _ = config } ---- âœ go_reflect git:(main) âœ— go test --bench . goos: darwin goarch: arm64 pkg: blog-example/go/go_reflect BenchmarkNew-10 47675076 25.40 ns/op BenchmarkReflectNew-10 36163776 32.51 ns/op PASS ok blog-example/go/go_reflect 3.895s å¦‚æœåªæ˜¯åˆ›å»ºçš„åœºæ™¯ï¼Œä¸¤è€…çš„æ€§èƒ½å·®è·ä¸æ˜¯ç‰¹åˆ«å¤§ã€‚\næˆ‘ä»¬å†æµ‹è¯•ä¸€ä¸‹ä¿®æ”¹å­—æ®µåœºæ™¯ï¼Œé€šè¿‡åå°„ä¿®æ”¹å­—æ®µæœ‰ä¸¤ç§æ–¹å¼\nFieldByName\nField ä¸‹æ ‡æ¨¡å¼\næˆ‘ä»¬åˆ†åˆ«æµ‹è¯•ä¸¤ç§æ¨¡å¼çš„æ€§èƒ½\nlist5: æµ‹è¯•ä¿®æ”¹Field çš„æ€§èƒ½\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 func BenchmarkFieldSet(b *testing.B) { config := new(Config) b.ResetTimer() for i := 0; i \u0026lt; b.N; i++ { config.Net = \u0026#34;tcp4\u0026#34; config.Addr = \u0026#34;127.0.0.1:3306\u0026#34; config.Passwd = \u0026#34;123456\u0026#34; config.User = \u0026#34;admin\u0026#34; } } func BenchmarkFieldSetFieldByName(b *testing.B) { config := new(Config) value := reflect.ValueOf(config).Elem() b.ResetTimer() for i := 0; i \u0026lt; b.N; i++ { value.FieldByName(\u0026#34;Net\u0026#34;).SetString(\u0026#34;tcp4\u0026#34;) value.FieldByName(\u0026#34;Addr\u0026#34;).SetString(\u0026#34;127.0.0.1:3306\u0026#34;) value.FieldByName(\u0026#34;Passwd\u0026#34;).SetString(\u0026#34;123456\u0026#34;) value.FieldByName(\u0026#34;User\u0026#34;).SetString(\u0026#34;admin\u0026#34;) } } func BenchmarkFieldSetField(b *testing.B) { config := new(Config) value := reflect.Indirect(reflect.ValueOf(config)) b.ResetTimer() for i := 0; i \u0026lt; b.N; i++ { value.Field(0).SetString(\u0026#34;tcp4\u0026#34;) value.Field(1).SetString(\u0026#34;127.0.0.1:3306\u0026#34;) value.Field(2).SetString(\u0026#34;123456\u0026#34;) value.Field(3).SetString(\u0026#34;admin\u0026#34;) } } ---- âœ go_reflect git:(main) âœ— go test --bench=\u0026#34;BenchmarkFieldSet*\u0026#34; goos: darwin goarch: arm64 pkg: blog-example/go/go_reflect BenchmarkFieldSet-10 1000000000 0.3282 ns/op BenchmarkFieldSetFieldByName-10 6471114 185.3 ns/op BenchmarkFieldSetField-10 100000000 11.88 ns/op PASS ok blog-example/go/go_reflect 3.910s å·®è·å¾ˆå¤§ï¼Œéreflect æ–¹å¼è·Ÿ reflect Field ä¸‹æ ‡æ¨¡å¼ ï¼Œå·®ä¸¤ä¸ªæ•°é‡çº§ï¼Œè·Ÿreflect FieldByName æ¨¡å¼ ç”šè‡³è¾¾åˆ°äº†ä¸‰ä¸ªæ•°é‡çº§ï¼Œæ¯”è¾ƒç–‘é—®çš„ä¸€ä¸ªç‚¹æ˜¯FieldByName æ¨¡å¼ è·Ÿ Field ä¸‹æ ‡æ¨¡å¼ å·®è·ç«Ÿç„¶ä¹Ÿæœ‰ä¸€ä¸ªæ•°é‡çº§ã€‚ä¸è¿‡æˆ‘ä»¬èƒ½å¤Ÿä»æºç ä¸­æ‰¾åˆ°ç­”æ¡ˆã€‚\nlist 6: reflect/value.go\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 func (v Value) FieldByName(name string) Value { v.mustBe(Struct) if f, ok := toRType(v.typ()).FieldByName(name); ok { return v.FieldByIndex(f.Index) } return Value{} } // FieldByIndex returns the nested field corresponding to index.// It panics if evaluation requires stepping through a nil // pointer or a field that is not a struct. func (v Value) FieldByIndex(index []int) Value { if len(index) == 1 { return v.Field(index[0]) } v.mustBe(Struct) for i, x := range index { if i \u0026gt; 0 { if v.Kind() == Pointer \u0026amp;\u0026amp; v.typ().Elem().Kind() == abi.Struct { if v.IsNil() { panic(\u0026#34;reflect: indirection through nil pointer to embedded struct\u0026#34;) } v = v.Elem() } } v = v.Field(x) } return v } list 7ï¼šreflect/type.go\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 func (t *rtype) FieldByName(name string) (StructField, bool) { if t.Kind() != Struct { panic(\u0026#34;reflect: FieldByName of non-struct type \u0026#34; + t.String()) } tt := (*structType)(unsafe.Pointer(t)) return tt.FieldByName(name) } // FieldByName returns the struct field with the given name// and a boolean to indicate if the field was found. func (t *structType) FieldByName(name string) (f StructField, present bool) { // Quick check for top-level name, or struct without embedded fields. hasEmbeds := false if name != \u0026#34;\u0026#34; { for i := range t.Fields { tf := \u0026amp;t.Fields[i] if tf.Name.Name() == name { return t.Field(i), true } if tf.Embedded() { hasEmbeds = true } } } if !hasEmbeds { return } return t.FieldByNameFunc(func(s string) bool { return s == name }) } åœ¨åå°„çš„å†…éƒ¨ï¼Œå­—æ®µæ˜¯æŒ‰é¡ºåºå­˜å‚¨çš„ï¼Œå› æ­¤æŒ‰ç…§ä¸‹æ ‡è®¿é—®æŸ¥è¯¢æ•ˆç‡ä¸º O(1)ï¼Œè€ŒæŒ‰ç…§Â NameÂ è®¿é—®ï¼Œåˆ™éœ€è¦éå†æ‰€æœ‰å­—æ®µï¼ŒæŸ¥è¯¢æ•ˆç‡ä¸º O(N)ã€‚ç»“æ„ä½“æ‰€åŒ…å«çš„å­—æ®µ(åŒ…æ‹¬æ–¹æ³•)è¶Šå¤šï¼Œé‚£ä¹ˆä¸¤è€…ä¹‹é—´çš„æ•ˆç‡å·®è·åˆ™è¶Šå¤§ã€‚ä½†æ˜¯æˆ‘ä»¬éœ€è¦è®°å¿†å­—æ®µçš„é¡ºåºï¼Œè¿™å¾ˆå®¹æ˜“å‡ºé”™ã€‚\nå¦‚ä½•æé«˜æ€§èƒ½ å°½é‡é¿å…ä½¿ç”¨reflect ä½¿ç”¨åå°„èµ‹å€¼ï¼Œæ•ˆç‡éå¸¸ä½ä¸‹ï¼Œå¦‚æœæœ‰æ›¿ä»£æ–¹æ¡ˆï¼Œå°½å¯èƒ½é¿å…ä½¿ç”¨åå°„ï¼Œç‰¹åˆ«æ˜¯ä¼šè¢«åå¤è°ƒç”¨çš„çƒ­ç‚¹ä»£ç ã€‚ä¾‹å¦‚ RPC åè®®ä¸­ï¼Œéœ€è¦å¯¹ç»“æ„ä½“è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼Œè¿™ä¸ªæ—¶å€™é¿å…ä½¿ç”¨ Go è¯­è¨€è‡ªå¸¦çš„Â jsonÂ çš„Â MarshalÂ å’ŒÂ UnmarshalÂ æ–¹æ³•ï¼Œå› ä¸ºæ ‡å‡†åº“ä¸­çš„ json åºåˆ—åŒ–å’Œååºåˆ—åŒ–æ˜¯åˆ©ç”¨åå°„å®ç°çš„ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨fastjsonç­‰æ›¿ä»£æ ‡å‡†åº“ï¼Œåº”è¯¥èƒ½å¸¦æ¥åå€å·¦å³çš„æå‡ã€‚\nå°½é‡ä½¿ç”¨ Field ä¸‹æ ‡æ¨¡å¼ ä»å‰é¢çš„benchmark çœ‹æ¥ï¼Œ Field ä¸‹æ ‡æ¨¡å¼æ¯”FieldByName çš„æ–¹å¼å¿«æ¥è¿‘ä¸€ä¸ªæ•°é‡çº§ï¼Œåœ¨å­—æ®µæ•°é‡å¤šçš„æ—¶å€™ï¼Œæ›´åŠ æ˜æ˜¾ï¼Œä½†æ˜¯ä½¿ç”¨Field ä¸‹æ ‡æ¨¡å¼ä¼šæ¯”è¾ƒéº»çƒ¦ï¼Œæˆ‘ä»¬éœ€è¦è®°å¿†ä¸‹æ ‡ï¼Œå¹¶ä¸”å¾ˆéš¾ä¿®æ”¹ã€‚è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸€ä¸ªMap å°†Name è·Ÿä¸‹æ ‡ç¼“å­˜èµ·æ¥ã€‚\næ¯”å¦‚ï¼š\nlist8: cache FieldByName and Field index\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 func BenchmarkFieldSetFieldByNameCache(b *testing.B) { config := new(Config) typ := reflect.TypeOf(Config{}) value := reflect.ValueOf(config).Elem() cache := make(map[string]int) for i := 0; i \u0026lt; typ.NumField(); i++ { cache[typ.Field(i).Name] = i } b.ResetTimer() for i := 0; i \u0026lt; b.N; i++ { value.Field(cache[\u0026#34;Net\u0026#34;]).SetString(\u0026#34;tcp4\u0026#34;) value.Field(cache[\u0026#34;Addr\u0026#34;]).SetString(\u0026#34;127.0.0.1:3306\u0026#34;) value.Field(cache[\u0026#34;Passwd\u0026#34;]).SetString(\u0026#34;123456\u0026#34;) value.Field(cache[\u0026#34;User\u0026#34;]).SetString(\u0026#34;admin\u0026#34;) } } ---- BenchmarkFieldSetFieldByNameCache-10 32121740 36.85 ns/op æ¯”ç›´æ¥ä½¿ç”¨FieldByName æå‡äº†4å€ï¼Œå¾ˆå¯è§‚çš„æå‡ã€‚\næ€»ç»“ æœ¬æ–‡æ²¡æœ‰æ·±å…¥ä»‹ç» reflect çš„ç»†èŠ‚ï¼Œå¦‚æœæ‚¨æƒ³è¦è¿›ä¸€æ­¥å­¦ä¹ reflect å¯ä»¥å‚è€ƒä¸‹é¢çš„æ–‡ç« ï¼š https://medium.com/capital-one-tech/learning-to-use-go-reflection-822a0aed74b7 https://go101.org/article/reflection.html åœ¨å„ä¸ªåŸºç¡€åº“ä¸­ï¼Œå¤§é‡ä½¿ç”¨reflect ï¼Œåˆç†çš„ä½¿ç”¨reflect æœ‰åŠ©äºç®€åŒ–ä»£ç ï¼Œä½†æ˜¯reflect æœ‰æ€§èƒ½æŸè€—ï¼Œæœ€æç«¯çš„æƒ…å†µå¯èƒ½é™ä½3ä¸ªæ•°é‡çº§ã€‚ å¯ä»¥ç”¨ Field index + cache çš„æ–¹å¼æ¥ä¼˜åŒ– æ€§èƒ½ã€‚\nå¯¹äºreflect æ‚¨æœ‰ä»€ä¹ˆå…¶ä»–æƒ³æ³•å˜›ï¼Ÿç•™è¨€è·Ÿæˆ‘ä¸€èµ·è®¨è®ºã€‚ ","date":"2024-07-09T09:44:18+08:00","permalink":"https://huizhou92.com/zh-cn/p/go%E9%AB%98%E6%80%A7%E8%83%BD%E7%BC%96%E7%A8%8B-ep4-%E5%8F%8D%E5%B0%84/","title":"Goé«˜æ€§èƒ½ç¼–ç¨‹ EP4: åå°„"},{"content":" æœ¬æ–‡å†™ä½œæ‰€æœ‰çš„ä¾‹å­ä»¥ macbookpro M1 ä¸ºä¾‹ï¼Œè¯¥CPUä¸º64ä½æ¶æ„\næœ¬æ–‡æ˜¯Goè¯­è¨€é«˜æ€§èƒ½ç¼–ç¨‹ç¬¬ä¸‰ç¯‡ï¼Œåˆ†æäº†ä¸ºä»€ä¹ˆéœ€è¦å†…å­˜å¯¹é½ï¼ŒGoè¯­è¨€å†…å­˜å¯¹é½çš„è§„åˆ™ï¼Œä»¥åŠå®é™…ä¾‹å­ä¸­å†…å­˜å¯¹é½çš„ä½¿ç”¨ï¼Œæœ€ååˆ†äº«äº†ä¸¤ä¸ªå·¥å…·ï¼Œå¸®åŠ©æˆ‘ä»¬åœ¨å¼€å‘è¿‡ç¨‹ä¸­å‘ç°å†…å­˜å¯¹é½é—®é¢˜ã€‚\nThis article was first published in the Medium MPP plan. If you are a Medium user, please follow me on Medium. Thank you very much.\nä»€ä¹ˆæ˜¯å†…å­˜å¯¹é½ï¼Ÿ åœ¨ç¨‹åºå‘˜çœ¼é‡Œï¼Œå†…å­˜å¯èƒ½å°±æ˜¯ä¸€ä¸ªå·¨å¤§çš„æ•°ç»„ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å†…å­˜ä¸­å†™ä¸€ä¸ªint16 ,å ç”¨ä¸¤ä¸ªå­—èŠ‚ã€‚ä¹Ÿå¯ä»¥å†™ä¸€ä¸ªint32ï¼Œå ç”¨å››ä¸ªå­—èŠ‚ã€‚ æ¯”å¦‚\n1 2 3 4 5 type T1 struct { a int8 b int64 c int16 } è¿™ä¸ª struce ä¸ç†Ÿæ‚‰Goè¯­è¨€çš„äººå¯èƒ½è®¤ä¸ºæ˜¯ä¸‹é¢è¿™ç§å¸ƒå±€ã€‚ æ€»å…±å ç”¨11å­—èŠ‚ç©ºé—´ã€‚\nFigure 1: Memory layout as understood by some people\nä¸€ä¸ªæŒ¨ç€ä¸€ä¸ªï¼Œå¾ˆç´§å‡‘ï¼Œå¾ˆå®Œç¾ã€‚\nä½†æ˜¯å®é™…ä¸Šå¹¶ä¸æ˜¯è¿™æ ·çš„ã€‚å¦‚æœæˆ‘ä»¬æ‰“å° T1 çš„å˜é‡åœ°å€ï¼Œä¼šå‘ç°ï¼Œä»–ä»¬å¤§æ¦‚é•¿è¿™æ ·ã€‚æ€»å…±å ç”¨ 24å­—èŠ‚ç©ºé—´ã€‚\nFigure 2: T1 çš„å®é™…å†…å­˜å¸ƒå±€\nList 1ï¼šT1 size\n1 2 3 4 5 6 7 8 9 10 func main() { t := T1{} fmt.Println(fmt.Sprintf(\u0026#34;%d %d %d %d\u0026#34;, unsafe.Sizeof(t.a), unsafe.Sizeof(t.b), unsafe.Sizeof(t.c), unsafe.Sizeof(t))) fmt.Println(fmt.Sprintf(\u0026#34;%p %p %p\u0026#34;, \u0026amp;t.a, \u0026amp;t.b, \u0026amp;t.c)) fmt.Println(unsafe.Alignof(t)) } // output // 1 8 2 24 // 0x14000114018 0x14000114020 0x14000114028 // 8 å› ä¸ºCPUä»å†…å­˜é‡Œé¢æ‹¿æ•°æ®ï¼Œæ˜¯æ ¹æ®word size æ¥æ‹¿çš„ï¼Œæ¯”å¦‚ 64 ä½çš„ CPU ï¼Œword size ä¸º 8å­—èŠ‚ï¼Œé‚£ä¹ˆ CPU è®¿é—®å†…å­˜çš„å•ä½ä¹Ÿæ˜¯ 8 å­—èŠ‚ï¼Œæˆ‘ä»¬å°†å¤„ç†å™¨è®¿é—®å†…å­˜çš„å¤§å°ç§°ä¸ºå†…å­˜è®¿é—®ç²’åº¦ã€‚\nè¿™ç§ç°è±¡ï¼Œä¼šé€ æˆå‡ ä¸ªä¸¥é‡çš„é—®é¢˜\næ€§èƒ½é™ä½ï¼Œå› ä¸ºå¤šäº†ä¸€æ¬¡CPUæŒ‡ä»¤ åŸæœ¬è¯»ä¸€ä¸ªå˜é‡æ˜¯åŸå­æ“ä½œçš„ï¼Œç°åœ¨å˜å¾—ä¸åŸå­ ä¸€äº›å…¶ä»–æ„æƒ³ä¸åˆ°çš„æƒ…å†µã€‚\næ‰€ä»¥ä¸€èˆ¬ç¼–è¯‘å™¨éƒ½ä¼šå®ç°å†…å­˜å¯¹é½ï¼Œç”¨ç‰ºç‰²å†…å­˜ç©ºé—´çš„æ–¹å¼ï¼Œä¿è¯äº†ï¼š å¹³å°ï¼ˆç§»æ¤æ€§ï¼‰\nä¸æ˜¯æ‰€æœ‰çš„ç¡¬ä»¶å¹³å°éƒ½èƒ½å¤Ÿè®¿é—®ä»»æ„åœ°å€ä¸Šçš„ä»»æ„æ•°æ®ã€‚ä¾‹å¦‚ï¼šç‰¹å®šçš„ç¡¬ä»¶å¹³å°åªå…è®¸åœ¨ç‰¹å®šåœ°å€è·å–ç‰¹å®šç±»å‹çš„æ•°æ®ï¼Œå¦åˆ™ä¼šå¯¼è‡´å¼‚å¸¸æƒ…å†µã€‚ æ€§èƒ½\nè‹¥è®¿é—®æœªå¯¹é½çš„å†…å­˜ï¼Œå°†ä¼šå¯¼è‡´ CPU è¿›è¡Œä¸¤æ¬¡å†…å­˜è®¿é—®ï¼Œå¹¶ä¸”è¦èŠ±è´¹é¢å¤–çš„æ—¶é’Ÿå‘¨æœŸæ¥å¤„ç†å¯¹é½åŠè¿ç®—ã€‚è€Œæœ¬èº«å°±å¯¹é½çš„å†…å­˜ä»…éœ€è¦ä¸€æ¬¡è®¿é—®å°±å¯ä»¥å®Œæˆè¯»å–åŠ¨ä½œï¼Œè¿™æ˜¾ç„¶é«˜æ•ˆå¾ˆå¤šï¼Œæ˜¯æ ‡å‡†çš„ç©ºé—´æ¢æ—¶é—´åšæ³•ã€‚ GOè¯­è¨€å†…å­˜å¯¹é½ go spec ä¸­çº¦å®šäº† go å¯¹é½çš„è§„åˆ™ã€‚\n1 2 3 4 5 6 7 type size in bytes byte, uint8, int8 1 uint16, int16 2 uint32, int32, float32 4 uint64, int64, float64, complex64 8 complex128 16 For a variableÂ xÂ of any type:Â unsafe.Alignof(x)Â is at least 1. For a variableÂ xÂ of struct type:Â unsafe.Alignof(x)Â is the largest of all the valuesÂ unsafe.Alignof(x.f)Â for each fieldÂ fÂ ofÂ x, but at least 1. For a variableÂ xÂ of array type:Â unsafe.Alignof(x)Â is the same as the alignment of a variable of the array\u0026rsquo;s element type. ç»å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œgoç¼–è¯‘å™¨ä¼šå¸®æˆ‘ä»¬è‡ªåŠ¨å†…å­˜å¯¹é½ï¼Œæˆ‘ä»¬ä¸éœ€è¦å…³å¿ƒå†…å­˜æ˜¯å¦å¯¹é½ï¼Œä½†æ˜¯åœ¨æœ‰ä¸€ç§æƒ…å†µä¸‹ï¼Œéœ€è¦æ‰‹åŠ¨å¯¹é½ã€‚\nåœ¨ x86 å¹³å°ä¸ŠåŸå­æ“ä½œ 64bit æŒ‡é’ˆã€‚ä¹‹æ‰€ä»¥è¦å¼ºåˆ¶å¯¹é½ï¼Œæ˜¯å› ä¸ºåœ¨ 32bit å¹³å°ä¸‹è¿›è¡Œ 64bit åŸå­æ“ä½œè¦æ±‚å¿…é¡» 8 å­—èŠ‚å¯¹é½ï¼Œå¦åˆ™ç¨‹åºä¼š panicã€‚\næ¯”å¦‚ä¸‹é¢è¿™æ®µä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 package main import \u0026#34;sync/atomic\u0026#34; type T3 struct { b int64 c int32 d int64 } func main() { a := T3{} atomic.AddInt64(\u0026amp;a.d, 1) } åœ¨ amd64 æ¶æ„ä¸‹è¿è¡Œä¸ä¼šæŠ¥é”™ï¼Œä½†æ˜¯åœ¨i386 æ¶æ„ä¸‹é¢å°±ä¼španicã€‚\nFigure 3: T3 panic\nåŸå› å°±æ˜¯ T3 åœ¨ 32bit å¹³å°ä¸Šæ˜¯ 4 å­—èŠ‚å¯¹é½ï¼Œè€Œåœ¨ 64bit å¹³å°ä¸Šæ˜¯ 8 å­—èŠ‚å¯¹é½ã€‚åœ¨ 64bit å¹³å°ä¸Šå…¶å†…å­˜å¸ƒå±€ä¸ºï¼š\nFigure 4: T3åœ¨ amd64 çš„å†…å­˜å¸ƒå±€\nä½†æ˜¯åœ¨I386 çš„å¸ƒå±€ä¸ºï¼š\nFigure 5: T3åœ¨ i386çš„å†…å­˜å¸ƒå±€\nè¿™ä¸ªé—®é¢˜åœ¨ atomic çš„ æ–‡æ¡£ä¸­æœ‰å†™ã€‚\nOn 386, the 64-bit functions use instructions unavailable before the Pentium MMX.\nOn non-Linux ARM, the 64-bit functions use instructions unavailable before the ARMv6k core.\nOn ARM, 386, and 32-bit MIPS, it is the caller\u0026rsquo;s responsibility to arrange for 64-bit alignment of 64-bit words accessed atomically via the primitive atomic functions (typesÂ Int64Â andÂ Uint64Â are automatically aligned). The first word in an allocated struct, array, or slice; in a global variable; or in a local variable (because the subject of all atomic operations will escape to the heap) can be relied upon to be 64-bit aligned. ä¸ºäº†è§£å†³è¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬å¿…é¡»æ‰‹åŠ¨ padding T3ï¼Œè®©å…¶ â€œçœ‹èµ·æ¥â€ åƒæ˜¯ 8 å­—èŠ‚å¯¹é½çš„ï¼š\n1 2 3 4 5 6 type T3 struct { b int64 c int32 _ int32 d int64 } åœ¨goæºç å’Œå¼€æºåº“ä¸­ä¹Ÿèƒ½çœ‹åˆ°å¾ˆå¤šç±»ä¼¼çš„æ“ä½œã€‚\næ¯”å¦‚\nmgc groupcache æ‰€å¹¸çš„æ˜¯ï¼Œæˆ‘ä»¬å…¶å®æœ‰å¾ˆå¤šå·¥å…·æ¥å¸®åŠ©æˆ‘ä»¬è¯†åˆ«ä¸ä¼˜åŒ– è¿™äº›é—®é¢˜ã€‚\nå·¥ç¨‹å®è·µ fieldalignment fieldalignment æ˜¯golang å®˜æ–¹çš„å·¥å…·ï¼Œå®ƒä¼šå¸®æˆ‘ä»¬å‘ç°ä»£ç ä¸­å¯èƒ½çš„å†…å­˜å¯¹é½ä¼˜åŒ–ä»¥åŠè‡ªåŠ¨å¸®æˆ‘ä»¬å¯¹é½ã€‚ æ¯”å¦‚T1 å®ƒä¼šè‡ªåŠ¨ è½¬æˆå†…å­˜å¯¹é½çš„ã€‚\n1 2 3 4 5 6 7 8 9 âœ go_mem_alignment git:(main) âœ— fieldalignment -fix . /Users/hxzhouh/workspace/github/blog-example/go/go_mem_alignment/main.go:8:8: struct of size 24 could be 16 // change type T1 struct { b int64 c int16 a int8 } ä¹Ÿå¯ä»¥åœ¨ golangci-link ä¸­ä½¿ç”¨å®ƒï¼Œfieldalignment æ˜¯éš¶å±äº govet çš„ä¸€ä¸ªå­åŠŸèƒ½ï¼Œåœ¨ .golangci.yaml ä¸­å¯ä»¥è¿™æ ·å¯ç”¨å®ƒï¼š\nlist :\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 # .golangci.yml linters: disable-all: true enable: - govet fast: false linters-settings: govet: # report about shadowed variables check-shadowing: false fast: false # disable: # - fieldalignment # I\u0026#39;m ok to waste some bytes enable: - fieldalignment ä½†æ˜¯ï¼Œfieldalignment æœ‰ä¸€ä¸ªæ¯”è¾ƒæ¼ç«çš„åœ°æ–¹ï¼šå®ƒä¼šåœ¨é‡æ–°æ’å¸ƒç»“æ„ä½“æˆå‘˜çš„æ—¶å€™ï¼Œå°†æ‰€æœ‰ç©ºè¡Œã€æ³¨é‡Šé€šé€šåˆ å»ã€‚ æ‰€ä»¥æœ‰æ—¶å€™ï¼Œä½ åº”è¯¥ git commit ä¸€æ¬¡ï¼Œç„¶åç”¨ä¸€ä¸‹è¿™ä¸ªå·¥å…·ï¼Œç„¶åé€šè¿‡ git diff æ¥ review å®ƒæ‰€åšçš„å˜æ›´ï¼Œç„¶åè¿›è¡Œè‹¥å¹²åå¤„ç†ã€‚æ‰€ä»¥æˆ‘å†ç”Ÿäº§ç¯å¢ƒå¾ˆå°‘ä½¿ç”¨è¿™ä¸ª å·¥å…·ï¼Œä¸€èˆ¬ä½¿ç”¨structlayout\nstructlayout structlayout å¯ä»¥æ˜¾ç¤ºstructçš„å¸ƒå±€ä»¥åŠå¤§å°ï¼Œå¯ä»¥è¾“å‡ºsvgæˆ–è€…jsonæ ¼å¼çš„æ•°æ®ã€‚å¦‚æœä¸€ä¸ªstruct æ¯”è¾ƒå¤æ‚ï¼Œå¯ä»¥ç”¨è¿™ä¸ªå·¥å…·æ¥ä¼˜åŒ–ã€‚\nå®‰è£…æ–¹å¼\n1 2 3 4 go install honnef.co/go/tools/cmd/structlayout@latest go install honnef.co/go/tools/cmd/structlayout-pretty@latest go install honnef.co/go/tools/cmd/structlayout-optimize@latest go install github.com/ajstarks/svgo/structlayout-svg@latest ç”¨structlayout åˆ†æä¸€ä¸‹ T1\n1 structlayout -json ./main.go T1 | structlayout-svg \u0026gt;T1.svg Figure 6: T1 Structure Layout\næˆ‘ä»¬å¯ä»¥å¾ˆæ¸…æ¥šçš„çœ‹åˆ°æœ‰ä¸¤ä¸ªpaddingã€‚ 7 size å’Œ 6size\nä¼˜åŒ–åçš„T2ï¼š\n1 2 3 4 5 type T2 struct { a int8 c int16 b int64 } Figure 7: T2 Structure Layout\nåªæœ‰ä¹Ÿæœ‰ä¸¤ä¸ªåœ°æ–¹æœ‰paddingï¼Œä½†æ˜¯åªæœ‰5ä¸ªsizeã€‚\næ€»ç»“ åœ¨ç¨‹åºè®¾è®¡ä¸­ï¼Œå†…å­˜å¯¹é½æ˜¯ä¸€é¡¹å…³é”®æŠ€æœ¯ï¼Œæ—¨åœ¨æé«˜ç¨‹åºæ€§èƒ½å’Œå…¼å®¹æ€§ã€‚æœ¬æ–‡ä»¥Goè¯­è¨€ä¸ºä¾‹ï¼Œè¯¦ç»†è®²è§£äº†å†…å­˜å¯¹é½çš„åŸºæœ¬æ¦‚å¿µå’Œå¿…è¦æ€§ï¼Œå¹¶é€šè¿‡ä»£ç ç¤ºä¾‹å±•ç¤ºäº†ä¸åŒç»“æ„ä½“åœ¨å†…å­˜ä¸­çš„å®é™…å¸ƒå±€ã€‚\nGoè¯­è¨€ä¸­çš„å†…å­˜å¯¹é½è§„åˆ™ä¸»è¦ä½“ç°åœ¨ç»“æ„ä½“å­—æ®µçš„æ’åˆ—é¡ºåºä¸Šã€‚ç¼–è¯‘å™¨é€šè¿‡è‡ªåŠ¨å¯¹é½æ¥ä¿è¯æ€§èƒ½å’Œå¹³å°ç§»æ¤æ€§ï¼Œä½†åœ¨æŸäº›æƒ…å†µä¸‹éœ€è¦å¼€å‘è€…æ‰‹åŠ¨è°ƒæ•´ç»“æ„ä½“å­—æ®µä»¥é¿å…æ€§èƒ½é—®é¢˜å’Œæ½œåœ¨çš„é”™è¯¯ã€‚\nempty struct æ˜¯å†…å­˜å¯¹é½ä¼˜åŒ–çš„ä¸€ä¸ªå¥½å¸®æ‰‹ï¼Œå…·ä½“æ“ä½œå¯ä»¥å‚è€ƒæˆ‘çš„å¦å¤–ä¸€ç¯‡æ–‡ç« ï¼šGolang High-Performance Programming EP1: Empty Struct\nä¸ºå¸®åŠ©å¼€å‘è€…æ£€æµ‹å’Œä¼˜åŒ–å†…å­˜å¯¹é½é—®é¢˜ï¼Œæœ¬æ–‡ä»‹ç»äº†ä¸¤ä¸ªå®ç”¨å·¥å…·ï¼š\nfieldalignmentï¼šGoå®˜æ–¹å·¥å…·ï¼Œèƒ½è‡ªåŠ¨ä¼˜åŒ–ç»“æ„ä½“çš„å†…å­˜å¯¹é½ã€‚ structlayoutï¼šæ˜¾ç¤ºç»“æ„ä½“çš„å†…å­˜å¸ƒå±€ï¼Œå¸®åŠ©å¼€å‘è€…æ›´ç›´è§‚åœ°ç†è§£å’Œä¼˜åŒ–å†…å­˜ä½¿ç”¨ã€‚ é€šè¿‡åˆç†ä½¿ç”¨è¿™äº›å·¥å…·ï¼Œå¼€å‘è€…å¯ä»¥åœ¨ä¿è¯ç¨‹åºæ€§èƒ½å’Œç¨³å®šæ€§çš„åŒæ—¶ï¼Œå‡å°‘å†…å­˜æµªè´¹ï¼Œæå‡å¼€å‘æ•ˆç‡ã€‚\nå‚è€ƒèµ„æ–™ IBM DeveloperWorks: Data Alignment Go Specification: Size and Alignment Guarantees ","date":"2024-07-03T15:48:59+08:00","image":"https://images.hxzhouh.com/blog-images/2024/07/b3eca51256266ff32f8a27c85544e1c8.jpg","permalink":"https://huizhou92.com/zh-cn/p/go-%E9%AB%98%E6%80%A7%E8%83%BD%E7%BC%96%E7%A8%8Bep3-%E5%86%85%E5%AD%98%E5%AF%B9%E9%BD%90/","title":"go é«˜æ€§èƒ½ç¼–ç¨‹EP3: å†…å­˜å¯¹é½"},{"content":"æˆ‘ä»¬éƒ½çŸ¥é“ï¼ŒGoæœ‰ä¸€ä¸ªå¾ˆé‡è¦çš„ç‰¹ç‚¹ï¼Œé‚£å°±æ˜¯å®ƒçš„ç¼–è¯‘é€Ÿåº¦éå¸¸å¿«ï¼Œç¼–è¯‘é€Ÿåº¦æ˜¯Goè¯­è¨€è®¾è®¡çš„æ—¶å€™å°±é‡ç‚¹è€ƒè™‘çš„é—®é¢˜. ä½†æ˜¯æ‚¨æœ‰æ²¡æœ‰è§‚å¯Ÿè¿‡Goè¯­è¨€ç¼–è¯‘åçš„äºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶çš„å¤§å°ï¼Ÿæˆ‘ä»¬å…ˆç”¨ä¸€ä¸ªç®€å•çš„http server çš„ä¾‹å­æ¥çœ‹çœ‹ã€‚\nThis article was first published in the Medium MPP plan. If you are a Medium user, please follow me on Medium. Thank you very much.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 import ( \u0026#34;fmt\u0026#34; \u0026#34;net/http\u0026#34; ) func main() { // create a http server and create a handler hello, return hello world http.HandleFunc(\u0026#34;/\u0026#34;, func(w http.ResponseWriter, r *http.Request) { fmt.Fprintf(w, \u0026#34;Hello, World\\n\u0026#34;) }) // listen to port 8080 err := http.ListenAndServe(\u0026#34;:8080\u0026#34;, nil) if err != nil { return } } --- ç¼–è¯‘åçš„ä½“ç§¯è¾¾åˆ°äº†6.5M\n1 2 3 âœ binary-size git:(main) âœ— go build -o server main.go âœ binary-size git:(main) âœ— ls -lh server -rwxr-xr-x 1 hxzhouh staff 6.5M Jul 2 14:20 server Goè¯­è¨€çš„ç¼–è¯‘å™¨ä¼šå¯¹äºŒè¿›åˆ¶æ–‡ä»¶çš„å¤§å°è¿›è¡Œè£å‰ªï¼Œå¦‚æœæ‚¨å¯¹è¿™éƒ¨åˆ†çš„å†…å®¹æ„Ÿå…´è¶£ï¼Œè¯·é˜…è¯»æˆ‘çš„å¦å¤–ä¸€ç¯‡æ–‡ç« How Does the Go Compiler Reduce Binary File Size?\nç°åœ¨æˆ‘ä»¬æ¥å°è¯•ä¼˜åŒ–ä¸€ä¸‹server çš„å¤§å°ã€‚\næ¶ˆé™¤è°ƒè¯•ä¿¡æ¯ Go ç¼–è¯‘å™¨é»˜è®¤ç¼–è¯‘å‡ºæ¥çš„ç¨‹åºä¼šå¸¦æœ‰ç¬¦å·è¡¨å’Œè°ƒè¯•ä¿¡æ¯ï¼Œä¸€èˆ¬æ¥è¯´ release ç‰ˆæœ¬å¯ä»¥å»é™¤è°ƒè¯•ä¿¡æ¯ä»¥å‡å°äºŒè¿›åˆ¶ä½“ç§¯ã€‚\n1 2 3 âœ binary-size git:(main) âœ— go build -ldflags=\u0026#34;-s -w\u0026#34; -o server main.go âœ binary-size git:(main) âœ— ls -lh server -rwxr-xr-x 1 hxzhouh staff 4.5M Jul 2 14:30 server -sï¼šå¿½ç•¥ç¬¦å·è¡¨å’Œè°ƒè¯•ä¿¡æ¯ã€‚ -wï¼šå¿½ç•¥DWARFv3è°ƒè¯•ä¿¡æ¯ï¼Œä½¿ç”¨è¯¥é€‰é¡¹åå°†æ— æ³•ä½¿ç”¨gdbè¿›è¡Œè°ƒè¯•ã€‚\nä½“ç§¯ä» 6.5M ä¸‹é™åˆ° 4.5Mï¼Œä¸‹é™çº¦ 30%ã€‚è¿™æ˜¯å¾ˆå¥½çš„ç¬¬ä¸€æ­¥ã€‚ ä½¿ç”¨ upx UPX is an advanced executable file compressor. UPX will typically reduce the file size of programs and DLLs by around 50%-70%, thus reducing disk space, network load times, download times and other distribution and storage costs.\nåœ¨Mac ä¸Šå¯ä»¥é€šè¿‡brew å®‰è£…upx\n1 brew install upx å•ç‹¬ä½¿ç”¨upx å‹ç¼© upx æœ‰å¾ˆå¤šå‚æ•°ï¼Œæœ€é‡è¦çš„åˆ™æ˜¯å‹ç¼©ç‡ï¼Œ1-9ï¼Œ1Â ä»£è¡¨æœ€ä½å‹ç¼©ç‡ï¼Œ9Â ä»£è¡¨æœ€é«˜å‹ç¼©ç‡ã€‚\næ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹ï¼Œå¦‚æœåªä½¿ç”¨ upx å‹ç¼©ï¼ŒäºŒè¿›åˆ¶çš„ä½“ç§¯å¯ä»¥å‡å°å¤šå°‘å‘¢ã€‚\n1 2 âœ binary-size git:(main) âœ— go build -o server main.go \u0026amp;\u0026amp; upx -9 server \u0026amp;\u0026amp; ls -lh server -rwxr-xr-x 1 hxzhouh staff 3.9M Jul 2 14:38 server å‹ç¼©æ¯”ä¾‹è¾¾åˆ°äº† 60%\nupx + ç¼–è¯‘å™¨é€‰é¡¹ åŒæ—¶å¼€å¯ upx + -ldflags=\u0026quot;-s -w\u0026quot;\n1 2 âœ binary-size git:(main) âœ— go build -ldflags=\u0026#34;-s -w\u0026#34; -o server main.go \u0026amp;\u0026amp; upx --brute server \u0026amp;\u0026amp; ls -lh server -rwxr-xr-x 1 hxzhouh staff 1.4M Jul 2 14:40 server æœ€ç»ˆæˆ‘ä»¬å¾—åˆ°çš„çš„å¯æ‰§è¡Œæ–‡ä»¶çš„å¤§å°æ˜¯ 1.4M å¯¹æ¯”ä¸å¼€å¯ä»»ä½•å‹ç¼©çš„6.5Mï¼Œå¤§çº¦èŠ‚çº¦äº†80%çš„ç©ºé—´ï¼Œå¯¹äºå¤§å‹åº”ç”¨ï¼Œè¿˜æ˜¯æŒºå¯è§‚çš„ã€‚\nupx çš„åŸç† upx å‹ç¼©åçš„ç¨‹åºå’Œå‹ç¼©å‰çš„ç¨‹åºä¸€æ ·ï¼Œæ— éœ€è§£å‹ä»ç„¶èƒ½å¤Ÿæ­£å¸¸åœ°è¿è¡Œï¼Œè¿™ç§å‹ç¼©æ–¹æ³•ç§°ä¹‹ä¸ºå¸¦å£³å‹ç¼©ï¼Œå‹ç¼©åŒ…å«ä¸¤ä¸ªéƒ¨åˆ†ï¼š\nåœ¨ç¨‹åºå¼€å¤´æˆ–å…¶ä»–åˆé€‚çš„åœ°æ–¹æ’å…¥è§£å‹ä»£ç ï¼› å°†ç¨‹åºçš„å…¶ä»–éƒ¨åˆ†å‹ç¼©ã€‚ æ‰§è¡Œæ—¶ï¼Œä¹ŸåŒ…å«ä¸¤ä¸ªéƒ¨åˆ†ï¼š\né¦–å…ˆæ‰§è¡Œçš„æ˜¯ç¨‹åºå¼€å¤´çš„æ’å…¥çš„è§£å‹ä»£ç ï¼Œå°†åŸæ¥çš„ç¨‹åºåœ¨å†…å­˜ä¸­è§£å‹å‡ºæ¥ï¼› å†æ‰§è¡Œè§£å‹åçš„ç¨‹åºã€‚\nä¹Ÿå°±æ˜¯è¯´ï¼Œupx åœ¨ç¨‹åºæ‰§è¡Œæ—¶ï¼Œä¼šæœ‰é¢å¤–çš„è§£å‹åŠ¨ä½œï¼Œä¸è¿‡è¿™ä¸ªè€—æ—¶å‡ ä¹å¯ä»¥å¿½ç•¥ã€‚\nå¦‚æœå¯¹ç¼–è¯‘åçš„ä½“ç§¯æ²¡ä»€ä¹ˆè¦æ±‚çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥ä¸ä½¿ç”¨ upx æ¥å‹ç¼©ã€‚ä¸€èˆ¬åœ¨æœåŠ¡å™¨ç«¯ç‹¬ç«‹è¿è¡Œçš„åå°æœåŠ¡ï¼Œæ— éœ€å‹ç¼©ä½“ç§¯ã€‚ æœ€å https://stackoverflow.com/questions/3861634/how-to-reduce-go-compiled-file-size\nè¿™å¸–å­é‡Œé¢æœ‰å¾ˆå¤šæœ‰æ„æ€çš„ç­”æ¡ˆï¼Œ\næ¯”å¦‚ç”¨cè¯­è¨€è·Ÿgoè¯­è¨€å®ç°ç›¸åŒçš„åŠŸèƒ½ï¼ˆå°demoï¼‰cè¯­è¨€ç”Ÿæˆçš„å¯æ‰§è¡Œå¤§å°æ˜¯ go è¯­è¨€çš„1/20(ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ) åœ¨Goè¯­è¨€ä¸­æˆ‘ä»¬ä½¿ç”¨ println æ¥æ›¿ä»£ fmt.println å°±èƒ½é¿å…å¼•å…¥fmtåŒ…ï¼Œè¿›ä¸€æ­¥ç¼©å°ä½“ç§¯ã€‚ ","date":"2024-07-02T15:01:44+08:00","image":"https://images.yixiao9206.cn/blog-images/2024/07/5f408427cbeaa5018a5af3e3499fdb82.png","permalink":"https://huizhou92.com/zh-cn/p/go-%E9%AB%98%E6%80%A7%E8%83%BD%E7%BC%96%E7%A8%8Bep2-%E9%80%9A%E8%BF%87upx-%E7%BC%A9%E5%B0%8F%E5%8F%AF%E6%89%A7%E8%A1%8C%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%96%87%E4%BB%B6%E7%9A%84%E4%BD%93%E7%A7%AF/","title":"Go é«˜æ€§èƒ½ç¼–ç¨‹EP2:  é€šè¿‡upx ç¼©å°å¯æ‰§è¡ŒäºŒè¿›åˆ¶æ–‡ä»¶çš„ä½“ç§¯"},{"content":"gRPC ä¸€èˆ¬ä¸åœ¨ message ä¸­å®šä¹‰é”™è¯¯ã€‚\næ¯•ç«Ÿæ¯ä¸ª gRPC æœåŠ¡æœ¬èº«å°±å¸¦ä¸€ä¸ª error çš„è¿”å›å€¼ï¼Œè¿™æ˜¯ç”¨æ¥ä¼ è¾“é”™è¯¯çš„ä¸“ç”¨é€šé“ã€‚\ngRPC ä¸­æ‰€æœ‰çš„é”™è¯¯è¿”å›éƒ½åº”è¯¥æ˜¯ nil æˆ–è€… ç”± status.Status äº§ç”Ÿçš„ä¸€ä¸ªerrorã€‚è¿™æ ·errorå¯ä»¥ç›´æ¥è¢«è°ƒç”¨æ–¹Clientè¯†åˆ«ã€‚\nThis article is first published in the medium MPP plan. If you are a medium user, please follow me in medium. Thank you very much.\n1. å¸¸è§„ç”¨æ³• å½“é‡åˆ°ä¸€ä¸ªgoé”™è¯¯çš„æ—¶å€™ï¼Œç›´æ¥è¿”å›æ˜¯æ— æ³•è¢«ä¸‹æ¸¸clientè¯†åˆ«çš„ã€‚\næ°å½“çš„åšæ³•æ˜¯ï¼š\nè°ƒç”¨ status.New æ–¹æ³•ï¼Œå¹¶ä¼ å…¥ä¸€ä¸ªé€‚å½“çš„é”™è¯¯ç ï¼Œç”Ÿæˆä¸€ä¸ª status.Status å¯¹è±¡ è°ƒç”¨è¯¥ status.Err æ–¹æ³•ç”Ÿæˆä¸€ä¸ªèƒ½è¢«è°ƒç”¨æ–¹è¯†åˆ«çš„errorï¼Œç„¶åè¿”å› 1 2 st := status.New(codes.NotFound, \u0026#34;some description\u0026#34;) err := st.Err() ä¼ å…¥çš„é”™è¯¯ç æ˜¯ codes.Code ç±»å‹ã€‚\næ­¤å¤–è¿˜æœ‰æ›´ä¾¿æ·çš„åŠæ³•ï¼šä½¿ç”¨ status.Errorã€‚å®ƒé¿å…äº†æ‰‹åŠ¨è½¬æ¢çš„æ“ä½œã€‚\n1 err := status.Error(codes.NotFound, \u0026#34;some description\u0026#34;) 2. è¿›é˜¶ç”¨æ³• ä¸Šé¢çš„é”™è¯¯æœ‰ä¸ªé—®é¢˜ï¼Œå°±æ˜¯ code.Code å®šä¹‰çš„é”™è¯¯ç åªæœ‰å›ºå®šçš„å‡ ç§ï¼Œæ— æ³•è¯¦å°½åœ°è¡¨è¾¾ä¸šåŠ¡ä¸­é‡åˆ°çš„é”™è¯¯åœºæ™¯ã€‚\ngRPC æä¾›äº†åœ¨é”™è¯¯ä¸­è¡¥å……ä¿¡æ¯çš„æœºåˆ¶ï¼šstatus.WithDetails æ–¹æ³•\nClient é€šè¿‡å°† error é‡æ–°è½¬æ¢ä½ status.Status ï¼Œå°±å¯ä»¥é€šè¿‡ status.Details æ–¹æ³•ç›´æ¥è·å–å…¶ä¸­çš„å†…å®¹ã€‚\nstatus.Details è¿”å›çš„æ˜¯ä¸ªsliceï¼Œ æ˜¯interface{}çš„sliceï¼Œç„¶è€Œgoå·²ç»è‡ªåŠ¨åšäº†ç±»å‹è½¬æ¢ï¼Œå¯ä»¥é€šè¿‡æ–­è¨€ç›´æ¥ä½¿ç”¨ã€‚\næœåŠ¡ç«¯ç¤ºä¾‹æœåŠ¡ç«¯ç¤ºä¾‹ ç”Ÿæˆä¸€ä¸ª status.Status å¯¹è±¡ å¡«å……é”™è¯¯çš„è¡¥å……ä¿¡æ¯ // ç”Ÿæˆä¸€ä¸ª status.Status\n1 2 3 4 5 6 7 8 9 10 11 12 func ErrorWithDetails() error { st := status.Newf(codes.Internal, fmt.Sprintf(\u0026#34;something went wrong: %v\u0026#34;, \u0026#34;api.Getter\u0026#34;)) v := \u0026amp;errdetails.PreconditionFailure_Violation{ //errDetails Type: \u0026#34;test\u0026#34;, Subject: \u0026#34;12\u0026#34;, Description: \u0026#34;32\u0026#34;, } br := \u0026amp;errdetails.PreconditionFailure{} br.Violations = append(br.Violations, v) st, _ = st.WithDetails(br) return st.Err() } å®¢æˆ·ç«¯çš„ç¤ºä¾‹ è°ƒç”¨RPCé”™è¯¯åï¼Œè§£æé”™è¯¯ä¿¡æ¯ é€šè¿‡æ–­è¨€ç›´æ¥è·å–é”™è¯¯è¯¦æƒ… 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 resp, err := odinApp.CreatePlan(cli.StaffId.AssetId, gentRatePlanMeta(cli.StaffId)) â€‹ if status.Code(err) != codes.InvalidArgument { logger.Error(\u0026#34;create plan error:%v\u0026#34;, err) } else { for _, d := range status.Convert(err).Details() { // switch info := d.(type) { case *errdetails.QuotaFailure: logger.Info(\u0026#34;Quota failure: %s\u0026#34;, info) case *errdetails.PreconditionFailure: detail := d.(*errdetails.PreconditionFailure).Violations for _, v1 := range detail { logger.Info(fmt.Sprintf(\u0026#34;details: %+v\u0026#34;, v1)) } case *errdetails.ResourceInfo: logger.Info(\u0026#34;ResourceInfo: %s\u0026#34;, info) â€‹ case *errdetails.BadRequest: logger.Info(\u0026#34;ResourceInfo: %s\u0026#34;, info) â€‹ default: logger.Info(\u0026#34;Unexpected type: %s\u0026#34;, info) } } } logger.Infof(\u0026#34;create plan success,resp=%v\u0026#34;, resp) åŸç† è¿™ä¸ªé”™è¯¯æ˜¯å¦‚ä½•ä¼ é€’ç»™è°ƒç”¨æ–¹Clientçš„å‘¢ï¼Ÿ\næ˜¯æ”¾åˆ° metadataä¸­çš„ï¼Œè€Œmetadataæ˜¯æ”¾åˆ°HTTPçš„headerä¸­çš„ã€‚\nmetadataæ˜¯keyï¼švalueæ ¼å¼çš„æ•°æ®ã€‚é”™è¯¯çš„ä¼ é€’ä¸­ï¼Œkeyæ˜¯ä¸ªå›ºå®šå€¼ï¼šgrpc-status-details-binã€‚\nè€Œvalueï¼Œæ˜¯è¢«protoç¼–ç è¿‡çš„ï¼Œæ˜¯äºŒè¿›åˆ¶å®‰å…¨çš„ã€‚\nç›®å‰å¤§å¤šæ•°è¯­è¨€éƒ½å®ç°äº†è¿™ä¸ªæœºåˆ¶ã€‚\næ³¨æ„ gRPCå¯¹å“åº”å¤´åšäº†é™åˆ¶ï¼Œä¸Šé™ä¸º8Kï¼Œæ‰€ä»¥é”™è¯¯ä¸èƒ½å¤ªå¤§ã€‚\nå‚è€ƒèµ„æ–™\nhttps://protobuf.dev/getting-started/gotutorial/\nhttps://pkg.go.dev/google.golang.org/genproto/googleapis/rpc/errdetails ","date":"2024-06-29T21:38:00Z","permalink":"https://huizhou92.com/zh-cn/p/go-action-error-handling-in-grpc/","title":"gRPCä¸­çš„é”™è¯¯å¤„ç†"},{"content":"gRPC æ˜¯Googleå¼€å‘çš„ä¸€ä¸ªé«˜æ€§èƒ½RPCæ¡†æ¶ï¼ŒgRPC é»˜è®¤å†…ç½®äº†ä¸¤ç§è®¤è¯æ–¹å¼ï¼š\nSSL/TLS è®¤è¯æ–¹å¼ åŸºäº Token çš„è®¤è¯æ–¹å¼\næ²¡æœ‰å¯ç”¨è¯ä¹¦çš„gRPCæœåŠ¡å’Œå®¢æˆ·ç«¯è¿›è¡Œçš„æ˜¯æ˜æ–‡é€šä¿¡ï¼Œä¿¡æ¯é¢ä¸´è¢«ä»»ä½•ç¬¬ä¸‰æ–¹ç›‘å¬çš„é£é™©ã€‚ä¸ºäº†ä¿è¯gRPCé€šä¿¡ä¸è¢«ç¬¬ä¸‰æ–¹ç›‘å¬ã€ç¯¡æ”¹æˆ–ä¼ªé€ ï¼Œå¯ä»¥å¯¹æœåŠ¡å™¨å¯åŠ¨TLSåŠ å¯†ç‰¹æ€§ã€‚\nä» go 1.15 ç‰ˆæœ¬å¼€å§‹åºŸå¼ƒ CommonNameï¼Œå› æ­¤æ¨èä½¿ç”¨ SAN è¯ä¹¦ã€‚å¦‚æœæŒ‰ç…§ä¹‹å‰çš„æ­¥éª¤é€šè¿‡ OpenSSL æ¥ç”Ÿæˆå¯†é’¥ã€CSRã€è¯ä¹¦ï¼Œä¼šå‡ºç°è¿™æ ·çš„é”™è¯¯ï¼š This article was first published in the Medium MPP plan. If you are a Medium user, please follow me on Medium. Thank you very much.\n1 rpc error: code = Unavailable desc = connection error: desc = \u0026#34;transport: authentication handshake failed: x509: certificate relies on legacy Common Name field, use SANs instead\u0026#34;| ä»€ä¹ˆæ˜¯SAN SAN(Subject Alternative Name) æ˜¯Â SSLÂ æ ‡å‡†Â x509Â ä¸­å®šä¹‰çš„ä¸€ä¸ªæ‰©å±•ã€‚ä½¿ç”¨äº†Â SANÂ å­—æ®µçš„Â SSLÂ è¯ä¹¦ï¼Œå¯ä»¥æ‰©å±•æ­¤è¯ä¹¦æ”¯æŒçš„åŸŸåï¼Œä½¿å¾—ä¸€ä¸ªè¯ä¹¦å¯ä»¥æ”¯æŒå¤šä¸ªä¸åŒåŸŸåçš„è§£æã€‚\né€šä¿—ç‚¹å°±æ˜¯ï¼Œåœ¨ SAN è¯ä¹¦ä¸­ï¼Œå¯ä»¥æœ‰å¤šä¸ªå®Œæ•´çš„ CNï¼ˆCommonNameï¼‰ï¼Œè¿™æ ·åªéœ€è¦è´­ä¹°ä¸€ä¸ªè¯ä¹¦å°±å¯ä»¥ç”¨åœ¨å¤šä¸ª URLã€‚æ¯”å¦‚ skype.com çš„è¯ä¹¦ï¼Œå®ƒå°±æœ‰å¾ˆå¤š SANã€‚\nåœ¨æœ¬åœ°åˆ›å»ºSAN è¯ä¹¦ ä¸‹é¢ æˆ‘ä»¬å°†ç”¨ä¸€ä¸ªä¾‹å­åœ¨æœ¬åœ°ç”Ÿæˆ å®¢æˆ·ç«¯\u0026amp;æœåŠ¡ç«¯åŒå‘SAN è¯ä¹¦ã€‚\nå‡è®¾gRPCæœåŠ¡ç«¯çš„ä¸»æœºåä¸ºlocalhostï¼Œéœ€è¦ä¸ºgRPCæœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ä¹‹é—´çš„é€šä¿¡é…ç½®tlsåŒå‘è®¤è¯åŠ å¯†ã€‚\næ–°å»º openssl.conf æ¥æ”¾ç›¸å…³ä¿¡æ¯ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 [req] req_extensions = v3_req distinguished_name = req_distinguished_name prompt = no [req_distinguished_name] countryName = CN stateOrProvinceName = state localityName = city organizationName = huizhou92 commonName = hello-world [v3_req] subjectAltName = @alt_names [alt_names] DNS.1 = localhost å…¶ä¸­å†…å®¹ è·Ÿ ä»¥å‰åˆ›å»ºcaçš„æ—¶å€™å·®ä¸å¤šã€‚\n2. ç”Ÿæˆcaæ ¹è¯ä¹¦\n1 openssl req -x509 -newkey rsa:4096 -keyout ca.key -out ca.crt -subj \u0026#34;/CN=localhost\u0026#34; -days 3650 -nodes -nodes æ˜¯å¿½ç•¥å¯†ç ,æ–¹ä¾¿ä½¿ç”¨ï¼Œä½†æ˜¯è¯·æ³¨æ„ï¼Œè¿™å¯èƒ½ä¼šé™ä½ç§é’¥çš„å®‰å…¨æ€§ï¼Œå› ä¸ºä»»ä½•äººéƒ½å¯ä»¥è¯»å–æœªåŠ å¯†çš„ç§é’¥ã€‚\n3. ç”ŸæˆæœåŠ¡ç«¯è¯ä¹¦\n1 2 openssl req -newkey rsa:2048 -nodes -keyout server.key -out server.csr -subj \u0026#34;/CN=localhost\u0026#34; -config openssl.cnf openssl x509 -req -in server.csr -out server.crt -CA ca.crt -CAkey ca.key -CAcreateserial -days 365 -extensions v3_req -extfile openssl.cnf ç”Ÿæˆå®¢æˆ·ç«¯è¯ä¹¦ 1 2 3 openssl req -newkey rsa:2048 -nodes -keyout client.key -out client.csr -subj \u0026#34;/CN=localhost\u0026#34; -config openssl.cnf openssl x509 -req -in client.csr -out client.crt -CA ca.crt -CAkey ca.key -CAcreateserial -days 365 -extensions v3_req -extfile openssl.cnf æœ€ç»ˆç”Ÿæˆçš„ç»“æœå¦‚ä¸‹\n1 2 âœ keys git:(day1) âœ— ls ca.crt ca.key ca.srl client.crt client.csr client.key openssl.cnf server.crt server.csr server.key æµ‹è¯• æˆ‘ä»¬å®šä¹‰ä¸€ä¸ªæœ€ç®€å•çš„grpcæ¥å£\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 // helloworld.proto syntax = \u0026#34;proto3\u0026#34;; option go_package = \u0026#34;./api;api\u0026#34;; package api; // The greeting service definition. service Greeter { // Sends a greeting rpc SayHello (HelloRequest) returns (HelloReply) {} } // The request message containing the user\u0026#39;s name. message HelloRequest { string name = 1; } // The response message containing the greetings message HelloReply { string message = 1; } æœåŠ¡ç«¯å®ç° 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 package main import ( \u0026#34;context\u0026#34; \u0026#34;crypto/tls\u0026#34; \u0026#34;crypto/x509\u0026#34; \u0026#34;fmt\u0026#34; \u0026#34;google.golang.org/genproto/googleapis/rpc/errdetails\u0026#34; \u0026#34;google.golang.org/grpc\u0026#34; \u0026#34;google.golang.org/grpc/codes\u0026#34; \u0026#34;google.golang.org/grpc/credentials\u0026#34; \u0026#34;google.golang.org/grpc/status\u0026#34; \u0026#34;hello-world/api\u0026#34; \u0026#34;io\u0026#34; \u0026#34;log\u0026#34; \u0026#34;net\u0026#34; \u0026#34;os\u0026#34; \u0026#34;time\u0026#34; ) type server struct { api.UnimplementedGreeterServer } func (s *server) SayHello(ctx context.Context, in *api.HelloRequest) (*api.HelloReply, error) { log.Printf(\u0026#34;Received: %v\u0026#34;, in.GetName()) select { case \u0026lt;-ctx.Done(): log.Println(\u0026#34;client timeout return\u0026#34;) return nil, ErrorWithDetails() case \u0026lt;-time.After(3 * time.Second): return \u0026amp;api.HelloReply{Message: \u0026#34;Hello \u0026#34; + in.GetName()}, nil } } func main() { certificate, err := tls.LoadX509KeyPair(\u0026#34;./keys/server.crt\u0026#34;, \u0026#34;./keys/server.key\u0026#34;) if err != nil { log.Fatalf(\u0026#34;Failed to load key pair: %v\u0026#34;, err) } // é€šè¿‡CAåˆ›å»ºè¯ä¹¦æ±  certPool := x509.NewCertPool() ca, err := os.ReadFile(\u0026#34;./keys/ca.crt\u0026#34;) if err != nil { log.Fatalf(\u0026#34;Failed to read ca: %v\u0026#34;, err) } // å°†æ¥è‡ªCAçš„å®¢æˆ·ç«¯è¯ä¹¦é™„åŠ åˆ°è¯ä¹¦æ±  if ok := certPool.AppendCertsFromPEM(ca); !ok { log.Fatalf(\u0026#34;Failed to append ca certificate\u0026#34;) } opts := []grpc.ServerOption{ grpc.Creds( // ä¸ºæ‰€æœ‰ä¼ å…¥çš„è¿æ¥å¯ç”¨TLS credentials.NewTLS(\u0026amp;tls.Config{ ClientAuth: tls.RequireAndVerifyClientCert, Certificates: []tls.Certificate{certificate}, ClientCAs: certPool, }, )), } listen, err := net.Listen(\u0026#34;tcp\u0026#34;, fmt.Sprintf(\u0026#34;0.0.0.0:%d\u0026#34;, 50051)) if err != nil { log.Fatalf(\u0026#34;failed to listen %d port\u0026#34;, 50051) } // é€šè¿‡ä¼ å…¥çš„TLSæœåŠ¡å™¨å‡­è¯åˆ›å»ºæ–°çš„gRPCæœåŠ¡å®ä¾‹ s := grpc.NewServer(opts...) api.RegisterGreeterServer(s, \u0026amp;server{}) log.Printf(\u0026#34;server listening at %v\u0026#34;, listen.Addr()) if err := s.Serve(listen); err != nil { log.Fatalf(\u0026#34;Failed to serve: %v\u0026#34;, err) } } func ErrorWithDetails() error { st := status.Newf(codes.Internal, fmt.Sprintf(\u0026#34;something went wrong: %v\u0026#34;, \u0026#34;api.Getter\u0026#34;)) v := \u0026amp;errdetails.PreconditionFailure_Violation{ //errDetails Type: \u0026#34;test\u0026#34;, Subject: \u0026#34;12\u0026#34;, Description: \u0026#34;32\u0026#34;, } br := \u0026amp;errdetails.PreconditionFailure{} br.Violations = append(br.Violations, v) st, _ = st.WithDetails(br) return st.Err() } æˆ‘ä»¬ç›´æ¥è¿è¡ŒæœåŠ¡ç«¯ go run main.go\nå®¢æˆ·ç«¯ é¦–å…ˆæˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªä¸å¸¦è¯ä¹¦çš„è¯·æ±‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 func Test_server_SayHello_No_Cert(t *testing.T) { conn, err := grpc.Dial(\u0026#34;localhost:50051\u0026#34;, grpc.WithTransportCredentials(insecure.NewCredentials())) if err != nil { log.Fatalf(\u0026#34;Connect to %s failed\u0026#34;, \u0026#34;localhost:50051\u0026#34;) } defer conn.Close() client := api.NewGreeterClient(conn) // åˆ›å»ºå¸¦æœ‰è¶…æ—¶æ—¶é—´çš„ä¸Šä¸‹æ–‡, cancelå¯ä»¥å–æ¶ˆä¸Šä¸‹æ–‡ ctx, cancel := context.WithTimeout(context.Background(), time.Second*5) defer cancel() // ä¸šåŠ¡ä»£ç å¤„ç†éƒ¨åˆ† ... r, err := client.SayHello(ctx, \u0026amp;api.HelloRequest{Name: \u0026#34;Hello\u0026#34;}) if err != nil { log.Printf(\u0026#34;Failed to greet, error: %v\u0026#34;, err) } else { log.Printf(\u0026#34;Greeting: %v\u0026#34;, r.GetMessage()) } // Set up a connection to the server. log.Printf(\u0026#34;Greeting: %s\u0026#34;, r.GetMessage()) } è¾“å‡º\n1 2024/05/12 19:18:51 Failed to greet, error: rpc error: code = Unavailable desc = connection error: desc = \u0026#34;error reading server preface: EOF\u0026#34; æœåŠ¡ä¸å¯ç”¨\næˆ‘ä»¬å†ä½¿ç”¨ä¸€ä¸ªæºå¸¦è¯ä¹¦çš„è¯·è¯·æ±‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 func Test_server_SayHello(t *testing.T) { certificate, err := tls.LoadX509KeyPair(\u0026#34;./keys/client.crt\u0026#34;, \u0026#34;./keys/client.key\u0026#34;) if err != nil { log.Fatalf(\u0026#34;Failed to load client key pair, %v\u0026#34;, err) } certPool := x509.NewCertPool() ca, err := os.ReadFile(\u0026#34;./keys/ca.crt\u0026#34;) if err != nil { log.Fatalf(\u0026#34;Failed to read %s, error: %v\u0026#34;, \u0026#34;./keys/ca.crt\u0026#34;, err) } if ok := certPool.AppendCertsFromPEM(ca); !ok { log.Fatalf(\u0026#34;Failed to append ca certs\u0026#34;) } opts := []grpc.DialOption{ grpc.WithTransportCredentials(credentials.NewTLS( \u0026amp;tls.Config{ ServerName: \u0026#34;localhost\u0026#34;, Certificates: []tls.Certificate{certificate}, RootCAs: certPool, })), } // conn, err := grpc.Dial(*addr, grpc.WithTransportCredentials(insecure.NewCredentials())) conn, err := grpc.Dial(\u0026#34;localhost:50051\u0026#34;, opts...) if err != nil { log.Fatalf(\u0026#34;Connect to %s failed\u0026#34;, \u0026#34;localhost:50051\u0026#34;) } defer conn.Close() client := api.NewGreeterClient(conn) // åˆ›å»ºå¸¦æœ‰è¶…æ—¶æ—¶é—´çš„ä¸Šä¸‹æ–‡, cancelå¯ä»¥å–æ¶ˆä¸Šä¸‹æ–‡ ctx, cancel := context.WithTimeout(context.Background(), time.Second*5) defer cancel() // ä¸šåŠ¡ä»£ç å¤„ç†éƒ¨åˆ† ... r, err := client.SayHello(ctx, \u0026amp;api.HelloRequest{Name: \u0026#34;Hello\u0026#34;}) if err != nil { log.Printf(\u0026#34;Failed to greet, error: %v\u0026#34;, err) } else { log.Printf(\u0026#34;Greeting: %v\u0026#34;, r.GetMessage()) } // Set up a connection to the server. log.Printf(\u0026#34;Greeting: %s\u0026#34;, r.GetMessage()) } è¾“å‡º\n1 2 === RUN Test_server_SayHello 2024/05/12 19:20:17 Greeting: Hello Hello æ€»ç»“\næˆ‘ä»¬å¯ä»¥ä½¿ç”¨tlså®ç°gRPC çš„åŠ å¯†é€šä¿¡ï¼Œ ä»go1.15 å¼€å§‹ï¼Œgoä¸å»ºè®®ä½¿ç”¨CAè€Œæ˜¯ä½¿ç”¨SANè¯ä¹¦ ","date":"2024-06-29T21:41:50+08:00","image":"https://images.yixiao9206.cn/blog-images/2024/05/4976a194a8daca00ff6991a866c2ee53.png","permalink":"https://huizhou92.com/zh-cn/p/grpc-%E4%BD%BF%E7%94%A8%E8%87%AA%E7%AD%BE%E5%90%8D%E8%AF%81%E4%B9%A6san%E5%BB%BA%E7%AB%8Btls-%E8%BF%9E%E6%8E%A5.zh-cn/","title":"gRPC ä½¿ç”¨è‡ªç­¾åè¯ä¹¦SANå»ºç«‹TLS è¿æ¥.zh-cn"},{"content":"ç½‘é¡µè®¾è®¡å’Œå¼€å‘æ˜¯ä¸€ä¸ªä¸æ–­è¿›åŒ–çš„é¢†åŸŸï¼Œè®¾è®¡å¸ˆå’Œå‰ç«¯å¼€å‘è€…ä»¬ç»å¸¸é¢ä¸´ä¸€ä¸ªå…±åŒçš„æŒ‘æˆ˜ï¼šå¦‚ä½•å¿«é€Ÿã€é«˜æ•ˆåœ°å°†æ¦‚å¿µåŒ–çš„è®¾è®¡è‰å›¾è½¬åŒ–ä¸ºå®é™…å¯ç”¨çš„ HTML ä»£ç ã€‚è¿™ä¸€è¿‡ç¨‹ä¸ä»…è€—æ—¶è€Œä¸”å®¹æ˜“å‡ºé”™ï¼Œå°¤å…¶æ˜¯åœ¨å°†å¤æ‚çš„è®¾è®¡æƒ³æ³•å…·ä½“å®ç°æ—¶ã€‚åœ¨åˆæ­¥è®¾è®¡é˜¶æ®µï¼Œå¾€å¾€éœ€è¦é¢‘ç¹åœ°ä¿®æ”¹å’Œè°ƒæ•´ï¼Œå¦‚æœæ¯ä¸€æ¬¡ä¿®æ”¹éƒ½éœ€è¦æ‰‹åŠ¨ç¼–å†™ä»£ç ï¼Œæ— ç–‘ä¼šå¤§å¤§æ‹–æ…¢é¡¹ç›®çš„è¿›åº¦ï¼Œå¢åŠ é¡¹ç›®æˆæœ¬ã€‚\nThis article is first published in the medium MPP plan. If you are a medium user, please follow me in medium. Thank you very much.\nç›®å‰æˆ‘ä»¬æˆ‘ä»¬æœ‰ä¸¤ç§åŠæ³•è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œç¬¬ä¸€ç§æ˜¯ä½ä»£ç æ¨¡å¼ï¼Œç¬¬äºŒç§æ˜¯ä½¿ç”¨AIã€‚æˆ‘ä¸ªäººè®¤ä¸ºï¼ŒAiå°†ä¼šåˆå¹¶ä½ä»£ç æ¨¡å¼ï¼Œç›®å‰å·²ç»æœ‰å¾ˆå¤šå•†ä¸šå…¬å¸åœ¨åšè¿™ä»¶äº‹æƒ…äº†ï¼Œä»Šå¤©çš„ä¸»è§’æ˜¯ä¸€ä¸ªåœ¨GitHubä¸Šæœ‰ä¸€ä¸ªè¶…è¿‡13k star çš„é¡¹ç›®â draw-a-ui å®ƒæ˜¯è¿™æ ·æè¿°è‡ªå·±çš„\nDraw a mockup and generate html for it\ndraw-a-ui å®ƒæ˜¯åŸºäº tldraw å’Œ gpt-4-vision apiï¼Œæ—¨åœ¨é€šè¿‡ç”¨æˆ·ç»˜åˆ¶çš„çº¿æ¡†å›¾è‡ªåŠ¨ç”Ÿæˆ HTML ä»£ç ã€‚ç”¨æˆ·åªéœ€ç»˜åˆ¶ä¸€ä¸ªæ¨¡æ‹Ÿç•Œé¢çš„è‰å›¾ï¼Œdraw-a-uiÂ å°±èƒ½å°†å…¶è½¬æ¢ä¸ºé…å¤‡ Tailwind CSS çš„ HTML æ–‡ä»¶ï¼Œæå¤§ç¼©çŸ­ä»è®¾è®¡åˆ°å¼€å‘çš„æ—¶é—´ã€‚é¡¹ç›®ç›®å‰å°šå¤„äºå¼€å‘é˜¶æ®µï¼Œä½†æ ¸å¿ƒåŠŸèƒ½â€”â€”å°†ç»˜å›¾ç”»å¸ƒçš„ SVG è½¬æ¢ä¸º PNGï¼Œå†å°†è¯¥ PNG ä¼ é€ç»™ gpt-4-vision ä»¥æŒ‡ä»¤å½¢å¼è¿”å›å•ä¸ª HTML æ–‡ä»¶â€”â€”å·²ç»å®Œå–„ã€‚\nä½¿ç”¨è¿™ä¸ªé¡¹ç›®å¾ˆç®€å•ï¼Œ å…‹éš†ä¸‹æ¥ï¼Œç„¶åé…ç½®ä¸€ä¸‹ä½ çš„openai keyå°±å¥½\n1 2 3 echoÂ \u0026#34;OPENAI_API_KEY=sk-your-key\u0026#34;Â \u0026gt;Â .env.local npmÂ install npmÂ runÂ dev ç„¶åä½ å°±èƒ½ é€šè¿‡ http://localhost:3000 è®¿é—®äº†ã€‚\nhttps://github.com/SawyerHood/draw-a-ui/blob/main/demo.gif\nå®ƒæ”¯æŒåœ¨çº¿è®¾è®¡ï¼Œä¹Ÿæ”¯æŒä¸Šä¼ png å›¾åƒ, æ¯”å¦‚æˆ‘å°† medium ä¸»é¡µæˆªå›¾ï¼Œç„¶åä¸Šä¼ ä¸Šå»ã€‚ç­‰å¾…20s å·¦å³ï¼ˆå½•å±æœ‰åŠ é€Ÿï¼‰,æˆ‘ä»¬å°±èƒ½å¾—åˆ°ç»“æœã€‚\nå°½ç®¡ç›®å‰ draw-a-ui é¡¹ç›®æ ‡æ³¨ä¸ºæ¼”ç¤ºç”¨é€”ï¼Œå¹¶ä¸å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ç›´æ¥ä½¿ç”¨ï¼Œç›®å‰çœ‹æ¥ç”Ÿæˆçš„ä½†å…¶èƒŒåçš„ç†å¿µå’ŒæŠ€æœ¯å®ç°æ— ç–‘å±•ç°äº†æœªæ¥å¼€å‘çš„è¶‹åŠ¿ã€‚è¯¥é¡¹ç›®åˆ©ç”¨æœ€æ–°çš„äººå·¥æ™ºèƒ½æŠ€æœ¯ï¼ˆå¦‚ GPT-4ï¼‰ï¼Œä¸ºå‰ç«¯å¼€å‘å¸¦æ¥äº†é©å‘½æ€§çš„å·¥ä½œæ¨¡å¼æ”¹å˜ã€‚\næˆ‘çœŸçš„å¾ˆæœŸå¾…è¿™ä¸ªæŠ€æœ¯ï¼Œæ¯•ç«Ÿæˆ‘è®¨åŒå†™cssã€‚ğŸ¶\n","date":"2024-06-26T18:21:43+08:00","permalink":"https://huizhou92.com/zh-cn/p/%E8%AE%BE%E8%AE%A1%E7%A8%BF%E7%94%9F%E6%88%90%E4%BB%A3%E7%A0%81web%E5%BC%80%E5%8F%91%E7%9A%84%E6%9C%AA%E6%9D%A5/","title":"è®¾è®¡ç¨¿ç”Ÿæˆä»£ç ï¼Œwebå¼€å‘çš„æœªæ¥ï¼Ÿ"},{"content":"ä»€ä¹ˆæ˜¯ ä¸€è‡´æ€§hash ç®—æ³• é¦–å…ˆæ‘˜æŠ„ä¸€æ®µç»´åŸºç™¾ç§‘çš„å®šä¹‰\nä¸€è‡´å“ˆå¸Œ æ˜¯ä¸€ç§ç‰¹æ®Šçš„å“ˆå¸Œç®—æ³•ã€‚åœ¨ä½¿ç”¨ä¸€è‡´å“ˆå¸Œç®—æ³•åï¼Œå“ˆå¸Œè¡¨æ§½ä½æ•°ï¼ˆå¤§å°ï¼‰çš„æ”¹å˜å¹³å‡åªéœ€è¦å¯¹ğ¾/ğ‘› ä¸ªå…³é”®å­—é‡æ–°æ˜ å°„ï¼Œå…¶ä¸­ ğ¾ æ˜¯å…³é”®å­—çš„æ•°é‡ï¼Œğ‘›æ˜¯æ§½ä½æ•°é‡ã€‚ç„¶è€Œåœ¨ä¼ ç»Ÿçš„å“ˆå¸Œè¡¨ä¸­ï¼Œæ·»åŠ æˆ–åˆ é™¤ä¸€ä¸ªæ§½ä½çš„å‡ ä¹éœ€è¦å¯¹æ‰€æœ‰å…³é”®å­—è¿›è¡Œé‡æ–°æ˜ å°„ã€‚ \u0026mdash; wikipedia\nåˆ†å¸ƒå¼ç³»ç»Ÿä¸­, ä¸€è‡´æ€§hashæ— å¤„ä¸åœ¨ï¼ŒCDNï¼ŒKVï¼Œè´Ÿè½½å‡è¡¡ç­‰åœ°æ–¹éƒ½æœ‰å®ƒçš„å½±å­ï¼Œæ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿçš„åŸºçŸ³ç®—æ³•ä¹‹ä¸€ã€‚ä¸€è‡´æ€§hash æœ‰ä»¥ä¸‹å‡ ä¸ªä¼˜ç‚¹ã€‚\nå‡è¡¡è´Ÿè½½ï¼š ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•èƒ½å¤Ÿå°†æ•°æ®åœ¨èŠ‚ç‚¹ä¸Šå‡åŒ€åˆ†å¸ƒã€‚ æ‰©å±•æ€§ï¼š åœ¨ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•ä¸­ï¼Œå½“èŠ‚ç‚¹æ•°é‡å¢åŠ æˆ–å‡å°‘æ—¶ï¼Œåªæœ‰éƒ¨åˆ†æ•°æ®éœ€è¦é‡æ–°æ˜ å°„ï¼Œç³»ç»Ÿèƒ½å¤Ÿè¿›è¡Œæ°´å¹³æ‰©å±•æ›´å®¹æ˜“ï¼Œå¯ä»¥å¢åŠ èŠ‚ç‚¹æ•°é‡ä»¥åº”å¯¹æ›´å¤§çš„è´Ÿè½½éœ€æ±‚ï¼› å‡å°‘æ•°æ®è¿ç§»ï¼š ç›¸æ¯”ä¼ ç»Ÿçš„å“ˆå¸Œç®—æ³•ï¼Œä¸€è‡´æ€§å“ˆå¸Œç®—æ³•åœ¨èŠ‚ç‚¹å¢å‡æ—¶éœ€è¦é‡æ–°æ˜ å°„çš„æ•°æ®é‡è¾ƒå°‘ï¼Œå¯ä»¥å¤§å¹…é™ä½æ•°æ®è¿ç§»çš„å¼€é”€ï¼Œå‡å°‘ç³»ç»Ÿçš„ä¸ç¨³å®šæ€§å’Œå»¶è¿Ÿï¼›\næœ¬ç¯‡æ–‡ç« çš„ç›®æ ‡å°±æ˜¯å­¦ä¹ ä¸€è‡´æ€§hash ç®—æ³•ä»¥åŠå®ƒçš„ç®€å•å®ç°ã€‚ This article is first published in the medium MPP plan. If you are a medium user, please follow me in medium. Thank you very much.\nä¸€è‡´æ€§hashç®—æ³•çš„åŸç† åŸºæœ¬ä¸€è‡´æ€§hash ç®—æ³• æœ€åŸºç¡€çš„ä¸€è‡´æ€§ hash ç®—æ³•å°±æ˜¯æŠŠèŠ‚ç‚¹ç›´æ¥åˆ†å¸ƒåˆ°ç¯ä¸Šï¼Œä»è€Œåˆ’åˆ†å‡ºå€¼åŸŸï¼Œ key ç»è¿‡Â hash( x )Â ä¹‹åï¼Œè½åˆ°ä¸åŒçš„å€¼åŸŸï¼Œåˆ™ç”±å¯¹åº”çš„èŠ‚ç‚¹å¤„ç†ã€‚æœ€å¸¸è§çš„å€¼åŸŸç©ºé—´å¤§å°æ˜¯ï¼š2^32 - 1ï¼ŒèŠ‚ç‚¹è½åˆ°è¿™ä¸ªç©ºé—´ï¼Œæ¥åˆ’åˆ†ä¸åŒèŠ‚ç‚¹æ‰€å±çš„å€¼åŸŸã€‚å¦‚å›¾æ‰€ç¤ºã€‚\nNode A å­˜å‚¨ çš„ hash èŒƒå›´ä¸º [0,2^12) .\nNode B å­˜å‚¨ çš„ hash èŒƒå›´ä¸º [2^12,2^28) .\nNode C å­˜å‚¨ çš„ hash èŒƒå›´ä¸º [2^28,0) .\nä¸Šè¿°åŸºæœ¬çš„ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•æœ‰æ˜æ˜¾çš„ç¼ºç‚¹ï¼š\néšæœºåˆ†å¸ƒèŠ‚ç‚¹çš„æ–¹å¼ä½¿å¾—å¾ˆéš¾å‡åŒ€çš„åˆ†å¸ƒå“ˆå¸Œå€¼åŸŸï¼Œä»ä¸Šé¢å¯ä»¥çœ‹å‡ºï¼Œä¸‰ä¸ªèŠ‚ç‚¹å­˜å‚¨çš„æ•°æ®ä¸å‡åŒ€ã€‚ åœ¨åŠ¨æ€å¢åŠ èŠ‚ç‚¹åï¼ŒåŸå…ˆçš„åˆ†å¸ƒå°±ç®—å‡åŒ€ä¹Ÿå¾ˆéš¾å†ç»§ç»­ä¿è¯å‡åŒ€ï¼› å¢åˆ èŠ‚ç‚¹å¸¦æ¥çš„ä¸€ä¸ªè¾ƒä¸ºä¸¥é‡çš„ç¼ºç‚¹æ˜¯ï¼š å½“ä¸€ä¸ªèŠ‚ç‚¹å¼‚å¸¸æ—¶ï¼Œè¯¥èŠ‚ç‚¹çš„å‹åŠ›å…¨éƒ¨è½¬ç§»åˆ°ç›¸é‚»çš„ä¸€ä¸ªèŠ‚ç‚¹ï¼› å½“ä¸€ä¸ªæ–°èŠ‚ç‚¹åŠ å…¥æ—¶åªèƒ½ä¸ºä¸€ä¸ªç›¸é‚»èŠ‚ç‚¹åˆ†æ‘Šå‹åŠ›ï¼› è™šæ‹ŸèŠ‚ç‚¹ Goè¯­è¨€ä¹‹çˆ¶ rob pike æ›¾ä»Šè¯´è¿‡ è®¡ç®—æœºé¢†åŸŸé‡Œï¼Œæ²¡æœ‰ä»€ä¹ˆé—®é¢˜æ˜¯åŠ ä¸€å±‚é—´æ¥å¯»å€è§£å†³ä¸äº†çš„. ä¸€è‡´æ€§hash ä¹Ÿæ˜¯ä¸€æ ·ã€‚\nå¦‚æœä¸‰ä¸ªèŠ‚ç‚¹ å­˜åœ¨ä¸å‡è¡¡çš„é—®é¢˜ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±æŠŠä»–è™šæ‹ŸæˆNä¸ªèŠ‚ç‚¹ã€‚A[a1,a2\u0026hellip;.a1024], ç„¶åå°†ä»–ä»¬æ˜ å°„åˆ°hash_ring ä¸Šï¼Œå°±æ˜¯è¿™æ ·æ ·å­çš„ã€‚\næ¯ä¸ªè™šæ‹ŸèŠ‚ç‚¹éƒ½æœ‰å¯¹åº”çš„hashåŒºé—´ã€‚è´Ÿè´£ä¸€æ®µkeyï¼Œç„¶åæ ¹æ®è™šæ‹Ÿnode çš„åå­—æ‰¾åˆ°å¯¹åº”çš„ç‰©ç†nodeè¯»å†™æ•°æ®ã€‚\nå¼•å…¥è™šæ‹ŸèŠ‚ç‚¹åï¼Œå°±å®Œç¾çš„è§£å†³äº†ä¸Šé¢çš„ä¸‰ä¸ªé—®é¢˜ã€‚\nåªè¦æˆ‘ä»¬çš„è™šæ‹ŸèŠ‚ç‚¹è¶³å¤Ÿå¤šï¼Œå„ä¸ªèŠ‚ç‚¹çš„æ•°æ®å°±èƒ½å¹³è¡¡ï¼Œï¼ˆâš ï¸ï¼šè¿™ä¸ªå†å·¥ç¨‹ä¸Šæ˜¯æœ‰ä»£ä»·çš„ï¼‰ å¦‚æœä¸€ä¸ªèŠ‚ç‚¹å®•æœºäº†ï¼Œå®ƒçš„æ•°æ®ä¼šå‡è¡¡çš„åˆ†å¸ƒåˆ°æ•´ä¸ªé›†ç¾¤æ‰€æœ‰èŠ‚ç‚¹ï¼ŒåŒç†ï¼Œæ–°å¢çš„èŠ‚ç‚¹ ä¹Ÿèƒ½è´Ÿæ‹…æ‰€æœ‰èŠ‚ç‚¹çš„å‹åŠ›ã€‚ goè¯­è¨€å®ç° å®Œæ•´çš„ä»£ç ï¼šhttps://github.com/hxzhouh/blog-example/tree/main/Distributed/consistent_hashing\né¦–å…ˆå®šä¹‰ä¸€ä¸ªhash_ring, ä½¿ç”¨ crc32.ChecksumIEEE ä½œä¸ºé»˜è®¤çš„hash function\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 type VirtualNode struct { // è™šæ‹ŸèŠ‚ç‚¹ Hash uint32 Node *Node } type Node struct { // ç‰©ç†èŠ‚ç‚¹ ID string Addr string } type HashRing struct { Nodes map[string]*Node VirtualNodes []VirtualNode. mu sync.Mutex hash HashFunc } func NewHashRing(hash HashFunc) *HashRing { if hash == nil { hash = crc32.ChecksumIEEE } return \u0026amp;HashRing{ Nodes: make(map[string]*Node), VirtualNodes: make([]VirtualNode, 0), hash: hash, } } æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹æ€ä¹ˆæ·»åŠ èŠ‚ç‚¹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 func (hr *HashRing) AddNode(node *Node) { hr.mu.Lock() defer hr.mu.Unlock() hr.Nodes[node.ID] = node for i := 0; i \u0026lt; VirtualNodesPerNode; i++ { virtualNodeID := fmt.Sprintf(\u0026#34;%s-%d\u0026#34;, node.ID, i) hash := hr.hash([]byte(virtualNodeID)) hr.VirtualNodes = append(hr.VirtualNodes, VirtualNode{Hash: hash, Node: node}) } sort.Slice(hr.VirtualNodes, func(i, j int) bool { return hr.VirtualNodes[i].Hash \u0026lt; hr.VirtualNodes[j].Hash }) } æˆ‘ä»¬æ¯æ·»åŠ ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå°±è¦åˆ›å»ºå¯¹åº”æ•°é‡çš„è™šæ‹ŸèŠ‚ç‚¹ï¼Œå¹¶ä¸”è¦ä¿è¯è™šæ‹ŸèŠ‚ç‚¹æœ‰åºï¼ˆè¿™æ ·æ‰èƒ½æŸ¥æ‰¾ï¼‰\nåŒæ ·ï¼Œremove çš„æ—¶å€™ï¼Œä¹Ÿéœ€è¦åˆ é™¤è™šæ‹ŸèŠ‚ç‚¹\n1 2 3 4 5 6 7 8 9 10 11 12 13 func (hr *HashRing) RemoveNode(nodeID string) { hr.mu.Lock() defer hr.mu.Unlock() delete(hr.Nodes, nodeID) virtualNodes := make([]VirtualNode, 0) for _, vn := range hr.VirtualNodes { if vn.Node.ID != nodeID { virtualNodes = append(virtualNodes, vn) } } hr.VirtualNodes = virtualNodes } æŸ¥è¯¢çš„æ—¶å€™ï¼Œæˆ‘ä»¬å…ˆæ‰¾åˆ°å¯¹åº”çš„è™šæ‹ŸèŠ‚ç‚¹ï¼Œç„¶åå†æ ¹æ®è™šæ‹ŸèŠ‚ç‚¹æ‰¾åˆ°å¯¹åº”çš„ç‰©ç†èŠ‚ç‚¹\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 func (hr *HashRing) GetNode(key string) *Node { hr.mu.Lock() defer hr.mu.Unlock() if len(hr.VirtualNodes) == 0 { return nil } hash := hr.hash([]byte(key)) idx := sort.Search(len(hr.VirtualNodes), func(i int) bool { return hr.VirtualNodes[i].Hash \u0026gt;= hash }) if idx == len(hr.VirtualNodes) { idx = 0 } return hr.VirtualNodes[idx].Node } æœ€åæˆ‘ä»¬æ¥çœ‹çœ‹ï¼Œä¸šåŠ¡å¦‚ä½•ä½¿ç”¨ è¿™ä¸ªhash_ring\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 type KVSystem struct { hashRing *HashRing kvStores map[string]*kvstorage.KVStore } func NewKVSystem(nodes int) *KVSystem { hashRing := NewHashRing(crc32.ChecksumIEEE) for i := 0; i \u0026lt; nodes; i++ { // init node node := \u0026amp;Node{ ID: fmt.Sprintf(\u0026#34;Node%d\u0026#34;, i), Addr: fmt.Sprintf(\u0026#34;192.168.1.%d\u0026#34;, i+1), } hashRing.AddNode(node) } kvStores := make(map[string]*kvstorage.KVStore) //init storage for id := range hashRing.Nodes { kvStores[id] = kvstorage.NewKVStore() } return \u0026amp;KVSystem{ hashRing: hashRing, kvStores: kvStores, } } func (kv *KVSystem) Get(key string) (string, bool) { //get value node := kv.hashRing.GetNode(key) return kv.kvStores[node.ID].Get(key) } func (kv *KVSystem) Set(key string, value string) { // set value node := kv.hashRing.GetNode(key) kv.kvStores[node.ID].Set(key, value) } func (kv *KVSystem) Delete(key string) { node := kv.hashRing.GetNode(key) kv.kvStores[node.ID].Delete(key) } // DeleteNode éœ€è¦å°†å­˜å‚¨åœ¨èŠ‚ç‚¹ä¸Šçš„æ•°æ®é‡æ–°åˆ†é…ã€‚ func (kv *KVSystem) DeleteNode(nodeID string) { allData := kv.kvStores[nodeID].GetAll() kv.hashRing.RemoveNode(nodeID) delete(kv.kvStores, nodeID) for key, value := range allData { kv.Set(key, value) } } func (kv *KVSystem) AddNode() { node := \u0026amp;Node{ ID: fmt.Sprintf(\u0026#34;Node%d\u0026#34;, len(kv.hashRing.Nodes)), Addr: fmt.Sprintf(\u0026#34;192.168.1.%d\u0026#34;, len(kv.hashRing.Nodes)+1), } kv.hashRing.AddNode(node) kv.kvStores[node.ID] = kvstorage.NewKVStore() } è¿™æ ·æˆ‘ä»¬å°±å®ç°äº†ä¸€ä¸ªæœ€ç®€å•çš„åŸºäºä¸€è‡´æ€§hashçš„kv å­˜å‚¨ï¼Œæ˜¯ä¸æ˜¯ç‰¹åˆ«ç®€å•? ä½†æ˜¯å®ƒå´æ”¯æ’‘äº†æˆ‘ä»¬æ•´ä¸ªç½‘ç»œä¸–ç•Œçš„è¿è½¬ã€‚\nå‚è€ƒèµ„æ–™ Consistent_hashing\n","date":"2024-06-19T21:22:15+08:00","image":"https://images.yixiao9206.cn/blog-images/2024/06/f3b53488c2407a75d85406be58526010.png","permalink":"https://huizhou92.com/zh-cn/p/%E5%88%86%E5%B8%83%E5%BC%8F%E5%9F%BA%E7%9F%B3%E7%AE%97%E6%B3%951-%E4%B8%80%E8%87%B4%E6%80%A7hash/","title":"åˆ†å¸ƒå¼åŸºçŸ³ç®—æ³•1:  ä¸€è‡´æ€§hash"},{"content":"åœ¨ goè¯­è¨€ä¸­ï¼Œæ­£å¸¸çš„ struct ä¸€å®šæ˜¯éœ€è¦å ç”¨ä¸€å—å†…å­˜çš„ï¼Œä½†æ˜¯æœ‰ä¸€ç§ç‰¹æ®Šæƒ…å†µï¼Œå¦‚æœæ˜¯ä¸€ä¸ªç©ºstructï¼Œé‚£ä¹ˆå®ƒçš„å¤§å°ä¸º0. è¿™æ˜¯æ€ä¹ˆå›äº‹ï¼Œç©ºstruct åˆæœ‰ä»€ä¹ˆç”¨å‘¢ï¼Ÿ\nThis article is first published in the medium MPP plan. If you are a medium user, please follow me in medium. Thank you very much.\n1 2 3 4 5 6 7 8 9 10 11 12 13 type Test struct { A int B string } func main() { fmt.Println(unsafe.Sizeof(new(Test))) fmt.Println(unsafe.Sizeof(struct{}{})) } /* 8 0 */ Empty Struct çš„ ç§˜å¯† ç‰¹æ®Šå˜é‡ï¼šzerobase ç©ºç»“æ„ä½“æ˜¯æ²¡æœ‰å†…å­˜å¤§å°çš„ç»“æ„ä½“ã€‚è¿™å¥è¯æ˜¯æ²¡æœ‰é”™çš„ï¼Œä½†æ˜¯æ›´å‡†ç¡®çš„æ¥è¯´ï¼Œå…¶å®æ˜¯æœ‰ä¸€ä¸ªç‰¹æ®Šèµ·ç‚¹çš„ï¼Œé‚£å°±æ˜¯Â zerobaseÂ å˜é‡ï¼Œè¿™æ˜¯ä¸€ä¸ªÂ uintptrÂ å…¨å±€å˜é‡ï¼Œå ç”¨ 8 ä¸ªå­—èŠ‚ã€‚å½“åœ¨ä»»ä½•åœ°æ–¹å®šä¹‰æ— æ•°ä¸ªÂ struct {}Â ç±»å‹çš„å˜é‡ï¼Œç¼–è¯‘å™¨éƒ½åªæ˜¯æŠŠè¿™ä¸ªÂ zerobaseÂ å˜é‡çš„åœ°å€ç»™å‡ºå»ã€‚æ¢å¥è¯è¯´ï¼Œåœ¨ golang é‡Œé¢ï¼Œæ¶‰åŠåˆ°æ‰€æœ‰å†…å­˜ size ä¸º 0 çš„å†…å­˜åˆ†é…ï¼Œé‚£ä¹ˆå°±æ˜¯ç”¨çš„åŒä¸€ä¸ªåœ°å€Â \u0026amp;zerobaseÂ ã€‚\nä¾‹å¦‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 package main import \u0026#34;fmt\u0026#34; type emptyStruct struct {} func main() { a := struct{}{} b := struct{}{} c := emptyStruct{} fmt.Printf(\u0026#34;%p\\n\u0026#34;, \u0026amp;a) fmt.Printf(\u0026#34;%p\\n\u0026#34;, \u0026amp;b) fmt.Printf(\u0026#34;%p\\n\u0026#34;, \u0026amp;c) } // 0x58e360 // 0x58e360 // 0x58e360 ç©ºç»“æ„ä½“çš„å˜é‡çš„å†…å­˜åœ°å€éƒ½æ˜¯ä¸€æ ·çš„ã€‚è¿™æ˜¯å› ä¸ºç¼–è¯‘å™¨åœ¨ç¼–è¯‘æœŸé—´ï¼Œé‡åˆ°Â struct {}Â è¿™ç§ç‰¹æ®Šç±»å‹çš„å†…å­˜åˆ†é…ï¼Œä¼šç»™ä»–åˆ†é…\u0026amp;zerobaseï¼Œè¿™ä¸ªä»£ç é€»è¾‘æ˜¯åœ¨Â mallocgcÂ å‡½æ•°é‡Œé¢ï¼š\n1 2 3 4 5 6 7 //go:linkname mallocgc func mallocgc(size uintptr, typ *_type, needzero bool) unsafe.Pointer { .... if size == 0 { return unsafe.Pointer(\u0026amp;zerobase) } ..... è¿™å°±æ˜¯Empty struct çš„ç§˜å¯†æœ‰äº†è¿™ä¸ªç‰¹æ®Šçš„ å˜é‡ï¼Œæˆ‘ä»¬åˆ©ç”¨å®ƒå¯ä»¥å®Œæˆå¾ˆå¤šåŠŸèƒ½ã€‚\nEmpty struct ä¸å†…å­˜å¯¹å…¶\nä¸€èˆ¬æƒ…å†µä¸‹ï¼Œstruct ä¸­åŒ…å« empty struct ï¼Œè¿™ä¸ªå­—æ®µæ˜¯ä¸å ç”¨å†…å­˜ç©ºé—´çš„ï¼Œä½†æ˜¯æœ‰ä¸€ç§æƒ…å†µæ˜¯ç‰¹æ®Šçš„ï¼Œé‚£å°±æ˜¯ empty struct ä½äºæœ€åä¸€ä½ï¼Œå®ƒä¼šè§¦å‘å†…å­˜å¯¹é½ ã€‚\næ¯”å¦‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 type A struct { x int y string z struct{} } type B struct { x int z struct{} y string } func main() { println(unsafe.Alignof(A{})) println(unsafe.Alignof(B{})) println(unsafe.Sizeof(A{})) println(unsafe.Sizeof(B{})) } /** 8 8 32 24 **/ å› ä¸ºå¦‚æœæœ‰æŒ‡é’ˆæŒ‡å‘è¯¥å­—æ®µ, è¿”å›çš„åœ°å€å°†åœ¨ç»“æ„ä½“ä¹‹å¤–ï¼Œå¦‚æœæ­¤æŒ‡é’ˆä¸€ç›´å­˜æ´»ä¸é‡Šæ”¾å¯¹åº”çš„å†…å­˜ï¼Œå°±ä¼šæœ‰å†…å­˜æ³„éœ²çš„é—®é¢˜ï¼ˆè¯¥å†…å­˜ä¸å› ç»“æ„ä½“é‡Šæ”¾è€Œé‡Šæ”¾ï¼‰ã€‚\nå› æ­¤ï¼Œå½“Â struct{}Â ä½œä¸ºå…¶ä»– struct æœ€åä¸€ä¸ªå­—æ®µæ—¶ï¼Œéœ€è¦å¡«å……é¢å¤–çš„å†…å­˜ä¿è¯å®‰å…¨,å¦‚æœ empty struct åœ¨å¼€å§‹ä½ç½®ï¼Œæˆ–è€…ä¸­é—´ä½ç½®ï¼Œé‚£ä¹ˆå®ƒçš„åœ°å€æ˜¯ä¸‹ä¸€ä¸ªå˜é‡çš„åœ°å€\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 type A struct { x int y string z struct{} } type B struct { x int z struct{} y string } func main() { a := A{} b := B{} fmt.Printf(\u0026#34;%p\\n\u0026#34;, \u0026amp;a.y) fmt.Printf(\u0026#34;%p\\n\u0026#34;, \u0026amp;a.z) fmt.Printf(\u0026#34;%p\\n\u0026#34;, \u0026amp;b.y) fmt.Printf(\u0026#34;%p\\n\u0026#34;, \u0026amp;b.z) } /** 0x1400012c008 0x1400012c018 0x1400012e008 0x1400012e008 **/ Empty çš„ä½¿ç”¨åœºæ™¯ ç©ºç»“æ„ä½“Â struct{ }Â ä¸ºä»€ä¹ˆä¼šå­˜åœ¨çš„æ ¸å¿ƒç†ç”±å°±æ˜¯ä¸ºäº†èŠ‚çœå†…å­˜ã€‚å½“ä½ éœ€è¦ä¸€ä¸ªç»“æ„ä½“ï¼Œä½†æ˜¯å´ä¸æ¯«ä¸å…³ç³»é‡Œé¢çš„å†…å®¹ï¼Œé‚£ä¹ˆå°±å¯ä»¥è€ƒè™‘ç©ºç»“æ„ä½“ã€‚golang æ ¸å¿ƒçš„å‡ ä¸ªå¤åˆç»“æ„Â mapÂ ï¼ŒchanÂ ï¼ŒsliceÂ éƒ½èƒ½ç»“åˆÂ struct{}Â ä½¿ç”¨ã€‚\nmapÂ \u0026amp;Â struct{} 1 2 3 4 5 6 // åˆ›å»º map m := make(map[int]struct{}) // èµ‹å€¼ m[1] = struct{}{} // åˆ¤æ–­ key é”®å­˜ä¸å­˜åœ¨ _, ok := m[1] chanÂ \u0026amp;Â struct{} channelÂ å’ŒÂ struct{}Â ç»“åˆæ˜¯ä¸€ä¸ªæœ€ç»å…¸çš„åœºæ™¯ï¼Œstruct{}Â é€šå¸¸ä½œä¸ºä¸€ä¸ªä¿¡å·æ¥ä¼ è¾“ï¼Œå¹¶ä¸å…³æ³¨å…¶ä¸­å†…å®¹ã€‚chan çš„åˆ†æåœ¨å‰å‡ ç¯‡æ–‡ç« æœ‰è¯¦ç»†è¯´æ˜ã€‚chan æœ¬è´¨çš„æ•°æ®ç»“æ„æ˜¯ä¸€ä¸ªç®¡ç†ç»“æ„åŠ ä¸Šä¸€ä¸ª ringbuffer ï¼Œå¦‚æœÂ struct{}Â ä½œä¸ºå…ƒç´ çš„è¯ï¼Œringbuffer å°±æ˜¯ 0 åˆ†é…çš„ã€‚\nchanÂ å’ŒÂ struct{}Â ç»“åˆåŸºæœ¬åªæœ‰ä¸€ç§ç”¨æ³•ï¼Œå°±æ˜¯ä¿¡å·ä¼ é€’ï¼Œç©ºç»“æ„ä½“æœ¬èº«æºå¸¦ä¸äº†å€¼ï¼Œæ‰€ä»¥ä¹Ÿåªæœ‰è¿™ä¸€ç§ç”¨æ³•å•¦ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œé…åˆ no buffer çš„ channel ä½¿ç”¨ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 // åˆ›å»ºä¸€ä¸ªä¿¡å·é€šé“ waitc := make(chan struct{}) // ... goroutine 1: // å‘é€ä¿¡å·: æŠ•é€’å…ƒç´  waitc \u0026lt;- struct{} // å‘é€ä¿¡å·: å…³é—­ close(waitc) goroutine 2: select { // æ”¶åˆ°ä¿¡å·ï¼Œåšå‡ºå¯¹åº”çš„åŠ¨ä½œ case \u0026lt;-waitc: } è¿™ç§åœºæ™¯æˆ‘ä»¬æ€è€ƒä¸‹ï¼Œæ˜¯å¦ä¸€å®šæ˜¯éÂ struct{}Â ä¸å¯ï¼Ÿå…¶å®ä¸æ˜¯ï¼Œè€Œä¸”ä¹Ÿä¸å¤šè¿™å‡ ä¸ªå­—èŠ‚çš„å†…å­˜ï¼Œæ‰€ä»¥è¿™ç§æƒ…å†µçœŸçš„å°±åªæ˜¯ä¸å…³å¿ƒÂ chanÂ çš„å…ƒç´ å€¼è€Œå·²ï¼Œæ‰€ä»¥æ‰ç”¨çš„Â struct{}ã€‚\næ€»ç»“ ç©ºç»“æ„ä½“ä¹Ÿæ˜¯ç»“æ„ä½“ï¼Œåªæ˜¯ size ä¸º 0 çš„ç±»å‹è€Œå·²ï¼› æ‰€æœ‰çš„ç©ºç»“æ„ä½“éƒ½æœ‰ä¸€ä¸ªå…±åŒçš„åœ°å€ï¼šzerobaseÂ çš„åœ°å€ï¼› æˆ‘ä»¬å¯ä»¥åˆ©ç”¨empty struct ä¸å ç”¨å†…å­˜çš„ç‰¹æ€§ï¼Œæ¥ä¼˜åŒ–ä»£ç ï¼Œæ¯”å¦‚åˆ©ç”¨map å®ç°set ä»¥åŠ chan ç­‰ã€‚ å‚è€ƒé“¾æ¥ The empty struct, Dave Cheney Go æœ€ç»†èŠ‚ç¯‡â€” struct{} ç©ºç»“æ„ä½“ç©¶ç«Ÿæ˜¯å•¥ï¼Ÿ ","date":"2024-06-17T23:18:02+08:00","image":"https://images.yixiao9206.cn/blog-images/2024/06/c78d096394f1791445b7c10f88dd0378.jpg","permalink":"https://huizhou92.com/zh-cn/p/%E8%A7%A3%E5%AF%86go-empty-struct/","title":"è§£å¯†go: empty struct"},{"content":"åŸæ–‡é“¾æ¥how-quic-is-displacing-tcp-for-speed\nå¼•è¨€ åœ¨è¿‡å»çš„ä¸‰åå¹´ä¸­ï¼ŒHTTPï¼ˆè¶…æ–‡æœ¬ä¼ è¾“åè®®ï¼‰ä¸€ç›´æ˜¯äº’è”ç½‘çš„æ”¯æŸ±ã€‚æˆ‘ä»¬èƒ½å¤Ÿæµè§ˆç½‘é¡µã€ä¸‹è½½æ–‡ä»¶ã€æµå¼ä¼ è¾“ç”µå½±ç­‰ï¼Œéƒ½æ˜¯å› ä¸ºHTTPã€‚è¿™ä¸ªåè®®å¤šå¹´æ¥ä¸æ–­å‘å±•ï¼Œè§è¯äº†é‡å¤§çš„æ”¹è¿›ã€‚\nHTTPåè®®æ˜¯ä¸€ä¸ªåº”ç”¨å±‚åè®®ï¼Œå·¥ä½œåœ¨TCPï¼ˆä¼ è¾“æ§åˆ¶åè®®ï¼‰ä¹‹ä¸Šã€‚TCPåè®®æœ‰ä¸€äº›é™åˆ¶ï¼Œå¯¼è‡´ç½‘ç»œåº”ç”¨ç¨‹åºå“åº”æ€§è¾ƒå·®ã€‚\nè°·æ­Œå¼€å‘äº†ä¸€ç§æ”¹å˜æ¸¸æˆè§„åˆ™çš„ä¼ è¾“åè®®QUICï¼Œä»¥å…‹æœTCPçš„ç¼ºç‚¹ã€‚QUICå‡ å¹´å‰è¢«æ ‡å‡†åŒ–å¹¶åŠ å…¥åˆ°IETFï¼ˆäº’è”ç½‘å·¥ç¨‹ä»»åŠ¡ç»„ï¼‰ã€‚\nåœ¨è¿‡å»å‡ å¹´ä¸­ï¼ŒQUICçš„é‡‡ç”¨å‘ˆæŒ‡æ•°çº§å¢é•¿ã€‚å¤§å¤šæ•°ç§‘æŠ€å…¬å¸ï¼Œå¦‚è°·æ­Œã€Facebookã€Pinterestç­‰ï¼Œå·²ç»å¼€å§‹é‡‡ç”¨ä½¿ç”¨QUICä½œä¸ºä¼ è¾“å±‚çš„HTTP/3.0ã€‚è¿™äº›å…¬å¸åœ¨ä½¿ç”¨HTTP/3.0å’ŒQUICåï¼Œå…¶ç½‘ç«™æ€§èƒ½æœ‰äº†æ˜¾è‘—æå‡ã€‚\nè®©æˆ‘ä»¬å¼€å§‹æˆ‘ä»¬çš„æ—…ç¨‹ï¼Œäº†è§£QUICå¦‚ä½•å–ä»£TCPã€‚æˆ‘ä»¬é¦–å…ˆå°†äº†è§£ä¸€äº›åŸºæœ¬çš„TCPå’ŒUDPç½‘ç»œæ¦‚å¿µã€‚ä¹‹åï¼Œæˆ‘ä»¬å°†çœ‹çœ‹HTTPçš„æ¼”å˜ï¼Œä»¥åŠæ¯ä¸ªç‰ˆæœ¬æ˜¯å¦‚ä½•å…‹æœå‰ä¸€ä¸ªç‰ˆæœ¬çš„é™åˆ¶çš„ã€‚ç„¶åï¼Œæˆ‘ä»¬å°†äº†è§£QUICæ˜¯ä»€ä¹ˆä»¥åŠå®ƒçš„å·¥ä½œåŸç†ã€‚æˆ‘ä»¬å°†æ¢è®¨ä¸ºä»€ä¹ˆQUICçš„æ€§èƒ½æ¯”TCPé«˜ã€‚\nTCPå’ŒUDPæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ TCPï¼ˆä¼ è¾“æ§åˆ¶åè®®ï¼‰å’ŒUDPï¼ˆç”¨æˆ·æ•°æ®æŠ¥åè®®ï¼‰æ˜¯ä¼ è¾“å±‚åè®®ã€‚è¿™äº›åè®®ç®¡ç†äº’è”ç½‘æ•°æ®åŒ…æµå‘å’Œæ¥è‡ªä»»ä½•ç”µå­è®¾å¤‡çš„è¿‡ç¨‹ã€‚è®©æˆ‘ä»¬è¯¦ç»†äº†è§£è¿™ä¸¤ä¸ªåè®®æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚\nTCP TCPæ˜¯ä¸€ç§åŸºäºè¿æ¥çš„åè®®ã€‚å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨å»ºç«‹è¿æ¥ï¼Œç„¶åå‘é€æ•°æ®ã€‚TCPè¿æ¥æ˜¯é€šè¿‡ä¸€ç§ç§°ä¸ºä¸‰æ¬¡æ¡æ‰‹çš„æœºåˆ¶å»ºç«‹çš„ã€‚ä¸‹å›¾å±•ç¤ºäº†ä¸‰æ¬¡æ¡æ‰‹è¿‡ç¨‹ï¼š\nè¿™ä¸ªè¿‡ç¨‹åŒ…æ‹¬ä¸‰ä¸ªæ­¥éª¤ï¼š\nSYN - å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€ä¸€ä¸ªSYNæ•°æ®åŒ…ã€‚\nACK - æœåŠ¡å™¨æ¥æ”¶åˆ°SYNåï¼Œé€šè¿‡ACKæ•°æ®åŒ…å‘å®¢æˆ·ç«¯å‘é€ç¡®è®¤ã€‚\nSYN-ACK - å®¢æˆ·ç«¯æ”¶åˆ°æœåŠ¡å™¨çš„ACKæ•°æ®åŒ…åï¼Œæœ€ç»ˆé€šè¿‡SYN-ACKå‘æœåŠ¡å™¨å‘é€ç¡®è®¤ã€‚\nTCPæ˜¯ä¸€ä¸ªæœ‰çŠ¶æ€å’Œå¯é çš„åè®®ã€‚å®ƒä¿è¯ä»ä¸€å°è®¾å¤‡åˆ°å¦ä¸€å°è®¾å¤‡çš„æ‰€æœ‰æ•°æ®åŒ…çš„ä¼ è¾“ã€‚æ­¤å¤–ï¼Œå®ƒå…è®¸å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä½¿ç”¨ç›¸åŒçš„è¿æ¥è¿›è¡Œé€šä¿¡ã€‚\nUDP UDPæ˜¯ä¸€ç§æ— è¿æ¥åè®®ã€‚ä¸TCPä¸åŒï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´æ²¡æœ‰ä¸‰æ¬¡æ¡æ‰‹ã€‚å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€æ•°æ®åŒ…ï¼Œä¸ç­‰å¾…æœåŠ¡å™¨çš„ç¡®è®¤ã€‚\nUDPä¸èƒ½ä¿è¯100%çš„æ•°æ®åŒ…ä¼ è¾“ã€‚æ•°æ®åŒ…å¯èƒ½ä¼šä¸¢å¤±ï¼Œå¯èƒ½æ— æ³•åˆ°è¾¾å¦ä¸€å°è®¾å¤‡ã€‚UDPä¸åƒTCPé‚£æ ·å¯é ã€‚\nç”±äºæ²¡æœ‰åˆå§‹æ¡æ‰‹ï¼ŒUDPæ¯”TCPå¿«å¾—å¤šã€‚å‡ºäºæ€§èƒ½åŸå› ï¼ŒUDPä¸»è¦ç”¨äºæµå¼æ•°æ®åº”ç”¨ç¨‹åºï¼Œå¦‚éŸ³ä¹/è§†é¢‘ã€‚\nè¿™æ˜¯ä¸€ä¸ªæµè¡Œçš„äº’è”ç½‘æ¢—ï¼Œå¯¹TCP/UDPè¿›è¡Œäº†è°ƒä¾ƒï¼š\nåˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å·²ç»äº†è§£äº†TCPå’ŒUDPåè®®æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚ç°åœ¨è®©æˆ‘ä»¬æ¢ç´¢HTTPåè®®ï¼Œè¿™æ˜¯ä¸€ä¸ªåº”ç”¨å±‚åè®®ã€‚\nHTTPçš„æ¼”å˜ ç”±Tim Berners-Leeåœ¨CERNå¼€å‘çš„HTTPçš„ç¬¬ä¸€ä¸ªç‰ˆæœ¬æ˜¯åœ¨1989å¹´ã€‚ä»é‚£æ—¶èµ·ï¼Œè¯¥åè®®ç»å†äº†å¤šæ¬¡ä¼˜åŒ–å’Œæ€§èƒ½æ”¹è¿›ã€‚å¤§å¤šæ•°ç°ä»£è®¾å¤‡ä½¿ç”¨HTTP 1.1/ HTTP 2.0å’ŒHTTP 3.0ã€‚è®©æˆ‘ä»¬å›é¡¾ä¸€ä¸‹HTTPçš„å†å²ï¼Œäº†è§£åè®®ç»å†çš„é‡å¤§å˜åŒ–ã€‚\nHTTP/1.0 åœ¨æœ€åˆçš„HTTP/0.9ç‰ˆæœ¬ä¹‹åï¼ŒHTTP/1.0å¼€å§‹æ”¯æŒå¤´ã€è¯·æ±‚ä½“ã€æ–‡æœ¬æ–‡ä»¶ç­‰ã€‚å®¢æˆ·ç«¯æ¯æ¬¡ä½¿ç”¨HTTPä»æœåŠ¡å™¨è·å–æ•°æ®æ—¶ï¼Œéƒ½å¿…é¡»åˆ›å»ºä¸€ä¸ªTCPè¿æ¥ã€‚è¿™å¯¼è‡´åœ¨å»ºç«‹è¿æ¥æ—¶æ˜¾è‘—æµªè´¹èµ„æºã€‚\nHTTP/1.1 è¿™ä¸ªåè®®å¢åŠ äº†å¯¹é‡ç”¨å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´ç°æœ‰TCPè¿æ¥ä»¥è·å–æ–°æ•°æ®çš„æ”¯æŒã€‚è¿™æ˜¯é€šè¿‡HTTPå¤´keep-aliveå®ç°çš„ã€‚\nå¦‚æœå®¢æˆ·ç«¯æƒ³è¦è·å–10ä¸ªJavaScriptæ–‡ä»¶ï¼Œé‚£ä¹ˆå®ƒå°†ä¸æœåŠ¡å™¨å»ºç«‹ä¸€ä¸ªè¿æ¥ã€‚ç„¶åï¼Œå®ƒå°†é‡ç”¨ç›¸åŒçš„è¿æ¥æ¥è·å–è¿™10ä¸ªæ–‡ä»¶ï¼Œè€Œä¸æ˜¯ä¸ºæ¯ä¸ªæ–‡ä»¶åˆ›å»ºä¸€ä¸ªæ–°è¿æ¥ã€‚\nè¿™å¯¼è‡´èµ„æºæµªè´¹å‡å°‘å’Œæ€§èƒ½æå‡ï¼Œå› ä¸ºå®ƒé¿å…äº†åˆ›å»ºå¤šä½™çš„è¿æ¥ã€‚ç„¶è€Œï¼Œä¸€ä¸ªä¸»è¦çš„ç¼ºç‚¹æ˜¯ä¼—æ‰€å‘¨çŸ¥çš„_é˜Ÿå¤´é˜»å¡_é—®é¢˜ã€‚\nä¸‹å›¾å±•ç¤ºäº†_é˜Ÿå¤´é˜»å¡_é—®é¢˜ã€‚\nè®©æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªä¾‹å­æ¥ç†è§£è¿™ä¸ªæ¦‚å¿µã€‚å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œä½ æœ‰3ä¸ªæ–‡ä»¶ - å›¾åƒã€æ–‡æœ¬å’Œè§†é¢‘ã€‚è§†é¢‘æ–‡ä»¶ä½“ç§¯è¾ƒå¤§ï¼Œä¼ è¾“æ—¶é—´ä¼šæ›´é•¿ã€‚ç”±äºè§†é¢‘æ–‡ä»¶ä¼ è¾“æ—¶é—´è¾ƒé•¿ï¼Œå®ƒä¼šé˜»å¡å›¾åƒå’Œæ–‡æœ¬æ–‡ä»¶çš„å‘é€ã€‚\nHTTP/2.0 HTTP 2.0é€šè¿‡å¤šè·¯å¤ç”¨è§£å†³äº†_é˜Ÿå¤´é˜»å¡_é—®é¢˜ã€‚é€šè¿‡å¤šè·¯å¤ç”¨ï¼Œå¤šä¸ªæ–‡ä»¶å¯ä»¥é€šè¿‡åŒä¸€ä¸ªTCPè¿æ¥å‘é€ã€‚\nè¿™å¯¼è‡´äº†æ€§èƒ½æå‡ï¼Œå¹¶è§£å†³äº†åº”ç”¨å±‚é¢çš„é˜Ÿå¤´é˜»å¡é—®é¢˜ã€‚ç„¶è€Œï¼Œåœ¨TCPå±‚é¢ï¼Œå¦‚æœå‘ç”Ÿæ•°æ®åŒ…ä¸¢å¤±ï¼Œå®ƒå¿…é¡»ç­‰å¾…æ•°æ®åŒ…é‡ä¼ ã€‚\nå¤šè·¯å¤ç”¨è§£å†³æ–¹æ¡ˆåœ¨æ•°æ®åŒ…ä¸¢å¤±çš„æƒ…å†µä¸‹å¹¶ä¸åƒé¢„æœŸçš„é‚£æ ·æœ‰æ•ˆã€‚å®é™…ä¸Šï¼Œå¦‚æœæ•°æ®åŒ…ä¸¢å¤±è¶…è¿‡5%ï¼ŒHTTP 1.1çš„æ€§èƒ½æ¯”HTTP 2.0æ›´å¥½ã€‚_é˜Ÿå¤´é˜»å¡_é—®é¢˜ä»åº”ç”¨å±‚è½¬ç§»åˆ°äº†ä¼ è¾“å±‚ã€‚\nä¸‹å›¾å±•ç¤ºäº†å•ä¸ªæ•°æ®åŒ…ä¸¢å¤±å¦‚ä½•å¯¼è‡´å¤šä¸ªæµå»¶è¿Ÿï¼š\nå½“ä¸€ä¸ªæ•°æ®åŒ…ä¸¢å¤±æ—¶ï¼ŒTCPå°†å…¶åç»­æ•°æ®åŒ…å­˜å‚¨åœ¨å…¶ç¼“å†²åŒºä¸­ï¼Œç›´åˆ°æ”¶åˆ°ä¸¢å¤±çš„æ•°æ®åŒ…ã€‚ç„¶åTCPä½¿ç”¨é‡ä¼ æ¥è·å–ä¸¢å¤±çš„æ•°æ®åŒ…ã€‚HTTPæ— æ³•çœ‹åˆ°TCPé‡ä¼ ã€‚å› æ­¤ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¸åŒçš„æµä¼šçœ‹åˆ°ä¼ è¾“å»¶è¿Ÿã€‚\nä»€ä¹ˆæ˜¯QUICï¼Ÿ åœ¨è¿‡å»çš„å‡ ä¸ªéƒ¨åˆ†ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°äº†TCPæœ‰ä¸€äº›å›ºæœ‰çš„é™åˆ¶ï¼Œå¦‚ä¸‰æ¬¡æ¡æ‰‹å’Œé˜Ÿå¤´é˜»å¡ã€‚è¿™äº›é™åˆ¶å¯ä»¥é€šè¿‡å¢å¼ºTCPæˆ–ç”¨æ–°åè®®æ›¿æ¢TCPæ¥è§£å†³ã€‚\nå°½ç®¡å¢å¼ºTCPå¾ˆç®€å•ï¼Œä½†TCPå­˜åœ¨äºæœ€ä½å±‚ï¼Œä¸æ“ä½œç³»ç»Ÿç´§å¯†è€¦åˆã€‚ç®€å•æ¥è¯´ï¼ŒTCPçš„ä»£ç å­˜åœ¨äºå†…æ ¸å±‚è€Œä¸æ˜¯ç”¨æˆ·ç©ºé—´ã€‚è€ƒè™‘åˆ°å¤§é‡çš„è®¾å¤‡ï¼Œå®æ–½å†…æ ¸ç©ºé—´çš„æ›´æ”¹å°†éœ€è¦å¤§é‡çš„æ—¶é—´æ‰èƒ½åˆ°è¾¾æ‰€æœ‰ç”¨æˆ·ã€‚\nå› æ­¤ï¼Œè°·æ­Œæå‡ºäº†ä¸€ç§æ–°çš„åè®®QUICï¼Œä½œä¸ºTCPçš„æ›¿ä»£å“ã€‚åƒTCPä¸€æ ·ï¼ŒQUICä¹Ÿæ˜¯ä¸€ä¸ªä¼ è¾“å±‚åè®®ã€‚ç„¶è€Œï¼Œå®ƒä½äºç”¨æˆ·ç©ºé—´è€Œä¸æ˜¯å†…æ ¸ç©ºé—´ã€‚è¿™ä½¿å¾—å®ƒå®¹æ˜“æ›´æ”¹å’Œå¢å¼ºï¼Œä¸TCPä¸åŒã€‚\nQUICåœ¨UDPä¹‹ä¸Šå·¥ä½œã€‚å®ƒé€šè¿‡ä½¿ç”¨UDPå…‹æœäº†TCPçš„é™åˆ¶ã€‚å®ƒåªæ˜¯ä¸€ä¸ªåœ¨UDPä¹‹ä¸Šçš„å±‚æˆ–åŒ…è£…å™¨ã€‚è¯¥åŒ…è£…å™¨æ·»åŠ äº†TCPçš„åŠŸèƒ½ï¼Œå¦‚æ‹¥å¡æ§åˆ¶ã€æ•°æ®åŒ…é‡ä¼ ã€å¤šè·¯å¤ç”¨ç­‰ã€‚å®ƒå†…éƒ¨ä½¿ç”¨UDPï¼Œå¹¶åœ¨å…¶ä¸Šæ·»åŠ äº†TCPçš„æœ€ä½³åŠŸèƒ½ã€‚\nä¸‹å›¾æ˜¾ç¤ºäº†QUICå¦‚ä½•é€‚åº”ç½‘ç»œæ ˆï¼š\nç°åœ¨æˆ‘ä»¬å·²ç»äº†è§£äº†QUICçš„åŸºç¡€çŸ¥è¯†ï¼Œè®©æˆ‘ä»¬æ·±å…¥äº†è§£è¿™ä¸ªåè®®çš„å·¥ä½œåŸç†ã€‚\nQUICæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ QUICæ¡æ‰‹ QUICåœ¨UDPä¸Šå·¥ä½œï¼Œå®ƒä¸éœ€è¦ç»è¿‡ä¸‰æ¬¡æ¡æ‰‹è¿‡ç¨‹ã€‚ä¸‰æ¬¡æ¡æ‰‹è¿‡ç¨‹å¢åŠ äº†é¢å¤–çš„å¼€é”€ï¼Œå¢åŠ äº†å»¶è¿Ÿã€‚å› æ­¤ï¼ŒQUICé€šè¿‡å‡å°‘è¿æ¥å»¶è¿Ÿæ¥æé«˜æ€§èƒ½ã€‚\nåœ¨TCPçš„æƒ…å†µä¸‹ï¼Œè¿˜æœ‰ä¸€ä¸ªé¢å¤–çš„ç”¨äºTLSçš„æ¡æ‰‹ï¼Œè¿™ä¹Ÿå¢åŠ äº†å»¶è¿Ÿã€‚QUICå°†TLSæ¡æ‰‹å’ŒQUICæ¡æ‰‹åˆå¹¶ä¸ºä¸€ä¸ªè°ƒç”¨ã€‚å®ƒä¼˜åŒ–äº†æ¡æ‰‹è¿‡ç¨‹å¹¶æé«˜äº†æ€§èƒ½ã€‚\nå¯é æ€§ æ‚¨å¯èƒ½ä¼šæƒ³â€œæ—¢ç„¶QUICåœ¨UDPä¸Šå·¥ä½œï¼Œæ•°æ®åŒ…ä¼šä¸¢å¤±å—ï¼Ÿâ€ã€‚ç­”æ¡ˆæ˜¯ä¸ã€‚QUICåœ¨UDPå †æ ˆä¸Šæ·»åŠ äº†å¯é æ€§ã€‚å®ƒå®ç°äº†æ•°æ®åŒ…é‡ä¼ ï¼Œä»¥é˜²å®ƒæ²¡æœ‰æ”¶åˆ°å¿…è¦çš„æ•°æ®åŒ…ã€‚ä¾‹å¦‚ï¼šå¦‚æœæœåŠ¡å™¨æ²¡æœ‰æ”¶åˆ°æ¥è‡ªå®¢æˆ·ç«¯çš„ç¬¬5ä¸ªæ•°æ®åŒ…ï¼Œåè®®å°†æ£€æµ‹åˆ°å®ƒå¹¶è¦æ±‚å®¢æˆ·ç«¯é‡æ–°å‘é€ç›¸åŒçš„æ•°æ®åŒ…ã€‚\nå¤šè·¯å¤ç”¨ ä¸TCPç±»ä¼¼ï¼ŒQUICä¹Ÿå®ç°äº†å¤šè·¯å¤ç”¨ã€‚å®¢æˆ·ç«¯å¯ä»¥ä½¿ç”¨å•ä¸ªé€šé“åŒæ—¶ä¼ è¾“å¤šä¸ªæ–‡ä»¶ã€‚QUICä¸ºæ¯ä¸ªæµï¼ˆä¼ è¾“çš„æ–‡ä»¶ï¼‰åˆ›å»ºä¸€ä¸ªUUIDã€‚å®ƒä½¿ç”¨UUIDæ¥è¯†åˆ«æµã€‚ç„¶åï¼Œå¤šä¸ªæµé€šè¿‡å•ä¸ªé€šé“å‘é€ã€‚\nä¸‹å›¾å±•ç¤ºäº†QUICä¸­å¤šè·¯å¤ç”¨æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼š\nQUICè¿˜é€šè¿‡å…¶å¤šè·¯å¤ç”¨è§£å†³äº†TCPé¢ä¸´çš„é˜Ÿå¤´é˜»å¡é—®é¢˜ã€‚å¦‚æœä¸€ä¸ªæµé­å—æ•°æ®åŒ…ä¸¢å¤±ï¼Œåªæœ‰è¯¥æµä¼šå—åˆ°å½±å“ã€‚QUICä¸­çš„æµæ˜¯ç‹¬ç«‹çš„ï¼Œä¸ä¼šå½±å“å½¼æ­¤çš„å·¥ä½œã€‚\nå®‰å…¨æ€§ æ­¤å¤–ï¼ŒQUIC è¿˜æ”¯æŒ TLS 1.3ï¼ˆä¼ è¾“å±‚å®‰å…¨æ€§ï¼‰ã€‚è¿™ä¿è¯äº†æ•°æ®çš„å®‰å…¨æ€§å’Œä¿å¯†æ€§ã€‚TLS åŠ å¯†äº† QUIC åè®®çš„å¤§éƒ¨åˆ†å†…å®¹ï¼Œä¾‹å¦‚æ•°æ®åŒ…ç¼–å·å’Œè¿æ¥å…³é—­ä¿¡å·ã€‚\nä¸ºä»€ä¹ˆé€‰æ‹©QUICï¼Ÿ é™ä½å»¶è¿Ÿ - QUICé€šè¿‡å°†TLSæ¡æ‰‹ä¸è¿æ¥å»ºç«‹ç»“åˆèµ·æ¥ï¼Œæœ€å°åŒ–äº†å»¶è¿Ÿã€‚è¿™ä¹Ÿè¢«ç§°ä¸º0-RTTï¼ˆé›¶å¾€è¿”æ—¶é—´ï¼‰ã€‚å®ƒå®ç°äº†æ›´å¿«çš„è¿æ¥å»ºç«‹ï¼Œå¹¶æé«˜äº†ç½‘ç»œåº”ç”¨ç¨‹åºçš„æ€§èƒ½ã€‚ å¤šè·¯å¤ç”¨ - é€šè¿‡å¤šè·¯å¤ç”¨ï¼ŒQUICå¯ä»¥åœ¨å•ä¸ªé€šé“ä¸Šå‘é€å¤šä¸ªæ•°æ®æµã€‚è¿™å¯¹äºä¸‹è½½å¤šä¸ªæ–‡ä»¶ï¼ˆå¦‚å›¾åƒã€JavaScriptã€CSSç­‰ï¼‰çš„å®¢æˆ·ç«¯åº”ç”¨ç¨‹åºéå¸¸æœ‰ç”¨ã€‚ è¿æ¥è¿ç§» - ä½¿ç”¨QUICï¼Œæ‚¨å¯ä»¥åœ¨ä¸å‡ºç°ä»»ä½•é—®é¢˜çš„æƒ…å†µä¸‹ä»ä¸€ç§ç½‘ç»œæ¥å£åˆ‡æ¢åˆ°å¦ä¸€ç§ï¼ˆä¾‹å¦‚ä»Wi-Fiåˆ‡æ¢åˆ°ç§»åŠ¨æ•°æ®ï¼‰ã€‚è¿™å¯¹äºç§»åŠ¨è®¾å¤‡å¾ˆé‡è¦ï¼Œå¹¶æé«˜äº†ç”¨æˆ·ä½“éªŒã€‚ æé«˜å®‰å…¨æ€§ - QUICä½¿ç”¨TLS 1.3ï¼Œæä¾›æ›´å¥½çš„å®‰å…¨æ€§ã€‚æ­¤å¤–ï¼Œå®ƒè¿˜åŠ å¯†äº†åè®®çš„å¤§éƒ¨åˆ†ï¼Œä¸åªåŠ å¯†HTTPæœ‰æ•ˆè½½è·çš„TCPå’ŒTLSä¸åŒã€‚ä¸TCPç›¸æ¯”ï¼Œå®ƒæ›´èƒ½æŠµå¾¡å®‰å…¨æ”»å‡»ã€‚ å¹¿æ³›æ”¯æŒ - è‡ªå…¶è¯ç”Ÿä»¥æ¥ï¼Œå®ƒçš„é‡‡ç”¨ç‡ä¸€ç›´åœ¨ä¸Šå‡ã€‚è¿™è¿›ä¸€æ­¥åŠ å¼ºäº†å®ƒçš„æœ‰æ•ˆæ€§ã€‚ HTTP/3å’ŒQUIC HTTP/3æ˜¯è¶…æ–‡æœ¬ä¼ è¾“åè®®ï¼ˆHTTPï¼‰çš„æœ€æ–°ç‰ˆæœ¬ã€‚å®ƒå†…éƒ¨ä½¿ç”¨QUICè€Œä¸æ˜¯TCPã€‚å®ƒæ—¨åœ¨ä¸ºç°ä»£ç½‘ç»œæä¾›æ›´æœ‰æ•ˆå’Œå®‰å…¨çš„åŸºç¡€ã€‚å®ƒæ‹¥æœ‰QUICæä¾›çš„æ‰€æœ‰ä¼˜åŠ¿ã€‚\nHTTP/3ç”±IETFæ ‡å‡†åŒ–ã€‚ä»Šå¤©ï¼Œå¾ˆå¤§ä¸€éƒ¨åˆ†äº’è”ç½‘æµé‡ä¾èµ–äºHTTP/3ã€‚ä»¥ä¸‹æ˜¯æ˜¾ç¤ºHTTP/3é‡‡ç”¨ç‡çš„å›¾è¡¨ï¼š\nä»ä¸Šè¿°å›¾è¡¨ä¸­å¯ä»¥çœ‹å‡ºï¼Œé‡‡ç”¨ç‡å·²ç»é£™å‡è‡³30%ï¼Œå¹¶é€æ¸è¶…è¶Šäº†HTTP/1.1ã€‚æŒ‰ç…§ç›®å‰çš„å‘å±•é€Ÿåº¦ï¼ŒHTTP/3.0å°†åœ¨æœªæ¥å‡ å¹´é€æ¸è¶…è¶ŠHTTP/2.0ã€‚\nç»“è®º è‡ªä¸‰åå¹´å‰HTTPè¯ç”Ÿä»¥æ¥ï¼Œäº’è”ç½‘å·²ç»èµ°è¿‡äº†æ¼«é•¿çš„é“è·¯ã€‚HTTPçš„æ¼”å˜ä½¿åœ¨çº¿ä½“éªŒæ›´åŠ é«˜æ•ˆå’Œå“åº”è¿…é€Ÿã€‚éšç€ç°ä»£åº”ç”¨ç¨‹åºéœ€æ±‚çš„å¢é•¿ï¼Œæˆ‘ä»¬æ„è¯†åˆ°äº†åº•å±‚åè®®å¦‚TCPçš„å›ºæœ‰é™åˆ¶ã€‚\nè°·æ­Œå¼€å‘äº†æ”¹å˜æ¸¸æˆè§„åˆ™çš„åè®®QUICã€‚å®ƒåˆ©ç”¨UDPå¹¶è§£å†³äº†TCPçš„æ‰€æœ‰ä¸è¶³ã€‚é™ä½å»¶è¿Ÿã€å¤šè·¯å¤ç”¨ã€å¢å¼ºå®‰å…¨æ€§å’Œè¿æ¥è¿ç§»æ˜¯QUICçš„ä¸€äº›æ˜¾è‘—ç‰¹ç‚¹ã€‚QUICå¸¦æ¥çš„åˆ›æ–°è§£å†³äº†é˜Ÿå¤´é˜»å¡ç­‰é—®é¢˜ã€‚\nåƒè°·æ­Œå’ŒFacebookè¿™æ ·çš„å¤§å‹ç§‘æŠ€å…¬å¸é€šè¿‡åœ¨HTTP/3ä¸­é‡‡ç”¨QUICï¼Œåœ¨æ€§èƒ½ä¸Šå–å¾—äº†æ˜¾è‘—æå‡ã€‚éšç€é‡‡ç”¨ç‡çš„ä¸Šå‡å’Œæ—¥ç›Šå¢é•¿çš„æ”¯æŒï¼ŒHTTP/3å°†æˆä¸ºäº’è”ç½‘é€šä¿¡çš„æ ‡å‡†ã€‚åœ¨æœªæ¥å‡ å¹´ï¼Œäº’è”ç½‘å°†å‘å±•å¹¶è¿‡æ¸¡åˆ°HTTP/3ï¼Œä»¥å®ç°æ•ˆç‡ã€å¯é æ€§å’Œæ€§èƒ½ã€‚\nå‚è€ƒæ–‡çŒ® TCP VS UDP æ¢— ä¸ºä»€ä¹ˆHTTP/3.0æ­£åœ¨åå™¬ä¸–ç•Œï¼Ÿ Pinterestç°åœ¨ä½¿ç”¨HTTP/3.0 ä¸è°·æ­Œå¯¹ç­‰ - QUIC ","date":"2024-06-14T09:38:42+08:00","image":"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd0e30c17-275b-4a94-8883-74c546ead5e5_5955x3350.jpeg","permalink":"https://huizhou92.com/zh-cn/p/quic-%E5%A6%82%E4%BD%95%E5%9C%A8%E9%80%9F%E5%BA%A6%E5%92%8C%E5%AE%89%E5%85%A8%E6%80%A7%E6%96%B9%E9%9D%A2%E5%8F%96%E4%BB%A3-tcp/","title":"QUIC å¦‚ä½•åœ¨é€Ÿåº¦å’Œå®‰å…¨æ€§æ–¹é¢å–ä»£ TCPï¼Ÿ"},{"content":"Compare the performance, advantages and disadvantages of fastjson, gjson, and jsonparser.\nå¯¹æ¯” fastjsonï¼Œgjsonï¼Œjsonparser çš„æ€§èƒ½ä»¥åŠä¼˜ç¼ºç‚¹ã€‚\nè¿™ç¯‡æ–‡ç« æ·±å…¥æºç åˆ†æä¸€ä¸‹åœ¨ Go ä¸­æ ‡å‡†åº“æ˜¯å¦‚ä½•è§£æ JSON çš„ï¼Œç„¶åå†çœ‹çœ‹æœ‰å“ªäº›æ¯”è¾ƒæµè¡Œçš„ Json è§£æåº“ï¼Œä»¥åŠè¿™äº›åº“éƒ½æœ‰ä»€ä¹ˆç‰¹ç‚¹ï¼Œåœ¨ä»€ä¹ˆåœºæ™¯ä¸‹èƒ½æ›´å¥½çš„å¸®åŠ©æˆ‘ä»¬è¿›è¡Œå¼€å‘ã€‚\nThis article is first published in the medium MPP plan. If you are a medium user, please follow me on the medium. Thank you very much.\nå…¶å®æœ¬æ¥æˆ‘æ˜¯æ²¡æ‰“ç®—å»çœ‹ JSON åº“çš„æ€§èƒ½é—®é¢˜çš„ï¼Œä½†æ˜¯æœ€è¿‘æˆ‘å¯¹æˆ‘çš„é¡¹ç›®åšäº†ä¸€æ¬¡ pprofï¼Œä»ä¸‹é¢çš„ç«ç„°å›¾ä¸­å¯ä»¥å‘ç°åœ¨ä¸šåŠ¡é€»è¾‘å¤„ç†ä¸­ï¼Œæœ‰ä¸€åŠå¤šçš„æ€§èƒ½æ¶ˆè€—éƒ½æ˜¯åœ¨ JSON è§£æè¿‡ç¨‹ä¸­ï¼Œæ‰€ä»¥å°±æœ‰äº†è¿™ç¯‡æ–‡ç« ã€‚\nè¿™ç¯‡æ–‡ç« æ·±å…¥æºç åˆ†æä¸€ä¸‹åœ¨ Go ä¸­æ ‡å‡†åº“æ˜¯å¦‚ä½•è§£æ JSON çš„ï¼Œç„¶åå†çœ‹çœ‹æœ‰å“ªäº›æ¯”è¾ƒæµè¡Œçš„ Json è§£æåº“ï¼Œä»¥åŠè¿™äº›åº“éƒ½æœ‰ä»€ä¹ˆç‰¹ç‚¹ï¼Œåœ¨ä»€ä¹ˆåœºæ™¯ä¸‹èƒ½æ›´å¥½çš„å¸®åŠ©æˆ‘ä»¬è¿›è¡Œå¼€å‘ã€‚\nä¸»è¦ä»‹ç»åˆ†æä»¥ä¸‹å‡ ä¸ªåº“ï¼ˆ2024-06-13ï¼‰ï¼š\nåº“å Star æ ‡å‡†åº“ JSON Unmarshal valyala/fastjson 2.2 k tidwall/gjson 13.8 k buger/jsonparser 5.4 k æ ‡å‡†åº“ JSON Unmarshal 1 func Unmarshal(data []byte, v interface{}) å®˜æ–¹çš„ JSON è§£æåº“éœ€è¦ä¼ ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯éœ€è¦è¢«åºåˆ—åŒ–çš„å¯¹è±¡ï¼Œå¦ä¸€ä¸ªæ˜¯è¡¨ç¤ºè¿™ä¸ªå¯¹è±¡çš„ç±»å‹ã€‚\nåœ¨çœŸæ­£æ‰§è¡Œ JSON è§£æä¹‹å‰ä¼šè°ƒç”¨ reflect.ValueOfæ¥è·å–å‚æ•° v çš„åå°„å¯¹è±¡ã€‚ç„¶åä¼šè·å–åˆ°ä¼ å…¥çš„ data å¯¹è±¡çš„å¼€å¤´éç©ºå­—ç¬¦æ¥ç•Œå®šè¯¥ç”¨å“ªç§æ–¹å¼æ¥è¿›è¡Œè§£æã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 func (d *decodeState) value(v reflect.Value) error { switch d.opcode { default: panic(phasePanicMsg) // æ•°ç»„ case scanBeginArray: ... // ç»“æ„ä½“æˆ–map case scanBeginObject: ... // å­—é¢é‡ï¼ŒåŒ…æ‹¬ intã€stringã€float ç­‰ case scanBeginLiteral: ... } return nil } å¦‚æœè¢«è§£æçš„å¯¹è±¡æ˜¯ä»¥[å¼€å¤´ï¼Œé‚£ä¹ˆè¡¨ç¤ºè¿™æ˜¯ä¸ªæ•°ç»„å¯¹è±¡ä¼šè¿›å…¥åˆ° scanBeginArray åˆ†æ”¯ï¼›å¦‚æœæ˜¯ä»¥{å¼€å¤´ï¼Œè¡¨æ˜è¢«è§£æçš„å¯¹è±¡æ˜¯ä¸€ä¸ªç»“æ„ä½“æˆ– mapï¼Œé‚£ä¹ˆè¿›å…¥åˆ° scanBeginObject åˆ†æ”¯ ç­‰ç­‰ã€‚\nå°ç»“ é€šè¿‡çœ‹ Unmarshal æºç ä¸­å¯ä»¥çœ‹åˆ°å…¶ä¸­ä½¿ç”¨äº†å¤§é‡çš„åå°„æ¥è·å–å­—æ®µå€¼ï¼Œå¦‚æœæ˜¯å¤šå±‚åµŒå¥—çš„ JSON çš„è¯ï¼Œé‚£ä¹ˆè¿˜éœ€è¦é€’å½’è¿›è¡Œåå°„è·å–å€¼ï¼Œå¯æƒ³è€ŒçŸ¥æ€§èƒ½æ˜¯éå¸¸å·®çš„äº†ã€‚\nä½†æ˜¯å¦‚æœå¯¹æ€§èƒ½ä¸æ˜¯é‚£ä¹ˆçœ‹é‡çš„è¯ï¼Œç›´æ¥ä½¿ç”¨å®ƒå…¶å®æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„é€‰æ‹©ï¼ŒåŠŸèƒ½å®Œå–„çš„åŒæ—¶å¹¶ä¸”å®˜æ–¹ä¹Ÿä¸€ç›´åœ¨è¿­ä»£ä¼˜åŒ–ï¼Œè¯´ä¸å®šåœ¨ä»¥åçš„ç‰ˆæœ¬ä¸­æ€§èƒ½ä¹Ÿä¼šå¾—åˆ°è´¨çš„é£è·ƒã€‚å¹¶ä¸”ä»–åº”è¯¥æ˜¯å”¯ä¸€ä¸€ä¸ªå¯ä»¥ç›´æ¥æŠŠJSONå¯¹è±¡è½¬æˆ go struct çš„ã€‚\nfastjson è¿™ä¸ªåº“çš„ç‰¹ç‚¹å’Œå®ƒçš„åå­—ä¸€æ ·å°±æ˜¯å¿«ï¼Œå®ƒçš„ä»‹ç»é¡µæ˜¯è¿™ä¹ˆè¯´çš„ï¼š\nFast. As usual, up to 15x faster than the standard encoding/json.\nå®ƒçš„ä½¿ç”¨ä¹Ÿæ˜¯éå¸¸çš„ç®€å•,å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 func main() { var p fastjson.Parser v, _ := p.Parse(`{ \u0026#34;str\u0026#34;: \u0026#34;bar\u0026#34;, \u0026#34;int\u0026#34;: 123, \u0026#34;float\u0026#34;: 1.23, \u0026#34;bool\u0026#34;: true, \u0026#34;arr\u0026#34;: [1, \u0026#34;foo\u0026#34;, {}] }`) fmt.Printf(\u0026#34;foo=%s\\n\u0026#34;, v.GetStringBytes(\u0026#34;str\u0026#34;)) fmt.Printf(\u0026#34;int=%d\\n\u0026#34;, v.GetInt(\u0026#34;int\u0026#34;)) fmt.Printf(\u0026#34;float=%f\\n\u0026#34;, v.GetFloat64(\u0026#34;float\u0026#34;)) fmt.Printf(\u0026#34;bool=%v\\n\u0026#34;, v.GetBool(\u0026#34;bool\u0026#34;)) fmt.Printf(\u0026#34;arr.1=%s\\n\u0026#34;, v.GetStringBytes(\u0026#34;arr\u0026#34;, \u0026#34;1\u0026#34;)) } // Output: // foo=bar // int=123 // float=1.230000 // bool=true // arr.1=foo ä½¿ç”¨ fastjson é¦–å…ˆè¦å°†è¢«è§£æçš„ JSON ä¸²äº¤ç»™ Parser è§£æå™¨è¿›è¡Œè§£æï¼Œç„¶åé€šè¿‡ Parse æ–¹æ³•è¿”å›çš„å¯¹è±¡æ¥è·å–ã€‚å¦‚æœæ˜¯åµŒå¥—å¯¹è±¡å¯ä»¥ç›´æ¥åœ¨ Get æ–¹æ³•ä¼ å‚çš„æ—¶å€™ä¼ å…¥ç›¸åº”çš„çˆ¶å­ key å³å¯ã€‚\nåˆ†æ fastjson åœ¨è®¾è®¡ä¸Šå’Œæ ‡å‡†åº“ Unmarshal ä¸åŒçš„æ˜¯ï¼Œå®ƒå°† JSON è§£æåˆ’åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼šParseã€Getã€‚\nParse è´Ÿè´£å°† JSON ä¸²è§£ææˆä¸ºä¸€ä¸ªç»“æ„ä½“å¹¶è¿”å›ï¼Œç„¶åé€šè¿‡è¿”å›çš„ç»“æ„ä½“æ¥è·å–æ•°æ®ã€‚åœ¨ Parse è§£æçš„è¿‡ç¨‹æ˜¯æ— é”çš„ï¼Œæ‰€ä»¥å¦‚æœæƒ³è¦åœ¨å¹¶å‘åœ°è°ƒç”¨ Parse è¿›è¡Œè§£æéœ€è¦ä½¿ç”¨ ParserPool\nfastjson æ˜¯ä»ä¸Šå¾€ä¸‹ä¾æ¬¡éå† JSON ï¼Œç„¶åè§£æå¥½çš„æ•°æ®å­˜æ”¾åœ¨ Value ç»“æ„ä½“ä¸­ï¼š\n1 type Value struct { o Object a []*Value s string t Type } è¿™ä¸ªç»“æ„ä½“éå¸¸ç®€æˆï¼š\no Objectï¼šè¡¨ç¤ºè¢«è§£æçš„ç»“æ„æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼› a []*Valueï¼šè¡¨ç¤ºè¡¨ç¤ºè¢«è§£æçš„ç»“æ„æ˜¯ä¸ªæ•°ç»„ï¼› s stringï¼šå¦‚æœè¢«è§£æçš„ç»“æ„ä¸æ˜¯å¯¹è±¡ä¹Ÿä¸æ˜¯æ•°ç»„ï¼Œé‚£ä¹ˆå…¶ä»–ç±»å‹çš„å€¼ä¼šä»¥å­—ç¬¦ä¸²çš„å½¢å¼å­˜æ”¾åœ¨è¿™ä¸ªå­—æ®µä¸­ï¼› t Typeï¼šè¡¨ç¤ºè¿™ä¸ªç»“æ„çš„ç±»å‹ï¼Œæœ‰ TypeObjectã€TypeArrayã€TypeStringã€TypeNumberç­‰ã€‚ 1 type Object struct { kvs []kv keysUnescaped bool } type kv struct { k string v *Value } è¿™ä¸ªç»“æ„å­˜æ”¾å¯¹è±¡çš„é€’å½’ç»“æ„ã€‚å¦‚æœæŠŠä¸Šé¢ä¾‹å­ä¸­çš„ JSON ä¸²è§£æå®Œæ¯•ä¹‹åå°±æ˜¯è¿™æ ·ä¸€ä¸ªç»“æ„ï¼š\nä»£ç  åœ¨ä»£ç å®ç°ä¸Šï¼Œç”±äºæ²¡æœ‰äº†åå°„éƒ¨åˆ†çš„ä»£ç ï¼Œæ‰€ä»¥æ•´ä¸ªè§£æè¿‡ç¨‹å˜å¾—éå¸¸çš„æ¸…çˆ½ã€‚æˆ‘ä»¬ç›´æ¥çœ‹çœ‹ä¸»å¹²éƒ¨åˆ†çš„è§£æï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 func parseValue(s string, c *cache, depth int) (*Value, string, error) { if len(s) == 0 { return nil, s, fmt.Errorf(\u0026#34;cannot parse empty string\u0026#34;) } depth++ // æœ€å¤§æ·±åº¦çš„jsonä¸²ä¸èƒ½è¶…è¿‡MaxDepth if depth \u0026gt; MaxDepth { return nil, s, fmt.Errorf(\u0026#34;too big depth for the nested JSON; it exceeds %d\u0026#34;, MaxDepth) } // è§£æå¯¹è±¡ if s[0] == \u0026#39;{\u0026#39; { v, tail, err := parseObject(s[1:], c, depth) if err != nil { return nil, tail, fmt.Errorf(\u0026#34;cannot parse object: %s\u0026#34;, err) } return v, tail, nil } // è§£ææ•°ç»„ if s[0] == \u0026#39;[\u0026#39; { ... } // è§£æå­—ç¬¦ä¸² if s[0] == \u0026#39;\u0026#34;\u0026#39; { ... } ... return v, tail, nil } parseValue ä¼šæ ¹æ®å­—ç¬¦ä¸²çš„ç¬¬ä¸€ä¸ªéç©ºå­—ç¬¦æ¥åˆ¤æ–­è¦è§£æçš„ç±»å‹ã€‚è¿™é‡Œç”¨ä¸€ä¸ªå¯¹è±¡ç±»å‹æ¥åšè§£æï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 func parseObject(s string, c *cache, depth int) (*Value, string, error) { ... o := c.getValue() o.t = TypeObject o.o.reset() for { var err error // è·å–Ojbectç»“æ„ä½“ä¸­çš„ kv å¯¹è±¡ kv := o.o.getKV() ... // è§£æ key å€¼ kv.k, s, err = parseRawKey(s[1:]) ... // é€’å½’è§£æ value å€¼ kv.v, s, err = parseValue(s, c, depth) ... // é‡åˆ° ï¼Œå·ç»§ç»­å¾€ä¸‹è§£æ if s[0] == \u0026#39;,\u0026#39; { s = s[1:] continue } // è§£æå®Œæ¯• if s[0] == \u0026#39;}\u0026#39; { return o, s[1:], nil } return nil, s, fmt.Errorf(\u0026#34;missing \u0026#39;,\u0026#39; after object value\u0026#34;) } } parseObject å‡½æ•°ä¹Ÿéå¸¸ç®€å•ï¼Œåœ¨å¾ªç¯ä½“ä¸­ä¼šè·å– key å€¼ï¼Œç„¶åè°ƒç”¨ parseValue é€’å½’è§£æ value å€¼ï¼Œä»ä¸Šå¾€ä¸‹ä¾æ¬¡è§£æ JSON å¯¹è±¡ï¼Œç›´åˆ°æœ€åé‡åˆ° }é€€å‡ºã€‚\nå°ç»“ é€šè¿‡ä¸Šé¢çš„åˆ†æå¯ä»¥çŸ¥é“ fastjson åœ¨å®ç°ä¸Šæ¯”æ ‡å‡†åº“ç®€å•ä¸å°‘ï¼Œæ€§èƒ½ä¹Ÿé«˜ä¸Šä¸å°‘ã€‚ä½¿ç”¨ Parse è§£æå¥½ JSON æ ‘ä¹‹åå¯ä»¥å¤šæ¬¡åå¤ä½¿ç”¨ï¼Œé¿å…äº†éœ€è¦åå¤è§£æè¿›è€Œæå‡æ€§èƒ½ã€‚\nä½†æ˜¯å®ƒçš„åŠŸèƒ½æ˜¯éå¸¸çš„ç®€é™‹çš„ï¼Œæ²¡æœ‰å¸¸ç”¨çš„å¦‚ JSON è½¬ Struct æˆ– JSON è½¬ map çš„æ“ä½œã€‚å¦‚æœåªæ˜¯æƒ³ç®€å•çš„è·å– JSON ä¸­çš„å€¼ï¼Œé‚£ä¹ˆä½¿ç”¨è¿™ä¸ªåº“æ˜¯éå¸¸æ–¹ä¾¿çš„ï¼Œä½†æ˜¯å¦‚æœæƒ³è¦æŠŠ JSON å€¼è½¬åŒ–æˆä¸€ä¸ªç»“æ„ä½“å°±éœ€è¦è‡ªå·±åŠ¨æ‰‹ä¸€ä¸ªä¸ªè®¾å€¼äº†ã€‚\nGJSON GJSON åœ¨æˆ‘çš„æµ‹è¯•ä¸­ï¼Œè™½ç„¶æ€§èƒ½æ˜¯æ²¡æœ‰ fastjson è¿™ä¹ˆæè‡´ï¼Œä½†æ˜¯åŠŸèƒ½æ˜¯éå¸¸å®Œå–„ï¼Œæ€§èƒ½ä¹Ÿæ˜¯ç›¸å½“ OK çš„ï¼Œä¸‹é¢å…ˆç®€å•ä»‹ç»ä¸€ä¸‹ GJSON çš„åŠŸèƒ½ã€‚\nGJSON çš„ä½¿ç”¨æ˜¯å’Œ fastjson å·®ä¸å¤šçš„ï¼Œä¹Ÿæ˜¯éå¸¸çš„ç®€å•ï¼Œåªè¦åœ¨å‚æ•°ä¸­ä¼ å…¥ json ä¸²ä»¥åŠéœ€è¦è·å–çš„å€¼å³å¯ï¼š\n1 2 json := `{\u0026#34;name\u0026#34;:{\u0026#34;first\u0026#34;:\u0026#34;li\u0026#34;,\u0026#34;last\u0026#34;:\u0026#34;dj\u0026#34;},\u0026#34;age\u0026#34;:18}` lastName := gjson.Get(json, \u0026#34;name.last\u0026#34;) é™¤äº†è¿™ä¸ªåŠŸèƒ½ä»¥å¤–è¿˜å¯ä»¥è¿›è¡Œç®€å•çš„æ¨¡ç³ŠåŒ¹é…ï¼Œæ”¯æŒåœ¨é”®ä¸­åŒ…å«é€šé…ç¬¦*å’Œ?ï¼Œ*åŒ¹é…ä»»æ„å¤šä¸ªå­—ç¬¦ï¼Œ?åŒ¹é…å•ä¸ªå­—ç¬¦ï¼Œå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 json := `{ \u0026#34;name\u0026#34;:{\u0026#34;first\u0026#34;:\u0026#34;Tom\u0026#34;, \u0026#34;last\u0026#34;: \u0026#34;Anderson\u0026#34;}, \u0026#34;age\u0026#34;: 37, \u0026#34;children\u0026#34;: [\u0026#34;Sara\u0026#34;, \u0026#34;Alex\u0026#34;, \u0026#34;Jack\u0026#34;] }` fmt.Println(\u0026#34;third child*:\u0026#34;, gjson.Get(json, \u0026#34;child*.2\u0026#34;)) fmt.Println(\u0026#34;first c?ild:\u0026#34;, gjson.Get(json, \u0026#34;c?ildren.0\u0026#34;)) child*.2ï¼šé¦–å…ˆchild*åŒ¹é…childrenï¼Œ.2è¯»å–ç¬¬ 3 ä¸ªå…ƒç´ ï¼› c?ildren.0ï¼šc?ildrenåŒ¹é…åˆ°childrenï¼Œ.0è¯»å–ç¬¬ä¸€ä¸ªå…ƒç´ ï¼› é™¤äº†æ¨¡ç³ŠåŒ¹é…ä»¥å¤–è¿˜æ”¯æŒä¿®é¥°ç¬¦æ“ä½œï¼š\n1 2 3 4 5 6 json := `{ \u0026#34;name\u0026#34;:{\u0026#34;first\u0026#34;:\u0026#34;Tom\u0026#34;, \u0026#34;last\u0026#34;: \u0026#34;Anderson\u0026#34;}, \u0026#34;age\u0026#34;: 37, \u0026#34;children\u0026#34;: [\u0026#34;Sara\u0026#34;, \u0026#34;Alex\u0026#34;, \u0026#34;Jack\u0026#34;] }` fmt.Println(\u0026#34;third child*:\u0026#34;, gjson.Get(json, \u0026#34;children|@reverse\u0026#34;)) children|@reverse å…ˆè¯»å–æ•°ç»„childrenï¼Œç„¶åä½¿ç”¨ä¿®é¥°ç¬¦@reverseç¿»è½¬ä¹‹åè¿”å›ï¼Œè¾“å‡ºã€‚\n1 nestedJSON := `{\u0026#34;nested\u0026#34;: [\u0026#34;one\u0026#34;, \u0026#34;two\u0026#34;, [\u0026#34;three\u0026#34;, \u0026#34;four\u0026#34;]]}` fmt.Println(gjson.Get(nestedJSON, \u0026#34;nested|@flatten\u0026#34;)) @flattenå°†æ•°ç»„nestedçš„å†…å±‚æ•°ç»„å¹³å¦åˆ°å¤–å±‚åè¿”å›ï¼š\n1 [\u0026#34;one\u0026#34;,\u0026#34;two\u0026#34;,\u0026#34;three\u0026#34;, \u0026#34;four\u0026#34;] ç­‰ç­‰è¿˜æœ‰ä¸€äº›å…¶ä»–æœ‰æ„æ€çš„åŠŸèƒ½ï¼Œå¤§å®¶å¯ä»¥å»æŸ¥é˜…ä¸€ä¸‹å®˜æ–¹æ–‡æ¡£ã€‚\nåˆ†æ GJSON çš„ Get æ–¹æ³•å‚æ•°æ˜¯ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼Œä¸€ä¸ªæ˜¯ JSON ä¸²ï¼Œå¦ä¸€ä¸ªå«åš Path è¡¨ç¤ºéœ€è¦è·å–çš„ JSON å€¼çš„åŒ¹é…è·¯å¾„ã€‚\nåœ¨ GJSON ä¸­å› ä¸ºè¦æ»¡è¶³å¾ˆå¤šçš„å®šä¹‰çš„è§£æåœºæ™¯ï¼Œæ‰€ä»¥è§£ææ˜¯åˆ†ä¸ºä¸¤éƒ¨åˆ†çš„ï¼Œéœ€è¦å…ˆè§£æå¥½ Path ä¹‹åæ‰å»éå†è§£æ JSON ä¸²ã€‚\nåœ¨è§£æè¿‡ç¨‹ä¸­å¦‚æœé‡åˆ°å¯ä»¥åŒ¹é…ä¸Šçš„å€¼ï¼Œé‚£ä¹ˆä¼šç›´æ¥è¿”å›ï¼Œä¸éœ€è¦ç»§ç»­å¾€ä¸‹éå†ï¼Œå¦‚æœæ˜¯åŒ¹é…å¤šä¸ªå€¼ï¼Œé‚£ä¹ˆä¼šä¸€ç›´éå†å®Œæ•´ä¸ª JSON ä¸²ã€‚å¦‚æœé‡åˆ°æŸä¸ª Path åœ¨ JSON ä¸²ä¸­åŒ¹é…ä¸åˆ°ï¼Œé‚£ä¹ˆä¹Ÿæ˜¯éœ€è¦éå†å®Œæ•´ä¸ª JSON ä¸²ã€‚\nåœ¨è§£æçš„è¿‡ç¨‹ä¸­ä¹Ÿä¸ä¼šåƒ fastjson ä¸€æ ·å°†è§£æçš„å†…å®¹ä¿å­˜åœ¨ä¸€ä¸ªç»“æ„ä½“ä¸­ï¼Œå¯ä»¥åå¤çš„åˆ©ç”¨ã€‚æ‰€ä»¥å½“è°ƒç”¨ GetMany æƒ³è¦è¿”å›å¤šä¸ªå€¼çš„æ—¶å€™ï¼Œå…¶å®ä¹Ÿæ˜¯éœ€è¦éå† JSON ä¸²å¤šæ¬¡ï¼Œå› æ­¤æ•ˆç‡ä¼šæ¯”è¾ƒä½ã€‚\né™¤æ­¤ä¹‹å¤–ï¼Œåœ¨è§£æ JSON çš„æ—¶å€™å¹¶ä¸ä¼šå¯¹å®ƒè¿›è¡Œæ ¡éªŒï¼Œå³ä½¿è¿™ä¸ªæ”¾å…¥çš„å­—ç¬¦ä¸²ä¸æ˜¯ä¸ª JSON ä¹Ÿä¼šç…§æ ·è§£æï¼Œæ‰€ä»¥éœ€è¦ç”¨æˆ·è‡ªå·±å»ç¡®ä¿æ”¾å…¥çš„æ˜¯ JSON ã€‚\nä»£ç  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 func Get(json, path string) Result { // è§£æ path if len(path) \u0026gt; 1 { ... } var i int var c = \u0026amp;parseContext{json: json} if len(path) \u0026gt;= 2 \u0026amp;\u0026amp; path[0] == \u0026#39;.\u0026#39; \u0026amp;\u0026amp; path[1] == \u0026#39;.\u0026#39; { c.lines = true parseArray(c, 0, path[2:]) } else { // æ ¹æ®ä¸åŒçš„å¯¹è±¡è¿›è¡Œè§£æ,è¿™é‡Œä¼šä¸€ç›´å¾ªç¯ï¼Œç›´åˆ°æ‰¾åˆ° \u0026#39;{\u0026#39; æˆ– \u0026#39;[\u0026#39; for ; i \u0026lt; len(c.json); i++ { if c.json[i] == \u0026#39;{\u0026#39; { i++ parseObject(c, i, path) break } if c.json[i] == \u0026#39;[\u0026#39; { i++ parseArray(c, i, path) break } } } if c.piped { res := c.value.Get(c.pipe) res.Index = 0 return res } fillIndex(json, c) return c.value } Get æ–¹æ³•é‡Œé¢å¯ä»¥çœ‹åˆ°æœ‰å¾ˆé•¿ä¸€ä¸²çš„ä»£ç æ˜¯ç”¨æ¥è§£æå„ç§ Pathï¼Œç„¶åä¸€ä¸ª for å¾ªç¯ä¸€ç›´éå† JSON ç›´åˆ°æ‰¾åˆ° â€˜{â€˜ æˆ– â€˜[â€˜ï¼Œç„¶åæ‰è¿›è¡Œç›¸åº”çš„é€»è¾‘è¿›è¡Œå¤„ç†ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 func parseObject(c *parseContext, i int, path string) (int, bool) { var pmatch, kesc, vesc, ok, hit bool var key, val string rp := parseObjectPath(path) if !rp.more \u0026amp;\u0026amp; rp.piped { c.pipe = rp.pipe c.piped = true } // åµŒå¥—ä¸¤ä¸ª for å¾ªç¯ å¯»æ‰¾ key å€¼ for i \u0026lt; len(c.json) { for ; i \u0026lt; len(c.json); i++ { if c.json[i] == \u0026#39;\u0026#34;\u0026#39; { i++ var s = i for ; i \u0026lt; len(c.json); i++ { if c.json[i] \u0026gt; \u0026#39;\\\\\u0026#39; { continue } // æ‰¾åˆ° key å€¼è·³è½¬åˆ° parse_key_string_done if c.json[i] == \u0026#39;\u0026#34;\u0026#39; { i, key, kesc, ok = i+1, c.json[s:i], false, true goto parse_key_string_done } ... } key, kesc, ok = c.json[s:], false, false // ç›´æ¥break parse_key_string_done: break } if c.json[i] == \u0026#39;}\u0026#39; { return i + 1, false } } if !ok { return i, false } // æ ¡éªŒæ˜¯å¦æ˜¯æ¨¡ç³ŠåŒ¹é… if rp.wild { if kesc { pmatch = match.Match(unescape(key), rp.part) } else { pmatch = match.Match(key, rp.part) } } else { if kesc { pmatch = rp.part == unescape(key) } else { pmatch = rp.part == key } } // è§£æ value hit = pmatch \u0026amp;\u0026amp; !rp.more for ; i \u0026lt; len(c.json); i++ { switch c.json[i] { default: continue case \u0026#39;\u0026#34;\u0026#39;: i++ i, val, vesc, ok = parseString(c.json, i) if !ok { return i, false } if hit { if vesc { c.value.Str = unescape(val[1 : len(val)-1]) } else { c.value.Str = val[1 : len(val)-1] } c.value.Raw = val c.value.Type = String return i, true } case \u0026#39;{\u0026#39;: if pmatch \u0026amp;\u0026amp; !hit { i, hit = parseObject(c, i+1, rp.path) if hit { return i, true } } else { i, val = parseSquash(c.json, i) if hit { c.value.Raw = val c.value.Type = JSON return i, true } } ... break } } return i, false } åœ¨ä¸Šé¢çœ‹ parseObject è¿™æ®µä»£ç çš„æ—¶å€™å…¶å®ä¸æ˜¯æƒ³è®©å¤§å®¶å­¦ä¹ å¦‚ä½•è§£æ JSONï¼Œä»¥åŠéå†å­—ç¬¦ä¸²ï¼Œè€Œæ˜¯æƒ³è¦è®©å¤§å®¶çœ‹çœ‹ä¸€ä¸ª bad case æ˜¯æ€æ ·çš„ã€‚for å¾ªç¯ä¸€å±‚å¥—ä¸€å±‚ï¼Œif ä¸€ä¸ªæ¥ä»¥ä¸€ä¸ªçœ‹å¾—æˆ‘ San å€¼ç‹‚æ‰ï¼Œè¿™ç‰‡ä»£ç å¤§å®¶æ˜¯ä¸æ˜¯çœ‹èµ·æ¥å¾ˆçœ¼ç†Ÿï¼Ÿæ˜¯ä¸æ˜¯æœ‰ç‚¹åƒå·¥ä½œä¸­é‡åˆ°çš„æŸä¸ªåŒäº‹å†™çš„ä»£ç ï¼Ÿ\nå°ç»“ ä¼˜ç‚¹ï¼š\næ€§èƒ½ç›¸å¯¹æ ‡å‡†åº“æ¥è¯´è¿˜ç®—ä¸é”™ï¼› å¯ç©æ€§é«˜ï¼Œå¯ä»¥å„ç§æ£€ç´¢ã€è‡ªå®šä¹‰è¿”å›å€¼ï¼Œè¿™ç‚¹éå¸¸æ–¹ä¾¿ï¼›\nç¼ºç‚¹ï¼š ä¸ä¼šæ ¡éªŒ JSON çš„æ­£ç¡®æ€§ï¼› ä»£ç çš„ Code smell å¾ˆé‡ã€‚ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœéœ€è¦è§£æè¿”å› JSON çš„å€¼çš„è¯ï¼ŒGetMany å‡½æ•°ä¼šæ ¹æ®æŒ‡å®šçš„ key å€¼æ¥ä¸€æ¬¡æ¬¡éå† JSON å­—ç¬¦ä¸²ï¼Œè§£æä¸º map å¯ä»¥å‡å°‘éå†æ¬¡æ•°ã€‚\njsonparser è¿™ä¹Ÿæ˜¯ä¸€ä¸ªæ¯”è¾ƒçƒ­é—¨ï¼Œå¹¶ä¸”å·ç§°é«˜æ€§èƒ½ï¼Œèƒ½æ¯”æ ‡å‡†åº“å¿«åå€çš„è§£æé€Ÿåº¦ã€‚\nåˆ†æ jsonparser ä¹Ÿæ˜¯ä¼ å…¥ä¸€ä¸ª JSON çš„ byte åˆ‡ç‰‡ï¼Œä»¥åŠå¯ä»¥é€šè¿‡ä¼ å…¥å¤šä¸ª key å€¼æ¥å¿«é€Ÿå®šä½åˆ°ç›¸åº”çš„å€¼ï¼Œå¹¶è¿”å›ã€‚\nå’Œ GJSON ä¸€æ ·ï¼Œåœ¨è§£æè¿‡ç¨‹ä¸­æ˜¯ä¸ä¼šåƒ fastjson ä¸€æ ·æœ‰ä¸ªæ•°æ®ç»“æ„ç¼“å­˜å·²è§£æè¿‡çš„ JSONå­—ç¬¦ä¸²ï¼Œä½†æ˜¯é‡åˆ°éœ€è¦è§£æå¤šä¸ªå€¼çš„æƒ…å†µå¯ä»¥ä½¿ç”¨ EachKey å‡½æ•°æ¥è§£æå¤šä¸ªå€¼ï¼Œåªéœ€è¦éå†ä¸€æ¬¡ JSONå­—ç¬¦ä¸²å³å¯å®ç°è·å–å¤šä¸ªå€¼çš„æ“ä½œã€‚\nå¦‚æœé‡åˆ°å¯ä»¥åŒ¹é…ä¸Šçš„å€¼ï¼Œé‚£ä¹ˆä¼šç›´æ¥è¿”å›ï¼Œä¸éœ€è¦ç»§ç»­å¾€ä¸‹éå†ï¼Œå¦‚æœæ˜¯åŒ¹é…å¤šä¸ªå€¼ï¼Œé‚£ä¹ˆä¼šä¸€ç›´éå†å®Œæ•´ä¸ª JSON ä¸²ã€‚å¦‚æœé‡åˆ°æŸä¸ª Path åœ¨ JSON ä¸²ä¸­åŒ¹é…ä¸åˆ°ï¼Œé‚£ä¹ˆä¹Ÿæ˜¯éœ€è¦éå†å®Œæ•´ä¸ª JSON ä¸²ã€‚\nå¹¶ä¸”åœ¨éå† JSON ä¸²çš„æ—¶å€™é€šè¿‡å¾ªç¯çš„æ–¹å¼æ¥å‡å°‘é€’å½’çš„ä½¿ç”¨ï¼Œå‡å°‘äº†è°ƒç”¨æ ˆçš„æ·±åº¦ï¼Œä¸€å®šç¨‹åº¦ä¸Šä¹Ÿæ˜¯å¯ä»¥æå‡æ€§èƒ½ã€‚\nåœ¨åŠŸèƒ½æ€§ä¸Š ArrayEachã€ObjectEachã€EachKey ç­‰ä¸‰ä¸ªå‡½æ•°éƒ½å¯ä»¥ä¼ å…¥ä¸€ä¸ªè‡ªå®šä¹‰çš„å‡½æ•°ï¼Œé€šè¿‡å‡½æ•°æ¥å®ç°ä¸ªæ€§åŒ–çš„éœ€æ±‚ï¼Œä½¿å¾—å®ç”¨æ€§å¤§å¤§å¢å¼ºã€‚\nå¯¹äº jsonparser æ¥è¯´ï¼Œä»£ç æ²¡ä»€ä¹ˆå¯åˆ†æçš„ï¼Œéå¸¸çš„æ¸…æ™°ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥è‡ªå·±å»çœ‹çœ‹ã€‚\nå°ç»“ å¯¹äº jsonparser æ¥è¯´ç›¸å¯¹æ ‡å‡†åº“æ¯”è¾ƒè€Œè¨€æ€§èƒ½å¦‚æ­¤é«˜çš„åŸå› å¯ä»¥æ€»ç»“ä¸ºï¼š\nä½¿ç”¨ for å¾ªç¯æ¥å‡å°‘é€’å½’çš„ä½¿ç”¨ï¼› ç›¸æ¯”æ ‡å‡†åº“è€Œè¨€æ²¡æœ‰ä½¿ç”¨åå°„ï¼› åœ¨æŸ¥æ‰¾ç›¸åº”çš„ key å€¼æ‰¾åˆ°äº†ä¾¿ç›´æ¥é€€å‡ºï¼Œå¯ä»¥ä¸ç”¨ç»§ç»­å¾€ä¸‹é€’å½’ï¼› æ‰€æ“ä½œçš„ JSON ä¸²éƒ½æ˜¯å·²è¢«ä¼ å…¥çš„ï¼Œä¸ä¼šå»é‡æ–°å†å»ç”³è¯·æ–°çš„ç©ºé—´ï¼Œå‡å°‘äº†å†…å­˜åˆ†é…ï¼› é™¤æ­¤ä¹‹å¤–åœ¨ api çš„è®¾è®¡ä¸Šä¹Ÿæ˜¯éå¸¸çš„å®ç”¨ï¼ŒArrayEachã€ObjectEachã€EachKey ç­‰ä¸‰ä¸ªå‡½æ•°éƒ½å¯ä»¥ä¼ å…¥ä¸€ä¸ªè‡ªå®šä¹‰çš„å‡½æ•°åœ¨å®é™…çš„ä¸šåŠ¡å¼€å‘ä¸­è§£å†³äº†ä¸å°‘é—®é¢˜ã€‚\nç¼ºç‚¹ä¹Ÿæ˜¯éå¸¸çš„æ˜æ˜¾ï¼Œä¸èƒ½å¯¹ JSON è¿›è¡Œæ ¡éªŒï¼Œå³ä½¿è¿™ä¸ª ä¼ å…¥çš„ä¸æ˜¯ JSONã€‚\næ€§èƒ½å¯¹æ¯” è§£æå° JSON å­—ç¬¦ä¸²\nè§£æä¸€ä¸ªç»“æ„ç®€å•ï¼Œå¤§å°çº¦ 190 bytes çš„å­—ç¬¦ä¸²\nåº“å æ“ä½œ æ¯æ¬¡è¿­ä»£è€—æ—¶ å ç”¨å†…å­˜æ•° åˆ†é…å†…å­˜æ¬¡æ•° æ€§èƒ½ æ ‡å‡†åº“ è§£æä¸ºmap 724 ns/op 976 B/op 51 allocs/op æ…¢ è§£æä¸ºstruct 297 ns/op 256 B/op 5 allocs/op ä¸€èˆ¬ fastjson get 68.2 ns/op 0 B/op 0 allocs/op æœ€å¿« parse 35.1 ns/op 0 B/op 0 allocs/op æœ€å¿« GJSON è½¬map 255 ns/op 1009 B/op 11 allocs/op ä¸€èˆ¬ get 232 ns/op 448 B/op 1 allocs/op ä¸€èˆ¬ jsonparser get 106 ns/op 232 B/op 3 allocs/op å¿« è§£æä¸­ç­‰å¤§å° JSON å­—ç¬¦ä¸²\nè§£æä¸€ä¸ªå…·æœ‰ä¸€å®šå¤æ‚åº¦ï¼Œå¤§å°çº¦ 2.3KB çš„å­—ç¬¦ä¸²\nåº“å æ“ä½œ æ¯æ¬¡è¿­ä»£è€—æ—¶ å ç”¨å†…å­˜æ•° åˆ†é…å†…å­˜æ¬¡æ•° æ€§èƒ½ æ ‡å‡†åº“ è§£æä¸ºmap 4263 ns/op 10212 B/op 208 allocs/op æ…¢ è§£æä¸ºstruct 4789 ns/op 9206 B/op 259 allocs/op æ…¢ fastjson get 285 ns/op 0 B/op 0 allocs/op æœ€å¿« parse 302 ns/op 0 B/op 0 allocs/op æœ€å¿« GJSON è½¬map 2571 ns/op 8539 B/op 83 allocs/op ä¸€èˆ¬ get 1489 ns/op 448 B/op 1 allocs/op ä¸€èˆ¬ jsonparser get 878 ns/op 2728 B/op 5 allocs/op å¿« è§£æå¤§ JSON å­—ç¬¦ä¸²\nè§£æå¤æ‚åº¦æ¯”è¾ƒé«˜ï¼Œå¤§å°çº¦ 2.2MB çš„å­—ç¬¦ä¸²\nåº“å æ“ä½œ æ¯æ¬¡è¿­ä»£è€—æ—¶ å ç”¨å†…å­˜æ•° åˆ†é…å†…å­˜æ¬¡æ•° æ€§èƒ½ æ ‡å‡†åº“ è§£æä¸ºmap 2292959 ns/op 5214009 B/op 95402 allocs/op æ…¢ è§£æä¸ºstruct 1165490 ns/op 2023 B/op 76 allocs/op ä¸€èˆ¬ fastjson get 368056 ns/op 0 B/op 0 allocs/op å¿« parse 371397 ns/op 0 B/op 0 allocs/op å¿« GJSON è½¬map 1901727 ns/op 4788894 B/op 54372 allocs/op ä¸€èˆ¬ get 1322167 ns/op 448 B/op 1 allocs/op ä¸€èˆ¬ jsonparser get 233090 ns/op 1788865 B/op 376 allocs/op æœ€å¿« æ€»ç»“ åœ¨è¿™æ¬¡çš„åˆ†äº«è¿‡ç¨‹ä¸­ï¼Œæˆ‘æ‰¾äº†å¾ˆå¤š JSON çš„è§£æåº“åˆ†åˆ«è¿›è¡Œå¯¹æ¯”åˆ†æï¼Œå¯ä»¥å‘ç°è¿™äº›é«˜æ€§èƒ½çš„è§£æåº“åŸºæœ¬ä¸Šéƒ½æœ‰ä¸€äº›å…±åŒçš„ç‰¹ç‚¹ï¼š\nä¸ä½¿ç”¨åå°„ï¼› é€šè¿‡éå† JSON å­—ç¬¦ä¸²çš„å­—èŠ‚æ¥æŒ¨ä¸ªè§£æï¼› å°½é‡ä½¿ç”¨ä¼ å…¥çš„ JSON å­—ç¬¦ä¸²æ¥è¿›è¡Œè§£æéå†ï¼Œå‡å°‘å†…å­˜åˆ†é…ï¼› ç‰ºç‰²äº†ä¸€å®šçš„å…¼å®¹æ€§ï¼› å°½ç®¡å¦‚æ­¤ï¼Œä½†æ˜¯åŠŸèƒ½ä¸Šï¼Œæ¯ä¸ªéƒ½æœ‰ä¸€å®šçš„ç‰¹è‰² fastjson çš„ api æ“ä½œæœ€ç®€å•ï¼›GJSON æä¾›äº†æ¨¡ç³ŠæŸ¥æ‰¾çš„åŠŸèƒ½ï¼Œè‡ªå®šä¹‰ç¨‹åº¦æœ€é«˜ï¼›jsonparser åœ¨å®ç°é«˜æ€§èƒ½çš„è§£æè¿‡ç¨‹ä¸­ï¼Œè¿˜å¯ä»¥æ’å…¥å›è°ƒå‡½æ•°æ‰§è¡Œï¼Œæä¾›äº†ä¸€å®šç¨‹åº¦ä¸Šçš„ä¾¿åˆ©ã€‚\nç»¼ä¸Šï¼Œå›åˆ°æ–‡ç« çš„å¼€å¤´ä¸­ï¼Œå¯¹äºæˆ‘è‡ªå·±çš„ä¸šåŠ¡æ¥è¯´ï¼Œä¸šåŠ¡ä¹Ÿåªæ˜¯ç®€å•çš„è§£æ http è¯·æ±‚è¿”å›çš„ JSON ä¸²çš„éƒ¨åˆ†å­—æ®µï¼Œå¹¶ä¸”å­—æ®µéƒ½æ˜¯ç¡®å®šçš„ï¼Œæ— éœ€æœç´¢åŠŸèƒ½ï¼Œä½†æ˜¯æœ‰æ—¶å€™éœ€è¦åšä¸€äº›è‡ªå®šä¹‰çš„æ“ä½œï¼Œæ‰€ä»¥å¯¹æˆ‘æ¥è¯´ jsonparser æ˜¯æœ€åˆé€‚çš„ã€‚\næ‰€ä»¥å¦‚æœå„ä½å¯¹æ€§èƒ½æœ‰ä¸€å®šè¦æ±‚ï¼Œä¸å¦¨ç»“åˆè‡ªå·±çš„ä¸šåŠ¡æƒ…å†µæ¥æŒ‘é€‰ä¸€æ¬¾ JSON è§£æå™¨ã€‚\nReference https://github.com/buger/jsonparser\nhttps://github.com/tidwall/gjson\nhttps://github.com/valyala/fastjson\nhttps://github.com/json-iterator/go\nhttps://github.com/mailru/easyjson\nhttps://github.com/Jeffail/gabs\nhttps://github.com/bitly/go-simplejson\n","date":"2024-06-13T17:10:25+08:00","permalink":"https://huizhou92.com/zh-cn/p/%E6%B7%B1%E5%85%A5-go-%E4%B8%AD%E5%90%84%E4%B8%AA%E9%AB%98%E6%80%A7%E8%83%BD-json-%E8%A7%A3%E6%9E%90%E5%BA%93/","title":"æ·±å…¥ Go ä¸­å„ä¸ªé«˜æ€§èƒ½ JSON è§£æåº“"},{"content":"ä¸Šå‘¨ï¼ŒGo 1.23 è¿›å…¥å†»ç»“æœŸï¼Œè¿™æ„å‘³ç€ä¸ä¼šæ·»åŠ ä»»ä½•æ–°åŠŸèƒ½ï¼Œå¹¶ä¸”ä»»ä½•å·²æ·»åŠ çš„åŠŸèƒ½ä¸å¤ªå¯èƒ½è¢«åˆ é™¤ã€‚è¿™æ˜¯ä¸€ä¸ªé¢„è§ˆå³å°†å‘ç”Ÿçš„å˜åŒ–çš„å¥½æœºä¼šã€‚\nè¿™ç¯‡æ–‡ç« ï¼Œæ¥äº†è§£ä¸€ä¸‹ 1.23 è½¬æ­£çš„ iter åŒ…ã€‚\nThis article is first published in the medium MPP plan. If you are a medium user, please follow me in medium. Thank you very much.\nåœ¨Go 1.22ä¸­ï¼Œå¼•å…¥äº†range over funcå®éªŒæ€§åŠŸèƒ½ï¼Œä½†éœ€è¦é€šè¿‡å‚æ•°GOEXPERIMENT=rangefuncå¯ç”¨ã€‚åœ¨Go 1.23ä¸­ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ä»£ç å®ç°è¿™ç§è¿­ä»£æ–¹å¼ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 func Backward(s []string) func(yield func(string) bool) { return func(yield func(string) bool) { for i := len(s) - 1; i \u0026gt;= 0; i-- { yield(strings.ToUpper(s[i])) } } } â€‹ func ToUpperByIter() { sl := []string{\u0026#34;hello\u0026#34;, \u0026#34;world\u0026#34;, \u0026#34;golang\u0026#34;} for v := range Backward(sl) { // do business } } yieldæ˜¯ä¼ é€’ç»™è¿­ä»£å™¨çš„å¯è°ƒç”¨å‡½æ•°çš„å¸¸è§„åç§°ã€‚\næˆ‘ä»¬è€ƒè™‘ä¸€ä¸‹å¦‚ä½•åœ¨ä¸ä½¿ç”¨â€œiterâ€åŒ…çš„æƒ…å†µä¸‹ç¼–å†™ä»£ç æ¥å®ç°ç›¸åŒçš„åŠŸèƒ½ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 func Convert[S any, D any](src []S, mapFn func(s S) D) []D { r := make([]D, 0, len(src)) for _, i := range src { r = append(r, mapFn(i)) } return r } func ToUpByString() { sl := []string{\u0026#34;hello\u0026#34;, \u0026#34;world\u0026#34;, \u0026#34;golang\u0026#34;} s0 := Convert(sl, func(v string) string { return strings.ToUpper(v) }) for _, v := range s0 { // do business } } æ€§èƒ½å¯¹æ¯” 1 2 3 4 5 6 7 8 9 10 11 12 13 âœ huizhou92 git:(master) âœ— go test -bench . -count=3 goos: darwin goarch: arm64 pkg: huizhou92 cpu: Apple M1 Pro BenchmarkToUpByString-10 8568332 128.7 ns/op BenchmarkToUpByString-10 9310351 128.6 ns/op BenchmarkToUpByString-10 9344986 128.5 ns/op BenchmarkToUpByIter-10 12440120 96.22 ns/op BenchmarkToUpByIter-10 12436645 96.25 ns/op BenchmarkToUpByIter-10 12371175 96.64 ns/op PASS ok huizhou92 8.162s ç»“æœå¾ˆæ˜æ˜¾ï¼šToUpperByIter æ€§èƒ½æ›´å¥½ï¼Œå› ä¸ºå®ƒä¸ä¼šé‡æ–°åˆ†é…æ–°çš„sliceï¼Œä½¿å¾—å®ƒæ¯”ä»¥å‰çš„æ–¹æ³•æ›´é«˜æ•ˆã€‚\niter çš„ç›®æ ‡ iter åŒ…æ—¨åœ¨æä¾›ç»Ÿä¸€ä¸”é«˜æ•ˆçš„è¿­ä»£æ–¹æ³•ã€‚å®ƒä¸ºè‡ªå®šä¹‰å®¹å™¨ç±»ï¼ˆå°¤å…¶æ˜¯åœ¨å¼•å…¥æ³›å‹ä¹‹åï¼‰æä¾›äº†æ ‡å‡†çš„è¿­ä»£æ¥å£ï¼Œå¹¶å¯ä»¥æ›¿æ¢ä¸€äº›è¿”å›åˆ‡ç‰‡çš„ç°æœ‰ APIã€‚é€šè¿‡ä½¿ç”¨è¿­ä»£å™¨å¹¶åˆ©ç”¨ç¼–è¯‘å™¨ä¼˜åŒ–ï¼Œå¯ä»¥æé«˜æ€§èƒ½ã€‚æ­¤å¤–ï¼Œå®ƒè¿˜æä¾›äº†é€‚åˆå‡½æ•°å¼ç¼–ç¨‹é£æ ¼çš„æ ‡å‡†è¿­ä»£æœºåˆ¶ã€‚\nå¦‚ä½•ä½¿ç”¨ iter iteræ”¯æŒä¸¤ç§ç±»å‹çš„è¿­ä»£å™¨ï¼š\n1 2 3 4 5 6 7 8 9 // Seq is an iterator over sequences of individual values. // When called as seq(yield), seq calls yield(v) for each value v in the sequence, // stopping early if yield returns false. type Seq[V any] func(yield func(V) bool) // Seq2 is an iterator over sequences of pairs of values, most commonly key-value pairs. // When called as seq(yield), seq calls yield(k, v) for each pair (k, v) in the sequence, // stopping early if yield returns false. type Seq2[K, V any] func(yield func(K, V) bool) map åŒ…å·²ç»ä½¿ç”¨ iter æ¥æ·»åŠ äº†è¯¸å¦‚ All å’Œ Keys ç­‰æ–¹æ³•ã€‚è¿™é‡Œæ˜¯å®ƒçš„å®ç°å‚è€ƒï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 //https://go.googlesource.com/go/blob/c83b1a7013784098c2061ae7be832b2ab7241424/src/maps/iter.go#L12 // All returns an iterator over key-value pairs from m. // The iteration order is not specified and is not guaranteed // to be the same from one call to the next. func All[Map ~map[K]V, K comparable, V any](m Map) iter.Seq2[K, V] { return func(yield func(K, V) bool) { for k, v := range m { if !yield(k, v) { return } } } } // Keys returns an iterator over keys in m. // The iteration order is not specified and is not guaranteed // to be the same from one call to the next. func Keys[Map ~map[K]V, K comparable](m Map) iter.Seq[K] { return func(yield func(K) bool) { for k := range m { if !yield(k) { return } } } } äº‰è®º â€œåœ¨æˆ‘çœ‹æ¥ï¼Œyield æ˜¯ä¸€ä¸ªè¶³å¤Ÿå¤æ‚çš„æ¦‚å¿µï¼Œä¼šå¯¼è‡´å‡ºç°å¤§é‡ç³Ÿç³•çš„ã€éš¾ä»¥ç†è§£çš„ä»£ç ã€‚è¿™ä¸ªå»ºè®®åªæä¾›äº†è¯­æ³•ç³–ï¼Œç”¨äºç¼–å†™è¯­è¨€ä¸­å·²ç»è¶…å‡ºå¯èƒ½èŒƒå›´çš„å†…å®¹ã€‚æˆ‘è®¤ä¸ºè¿™è¿èƒŒäº†â€œä¸€ä¸ªé—®é¢˜ - ä¸€ä¸ªè§£å†³æ–¹æ¡ˆâ€çš„è§„åˆ™ã€‚æ‹œæ‰˜ï¼Œè®© Go ä¿æŒæ— èŠã€‚â€ æ¥æº\nè¿™æ˜¯ç¤¾åŒºå†…å¸¸è§çš„åå¯¹æ„è§ã€‚yield ä¸å®¹æ˜“ç†è§£ï¼Œå¹¶ä¸”æˆ‘ä»¬å¯ä»¥é€šè¿‡å¤šç§æ–¹å¼å®ç°è¿­ä»£å™¨ã€‚\nç»“è®º æˆ‘æ”¯æŒæ·»åŠ iterã€‚\niteråŒ…ä¸ºå¼€å‘äººå‘˜æä¾›äº†è®¸å¤šå¯èƒ½æ€§ï¼Œæ—¨åœ¨ç®€åŒ–ä»£ç å¹¶é‡‡ç”¨æ›´å¤šçš„å‡½æ•°å¼ç¼–ç¨‹å®è·µã€‚ç„¶è€Œï¼Œç”±äºå¯¹æ€§èƒ½ã€å¤æ‚æ€§å’Œå­¦ä¹ æ›²çº¿çš„æ‹…å¿§ï¼Œå®ƒçš„æ¥å—åº¦å­˜åœ¨åˆ†æ­§ã€‚\nä¸ä»»ä½•æ–°å·¥å…·ä¸€æ ·ï¼Œå…³é”®æ˜¯åœ¨æä¾›æ˜æ˜¾å¥½å¤„çš„åœ°æ–¹å¹³è¡¡å…¶ä½¿ç”¨ï¼Œå¹¶åŒæ—¶æ³¨æ„æ½œåœ¨ç¼ºç‚¹ã€‚æ¯«æ— ç–‘é—®ï¼ŒGoç¤¾åŒºå°†ç»§ç»­æ¢ç´¢å’Œè¾©è®ºå¦‚ä½•åˆ©ç”¨iterçš„åŠ›é‡è€Œä¸æŸå®³è¯¥è¯­è¨€çš„åŸºæœ¬åŸåˆ™ã€‚\nå‚è€ƒèµ„æ–™ 61405 56413 iterators_in_go_123 ","date":"2024-06-11T17:33:16+08:00","permalink":"https://huizhou92.com/zh-cn/p/go-1.23-new-iter-package/","title":"Go 1.23: æ–°åŒ… Iter"},{"content":"ä¸Šå‘¨ï¼ŒGo 1.23 è¿›å…¥å†»ç»“æœŸï¼Œè¿™æ„å‘³ç€ä¸ä¼šæ·»åŠ ä»»ä½•æ–°åŠŸèƒ½ï¼Œå¹¶ä¸”ä»»ä½•å·²æ·»åŠ çš„åŠŸèƒ½ä¸å¤ªå¯èƒ½è¢«åˆ é™¤ã€‚è¿™æ˜¯ä¸€ä¸ªé¢„è§ˆå³å°†å‘ç”Ÿçš„å˜åŒ–çš„å¥½æœºä¼šã€‚\nè¿™ç¯‡æ–‡ç« ï¼Œæˆ‘ä»¬æ¥ä»‹ç»å¼•å…¥çš„æ–°åŒ…unique\nThis article is first published in the medium MPP plan. If you are a medium user, please follow me in medium. Thank you very much.\næ ¹æ®wikipediaçš„æè¿°ï¼Œinterningæ˜¯æŒ‰éœ€é‡å¤ä½¿ç”¨å…·æœ‰åŒç­‰å€¼å¯¹è±¡çš„æŠ€æœ¯ï¼Œå‡å°‘åˆ›å»ºæ–°å¯¹è±¡çš„åŠ¨ä½œã€‚è¿™ç§åˆ›å»ºæ¨¡å¼ç»å¸¸ç”¨äºä¸åŒç¼–ç¨‹è¯­è¨€ä¸­çš„æ•°å’Œå­—ç¬¦ä¸²ï¼Œå¯ä»¥é¿å…ä¸å¿…è¦çš„å¯¹è±¡é‡å¤åˆ†é…çš„å¼€é”€ã€‚\nunique å‚è€ƒäº†go4.org/intern ,å°†å®ƒç§»åŠ¨åˆ°äº† å®˜æ–¹åº“ï¼Œå¹¶ä¸”åšäº†ç›¸åº”çš„ä¿®æ”¹ã€‚ issue #62483\nå°±åƒå®˜æ–¹æè¿°çš„ä¸€æ · unique è¿™ä¸ªåŒ…æä¾›äº†ä¸€ç§è½»é‡åŒ–ï¼ˆuniqueä»…ä»…å…«ä¸ªå­—èŠ‚ï¼‰çš„æ¯”è¾ƒä¸¤ä¸ªå˜é‡æ˜¯å¦ç›¸ç­‰çš„å®ç°ã€‚æ¯”å¦‚ä¸‹é¢è¿™æ®µä»£ç \næ€§èƒ½æå‡è¿˜æ˜¯å¾ˆæ˜æ˜¾çš„\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 âœ unique git:(master) âœ— /Users/hxzhouh/workspace/googlesource/go/bin/go test -bench=\u0026#39;BenchmarkMake1\u0026#39; -count=5 goos: darwin goarch: arm64 pkg: unique cpu: Apple M1 Pro BenchmarkMake1-10 122033748 9.692 ns/op BenchmarkMake1-10 123878858 9.688 ns/op BenchmarkMake1-10 123927121 9.706 ns/op BenchmarkMake1-10 123849468 9.759 ns/op BenchmarkMake1-10 123306187 9.673 ns/op PASS ok unique 11.055s âœ unique git:(master) âœ— /Users/hxzhouh/workspace/googlesource/go/bin/go test -bench=\u0026#39;BenchmarkMake2\u0026#39; -count=5 goos: darwin goarch: arm64 pkg: unique cpu: Apple M1 Pro BenchmarkMake2-10 1000000000 0.3118 ns/op BenchmarkMake2-10 1000000000 0.3114 ns/op BenchmarkMake2-10 1000000000 0.3119 ns/op BenchmarkMake2-10 1000000000 0.3136 ns/op BenchmarkMake2-10 1000000000 0.3115 ns/op PASS ok unique 1.875s ä½†æ˜¯ ä½ ä¸åº”è¯¥æŠŠä»–å½“ä½œä¸€ä¸ªå…¨å±€å˜é‡æ¥ç”¨,å­˜å‚¨å…±äº«æ•°æ®ï¼Œunique çš„åº•å±‚å®ç°å…¶å®æ˜¯ä¸€ä¸ªmap,æŸ¥è¯¢çš„æˆæœ¬ä¹Ÿæ˜¯å¾ˆé«˜çš„ã€‚\næ¯”å¦‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 âœ huizhou92_test git:(master) âœ— /Users/hxzhouh/workspace/googlesource/go/bin/go test --bench=BenchmarkBusinessUnique --count=5 goos: darwin goarch: arm64 pkg: huizhou92_test cpu: Apple M1 Pro BenchmarkBusinessUnique-10 3114 373867 ns/op BenchmarkBusinessUnique-10 3280 390818 ns/op BenchmarkBusinessUnique-10 2941 376503 ns/op BenchmarkBusinessUnique-10 3291 389665 ns/op BenchmarkBusinessUnique-10 2954 398610 ns/op PASS ok huizhou92_test 6.320s âœ huizhou92_test git:(master) âœ— /Users/hxzhouh/workspace/googlesource/go/bin/go test --bench=BenchmarkBusinessString --count=5 goos: darwin goarch: arm64 pkg: huizhou92_test cpu: Apple M1 Pro BenchmarkBusinessString-10 526721706 2.185 ns/op BenchmarkBusinessString-10 548612287 2.183 ns/op BenchmarkBusinessString-10 549425077 2.188 ns/op BenchmarkBusinessString-10 549012100 2.182 ns/op BenchmarkBusinessString-10 548929644 2.183 ns/op PASS ok huizhou92_test 7.237s æ­£æ˜¯å› ä¸ºè¿™æ ·ï¼Œå…³äºuniqueçš„è®¨è®ºå…¶å®è¿˜åœ¨ç»§ç»­ï¼Œå¯èƒ½æ˜¯å› ä¸ºç”¨åˆ°çš„åœ°æ–¹ä¸æ˜¯å¾ˆå¤šï¼Ÿä¸ç®¡æ€ä¹ˆæ ·ï¼Œ è¿™ä¸ªæ–°çš„åŒ…è¿›å…¥æ ‡å‡†åº“å·²ç»æ˜¯äº‹å®äº†ã€‚ net/netip å·²ç»ç”¨unique é‡æ„äº†å®ƒï¼Œç”¨æ¥æ¯”å¯¹IPåœ°å€çš„è¯¦ç»†ä¿¡æ¯ã€‚\n","date":"2024-06-04T09:54:42+08:00","image":"https://images.yixiao9206.cn/blog-images/2024/06/0a8a9a271b2db6d5922f8e58e589b187.png","permalink":"https://huizhou92.com/zh-cn/p/golang-1.23-%E6%96%B0%E7%9A%84-unique-%E5%8C%85/","title":"Golang 1.23: æ–°çš„ unique åŒ…"},{"content":"ä¼—æ‰€å‘¨çŸ¥ï¼ŒHTTPSå¯ä»¥è§£å†³HTTPæ˜æ–‡ä¼ è¾“è¿‡ç¨‹ä¸­çš„å®‰å…¨æ€§é—®é¢˜ï¼Œå°¤å…¶æ˜¯ä¸­é—´äººæ”»å‡»é—®é¢˜ã€‚å…¶æœ€åˆçš„å…¨ç§°æ˜¯HTTP over SSLï¼ˆæˆ–è€…è¯´ http Securityï¼‰ã€‚å…¶ä¸­çš„SSLæ˜¯æŒ‡Secure Sockets Layerï¼Œåæ¥SSLè¢«TLSï¼ˆTransport Layer Security ï¼‰æ‰€å–ä»£ã€‚ä»Šå¤©æˆ‘ä»¬å°±æ¥æ€»ç»“ä¸€ä¸‹HTTPSçš„è¦ç‚¹\nThis article is first published in the medium MPP plan. If you are a medium user, please follow me in medium. Thank you very much.\nHTTPS ç‰ˆæœ¬ å½“å‰äººä»¬ä¸€èˆ¬å°†SSL,TLSè¿™ä¸¤ä¸ªåè®®ç»Ÿç§°ä¸ºSSL/TLSåè®®ï¼Œä½†å¤§å®¶æ—¥å¸¸è¯´SSLçš„æ—¶ï¼Œé»˜è®¤è¿˜æ˜¯æŒ‡TLSåè®®ã€‚\nTLS åè®®åœ¨ç‰ˆæœ¬ä¸Šæœ‰1.1ã€1.2ã€1.3ï¼Œå…¶ä¸­1.2æ›¾ç»æ˜¯ä¸»æµï¼Œç°åœ¨æ¨èä½¿ç”¨æ”¹è¿›åçš„ TLS 1.3ï¼Œå®ƒå‡çº§äº†HandShakeå’ŒRecordåè®®ï¼Œä¼šä½¿å¾—é€šä¿¡æ›´åŠ å®‰å…¨å’Œé«˜æ•ˆã€‚\nå®‰å…¨ä¸Šï¼ŒTLS 1.3 ç§»é™¤äº†ä¸€äº›åœ¨ TLS 1.2 ä¸­è¢«è®¤ä¸ºæ˜¯ä¸å®‰å…¨çš„åŠ å¯†ç®—æ³•ï¼Œå¦‚ RC4ã€DESã€3DESã€AES-CBC å’Œ MD5 ç­‰ï¼Œè¿™æ ·å¯ä»¥å‡å°‘å®‰å…¨æ¼æ´çš„é£é™©ã€‚\næ€§èƒ½ä¸Šï¼ŒTLS 1.3 å‡å°‘äº†æ¡æ‰‹è¿‡ç¨‹ä¸­çš„å¾€è¿”æ¬¡æ•°ï¼ˆRTTï¼‰ï¼Œä»è€ŒåŠ å¿«äº†è¿æ¥çš„å»ºç«‹é€Ÿåº¦ã€‚åœ¨æœ€ä½³æƒ…å†µä¸‹ï¼ŒTLS 1.3 åªéœ€è¦ä¸€æ¬¡å¾€è¿”å°±å¯ä»¥å®Œæˆæ¡æ‰‹ï¼ŒåŒæ—¶æ”¯æŒ0-RTTæ‰©å±•ï¼Œè€Œ TLS 1.2 éœ€è¦ä¸¤æ¬¡æˆ–æ›´å¤šã€‚\nå½“ç„¶ï¼Œä½œä¸ºè®¾è®¡ç²¾è‰¯çš„äº’è”ç½‘åè®®ï¼ŒTLS 1.3ä¹Ÿé€šè¿‡helloæ¡æ‰‹æ¶ˆæ¯çš„æ‰©å±•åè®®è€ƒè™‘äº†æœ€å¤§åŒ–å‘å‰å…¼å®¹ï¼Œè¿™ç‚¹ä¸å†èµ˜è¿°ã€‚\nHTTPS æ ¸å¿ƒæµç¨‹ ä¾æ®ä¸åŒç‰ˆæœ¬çš„å·®å¼‚ï¼Œç»†èŠ‚æµç¨‹ä¼šç•¥æœ‰ä¸åŒï¼Œä¸è¿½æ±‚ä¸¥è°¨ç»†è‡´çš„æƒ…å†µä¸‹ï¼ŒHTTPSå·¥ä½œæµç¨‹å¦‚ä¸‹ã€‚\nbytebytego çš„è¿™ä¸ªå›¾éå¸¸å…·æœ‰è¡¨ç°åŠ›ï¼Œå±•ç¤ºäº†å…³é”®çš„äº¤äº’å’Œæ ¸å¿ƒçš„åŠ å¯†æµç¨‹ã€‚æœ€å…³é”®çš„å‡ æ­¥åœ¨äºå¦‚ä½•å»ºç«‹TCPé“¾æ¥ï¼Œå¦‚ä½•é€šè¿‡éå¯¹ç§°åŠ å¯†åå•†è·å–å¯¹ç§°åŠ å¯†çš„å¯†é’¥ï¼Œä»¥åŠæœ€åé€šè¿‡å¯¹ç§°åŠ å¯†è¿›è¡Œé€šä¿¡ã€‚\nHTTPSï¼Œå‡†ç¡®æ¥è¯´æ˜¯TLSï¼Œè®¾è®¡ä¸¥å¯†ï¼Œå…¶ä¸­æœ€å…³é”®çš„æ˜¯Record Layerå’Œå‡ ç§Protocolï¼Œå‰è€…æ˜¯æ•°æ®æ‰¿è½½ç®¡é“ï¼Œå„ç§å­Protocoléƒ½è·‘åœ¨å®ƒä¸Šé¢ ï¼Œå…¶ä¸­çš„Recordæ˜¯TLSæ•°æ®æ”¶å‘ä¼ è¾“çš„åŸºæœ¬å•ä½ï¼Œç±»ä¼¼TCPçš„segmentï¼ŒIPçš„Packetï¼Œè¿™ä¹Ÿæ˜¯ä¸‹é¢è¿™å¹…å›¾çš„å«ä¹‰ã€‚\nä¸Šå›¾ä¸­Protocolé‡Œæœ€é‡è¦çš„æ˜¯Handshakeåè®®ï¼Œé’ˆå¯¹Client Helloè¿›è¡ŒæŠ“åŒ…åï¼Œåœ¨Wiresharkä¸­ä½“ç°å¾—ä¼šæ›´æ¸…æ™°ã€‚\nHTTPS SNI æ‰©å±• äº’è”ç½‘æ—©æœŸï¼Œå•æœºæœåŠ¡å™¨æ²¡é‚£ä¹ˆå¼ºå¤§ï¼Œé…å¥—çš„HTTPSæ¯”å¦‚SSL v2ä¹Ÿæœ‰è®¾è®¡ç¼ºé™·ã€‚é‚£æ—¶æœ‰ä¸€ä¸ªå‡å®šï¼Œè®¤ä¸ºæ‹¥æœ‰ä¸€ä¸ªIPçš„å•å°æœåŠ¡å™¨åªä¼šæ‰˜ç®¡ä¸€ä¸ªåŸŸåæœåŠ¡ï¼Œæ‰€ä»¥DNSè§£æä»¥åï¼Œç›´è¿IPæ—¶å°±èƒ½éå¸¸ç¡®å®šè¦ä½¿ç”¨å…·ä½“æŸä¸ªåŸŸåçš„è¯ä¹¦ã€‚ä½†åé¢äº‘è®¡ç®—ã€è™šæ‹Ÿä¸»æœºå¤§çˆ†å‘ï¼Œä»¥åŠIPv4ä¸­IPçš„ç¨€ç¼ºæ€§ï¼Œä¸€å°æœåŠ¡å™¨æ‰˜ç®¡å¤šä¸ªåŸŸåçš„åœºæ™¯æ— å¯é¿å…ï¼Œè¿™æ—¶æœåŠ¡å™¨é¢ä¸´æ— æ³•çŸ¥é“å®¢æˆ·ç«¯åˆ°åº•æƒ³è¦è®¿é—®å“ªä¸ªåŸŸåçš„SSLè¯ä¹¦çš„é—®é¢˜ï¼Œä»è€Œå¯¼è‡´äº†HTTPS SNIçš„å‡ºç°ã€‚\nSNIï¼ˆServer Name Indicationï¼‰æ˜¯TLSåè®®çš„ä¸€ä¸ªæ‰©å±•ï¼Œå®ƒå…è®¸å®¢æˆ·ç«¯åœ¨æ¡æ‰‹è¿‡ç¨‹ä¸­å‘æœåŠ¡å™¨å‘é€ç›®æ ‡ä¸»æœºåä¿¡æ¯ã€‚è¿™æ ·ï¼ŒæœåŠ¡å™¨å°±å¯ä»¥åœ¨åŒä¸€ä¸ªIPåœ°å€ä¸Šæ‰˜ç®¡å¤šä¸ªåŸŸåçš„HTTPSæœåŠ¡ï¼Œå¹¶ä¸ºæ¯ä¸ªåŸŸåæä¾›æ­£ç¡®çš„è¯ä¹¦ã€‚\nè¿™ä¸ªé—®é¢˜çœ‹ä¼¼ç®€å•ï¼Œåœ¨HTTPSé€æ¸æ™®åŠï¼Œå„äº’è”ç½‘æœåŠ¡å•†èµ°å‘å…¨ç«™HTTPSåŒ–çš„æ—©æœŸï¼Œå¾ˆå¤šCDNå‚å•†ç”šè‡³éƒ½æ˜¯ä¸æ”¯æŒSNIçš„ã€‚å½“ç„¶åœ¨2024å¹´çš„ä»Šå¤©ï¼Œæ— è®ºæ˜¯Nginxç­‰è½¯ä»¶ç”Ÿæ€ï¼Œè¿˜æ˜¯å„å‚å•†ï¼Œéƒ½å·²ç»æ”¯æŒäº†çš„ã€‚\nSNIä¿¡æ¯æ˜¯é€šè¿‡TLSæ¡æ‰‹åè®®ä¼ è¾“çš„ï¼ŒæŠ“åŒ…ç¤ºæ„å¤§æ¦‚æ˜¯ä¸‹é¢è¿™æ ·å­ã€‚\nå…·ä½“åˆ°å®æ“ï¼Œå¯ä»¥ä½¿ç”¨openssl s_clientå­å‘½ä»¤ä¸­çš„-servernameé€‰é¡¹æ¥æŒ‡å®šSNIï¼š\n1 openssl s_client -connect example.com:443 -servername example.com å¦‚æœä½¿ç”¨OpenSSL Libraryï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨SSL_set_tlsext_host_nameå’ŒBIO_set_conn_hostnameç­‰å‡½æ•°æ¥åœ¨ä»£ç ä¸­è®¾ç½®ã€‚\nHTTPS è¯ä¹¦æœºåˆ¶ HTTPSé€šè¿‡å…¬é’¥ ä½“ç³»é‡Œçš„éå¯¹ç§°ã€å¯¹ç§°åŠæ‘˜è¦ç®—æ³•ï¼Œå®ç°äº†ä¸€ç³»åˆ—çš„åŠ è§£å¯†ã€ç­¾åã€éªŒç­¾ç­‰åŠŸèƒ½ï¼ŒåŸºæœ¬å®ç°äº†å®‰å…¨å››å¤§ç‰¹æ€§ï¼šæœºå¯†æ€§ã€å®Œæ•´æ€§ï¼Œèº«ä»½è®¤è¯å’Œä¸å¯å¦è®¤ã€‚å¦‚å…¸å‹çš„ä¸­é—´äººæ”»å‡»ï¼ˆMan-in-the-middle attackï¼ŒMITMï¼‰ï¼Œä¹Ÿéƒ½æœ‰äº†è§£å†³æ–¹æ¡ˆã€‚\nè¿™é‡Œä¸ºäº†è§£å†³å…¬é’¥çš„ä¿¡ä»»é—®é¢˜ï¼Œåˆå¼•å…¥äº†è¯ä¹¦å’Œä¿¡ä»»é“¾æœºåˆ¶ã€‚è¯ä¹¦ï¼ˆCertificateï¼‰æ˜¯ç”±ç¬¬ä¸‰æ–¹CAï¼ˆCertificate Authorityï¼Œè¯ä¹¦è®¤è¯æœºæ„ï¼‰é¢å‘çš„ï¼Œæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªæ–‡ä»¶ï¼Œé€šå¸¸æ˜¯.crtã€.cer æˆ– .pem ç­‰æ‰©å±•åå­˜å‚¨ã€‚è¿™ä¸ªæ–‡ä»¶æŒ‰ç…§ä¸€å®šçš„æ ‡å‡†ï¼ˆå¦‚X.509ï¼‰ç¼–ç ï¼ŒåŒ…å«äº†å…¬é’¥ã€è¯ä¹¦æŒæœ‰è€…ä¿¡æ¯ã€é¢å‘æœºæ„ä¿¡æ¯ã€æœ‰æ•ˆæœŸå’Œæ•°å­—ç­¾åç­‰ä¿¡æ¯ã€‚\næœ‰ä¸€äº›ä¸–ç•ŒçŸ¥åçš„ CA æœºæ„ï¼Œæ¯”å¦‚ DigiCertã€VeriSignã€Entrustã€Letâ€™s Encrypt ç­‰ï¼Œå®ƒä»¬ç­¾å‘çš„è¯ä¹¦åˆ† DVã€OVã€EV ä¸‰ç§ï¼Œå¯¹åº”ä¸åŒçš„å¯ä¿¡ç¨‹åº¦ã€‚ä½†CAè‡ªå·±ä¹Ÿæœ‰ä¿¡ä»»é—®é¢˜ï¼Œå°CAçš„ä¿¡ä»»é å¤§CAç­¾åè®¤è¯ï¼Œä½†é€å±‚å‘ä¸Šåˆ°äº†é“¾æ¡çš„æœ€åï¼Œå°±æ˜¯ Root CAï¼Œå°±åªèƒ½ç”¨â€œè‡ªç­¾åè¯ä¹¦â€ï¼ˆSelf-Signed Certificateï¼‰æˆ–è€…â€œæ ¹è¯ä¹¦â€ï¼ˆRoot Certificateï¼‰äº†ã€‚\nå¤§éƒ¨åˆ†æ“ä½œç³»ç»Ÿå’Œæµè§ˆå™¨éƒ½å†…ç½®äº†å„å¤§ CA çš„æ ¹è¯ä¹¦ï¼ŒHTTPSé€šä¿¡æ—¶ä¼šé¡ºç€è¯ä¹¦é“¾ï¼ˆCertificate Chainï¼‰é€å±‚éªŒè¯åˆ°æ ¹è¯ä¹¦ã€‚\nHTTPS è½¯ä»¶ç”Ÿæ€ HTTPSï¼Œæˆ–æ˜¯è¯´TLSï¼Œç”Ÿæ€è™½ç„¶ä¸°å¯Œï¼Œä½†OpenSSLä¸€å®¶ç‹¬å¤§ã€‚å®ƒå‡ ä¹æ”¯æŒæ‰€æœ‰å…¬å¼€çš„åŠ å¯†ç®—æ³•å’Œåè®®ï¼Œå·²ç»æˆä¸ºäº†äº‹å®ä¸Šçš„æ ‡å‡†ï¼Œè®¸å¤šåº”ç”¨è½¯ä»¶éƒ½ä¼šä½¿ç”¨å®ƒä½œä¸ºåº•å±‚åº“æ¥å®ç° TLS åŠŸèƒ½ï¼Œæ¯”å¦‚è‘—åçš„ Apacheã€Nginx ç­‰ã€‚\nOpenSSLæºäºSSLeayï¼Œå…¶åå¼€ææ•£å¶ï¼Œå½¢æˆä¼—å¤šåˆ†æ”¯ï¼Œå¦‚ Google çš„ BoringSSLã€OpenBSD çš„ LibreSSLã€‚OpenSSLçš„å†…å®¹ä¹Ÿæå…¶åºæ‚ï¼Œå¯ä»¥ä¼˜å…ˆä½¿ç”¨opensslå‘½ä»¤è¿›è¡Œå­¦ä¹ ï¼Œå…·ä½“å¯ä»¥å‚è€ƒChatGPTã€‚\nHTTPS åŠ é€Ÿæ–¹æ¡ˆ HTTPSå¾ˆç¾å¥½ï¼Œä½†ç¾å¥½çš„äº‹ç‰©éƒ½æœ‰æˆæœ¬ã€‚æ‰€ä»¥å…³äºHTTPSå…¨ç«™é“ºå¼€åçš„å„ç§ä¼˜åŒ–ï¼ŒåŸºæœ¬ä¸Šå¯ä»¥å†™æˆç‹¬ç«‹çš„ä¸€ç¯‡æ–‡ç« ï¼Œè¿™é‡Œå…ˆç®€å•æä¸‹ã€‚\né¦–å…ˆæ˜¯ä¼˜åŒ–RTTï¼Œè¿™ä¸ªåœ¨IOå¯†é›†å‹çš„äº’è”ç½‘åœºæ™¯ä¸‹å°¤ä¸ºé‡è¦ï¼Œä¸»è¦æ˜¯é€šè¿‡å‡çº§åè®®ï¼Œå¦‚å‡çº§HTTP/3ï¼Œå‡çº§TLS 1.3ï¼Œéƒ½å¯ä»¥é€šè¿‡ä¸åŒåŸç†æ¥ä¼˜åŒ–RTTã€‚å…¶æ¬¡æ˜¯ä¼˜åŒ–å•æ­¥éª¤æ€§èƒ½ï¼Œå¦‚å¢åŠ TLSåŠ é€Ÿå¡ï¼Œè®¾ç½®å•ç‹¬çš„TLSé›†ç¾¤æˆ–æ¨¡å—ç­‰ï¼Œè¿˜æœ‰ä¸€äº›TLS session resumptionç­‰åè¯ä¹Ÿå¯ä»¥å…³æ³¨ã€‚\næˆ‘ä»¥å‰å†™è¿‡ä¸€ç¯‡æ–‡ç« åˆ†äº«ä¸ºä»€ä¹ˆHTTPSä¸ºä»€ä¹ˆè¿™ä¹ˆæ…¢çš„æ–‡ç« ï¼Œæœ‰å…´è¶£å¯ä»¥é˜…è¯»ä¸€ä¸‹ã€‚\nWhy does HTTPS need 7 handshakes and 9 times delay?\nå‚è€ƒèµ„æ–™ What\u0026rsquo;s the difference between HTTP and HTTPS?\nhow-does-https-work\n","date":"2024-05-27T18:30:32+08:00","image":"https://images.yixiao9206.cn/blog-images/2024/05/9113c36ee94b362ffe79a997b75c8efe.png","permalink":"https://huizhou92.com/zh-cn/p/the-key-points-of-https/","title":"äº†è§£ HTTPSï¼šå…³é”®ç‚¹å’Œæµç¨‹è¯¦è§£"},{"content":"ä¸Šå‘¨ go1.23 å·²ç»è¿›å…¥å†»ç»“æœŸäº†ï¼Œåº”è¯¥ä¸ä¼šå†æ·»åŠ æ–°åŠŸèƒ½ï¼Œç›¸åº”çš„å·²ç»æ·»åŠ äº†çš„åŠŸèƒ½ ä¹Ÿä¸å¤ªå¯èƒ½ä¼šè¢«ç§»é™¤ã€‚\nè¿™æ­£å¥½å¯ä»¥è®©æˆ‘ä»¬æå‰å°é²œè¿™äº›å³å°†åˆ°æ¥çš„æ–°ç‰¹æ€§ã€‚\nhttps://groups.google.com/g/golang-dev/c/vXE304_MnKM\nThis article is first published in the medium MPP plan. If you are a medium user, please follow me in medium. Thank you very much.\nä»Šå¤©è¦è¯´çš„å°±æ˜¯1.23ä¸­å¯¹//go:linknameæŒ‡ä»¤çš„å˜æ›´ã€‚\nç›¸å…³è®¨è®ºçš„issue åœ¨è¿™é‡Œï¼š\nhttps://github.com/golang/go/issues/67401\nTL;DR //go:linknameæŒ‡ä»¤å®˜æ–¹å¹¶ä¸æ¨èä½¿ç”¨ï¼Œä¸”ä¸ä¿è¯ä»»ä½•å‘å‰æˆ–è€…å‘åå…¼å®¹æ€§ï¼Œå› æ­¤æ˜æ™ºçš„åšæ³•æ˜¯å°½é‡åˆ«ç”¨\nç‰¢è®°è¿™ä¸€ç‚¹ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥æ¥ç€å¾€ä¸‹çœ‹äº†ã€‚è‡³äºä¸ºå•¥å’Œâ€œæˆ‘â€ä¹Ÿå°±æ˜¯æœ¬æ–‡çš„ä½œè€…æœ‰å…³ï¼Œæˆ‘ä»¬å…ˆçœ‹å®Œæ–°ç‰ˆæœ¬å¸¦æ¥çš„æ–°å˜åŒ–å†è¯´ã€‚\nlinknameæŒ‡ä»¤æ˜¯åšä»€ä¹ˆçš„ ç®€å•çš„è¯´ï¼ŒlinknameæŒ‡ä»¤ç”¨äºå‘ç¼–è¯‘å™¨å’Œé“¾æ¥å™¨ä¼ é€’ä¿¡æ¯ã€‚å…·ä½“çš„å«ä¹‰æ ¹æ®ç”¨æ³•å¯ä»¥åˆ†ä¸ºä¸‰ç±»ã€‚\nç¬¬ä¸€ç±»å«åšâ€œpullâ€ï¼Œæ„æ€æ˜¯æ‹‰å–ï¼Œä½¿ç”¨æ–¹å¼å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 import _ \u0026#34;unsafe\u0026#34; // å¿…é¡»æœ‰è¿™è¡Œæ‰èƒ½ç”¨linkname import _ \u0026#34;fmt\u0026#34; // è¢«æ‹‰å–çš„åŒ…éœ€è¦æ˜¾å¼å¯¼å…¥ï¼ˆé™¤äº†runtimeåŒ…ï¼‰ //go:linkname my_func fmt.Println func my_func(...any) (n int, err error) è¿™ç§ç”¨æ³•çš„æŒ‡ä»¤æ ¼å¼æ˜¯//go:linkname \u0026lt;æŒ‡ä»¤ä¸‹æ–¹çš„åªæœ‰å£°æ˜çš„å‡½æ•°æˆ–åŒ…çº§åˆ«å˜é‡å\u0026gt; \u0026lt;æœ¬åŒ…æˆ–è€…å…¶ä»–åŒ…ä¸­çš„æœ‰å®Œæ•´å®šä¹‰çš„å‡½æ•°æˆ–å˜é‡\u0026gt;ã€‚\nè¿™ä¸ªæŒ‡ä»¤çš„ä½œç”¨å°±æ˜¯å‘Šè¯‰ç¼–è¯‘å™¨å’Œè¿æ¥å™¨ï¼Œmy_funcçš„å‡½æ•°ä½“ç›´æ¥ä½¿ç”¨fmt.Printlnçš„ï¼Œmy_funcç±»ä¼¼fmt.Printlnçš„åˆ«åï¼Œå’Œå®ƒå…±äº«åŒä¸€ä»½ä»£ç ï¼Œå°±åƒæŠŠæŒ‡ä»¤ç¬¬äºŒä¸ªå‚æ•°æŒ‡å®šçš„å‡½æ•°å’Œå˜é‡æ‹‰å–ä¸‹æ¥ç»™ç¬¬ä¸€ä¸ªå‚æ•°ä½¿ç”¨ä¸€æ ·ã€‚\næ­£å› å¦‚æ­¤ï¼ŒæŒ‡ä»¤ä¸‹æ–¹ç»™å‡ºçš„å£°æ˜å¿…é¡»å’Œè¢«æ‹‰å–çš„å‡½æ•°/å˜é‡å®Œå…¨ä¸€è‡´ï¼Œå¦åˆ™å¾ˆå®¹æ˜“å› ä¸ºç±»å‹ä¸åŒ¹é…å¯¼è‡´panicï¼ˆæ˜¯çš„æ²¡é”™ï¼Œé™¤éæ‹‰å–çš„å¯¹è±¡ä¸å­˜åœ¨ï¼Œå¦åˆ™éƒ½ä¸ä¼šå‡ºç°ç¼–è¯‘é”™è¯¯ï¼‰ã€‚\nè¿™ä¸ªæŒ‡ä»¤æœ€ææ€–çš„åœ°æ–¹åœ¨äºå®ƒèƒ½æ— è§†å‡½æ•°æˆ–è€…å˜é‡æ˜¯å¦æ˜¯exportçš„ï¼ŒåŒ…ç§æœ‰çš„ä¸œè¥¿ä¹Ÿèƒ½è¢«æ‹‰å–å‡ºæ¥ä½¿ç”¨ã€‚å› ä¸ºè¿™ä¸€ç‚¹è¿™ç§ç”¨æ³•åœ¨æ—©æœŸçš„ç¤¾åŒºä¸­å¾ˆå¸¸è§ï¼Œæ¯”å¦‚å¾ˆå¤šäººå–œæ¬¢è¿™ä¹ˆå¹²ï¼š//go:linkname myRand runtime.fastrandï¼Œå› ä¸ºruntimeæä¾›äº†ä¸€ä¸ªæ€§èƒ½è¿˜ä¸é”™çš„éšæœºæ•°å®ç°ï¼Œä½†æ²¡æœ‰å…¬å¼€å‡ºæ¥ï¼Œæ‰€ä»¥æœ‰äººä¼šç”¨linknameæŒ‡ä»¤æŠŠå®ƒå¯¼å‡ºä¸ºå·±æ‰€ç”¨ï¼Œå½“ç„¶éšç€1.21çš„å‘å¸ƒè¿™ç§ç”¨æ³•ä¸å†æœ‰ä»»ä½•æ„ä¹‰äº†ï¼Œè¯·æ°¸è¿œéƒ½ä¸è¦å»æ¨¡ä»¿ã€‚\nç¬¬äºŒç§ç”¨æ³•å«åšâ€œpushâ€ï¼Œå³æ¨é€ã€‚å½¢å¼ä¸Šæ˜¯ä¸‹é¢è¿™æ ·ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 import _ \u0026#34;unsafe\u0026#34; // å¿…é¡»æœ‰è¿™è¡Œæ‰èƒ½ç”¨linkname //go:linkname main.fastHandle func fastHandle(input io.Writer) error { ... } // package main func fastHandle(input io.Writer) error // åé¢mainåŒ…ä¸­å¯ä»¥ç›´æ¥ä½¿ç”¨fastHandle // è¿™ç§æƒ…å†µä¸‹éœ€è¦åœ¨mainåŒ…ä¸‹åˆ›å»ºä¸€ä¸ªç©ºçš„asmæ–‡ä»¶ï¼ˆé€šå¸¸ä»¥.sä½œä¸ºæ‰©å±•åï¼‰ï¼Œä»¥å‘Šè¯‰ç¼–è¯‘å™¨fastHandleçš„å®šä¹‰åœ¨åˆ«å¤„ åœ¨è¿™ç§ç”¨æ³•ä¸­ï¼Œæˆ‘ä»¬åªéœ€è¦æŠŠå‡½æ•°/å˜é‡åå½“ä½œç¬¬ä¸€ä¸ªå‚æ•°ä¼ ç»™æŒ‡ä»¤ï¼Œæ³¨æ„éœ€è¦ç»™å‡ºæƒ³ç”¨è¿™ä¸ªå‡½æ•°/å˜é‡çš„åŒ…çš„åå­—ï¼Œè¿™é‡Œæ˜¯mainã€‚åŒæ—¶æŒ‡ä»¤å£°æ˜çš„å˜é‡æˆ–å‡½æ•°å¿…é¡»è¦åœ¨åŒåŒ…å†…æœ‰å®Œæ•´çš„å®šä¹‰ï¼Œé€šå¸¸æ¨èç›´æ¥æŠŠå®Œæ•´å®šä¹‰å†™åœ¨linknameæŒ‡ä»¤ä¸‹æ–¹ã€‚\nè¿™ç§ç”¨æ³•æ˜¯å‘Šè¯‰ç¼–è¯‘å™¨å’Œé“¾æ¥å™¨è¿™ä¸ªå‡½æ•°/å˜é‡çš„åå­—å°±æ˜¯xxx.yyyï¼Œå¦‚æœé‡åˆ°è¿™ä¸ªå‡½æ•°å°±ä½¿ç”¨linknameæŒ‡å®šçš„å‡½æ•°/å˜é‡çš„ä»£ç ï¼Œè¿™ä¸ªæ¨¡å¼ä¸‹ç”šè‡³èƒ½åœ¨æœ¬åŒ…å®šä¹‰åˆ«çš„åŒ…é‡Œçš„å‡½æ•°ã€‚\nå½“ç„¶è¿™ç§ç”¨æ³•çš„è¯­ä¹‰ä½œç”¨æ›´æ˜æ˜¾ï¼Œå®ƒæ„å‘³ç€è¿™ä¸ªå‡½æ•°ä¼šåœ¨ä»»ä½•åœ°æ–¹è¢«ä½¿ç”¨ï¼Œä¿®æ”¹å®ƒéœ€è¦å°å¿ƒï¼Œå› ä¸ºæ”¹å˜äº†å‡½æ•°çš„è¡Œä¸ºå¯èƒ½ä¼šè®©å…¶ä»–è°ƒç”¨å®ƒçš„ä»£ç å‡ºbugï¼›ä¿®æ”¹äº†å‡½æ•°çš„ç­¾ååˆ™å¾ˆå¯èƒ½å¯¼è‡´è¿è¡Œæ—¶panicï¼›åˆ é™¤äº†è¿™ä¸ªå‡½æ•°åˆ™ä¼šå¯¼è‡´ä»£ç æ— æ³•ç¼–è¯‘ã€‚\næœ€åä¸€ç±»å«åšâ€œhandshakeâ€ï¼Œå³æ¡æ‰‹ã€‚ä»–æ˜¯æŠŠç¬¬ä¸€ç±»å’Œç¬¬äºŒç±»æ–¹æ³•ç»“åˆä½¿ç”¨ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 package mypkg import _ \u0026#34;unsafe\u0026#34; // å¿…é¡»æœ‰è¿™è¡Œæ‰èƒ½ç”¨linkname //go:linkname fastHandle func fastHandle(input io.Writer) error { ... } package main import _ \u0026#34;unsafe\u0026#34; // å¿…é¡»æœ‰è¿™è¡Œæ‰èƒ½ç”¨linkname //go:linkname fastHandle mypkg.fastHandle func fastHandle(input io.Writer) error â€œpullâ€çš„ä¸€æ–¹æ²¡ä»€ä¹ˆåŒºåˆ«ï¼Œä½†â€œpushâ€çš„ä¸€æ–¹ä¸ç”¨å†å†™åŒ…åï¼ŒåŒæ—¶ç”¨æ¥å‘Šè¯‰ç¼–è¯‘å™¨å‡½æ•°å®šä¹‰åœ¨åˆ«çš„åœ°æ–¹çš„ç©ºçš„asmæ–‡ä»¶ä¹Ÿä¸éœ€è¦äº†ã€‚è¿™ç§å°±åƒé€šè®¯åè®®ä¸­çš„â€œæ¡æ‰‹â€ï¼Œä¸€æ–¹å‘Šè¯‰ç¼–è¯‘å™¨è¿™è¾¹å…è®¸æŸä¸ªå‡½æ•°/å˜é‡è¢«linknameæ“ä½œï¼Œå¦ä¸€è¾¹åˆ™æ˜ç¡®åƒç¼–è¯‘å™¨è¦æ±‚å®ƒè¦ä½¿ç”¨æŸä¸ªåŒ…çš„æŸä¸ªå‡½æ•°/å˜é‡ã€‚\né€šå¸¸â€œpullâ€å’Œâ€œpushâ€åº”è¯¥æˆå¯¹å‡ºç°ï¼Œä¹Ÿå°±æ˜¯ä½ åªåº”è¯¥ä½¿ç”¨â€œhandshakeâ€æ¨¡å¼ã€‚\nç„¶è€Œä¸å¹¸çš„æ˜¯ï¼Œå½“å‰ï¼ˆ1.22ï¼‰çš„goè¯­è¨€æ”¯æŒâ€œpull-onlyâ€çš„ç”¨æ³•ï¼Œå³å¯ä»¥éšä¾¿æ‹‰å–ä»»ä½•åŒ…é‡Œçš„ä»»ä½•å‡½æ•°/å˜é‡ï¼Œä½†ä¸éœ€è¦è¢«æ‹‰å–çš„å¯¹è±¡ä½¿ç”¨â€œpushâ€æ ‡è®°è‡ªå·±ã€‚è€Œè¢«linknameæ‹‰å–çš„ä¸€æ–¹æ˜¯å®Œå…¨æ— æ„ŸçŸ¥çš„ã€‚\nè¿™å°±å¯¼è‡´äº†éå¸¸å¤§çš„éšæ‚£ã€‚\nlinknameå¸¦æ¥çš„éšæ‚£ æœ€å¤§çš„éšæ‚£åœ¨äºè¿™ä¸ªæŒ‡ä»¤å¯ä»¥åœ¨ä¸é€šçŸ¥è¢«æ‹‰å–çš„packagesçš„æƒ…å†µä¸‹éšæ„ä½¿ç”¨åŒ…ä¸­ç§æœ‰çš„å‡½æ•°/å˜é‡ã€‚\nä¸¾ä¸ªä¾‹å­ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 // pkg/mymath/mymath.go package mymath func uintPow(n uint) uint { return n*n } // main.go package main import ( \u0026#34;fmt\u0026#34; _ \u0026#34;linkname/pkg/mymath\u0026#34; _ \u0026#34;unsafe\u0026#34; ) //go:linkname pow linkname/pkg/mymath.uintPow func pow(n uint) uint func main() { fmt.Println(pow(6)) // 36 } æ­£å¸¸æ¥è¯´ï¼ŒuintPowæ˜¯ä¸å¯èƒ½è¢«å¤–éƒ¨ä½¿ç”¨çš„ï¼Œç„¶è€Œé€šè¿‡linknameæŒ‡ä»¤æˆ‘ä»¬ç›´æ¥æ— è§†äº†æ¥å£çš„å…¬å¼€å’Œç§æœ‰ï¼Œæœ‰ä»€ä¹ˆå°±èƒ½ç”¨ä»€ä¹ˆäº†ã€‚\nè¿™å½“ç„¶æ˜¯éå¸¸å±é™©çš„ï¼Œæ¯”å¦‚æˆ‘ä»¬æŠŠuintPowçš„å‚æ•°ç±»å‹æ”¹æˆstringï¼š\n1 2 3 4 5 package mymath func uintPow(n string) string { return n + n } è¿™æ—¶å€™ç¼–è¯‘è¿˜æ˜¯èƒ½æ­£å¸¸ç¼–è¯‘ï¼Œä½†è¿è¡Œçš„æ—¶å€™å°±ä¼šå‡ºç°å„ç§bugï¼Œåœ¨æˆ‘çš„æœºå™¨ä¸Šè¡¨ç°æ˜¯å¡æ­»å’Œæ®µé”™è¯¯ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿå› ä¸ºæˆ‘ä»¬æŠŠuintå¼ºè¡Œä¼ é€’äº†è¿‡å»ï¼Œä½†å‚æ•°éœ€è¦æ˜¯stringï¼Œç±»å‹å¯¹ä¸ä¸Šï¼Œè‡ªç„¶ä¼šå‡ºç°ç¨€å¥‡å¤æ€ªçš„bugã€‚è¿™ç§åœ¨åˆ«çš„è¯­è¨€é‡Œæ˜¯ä¸¥é‡çš„ç±»å‹ç›¸å…³çš„å†…å­˜é”™è¯¯ã€‚\nå¦å¤–å¦‚æœæˆ‘ä»¬ç›´æ¥åˆ äº†uintPowæˆ–è€…ç»™ä»–æ”¹ä¸ªåï¼Œé“¾æ¥å™¨ä¼šåœ¨ç¼–è¯‘æœŸé—´æŠ¥é”™ï¼š\n1 2 3 4 $ go build # linkname main.main: relocation target linkname/pkg/mymath.uintPow not defined è€Œä¸”æˆ‘ä»¬å¯¼å‡ºçš„æ˜¯ç§æœ‰å‡½æ•°ï¼Œé€šå¸¸æ²¡äººä¼šè®¤ä¸ºè‡ªå·±å†™çš„ç§æœ‰çº§åˆ«çš„å¸®åŠ©å‡½æ•°ä¼šè¢«å¯¼å‡ºåˆ°åŒ…å¤–å¹¶è¢«ä½¿ç”¨ï¼Œå› æ­¤åœ¨å¼€å‘æ—¶å¤§å®¶éƒ½æ˜¯ä¿è¯å…¬å¼€æ¥å£çš„ç¨³å®šæ€§ï¼Œç§æœ‰çš„å‡½æ•°/å˜é‡æ˜¯éšæ—¶å¯ä»¥è¢«å¤§è§„æ¨¡ä¿®æ”¹ç”šè‡³åˆ é™¤çš„ã€‚\nè€Œlinknameå°†è¿™ç§åœ¨åˆ«çš„è¯­è¨€é‡Œæœ€åŸºæœ¬çš„è§„çŸ©ç»™ç²‰ç¢äº†ã€‚\nè€Œä¸”äº‹å®ä¸Šä¹Ÿæ˜¯å¦‚æ­¤ï¼Œä»1.18å¼€å§‹å‡ ä¹æ¯ä¸ªç‰ˆæœ¬éƒ½æœ‰å› ä¸ºç¼–è¯‘å™¨æˆ–è€…æ ‡å‡†åº“å†…éƒ¨çš„ç§æœ‰å‡½æ•°è¢«ä¿®æ”¹/åˆ é™¤ä»è€Œå¯¼è‡´æŸäº›ç¬¬ä¸‰æ–¹åº“åœ¨æ–°ç‰ˆæœ¬æ— æ³•ä½¿ç”¨çš„é—®é¢˜ï¼Œå› ä¸ºè¿™äº›åº“åœ¨å†…éƒ¨æ‚„æ‚„ç”¨//go:linknameç”¨äº†ä¸€äº›æœªå…¬å¼€çš„åŠŸèƒ½ã€‚æœ€è¿‘ä¸€æ¬¡å‘ç”Ÿåœ¨å¹¿æ³›ä½¿ç”¨çš„çŸ¥åjsonåº“ä¸Šç±»ä¼¼çš„é—®é¢˜å¯ä»¥åœ¨è¿™é‡Œçœ‹åˆ°ã€‚\nlinknameçš„æ­£é¢ä½œç”¨ æ—¢ç„¶è¿™ä¸ªæŒ‡ä»¤å¦‚æ­¤å±é™©ï¼Œä¸ºä»€ä¹ˆè¿˜ä¸€ç›´å­˜åœ¨å‘¢ï¼Ÿç­”æ¡ˆæ˜¯æœ‰ä¸å¾—ä¸ç”¨çš„ç†ç”±ï¼Œå…¶ä¸­ä¸€ä¸ªå°±åœ¨å¯åŠ¨goç¨‹åºçš„æ—¶å€™ã€‚\næˆ‘ä»¬æ¥çœ‹ä¸‹goçš„runtimeé‡Œæ˜¯æ€ä¹ˆç”¨linknameçš„ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 // runtime/proc.go //go:linkname main_main main.main func main_main() // runtime.main // æ‰€æœ‰goç¨‹åºçš„å…¥å£ func main() { // åˆå§‹åŒ–runtime // è°ƒç”¨main.main fn := main_main // make an indirect call, as the linker doesn\u0026#39;t know the address of the main package when laying down the runtime fn() // mainé€€å‡ºååšæ¸…ç†å·¥ä½œ } å› ä¸ºç¨‹åºçš„å…¥å£åœ¨runtimeé‡Œï¼ˆè¦åˆå§‹åŒ–runtimeï¼Œæ¯”å¦‚gcç­‰ï¼‰ï¼Œæ‰€ä»¥å…¥å£å‡½æ•°å¿…é¡»åœ¨runtimeåŒ…é‡Œã€‚è€Œæˆ‘ä»¬åˆéœ€è¦è°ƒç”¨ç”¨æˆ·å®šä¹‰åœ¨mainåŒ…é‡Œçš„mainå‡½æ•°ï¼Œä½†mainåŒ…ä¸èƒ½è¢«importï¼Œå› æ­¤åªèƒ½é linknameæŒ‡ä»¤è®©é“¾æ¥å™¨ç»•è¿‡æ‰€æœ‰ç¼–è¯‘å™¨é™„åŠ çš„é™åˆ¶æ¥è°ƒç”¨mainå‡½æ•°ã€‚\nè¿™æ˜¯ç›®å‰åœ¨goè‡ªèº«çš„æºä»£ç é‡Œçœ‹åˆ°çš„å”¯ä¸€ä¸€å¤„ä¸å¾—ä¸ä½¿ç”¨â€œpull-onlyâ€æ¨¡å¼çš„åœ°æ–¹ã€‚\nå¦å¤–â€œhandshakeâ€æ¨¡å¼ä¹Ÿæœ‰å­˜åœ¨çš„å¿…è¦æ€§ï¼Œå› ä¸ºåƒruntimeå’Œreflectéœ€è¦å…±äº«å¾ˆå¤šå®ç°ä¸Šçš„ç»†èŠ‚ï¼Œå› æ­¤reflectä½œä¸ºpullçš„ä¸€æ–¹ï¼Œruntimeä½œä¸ºpushçš„ä¸€æ–¹ï¼Œå¯ä»¥æå¤§å‡å°‘ä»£ç ç»´æŠ¤çš„å¤æ‚åº¦ã€‚\né™¤äº†ä¸Šè¿°è¿™äº›æƒ…å†µï¼Œç»å¤§æ•°linknameçš„ä½¿ç”¨éƒ½å¯ä»¥ç®—ä½œ_abuse_ã€‚\ngolang1.23å¯¹linknameæŒ‡ä»¤çš„æ”¹åŠ¨ é‰´äºä¸Šè¿°æƒ…å†µï¼Œgolangæ ¸å¿ƒå›¢é˜Ÿå†³å®šé™åˆ¶linknameçš„ä½¿ç”¨ã€‚\nç¬¬ä¸€ä¸ªæ”¹åŠ¨æ˜¯æ ‡å‡†åº“é‡Œæ–°æ·»åŠ çš„åŒ…å…¨éƒ¨ç¦æ­¢ä½¿ç”¨linknameå¯¼å‡ºå…¶ä¸­çš„å†…å®¹ï¼Œç›®å‰æ˜¯é€šè¿‡é»‘åå•å®ç°çš„ï¼Œ1.23ä¸­æ–°æ·»åŠ çš„å‡ ä¸ªåŒ…ä»¥åŠå®ƒä»¬çš„internalä¾èµ–éƒ½åœ¨åå•ä¸Šï¼Œè¿™æ ·å¯ä»¥é˜²æ­¢å·²æœ‰çš„linknameé—®é¢˜ç»§ç»­æ‰©å¤§ã€‚è¿™å¯¹å·²æœ‰çš„ä»£ç ä¹Ÿæ˜¯å®Œå…¨æ— å®³çš„ã€‚\nç¬¬äºŒä¸ªå˜æ›´æ—¶æ·»åŠ äº†æ–°çš„ldflags: -checklinkname=1ã€‚1ä»£è¡¨å¼€å¯å¯¹linknameçš„é™åˆ¶ï¼Œ0ä»£è¡¨ç»´æŒ1.22çš„è¡Œä¸ºä¸å˜ã€‚ç›®å‰é»˜è®¤æ˜¯0ï¼Œä½†å®˜æ–¹å†³å®šåœ¨1.23å‘å¸ƒæ—¶é»˜è®¤å€¼ä¸º1å¼€å¯é™åˆ¶ã€‚ä¸ªäººå»ºè®®å°½é‡ä¸è¦å…³é—­è¿™ä¸ªé™åˆ¶ã€‚è¿™ä¸ªé™åˆ¶çœ¼ä¸‹åªé’ˆå¯¹æ ‡å‡†åº“ï¼Œä½†æŒ‰å®˜æ–¹çš„è¯´æ³•æ•ˆæœå¥½çš„è¯ä»¥åæ‰€æœ‰çš„ä»£ç ä¸ç®¡æ ‡å‡†åº“è¿˜æ˜¯ç¬¬ä¸‰æ–¹éƒ½ä¼šå¯ç”¨é™åˆ¶ã€‚\næœ€åä¹Ÿæ˜¯æœ€å¤§çš„å˜åŠ¨ï¼Œç¦æ­¢å¯¹æ ‡å‡†åº“çš„ â€œpull-onlyâ€ linknameæŒ‡ä»¤ï¼Œä½†å…è®¸â€œhandshakeâ€æ¨¡å¼ã€‚\nè™½ç„¶goä»æ¥ä¸ä¿è¯linknameçš„å‘åå…¼å®¹æ€§ï¼Œä½†è¿™æ ·è¿˜æ˜¯ä¼šå¤§é‡è¾ƒå¤§çš„ç ´åï¼Œå› æ­¤å®˜æ–¹å·²ç»å¯¹å¸¸è§çš„goç¬¬ä¸‰æ–¹åº“åšäº†æ‰«æï¼Œä¼šæŠŠä¸€äº›ç»å¸¸è¢«äººç”¨linknameæ‹‰å–çš„æ¥å£æ”¹æˆç¬¦åˆâ€œhandshakeâ€æ¨¡å¼çš„å½¢å¼ï¼Œè¿™ç§æ”¹åŠ¨åªç”¨åŠ ä¸€è¡ŒæŒ‡ä»¤å³å¯ã€‚è€Œä¸”è¯¥é™åˆ¶ç›®å‰åªé’ˆå¯¹æ ‡å‡†åº“ï¼Œå…¶ä»–ç¬¬ä¸‰æ–¹åº“æš‚æ—¶ä¸å—å½±å“ã€‚\nå› ä¸ºè¿™ä¸ªå˜æ›´ï¼Œä¸‹é¢çš„ä»£ç åœ¨1.23æ˜¯æ— æ³•ç¼–è¯‘é€šè¿‡çš„ï¼š\n1 2 3 4 5 6 7 8 package main import _ \u0026#34;unsafe\u0026#34; //go:linkname corostart runtime.corostart func corostart() func main() { corostart() } å› ä¸ºruntime.corostartå¹¶ä¸ç¬¦åˆhandshakeæ¨¡å¼ï¼Œæ‰€ä»¥å¯¹å®ƒçš„linknameè¢«ç¦æ­¢äº†ï¼š\n1 2 3 4 5 $ go version go version devel go1.23-13d36a9b46 Wed May 27 21:51:49 2024 +0000 windows/amd64 $ go build -ldflags=-checklinkname=1 # linkname link: main: invalid reference to runtime.corostart linknameæŒ‡ä»¤ä»Šåçš„å‘å±• å¤§è¶‹åŠ¿è‚¯å®šæ˜¯ä»¥ååªå…è®¸handshakeæ¨¡å¼ã€‚ä¸è¿‡ä½œä¸ºè¿‡æ¸¡ç›®å‰è¿˜æ˜¯å…è®¸pushæ¨¡å¼çš„ï¼Œå¹¶ä¸”å®˜æ–¹åº”è¯¥ä¼šåœ¨è¿›å…¥åŠŸèƒ½å†»ç»“åæŠŠä¹‹å‰è¯´çš„æ‰«æåˆ°çš„å¸¸ç”¨çš„å†…éƒ¨å‡½æ•°æ·»åŠ ä¸ŠlinknameæŒ‡ä»¤ã€‚\nè¿™é‡Œæ¯”è¾ƒé‡è¦çš„æ˜¯ä½œä¸ºå¼€å‘è€…çš„æˆ‘ä»¬åº”è¯¥æ€ä¹ˆåŠï¼š\n1.23å‘å¸ƒä¹‹åæˆ–è€…ç°åœ¨å°±å¼€å§‹åˆ©ç”¨-checklinkname=1æ’æŸ¥ä»£ç ï¼ŒåŠæ—¶æ¸…é™¤ä¸å¿…è¦çš„linknameæŒ‡ä»¤ã€‚ å¦‚æœlinknameæŒ‡ä»¤éç”¨ä¸å¯ï¼Œå»ºè®®é©¬ä¸Šæissueæˆ–è€…ç†Ÿæ‚‰goå¼€å‘æµç¨‹çš„ç«‹åˆ»æprè¡¥ä¸Šhandshakeæ¨¡å¼éœ€è¦çš„æŒ‡ä»¤ï¼Œä¸è¿‡æˆ‘ä¸æ€ä¹ˆæ¨èè¿™ç§åšæ³•ï¼Œå› ä¸ºå†…éƒ¨apiå°¤å…¶æ˜¯runtimeä»¥å¤–çš„åº“çš„æœ¬æ¥å°±ä¸è¯¥éšä¾¿è¢«å¯¼å‡ºä½¿ç”¨ï¼Œæ²¡æœ‰ä¸€ä¸ªå¼ºåŠ›çš„èƒ½è¯´æœæ‰€æœ‰äººçš„ç†ç”±ï¼Œè¿™äº›issueå’Œprå¤šåŠä¸ä¼šè¢«æ¥å—ã€‚ å‘å®˜æ–¹ææ¡ˆï¼Œå°è¯•æŠŠä½ è¦ç”¨çš„ç§æœ‰apiå˜æˆå…¬å¼€æ¥å£ï¼Œè¿™ä¸€æ­¥éš¾åº¦ä¹Ÿå¾ˆé«˜ï¼Œç§æœ‰apiä¹‹æ‰€ä»¥å½“åˆä¸å…¬å¼€ä¸€å®šæ˜¯æœ‰åŸå› çš„ï¼Œç°åœ¨å†æƒ³å…¬å¼€å¯èƒ½æ€§ä¹Ÿä¸é«˜ã€‚ ä½ çš„è¿½æ±‚æ¯”è¾ƒä½ï¼Œåªè¦ä»£ç èƒ½è·‘å°±è¡Œï¼Œé‚£å¯ä»¥åœ¨æ„å»ºè„šæœ¬é‡ŒåŠ ä¸Š-ldflags=-checklinkname=0å…³é—­é™åˆ¶ï¼Œè¿™æ ·ä¹Ÿè®¸èƒ½å²æœˆé™å¥½å‡ ä¸ªç‰ˆæœ¬ï¼Œç›´åˆ°æŸä¸€å¤©ç¨‹åºçªç„¶æ²¡æ³•ç¼–è¯‘æˆ–è€…è¿è¡Œäº†ä¸€åŠè¢«è«åå…¶å¦™çš„panicæ‰“æ–­ã€‚ 4æ˜¯ä¸‡ä¸å¾—å·²æ—¶çš„ä¿åº•æ–¹æ¡ˆï¼ŒæŒ‰ä¼˜å…ˆåº¦æˆ‘æ¨è1 \u0026gt; 3 \u0026gt; 2çš„é¡ºåºå»é€‚é…go1.23ã€‚2å’Œ3ä¸ä»…ä»…é€‚ç”¨äºgoæ ‡å‡†åº“ï¼Œå¸¸ç”¨çš„ç¬¬ä¸‰æ–¹åº“ä¹Ÿå¯ä»¥ã€‚é€šè¿‡è¿™äº›é€‚é…å·¥ä½œè¯´ä¸å®šä¹Ÿæœ‰æœºä¼šè®©ä½ æˆä¸ºgoæˆ–è€…çŸ¥åç¬¬ä¸‰æ–¹åº“çš„è´¡çŒ®è€…ã€‚\nä»ç°åœ¨å¼€å§‹å®Œå…¨æ˜¯æ¥å¾—åŠçš„ï¼Œæ¯•ç«Ÿç¦»1.23çš„ç¬¬ä¸€ä¸ªæµ‹è¯•ç‰ˆå‘å¸ƒè¿˜æœ‰ä¸€ä¸ªæœˆå·¦å³ï¼Œç¦»æ­£å¼ç‰ˆå‘å¸ƒè¿˜æœ‰ä¸¤ä¸ªæœˆã€‚è€Œä¸”æ–¹æ¡ˆ2çš„ä¿®æ”¹å¹¶ä¸ç®—ä½œæ–°åŠŸèƒ½ï¼Œä¸å—åŠŸèƒ½å†»ç»“çš„å½±å“ã€‚\nå½“ç„¶ï¼Œå¤§éƒ¨åˆ†å¼€å‘è€…åº”è¯¥ä¸ç”¨æ‹…å¿ƒï¼Œæ¯”è¾ƒlinknameçš„ä½¿ç”¨æ˜¯å°‘æ•°ï¼Œä¸€äº›ä¸»åŠ¨ä½¿ç”¨linknameçš„åº“æ¯”å¦‚quic-goä¹ŸçŸ¥é“å…¼å®¹æ€§é—®é¢˜ï¼Œå¾ˆå°å¿ƒåœ°åšäº†ä¸åŒç‰ˆæœ¬çš„é€‚é…ï¼ŒåŠ ä¸Šå®˜æ–¹æ‰¿è¯ºçš„å…œåº•è¿™ä¸€å¯¹linknameæŒ‡ä»¤çš„æ”¹åŠ¨çš„å½±å“åº”è¯¥æ¯”æƒ³è±¡ä¸­å°ï¼Œä½†æ˜¯æ˜¯æé«˜ä»£ç å®‰å…¨æ€§çš„ä¸€å¤§æ­¥ã€‚\næ€»ç»“ æœ€åæ€»ç»“å°±ä¸€å¥è¯ï¼šæ²¡äº‹åˆ«ç”¨//go:linkname å¯èƒ½ä¼šç•™ä¸‹ä¸å¯é¢„çŸ¥çš„éšæ‚£ã€‚\n","date":"2024-05-27T09:37:25+08:00","permalink":"https://huizhou92.com/zh-cn/p/%23-golang-1.23-changes-to-/golinkname-and-what-it-means-for-developers/","title":"Golang 1.23ï¼š`//go:linkname` çš„å˜æ›´åŠå…¶å¯¹å¼€å‘äººå‘˜çš„æ„ä¹‰"},{"content":"èƒŒæ™¯ gRPCæ˜¯googleå¼€æºçš„é«˜æ€§èƒ½è·¨è¯­è¨€çš„RPCæ–¹æ¡ˆã€‚gRPCçš„è®¾è®¡ç›®æ ‡æ˜¯åœ¨ä»»ä½•ç¯å¢ƒä¸‹è¿è¡Œï¼Œæ”¯æŒå¯æ’æ‹”çš„è´Ÿè½½å‡è¡¡ï¼Œè·Ÿè¸ªï¼Œè¿è¡ŒçŠ¶å†µæ£€æŸ¥å’Œèº«ä»½éªŒè¯ã€‚å®ƒä¸ä»…æ”¯æŒæ•°æ®ä¸­å¿ƒå†…éƒ¨å’Œè·¨æ•°æ®ä¸­å¿ƒçš„æœåŠ¡è°ƒç”¨ï¼Œå®ƒä¹Ÿé€‚ç”¨äºåˆ†å¸ƒå¼è®¡ç®—çš„æœ€åä¸€å…¬é‡Œï¼Œå°†è®¾å¤‡ï¼Œç§»åŠ¨åº”ç”¨ç¨‹åºå’Œæµè§ˆå™¨è¿æ¥åˆ°åç«¯æœåŠ¡ã€‚\nå…³äº GRPCè®¾è®¡çš„åŠ¨æœºå’ŒåŸåˆ™ æˆ‘ä»¬å¯ä»¥ä»è¿™ç¯‡æ–‡ç« é‡Œé¢æ‰¾åˆ°ç­”æ¡ˆï¼ŒgRPC Motivation and Design Principles\nThis article is first published in the medium MPP plan. If you are a medium user, please follow me in medium. Thank you very much.\nå®˜æ–¹çš„æ–‡ç« ä»¤äººå°è±¡æ·±åˆ»çš„ç‚¹ï¼š\nå†…éƒ¨æœ‰Stubbyçš„æ¡†æ¶ï¼Œä½†æ˜¯å®ƒä¸æ˜¯åŸºäºä»»ä½•ä¸€ä¸ªæ ‡å‡†çš„ æ”¯æŒä»»æ„ç¯å¢ƒä½¿ç”¨ï¼Œæ”¯æŒç‰©è”ç½‘ã€æ‰‹æœºã€æµè§ˆå™¨ æ”¯æŒstreamå’Œæµæ§ å®é™…ä¸Šï¼šæ€§èƒ½ä¸æ˜¯gRPC è®¾è®¡çš„ç¬¬ä¸€ç›®æ ‡ã€‚é‚£ä¹ˆä¸ºä»€ä¹ˆé€‰æ‹©HTTP/2?\nHTTP/2æ˜¯ä»€ä¹ˆ åœ¨æ­£å¼è®¨è®ºgRPCä¸ºä»€ä¹ˆé€‰æ‹©HTTP/2ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥ç®€å•äº†è§£ä¸‹HTTP/2ã€‚\nHTTP/2å¯ä»¥ç®€å•ç”¨ä¸€ä¸ªå›¾ç‰‡æ¥ä»‹ç»ï¼š\næ¥è‡ªï¼šhttps://hpbn.co/\nHTTP/1é‡Œçš„headerå¯¹åº”HTTP/2é‡Œçš„ HEADERS frame HTTP/1é‡Œçš„payloadå¯¹åº”HTTP/2é‡Œçš„ DATA frame\nåœ¨Chromeæµè§ˆå™¨é‡Œï¼Œæ‰“å¼€chrome://net-internals/#http2ï¼Œå¯ä»¥çœ‹åˆ°http2é“¾æ¥çš„ä¿¡æ¯ã€‚\nç›®å‰å¾ˆå¤šç½‘ç«™éƒ½å·²ç»è·‘åœ¨HTTP/2ä¸Šäº†ã€‚\ngRPC Over HTTP/2 å‡†ç¡®æ¥è¯´gRPCè®¾è®¡ä¸Šæ˜¯åˆ†å±‚çš„ï¼Œåº•å±‚æ”¯æŒä¸åŒçš„åè®®ï¼Œç›®å‰gRPCæ”¯æŒï¼š\ngRPC over HTTP2 gRPC Web ä½†æ˜¯å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œè®¨è®ºéƒ½æ˜¯åŸºäºgRPC over HTTP2ã€‚\nä¸‹é¢ä»ä¸€ä¸ªçœŸå®çš„gRPC SayHelloè¯·æ±‚ï¼ŒæŸ¥çœ‹å®ƒåœ¨HTTP/2ä¸Šæ˜¯æ€æ ·å®ç°çš„ã€‚ç”¨WiresharkæŠ“åŒ…ï¼š\nå¯ä»¥çœ‹åˆ°ä¸‹é¢è¿™äº›Headerï¼š\n1 2 3 4 5 6 Header: :authority: localhost:50051 Header: :path: /helloworld.Greeter/SayHello Header: :method: POST Header: :scheme: http Header: content-type: application/grpc Header: user-agent: grpc-java-netty/1.11.0 ç„¶åè¯·æ±‚çš„å‚æ•°åœ¨DATA frameé‡Œï¼š\nGRPC Message: /helloworld.Greeter/SayHello, Request\nç®€è€Œè¨€ä¹‹ï¼ŒgGRPCæŠŠå…ƒæ•°æ®æ”¾åˆ°HTTP/2 Headersé‡Œï¼Œè¯·æ±‚å‚æ•°åºåˆ—åŒ–ä¹‹åæ”¾åˆ° DATA frameé‡Œã€‚\nåŸºäºHTTP/2 åè®®çš„ä¼˜ç‚¹ HTTP/2 æ˜¯ä¸€ä¸ªå…¬å¼€çš„æ ‡å‡† Googleæœ¬èº«æŠŠè¿™ä¸ªäº‹æƒ…æƒ³æ¸…æ¥šäº†ï¼Œå®ƒå¹¶æ²¡æœ‰æŠŠå†…éƒ¨çš„Stubbyå¼€æºï¼Œè€Œæ˜¯é€‰æ‹©é‡æ–°åšã€‚ç°åœ¨æŠ€æœ¯è¶Šæ¥è¶Šå¼€æ”¾ï¼Œç§æœ‰åè®®çš„ç©ºé—´è¶Šæ¥è¶Šå°ã€‚\nHTTP/2 æ˜¯ä¸€ä¸ªç»è¿‡å®è·µæ£€éªŒçš„æ ‡å‡† HTTP/2æ˜¯å…ˆæœ‰å®è·µå†æœ‰æ ‡å‡†ï¼Œè¿™ä¸ªå¾ˆé‡è¦ã€‚å¾ˆå¤šä¸æˆåŠŸçš„æ ‡å‡†éƒ½æ˜¯å…ˆæœ‰ä¸€å¤§å †å‚å•†è®¨è®ºå‡ºæ ‡å‡†åæœ‰å®ç°ï¼Œå¯¼è‡´æ··ä¹±è€Œä¸å¯ç”¨ï¼Œæ¯”å¦‚CORBAã€‚HTTP/2çš„å‰èº«æ˜¯Googleçš„SPDYï¼Œæ²¡æœ‰Googleçš„å®è·µå’Œæ¨åŠ¨ï¼Œå¯èƒ½éƒ½ä¸ä¼šæœ‰HTTP/2ã€‚\nHTTP/2 å¤©ç„¶æ”¯æŒç‰©è”ç½‘ã€æ‰‹æœºã€æµè§ˆå™¨ å®é™…ä¸Šå…ˆç”¨ä¸ŠHTTP/2çš„ä¹Ÿæ˜¯æ‰‹æœºå’Œæ‰‹æœºæµè§ˆå™¨ã€‚ç§»åŠ¨äº’è”ç½‘æ¨åŠ¨äº†HTTP/2çš„å‘å±•å’Œæ™®åŠã€‚\nåŸºäºHTTP/2 å¤šè¯­è¨€çš„å®ç°å®¹æ˜“ åªè®¨è®ºåè®®æœ¬èº«çš„å®ç°ï¼Œä¸è€ƒè™‘åºåˆ—åŒ–ã€‚\næ¯ä¸ªæµè¡Œçš„ç¼–ç¨‹è¯­è¨€éƒ½ä¼šæœ‰æˆç†Ÿçš„HTTP/2 Client HTTP/2 Clientæ˜¯ç»è¿‡å……åˆ†æµ‹è¯•ï¼Œå¯é çš„ ç”¨Clientå‘é€HTTP/2è¯·æ±‚çš„éš¾åº¦è¿œä½äºç”¨socketå‘é€æ•°æ®åŒ…/è§£ææ•°æ®åŒ… HTTP/2æ”¯æŒStreamå’Œæµæ§ åœ¨ä¸šç•Œï¼Œæœ‰å¾ˆå¤šæ”¯æŒstreamçš„æ–¹æ¡ˆï¼Œæ¯”å¦‚åŸºäºwebsocketçš„ï¼Œæˆ–è€…rsocketã€‚ä½†æ˜¯è¿™äº›æ–¹æ¡ˆéƒ½ä¸æ˜¯é€šç”¨çš„ã€‚\nHTTP/2é‡Œçš„Streamè¿˜å¯ä»¥è®¾ç½®ä¼˜å…ˆçº§ï¼Œå°½ç®¡åœ¨rpcé‡Œå¯èƒ½ç”¨çš„æ¯”è¾ƒå°‘ï¼Œä½†æ˜¯ä¸€äº›å¤æ‚çš„åœºæ™¯å¯èƒ½ä¼šç”¨åˆ°ã€‚\nåŸºäºHTTP/2 åœ¨Gateway/Proxyå¾ˆå®¹æ˜“æ”¯æŒ nginxå¯¹gRPCçš„æ”¯æŒ envoyå¯¹gRPCçš„æ”¯æŒ HTTP/2 å®‰å…¨æ€§æœ‰ä¿è¯ HTTP/2 å¤©ç„¶æ”¯æŒSSLï¼Œå½“ç„¶gRPCå¯ä»¥è·‘åœ¨clear textåè®®ï¼ˆå³ä¸åŠ å¯†ï¼‰ä¸Šã€‚ å¾ˆå¤šç§æœ‰åè®®çš„rpcå¯èƒ½è‡ªå·±åŒ…è£…äº†ä¸€å±‚TLSæ”¯æŒï¼Œä½¿ç”¨èµ·æ¥ä¹Ÿéå¸¸å¤æ‚ã€‚å¼€å‘è€…æ˜¯å¦æœ‰è¶³å¤Ÿçš„å®‰å…¨çŸ¥è¯†ï¼Ÿä½¿ç”¨è€…æ˜¯å¦é…ç½®å¯¹äº†ï¼Ÿè¿ç»´è€…æ˜¯å¦èƒ½æ­£ç¡®ç†è§£ï¼Ÿ HTTP/2 åœ¨å…¬æœ‰ç½‘ç»œä¸Šçš„ä¼ è¾“ä¸Šæœ‰ä¿è¯ã€‚æ¯”å¦‚è¿™ä¸ªCRIMEæ”»å‡»ï¼Œç§æœ‰åè®®å¾ˆéš¾ä¿è¯æ²¡æœ‰è¿™æ ·å­çš„æ¼æ´ã€‚ HTTP/2 é‰´æƒæˆç†Ÿ ä»HTTP/1å‘å±•èµ·æ¥çš„é‰´æƒç³»ç»Ÿå·²ç»å¾ˆæˆç†Ÿäº†ï¼Œå¯ä»¥æ— ç¼ç”¨åœ¨HTTP/2ä¸Š å¯ä»¥ä»å‰ç«¯åˆ°åç«¯å®Œå…¨æ‰“é€šçš„é‰´æƒï¼Œä¸éœ€è¦åšä»»ä½•è½¬æ¢é€‚é…\næ¯”å¦‚ä¼ ç»Ÿçš„rpc dubboï¼Œéœ€è¦å†™ä¸€ä¸ªdubbo filterï¼Œè¿˜è¦è€ƒè™‘æŠŠé‰´æƒç›¸å…³çš„ä¿¡æ¯é€šè¿‡thread localä¼ é€’è¿›å»ã€‚rpcåè®®æœ¬èº«ä¹Ÿéœ€è¦æ”¯æŒã€‚æ€»ä¹‹ï¼Œéå¸¸å¤æ‚ã€‚å®é™…ä¸Šç»å¤§éƒ¨åˆ†å…¬å¸é‡Œçš„rpcéƒ½æ˜¯æ²¡æœ‰é‰´æƒçš„ï¼Œå¯ä»¥éšä¾¿è°ƒã€‚ åŸºäºHTTP/2 çš„ç¼ºç‚¹ rpcçš„å…ƒæ•°æ®çš„ä¼ è¾“ä¸å¤Ÿé«˜æ•ˆ å°½ç®¡HPACå¯ä»¥å‹ç¼©HTTP Headerï¼Œä½†æ˜¯å¯¹äºrpcæ¥è¯´ï¼Œç¡®å®šä¸€ä¸ªå‡½æ•°è°ƒç”¨ï¼Œå¯ä»¥ç®€åŒ–ä¸ºä¸€ä¸ªintï¼Œåªè¦ä¸¤ç«¯å»åå•†è¿‡ä¸€æ¬¡ï¼Œåé¢ç›´æ¥æŸ¥è¡¨å°±å¯ä»¥äº†ï¼Œä¸éœ€è¦åƒHPACé‚£æ ·ç¼–ç è§£ç ã€‚\nå¯ä»¥è€ƒè™‘ä¸“é—¨å¯¹gRPCåšä¸€ä¸ªä¼˜åŒ–è¿‡çš„HTTP/2è§£æå™¨ï¼Œå‡å°‘ä¸€äº›é€šç”¨çš„å¤„ç†ï¼Œæ„Ÿè§‰å¯ä»¥æå‡æ€§èƒ½ã€‚\nHTTP/2 é‡Œä¸€æ¬¡gRPCè°ƒç”¨éœ€è¦è§£ç ä¸¤æ¬¡ ä¸€æ¬¡æ˜¯HEADERS frameï¼Œä¸€æ¬¡æ˜¯DATA frameã€‚\nHTTP/2 æ ‡å‡†æœ¬èº«æ˜¯åªæœ‰ä¸€ä¸ªTCPè¿æ¥ï¼Œä½†æ˜¯å®é™…åœ¨gRPCé‡Œæ˜¯ä¼šæœ‰å¤šä¸ªTCPè¿æ¥ï¼Œä½¿ç”¨æ—¶éœ€è¦æ³¨æ„ã€‚\ngRPCé€‰æ‹©åŸºäºHTTP/2ï¼Œé‚£ä¹ˆå®ƒçš„æ€§èƒ½è‚¯å®šä¸ä¼šæ˜¯æœ€é¡¶å°–çš„ã€‚ä½†æ˜¯å¯¹äºrpcæ¥è¯´ä¸­åº¸çš„qpså¯ä»¥æ¥å—ï¼Œé€šç”¨å’Œå…¼å®¹æ€§æ‰æ˜¯æœ€é‡è¦çš„äº‹æƒ…ã€‚æˆ‘ä»¬å¯ä»¥å‚è€ƒä¸€ä¸‹å®˜æ–¹çš„benchmarkï¼šhttps://grpc.io/docs/guides/benchmarking.html\nhttps://github.com/hank-whu/rpc-benchmark\nå¦‚æœæ‚¨çš„åœºæ™¯æ˜¯æ Googleåˆ¶å®šæ ‡å‡†çš„èƒ½åŠ› è¿‘10å¹´æ¥ï¼ŒGoogleåˆ¶å®šæ ‡å‡†çš„èƒ½åŠ›è¶Šæ¥è¶Šå¼ºã€‚ä¸‹é¢åˆ—ä¸¾ä¸€äº›æ ‡å‡†ï¼š\nHTTP/2 WebPå›¾ç‰‡æ ¼å¼ WebRTC ç½‘é¡µå³æ—¶é€šä¿¡ VP9/AV1 è§†é¢‘ç¼–ç æ ‡å‡† Service Worker/PWA QUIC/ HTTP/3\nå½“ç„¶googleä¹Ÿå¹¶ä¸éƒ½ä¼šæˆåŠŸï¼Œå¾ˆå¤šäº‹æƒ…å®ƒæƒ³æ¨ä¹Ÿå¤±è´¥äº†ï¼Œæ¯”å¦‚Chromeçš„Native Clientã€‚ gRPCç›®å‰æ˜¯k8sç”Ÿæ€é‡Œçš„äº‹å®æ ‡å‡†ã€‚ gRPCæ˜¯å¦ä¼šæˆä¸ºæ›´å¤šåœ°æ–¹ï¼Œæ›´å¤§é¢†åŸŸçš„RPCæ ‡å‡†ï¼Ÿ\nä¸ºä»€ä¹ˆä¼šå‡ºç°gRPC å‡†ç¡®æ¥è¯´ä¸ºä»€ä¹ˆä¼šå‡ºç°åŸºäºHTTP/2çš„RPCï¼Ÿ\nä¸ªäººè®¤ä¸ºä¸€ä¸ªé‡è¦çš„åŸå› æ˜¯ï¼Œåœ¨Cloud Nativeçš„æ½®æµä¸‹ï¼Œå¼€æ”¾äº’é€šçš„éœ€æ±‚å¿…ç„¶ä¼šäº§ç”ŸåŸºäºHTTP/2çš„RPCã€‚å³ä½¿æ²¡æœ‰gRPCï¼Œä¹Ÿä¼šæœ‰å…¶å®ƒåŸºäºHTTP/2çš„RPCã€‚\ngRPCåœ¨Googleçš„å†…éƒ¨ä¹Ÿæ˜¯å…ˆç”¨åœ¨Google Cloud Platformå’Œå…¬å¼€çš„APIä¸Šï¼šhttps://opensource.google.com/projects/grpc\næ€»ç»“ å°½ç®¡gRPCå®ƒå¯èƒ½æ›¿æ¢ä¸äº†å†…éƒ¨çš„RPCå®ç°ï¼Œä½†æ˜¯åœ¨å¼€æ”¾äº’é€šçš„æ—¶ä»£ï¼Œä¸æ­¢åœ¨k8sä¸Šï¼ŒgRPCä¼šæœ‰è¶Šæ¥è¶Šå¤šçš„èˆå°å¯ä»¥æ–½å±•ã€‚\nå‚è€ƒèµ„æ–™ https://grpc.io/ https://hpbn.co/ https://grpc.io/blog/loadbalancing https://http2.github.io/faq https://github.com/grpc/grpc ","date":"2024-05-23T10:25:02+08:00","image":"https://huizhou92.com/cb553b8f542344f88169374915cb1819.png","permalink":"https://huizhou92.com/zh-cn/p/why-did-google-choose-to-implement-grpc-using-http2/","title":"ä¸ºä»€ä¹ˆ Google é€‰æ‹©ä½¿ç”¨HTTP 2 å®ç° gRPC"},{"content":"æ‘˜è¦ wireshark æ˜¯ä¸€ä¸ª æµè¡Œçš„æŠ“å–ç½‘ç»œæŠ¥æ–‡çš„å·¥å…·,ä»–ä¸ä»…è‡ªå·±å¯ä»¥æŠ“åŒ…ï¼Œä¹Ÿå¯ä»¥è§£ætcpdumpæŠ“åŒ…çš„æ–‡ä»¶ã€‚\ngRPC æ˜¯Googleå¼€å‘çš„ä¸€ä¸ªé«˜æ€§èƒ½RPCæ¡†æ¶ï¼ŒåŸºäºHTTP/2åè®®+protobufåºåˆ—åŒ–åè®®.\næœ¬æ–‡ä¸»è¦ä»‹ç»å¦‚ä½•ä½¿ç”¨wiresharkæŠ“å–gRPCçš„æŠ¥æ–‡ï¼Œå¹¶è§£ææŠ¥æ–‡å†…å®¹ã€‚\nThis article is first published in the medium MPP plan. If you are a medium user, please follow me in medium. Thank you very much.\nWireshark version: 4.2.2\né…ç½® å› ä¸ºgRPC æ˜¯åŸºäºprotobufåºåˆ—åŒ–åè®®ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å…ˆæ·»åŠ protobufçš„æ–‡ä»¶åœ°å€ã€‚\nç‚¹å‡» Wireshark -\u0026gt; Preferences\u0026hellip; -\u0026gt; Protocols -\u0026gt; Protobuf -\u0026gt; Protobuf search paths -\u0026gt; Edit\u0026hellip;\nç‚¹å‡»+ æ·»åŠ æ‚¨è¦æŠ“åŒ…çš„protobuf æ–‡ä»¶è·¯å¾„ï¼Œä¸è¦å¿˜è®°å‹¾é€‰å³è¾¹çš„ Load all files\nå…·ä½“æ“ä½œ é¦–å…ˆæˆ‘ä»¬å†™ä¸€ä¸ªæœ€ç®€å•çš„gRPCæœåŠ¡ï¼Œ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 syntax = \u0026#34;proto3\u0026#34;; option go_package = \u0026#34;example.com/hxzhouh/go-example/grpc/helloworld/api\u0026#34;; package api; // The greeting service definition. service Greeter { // Sends a greeting rpc SayHello (HelloRequest) returns (HelloReply) {} } // The request message containing the user\u0026#39;s name. message HelloRequest { string name = 1; } // The response message containing the greetings message HelloReply { string message = 1; } å®ƒä»…ä»…å°±ä¸€ä¸ªå‡½æ•° Greeter ,è¡¥å……å®ŒæœåŠ¡ç«¯ä»£ç ï¼ŒæŠŠå®ƒè¿è¡Œèµ·æ¥ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 type server struct { api.UnimplementedGreeterServer } func (s *server) SayHello(ctx context.Context, in *api.HelloRequest) (*api.HelloReply, error) { log.Printf(\u0026#34;Received: %v\u0026#34;, in.GetName()) return \u0026amp;api.HelloReply{Message: \u0026#34;Hello \u0026#34; + in.GetName()}, nil } func main() { lis, err := net.Listen(\u0026#34;tcp\u0026#34;, \u0026#34;:50051\u0026#34;) if err != nil { log.Fatalf(\u0026#34;failed to listen: %v\u0026#34;, err) } s := grpc.NewServer() api.RegisterGreeterServer(s, \u0026amp;server{}) if err := s.Serve(lis); err != nil { log.Fatalf(\u0026#34;failed to serve: %v\u0026#34;, err) } } ç„¶åæˆ‘ä»¬æ‰“å¼€ wireshark ï¼Œé€‰æ‹©æœ¬åœ°ç½‘å¡ï¼Œç›‘å¬ tcp.port == 50051\nå¦‚æœæ‚¨ä»¥å‰æ²¡æ¥è§¦è¿‡ wiresharkï¼Œæˆ‘å»ºè®®æ‚¨å…ˆçœ‹çœ‹è¿™ç¯‡æ–‡ç« ï¼šhttps://www.lifewire.com/wireshark-tutorial-4143298\nä¸€å…ƒå‡½æ•° ç°åœ¨æˆ‘ä»¬æœ‰ä¸€ä¸ªgRPC æœåŠ¡è¿è¡Œå†æœ¬åœ°çš„50051 ç«¯å£ï¼Œ æˆ‘ä»¬å¯ä»¥ä½¿ç”¨BloomRPC æˆ–è€…å…¶ä»–æ‚¨ä»»ä½•å–œæ¬¢çš„å·¥å…·å¯¹æœåŠ¡ç«¯å‘èµ·ä¸€ä¸ªRPCè¯·æ±‚,æˆ–è€…ç›´æ¥åƒæˆ‘ä¸€æ ·ä½¿ç”¨ä¸‹é¢çš„ä»£ç \n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 func Test_server_SayHello(t *testing.T) { // Set up a connection to the server. conn, err := grpc.Dial(\u0026#34;localhost:50051\u0026#34;, grpc.WithInsecure(), grpc.WithBlock()) if err != nil { log.Fatalf(\u0026#34;did not connect: %v\u0026#34;, err) } defer conn.Close() c := api.NewGreeterClient(conn) // Contact the server and print out its response. name := \u0026#34;Hello\u0026#34; ctx, cancel := context.WithTimeout(context.Background(), time.Second) defer cancel() r, err := c.SayHello(ctx, \u0026amp;api.HelloRequest{Name: name}) if err != nil { log.Fatalf(\u0026#34;could not greet: %v\u0026#34;, err) } log.Printf(\u0026#34;Greeting: %s\u0026#34;, r.GetMessage()) } è¿™ä¸ªæ—¶å€™ï¼Œwireshark åº”è¯¥å°±èƒ½æŠ“åˆ°æµé‡åŒ…äº†ã€‚\nå‰é¢æˆ‘ä»¬è¯´è¿‡ï¼ŒgRPC = http2+protobuf, å¹¶ä¸”æˆ‘ä»¬å‰é¢å·²ç»åŠ è½½äº†protobuf æ–‡ä»¶ï¼Œç†è®ºä¸Šæˆ‘ä»¬ç°åœ¨å·²ç»èƒ½è§£ææŠ¥æ–‡äº†ã€‚\nä½¿ç”¨wiresharkå¿«æ·é”® shift+command+U æˆ–è€… ç”¨é¼ æ ‡ç‚¹å‡» Analyze -\u0026gt; Decode As... ç„¶åè®¾ç½®ä¸€ä¸‹å°†æŠ¥æ–‡è§£ææˆHTTP2 æ ¼å¼ã€‚\nè¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å°±èƒ½å¾ˆæ¸…æ™°çš„çœ‹åˆ°è¿™ä¸ªè¯·æ±‚äº†\nmetadata æˆ‘ä»¬çŸ¥é“ gRPC çš„metadata æ˜¯é€šè¿‡ http2 çš„header æ¥ä¼ é€’çš„ã€‚ ç°åœ¨æˆ‘ä»¬é€šè¿‡æŠ“åŒ…æ¥éªŒè¯ä¸€ä¸‹ã€‚\nç¨å¾®æ”¹é€ ä¸€ä¸‹å®¢æˆ·ç«¯ä»£ç \n1 2 3 4 5 6 7 8 9 10 11 12 func Test_server_SayHello(t *testing.T) { // Set up a connection to the server. ..... // add md md := map[string][]string{\u0026#34;timestamp\u0026#34;: {time.Now().Format(time.Stamp)}} md[\u0026#34;testmd\u0026#34;] = []string{\u0026#34;testmd\u0026#34;} ctx := metadata.NewOutgoingContext(context.Background(), md) // Contact the server and print out its response. name := \u0026#34;Hello\u0026#34; ctx, cancel := context.WithTimeout(ctx, time.Second) .... } ç„¶åé‡æ–°æŠ“åŒ…ã€‚ æˆ‘ä»¬å°±èƒ½çœ‹åˆ° md ç¡®å®æ”¾åœ¨ header é‡Œé¢ã€‚\nå¹¶ä¸”æˆ‘ä»¬è¿˜åœ¨header çœ‹åˆ°äº†grpc-timeout å¯è§è¯·æ±‚è¶…æ—¶æ“ä½œä¹Ÿæ˜¯æˆ¿å­å•Šheader é‡Œé¢çš„ã€‚é‡Œé¢æ¶‰åŠçš„å…·ä½“ç»†èŠ‚ï¼Œæˆ‘å¯èƒ½ä¼šå‡ºä¸€ç¯‡ä¸“é—¨çš„æ–‡ç« æ¥è¯´æ˜ï¼Œä»Šå¤©æˆ‘ä»¬åªå…³æ³¨æŠ“åŒ…ã€‚\nTLS ä¸Šé¢ä½¿ç”¨çš„ä¾‹å­éƒ½æ˜¯æ˜æ–‡ ä¼ è¾“çš„ æˆ‘ä»¬å†Dial çš„æ—¶å€™ä½¿ç”¨äº† grpc.WithInsecure() ,ä½†æ˜¯åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä½¿ç”¨TLS å¯¹è¿›è¡ŒåŠ å¯†ä¼ è¾“ã€‚å…·ä½“çš„ç»†èŠ‚å¯ä»¥å‚è€ƒæˆ‘ä»¥å‰å†™çš„æ–‡ç« ã€‚\nhttps://medium.com/gitconnected/secure-communication-with-grpc-from-ssl-tls-certification-to-san-certification-d9464c3d706f\næˆ‘ä»¬æ”¹é€ ä¸€ä¸‹ æœåŠ¡ç«¯ä»£ç \nhttps://gist.github.com/hxzhouh/e08546cf0457d28a614d59ec28870b11\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 func main() { certificate, err := tls.LoadX509KeyPair(\u0026#34;./keys/server.crt\u0026#34;, \u0026#34;./keys/server.key\u0026#34;) if err != nil { log.Fatalf(\u0026#34;Failed to load key pair: %v\u0026#34;, err) } certPool := x509.NewCertPool() ca, err := os.ReadFile(\u0026#34;./keys/ca.crt\u0026#34;) if err != nil { log.Fatalf(\u0026#34;Failed to read ca: %v\u0026#34;, err) } if ok := certPool.AppendCertsFromPEM(ca); !ok { log.Fatalf(\u0026#34;Failed to append ca certificate\u0026#34;) } opts := []grpc.ServerOption{ grpc.Creds( // ä¸ºæ‰€æœ‰ä¼ å…¥çš„è¿æ¥å¯ç”¨TLS credentials.NewTLS(\u0026amp;tls.Config{ ClientAuth: tls.RequireAndVerifyClientCert, Certificates: []tls.Certificate{certificate}, ClientCAs: certPool, }, )), } listen, err := net.Listen(\u0026#34;tcp\u0026#34;, fmt.Sprintf(\u0026#34;0.0.0.0:%d\u0026#34;, 50051)) if err != nil { log.Fatalf(\u0026#34;failed to listen %d port\u0026#34;, 50051) } // é€šè¿‡ä¼ å…¥çš„TLSæœåŠ¡å™¨å‡­è¯åˆ›å»ºæ–°çš„gRPCæœåŠ¡å®ä¾‹ s := grpc.NewServer(opts...) api.RegisterGreeterServer(s, \u0026amp;server{}) log.Printf(\u0026#34;server listening at %v\u0026#34;, listen.Addr()) if err := s.Serve(listen); err != nil { log.Fatalf(\u0026#34;Failed to serve: %v\u0026#34;, err) } } client\nhttps://gist.github.com/hxzhouh/46a7a31e2696b87fe6fb83c8ce7e036c\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 func Test_server_SayHello(t *testing.T) { certificate, err := tls.LoadX509KeyPair(\u0026#34;./keys/client.crt\u0026#34;, \u0026#34;./keys/client.key\u0026#34;) if err != nil { log.Fatalf(\u0026#34;Failed to load client key pair, %v\u0026#34;, err) } certPool := x509.NewCertPool() ca, err := os.ReadFile(\u0026#34;./keys/ca.crt\u0026#34;) if err != nil { log.Fatalf(\u0026#34;Failed to read %s, error: %v\u0026#34;, \u0026#34;./keys/ca.crt\u0026#34;, err) } if ok := certPool.AppendCertsFromPEM(ca); !ok { log.Fatalf(\u0026#34;Failed to append ca certs\u0026#34;) } opts := []grpc.DialOption{ grpc.WithTransportCredentials(credentials.NewTLS( \u0026amp;tls.Config{ ServerName: \u0026#34;localhost\u0026#34;, Certificates: []tls.Certificate{certificate}, RootCAs: certPool, })), } // conn, err := grpc.Dial(*addr, grpc.WithTransportCredentials(insecure.NewCredentials())) conn, err := grpc.Dial(\u0026#34;localhost:50051\u0026#34;, opts...) if err != nil { log.Fatalf(\u0026#34;Connect to %s failed\u0026#34;, \u0026#34;localhost:50051\u0026#34;) } defer conn.Close() client := api.NewGreeterClient(conn) ctx, cancel := context.WithTimeout(context.Background(), time.Second*5) defer cancel() r, err := client.SayHello(ctx, \u0026amp;api.HelloRequest{Name: \u0026#34;Hello\u0026#34;}) if err != nil { log.Printf(\u0026#34;Failed to greet, error: %v\u0026#34;, err) } else { log.Printf(\u0026#34;Greeting: %v\u0026#34;, r.GetMessage()) } } è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å†æŠ“åŒ…ï¼Œç„¶åä½¿ç”¨ç›¸åŒçš„æ–¹å¼è§£æã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬ä¼šå‘ç°ï¼Œä½¿ç”¨HTTP2 å·²ç»æ— æ³•è§£å¯†äº†ï¼Œä½†æ˜¯å¯ä»¥è§£ç æˆ TLS1.3\næ€»ç»“ è¿™ç¯‡æ–‡ç« ï¼Œé¦–å…ˆæ€»ç»“äº†ä½¿ç”¨ Wireshark æŠ“gRPC åŒ…çš„ä¸€ä¸ªåŸºæœ¬æµç¨‹ã€‚\nç„¶åæˆ‘ä»¬é€šè¿‡æŠ“åŒ…çŸ¥é“äº†gRPCçš„å‚æ•°ä¼ é€’æ˜¯é€šè¿‡ HTTP2 çš„data-frameï¼ŒCTX ç­‰meta æ˜¯é€šè¿‡ header ä¼ é€’çš„ã€‚è¿™äº›çŸ¥è¯†æˆ‘ä»¬ä»¥å‰è‚¯å®šå¬è¿‡ï¼Œä½†æ˜¯åªæœ‰åŠ¨æ‰‹å®éªŒæ‰èƒ½åŠ æ·±ç†è§£ã€‚\né€šè¿‡TLS æˆ‘ä»¬å¯ä»¥å®ç° å®‰å…¨çš„gRPC é€šä¿¡ï¼Œä¸‹ä¸€ç¯‡æ–‡ç« ï¼Œæˆ‘ä»¬å°†å°è¯•è§£å¯†TLS æŠ¥æ–‡ã€‚\nå‚è€ƒèµ„æ–™ Wireshark Tutorial https://grpc.io/blog/wireshark/ https://www.lifewire.com/wireshark-tutorial-4143298 ","date":"2024-05-19T21:36:25Z","image":"https://images.yixiao9206.cn/blog-images/2024/05/a8ca43282aece789e1e0b1d2a2db7a5f.png","permalink":"https://huizhou92.com/zh-cn/p/how-to-capture-and-analyze-grpc-packets/","title":"ä½¿ç”¨ wireshark æŠ“åŒ…GRPC"},{"content":"æˆ‘æœ€è¿‘å‡ å¹´ä¸€ç›´å†æ‰“é€ è‡ªå·±çš„ç¬¬äºŒå¤§è„‘ï¼Œä¸‹é¢æ˜¯æˆ‘çš„å‡ ä¸ªç»éªŒæ•™è®­ã€‚\né¢‘ç¹åˆ‡æ¢ç¬”è®°è½¯ä»¶/åšå®¢ç³»ç»Ÿ æˆ‘å…ˆåä½¿ç”¨è¿‡ EverNoteï¼ŒWizNoteï¼ŒVNoteï¼ŒCSDN blogï¼ŒGoogle blogspot, WordPressï¼Œæœ€ç»ˆåªé€ æˆåšå®¢æ•£è½åœ¨å¤šä¸ªäº’è”ç½‘è§’è½ã€‚è§£å†³åŠæ³•å°±æ˜¯ all in one ã€‚æˆ‘ç°åœ¨é€‰æ‹©çš„æ˜¯Obsidian\né¢‘ç¹åˆ‡æ¢ç¬”è®°æ ¼å¼ æˆ‘å…ˆåä½¿ç”¨è¿‡ txt, orgmode, markdownï¼Œå¯Œæ–‡æœ¬ç­‰å¤šç§æ ¼å¼ï¼Œæœ€ç»ˆåªé€ æˆå„ç§æ ¼å¼è½¬æ¢çƒ¦æ¼ï¼Œè·Ÿç¬¬ä¸€æ¡ä¸€æ ·ï¼Œæ¯ä¸ªç¬”è®°ç³»ç»Ÿçš„æ ¼å¼å¯èƒ½ä¸é€šç”¨ï¼Œé€‰æ‹©Obsidiançš„åŸå› å°±æ˜¯å®ƒçš„markdownè¯­æ³•ã€‚å¦‚æœæˆ‘éœ€è¦ï¼Œæˆ‘å¯ä»¥è½»æ˜“çš„å°†å®ƒè¿ç§»åˆ°ä»»ä½•ç¬”è®°ç³»ç»Ÿï¼Œ\né—ªå¿µç¬”è®°å’ŒçœŸæ­£æœ‰ç”¨çš„ç¬”è®°æ··æ‚ é—ªå¿µç¬”è®°ç”¨äºå¿«é€Ÿæ•æ‰ä¸€ç¬é—´çš„çµæ„Ÿï¼Œä½†åªæœ‰ä½ åœ¨ä¸€ä¸¤å¤©å†…å›é¡¾å®ƒå¹¶æŠŠå®ƒå˜æˆæœ‰ç”¨çš„åˆé€‚çš„ç¬”è®°æ‰æœ‰æ„ä¹‰ã€‚å¦‚æœä¸åŠæ—¶å›é¡¾ï¼Œå¥½çš„æƒ³æ³•å°†æ·¹æ²¡åœ¨å¤§é‡çš„çªå‘å¥‡æƒ³ä¸­ã€‚æˆ‘ä»¬æ¯å¤©å¤§å¤šæ•°çš„æƒ³æ³•æ²¡æœ‰å¤ªå¤§æ„ä¹‰åº”è¯¥è¢«ä¸¢å¼ƒï¼Œè€Œé‚£äº›å¯ä»¥æˆä¸ºé‡å¤§æœ‰æ„ä¹‰çš„æƒ³æ³•æˆ‘ä»¬å¿…é¡»å°†ä»–ä»¬è¯†åˆ«å‡ºæ¥ã€‚\né¡¹ç›®ç¬”è®°å’ŒçŸ¥è¯†ç¬”è®°æ··æ‚ åªè®°å½•ç‰¹å®šé¡¹ç›®ç›¸å…³çš„ç¬”è®°ï¼Œå°†å¯¼è‡´é¡¹ç›®æœŸé—´æœ‰è¶£çš„è§‚ç‚¹æˆ–è€…æƒ³æ³•ä¿¡æ¯ä¸¢å¤±ã€‚æ­£ç¡®çš„åšæ³•æ˜¯åœ¨é¡¹ç›®ä¸­æå–é€šç”¨çš„çŸ¥è¯†ã€‚æˆ‘æ¨èä½¿ç”¨P.A.R.A æ–¹æ³•æ¥æ•´ç†ç¬”è®°ï¼Œæœ‰å…³P.A.R.A æ‚¨å¯ä»¥å‚è€ƒ è¿™ä¸ªç½‘é¡µ\né¢‘ç¹æ•´ç†ç¬”è®°çš„ã€Œæ´ç™–ã€ å¤§é‡å †ç§¯çš„ç¬”è®°å°†é€ æˆçŸ¥è¯†æ•´ç†å†²åŠ¨ï¼Œå¤šæ¥å‡ æ¬¡å°±ä¼šå½±å“åšæŒè®°å½•çš„ä¿¡å¿ƒã€‚è§£å†³æ–¹æ³•æ˜¯ï¼Œç¡®å®šè‡ªå·±å…³æ³¨çš„é¢†åŸŸå’Œè´Ÿè´£çš„è´£ä»»èŒƒå›´ï¼Œå¹¶ä¸å®Œå…¨é‡‡ç”¨è‡ªä¸‹è€Œä¸Šçš„çŸ¥è¯†ç®¡ç†æ–¹æ³•ã€‚åœ¨è¾¾åˆ°å¿ƒç†æŒ¤å‹ç‚¹æ—¶ï¼Œä½¿ç”¨ MOCSï¼ˆMaps of Contentï¼‰çš„æ–¹æ³•æ•´ç†ç¬”è®°ï¼ˆåŒé“¾ç»å¯¹æ˜¯ä½ å€¼å¾—å°è¯•çš„ã€‚ï¼‰ã€‚çŸ¥è¯†ç®¡ç†ç³»ç»Ÿæœ€é‡è¦çš„æ˜¯åœ¨åŒä¸€ä¸ªåœ°æ–¹ï¼Œç”¨åŒæ ·çš„æ ¼å¼å’Œä¸€è‡´çš„æ ‡å‡†è®°å½•ä½ çš„æ´è§ã€‚\n","date":"2024-05-06T10:19:00+08:00","image":"https://images.yixiao9206.cn/blog-images/2024/05/5ab6b54893dc2241704444526269572a.jpg","permalink":"https://huizhou92.com/zh-cn/p/crafting-your-second-brain-lessons-learned-from-my-note-taking-journey/","title":"çŸ¥è¯†ç®¡ç†çš„å‡ ä¸ªè¯¯åŒº"},{"content":"è¿›ç¨‹æ˜¯æ“ä½œç³»ç»Ÿçš„ä¼Ÿå¤§å‘æ˜ä¹‹ä¸€ï¼Œå¯¹åº”ç”¨ç¨‹åºå±è”½äº†CPUè°ƒåº¦ã€å†…å­˜ç®¡ç†ç­‰ç¡¬ä»¶ç»†èŠ‚ï¼Œè€ŒæŠ½è±¡å‡ºä¸€ä¸ªè¿›ç¨‹çš„æ¦‚å¿µï¼Œè®©åº”ç”¨ç¨‹åºä¸“å¿ƒäºå®ç°è‡ªå·±çš„ä¸šåŠ¡é€»è¾‘æ—¢å¯ï¼Œè€Œä¸”åœ¨æœ‰é™çš„CPUä¸Šå¯ä»¥â€œåŒæ—¶â€è¿›è¡Œè®¸å¤šä¸ªä»»åŠ¡ã€‚ä½†æ˜¯å®ƒä¸ºç”¨æˆ·å¸¦æ¥æ–¹ä¾¿çš„åŒæ—¶ï¼Œä¹Ÿå¼•å…¥äº†ä¸€äº›é¢å¤–çš„å¼€é”€ã€‚å¦‚ä¸‹å›¾ï¼Œåœ¨è¿›ç¨‹è¿è¡Œä¸­é—´çš„æ—¶é—´é‡Œï¼Œè™½ç„¶CPUä¹Ÿåœ¨å¿™äºå¹²æ´»ï¼Œä½†æ˜¯å´æ²¡æœ‰å®Œæˆä»»ä½•çš„ç”¨æˆ·å·¥ä½œï¼Œè¿™å°±æ˜¯è¿›ç¨‹æœºåˆ¶å¸¦æ¥çš„é¢å¤–å¼€é”€ã€‚\nåœ¨è¿›ç¨‹Aåˆ‡æ¢åˆ°è¿›ç¨‹Bçš„è¿‡ç¨‹ä¸­ï¼Œå…ˆä¿å­˜Aè¿›ç¨‹çš„ä¸Šä¸‹æ–‡ï¼Œä»¥ä¾¿äºç­‰Aæ¢å¤è¿è¡Œçš„æ—¶å€™ï¼Œèƒ½å¤ŸçŸ¥é“Aè¿›ç¨‹çš„ä¸‹ä¸€æ¡æŒ‡ä»¤æ˜¯å•¥ã€‚ç„¶åå°†è¦è¿è¡Œçš„Bè¿›ç¨‹çš„ä¸Šä¸‹æ–‡æ¢å¤åˆ°å¯„å­˜å™¨ä¸­ã€‚è¿™ä¸ªè¿‡ç¨‹è¢«ç§°ä¸ºä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚ä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€åœ¨è¿›ç¨‹ä¸å¤šã€åˆ‡æ¢ä¸é¢‘ç¹çš„åº”ç”¨åœºæ™¯ä¸‹é—®é¢˜ä¸å¤§ã€‚ä½†æ˜¯ç°åœ¨Linuxæ“ä½œç³»ç»Ÿè¢«ç”¨åˆ°äº†é«˜å¹¶å‘çš„ç½‘ç»œç¨‹åºåç«¯æœåŠ¡å™¨ã€‚åœ¨å•æœºæ”¯æŒæˆåƒä¸Šä¸‡ä¸ªç”¨æˆ·è¯·æ±‚çš„æ—¶å€™ï¼Œè¿™ä¸ªå¼€é”€å°±å¾—æ‹¿å‡ºæ¥è¯´é“è¯´é“äº†ã€‚å› ä¸ºç”¨æˆ·è¿›ç¨‹åœ¨è¯·æ±‚Redisã€Mysqlæ•°æ®ç­‰ç½‘ç»œIOé˜»å¡æ‰çš„æ—¶å€™ï¼Œæˆ–è€…åœ¨è¿›ç¨‹æ—¶é—´ç‰‡åˆ°äº†ï¼Œéƒ½ä¼šå¼•å‘ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚\nä¸€ä¸ªç®€å•çš„è¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€æµ‹è¯•å®éªŒ åºŸè¯ä¸å¤šè¯´ï¼Œæˆ‘ä»¬å…ˆç”¨ä¸ªå®éªŒæµ‹è¯•ä¸€ä¸‹ï¼Œåˆ°åº•ä¸€æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢éœ€è¦å¤šé•¿çš„CPUæ—¶é—´ï¼å®éªŒæ–¹æ³•æ˜¯åˆ›å»ºä¸¤ä¸ªè¿›ç¨‹å¹¶åœ¨å®ƒä»¬ä¹‹é—´ä¼ é€ä¸€ä¸ªä»¤ç‰Œã€‚å…¶ä¸­ä¸€ä¸ªè¿›ç¨‹åœ¨è¯»å–ä»¤ç‰Œæ—¶å°±ä¼šå¼•èµ·é˜»å¡ã€‚å¦ä¸€ä¸ªè¿›ç¨‹å‘é€ä»¤ç‰Œåç­‰å¾…å…¶è¿”å›æ—¶ä¹Ÿå¤„äºé˜»å¡çŠ¶æ€ã€‚å¦‚æ­¤å¾€è¿”ä¼ é€ä¸€å®šçš„æ¬¡æ•°ï¼Œç„¶åç»Ÿè®¡ä»–ä»¬çš„å¹³å‡å•æ¬¡åˆ‡æ¢æ—¶é—´å¼€é”€ã€‚\ntest04\n1 2 3 4 # gcc main.c -o main # ./main./main Before Context Switch Time1565352257 s, 774767 us After Context SWitch Time1565352257 s, 842852 us æ¯æ¬¡æ‰§è¡Œçš„æ—¶é—´ä¼šæœ‰å·®å¼‚ï¼Œå¤šæ¬¡è¿è¡Œåå¹³å‡æ¯æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢è€—æ—¶3.5uså·¦å³ã€‚å½“ç„¶äº†è¿™ä¸ªæ•°å­—å› æœºå™¨è€Œå¼‚ï¼Œè€Œä¸”å»ºè®®åœ¨å®æœºä¸Šæµ‹è¯•ã€‚\nå‰é¢æˆ‘ä»¬æµ‹è¯•ç³»ç»Ÿè°ƒç”¨çš„æ—¶å€™ï¼Œæœ€ä½å€¼æ˜¯200nsã€‚å¯è§ï¼Œä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€è¦æ¯”ç³»ç»Ÿè°ƒç”¨çš„å¼€é”€è¦å¤§ã€‚ç³»ç»Ÿè°ƒç”¨åªæ˜¯åœ¨è¿›ç¨‹å†…å°†ç”¨æˆ·æ€åˆ‡æ¢åˆ°å†…æ ¸æ€ï¼Œç„¶åå†åˆ‡å›æ¥ï¼Œè€Œä¸Šä¸‹æ–‡åˆ‡æ¢å¯æ˜¯ç›´æ¥ä»è¿›ç¨‹Aåˆ‡æ¢åˆ°äº†è¿›ç¨‹Bã€‚æ˜¾ç„¶è¿™ä¸ªä¸Šä¸‹æ–‡åˆ‡æ¢éœ€è¦å®Œæˆçš„å·¥ä½œé‡æ›´å¤§ã€‚\nè¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€éƒ½æœ‰å“ªäº› é‚£ä¹ˆä¸Šä¸‹æ–‡åˆ‡æ¢çš„æ—¶å€™ï¼ŒCPUçš„å¼€é”€éƒ½å…·ä½“æœ‰å“ªäº›å‘¢ï¼Ÿå¼€é”€åˆ†æˆä¸¤ç§ï¼Œä¸€ç§æ˜¯ç›´æ¥å¼€é”€ã€ä¸€ç§æ˜¯é—´æ¥å¼€é”€ã€‚\nç›´æ¥å¼€é”€å°±æ˜¯åœ¨åˆ‡æ¢æ—¶ï¼Œcpuå¿…é¡»åšçš„äº‹æƒ…ï¼ŒåŒ…æ‹¬ï¼š\n1ã€==åˆ‡æ¢é¡µè¡¨å…¨å±€ç›®å½•== 2ã€==åˆ‡æ¢å†…æ ¸æ€å †æ ˆ== 3ã€==åˆ‡æ¢ç¡¬ä»¶ä¸Šä¸‹æ–‡==ï¼ˆè¿›ç¨‹æ¢å¤å‰ï¼Œå¿…é¡»è£…å…¥å¯„å­˜å™¨çš„æ•°æ®ç»Ÿç§°ä¸ºç¡¬ä»¶ä¸Šä¸‹æ–‡ï¼‰ ip(instruction pointer)ï¼šæŒ‡å‘å½“å‰æ‰§è¡ŒæŒ‡ä»¤çš„ä¸‹ä¸€æ¡æŒ‡ä»¤ bp(base pointer): ç”¨äºå­˜æ”¾æ‰§è¡Œä¸­çš„å‡½æ•°å¯¹åº”çš„æ ˆå¸§çš„æ ˆåº•åœ°å€ sp(stack poinger): ç”¨äºå­˜æ”¾æ‰§è¡Œä¸­çš„å‡½æ•°å¯¹åº”çš„æ ˆå¸§çš„æ ˆé¡¶åœ°å€ cr3:é¡µç›®å½•åŸºå€å¯„å­˜å™¨ï¼Œä¿å­˜é¡µç›®å½•è¡¨çš„ç‰©ç†åœ°å€ \u0026hellip;\u0026hellip; 4ã€åˆ·æ–°TLB 5ã€ç³»ç»Ÿè°ƒåº¦å™¨çš„ä»£ç æ‰§è¡Œ é—´æ¥å¼€é”€ä¸»è¦æŒ‡çš„æ˜¯è™½ç„¶åˆ‡æ¢åˆ°ä¸€ä¸ªæ–°è¿›ç¨‹åï¼Œ==ç”±äºå„ç§ç¼“å­˜å¹¶ä¸çƒ­ï¼Œé€Ÿåº¦è¿è¡Œä¼šæ…¢ä¸€äº›==ã€‚å¦‚æœè¿›ç¨‹å§‹ç»ˆéƒ½åœ¨ä¸€ä¸ªCPUä¸Šè°ƒåº¦è¿˜å¥½ä¸€äº›ï¼Œå¦‚æœè·¨CPUçš„è¯ï¼Œä¹‹å‰çƒ­èµ·æ¥çš„TLBã€L1ã€L2ã€L3å› ä¸ºè¿è¡Œçš„è¿›ç¨‹å·²ç»å˜äº†ï¼Œæ‰€ä»¥ä»¥å±€éƒ¨æ€§åŸç†cacheèµ·æ¥çš„ä»£ç ã€æ•°æ®ä¹Ÿéƒ½æ²¡æœ‰ç”¨äº†ï¼Œå¯¼è‡´æ–°è¿›ç¨‹ç©¿é€åˆ°å†…å­˜çš„IOä¼šå˜å¤šã€‚ å…¶å®æˆ‘ä»¬ä¸Šé¢çš„å®éªŒå¹¶æ²¡æœ‰å¾ˆå¥½åœ°æµ‹é‡åˆ°è¿™ç§æƒ…å†µï¼Œæ‰€ä»¥å®é™…çš„ä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€å¯èƒ½æ¯”3.5usè¦å¤§ã€‚\næƒ³äº†è§£æ›´è¯¦ç»†æ“ä½œè¿‡ç¨‹çš„åŒå­¦è¯·å‚è€ƒã€Šæ·±å…¥ç†è§£Linuxå†…æ ¸ã€‹ä¸­çš„ç¬¬ä¸‰ç« å’Œç¬¬ä¹ç« ã€‚\nä¸€ä¸ªæ›´ä¸ºä¸“ä¸šçš„æµ‹è¯•å·¥å…·-lmbench lmbenchç”¨äºè¯„ä»·ç³»ç»Ÿç»¼åˆæ€§èƒ½çš„å¤šå¹³å°å¼€æºbenchmarkï¼Œèƒ½å¤Ÿæµ‹è¯•åŒ…æ‹¬æ–‡æ¡£è¯»å†™ã€å†…å­˜æ“ä½œã€è¿›ç¨‹åˆ›å»ºé”€æ¯å¼€é”€ã€ç½‘ç»œç­‰æ€§èƒ½ã€‚ä½¿ç”¨æ–¹æ³•ç®€å•ï¼Œä½†å°±æ˜¯è·‘æœ‰ç‚¹æ…¢ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥è‡ªå·±è¯•ä¸€è¯•ã€‚\nè¿™ä¸ªå·¥å…·çš„ä¼˜åŠ¿æ˜¯æ˜¯è¿›è¡Œäº†å¤šç»„å®éªŒï¼Œæ¯ç»„2ä¸ªè¿›ç¨‹ã€8ä¸ªã€16ä¸ªã€‚æ¯ä¸ªè¿›ç¨‹ä½¿ç”¨çš„æ•°æ®å¤§å°ä¹Ÿåœ¨å˜ï¼Œå……åˆ†æ¨¡æ‹Ÿcache missé€ æˆçš„å½±å“ã€‚æˆ‘ç”¨ä»–æµ‹äº†ä¸€ä¸‹ç»“æœå¦‚ä¸‹ï¼š\n1 2 3 4 5 ------------------------------------------------------------------------- Host OS 2p/0K 2p/16K 2p/64K 8p/16K 8p/64K 16p/16K 16p/64K ctxsw ctxsw ctxsw ctxsw ctxsw ctxsw ctxsw --------- ------------- ------ ------ ------ ------ ------ ------- ------- bjzw_46_7 Linux 2.6.32- 2.7800 2.7800 2.7000 4.3800 4.0400 4.75000 5.48000 lmbenchæ˜¾ç¤ºçš„è¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢è€—æ—¶ä»2.7usåˆ°5.48ä¹‹é—´ã€‚\nçº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢è€—æ—¶ å‰é¢æˆ‘ä»¬æµ‹è¯•äº†è¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢çš„å¼€é”€ï¼Œæˆ‘ä»¬å†ç»§ç»­åœ¨Linuxæµ‹è¯•ä¸€ä¸‹çº¿ç¨‹ã€‚çœ‹çœ‹ç©¶ç«Ÿæ¯”è¿›ç¨‹èƒ½ä¸èƒ½å¿«ä¸€äº›ï¼Œå¿«çš„è¯èƒ½å¿«å¤šå°‘ã€‚\nåœ¨Linuxä¸‹å…¶å®æœ¬å¹¶æ²¡æœ‰çº¿ç¨‹ï¼Œåªæ˜¯ä¸ºäº†è¿åˆå¼€å‘è€…å£å‘³ï¼Œæäº†ä¸ªè½»é‡çº§è¿›ç¨‹å‡ºæ¥å°±å«åšäº†çº¿ç¨‹ã€‚è½»é‡çº§è¿›ç¨‹å’Œè¿›ç¨‹ä¸€æ ·ï¼Œéƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„task_structè¿›ç¨‹æè¿°ç¬¦ï¼Œä¹Ÿéƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„pidã€‚ä»æ“ä½œç³»ç»Ÿè§†è§’çœ‹ï¼Œè°ƒåº¦ä¸Šå’Œè¿›ç¨‹æ²¡æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Œéƒ½æ˜¯åœ¨ç­‰å¾…é˜Ÿåˆ—çš„åŒå‘é“¾è¡¨é‡Œé€‰æ‹©ä¸€ä¸ªtask_structåˆ‡åˆ°è¿è¡Œæ€è€Œå·²ã€‚åªä¸è¿‡è½»é‡çº§è¿›ç¨‹å’Œæ™®é€šè¿›ç¨‹çš„åŒºåˆ«æ˜¯å¯ä»¥å…±äº«åŒä¸€å†…å­˜åœ°å€ç©ºé—´ã€ä»£ç æ®µã€å…¨å±€å˜é‡ã€åŒä¸€æ‰“å¼€æ–‡ä»¶é›†åˆè€Œå·²ã€‚\nåŒä¸€è¿›ç¨‹ä¸‹çš„çº¿ç¨‹ä¹‹æ‰€æœ‰getpid()çœ‹åˆ°çš„pidæ˜¯ä¸€æ ·çš„ï¼Œå…¶å®task_structé‡Œè¿˜æœ‰ä¸€ä¸ªtgidå­—æ®µã€‚ å¯¹äºå¤šçº¿ç¨‹ç¨‹åºæ¥è¯´ï¼Œgetpid()ç³»ç»Ÿè°ƒç”¨è·å–çš„å®é™…ä¸Šæ˜¯è¿™ä¸ªtgidï¼Œå› æ­¤éš¶å±åŒä¸€è¿›ç¨‹çš„å¤šçº¿ç¨‹çœ‹èµ·æ¥PIDç›¸åŒã€‚\næˆ‘ä»¬ç”¨ä¸€ä¸ªå®éªŒæ¥æµ‹è¯•ä¸€ä¸‹test06ã€‚å…¶åŸç†å’Œè¿›ç¨‹æµ‹è¯•å·®ä¸å¤šï¼Œåˆ›å»ºäº†20ä¸ªçº¿ç¨‹ï¼Œåœ¨çº¿ç¨‹ä¹‹é—´é€šè¿‡ç®¡é“æ¥ä¼ é€’ä¿¡å·ã€‚æ¥åˆ°ä¿¡å·å°±å”¤é†’ï¼Œç„¶åå†ä¼ é€’ä¿¡å·ç»™ä¸‹ä¸€ä¸ªçº¿ç¨‹ï¼Œè‡ªå·±ç¡çœ ã€‚ è¿™ä¸ªå®éªŒé‡Œå•ç‹¬è€ƒè™‘äº†ç»™ç®¡é“ä¼ é€’ä¿¡å·çš„é¢å¤–å¼€é”€ï¼Œå¹¶åœ¨ç¬¬ä¸€æ­¥å°±ç»Ÿè®¡äº†å‡ºæ¥ã€‚\n1 2 3 # gcc -lpthread main.c -o main 0.508250 4.363495 æ¯æ¬¡å®éªŒç»“æœä¼šæœ‰ä¸€äº›å·®å¼‚ï¼Œä¸Šé¢çš„ç»“æœæ˜¯å–äº†å¤šæ¬¡çš„ç»“æœä¹‹åç„¶åå¹³å‡çš„ï¼Œå¤§çº¦æ¯æ¬¡çº¿ç¨‹åˆ‡æ¢å¼€é”€å¤§çº¦æ˜¯3.8uså·¦å³ã€‚ä»ä¸Šä¸‹æ–‡åˆ‡æ¢çš„è€—æ—¶ä¸Šæ¥çœ‹ï¼ŒLinuxçº¿ç¨‹ï¼ˆè½»é‡çº§è¿›ç¨‹ï¼‰å…¶å®å’Œè¿›ç¨‹å·®åˆ«ä¸å¤ªå¤§ã€‚\nLinuxç›¸å…³å‘½ä»¤ æ—¢ç„¶æˆ‘ä»¬çŸ¥é“äº†ä¸Šä¸‹æ–‡åˆ‡æ¢æ¯”è¾ƒçš„æ¶ˆè€—CPUæ—¶é—´ï¼Œé‚£ä¹ˆæˆ‘ä»¬é€šè¿‡ä»€ä¹ˆå·¥å…·å¯ä»¥æŸ¥çœ‹ä¸€ä¸‹Linuxé‡Œç©¶ç«Ÿåœ¨å‘ç”Ÿå¤šå°‘åˆ‡æ¢å‘¢ï¼Ÿå¦‚æœä¸Šä¸‹æ–‡åˆ‡æ¢å·²ç»å½±å“åˆ°äº†ç³»ç»Ÿæ•´ä½“æ€§èƒ½ï¼Œæˆ‘ä»¬æœ‰æ²¡æœ‰åŠæ³•æŠŠæœ‰é—®é¢˜çš„è¿›ç¨‹æªå‡ºæ¥ï¼Œå¹¶æŠŠå®ƒä¼˜åŒ–æ‰å‘¢ï¼Ÿ\n1 2 3 4 5 6 7 8 # vmstat 1 procs -----------memory---------- ---swap-- -----io---- --system-- -----cpu----- r b swpd free buff cache si so bi bo in cs us sy id wa st 2 0 0 595504 5724 190884 0 0 295 297 0 0 14 6 75 0 4 5 0 0 593016 5732 193288 0 0 0 92 19889 29104 20 6 67 0 7 3 0 0 591292 5732 195476 0 0 0 0 20151 28487 20 6 66 0 8 4 0 0 589296 5732 196800 0 0 116 384 19326 27693 20 7 67 0 7 4 0 0 586956 5740 199496 0 0 216 24 18321 24018 22 8 62 0 8 æˆ–è€…æ˜¯\n1 2 3 4 5 6 7 8 9 10 11 12 13 # sar -w 1 proc/s Total number of tasks created per second. cswch/s Total number of context switches per second. 11:19:20 AM proc/s cswch/s 11:19:21 AM 110.28 23468.22 11:19:22 AM 128.85 33910.58 11:19:23 AM 47.52 40733.66 11:19:24 AM 35.85 30972.64 11:19:25 AM 47.62 24951.43 11:19:26 AM 47.52 42950.50 ...... ä¸Šå›¾çš„ç¯å¢ƒæ˜¯ä¸€å°ç”Ÿäº§ç¯å¢ƒæœºå™¨ï¼Œé…ç½®æ˜¯8æ ¸8Gçš„KVMè™šæœºï¼Œç¯å¢ƒæ˜¯åœ¨nginx+fpmçš„ï¼Œfpmæ•°é‡ä¸º1000ï¼Œå¹³å‡æ¯ç§’å¤„ç†çš„ç”¨æˆ·æ¥å£è¯·æ±‚å¤§çº¦100å·¦å³ã€‚å…¶ä¸­csåˆ—è¡¨ç¤ºçš„å°±æ˜¯åœ¨1så†…ç³»ç»Ÿå‘ç”Ÿçš„ä¸Šä¸‹æ–‡åˆ‡æ¢æ¬¡æ•°ï¼Œå¤§çº¦1såˆ‡æ¢æ¬¡æ•°éƒ½è¾¾åˆ°4Wæ¬¡äº†ã€‚ç²—ç•¥ä¼°ç®—ä¸€ä¸‹ï¼Œæ¯æ ¸å¤§çº¦æ¯ç§’éœ€è¦åˆ‡æ¢5Kæ¬¡ï¼Œåˆ™1så†…éœ€è¦èŠ±å°†è¿‘20msåœ¨ä¸Šä¸‹æ–‡åˆ‡æ¢ä¸Šã€‚è¦çŸ¥é“è¿™æ˜¯è™šæœºï¼Œæœ¬èº«åœ¨è™šæ‹ŸåŒ–ä¸Šè¿˜ä¼šæœ‰ä¸€äº›é¢å¤–å¼€é”€ï¼Œè€Œä¸”è¿˜è¦çœŸæ­£æ¶ˆè€—CPUåœ¨ç”¨æˆ·æ¥å£é€»è¾‘å¤„ç†ã€ç³»ç»Ÿè°ƒç”¨å†…æ ¸é€»è¾‘å¤„ç†ã€ä»¥åŠç½‘ç»œè¿æ¥çš„å¤„ç†ä»¥åŠè½¯ä¸­æ–­ï¼Œæ‰€ä»¥20msçš„å¼€é”€å®é™…ä¸Šä¸ä½äº†ã€‚\né‚£ä¹ˆè¿›ä¸€æ­¥ï¼Œæˆ‘ä»¬çœ‹ä¸‹åˆ°åº•æ˜¯å“ªäº›è¿›ç¨‹å¯¼è‡´äº†é¢‘ç¹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Ÿ\n1 2 3 4 5 6 # pidstat -w 1 11:07:56 AM PID cswch/s nvcswch/s Command 11:07:56 AM 32316 4.00 0.00 php-fpm 11:07:56 AM 32508 160.00 34.00 php-fpm 11:07:56 AM 32726 131.00 8.00 php-fpm ...... ç”±äºfpmæ˜¯åŒæ­¥é˜»å¡çš„æ¨¡å¼ï¼Œæ¯å½“è¯·æ±‚Redisã€Memcacheã€Mysqlçš„æ—¶å€™å°±ä¼šé˜»å¡å¯¼è‡´cswch/sè‡ªæ„¿ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œè€Œåªæœ‰æ—¶é—´ç‰‡åˆ°äº†ä¹‹åæ‰ä¼šè§¦å‘nvcswch/séè‡ªæ„¿åˆ‡æ¢ã€‚å¯è§fpmè¿›ç¨‹å¤§éƒ¨åˆ†çš„åˆ‡æ¢éƒ½æ˜¯è‡ªæ„¿çš„ã€éè‡ªæ„¿çš„æ¯”è¾ƒå°‘ã€‚\nå¦‚æœæƒ³æŸ¥çœ‹å…·ä½“æŸä¸ªè¿›ç¨‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢æ€»æƒ…å†µï¼Œå¯ä»¥åœ¨/procæ¥å£ä¸‹ç›´æ¥çœ‹ï¼Œä¸è¿‡è¿™ä¸ªæ˜¯æ€»å€¼ã€‚\n1 2 3 grep ctxt /proc/32583/status voluntary_ctxt_switches: 573066 nonvoluntary_ctxt_switches: 89260 ç»“è®º ä¸Šä¸‹æ–‡åˆ‡æ¢å…·ä½“åšå“ªäº›äº‹æƒ…æˆ‘ä»¬æ²¡æœ‰å¿…è¦è®°ï¼Œåªéœ€è¦è®°ä½ä¸€ä¸ªç»“è®ºæ—¢å¯ï¼Œåœ¨æˆ‘çš„å·¥ä½œæœºä¸Šä¸‹æ–‡åˆ‡æ¢çš„å¼€é”€å¤§çº¦æ˜¯2.7-5.48uså·¦å³ï¼Œä½ è‡ªå·±çš„æœºå™¨å¯ä»¥ç”¨æˆ‘æä¾›çš„ä»£ç æˆ–å·¥å…·è¿›è¡Œä¸€ç•ªæµ‹è¯•ã€‚ å¯ä»¥ä½¿ç”¨ vmstat sar ç­‰å·¥å…·æŸ¥çœ‹è¿›ç¨‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œè¿›è€Œå®šä½æ€§èƒ½é—®é¢˜ã€‚ lmbenchç›¸å¯¹æ›´å‡†ç¡®ä¸€äº›ï¼Œå› ä¸ºè€ƒè™‘äº†åˆ‡æ¢åCache misså¯¼è‡´çš„é¢å¤–å¼€é”€ã€‚ ","date":"2024-03-19T18:45:00Z","permalink":"https://huizhou92.com/zh-cn/p/the-time-in-the-computers-context-switching/","title":"è®¡ç®—æœºä¸­çš„æ—¶é—´ çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ä¼šç”¨æ‰ä½ å¤šå°‘CPUï¼Ÿ"}]