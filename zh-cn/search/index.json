[{"content":"goroutine çš„çŠ¶æ€ åœ¨ golang ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨go åˆ›å»ºä¸€ä¸ªæ–°çš„gorotine,æˆ‘ä»¬éƒ½çŸ¥é“æ“ä½œç³»ç»Ÿçº¿ç¨‹æœ‰è‡ªå·±çš„çŠ¶æ€ï¼Œ æ¯”å¦‚ åœ¨ The time in computers: how long will it take to switch the context? ä¸­ï¼Œæˆ‘ä»¬æ€»ç»“äº†çº¿ç¨‹çš„çŠ¶æ€ä»¥åŠçº¿ç¨‹è°ƒåº¦è€—æ—¶ã€‚\ngoroutineä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œæœ‰è‡ªå·±çš„çŠ¶æ€ï¼Œå¹¶ä¸”å®ƒçš„çŠ¶æ€ç”± runtime æ§åˆ¶ã€‚\nåœ¨ rimetime2.go ä¸­å®šä¹‰äº†goroutine çš„æ•°æ®ç»“æ„ã€‚g.atomicstatus è¡¨ç¤º goroutine çš„çŠ¶æ€ã€‚å®ƒçš„å–å€¼èŒƒå›´åœ¨æºç ä¸­ä¹Ÿæœ‰å®šä¹‰ã€‚\né™¤äº†å‡ ä¸ªå·²ç»ä¸è¢«ä½¿ç”¨çš„ä»¥åŠä¸ GC ç›¸å…³çš„çŠ¶æ€ä¹‹å¤–ï¼ŒGoroutine å¯èƒ½å¤„äºä»¥ä¸‹ 9 ç§çŠ¶æ€ï¼š\nçŠ¶æ€ æè¿° _Gidle åˆšåˆšè¢«åˆ†é…å¹¶ä¸”è¿˜æ²¡æœ‰è¢«åˆå§‹åŒ– _Grunnable æ²¡æœ‰æ‰§è¡Œä»£ç ï¼Œæ²¡æœ‰æ ˆçš„æ‰€æœ‰æƒï¼Œå­˜å‚¨åœ¨è¿è¡Œé˜Ÿåˆ—ä¸­ _Grunning å¯ä»¥æ‰§è¡Œä»£ç ï¼Œæ‹¥æœ‰æ ˆçš„æ‰€æœ‰æƒï¼Œè¢«èµ‹äºˆäº†å†…æ ¸çº¿ç¨‹ M å’Œå¤„ç†å™¨ P _Gsyscall æ­£åœ¨æ‰§è¡Œç³»ç»Ÿè°ƒç”¨ï¼Œæ‹¥æœ‰æ ˆçš„æ‰€æœ‰æƒï¼Œæ²¡æœ‰æ‰§è¡Œç”¨æˆ·ä»£ç ï¼Œè¢«èµ‹äºˆäº†å†…æ ¸çº¿ç¨‹ M ä½†æ˜¯ä¸åœ¨è¿è¡Œé˜Ÿåˆ—ä¸Š _Gwaiting ç”±äºè¿è¡Œæ—¶è€Œè¢«é˜»å¡ï¼Œæ²¡æœ‰æ‰§è¡Œç”¨æˆ·ä»£ç å¹¶ä¸”ä¸åœ¨è¿è¡Œé˜Ÿåˆ—ä¸Šï¼Œä½†æ˜¯å¯èƒ½å­˜åœ¨äº Channel çš„ç­‰å¾…é˜Ÿåˆ—ä¸Š _Gdead æ²¡æœ‰è¢«ä½¿ç”¨ï¼Œæ²¡æœ‰æ‰§è¡Œä»£ç ï¼Œå¯èƒ½æœ‰åˆ†é…çš„æ ˆ _Gcopystack æ ˆæ­£åœ¨è¢«æ‹·è´ï¼Œæ²¡æœ‰æ‰§è¡Œä»£ç ï¼Œä¸åœ¨è¿è¡Œé˜Ÿåˆ—ä¸Š _Gpreempted ç”±äºæŠ¢å è€Œè¢«é˜»å¡ï¼Œæ²¡æœ‰æ‰§è¡Œç”¨æˆ·ä»£ç å¹¶ä¸”ä¸åœ¨è¿è¡Œé˜Ÿåˆ—ä¸Šï¼Œç­‰å¾…å”¤é†’ _Gscan GC æ­£åœ¨æ‰«ææ ˆç©ºé—´ï¼Œæ²¡æœ‰æ‰§è¡Œä»£ç ï¼Œå¯ä»¥ä¸å…¶ä»–çŠ¶æ€åŒæ—¶å­˜åœ¨ ä¸Šè¿°çŠ¶æ€ä¸­æ¯”è¾ƒå¸¸è§æ˜¯Â _Grunnableã€_Grunningã€_Gsyscallã€_GwaitingÂ å’ŒÂ _GpreemptedÂ äº”ä¸ªçŠ¶æ€ï¼Œè¿™é‡Œä¼šé‡ç‚¹ä»‹ç»è¿™å‡ ä¸ªçŠ¶æ€ã€‚Goroutine çš„çŠ¶æ€è¿ç§»æ˜¯ä¸ªå¤æ‚çš„è¿‡ç¨‹ï¼Œè§¦å‘ Goroutine çŠ¶æ€è¿ç§»çš„æ–¹æ³•ä¹Ÿå¾ˆå¤šï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬ä¹Ÿæ²¡æœ‰åŠæ³•ä»‹ç»å…¨éƒ¨çš„è¿ç§»è·¯çº¿ï¼Œåªä¼šä»ä¸­é€‰æ‹©ä¸€äº›ä»‹ç»ã€‚ è™½ç„¶ Goroutine åœ¨è¿è¡Œæ—¶ä¸­å®šä¹‰çš„çŠ¶æ€éå¸¸å¤šè€Œä¸”å¤æ‚ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥å°†è¿™äº›ä¸åŒçš„çŠ¶æ€èšåˆæˆä¸‰ç§ï¼šç­‰å¾…ä¸­ã€å¯è¿è¡Œã€è¿è¡Œä¸­ï¼Œè¿è¡ŒæœŸé—´ä¼šåœ¨è¿™ä¸‰ç§çŠ¶æ€æ¥å›åˆ‡æ¢ï¼š\nç­‰å¾…ä¸­ï¼šGoroutine æ­£åœ¨ç­‰å¾…æŸäº›æ¡ä»¶æ»¡è¶³ï¼Œä¾‹å¦‚ï¼šç³»ç»Ÿè°ƒç”¨ç»“æŸç­‰ï¼ŒåŒ…æ‹¬Â _Gwaitingã€_GsyscallÂ å’ŒÂ _GpreemptedÂ å‡ ä¸ªçŠ¶æ€ï¼› å¯è¿è¡Œï¼šGoroutine å·²ç»å‡†å¤‡å°±ç»ªï¼Œå¯ä»¥åœ¨çº¿ç¨‹è¿è¡Œï¼Œå¦‚æœå½“å‰ç¨‹åºä¸­æœ‰éå¸¸å¤šçš„ Goroutineï¼Œæ¯ä¸ª Goroutine å°±å¯èƒ½ä¼šç­‰å¾…æ›´å¤šçš„æ—¶é—´ï¼Œå³Â _Grunnableï¼›è¿™ä¸ªæ—¶å€™Goroutine åœ¨ Pçš„local queue æˆ–è€… å…¨å±€é˜Ÿåˆ—ä¸­ã€‚ è¿è¡Œä¸­ï¼šGoroutine æ­£åœ¨æŸä¸ªçº¿ç¨‹ä¸Šè¿è¡Œï¼Œå³Â _Grunningï¼›\nGrunnable goroutineåœ¨ä¸‹åˆ—å‡ ç§æƒ…å†µä¼šè®¾ç½®ä¸ºGrunnableçŠ¶æ€ï¼š\nåˆ›å»ºgoroutine åœ¨goä¸­ï¼ŒåŒ…æ‹¬ç”¨æˆ·å…¥å£main.mianåœ¨å†…çš„æ‰€æœ‰goroutineéƒ½æ˜¯é€šè¿‡runtime.newproc-\u0026gt;runtime.newproc1åˆ›å»ºçš„ï¼Œå‰è€…æ˜¯å¯¹åè€…çš„ä¸€å±‚å°è£…ã€‚goå…³é”®å­—æœ€ç»ˆä¼šè¢«ç¼–è¯‘å™¨æ˜ å°„ä¸ºå¯¹runtime.newprocçš„è°ƒç”¨ã€‚å½“runtime.newproc1å®Œæ•´èµ„æºåˆ†é…åŠåˆå§‹åŒ–åï¼Œæ–°ä»»åŠ¡çš„çŠ¶æ€ä¼šè¢«ç½®ä¸ºGrunnableï¼Œç„¶åè¢«æ·»åŠ åˆ°å½“å‰Pçš„æœ¬åœ°ä»»åŠ¡é˜Ÿåˆ—ä¸­ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 func newproc1(fn *funcval, argp unsafe.Pointer, narg int32, callergp *g, callerpc uintptr) { // --snip-- // è·å–å½“å‰gæ‰€åœ¨çš„pï¼Œä»pä¸­åˆ›å»ºä¸€ä¸ªæ–°g(newg) _p_ := _g_.m.p.ptr() newg := gfget(_p_) // --snip-- // è®¾ç½®GoroutineçŠ¶æ€ä¸ºGrunnable casgstatus(newg, _Gdead, _Grunnable) // --snip-- // // æ–°åˆ›å»ºçš„gæ·»åŠ åˆ°runé˜Ÿåˆ—ä¸­ runqput(_p_, newg, true) // --snip-- } é˜»å¡ä»»åŠ¡å”¤é†’ å½“æŸä¸ªé˜»å¡ä»»åŠ¡(Gwaiting)çš„ç­‰å¾…æ¡ä»¶æ»¡è¶³è€Œè¢«å”¤é†’æ—¶ã€‚ï¼ˆå¦‚g1é¡¹channelå†™å…¥æ•°æ®å°†å”¤é†’ç­‰å¾…æ¥æ”¶çš„)ï¼Œg1é€šè¿‡è°ƒç”¨runtime.readyå°†g2çŠ¶æ€é‡æ–°ç½®ä¸ºGrunnableå¹¶æ·»åŠ åˆ°ä»»åŠ¡é˜Ÿåˆ—ä¸­ã€‚å…³äºgroutineé˜»å¡ï¼Œè¿˜æœ‰æ›´è¯¦ç»†çš„ä»‹ç»ã€‚\n1 2 3 4 5 6 7 8 9 10 func ready(gp *g, traceskip int, next bool) { // --snip-- // è·å–current g _g_ := getg() // å°†çŠ¶æ€ä»Gwaitingè½¬æ¢è‡³Grunnable casgstatus(gp, _Gwaiting, _Grunnable) // æ·»åŠ åˆ°è¿è¡Œé˜Ÿåˆ—ä¸­ runqput(_g_.m.p.ptr(), gp, next) // --snip-- } å…¶ä»– å¦å¤–çš„è·¯å¾„æ˜¯ä»Grunningå’ŒGsyscallçŠ¶æ€è½¬æ¢åˆ°Grunnableï¼Œåé¢å†ä»‹ç»ã€‚æ€»ä¹‹å¤„äºGrunnableçš„ä»»åŠ¡ä¸€å®šæ˜¯åœ¨æŸä¸ªä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œéšæ—¶ç­‰å¾…è¢«è°ƒåº¦æ‰§è¡Œã€‚\nGrunning æ‰€æœ‰çŠ¶æ€ä¸ºGrunnableçš„ä»»åŠ¡éƒ½å¯èƒ½é€šè¿‡findrunnableå‡½æ•°è¢«è°ƒåº¦å™¨(P\u0026amp;M)è·å–ï¼Œè¿›è€Œé€šè¿‡executeå°†å…¶çŠ¶æ€åˆ‡æ¢åˆ°Grunningï¼Œæœ€åè°ƒç”¨runtime.gogoåŠ è½½contextå¹¶æ‰§è¡Œã€‚\n1 2 3 4 5 6 7 8 9 10 11 // One round of scheduler: find a runnable goroutine and execute it. // Never returns. func schedule() { // --snip-- // æŒ‘ä¸€ä¸ªå¯è¿è¡Œçš„gï¼Œå¹¶æ‰§è¡Œ if gp == nil { gp, inheritTime = findrunnable() // blocks until work is available } // --snip-- execute(gp, inheritTime) } 1 2 3 4 5 6 7 8 9 10 11 12 // Schedules gp to run on the current M. func execute(gp *g, inheritTime bool) { // å°†å½“å‰gçš„Måˆ‡æ¢åˆ°æ–°çš„gä¸Š _g_ := getg() _g_.m.curg = gp gp.m = _g_.m // å°†GrunnableçŠ¶æ€å˜æ›´ä¸ºGrunning casgstatus(gp, _Grunnable, _Grunning) // --snip-- // çœŸæ­£æ‰§è¡Œgoroutine gogo(\u0026amp;gp.sched) } goé‡‡å–çš„æ˜¯ä¸€ç§åä½œå¼è°ƒåº¦æ–¹æ¡ˆï¼Œä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„ä»»åŠ¡ï¼Œéœ€è¦é€šè¿‡yieldçš„æ–¹å¼æ˜¾å¼çš„è®©å‡ºå¤„ç†å™¨ã€‚\nåœ¨Go1.2ä¹‹åï¼Œruntimeä¹Ÿæ”¯æŒä¸€å®šç¨‹åº¦çš„ä»»åŠ¡æŠ¢å â€“å½“ç³»ç»Ÿçº¿ç¨‹sysmonå‘ç°æŸä¸ªä»»åŠ¡æ‰§è¡Œæ—¶é—´è¿‡é•¿æˆ–è€…runtimeåˆ¤æ–­éœ€è¦è¿›è¡Œåƒåœ¾æ”¶é›†æ—¶ï¼Œä¼šå°†ä»»åŠ¡ç½®ä¸ºâ€œå¯è¢«æŠ¢å â€çš„ï¼Œå½“è¯¥ä»»åŠ¡ä¸‹ä¸€æ¬¡å‡½æ•°è°ƒç”¨æ—¶ï¼Œå°±ä¼šè®©å‡ºå¤„ç†å™¨å¹¶é‡æ–°åˆ‡æ¢åˆ°GrunnableçŠ¶æ€ã€‚\nGsyscall Goè¿è¡Œæ—¶ä¸ºäº†ä¿è¯é«˜çš„å¹¶å‘æ€§èƒ½ï¼Œå½“ä¼šåœ¨ä»»åŠ¡æ‰§è¡ŒOSç³»ç»Ÿè°ƒç”¨å‰ï¼Œå…ˆè°ƒç”¨runtime.entersyscallå‡½æ•°å°†è‡ªå·±çš„çŠ¶æ€ç½®ä¸ºGsyscall(å¦‚æœç³»ç»Ÿè°ƒç”¨æ˜¯é˜»å¡å¼çš„æˆ–è€…æ‰§è¡Œè¿‡ä¹…ï¼Œåˆ™å°†å½“å‰Mä¸Påˆ†ç¦»)ï¼Œå½“ç³»ç»Ÿè°ƒç”¨è¿”å›åï¼Œæ‰§è¡Œçº¿ç¨‹è°ƒç”¨runtime.exitsyscallå°è¯•é‡æ–°è·å–Pï¼Œå¦‚æœæˆåŠŸä¸”å½“å‰ä»»åŠ¡æ²¡æœ‰è¢«æŠ¢å ï¼Œåˆ™å°†çŠ¶æ€åˆ‡æ¢å›Grunningå¹¶ç»§ç»­æ‰§è¡Œï¼›å¦åˆ™å°†çŠ¶æ€ç½®ä¸ºGrunnableï¼Œç­‰å¾…å†æ¬¡è¢«è°ƒåº¦æ‰§è¡Œã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 func reentersyscall(pc, sp uintptr) { _g_ := getg() // --snip-- casgstatus(_g_, _Grunning, _Gsyscall) // --snip-- // å°†må’Œpåˆ†ç¦» pp := _g_.m.p.ptr() pp.m = 0 _g_.m.oldp.set(pp) _g_.m.p = 0 // --snip-- } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 func exitsyscall() { _g_ := getg() // --snip-- // å¦‚æœPè¿˜å­˜åœ¨åˆ™é‡æ–°è·å–P if exitsyscallfast(oldp) { // --snip-- casgstatus(_g_, _Gsyscall, _Grunning) // --snip-- return } // --snip-- // å¦‚æœPä¸å­˜åœ¨åˆ™Gsyscall-\u0026gt;Grunnable mcall(exitsyscall0) // --snip-- } Gwaiting å½“ä¸€ä¸ªä»»åŠ¡éœ€è¦çš„èµ„æºæˆ–è¿è¡Œæ¡ä»¶ä¸èƒ½è¢«æ»¡è¶³æ—¶ï¼Œéœ€è¦è°ƒç”¨runtime.parkå‡½æ•°è¿›å…¥è¯¥çŠ¶æ€ï¼Œä¹‹åé™¤éç­‰å¾…æ¡ä»¶æ»¡è¶³ï¼Œå¦åˆ™ä»»åŠ¡å°†ä¸€ç›´å¤„äºç­‰å¾…çŠ¶æ€ä¸èƒ½æ‰§è¡Œã€‚é™¤äº†ä¹‹å‰ä¸¾è¿‡çš„channelçš„ä¾‹å­å¤–ï¼ŒGoçš„å®šæ—¶å™¨ï¼Œç½‘ç»œioæ“ä½œï¼ŒåŸå­ï¼Œä¿¡å·é‡éƒ½å¯èƒ½å¼•èµ·ä»»åŠ¡çš„é˜»å¡ã€‚\n1 2 3 4 5 6 // park continuation on g0. func park_m(gp *g) { // --snip-- casgstatus(gp, _Grunning, _Gwaiting) // --snip-- } 1 2 3 4 func gopark(unlockf func(*g, unsafe.Pointer) bool, lock unsafe.Pointer, reason waitReason, traceEv byte, traceskip int) { // --snip-- mcall(park_m) } runtime.parkä¸­lockæ˜¯goroutineé˜»å¡æ—¶éœ€è¦é‡Šæ”¾çš„é”ï¼Œ(æ¯”å¦‚channel)ï¼Œreasonæ˜¯é˜»å¡çš„åŸå› ï¼Œæ–¹ä¾¿gdbè°ƒè¯•ã€‚å½“æ‰€æœ‰ä»»åŠ¡å¤„äºGwaitingçŠ¶æ€æ—¶ï¼Œä¹Ÿå°±è¡¨ç¤ºå½“å‰ç¨‹åºè¿›å…¥äº†æ­»é”çŠ¶æ€ï¼Œé‚£ä¹ˆruntimeå›æ£€æµ‹åˆ°è¿™ç§æƒ…å†µï¼Œå¹¶è¾“å‡ºæ‰€æœ‰Gwaitingä»»åŠ¡çš„backtraceä¿¡æ¯ã€‚\nGdead å½“ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œç»“æŸåï¼Œä¼šè°ƒç”¨runtime.goexitç»“æŸã€‚å°†çŠ¶æ€ç½®ä¸ºGdeadï¼Œå¹¶è¿›å…¥å½“å‰Pçš„gFreeåˆ—è¡¨ã€‚\næ€»ç»“ goroutineçš„çŠ¶æ€åˆ‡æ¢è·Ÿçº¿ç¨‹çŠ¶æ€åˆ‡æ¢å…¶å®å·®ä¸å¤šï¼Œä¸è¿‡ï¼Œå› ä¸ºgcçš„åŸå› å¯¼è‡´çœ‹ä¸Šå»å¤æ‚ä¸€ç‚¹ã€‚ä½†æ˜¯å¦‚æœå»æ‰gcéƒ¨åˆ†ï¼Œå…¶å®goroutine çŠ¶æ€çš„åˆ‡æ¢è·Ÿ çº¿ç¨‹çŠ¶æ€åˆ‡æ¢å·®ä¸å¤šã€‚\nä¸‹ä¸€ç¯‡æ–‡ç« ï¼Œæˆ‘å°†ä¼šæ€»ç»“åˆ†æä¸€ä¸‹ Pçš„çŠ¶æ€åˆ‡æ¢ã€‚\n","date":"2025-01-06T10:35:19+08:00","permalink":"https://huizhou92.com/zh-cn/p/goroutine-%E7%9A%84%E7%8A%B6%E6%80%81-%E5%88%87%E6%8D%A2/","title":"goroutine çš„çŠ¶æ€ åˆ‡æ¢"},{"content":"åœ¨Goè¯­è¨€ä¸­ï¼Œæµ‹è¯•å¹¶å‘ä»£ç ä¸€ç›´æ˜¯ä¸€ä¸ªå…·æœ‰æŒ‘æˆ˜æ€§çš„ä»»åŠ¡ã€‚å°¤å…¶æ˜¯æµ‹è¯•ä¸€äº›éœ€è¦è·Ÿæ—¶é—´ç›¸å…³çš„caseçš„æ—¶å€™ï¼Œä¼ ç»Ÿçš„æµ‹è¯•æ–¹æ³•é€šå¸¸ä¾èµ–äºçœŸå®çš„ç³»ç»Ÿæ—¶é’Ÿå’ŒåŒæ­¥æœºåˆ¶ï¼Œè¿™ä¼šå¯¼è‡´æµ‹è¯•å˜å¾—ç¼“æ…¢ä¸”å®¹æ˜“å‡ºç°ä¸ç¡®å®šæ€§ã€‚\nå‡è®¾æˆ‘ä»¬éœ€è¦æµ‹è¯•go-cache çš„è¿‡æœŸåˆ é™¤åŠŸèƒ½ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šå†™å‡ºè¿™ç§ä»£ç \ngo-cacheæ˜¯ä¸€ä¸ªéå¸¸æµè¡Œçš„ Go ç¼“å­˜åº“ï¼Œæ”¯æŒè¿‡æœŸæ—¶é—´ï¼ˆTTLï¼‰å’Œå®šæœŸæ¸…ç†è¿‡æœŸçš„ç¼“å­˜é¡¹ã€‚å®ƒé€‚ç”¨äºç¼“å­˜æ•°æ®ï¼Œèƒ½å¤Ÿè‡ªåŠ¨åˆ é™¤è¿‡æœŸçš„æ¡ç›®ã€‚\nlist1: TestGoCacheEntryExpires\n1 2 3 4 5 6 7 8 9 10 11 func TestGoCacheEntryExpires(t *testing.T) { c := cache.New(5*time.Second, 10*time.Second) c.Set(\u0026#34;foo\u0026#34;, \u0026#34;bar\u0026#34;, cache.DefaultExpiration) v, found := c.Get(\u0026#34;foo\u0026#34;) assert.True(t, found) assert.Equal(t, \u0026#34;bar\u0026#34;, v) time.Sleep(5 * time.Second) v, found = c.Get(\u0026#34;foo\u0026#34;) assert.False(t, found) assert.Nil(t, v) } è¿è¡Œè¿™ä¸ªcase éœ€è¦ç­‰å¾…5sï¼Œè®© cacheè¿‡æœŸã€‚\n1 2 3 âœ synctest git:(main) âœ— time go test go-cacha_test.go ok command-line-arguments 5.012s go test go-cacha_test.go 0.38s user 1.27s system 27% cpu 6.049 total åœ¨ Golang 1.24 ä¹‹åï¼Œå¦‚ä½•ä½¿ç”¨testing/synctest è§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿé¦–å…ˆçœ‹çœ‹åŸºäº testing/synctest å¦‚ä½•å†™è¿™ä¸ªtest case æŠŠã€‚\nList 2: TestGoCacheEntryExpiresWithSynctest\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 func TestGoCacheEntryExpiresWithSynctest(t *testing.T) { c := cache.New(2*time.Second, 5*time.Second) synctest.Run(func() { c.Set(\u0026#34;foo\u0026#34;, \u0026#34;bar\u0026#34;, cache.DefaultExpiration) // Get an entry from the cache. if got, exist := c.Get(\u0026#34;foo\u0026#34;); !exist \u0026amp;\u0026amp; got != \u0026#34;bar\u0026#34; { t.Errorf(\u0026#34;c.Get(k) = %v, want %v\u0026#34;, got, \u0026#34;bar\u0026#34;) } // Verify that we get the same entry when accessing it before the expiry. time.Sleep(1 * time.Second) if got, exist := c.Get(\u0026#34;foo\u0026#34;); !exist \u0026amp;\u0026amp; got != \u0026#34;bar\u0026#34; { t.Errorf(\u0026#34;c.Get(k) = %v, want %v\u0026#34;, got,\u0026#34;bar\u0026#34;) } // Wait for the entry to expire and verify that we now get a new one. time.Sleep(3 * time.Second) if got, exist := c.Get(\u0026#34;foo\u0026#34;); exist { t.Errorf(\u0026#34;c.Get(k) = %v, want %v\u0026#34;, got, nil) } }) } è¿è¡Œæ—¶é—´ï¼š\n1 2 3 4 âœ synctest git:(main) âœ— time GOEXPERIMENT=synctest gotip test -run TestGoCacheEntryExpiresWithSynctest PASS ok blog-example/go/go1.24/synctest 0.009s GOEXPERIMENT=synctest gotip test -run TestGoCacheEntryExpiresWithSynctest 0.36s user 1.23s system 171% cpu 0.933 total ä»…ä»…è€—æ—¶ 0.009s\ntesting/synctest æ­ç§˜ testing/synctestä¸»è¦ç›®çš„æ˜¯ä¸ºäº†ç®€åŒ–å¹¶å‘ä»£ç çš„æµ‹è¯•ã€‚å®ƒçš„æ ¸å¿ƒæ€æƒ³æ˜¯é€šè¿‡ä½¿ç”¨è™šæ‹Ÿæ—¶é’Ÿå’Œgoroutineç»„(ä¹Ÿç§°ä¸ºbubble)æ¥æ§åˆ¶å¹¶å‘ä»£ç çš„æ‰§è¡Œï¼Œä»è€Œä½¿æµ‹è¯•æ—¢å¿«é€Ÿåˆå¯é ã€‚å®ƒä»…ä»…åªæœ‰ä¸¤ä¸ªæ¥å£ã€‚\n1 2 func Run(f func()) { synctest.Run(f) } func Wait() { synctest.Wait() } Runå‡½æ•°åœ¨ä¸€ä¸ªæ–°çš„goroutineä¸­æ‰§è¡Œfå‡½æ•°ï¼Œå¹¶åˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„bubbleï¼Œç¡®ä¿æ‰€æœ‰ç›¸å…³çš„goroutineéƒ½åœ¨è™šæ‹Ÿæ—¶é’Ÿçš„æ§åˆ¶ä¸‹æ‰§è¡Œã€‚\nWait ç”¨æ¥åŒæ­¥ bubble ä¸­goroutineâ€˜s çš„çŠ¶æ€ã€‚è°ƒç”¨è¯¥å‡½æ•°è°ƒç”¨åï¼Œä¸»goroutineå°†é˜»å¡ï¼Œç›´åˆ°bubbleä¸­çš„å…¶ä»–goroutineéƒ½å¤„äºdurably blocked çŠ¶æ€ã€‚\ndurably blocked æ˜¯ bubble ä¸­goroutine çš„ä¸€ä¸ªç‰¹æœ‰çš„çŠ¶æ€ï¼Œæœ‰å‡ ç§æ–¹å¼å¯ä»¥ä½¿ goroutine è¿›å…¥ durably blocked çŠ¶æ€ã€‚\nåœ¨bubbleå†…å‘channelå‘é€æˆ–æ¥æ”¶æ•°æ® selectè¯­å¥ä¸­ï¼Œæ¯ä¸ªcaseéƒ½æ˜¯bubbleå†…çš„channel A send or receive on a channel from within the bubble A select statement where every case is a channel within the bubble sync.Cond.Wait time.Sleep\nä½†æ˜¯å¦‚æœgoroutine æ˜¯å› ä¸º ç³»ç»Ÿè°ƒç”¨æˆ–å¤–éƒ¨äº‹ä»¶è€Œé˜»å¡ï¼Œ å®ƒå°±ä¸æ˜¯ durably blocked çŠ¶æ€ï¼Œsynctest.Wait ä¹Ÿä¸ä¼šå› ä¸ºå®ƒè€Œé˜»å¡ã€‚ æ¯ä¸ªbubbleéƒ½æœ‰ä¸€ä¸ªè™šæ‹Ÿæ—¶é’Ÿï¼Œä»2000-01-01 00:00:00 UTC å¼€å§‹. è¿™ä¸ªè™šæ‹Ÿæ—¶é’Ÿä¸ä¼šæ ¹æ®ä»£ç çš„æ‰§è¡Œæ—¶é—´å‰è¿›ï¼Œåªæœ‰åœ¨æ‰€æœ‰goroutineéƒ½å¤„äºç©ºé—²çŠ¶æ€æ—¶æ‰ä¼šå‘å‰æ¨è¿›ã€‚åœ¨TestGoCacheEntryExpiresWithSynctest ä¸­è°ƒç”¨time.Sleep çš„æ—¶å€™ï¼Œ goroutine åªæœ‰ä¸€ä¸ªå¹¶ä¸”å¤„äºç©ºé—²çŠ¶æ€ï¼Œæ—¶é—´ä¼šå¿«é€Ÿå‰è¿›ï¼Œè€Œä¸å¿…ç­‰å¾…çœŸå®æ—¶é—´è¿‡å»ï¼Œæ‰€ä»¥æµ‹è¯•è¿è¡Œé€Ÿåº¦å¾ˆå¿«ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 func TestSynctest(t *testing.T) { synctest.Run(func() { before := time.Now() fmt.Println(\u0026#34;before\u0026#34;, before) f1:=func() { count := 0 for i := 0; i \u0026lt; 10e9; i++ { // time consuming, It\u0026#39;s about 3s in my machine count++ } } go f1() synctest.Wait() //wait f1 after := time.Now() // time is not affected by the running time of f1 fmt.Println(\u0026#34;after\u0026#34;, after) }) } è¿è¡Œç»“æœä¸ºï¼š\n1 2 3 4 5 6 âœ synctest git:(main) âœ— time GOEXPERIMENT=synctest gotip test -run TestSynctest before 2000-01-01 08:00:00 +0800 CST m=+946164282.733407335 after 2000-01-01 08:00:00 +0800 CST m=+946164282.733407335 PASS ok blog-example/go/go1.24/synctest 3.131s GOEXPERIMENT=synctest gotip test -run TestSynctest 3.45s user 1.25s system 133% cpu 3.533 total åœ¨ gosrc ä¸­å·²ç»å·²ç»æœ‰è›®å¤šä½¿ç”¨ synctest ä¼˜åŒ–case çš„ä¾‹å­ã€‚\nå‚è€ƒèµ„æ–™ï¼š\nhttps://github.com/golang/go/blob/05d8984781f7cf2f0f39b53699a558b6a1965c6c/src/testing/synctest/synctest.go#L41\n","date":"2024-12-19T19:22:52+08:00","image":"https://images.hxzhouh.com/blog-images/2024/12/260aeb6207be4b765d34328515c144dc.png","permalink":"https://huizhou92.com/zh-cn/p/go-1.24-%E6%96%B0%E7%9A%84%E5%AE%98%E6%96%B9%E5%BA%93-synctest/","title":"Go 1.24: æ–°çš„å®˜æ–¹åº“ synctest"},{"content":"åŸæ–‡é“¾æ¥ï¼š\u0026ldquo;Security Is Our Top Priority\u0026rdquo; is BS\nå‡ å¹´å‰ï¼Œæˆ‘è¢«é‚€è¯·å»åšä¸€ä¸ªå…³äºè½¯ä»¶å®‰å…¨çš„ä¼šè®®æ¼”è®²ã€‚å…¶å®ï¼Œæˆ‘å¹¶æ²¡æœ‰çœŸæ­£è¢«é‚€è¯·ï¼Œè€Œæ˜¯æˆ‘çš„å…¬å¸è´­ä¹°äº†ä¸€ä¸ªåŒ…å«æ¼”è®²å¸­ä½çš„èµåŠ©åŒ…ï¼Œæˆ‘å›å¤äº†ä¸€å°å†…éƒ¨é‚®ä»¶ï¼Œè‡ªæ„¿å‚ä¸äº†è¿™ä¸ªæ´»åŠ¨ ğŸ¤£ æ— è®ºå¦‚ä½•ï¼Œåœ¨å‡†å¤‡æˆ‘çš„æ¼”è®²è¿‡ç¨‹ä¸­ï¼Œæˆ‘æ„è¯†åˆ°äº†å‡ ä¸ªå…³äºå®‰å…¨çš„é‡è¦è§‚ç‚¹ï¼Œè¿™äº›è§‚ç‚¹è‡ªæ­¤ä¸€ç›´è¦ç»•åœ¨æˆ‘çš„å¿ƒå¤´ï¼š\nå®‰å…¨æ˜¯æ— æ­¢å¢ƒçš„ã€‚ä½ æ€»æ˜¯å¯ä»¥æŠ•å…¥æ›´å¤šåŠªåŠ›æ¥æé«˜å®‰å…¨æ€§ã€‚è´¨é‡å’Œå®‰å…¨ã€å‘˜å·¥æ»¡æ„åº¦ç­‰ä¹Ÿæ˜¯å¦‚æ­¤ã€‚ å®‰å…¨çš„éœ€æ±‚ä¸ä¾¿æ·çš„ç”¨æˆ·ä½“éªŒéœ€æ±‚ç›¸å†²çªã€‚å¢å¼ºä¸€ä¸ªæ–¹é¢å¾€å¾€ä¼šæŸå®³å¦ä¸€ä¸ªæ–¹é¢ã€‚ ç°åœ¨ï¼Œæœ‰äº›ç»„ç»‡å®£ç§°â€œå®‰å…¨æ˜¯æˆ‘ä»¬çš„é¦–è¦ä»»åŠ¡â€ã€‚çœŸçš„å—ï¼Ÿä½ æƒ³è¦å°†ä¸€ä¸ªæ²¡æœ‰ä¸Šé™çš„äº‹æƒ…ä½œä¸ºä½ çš„é¦–è¦ä»»åŠ¡ï¼Ÿæˆ‘çš„æ„æ€æ˜¯ï¼Œå®‰å…¨æ˜¯ä¸€ä»¶å¥½äº‹ï¼Œä½†è¿™å¬èµ·æ¥æ˜¯ä¸æ˜¯æœ‰ç‚¹å¤ªç®€å•äº†ï¼Ÿå®é™…ä¸Šï¼Œåƒè¿™æ ·çš„ç©ºæ´è¥é”€å£°æ˜å¯èƒ½ä¼šè®©æˆ‘æœ‰ç‚¹ç”Ÿæ°”ã€‚åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å°†å¸®åŠ©ä½ ç†è§£å¦‚ä½•è§£è¯»è¿™æ ·çš„å£°æ˜ï¼Œä»¥åŠåœ¨ç°å®ç”Ÿæ´»ä¸­å¦‚ä½•å¤„ç†å®‰å…¨é—®é¢˜ã€‚æˆ‘å°†æ¶µç›–ï¼š\nä¸€ä¸ªå“²å­¦æ€§çš„ä»‹ç» â€œå®‰å…¨æ˜¯æˆ‘ä»¬çš„é¦–è¦ä»»åŠ¡â€å®é™…ä¸Šæ„å‘³ç€ä»€ä¹ˆï¼Ÿ ä½ åº”è¯¥åœ¨å¤šå¤§ç¨‹åº¦ä¸Šé‡è§†å®‰å…¨ï¼Ÿ å…¬å¸åº”è¯¥æ€ä¹ˆè¯´æ›¿ä»£è¿™å¥è¯ï¼Ÿ å®‰å…¨æ€§ä¸ç”¨æˆ·ä½“éªŒå¹³è¡¡çš„å“²å­¦æ€è€ƒ å®‰å…¨çš„æ— é™æ€§ä»¥åŠå®ƒä¸ç”¨æˆ·ä½“éªŒï¼ˆUXï¼‰ä¹‹é—´çš„å¹³è¡¡è®©æˆ‘æƒ³èµ·äº†æŸä»¶äº‹ã€‚æˆ‘ä¸å¾—ä¸åœä¸‹æ¥æ€è€ƒäº†ä¸€ä¼šå„¿ï¼Œç„¶åæˆ‘æƒ³èµ·æ¥äº†ã€‚å¤§çº¦åœ¨æˆ‘19æˆ–20å²çš„æ—¶å€™ï¼Œæˆ‘å‘ç°äº†GK Chestertonã€‚æˆ‘éå¸¸å–œæ¬¢ä»–ï¼Œå› ä¸ºä»–è®©æˆ‘æ„è¯†åˆ°å®é™…ä¸Šæœ‰éå¸¸äº†ä¸èµ·çš„åŸºç£æ•™æ€æƒ³å®¶ï¼Œè€Œåœ¨æˆ‘é‚£ç§å¤šå°‘ç®—æ˜¯ç¦éŸ³æ´¾çš„èƒŒæ™¯ä¸­ï¼Œè¿™æ ·çš„äººå¹¶ä¸å¤šã€‚ä¸å¹¸çš„æ˜¯ï¼Œå°½ç®¡æœ‰Chestertonçš„å½±å“ï¼Œä½†ä¸20å²æ—¶çš„æˆ‘å¸Œæœ›çš„ç›¸åï¼Œæˆ‘ä¸ªäººçš„ä¿¡ä»°å¹¶æ²¡æœ‰åšæŒä¸‹å»ã€‚ä¸è¿‡ï¼Œæˆ‘è¿˜æ˜¯ä»ä»–çš„è‘—ä½œä¸­å­¦åˆ°äº†å¾ˆå¤šè‡³ä»Šä»æ„Ÿæ¿€çš„ä¸œè¥¿ã€‚è¿™é‡Œæœ‰ä¸€æ®µä¸æˆ‘ä»¬è®¨è®ºçš„è¯é¢˜ç›¸å…³çš„å¼•ç”¨ï¼š\nâ€œç°ä»£ç¤¾ä¼šå¹¶ä¸é‚ªæ¶ï¼›åœ¨æŸäº›æ–¹é¢ï¼Œç°ä»£ç¤¾ä¼šå¤ªè¿‡ç¾å¥½äº†ã€‚å®ƒå……æ»¡äº†ç‹‚é‡è€Œè¢«æµªè´¹çš„ç¾å¾·ã€‚å½“ä¸€ä¸ªå®—æ•™ä½“ç³»è¢«ç²‰ç¢ï¼ˆæ­£å¦‚åŸºç£æ•™åœ¨å®—æ•™æ”¹é©ä¸­è¢«ç²‰ç¢é‚£æ ·ï¼‰ï¼Œè¢«é‡Šæ”¾çš„ä¸ä»…ä»…æ˜¯æ¶ä¹ ã€‚æ¶ä¹ ç¡®å®è¢«é‡Šæ”¾äº†ï¼Œå®ƒä»¬å››å¤„æ¸¸è¡å¹¶é€ æˆç ´åã€‚ä½†ç¾å¾·ä¹Ÿè¢«é‡Šæ”¾äº†ï¼›ç¾å¾·æ¸¸è¡å¾—æ›´åŠ ç–¯ç‹‚ï¼Œç¾å¾·é€ æˆçš„ç ´åæ›´åŠ å¯æ€•ã€‚ç°ä»£ç¤¾ä¼šå……æ»¡äº†æ—§åŸºç£æ•™ç¾å¾·çš„ç–¯ç‹‚ã€‚ç¾å¾·ä¹‹æ‰€ä»¥ç–¯ç‹‚ï¼Œæ˜¯å› ä¸ºå®ƒä»¬å½¼æ­¤å­¤ç«‹ï¼Œç‹¬è‡ªæ¸¸è¡ã€‚å› æ­¤ï¼Œæœ‰äº›ç§‘å­¦å®¶åªå…³å¿ƒçœŸç†ï¼›è€Œä»–ä»¬çš„çœŸç†æ˜¯æ— æƒ…çš„ã€‚å› æ­¤ï¼Œæœ‰äº›äººæ–‡ä¸»ä¹‰è€…åªå…³å¿ƒæ€œæ‚¯ï¼›è€Œä»–ä»¬çš„æ€œæ‚¯ï¼ˆå¾ˆé—æ†¾åœ°è¯´ï¼‰å¾€å¾€æ˜¯ä¸çœŸå®çš„ã€‚â€â€”â€”GK Chestertonï¼Œã€Šæ­£ç»Ÿã€‹ï¼Œ1908å¹´\nChestertonçš„æ„æ€æ˜¯ï¼Œå¥½çš„äº‹ç‰©ï¼ˆç¾å¾·ï¼‰å¦‚æœè¢«è¿‡åˆ†è¿½æ±‚æˆ–è€…è„±ç¦»äº†å…¶ä»–å¥½çš„äº‹ç‰©ï¼Œå°±å¯èƒ½å˜æˆåäº‹ã€‚è¿™å¬èµ·æ¥ä¼¼ä¹æ˜¯æ˜¾è€Œæ˜“è§çš„ï¼Œç¡®å®å¦‚æ­¤ã€‚ä½†æ˜¯ä¸€æ—¦ä½ æŒæ¡äº†è¿™ä¸ªæ¨¡å¼ï¼Œå°±ä¼šå‘ç°å®ƒä¸€ç›´åœ¨å‘ç”Ÿã€‚åœ¨è¿™ç¯‡åšæ–‡ä¸­ï¼Œæˆ‘ä»¬è°ˆè®ºçš„æ˜¯é‚£äº›å¿½è§†äº†UXçš„å®‰å…¨ç‹‚çƒ­è€…ï¼Œä½†åœ¨æˆ‘ä»¬çš„æ”¿æ²»ä¸–ç•Œä¸­ä¹Ÿæ˜¯å¦‚æ­¤ã€‚æœ‰äº›äººå°†å¤šæ ·æ€§ã€å…¬å¹³æ€§å’ŒåŒ…å®¹æ€§ï¼ˆDEIï¼‰æ¨è¡Œåˆ°æè‡´ï¼Œä»¥è‡³äºå°†ç™½äººç”·æ€§å¦–é­”åŒ–ã€‚æœ‰äº›äººå°†å®¶åº­ä»·å€¼è§‚æ¨å´‡åˆ°æè‡´ï¼Œè®©å…¶ä»–äººæ„Ÿåˆ°æ ¼æ ¼ä¸å…¥ã€‚å®¶åº­ä»·å€¼è§‚å’ŒåŒ…å®¹æ€§éƒ½æ˜¯å¥½ä¸œè¥¿ï¼Œä½†å¦‚æœå®ƒä»¬è¢«å­¤ç«‹å¯¹å¾…ï¼Œå°±å¯èƒ½èµ°å‘æç«¯ï¼Œå¹¶åœ¨ç¾¤ä½“ä¹‹é—´é€ æˆåˆ†è£‚ã€‚\nå› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦åœ¨æ‰€æœ‰ç¾å¥½çš„äº‹ç‰©ä¹‹é—´æ‰¾åˆ°ä¸€ä¸ªå¥åº·çš„å¹³è¡¡ï¼Œä¸è®©ä»»ä½•ä¸€ä¸ªèµ°å‘æç«¯è€Œå¿½è§†å…¶ä»–ã€‚è¿™å¹¶ä¸å®¹æ˜“ï¼å¦‚æœä½ æ˜¯ä¸€ä¸ªå®‰å…¨æç«¯ä¸»ä¹‰è€…ï¼Œå³ä½¿ä½ è¿˜æ˜¯è¢«é»‘å®¢æ”»å‡»äº†ï¼Œè‡³å°‘å¯ä»¥è¯´ä½ å·²ç»ç«­å°½å…¨åŠ›æ¥æé«˜å®‰å…¨æ€§ã€‚å¦ä¸€æ–¹é¢ï¼Œå¦‚æœä½ åœ¨å®‰å…¨æ€§å’ŒUXä¹‹é—´å–å¾—äº†å¹³è¡¡ï¼Œå¹¶ä¸ºäº†æ›´å¥½çš„UXè€Œåšå‡ºäº†ä¸€äº›é™ä½å®‰å…¨æ€§çš„å†³å®šï¼Œç„¶åé­åˆ°äº†é»‘å®¢æ”»å‡»ã€‚ä½ å¦‚ä½•ä¸ºè‡ªå·±è¾©æŠ¤ï¼Ÿè¯´â€œç°å®æ˜¯å¤æ‚çš„ï¼Œæˆ‘ä»¬åœ¨è¿™ç§æƒ…å†µä¸‹å†³å®šä¼˜å…ˆè€ƒè™‘UXâ€å¹¶ä¸æ˜¯ä¸€ä¸ªå¬èµ·æ¥å¾ˆå¥½çš„å›ç­”ã€‚æå«éæç«¯ç«‹åœºéœ€è¦å‹‡æ°”ï¼Œå› ä¸ºæç«¯ä¸»ä¹‰è€…æ€»æ˜¯æœ‰æ›´æœ‰åŠ›çš„å£å·ã€‚\nâ€œå®‰å…¨æ˜¯æˆ‘ä»¬çš„é¦–è¦ä»»åŠ¡â€å®é™…ä¸Šæ„å‘³ç€ä»€ä¹ˆï¼Ÿ å®‰å…¨çœŸçš„æ˜¯æ— é™çš„å—ï¼Ÿæˆ‘è®¤ä¸ºæ˜¯çš„ã€‚å®é™…ä¸Šï¼Œé“¶è¡Œæœ€å®‰å…¨çš„è¿è¥æ–¹å¼å¯èƒ½æ˜¯å…³é—­ä»–ä»¬çš„åœ¨çº¿ä¸šåŠ¡ï¼Œè´­ä¹°ä¸€ä¸ªå¤§ä¿é™©åº“ï¼Œå¹¶åœ¨é—¨å¤–éƒ¨ç½²ä¸€æ”¯å°å‹å†›é˜Ÿã€‚å³ä¾¿å¦‚æ­¤ï¼Œå®‰å…¨æ£€æŸ¥çš„å¼ºåº¦å’Œå†›é˜Ÿçš„è§„æ¨¡ä¹Ÿå¯ä»¥æ— é™å¢åŠ ã€‚ç„¶è€Œï¼Œå¤§å¤šæ•°äººè¿˜æ˜¯æ›´æ„¿æ„é€šè¿‡é“¶è¡Œåº”ç”¨ç¨‹åºçš„é¢éƒ¨è¯†åˆ«æ¥è½¬è´¦ï¼Œå¹¶è®¤ä¸ºè¿™ç§å®‰å…¨ç¨‹åº¦å·²ç»è¶³å¤Ÿå¥½ã€‚\nå…¬å¸çœŸçš„ä¼šè¿™ä¹ˆè¯´å—ï¼Ÿæ˜¯çš„ã€‚æ¯”å¦‚å¾®è½¯çš„â€œå°†å®‰å…¨ç½®äºä¸€åˆ‡ä¹‹ä¸Šâ€ï¼ŒAWSçš„â€œåœ¨AWSï¼Œäº‘å®‰å…¨æ˜¯æœ€é«˜ä¼˜å…ˆçº§â€ï¼ŒMetaçš„â€œä¿æŠ¤æ‚¨çš„æ•°æ®æ˜¯æˆ‘ä»¬çš„æœ€é«˜ä¼˜å…ˆçº§â€ï¼Œè¿˜æœ‰å¾ˆå¤šå…¶ä»–ä¾‹å­ã€‚\nè¿™å¬èµ·æ¥ä¸é”™ï¼Œä½†åœ¨å®è·µä¸­ï¼Œè¿™æ˜¯å¦æ„å‘³ç€åªè¦æœ‰äººæå‡ºä»¥ç‰ºç‰²UXã€æ¶ˆè´¹è€…ä»·æ ¼ç­‰ä¸ºä»£ä»·æ¥æé«˜å®‰å…¨æ€§çš„æƒ³æ³•ï¼Œä½ å°±ä¼šå®æ–½ï¼Ÿå› ä¸ºè¿™ä¼¼ä¹æ˜¯å®ƒçš„æ„æ€ã€‚å½“ç„¶ï¼Œç­”æ¡ˆæ˜¯å¦å®šçš„ï¼Œæ‰€ä»¥æˆ‘å¯¹è¿™äº›å£°æ˜å¹¶ä¸å¤ªè®¤çœŸï¼Œå°½ç®¡æˆ‘ç†è§£è¿™ç»™å®¢æˆ·å¸¦æ¥äº†ä¸€ç§æ¸©æš–è€Œæ¨¡ç³Šçš„æ„Ÿè§‰ã€‚æˆ‘æ›´å¸Œæœ›ç»„ç»‡èƒ½å¤Ÿå¦è¯šå’Œæ¸…æ™°ï¼Œä½†æˆ‘åªèƒ½æ¢¦æƒ³åœ¨ä¸€ä¸ªè¿™æ ·çš„ä¸–ç•Œé‡Œã€‚\nå®é™…ä¸Šï¼Œè¿™äº›å…¬å¸æ‰€è¡¨è¾¾çš„å¯èƒ½æ˜¯ï¼š\nâ€œæˆ‘ä»¬æœ‰ä¸€ä¸ªå¹³è¡¡çš„ä¼˜å…ˆçº§æ¡†æ¶ï¼Œæˆ‘ä»¬å¯¹é—®é¢˜è¿›è¡Œåˆ†ç±»å¹¶ç»™äºˆæ¯ä¸ªé—®é¢˜åŠ æƒå¾—åˆ†ã€‚æˆ‘ä»¬ç»™UXé—®é¢˜åˆ†é…20%ï¼Œå®‰å…¨25%ï¼ŒæŠ€æœ¯å€ºåŠ¡10%ï¼Œæ–°åŠŸèƒ½20%ï¼Œç­‰ç­‰ã€‚æ­£å¦‚ä½ æ‰€è§ï¼Œé£é™©æ˜¯é¦–è¦ä¼˜å…ˆçº§ï¼Œå› ä¸º25%é«˜äº20%ã€‚â€\næˆ–è€…ä»–ä»¬å¯èƒ½æ„å‘³ç€ï¼š\nâ€œå®‰å…¨ï¼ˆè¾¾åˆ°æˆ‘ä»¬è¡Œä¸šä¸­æ ‡å‡†æ°´å¹³çš„å®‰å…¨æ€§ï¼‰æ˜¯æˆ‘ä»¬çš„é¦–è¦ä»»åŠ¡ã€‚ä¸€æ—¦æˆ‘ä»¬å®æ–½äº†è¶³å¤Ÿçš„å®‰å…¨æªæ–½ï¼Œæˆ‘ä»¬å°±ä¼šä¸“æ³¨äºå…¶ä»–é—®é¢˜ã€‚â€\nå¦‚æœä½ æœ‰å®Œå…¨è¯šå®çš„å®‰å…¨å£°æ˜çš„ä¾‹å­ï¼Œæ¯”å¦‚â€œæˆ‘ä»¬å…³å¿ƒå®‰å…¨ï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦ä½ ä¿¡ä»»æˆ‘ä»¬ï¼Œå› æ­¤å®ƒæ˜¯æˆ‘ä»¬çš„é¦–è¦ä»»åŠ¡ä¹‹ä¸€â€ï¼Œæˆ‘ä¼šéå¸¸æ„Ÿå…´è¶£ã€‚è¯·åœ¨è¯„è®ºä¸­åˆ†äº«ï¼\nå®‰å…¨æ€§åº”è¯¥åšåˆ°ä»€ä¹ˆç¨‹åº¦ï¼Ÿ å½“æˆ‘åœ¨2018å¹´åšé‚£æ¬¡æ¼”è®²æ—¶ï¼Œæˆ‘è¿˜ä¸æ¸…æ¥šåˆ°åº•åº”è¯¥åœ¨ä½•å¤„åˆ’çº¿ã€‚è‡ªé‚£ä»¥åï¼Œæˆ‘å¼€å§‹ä½¿ç”¨ISO 14971å’ŒISO 27001è¿™æ ·çš„é£é™©æ¡†æ¶è¿›è¡Œå·¥ä½œï¼Œç°åœ¨æˆ‘å·²ç»æœ‰äº†ä¸€äº›å·¥å…·æ¥å¸®åŠ©æˆ‘å¤„ç†è¿™ä¸ªé—®é¢˜ã€‚\nä¸€åˆ‡å§‹äºä¸€ä¸ªè¯„åˆ†æœºåˆ¶ï¼šå¼„æ¸…æ¥šæˆ‘ä»¬éœ€è¦ä¿æŠ¤çš„æ˜¯ä»€ä¹ˆï¼Œå­˜åœ¨å“ªäº›é£é™©ï¼Œä»¥åŠè¿™äº›é£é™©å‘ç”Ÿçš„å¯èƒ½æ€§å’Œä¸¥é‡ç¨‹åº¦å¦‚ä½•ã€‚ä½ å°†å¯èƒ½æ€§å’Œä¸¥é‡æ€§ç›¸ä¹˜ï¼Œä¸ºæ¯ä¸ªé£é™©å¾—å‡ºä¸€ä¸ªé£é™©åˆ†æ•°ï¼Œç„¶åå°†è¿™äº›åˆ†æ•°æ˜ å°„åˆ°ä½ã€ä¸­ã€é«˜ä¸‰ä¸ªç­‰çº§ã€‚\nå¦‚æœé£é™©åˆ†æ•°æ˜¯ä½çš„ï¼Œä½ å¯ä»¥å®‰å…¨åœ°æ¥å—è¿™ä¸ªé£é™©ã€‚ å¦‚æœæ˜¯ä¸­ç­‰ï¼Œä½ åº”è¯¥è€ƒè™‘é£é™©æ§åˆ¶ï¼Œé™¤éæœ‰æ­£å½“ç†ç”±ä¸è¿™ä¹ˆåšã€‚ å¦‚æœæ˜¯é«˜é£é™©ï¼Œä½ å¿…é¡»å®æ–½é£é™©æ§åˆ¶ã€‚ ç„¶åï¼Œä¸€æ—¦é£é™©æ§åˆ¶æªæ–½åˆ°ä½ï¼ŒéªŒè¯å®ƒä»¬æ˜¯å¦çœŸæ­£å‡è½»äº†é£é™©ï¼Œå‰©ä½™é£é™©æ˜¯å¦ç°åœ¨å˜ä½æˆ–ä¸å­˜åœ¨ã€‚è¿™æ ·ä½ å°±å®Œæˆäº†ã€‚\nå¬èµ·æ¥ç®€å•ï¼Œä½†ä½ã€ä¸­ã€é«˜çš„ç•Œé™æˆ‘ä»¬åº”è¯¥æ€ä¹ˆåˆ’åˆ†å‘¢ï¼Ÿæˆ‘æ€»æ˜¯æŠŠä¸€äº›å†³ç­–è€…èšåœ¨ä¸€èµ·ï¼Œç»™ä»–ä»¬æä¾›å¯èƒ½å‡ºé”™çš„æƒ…å†µçš„ä¾‹å­ï¼Œç„¶åè¯·ä»–ä»¬æå‡ºä¸€ä¸ªè¯„åˆ†ç³»ç»Ÿã€‚æ¥ç€è¯¢é—®ä»–ä»¬æ„¿æ„æ¥å—å“ªäº›ç±»å‹çš„é£é™©ï¼ŒåŒæ—¶è€ƒè™‘åˆ°å¦‚æœåº”ç”¨äº†é£é™©æ§åˆ¶ï¼Œäº§å“æˆ–æµç¨‹ä¼šæ˜¯ä»€ä¹ˆæ ·å­ã€‚\nè¿™ä¸ªç®€å•çš„è¯„åˆ†ç³»ç»ŸåŒ…æ‹¬é£é™©çŸ©é˜µã€é£é™©åå¥½/é£é™©æ¥å—æ”¿ç­–å’Œé£é™©æ¸…å•ã€‚è¿™æ˜¯ä¸€ä¸ªç®€å•çš„å·¥å…·ï¼Œå¯ä»¥å¸®åŠ©ä½ åšå‡ºå†³ç­–ã€‚\næˆ‘ä»¬åº”è¯¥æ€ä¹ˆè¯´ï¼Ÿ å‡ åå¹´æ¥ï¼Œå…¨çƒéƒ½åœ¨ä»¥æˆç†Ÿçš„æ–¹å¼å¤„ç†å®‰å…¨ã€è´¨é‡å’Œå®‰å…¨é—®é¢˜ã€‚è®©æˆ‘ä»¬æ¨å¹¿é‚£äº›å®é™…è¿™ä¹ˆåšçš„å…¬å¸ï¼Œè€Œä¸æ˜¯è¯´è¿™æ˜¯ä»–ä»¬çš„é¦–è¦ä»»åŠ¡ã€‚è¿™æ˜¯ä¸€ä¸ªæ²¡æœ‰æ„ä¹‰çš„å£°æ˜ã€‚\nåœ¨æˆ‘ç†æƒ³çš„ä¸–ç•Œé‡Œï¼Œå…¬å¸ä¼šè¯´ï¼šâ€œæˆ‘ä»¬ç»´æŠ¤ç€æœ€å…ˆè¿›çš„å®‰å…¨ä½“ç³»ï¼Œå› ä¸ºæ²¡æœ‰å®¢æˆ·çš„ä¿¡ä»»ï¼Œæˆ‘ä»¬ä½œä¸ºå…¬å¸å°±æ²¡æœ‰å­˜åœ¨çš„æƒåˆ©ã€‚å› æ­¤ï¼Œè¿™æ˜¯æˆ‘ä»¬å·¥ä½œä¸­æœ€é‡è¦çš„äº‹æƒ…ä¹‹ä¸€ï¼Œæˆ‘ä»¬æŠ•å…¥äº†å¤§é‡çš„ç²¾åŠ›ã€‚â€è¿™å¯èƒ½å¯¹å¤§å¤šæ•°äººæ¥è¯´å¬èµ·æ¥æ²¡æœ‰é‚£ä¹ˆå¥½ï¼Œä½†è¿™æ ·è¯´çš„å…¬å¸è‚¯å®šä¼šç»™æˆ‘ç•™ä¸‹æ·±åˆ»çš„å°è±¡ã€‚\nåŸæ–‡è¿æ¥ï¼š\u0026ldquo;Security Is Our Top Priority\u0026rdquo; is BS\n","date":"2024-12-19T11:07:26+08:00","image":"https://images.unsplash.com/photo-1614064849549-ba6c7b819a49?crop=entropy\u0026cs=tinysrgb\u0026fit=max\u0026fm=jpg\u0026ixid=M3wzNjAwOTd8MHwxfHNlYXJjaHw1NHx8c2VjdXJpdHl8ZW58MHwwfHx8MTczNDU3ODA0NXww\u0026ixlib=rb-4.0.3\u0026q=80\u0026w=400","permalink":"https://huizhou92.com/zh-cn/p/%E8%AF%91%E5%AE%89%E5%85%A8%E6%98%AF%E6%88%91%E4%BB%AC%E7%9A%84%E9%A6%96%E8%A6%81%E4%BB%BB%E5%8A%A1--%E8%BF%99%E6%98%AF%E4%B8%80%E5%8F%A5%E5%BA%9F%E8%AF%9D/","title":"ã€è¯‘ã€‘â€œå®‰å…¨æ˜¯æˆ‘ä»¬çš„é¦–è¦ä»»åŠ¡â€--è¿™æ˜¯ä¸€å¥åºŸè¯"},{"content":"weak æ˜¯ä»€ä¹ˆï¼Ÿ Golang åœ¨1.24 ä¸­å¸¦æ¥äº†ä¸€ä¸ªæ–°çš„std-lib weakã€‚ å¯ä»¥ä¸º*T åˆ›å»ºä¸€ä¸ªå®‰å…¨çš„å¼•ç”¨ï¼Œä½†æ˜¯ä¸ä¼šé˜»æ­¢ *T è¢«GC å›æ”¶ã€‚\nPackage weak provides ways to safely reference memory weakly, that is, without preventing its reclamation.\nè·Ÿ OS.ROOT ä¸€æ ·ï¼Œ weak ä¹Ÿæ˜¯ä¸€ä¸ªåœ¨å…¶ä»–è¯­è¨€ä¸­å­˜åœ¨å¾ˆä¹…çš„åŠŸèƒ½ï¼Œæ¯”å¦‚ï¼š\nJava çš„ WeakReference å’Œ SoftReference æ˜¯ç»å…¸å®ç°ï¼Œä¸»è¦ç”¨äºç¼“å­˜å’Œå¯¹è±¡æ± ã€‚å®ƒä»¬èƒ½å¤Ÿåœ¨ JVM æ£€æµ‹åˆ°å†…å­˜ä¸è¶³æ—¶è‡ªåŠ¨å›æ”¶ã€‚ Python æä¾›äº† weakref æ¨¡å—ï¼Œå…è®¸åˆ›å»ºå¼±å¼•ç”¨å¯¹è±¡ï¼Œå¸¸ç”¨äºé˜²æ­¢å¾ªç¯å¼•ç”¨é—®é¢˜æˆ–ç¼“å­˜ã€‚ c++ åœ¨ std::shared_ptr ä¸­å¼•å…¥äº† std::weak_ptrï¼Œç”¨äºè§£å†³å…±äº«æŒ‡é’ˆçš„å¾ªç¯ä¾èµ–é—®é¢˜ã€‚ Rust æä¾› Rc å’Œ Arc çš„å¼±å¼•ç”¨ç‰ˆæœ¬ Weakï¼Œä¹Ÿç”¨äºé¿å…å¾ªç¯å¼•ç”¨å¹¶æå‡å†…å­˜ç®¡ç†çš„çµæ´»æ€§ã€‚ weak çš„å®šä¹‰å¾ˆç®€å•ï¼Œä¸€ä¸ªMake æ–¹æ³•è¿˜æœ‰ä¸€ä¸ªValue æ–¹æ³•ã€‚\né€šè¿‡weak.Make åˆ›å»ºä¸€ä¸ªweak.Pointer ,å¦‚æœ T æ²¡æœ‰è¢«å›æ”¶çš„è¯ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡weak.Pointer.Value è·å–Tçš„åœ°å€ã€‚ å¦åˆ™å°±ä¼šè¿”å› nilï¼Œå¾ˆç®€å•ã€‚\næˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸€ä¸ªç®€å•çš„ä¾‹å­æ¥å®è·µä¸€ä¸‹ weakã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 func main() { originalObject := \u0026#34;Hello, World!\u0026#34; runtime.AddCleanup(\u0026amp;originalObject, func(s int64) { fmt.Println(\u0026#34;originalObject clean at: \u0026#34;, s) }, time.Now().Unix()) weakPtr := weak.Make(\u0026amp;originalObject) fmt.Println(fmt.Sprintf(\u0026#34;originalObject:addr %x\u0026#34;, \u0026amp;originalObject)) fmt.Println(fmt.Sprintf(\u0026#34;weakPtr addr:%x,size:%d\u0026#34;, weakPtr, unsafe.Sizeof(weakPtr))) runtime.GC() time.Sleep(1 * time.Millisecond) value := weakPtr.Value() if value != nil \u0026amp;\u0026amp; strings.Contains(*value, originalObject) { fmt.Println(\u0026#34;First GC :value: \u0026#34;, *value) } else { fmt.Println(\u0026#34;first gc. Weak reference value is nil\u0026#34;) } runtime.GC() time.Sleep(1 * time.Millisecond) value = weakPtr.Value() if value != nil { fmt.Println(\u0026#34;Second GC\u0026#34;, *value) } else { fmt.Println(\u0026#34;Second GC: Weak reference value is nil\u0026#34;) } } https://gist.github.com/hxzhouh/abd6be9ed8860e506643031bb2d446ce\nè¿è¡Œç»“æœ\n1 2 3 4 5 6 7 8 âœ weak git:(main) âœ— gotip version go version devel go1.24-18b5435 Sun Dec 15 21:41:28 2024 -0800 darwin/arm64 âœ weak git:(main) âœ— gotip run main.go originalObject:addr 14000010050 weakPtr addr:{1400000e0d0},size:8 First GC :value: Hello, World! originalObject clean at: 1734340907 Second GC: Weak reference value is nil åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ª string å˜é‡ originalObject ,ç„¶åä½¿ç”¨weak.Make åˆ›å»ºäº†ä¸€ä¸ª weak.Pointer weakPtr\nåœ¨ç¬¬ä¸€æ¬¡GC çš„æ—¶å€™ï¼Œå› ä¸ºoriginalObject åœ¨åé¢è¿˜æœ‰ä½¿ç”¨ï¼Œæ‰€ä»¥ weakPtr.Value è¿”å›äº† originalObject çš„åœ°å€ã€‚ åœ¨ç¬¬äºŒæ¬¡GC çš„æ—¶å€™ï¼ŒoriginalObject æ²¡æœ‰è¢«ä½¿ç”¨ï¼Œå®ƒè¢«GCå›æ”¶äº†ï¼Œ æ‰€ä»¥ weakPtr.Value è¿”å›äº†nil runtime.AddCleanup ä¹Ÿæ˜¯go 1.24 æ–°å¢çš„åŠŸèƒ½ï¼Œå®ƒçš„åŠŸèƒ½ç±»ä¼¼ runtime.SetFinalizer,ä¹Ÿæ˜¯åœ¨ å¯¹è±¡å‘—åƒåœ¾å›æ”¶çš„æ—¶å€™ç”¨äºæ‰§è¡Œä¸€æ®µä»£ç ã€‚æˆ‘åé¢å¯èƒ½ä¼šè¯¦ç»†ä»‹ç»å®ƒ\né€šè¿‡ä¸Šé¢çš„ä¾‹å­ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“ weak.Make é€šè¿‡åˆ›å»ºä¸€ä¸ªä¸­é—´åœ°å€(weak.Printer)å°†çœŸå®åœ°å€éšè—èµ·æ¥ã€‚ weak.Printer ä¸ä¼šå½±å“ çœŸå®åœ°å€çš„åƒåœ¾å›æ”¶ï¼Œå¦‚æœçœŸå®åœ°å€è¢«åƒåœ¾å›æ”¶äº†ï¼Œweak.Printer.Value å°†ä¼šè¿”å›nilã€‚ç”±äºä¸çŸ¥é“çœŸå®åœ°å€ä»€ä¹ˆæ—¶å€™ä¼šè¢«å›æ”¶ï¼Œæ‰€ä»¥éœ€è¦ä»”ç»†æ£€æŸ¥weak.Printer.Value çš„è¿”å›å€¼ã€‚ weak æœ‰ä»€ä¹ˆä½œç”¨ canonicalization maps ç›¸ä¿¡æ‚¨è¿˜è®°å¾—åœ¨go 1.23 ä¸­æ·»åŠ çš„ unique å®ƒå¯ä»¥å°†å¤šä¸ªç›¸åŒçš„å­—ç¬¦ä¸²ç”¨ä¸€ä¸ªæŒ‡é’ˆï¼ˆ8ä¸ªå­—èŠ‚ï¼‰æ¥è¡¨ç¤ºï¼Œè¾¾åˆ°èŠ‚çº¦å†…å­˜çš„ç›®çš„ , weak ä¹Ÿèƒ½å®ç°ç±»ä¼¼çš„æ•ˆæœ.(å®é™…ä¸Š go 1.24 ä¸­unique å·²ç»ä½¿ç”¨ weak é‡æ„äº†)\nå®ç°ä¸€ä¸ªå›ºå®šå¤§å°çš„ç¼“å­˜ ä¸‹é¢æ˜¯ä¸€ä¸ªä½¿ç”¨weak+ list.List å®ç° å›ºå®šå¤§å°ç¼“å­˜çš„ä¾‹å­\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 type WeakCache struct { cache map[string]weak.Pointer[list.Element] // Use weak references to store values mu sync.Mutex storage Storage } // Storage is a fixed-length cache based on doubly linked tables and weaktype Storage struct { capacity int // Maximum size of the cache list *list.List } // Set func (c *WeakCache) Set(key string, value any) { // If the element already exists, update the value and move it to the head of the chain table if elem, exists := c.cache[key]; exists { if elemValue := elem.Value(); elemValue != nil { elemValue.Value = \u0026amp;CacheItem{key: key, value: value} c.storage.list.MoveToFront(elemValue) elemWeak := weak.Make(elemValue) c.cache[key] = elemWeak return } else { c.removeElement(key) } } // remove the oldest unused element if capacity is full if c.storage.list.Len() \u0026gt;= c.storage.capacity { c.evict() } // Add new element elem := c.storage.list.PushFront(\u0026amp;CacheItem{key: key, value: value}) elemWeak := weak.Make(elem) c.cache[key] = elemWeak } å®Œæ•´çš„ä»£ç è¯·å‚è€ƒï¼š https://gist.github.com/hxzhouh/1945d4a1e5a6567f084628d60b63f125\næˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªå›ºå®šå¤§å°çš„list ï¼Œç„¶åä½¿ç”¨ä¸€ä¸ªMapè®°å½•keyåœ¨list ä¸­çš„ä½ç½®ï¼Œvalue æ˜¯ä¸€ä¸ªæŒ‡å‘ list.Element çš„weak.Pointer. å¦‚æœ key å­˜åœ¨äºlist ä¸Šï¼Œé‚£ä¹ˆ Map[key].Value ä¼šè¿”å› list çš„åœ°å€ã€‚ å†ç»™cache æ·»åŠ æ•°æ®çš„æ—¶å€™ï¼Œä¼šå…ˆåˆ¤æ–­list çš„å¤§å°ï¼Œå¦‚æœå·²ç»listå·²ç»æ»¡äº†çš„è¯ï¼Œå°±æŠŠé˜Ÿå°¾çš„æ•°æ®æ·˜æ±°ã€‚Map[key].Valueè¿”å›nilã€‚\nè¿™æ ·ï¼Œæˆ‘ä»¬å°±èƒ½æ„å»ºä¸€ä¸ªé«˜æ•ˆ+å›ºå®šå¤§å°çš„cacheç³»ç»Ÿã€‚ weak + æ— é”é˜Ÿåˆ— å¯ä»¥æ„å»ºå‡ºæ›´åŠ é«˜æ•ˆçš„æ•°æ®ç»“æ„ã€‚\nå°±æˆ‘ä¸ªäººè€Œè¨€ï¼Œweak åœ¨ç‰¹å®šåœºåˆä¸‹è¿˜æ˜¯æŒºæœ‰ç”¨å¤„çš„ã€‚ä½¿ç”¨èµ·æ¥ä¹Ÿå¾ˆç®€å•ï¼Œæˆ‘ä¼šåœ¨é¡¹ç›®ä¸­ç§¯æä½¿ç”¨weak\næ›´å¤šå…³äº weak çš„èµ„æ–™\nhttps://tip.golang.org/doc/go1.24#weak https://github.com/golang/go/issues/67552 ","date":"2024-12-14T19:40:46+08:00","image":"https://images.hxzhouh.com/blog-images/2024/12/edbf334955e117265be0194bba455ee3.png","permalink":"https://huizhou92.com/zh-cn/p/go1.24-%E6%96%B0%E7%9A%84%E6%A0%87%E5%87%86%E5%BA%93-weak/","title":"go1.24: æ–°çš„æ ‡å‡†åº“ weak"},{"content":"\nBacklink | |Photo by Kaleidico on Unsplash Golang 1.24 å·²ç»è¿›å…¥å†»ç»“æœŸäº†ï¼Œç›®å‰å¾ˆå¤šç‰¹æ€§æˆ‘ä»¬åœ¨Go 1.24 Release Notes èƒ½å¤Ÿçœ‹åˆ°ï¼Œæ¥ä¸‹æ¥ä¸€æ®µæ—¶é—´æˆ‘ä¼šå­¦ä¹ Golang1.24å°†ä¼šæ·»åŠ çš„æ–°åŠŸèƒ½ä»¥åŠä¿®æ”¹ç‚¹ã€‚å¦‚æœæ‚¨ä¹Ÿæƒ³å­¦ä¹ Goæœ€æ–°çš„è¿›å±•ï¼Œè¯·å…³æ³¨æˆ‘ï¼Œ\nè¿™ç¯‡æ–‡ç« ï¼Œæˆ‘ä»¬å°†å­¦ä¹ ä¸€ä¸‹os.Rootè¿™ä¸ªæ–°å¢çš„Standard libraryã€‚\nProposal ç›®å½•éå†æ¼æ´æ˜¯ä¸€ç±»å¸¸è§çš„æ¼æ´ï¼Œæ”»å‡»è€…ä¼šè¯±éª—ç¨‹åºæ‰“å¼€å…¶ä¸å¸Œæœ›çš„æ–‡ä»¶ã€‚è¿™äº›æ”»å‡»é€šå¸¸é‡‡ç”¨æä¾›ç›¸å¯¹è·¯å¾„åçš„å½¢å¼ï¼Œä¾‹å¦‚\u0026quot;../../../etc/passwd\u0026quot;Â ï¼Œè¿™ä¼šå¯¼è‡´åœ¨é¢„æœŸä½ç½®ä¹‹å¤–è¿›è¡Œè®¿é—®ã€‚Â CVE-2024-3400æ˜¯æœ€è¿‘çš„ä¸€ä¸ªçœŸå®çš„ç›®å½•éå†ç¤ºä¾‹ï¼Œå¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´è¢«ä¸»åŠ¨åˆ©ç”¨ã€‚\nåœ¨å…¶ä»–è¯­è¨€ä»¥åŠæ“ä½œç³»ç»Ÿä¸­ï¼Œå·²ç»éƒ½æœ‰ç±»ä¼¼çš„å®ç°, æ¯”å¦‚:\nPython çš„ chrootï¼šé€šè¿‡ os.chroot() å°†æ ¹ç›®å½•é™åˆ¶ä¸ºç‰¹å®šç›®å½•ã€‚ Linux çš„æ–‡ä»¶ç³»ç»Ÿå‘½åç©ºé—´ï¼šé€šè¿‡ mount å’Œ chroot é™åˆ¶è¿›ç¨‹çš„è§†å›¾ã€‚\næˆ‘ä»¬å¯ä»¥å†™ä¸€ä¸ªdemo æµ‹è¯•ä¸€ä¸‹ã€‚\né¦–å…ˆæ„é€ ä¸€ä¸ª â€œæœºå¯†â€æ–‡ä»¶ 1 echo \u0026#39;password123\u0026#39; \u0026gt;\u0026gt; /tmp/password ç„¶åå†™ä¸€ä¸ªGolangå‡½æ•°ï¼Œ åŸä¹‰æ˜¯æ‰“å¼€å½“å‰ç›®å½•çš„æ–‡ä»¶\n1 2 3 4 5 6 7 8 9 10 11 12 func main() { fileName := os.Args[1] //readFile localFilePath := \u0026#34;.\u0026#34; filePath := fmt.Sprintf(\u0026#34;%s/%s\u0026#34;, localFilePath, fileName) content, err := os.ReadFile(filePath) if err != nil { fmt.Printf(\u0026#34;Error reading file %s: %s\\n\u0026#34;, fileName, err) return } fmt.Printf(\u0026#34;File %s opened successfully. file content %s\\n\u0026#34;, fileName, content) } ä½†æ˜¯å› ä¸ºä¼ å…¥äº†ä¸å¯é çš„å‚æ•°ï¼Œä»£ç èƒ½å¤Ÿè®¿é—®åˆ° æƒé™èŒƒå›´ä¹‹å¤–çš„åœ°æ–¹ã€‚\n1 2 3 4 5 6 âœ os_root git:(main) âœ— pwd /Users/hxzhouh/workspace/github/me/blog-example/go/go1.24/os_root âœ os_root git:(main) âœ— ./main ../../../../../../../../../tmp/password ./../../../../../../../../../tmp/password File ../../../../../../../../../tmp/password opened successfully. file content password123 åœ¨ Go1.24 ä¸­ï¼Œæ–°å¢äº† os.Root çš„ç±»å‹ï¼Œå…¶æä¾›äº†åœ¨ç‰¹å®šç›®å½•ä¸­æ‰§è¡Œæ–‡ä»¶ç³»ç»Ÿæ“ä½œçš„èƒ½åŠ›ã€‚æ•´ä¸ªä½“ç³»æ˜¯å›´ç»•ç€è¿™ä¸ªæ–°ç±»å‹è¿›è¡Œçš„ã€‚ å¯¹åº”çš„æ ¸å¿ƒå‡½æ•°æ˜¯ os.OpenRootï¼Œå‡½æ•°æ‰“å¼€ä¸€ä¸ªç›®å½•å¹¶è¿”å›ä¸€ä¸ª os.Rootã€‚\nos.Root ä¸Šçš„æ–¹æ³•ä»…å…è®¸åœ¨ç›®å½•å†…æ“ä½œï¼Œä¸å…è®¸æŒ‡å‘ç›®å½•å¤–éƒ¨ä½ç½®çš„è·¯å¾„ï¼ŒåŒ…æ‹¬éµå¾ªç›®å½•å¤–ç¬¦å·é“¾æ¥çš„è·¯å¾„ã€‚ï¼ˆé˜²å¾¡ä½äº†å‰é¢ææ¡ˆèƒŒæ™¯æåˆ°çš„æ”»å‡»èŒƒå›´ï¼‰\næˆ‘ä»¬ç”¨Go1.24 çš„æ–¹å¼ä¿®æ”¹ä»£ç \n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 func main() { fileName := os.Args[1] root, err := os.OpenRoot(\u0026#34;.\u0026#34;) if err != nil { panic(err) } file, err := root.Open(fileName) if err != nil { fmt.Println(fmt.Sprintf(\u0026#34;Error opening file %s: %s\\n\u0026#34;, fileName, err.Error())) return } content := make([]byte, 1024) c, err := file.Read(content) if err != nil { panic(err) } content = content[:c] fmt.Printf(\u0026#34;File %s opened successfully. file content %s\\n\u0026#34;, fileName, content) } å†æ¬¡è¿è¡Œ\n1 2 3 4 5 âœ os_root git:(main) âœ— gotip version go version devel go1.24-fafd447 Wed Dec 11 15:57:34 2024 -0800 darwin/arm64 âœ os_root git:(main) âœ— gotip build -o go1.24 main.go âœ os_root git:(main) âœ— ./go1.24 ../../../../../../../../../tmp/password Error opening file ../../../../../../../../../tmp/password: openat ../../../../../../../../../tmp/password: path escapes from parent å¦‚æœæ–‡ä»¶å¤¹è„±ç¦»äº†parent å±‚çº§ï¼Œå°±ä¼šæŠ¥é”™ã€‚\næ›´å¤šçš„APiæ¥å£è¯·å‚è€ƒå®˜æ–¹æ–‡æ¡£ ã€‚1.24æ­£å¼å‘å¸ƒåï¼Œä¼°è®¡å¾ˆå¤šç¬¬ä¸‰æ–¹åº“éƒ½ä¼šç¬¬ä¸€æ—¶é—´é€‚é…æŠŠï¼Œæ¯•ç«Ÿå…¶ä»–è¯­è¨€åŸºæœ¬ä¸Šéƒ½æœ‰è¿™ç§åŠŸèƒ½äº†ã€‚\n","date":"2024-12-10T19:23:31+08:00","permalink":"https://huizhou92.com/zh-cn/p/go1.24-%E6%96%B0%E7%9A%84%E6%A0%87%E5%87%86%E5%BA%93-os.root/","title":"go1.24: æ–°çš„æ ‡å‡†åº“ os.Root"},{"content":"bigcacheæ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„å†…å­˜ç¼“å­˜åº“ï¼Œä¸“ä¸ºéœ€è¦é«˜å¹¶å‘è®¿é—®å’Œä½å»¶è¿Ÿå“åº”çš„åº”ç”¨åœºæ™¯è®¾è®¡ã€‚æœ¬æ–‡å°†æ·±å…¥æ¢è®¨ BigCache çš„æ€§èƒ½ä¼˜åŒ–æ‰‹æ®µï¼ŒåŒ…æ‹¬åˆ†ç‰‡æœºåˆ¶ã€é«˜æ•ˆå“ˆå¸Œç®—æ³•ã€è¯»å†™é”çš„ä½¿ç”¨ç­‰ï¼Œå¹¶å¼•ç”¨ç›¸å…³æºç è¿›è¡Œè¯¦ç»†è¯´æ˜ã€‚\nåˆ†æ®µåŠ é” ä»ä½¿ç”¨è€…çš„è§’åº¦æ¥çœ‹cacheå°±åƒä¸€ä¸ªå¤§çš„hashtable,å¯ä»¥å­˜å‚¨k/vÂ æ ¼å¼çš„æ•°æ®ã€‚ é‚£ä¹ˆï¼Œæ˜¯ä¸æ˜¯å¯ä»¥ä½¿ç”¨ä¸€ä¸ªmap[string][]byteÂ +Â sync.RWMutexÂ å®ç°æ»¡è¶³éœ€æ±‚çš„cacheå‘¢ï¼Ÿ\nå¦‚æœæ€§èƒ½è¦æ±‚ä¸é«˜ï¼Œçš„ç¡®å¯ä»¥è¿™ä¹ˆåšã€‚\nsync.RWMutexè™½ç„¶å¯¹è¯»å†™è¿›è¡Œäº†ä¼˜åŒ–ï¼Œä½†æ˜¯å¯¹äºå¹¶å‘çš„è¯»ï¼Œæœ€ç»ˆè¿˜æ˜¯æŠŠå†™å˜æˆäº†ä¸²è¡Œï¼Œä¸€æ—¦å†™çš„å¹¶å‘é‡å¤§çš„æ—¶å€™ï¼Œå³ä½¿å†™ä¸åŒçš„key, å¯¹åº”çš„goroutineä¹Ÿä¼šblockï¼Œåªå…è®¸ä¸€ä¸ªå†™æ‰§è¡Œï¼Œè¿™æ˜¯ä¸€ä¸ªç“¶é¢ˆï¼Œå¹¶ä¸”ä¸å¯æ§ã€‚\nbigcacheÂ å‚è€ƒäº† javaÂ ConcurrentMapÂ çš„å®ç°æ–¹å¼ï¼Œå°†ä¸€ä¸ªå¤§hashtableÂ åˆ†æˆå¤šä¸ªå°çš„ shardï¼Œæ¯ä¸ªåˆ†ç‰‡ä¸€æŠŠé”ï¼Œå¾ˆå¤šå¤§å¹¶å‘åœºæ™¯ä¸‹ä¸ºäº†å‡å°å¹¶å‘çš„å‹åŠ›éƒ½ä¼šé‡‡ç”¨è¿™ç§æ–¹æ³•ï¼Œæ¯”å¦‚MongoDBçš„shardingç­‰ã€‚Golangä¹Ÿæœ‰ä¸€ä¸ªç¬¬ä¸‰æ–¹çš„Â ConcurrentMapÂ å®ç°Â concurrent-mapã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 // https://github.com/allegro/bigcache/blob/a2f05d7cbfdc7000a8b7e1c40f27d3f239c204df/bigcache.go#L58 type BigCache struct { shards []*cacheShard shardMask uint64 config Config } func newBigCache(ctx context.Context, config Config, clock clock) (*BigCache, error) { ...... cache := \u0026amp;BigCache{ shards: make([]*cacheShard, config.Shards), lifeWindow: lifeWindowSeconds, clock: clock, hash: config.Hasher, config: config, shardMask: uint64(config.Shards - 1), close: make(chan struct{}), } ...... for i := 0; i \u0026lt; config.Shards; i++ { cache.shards[i] = initNewShard(config, onRemove, clock) } ...... return cache, nil } å¯¹äºæ¯ä¸€ä¸ªç¼“å­˜å¯¹è±¡ï¼Œæ ¹æ®å®ƒçš„keyè®¡ç®—å®ƒçš„å“ˆå¸Œå€¼:Â hash(key) % Nã€‚ ç†æƒ³æƒ…å†µä¸‹Nä¸ªÂ goroutineÂ æ¯æ¬¡è¯·æ±‚æ­£å¥½å¹³å‡è½åœ¨å„è‡ªçš„shardä¸Šï¼Œè¿™æ ·å°±ä¸ä¼šæœ‰é”ç«äº‰äº†ã€‚å³ä½¿æœ‰å¤šä¸ªgoroutineåŒæ—¶è¯·æ±‚ï¼Œå¦‚æœhashæ¯”è¾ƒå¹³å‡çš„è¯ï¼Œå•ä¸ªshardçš„å‹åŠ›ä¹Ÿä¼šæ¯”è¾ƒå°ã€‚å¯ä»¥é™ä½å»¶è¿Ÿï¼Œå› ä¸ºç­‰å¾…è·å–é”çš„æ—¶é—´å˜å°äº†ã€‚Â Nçš„é€‰æ‹© æ—¢ç„¶åˆ†ç‰‡å¯ä»¥å¾ˆå¥½çš„é™ä½é”çš„ç«äº‰ï¼Œé‚£ä¹ˆNæ˜¯ä¸æ˜¯è¶Šå¤§è¶Šå¥½å‘¢ï¼Ÿå½“ç„¶ä¸æ˜¯ï¼Œå¦‚æœNéå¸¸å¤§ï¼Œæ¯”å¦‚æ¯ä¸ªç¼“å­˜å¯¹è±¡ä¸€ä¸ªé”ï¼Œé‚£ä¹ˆä¼šå¸¦æ¥å¾ˆå¤šé¢å¤–çš„ä¸å¿…è¦çš„å¼€é”€ã€‚å¯ä»¥é€‰æ‹©ä¸€ä¸ªä¸å¤ªå¤§çš„å€¼ï¼Œåœ¨æ€§èƒ½å’ŒèŠ±é”€ä¸Šå¯»æ‰¾ä¸€ä¸ªå¹³è¡¡ã€‚\nå¦å¤–,Â Næ˜¯ 2çš„å¹‚ï¼Œ æ¯”å¦‚16ã€32ã€64ã€‚è¿™æ ·è®¾è®¡çš„å¥½å¤„å°±æ˜¯è®¡ç®—ä½™æ•°å¯ä»¥ä½¿ç”¨ä½è¿ç®—å¿«é€Ÿè®¡ç®—ã€‚\n1 2 3 4 // https://github.com/allegro/bigcache/blob/a2f05d7cbfdc7000a8b7e1c40f27d3f239c204df/bigcache.go#L253 func (c *BigCache) getShard(hashedKey uint64) (shard *cacheShard) { return c.shards[hashedKey\u0026amp;c.shardMask] } å› ä¸ºå¯¹äº 2 çš„å¹‚Nï¼Œå¯¹äºä»»æ„çš„x, ä¸‹é¢çš„å…¬å¼æˆç«‹:\nx mod N = (x \u0026amp; (N âˆ’ 1))\næ‰€ä»¥åªéœ€è¦ä½¿ç”¨ä¸€æ¬¡æŒ‰ä½ AND (\u0026amp;) å°±å¯ä»¥æ±‚å¾—å®ƒçš„ä½™æ•°ã€‚\né€‰æ‹©åˆé€‚çš„ hash ç®—æ³• è®¡ç®—æœºç§‘å­¦å®¶å·²ç»å‘æ˜äº†å¾ˆå¤šçš„Hashç®—æ³•ï¼Œgopherä¹Ÿå®ç°äº†å¾ˆå¤šHashç®—æ³•ã€‚ä¸€ä¸ªä¼˜ç§€çš„Hashç®—æ³•æœ‰ä»¥ä¸‹ç‰¹ç‚¹\nå“ˆå¸Œå€¼åº”è¯¥æ¯”è¾ƒéšæœº (è´¨é‡) å“ˆå¸Œé€Ÿåº¦æ¯”è¾ƒå¿« (é€Ÿåº¦) å°½é‡ä¸äº§ç”Ÿé¢å¤–çš„å†…å­˜åˆ†é…, é¿å…å¯¹åƒåœ¾å›æ”¶äº§ç”Ÿå‹åŠ› (è€—è´¹èµ„æºå°‘) bigcacheÂ æä¾›äº†ä¸€ä¸ªé»˜è®¤çš„Â Hashç®—æ³•çš„å®ç°ï¼Œé‡‡ç”¨Â fnv64aÂ ç®—æ³•ã€‚è¿™ä¸ªç®—æ³•çš„å¥½å¤„æ˜¯é‡‡ç”¨ä½è¿ç®—çš„æ–¹å¼åœ¨æ ˆä¸Šè¿›è¡Œè¿ç®—ï¼Œé¿å…åœ¨å †ä¸Šåˆ†é…ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 type fnv64a struct{} const ( offset64 = 14695981039346656037 prime64 = 1099511628211 ) func (f fnv64a) Sum64(key string) uint64 { var hash uint64 = offset64 for i := 0; i \u0026lt; len(key); i++ { hash ^= uint64(key[i]) hash *= prime64 } return hash } å†…å­˜ä¼˜åŒ– å¯¹äº Go è¯­è¨€ä¸­çš„ map, åƒåœ¾å›æ”¶å™¨åœ¨Â markå’Œscané˜¶æ®µæ£€æŸ¥ map ä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ , å¦‚æœç¼“å­˜ä¸­åŒ…å«æ•°ç™¾ä¸‡çš„ç¼“å­˜å¯¹è±¡ï¼Œåƒåœ¾å›æ”¶å™¨å¯¹è¿™äº›å¯¹è±¡æ— æ„ä¹‰çš„æ£€æŸ¥å¯¼è‡´ä¸å¿…è¦çš„æ—¶é—´å¼€é”€ã€‚\nä½œè€…åšäº†æµ‹è¯•ã€‚ä»–ä»¬æµ‹è¯•äº†ç®€å•çš„ HTTP/JSON åºåˆ—åŒ– (ä¸ä¼šè®¿é—® cache)ã€‚ åœ¨ cache ä¸ºç©ºçš„æ—¶å€™ 1 ä¸‡çš„ QPS çš„è€—æ—¶å¤§çº¦ 10 æ¯«ç§’ã€‚å½“ cache å¡«æ»¡çš„æ—¶å€™ï¼Œ P99 çš„è¯·æ±‚éƒ½ä¼šè¶…è¿‡ 1 ç§’ã€‚ç›‘æ§æ˜¾ç¤ºå †ä¸­åŒ…å« 4 åƒä¸‡çš„å¯¹è±¡ï¼Œ GC è¿‡ç¨‹ä¸­çš„Â markÂ å’ŒÂ scanÂ ä¹Ÿéœ€è¦ 4 ç§’ã€‚\né‚£æ˜¯å› ä¸ºå¦‚æœhashtableä¸­çš„å…ƒç´ åŒ…å«æŒ‡é’ˆï¼Œé‚£ä¹ˆGCåœ¨markä¼šæ‰«ææ¯ä¸ªåŒ…å«æŒ‡é’ˆçš„å…ƒç´ ï¼Œå¦‚æœä¸åŒ…å«æŒ‡é’ˆï¼Œåœ¨marké˜¶æ®µå°±ä¼šè·³è¿‡è¿™äº›å…ƒç´ ã€‚\næˆ‘ä»¬å¯ä»¥ç”¨ä¸€ä¸ªç®€å•çš„ä¾‹å­æµ‹è¯•ä¸€ä¸‹ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 var pointMap map[int]*int var noPointMap map[int]int func BenchmarkPointMap(b *testing.B) { pointMap = make(map[int]*int) for i := 0; i \u0026lt; 10e6; i++ { pointMap[i] = \u0026amp;i } b.ResetTimer() for i := 0; i \u0026lt; b.N; i++ { delete(pointMap, i) pointMap[i] = \u0026amp;i } } func BenchmarkNoPointMap(b *testing.B) { noPointMap = make(map[int]int) for i := 0; i \u0026lt; 10e6; i++ { noPointMap[i] = i } b.ResetTimer() for i := 0; i \u0026lt; b.N; i++ { delete(noPointMap, i) noPointMap[i] = i } } æµ‹è¯•ç»“æœå¦‚ä¸‹\n1 2 3 4 5 6 7 âœ gc git:(main) âœ— GOMAXPROCS=1 go test --bench=. goos: darwin goarch: arm64 pkg: blog-example/go/gc cpu: Apple M1 Pro BenchmarkPointMap 5273188 209.4 ns/op BenchmarkNoPointMap 7037848 178.5 ns/op ç„¶ååˆ†åˆ«è¿è¡Œä¸¤ä¸ªæµ‹è¯•ï¼Œåˆ†æ gc\n1 2 go test -bench=BenchmarkPointMap -trace trace_point.out go test -bench=BenchmarkNoPointMap -trace trace_no_point.out NoPointMapÂ çš„Â Wall DurationÂ åªæœ‰PointMapÂ çš„2% ã€‚è™½ç„¶PointMapÂ çš„å¹¶å‘é‡å¾ˆå°ï¼Œå¹¶ä¸”å•ä¸ªçš„ goroutineä¹Ÿæ²¡æœ‰ç«äº‰ï¼Œä½†æ˜¯ç”±äºå…ƒç´ çš„æ•°é‡å¾ˆå¤šï¼Œåƒåœ¾å›æ”¶åœ¨mark/scané˜¶æ®µéœ€è¦èŠ±è´¹ä¸Šç™¾æ¯«ç§’è¿›è¡Œæ ‡è®°å’Œéå†ã€‚\nbigcacheÂ æ˜¯å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜çš„ï¼Ÿç¦æ­¢ä½ çš„ç”¨æˆ·åœ¨Â bigcacheÂ ä¸Šå­˜å‚¨å¸¦æœ‰æŒ‡é’ˆçš„æ•°æ®ã€‚\nå¼€ä¸ªç©ç¬‘ï¼Œå¦‚æœçœŸçš„è¿™ä¹ˆåšï¼Œä½ çš„ç”¨æˆ·ä¼šæŠ›å¼ƒä½ ã€‚æœ‰å‡ ç§åŠæ³•å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚\nå‚è€ƒÂ offheapï¼Œä½¿ç”¨å®šåˆ¶åŒ–çš„Malloc()Â å’ŒÂ Free()Â æ¥æ‰‹åŠ¨ç®¡ç†å†…å­˜ï¼Œè€Œç»•è¿‡runtimeÂ åƒåœ¾å›æ”¶ï¼Œä½†æ˜¯è¿™æ ·ä¼šæ¯”è¾ƒå®¹æ˜“å¯¼è‡´å†…å­˜æ³„éœ²ã€‚ ç¬¬äºŒç§æ–¹å¼æ˜¯ä½¿ç”¨Â freecacheã€‚freecache é€šè¿‡å‡å°‘æŒ‡é’ˆçš„æ•°é‡ä»¥é›¶ GC å¼€é”€å®ç° mapã€‚å®ƒå°†é”®å’Œå€¼ä¿å­˜åœ¨ringbufferä¸­ï¼Œå¹¶ä½¿ç”¨ç´¢å¼•æŸ¥æ‰¾å¯¹è±¡ã€‚ bigcacheÂ å®ç°çš„æ–¹å¼æ˜¯ä½¿ç”¨å“ˆå¸Œå€¼ä½œä¸ºmap[int]intçš„ keyã€‚ æŠŠç¼“å­˜å¯¹è±¡åºåˆ—åŒ–åæ”¾åˆ°ä¸€ä¸ªé¢„å…ˆåˆ†é…çš„å¤§çš„å­—èŠ‚æ•°ç»„ä¸­ï¼Œç„¶åå°†å®ƒåœ¨æ•°ç»„ä¸­çš„ offset ä½œä¸ºmap[int]intçš„ valueã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 //https://github.com/allegro/bigcache/blob/a2f05d7cbfdc7000a8b7e1c40f27d3f239c204df/shard.go#L18 type cacheShard struct { hashmap map[uint64]uint32 entries queue.BytesQueue lock sync.RWMutex entryBuffer []byte onRemove onRemoveCallback isVerbose bool statsEnabled bool logger Logger clock clock lifeWindow uint64 hashmapStats map[uint64]uint32 stats Stats } func (s *cacheShard) set(key string, hashedKey uint64, entry []byte) error { currentTimestamp := uint64(s.clock.Epoch()) s.lock.Lock() if previousIndex := s.hashmap[hashedKey]; previousIndex != 0 { // æ£€æŸ¥æ˜¯å¦å­˜åœ¨ç›¸åŒå“ˆå¸Œé”®çš„æ—§æ¡ç›® if previousEntry, err := s.entries.Get(int(previousIndex)); err == nil { resetHashFromEntry(previousEntry) // é‡ç½®æ—§æ¡ç›®çš„å“ˆå¸Œ delete(s.hashmap, hashedKey) // ä»å“ˆå¸Œè¡¨ä¸­åˆ é™¤æ—§æ¡ç›® } } if !s.cleanEnabled { // å¦‚æœæ¸…ç†åŠŸèƒ½æœªå¯ç”¨ if oldestEntry, err := s.entries.Peek(); err == nil { s.onEvict(oldestEntry, currentTimestamp, s.removeOldestEntry) // å¤„ç†æœ€æ—§çš„æ¡ç›® } } w := wrapEntry(currentTimestamp, hashedKey, key, entry, \u0026amp;s.entryBuffer) for { if index, err := s.entries.Push(w); err == nil { // å°è¯•å°†æ–°æ¡ç›®æ¨å…¥é˜Ÿåˆ— s.hashmap[hashedKey] = uint64(index) // æ›´æ–°å“ˆå¸Œè¡¨ s.lock.Unlock() return nil } if s.removeOldestEntry(NoSpace) != nil { // å¦‚æœç©ºé—´ä¸è¶³ï¼Œåˆ é™¤æœ€æ—§çš„æ¡ç›® s.lock.Unlock() return errors.New(\u0026#34;entry is bigger than max shard size\u0026#34;) // è¿”å›é”™è¯¯ } } } func (s *cacheShard) getValidWrapEntry(key string, hashedKey uint64) ([]byte, error) { wrappedEntry, err := s.getWrappedEntry(hashedKey) if err != nil { return nil, err } if !compareKeyFromEntry(wrappedEntry, key) { s.collision() if s.isVerbose { s.logger.Printf(\u0026#34;Collision detected. Both %q and %q have the same hash %x\u0026#34;, key, readKeyFromEntry(wrappedEntry), hashedKey) } return nil, ErrEntryNotFound } s.hitWithoutLock(hashedKey) return wrappedEntry, nil } queue.BytesQueueæ˜¯ä¸€ä¸ªå­—èŠ‚æ•°ç»„ï¼ŒæŒ‰éœ€åˆ†é…ã€‚å½“åŠ å…¥ä¸€ä¸ª[]byteæ—¶ï¼Œå®ƒä¼šæŠŠæ•°æ® copy åˆ°å°¾éƒ¨ã€‚\nbigcacheÂ åœ¨åˆ é™¤ç¼“å­˜å…ƒç´ çš„æ—¶å€™ï¼Œ åªæ˜¯æŠŠå®ƒä»çš„ç´¢å¼•ä»map[uint64]uint32ä¸­åˆ é™¤äº†ï¼Œå¹¶æŠŠå®ƒåœ¨queue.BytesQueueé˜Ÿåˆ—ä¸­çš„æ•°æ®ç½®ä¸º0ã€‚åˆ é™¤æ“ä½œä¼šåœ¨Â queue.BytesQueueä¸­é€ æˆå¾ˆå¤šçš„ â€œç©ºæ´â€ï¼Œè€Œä¸”è¿™äº› \u0026ldquo;è™«æ´\u0026rdquo; ä¸ä¼šè¢«æ•´ç†ï¼Œä¹Ÿä¸ä¼šè¢«ç§»é™¤ã€‚å› ä¸ºå®ƒçš„åº•å±‚æ˜¯ä½¿ç”¨ä¸€ä¸ªå­—èŠ‚æ•°ç»„å®ç°çš„ï¼Œ\u0026ldquo;ç©ºæ´\u0026rdquo; çš„ç§»é™¤æ˜¯ä¸€ä¸ªè€—æ—¶çš„æ“ä½œï¼Œä¼šå¯¼è‡´é”çš„æŒæœ‰æ—¶é—´è¿‡é•¿ã€‚bigcacheÂ åªèƒ½ç­‰å¾…æ¸…ç†æœºåˆ¶æŠŠè¿™äº› \u0026ldquo;ç©ºæ´\u0026rdquo; åˆ é™¤æ‰ã€‚\nå…¶ä»–ä¸€äº›ç»†èŠ‚ï¼šÂ bigcacheÂ ä¸­çš„ç¼“å­˜å¯¹è±¡æ²¡æœ‰åˆ·æ–°è¿‡æœŸæ—¶é—´çš„åŠŸèƒ½ï¼Œæ‰€æœ‰çš„ç¼“å­˜æœ€ç»ˆéƒ½ä¼šè¿‡æœŸã€‚ æ‰€æœ‰ç¼“å­˜çš„ç”Ÿå‘½å‘¨æœŸéƒ½æ˜¯ç”±config.LifeWindowÂ é…ç½®ï¼Œä¸èƒ½é’ˆå¯¹å•ç‹¬çš„keyè®¾ç½®ã€‚ ","date":"2024-12-04T21:42:56+08:00","image":"https://images.hxzhouh.com/blog-images/2024/12/d1288ea91074f2a22a8ac4fec04d8b90.png","permalink":"https://huizhou92.com/zh-cn/p/%E6%B7%B1%E5%85%A5%E6%8E%A2%E8%AE%A8-bigcache-%E7%9A%84%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E6%89%8B%E6%AE%B5/","title":"æ·±å…¥æ¢è®¨ BigCache çš„æ€§èƒ½ä¼˜åŒ–æ‰‹æ®µ"},{"content":"Ben Dicken (@BenjDicken) åšäº†ä¸€é¡¹æµ‹è¯•ï¼Œæ‰§è¡ŒåŒå±‚å¾ªç¯ï¼Œ 1 ä¸‡ * 10 ä¸‡= 10 äº¿æ¬¡å¾ªç¯ï¼Œçœ‹çœ‹å“ªç§ç¼–ç¨‹è¯­è¨€å¿«ã€‚ä¸ºæ­¤è¿˜åˆ¶ä½œäº†ä¸€ä¸ªåŠ¨å›¾æ¥ç›´è§‚å±•ç¤ºã€‚\n![[iWkHAGyRUf1bKIW6.gif]]\nä¸€èˆ¬æ¥è¯´ï¼Œè¿™ç§é¡¹ç›®ï¼Œæœ€ç²¾å½©çš„æ˜¯issueã€‚\nçƒ­å¿ƒçš„å¼€å‘è€…è´¡çŒ®äº†å„ç§è¯­è¨€çš„ç‰ˆæœ¬ï¼Œæ¯”å¦‚Zigã€Juliaã€Perlã€Elixirã€Fortanã€C#ã€Luaç­‰\nåŒæ—¶ï¼Œè¿˜åœ¨è®¨è®ºåº”è¯¥æ€æ ·ä¼˜åŒ–ä»£ç \næ¯”å¦‚ @dolanor æäº†ä¸€ä¸ªPR # optimize go loops with goroutine è®¤ä¸ºGolangçš„é•¿å¤„æ˜¯åœ¨å¹¶å‘ç¼–ç¨‹ï¼Œå•çº¿ç¨‹ä¸‹å®ƒçš„æ•ˆç‡è‚¯å®šæ¯”ä¸ä¸ŠCã€Rustï¼Œåº”è¯¥ç”¨goroutineæ¥ä¼˜åŒ–ã€‚\n@Brandon-T åœ¨ # Benchmark Issues è®¨è®ºäº†ç°æœ‰åŸºå‡†æµ‹è¯•å­˜åœ¨çš„é—®é¢˜åŠæ”¹è¿›æ–¹å‘ï¼Œæ ¸å¿ƒè§‚ç‚¹ä¸ºæµ‹è¯•ä¸åº”åŒ…å«ç¨‹åºå¯åŠ¨ã€æ‰“å°ç­‰æ— å…³æ—¶é—´ï¼Œåº”èšç„¦ä»£ç æ‰§è¡Œæœ¬èº«ã€‚\nä¸çŸ¥ä¸è§‰æˆ‘å‡ ä¹æŠŠæ•´ä¸ªissueå…¨éƒ¨çœ‹å®Œäº†ã€‚\nè¿™ä¸ªé¡¹ç›®è®©æˆ‘æƒ³åˆ°äº†å¹´åˆçš„1BRCã€‚åœ¨æ¯ç‡¥çš„ç¼–ç ç”Ÿæ´»ä¸­ï¼Œè¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„æ¶ˆé£ã€‚åŒæ—¶èƒ½å¤Ÿå­¦ä¹ ä¸€äº›æ€§èƒ½ä¼˜åŒ–çš„æŠ€å·§ï¼Œå‚ä¸åˆ°ä¸ä¸–ç•Œå„åœ°çš„äººçš„è®¨è®ºä¸­æ¥ã€‚\næˆ‘å¸Œæœ›è¿™æ ·çš„æ´»åŠ¨èƒ½å¤Ÿå¤šä¸€ç‚¹ã€‚\n","date":"2024-12-04T19:20:16+08:00","permalink":"https://huizhou92.com/zh-cn/p/%E9%82%A3%E4%B8%AA%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80%E6%89%8D%E6%98%AF%E6%9C%80%E5%BF%AB%E7%9A%84/","title":"é‚£ä¸ªç¼–ç¨‹è¯­è¨€æ‰æ˜¯æœ€å¿«çš„ï¼Ÿ"},{"content":"\u0026ldquo;å› ä¸ºTCPç«¯å£å·æ˜¯16ä½æ— ç¬¦å·æ•´æ•°ï¼Œæœ€å¤§65535ï¼Œæ‰€ä»¥ä¸€å°æœåŠ¡å™¨æœ€å¤šæ”¯æŒ65536ä¸ªTCP socketè¿æ¥.\u0026rdquo; è¿™æ˜¯ä¸€ä¸ªéå¸¸ç»å…¸çš„è¯¯è§£! å³ä½¿æ˜¯æœ‰å¤šå¹´ç½‘ç»œç¼–ç¨‹ç»éªŒçš„äºº,ä¹Ÿä¼šæŒæœ‰è¿™ä¸ªé”™è¯¯ç»“è®ºã€‚\nå…¶ä¸­0-1023 ç«¯å£æ˜¯ç³»ç»Ÿä¿ç•™çš„ç«¯å£ï¼Œå¹¶ä¸èƒ½è¢«æ™®é€šåº”ç”¨ç¨‹åºæ‰€ä½¿ç”¨ï¼Œè¿™é‡Œæš‚æ—¶ä¸è€ƒè™‘è¿™ä¸ªæƒ…å†µ.è€Œæ˜¯ä»¥65535 ä»£æ›¿ã€‚\nè¦æˆ³ç ´è¿™ä¸ªé”™è¯¯ç»“è®ºï¼Œå¯ä»¥ä»ç†è®ºå’Œå®è·µä¸¤æ–¹é¢æ¥ã€‚\nç†è®º *unix ç³»ç»Ÿé€šè¿‡ä¸€ä¸ªå››å…ƒç»„æ¥å”¯ä¸€æ ‡è¯†ä¸€æ¡TCPè¿æ¥. è¿™ä¸ªå››å…ƒç»„çš„ç»“æ„æ˜¯{local_ip, local_port, remote_ip, remote_port}ã€‚æ‰€ä»¥ï¼Œå¯¹äºIPv4, ç³»ç»Ÿç†è®ºä¸Šæœ€å¤šå¯ä»¥ç®¡ç†2^(32+16+32+16),ä¹Ÿå°±æ˜¯2çš„96æ¬¡æ–¹ä¸ªè¿æ¥ã€‚\nIPv4 å¯ä»¥ç†è§£æˆä¸€ä¸ª 32ä½æ­£æ•°\nå› ä¸ºå¯¹äºåŒä¸€å°æœåŠ¡å™¨æ¥è¯´ï¼Œä¸€èˆ¬åªæœ‰ä¸€ä¸ª local_ipï¼Œé‚£ä¹ˆåŒä¸€å°æœåŠ¡å™¨å¯ä»¥ç®¡ç† 2^(16+32+16) ä¸ªè¿æ¥ã€‚ ä¸€ä¸ªæœåŠ¡(è¿›ç¨‹, å¦‚ Nginx è¿›ç¨‹)ä¸€èˆ¬åªç›‘å¬ä¸€ä¸ª local_portï¼Œé‚£ä¹ˆåŒä¸€å°æœåŠ¡å°±å¯ä»¥ç®¡ç† 2^(32+16) ä¸ªè¿æ¥ã€‚ å¦‚æœä»ä¸€å°è¿œç«¯æœºå™¨(æ‰€è°“çš„ client)æ¥è¿æ¥è¿™å°æœåŠ¡å™¨ä¸Šçš„ä¸€ä¸ªæœåŠ¡ï¼Œé‚£ä¹ˆ local_ipï¼Œlocal_portï¼Œremote_ip è¿™3ä¸ªå˜é‡æ˜¯å›ºå®šçš„ï¼Œé‚£ä¹ˆå°±åªèƒ½å»ºç«‹ 2^16=65536 ä¸ªè¿æ¥äº†ã€‚è¿™å°±æ˜¯ç»å…¸çš„è¯¯è§£çš„æ¥æºï¼ å¦‚æœä¸ä»…ä»…è€ƒè™‘TCPï¼Œåˆ™æ˜¯ä¸€ä¸ªäº”å…ƒç»„ï¼ŒåŠ ä¸Šåè®®å·(TCPï¼ŒUDPæˆ–è€…å…¶å®ƒ)ã€‚æ‰€ä»¥ä¸€ä¸ªæœåŠ¡å™¨æœ€å¤šèƒ½æ”¯æŒå¤šå°‘ä¸ªTCPè¿æ¥ï¼Œå®ƒçš„é™åˆ¶ä¸åœ¨äºå››å…ƒç»„ï¼Œè€Œæ˜¯å…¶ä»–å‚æ•°ã€‚\næ–‡ä»¶æè¿°ç¬¦ æˆ‘ä»¬çŸ¥é“åœ¨Linuxä¸­ä¸€åˆ‡éƒ½æ˜¯æ–‡ä»¶ï¼ˆsocketä¹Ÿæ˜¯æ–‡ä»¶ï¼‰ï¼Œæœ€å¤§èƒ½æ‰“å¼€çš„æ–‡ä»¶æ•°é‡ï¼Œå†³å®šäº†èƒ½å¤ŸåŒæ—¶å»ºç«‹TCPè¿æ¥çš„æ•°é‡ï¼Œé‚£ä¹ˆä¸€å°æœåŠ¡å™¨æœ€å¤§èƒ½æ‰“å¼€å¤šå°‘ä¸ªæ–‡ä»¶å‘¢ï¼Ÿ\næŸ¥çœ‹ç³»ç»Ÿæ”¯æŒçš„æœ€å¤§æ‰“å¼€æ–‡ä»¶æè¿°ç¬¦æ•°ï¼Œ 1 2 [root@test1 ~]# cat /proc/sys/fs/file-max 1616352 å•ä¸ªè¿›ç¨‹èƒ½æ‰“å¼€çš„æœ€å¤§æ–‡ä»¶æè¿°ç¬¦æ•°é‡ 1 2 [root@test1 ~]# ulimit -n 1024 è¿™ä¸¤ä¸ªå€¼éƒ½æ˜¯å¯ä»¥æ”¹å˜çš„ï¼Œä¸€èˆ¬åœ¨è¿›è¡Œå‹åŠ›æµ‹è¯•çš„æ—¶å€™ï¼Œä¼šæ‰‹åŠ¨è°ƒæ•´è¿™ä¸ªå€¼ã€‚\nip_local_port_range å¦‚æœæŸä¸ªå®¢æˆ·ç«¯å‘åŒä¸€ä¸ªTCPç«¯ç‚¹(ip:port)å‘èµ·ä¸»åŠ¨è¿æ¥ï¼Œé‚£ä¹ˆæ¯ä¸€æ¡è¿æ¥éƒ½å¿…é¡»ä½¿ç”¨ä¸åŒçš„æœ¬åœ°TCPç«¯ç‚¹ï¼Œå¦‚æœå®¢æˆ·ç«¯åªæœ‰ä¸€ä¸ªIPåˆ™æ˜¯ä½¿ç”¨ä¸åŒçš„æœ¬åœ°ç«¯å£ï¼Œè¯¥ç«¯å£çš„èŒƒå›´åœ¨*nixç³»ç»Ÿä¸Šçš„ä¸€ä¸ªä¾‹å­æ˜¯32768åˆ°61000å·¦å³ï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤æŸ¥çœ‹ï¼š\n1 2 [root@test1 ~]# cat /proc/sys/net/ipv4/ip_local_port_range 32768\t60999 ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€ä¸ªå®¢æˆ·ç«¯è¿æ¥åŒä¸€ä¸ªæœåŠ¡å™¨çš„åŒä¸€ä¸ªip:port(æ¯”å¦‚è¿›è¡Œå‹åŠ›æµ‹è¯•)ï¼Œæœ€å¤šå¯ä»¥å‘èµ·30000ä¸ªå·¦å³çš„è¿æ¥ã€‚ä¸è¿‡ï¼Œå¯¹äºclientç«¯ï¼Œæ“ä½œç³»ç»Ÿä¼šè‡ªåŠ¨æ ¹æ®ä¸åŒçš„è¿œç«¯ ip:portï¼Œå†³å®šæ˜¯å¦é‡ç”¨æœ¬åœ°ç«¯å£ã€‚\nå†…å­˜\u0026amp;CPU ä¸€ä¸ªESTABLISHçŠ¶æ€çš„socketå¤§çº¦æ¶ˆè€—3.3KBå†…å­˜ï¼Œå¦‚æœæ²¡æœ‰æ•°æ®ä¸šåŠ¡çš„è¯CPUå ç”¨å¾ˆä½ã€‚æ‰€ä»¥ä»å†…å­˜è§’åº¦æ¥çœ‹ï¼Œä¸€å°æœåŠ¡å™¨èƒ½æ”¯æŒçš„æœ€å¤§TCP è¿æ¥æ•°é‡ä¹Ÿæ˜¯æœ‰ä¸Šçº¿çš„ï¼Œè¿œè¿œåˆ°ä¸äº†4å…ƒç»„çš„ä¸Šé™ã€‚\næ€»ç»“ ä¸€å°æœåŠ¡å™¨æœ€å¤§èƒ½æ”¯æŒå¤šå°‘æ¡ TCP è¿æ¥çš„ä¸Šé™æ˜¯ç¡®å®šçš„ï¼Œé‚£å°±æ˜¯2^96 ä¸ªï¼Œä½†æ˜¯å®ƒçš„ä¸‹é™ï¼Œéœ€è¦æ ¹æ®å¾ˆå¤šæƒ…å†µæ¥åˆ¤æ–­ï¼Œæ¯”å¦‚å†…å­˜ã€CPUã€æ–‡ä»¶æè¿°ç¬¦ç­‰ã€‚æ²¡æœ‰å…·ä½“ç­”æ¡ˆã€‚\n","date":"2024-12-02T15:50:14+08:00","image":"https://images.hxzhouh.com/blog-images/2024/12/5a04e98368531b4e0208f40a907399f0.png","permalink":"https://huizhou92.com/zh-cn/p/linux%E4%B8%80%E5%8F%B0%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%9C%80%E5%A4%A7%E8%83%BD%E6%94%AF%E6%8C%81%E5%A4%9A%E5%B0%91%E6%9D%A1-tcp-%E8%BF%9E%E6%8E%A5/","title":"linuxï¼šä¸€å°æœåŠ¡å™¨æœ€å¤§èƒ½æ”¯æŒå¤šå°‘æ¡ TCP è¿æ¥"},{"content":"æœ€è¿‘æƒ³è¦ç³»ç»Ÿçš„å­¦ä¹ ä¸€ä¸‹åŸºç¡€è®¾æ–½æ–¹é¢çš„çŸ¥è¯†ï¼Œæ‰€ä»¥å‡†å¤‡æ­å»ºä¸€ä¸ªå­¦ä¹ ç¯å¢ƒï¼Œæˆ‘æ²¡æœ‰å¤šä½™çš„æœºå™¨ä½¿ç”¨ï¼Œåªæœ‰ä¸€ä¸ªMacBook Pro 2021 ï¼Œæ‰€ä»¥é€‰æ‹©åœ¨ç¬”è®°æœ¬ä¸Šä½¿ç”¨ Docker æ­å»ºä¸€å¥—ç¯å¢ƒï¼Œç›®å‰çœ‹æ¥ç¬¬ä¸€æ­¥è¿˜æ˜¯é¡ºåˆ©çš„ã€‚\nå®‰è£… GitLab Mac çš„M1èŠ¯ç‰‡ä½¿ç”¨çš„æ˜¯ARMæ¶æ„ï¼Œæ‰€ä»¥æˆ‘ä»¬å»å¯»æ‰¾ ARMæ¶æ„çš„é•œåƒï¼Œ æˆ‘æ˜¯ç”¨çš„æ˜¯yrzr/gitlab-ce-arm64v8:latest\né¦–å…ˆéœ€è¦åˆ›å»º gitlab-ce çš„ä¸‰ä¸ªå·¥ä½œç›®å½• etcã€ logã€ opt ï¼Œä¸ç„¶ä¼šæŠ¥é”™ ã€‚\nå°†volumesé‡Œé¢çš„é…ç½®ä¿®æ”¹æˆä½ çš„å·¥ä½œç›®å½•å°±å¯ä»¥äº†ã€‚è¿™é‡Œæš´éœ²äº†ä¸¤ä¸ªç«¯å£9922ã€9980 å› ä¸ºæ˜¯åœ¨æœ¬åœ°ä½¿ç”¨ï¼Œæ‰€ä»¥å°±æ²¡å¼€æ”¾httpsçš„443 ç«¯å£ï¼Œåé¢ä¹Ÿä¸å‡†å¤‡ä½¿ç”¨httpsã€‚\ndocker-compose.yaml\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 version: \u0026#34;3.8\u0026#34; services: gitlab-ce: image: yrzr/gitlab-ce-arm64v8:latest container_name: gitlab-ce privileged: true restart: always ports: - \u0026#34;9922:22\u0026#34; - \u0026#34;9980:9980\u0026#34; volumes: - /Users/hxzhouh/tools/gitlab/etc:/etc/gitlab:z - /Users/hxzhouh/tools/gitlab/log:/var/log/gitlab:z - /Users/hxzhouh/tools/gitlab/opt:/var/opt/gitlab:z deploy: resources: limits: memory: 4096M tty: true stdin_open: true è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬å¯¹å¤–æš´éœ²çš„ç«¯å£æ˜¯9980ï¼Œå› ä¸ºæˆ‘ä»¬åé¢ä¼šé…ç½® gitlab çš„http ç«¯å£è¿è¡Œåœ¨9980 è€Œä¸æ˜¯ é»˜è®¤çš„80 ï¼Œè¿™æ ·åšï¼Œæ˜¯ä¸ºäº†é¿å…è¿™ä¸ªé—®é¢˜ï¼š\nhttps://stackoverflow.com/questions/66961517/gitlab-http-clone-url-is-wrong-port-8022-missing\nç­‰å¾…docker è¢«æ‹‰èµ·æ¥ï¼Œç„¶åè¿›å…¥gitlab-ce é‡Œé¢ä¿®æ”¹ é…ç½® /etc/gitlab/gitlab.rb\n1 2 docker exec -it gitlab-ce /bin/bash vi /etc/gitlab/gitlab.rb åœ¨æœ€åæ·»åŠ ä¸‰è¡Œï¼Œä¿å­˜é€€å‡ºã€‚\n1 2 3 external_url \u0026#39;http://127.0.0.1:9980\u0026#39; gitlab_rails[\u0026#39;gitlab_ssh_host\u0026#39;] = \u0026#39;127.0.0.1\u0026#39; gitlab_rails[\u0026#39;gitlab_shell_ssh_port\u0026#39;] = 9922 ç„¶åä¿®æ”¹é»˜è®¤å¯†ç \n1 2 3 4 gitlab-rails console -e production user = User.where(id: 1).first user.password = \u0026#39;AIl+mVN(:bk\\#5%c\u0026#39; user.save! æœ€ååœ¨æ‰§è¡Œreload æ“ä½œï¼Œç„¶åé‡å¯\n1 2 gitlab-ctl reconfigure gitlab-ctl restart ç¨ç­‰ç‰‡åˆ»ã€‚\nç„¶å æµè§ˆå™¨è¾“å…¥127.0.0.1:9980 å°±å¯ä»¥æ‰“å¼€gitlab-ceäº†ï¼Œé»˜è®¤çš„root è´¦å·å¯†ç å°±æ˜¯æˆ‘ä»¬åˆšåˆšä¿®æ”¹çš„å¯†ç ã€‚\næ·»åŠ ssh è·Ÿä½¿ç”¨GitHubä¸€æ ·ï¼Œæˆ‘ä»¬å…ˆåˆ›å»ºä¸€ä¸ªssh å¯†é’¥å¯¹ï¼Œ ç„¶åå°†å…¬é’¥æ·»åŠ åˆ° GitLabé‡Œé¢ã€‚åœ¨æœ¬åœ° ~/.ssh/config é‡Œé¢æ·»åŠ é…ç½®\n1 2 3 4 5 6 Host 127.0.0.1 HostName 127.0.0.1 Port 9922 IdentityFile ~/.ssh/ssh PreferredAuthentications publickey User root æµ‹è¯•ä¸€ä¸‹\n1 2 âœ .ssh ssh -T git@127.0.0.1 Welcome to GitLab, @root! ssh æ˜¯æ²¡æœ‰é—®é¢˜çš„ã€‚\nå°è¯•æ–°å»ºä¸€ä¸ªé¡¹ç›®\nåˆ›å»ºæˆåŠŸï¼Œåœ¨æœ¬åœ°å°†ä»£ç æ‹‰ä¸‹æ¥ã€‚\n1 git clone ssh://git@127.0.0.1:9922/root/hello-world.git ssh æ¨é€ä¹Ÿæ˜¯æ²¡æœ‰é—®é¢˜çš„\n1 2 3 âœ hello-world git:(main) git push origin --force To ssh://127.0.0.1:9922/root/hello-world.git b4dd724..e45f213 main -\u0026gt; main Gitlab Runners é…ç½® åœ¨setting -\u0026gt; CI/CD -\u0026gt; Runners ç‚¹å‡» \u0026hellip;,ç„¶å æ ¹æ® â€˜Show runner installation and registration instructionsâ€™ æ–‡æ¡£ å®‰è£… runners\næˆ‘è¿™é‡Œè¾“å…¥çš„å‘½ä»¤æ˜¯ï¼š\n1 2 3 4 5 sudo curl --output /usr/local/bin/gitlab-runner https://gitlab-runner-downloads.s3.amazonaws.com/latest/binaries/gitlab-runner-darwin-arm64 sudo chmod +x /usr/local/bin/gitlab-runner gitlab-runner install gitlab-runner start gitlab-runner register --url http://127.0.0.1:9980 --registration-token GR13489416KQ-jitR3JhfMgr8f-9G æœ‰å‡ ä¸ªå…³é”®ç‚¹éœ€è¦æ³¨æ„\nEnter tags for the runner (comma-separated): GitLabæ˜¯ç”¨ tagæ¥ç®¡ç†runner çš„ï¼Œæœ€å¥½æ˜¯ä¸€ä¸ªrunneråšä¸€ä»¶äº‹æƒ…ï¼Œç”¨tag æ ‡è®°ï¼Œå†™.gitlab.ci.yml çš„æ—¶å€™éœ€è¦æŒ‡å®štags Enter an executor executor æœ‰å¾ˆå¤šç§ï¼Œæˆ‘è¿™é‡Œä¸ºäº†æ¼”ç¤ºï¼Œé€‰æ‹©äº†shell æ›´å¤šå…³äºGitLab Runner çš„ çš„ä»‹ç»å¯ä»¥å‚è€ƒå®˜ç½‘çš„æ–‡ç« ï¼Œè¿™é‡Œå°±ä¸åšå±•å¼€ã€‚\nå®‰è£…å¥½äº†å°±å¯ä»¥åœ¨ http://127.0.0.1:9980/admin/runners çœ‹åˆ°æ•ˆæœäº†\næœ€åï¼Œåœ¨ åˆšæ‰åˆ›å»ºçš„å·¥ç¨‹ä¸­ï¼Œæ·»åŠ ä¸€ä¸ª .gitlab-ci.yml æµ‹è¯•ä¸€ä¸‹ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 stages: - build build_job: stage: build tags: - golang-local-shell script: - go build -o myapp only: - main - tags artifacts: paths: - myapp å°†ä»£ç æ¨é€åˆ°gitlabï¼Œå¾ˆå¿«å°±èƒ½ç¼–è¯‘å®Œäº† http://127.0.0.1:9980/root/hello-world/-/pipelines\nç„¶ååœ¨ http://127.0.0.1:9980/root/hello-world/-/artifacts å¯ä»¥æ‰¾åˆ° æ„å»ºçš„äº§ç‰©ã€‚\nè‡³æ­¤ï¼Œåœ¨æœ¬åœ°æ­å»ºGitLabç¯å¢ƒå·²ç»å¼„å¥½ï¼Œä¸‹ä¸€ç¯‡æ–‡ç« ï¼Œåœ¨æŠ˜è…¾åœ¨æœ¬åœ°æ­å»ºk8s é›†ç¾¤ï¼Œç„¶åä»GitLabè‡ªåŠ¨æ‰“åŒ…æˆdockeré•œåƒæ¨é€åˆ° k8s é›†ç¾¤ï¼Œå®Œæˆä¸€ä¸ªCI/CDçš„å®Œæ•´æµæ°´çº¿ã€‚\n","date":"2024-11-16T14:58:29+08:00","image":"https://images.hxzhouh.com/blog-images/2024/11/0d1e85b332916907aaf183fc74feb3d7.png","permalink":"https://huizhou92.com/zh-cn/p/01jcsw86hvvsfs4j9rtjshk97z/","title":"å¦‚ä½•åœ¨MacBookä¸Šæ­å»ºGitLab"},{"content":"å¯¹äºæ— é”ç¼–ç¨‹æ¥è®²ï¼Œæ— é”åªæ˜¯ä¸€ä¸ªè¡¨è±¡ï¼Œç¼–ç¨‹è€…è®¾æ³•ç»„ç»‡ data+processingï¼Œé‡ç‚¹åœ¨äºå¦‚ä½•æ¶ˆé™¤ dataracingã€‚è€Œæ¶ˆé™¤ dataracing è€Œè¨€ï¼Œä¼ ç»Ÿçš„å¹¶å‘ç¼–ç¨‹é€»è¾‘æ˜¯é‡‡ç”¨å…³é”®åŒºã€æ’ä»–æ€§é”ã€è¯»å†™é”ç­‰æ–¹å¼æ¥ä¿æŠ¤ data ä¸ä¼šå› ä¸º processing è€Œå¯¼è‡´é”™è¯¯è¯»æˆ–é”™è¯¯å†™ï¼Œé‚£ä¹ˆå¯¹äºæ— é”ç¼–ç¨‹æ¥è¯´ï¼Œåˆ™æ˜¯é€šè¿‡æ¶ˆé™¤ data çš„å…±äº«æ€§ï¼Œæˆ–è€…æ¶ˆé™¤å¹¶å‘æ“ä½œ data ç­‰æ–¹å¼æ¥è§£å†³é—®é¢˜ã€‚\næ‰€ä»¥æœ€å…¸å‹çš„æ— é”ç¼–ç¨‹æŠ€æ³•åŒ…å«ä¸¤ä¸ªæŠ€å·§ï¼š\nstructure bumper loop\nå…¶ä»–çš„æ–¹æ³•éƒ½æ˜¯ç›¸ä¼¼æ€è·¯çš„å…·ä½“è¡ç”Ÿã€‚ è¿™é‡Œçš„â€œå…¶ä»–çš„æ–¹æ³•â€ï¼Œæ˜¯æŒ‡å®Œå…¨ä¸ä½¿ç”¨é”å®šæˆ– CAS çš„ç®—æ³•è®¾è®¡æ–¹æ¡ˆã€‚æœ¬æ–‡ä¸­è®¨è®ºçš„æ˜¯å¦‚ä½•è®¾è®¡æ•°æ®ç»“æ„åŠå…¶å¤„ç†å™¨ï¼ˆç®—æ³•ï¼‰æ¥é˜²æ­¢åŠ é”ï¼Œç”šè‡³äºè¿ CAS ä¹Ÿå»é™¤ã€‚\nè‡³äºåœ¨å…±äº«çš„dataä¸Šå¼ºè¡Œæ¶ˆé™¤ç«äº‰è¯»å†™é—®é¢˜çš„å…¶ä»–æ— é”æ–¹æ¡ˆï¼Œä¾‹å¦‚RingBufferä¹‹ç±»çš„å·¥å…·ç±»åº“ï¼Œåˆ™æ˜¯å®Œå…¨ä¾èµ–äºå…·ä½“çš„ data å®ä½“å¹¶åœ¨å…·ä½“çš„ CPU ä¸Šè¿›è¡Œè®¾è®¡ï¼ŒåŸºæœ¬ä¸Šæ˜¯ä¸€ç§å¾ˆå—é™çš„æ–¹æ³•ï¼Œä¸å…·å¤‡é«˜å±‚æ¬¡æŠ½è±¡å±‚é¢çš„é€šç”¨æ€§ã€‚å°½ç®¡å…¶å…·ä½“çš„è®¾è®¡æ€è·¯æœ‰è¿¹å¯å¾ªï¼Œä½†å´ä¸æ˜¯æœ€ä½³çš„é€‰æ‹©ï¼šä¸€ä¸ªä¼˜ç§€çš„ RingBufferï¼Œå®ƒçš„è‡´å‘½ä¹‹å¤„å°±åœ¨äºåœ¨å•æ ¸å¿ƒçš„CPUä¸Šï¼Œæˆ–è€…å•é¢— vCPU çš„ vHost ä¸Šå¯èƒ½æ˜¯æ— æ³•é™çº§å·¥ä½œçš„ï¼Œæˆ–è€…å³ä½¿èƒ½å·¥ä½œä¹Ÿæ˜¯ä½æ•ˆçš„æˆ–è€…é«˜æ¶ˆè´¹çš„ã€‚æ‰€ä»¥æœ¬æ–‡è®¨è®ºçš„æ˜¯æ›´é€šç”¨çš„ï¼Œåœ¨ä»»ä½•é«˜çº§è¯­è¨€ï¼ˆæ— è®ºå…¶çº¿ç¨‹ã€åç¨‹æ”¯æŒåº¦å¦‚ä½•ï¼‰äºä»»ä½• Targets ä¸Šéƒ½å¯ä»¥é€šè¡Œçš„æ— é”ç¼–ç¨‹æŠ€æ³•ã€‚\nStructure copy Structure copyæ˜¯ä¸€ç§ç»å…¸çš„æ— é”ç¼–ç¨‹æŠ€å·§ã€‚å®ƒçš„æ ¸å¿ƒæ€æƒ³åœ¨äºå°†æ˜“å˜æ•°æ®äº¤ç»™ä¸€ä¸ª structure ç®¡ç†ï¼Œé€šå¸¸å¯èƒ½èµ·åä¸º Entryï¼Œç„¶ååœ¨è¿™ä¸ª structure ä¸Šå±•å¼€æ•°æ®å¤„ç†è¿‡ç¨‹ã€‚å¦‚æ­¤ï¼Œç”±äºæ•°æ®å¤„ç†è¿‡ç¨‹åªä¼šæ“ä½œå…¶æ‰€å…³è”åˆ°çš„ structureï¼Œå› æ­¤è¿™ä¸€ç»„æ•°æ®æœ¬èº«å°±æ˜¯éå…±äº«çš„ï¼Œä¹Ÿå°±ä¸éœ€è¦è€ƒè™‘ dataracing çš„æ½œåœ¨å¯èƒ½æ€§çš„ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 type Worker struct { closed int32 // avoid duplicated release rsrc in Close() entries []*Entry } type Entry struct { Count int Data []any } func (w *Worker) New(data ...any) *Entry { e:=\u0026amp;Entry{Data:data} w.entries = append(w.entries, e) return e } func (e *Entry) Run() { // processing e.data } å‡è®¾åˆå§‹åŒ–æ•°æ® data []any è¢«æä¾›ç»™ Workerï¼ŒåŸºäºæ­¤äº§ç”Ÿä¸€ä¸ª Entryï¼Œç„¶åé€šè¿‡ Entry.Run æ¥å¤„ç†åˆå§‹åŒ–æ•°æ®ï¼Œäº§ç”Ÿç»“æœï¼Œé‚£ä¹ˆä¸Šé¢çš„ç¤ºä¾‹ä»£ç å°±é¿å…äº†æ•°æ®åŒ…ï¼ˆCountï¼ŒDataï¼‰çš„å…±äº«é—®é¢˜ï¼Œå› ä¸ºè¿™ä¸ªæ•°æ®åŒ…æ˜¯æ’ä»–æ€§ç‹¬ç«‹çš„ã€‚\næœ‰æ—¶å€™æˆ‘ä»¬çš„æ•°æ®åŒ…å¾ˆéš¾æ‹†è§£ï¼Œæ­¤æ—¶å¯ä»¥ä»¥è¡ç”ŸæŠ€æ³•æ¥å®ç°æ‹†è§£ã€‚å…·ä½“çš„æ€è·¯æ˜¯è®¾æ³•è¿›è¡Œåˆ†æ²»ã€‚å³æ•°æ®åŒ…å¯ä»¥æŒ‰ç…§æ¨è¿›ç¨‹åº¦é‡æ–°è®¾è®¡ä¸º step1ï¼Œstep2ï¼Œç­‰ç­‰ï¼Œæ¯ä¸€æ­¥éª¤ä¸­çš„å°æ•°æ®åŒ…çš„è®¡ç®—ç»“æœä¾æ¬¡æäº¤ç»™ä¸‹ä¸€æ­¥éª¤ã€‚åˆæˆ–è€…æ•°æ®åŒ…å¯ä»¥æ‹†è§£ä¸ºè‹¥å¹²ä¸ªå°è®¡é¡¹ç›®ï¼Œæœ€åå°†å¤šä¸ªå°è®¡ç»“æœåˆå¹¶è®¡ç®—ï¼ˆMap-Reduce?ï¼‰ã€‚\næ— è®ºé‡‡å–å“ªç§æ‹†è§£æ€è·¯ï¼Œæ€»çš„æ€è·¯ä¸å˜ï¼Œå³å•ä¸ª processing æ‰€æ“ä½œçš„ data æ˜¯æ’ä»–æ€§ç‹¬ç«‹çš„ä¸€ä¸ªå‰¯æœ¬ï¼Œä»è€Œä»æ ¹æœ¬ä¸Šå»é™¤å…±äº«åŠ é”è§£é”çš„éœ€æ±‚ã€‚\né—®é¢˜ é—®é¢˜åœ¨äºå¤ªå¤šçš„å°å—å†…å­˜ï¼ˆEntry structï¼‰å¯èƒ½æ˜¯ä¸å¥½çš„ã€‚ä¸€æ–¹é¢å®ƒå¯èƒ½å¸¦æ¥é¢å¤–çš„å†…å­˜æ¶ˆè€—ï¼ˆå¦‚æœæ­£åœ¨å¤„ç†ä¸€ä¸ªå·¨å¤§çš„é“¾è¡¨ã€æ•°ç»„ä¹‹ç±»ï¼Œä½ ä¸å¤ªå¯èƒ½æ€»æ˜¯åˆ¶é€ å®ƒä»¬çš„å‰¯æœ¬ï¼‰ï¼Œå¦ä¸€æ–¹é¢ï¼Œå¤ªå¤šé¢‘ç¹çš„å°å—å†…å­˜çš„åˆ†å‘å’Œææ„ä¹Ÿä¼šäº§ç”Ÿéš¾ä»¥æ¥å—çš„å¼€é”€ã€‚æœ‰æ—¶å€™ï¼Œå¼ºåˆ¶è¿™æ ·çš„å°å—å†…å­˜åœ¨æ ˆä¸Šåˆ†é…ï¼ˆå¦‚æœè¯­è¨€æˆ–è€…ç¼–è¯‘å™¨æ”¯æŒï¼‰æ˜¯è§£å†³åä¸€é—®é¢˜çš„è‰¯è¯ã€‚ä¸è¿‡æ›´å¤šçš„æƒ…å†µä¸‹ã€æˆ–è®¸è¿™çš„ç¡®å°±æ˜¯ä¸å¯è¡Œçš„ã€‚\nå½“ç„¶ï¼Œå¸¦æœ‰ GC çš„è¯­è¨€è¿™æ–¹é¢çš„å‹åŠ›ä¼šå°ä¸€ç‚¹ã€‚ å…¶æ¬¡ï¼Œä½¿ç”¨ä¸€ä¸ªsync.Poolä¹Ÿå¯ä»¥å‡è½»å°å†…å­˜é¢‘ç¹åˆ†é…çš„å‹åŠ›ã€‚\nåº”ç”¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 type Logger struct { handler Handler // for structured logging } type Handler interface { Handle(context.Context, Record) error } func (l *Logger) Debug(msg string, args ...any) { l.log(context.Background(), LevelDebug, msg, args...) } func (l *Logger) log(ctx context.Context, level Level, msg string, args ...any) { ã€‚ã€‚ã€‚ã€‚ r := NewRecord(time.Now(), level, msg, pc) ã€‚ã€‚ã€‚ã€‚ _ = l.Handler().Handle(ctx, r) } åœ¨ slog ä¸­ï¼Œæ¯æ¡æ—¥å¿—éƒ½ä¼šè¢«åŒ…è£…æˆä¸€ä¸ªNewRecord ï¼Œé¿å…äº†æ•°æ®ç«äº‰ã€‚\nEntry æ¨¡å¼å¯ä»¥è¯´æ˜¯åˆ°å¤„éƒ½æœ‰åœ¨ç”¨ï¼Œç”¨é€”ä¹Ÿä¸ä¸€å®šé™äºä¸ºäº†æ— é”ã€‚ç„¶è€Œå‡¡æ˜¯è¿ç”¨åˆ°è¯¥æ¨¡å¼çš„åœ°æ–¹ï¼Œè‡ªåŠ¨è·å¾—äº†æ— é”çš„æ”¶ç›Šï¼Œè¿™å…¶å®æ˜¯å¾ˆåˆ’ç®—çš„ã€‚\nBumper Loop Bumper Loopæ˜¯ä¸€ç§è®¾è®¡æ¨¡å¼\nBumper Loop æœ€ç»å…¸çš„ä¾‹å­æ˜¯Redis, Redis ä½¿ç”¨å¤šçº¿ç¨‹ç½‘ç»œæ¨¡å‹ï¼Œä½†æ˜¯åœ¨äº‹åŠ¡å¤„ç†ä¸Šä½¿ç”¨å•çº¿ç¨‹ã€‚\nå®ƒçš„æ ¸å¿ƒæ€æƒ³æ˜¯å°†å¹¶è¡Œäº‹ä»¶å¼ºè¡Œåºåˆ—åŒ–ï¼Œç„¶åå†ä¸€ä¸€åˆ†å‘ç»™å…·ä½“å¤„ç†ç¨‹åºã€‚äºæ˜¯å¯¹äºè¿™äº›å…·ä½“å¤„ç†ç¨‹åºæ¥è®²ï¼Œå…±äº«æ•°æ®æ€»æ˜¯æ’ä»–æ€§çš„ï¼šå› ä¸ºæ‰€æœ‰å¤„ç†ç¨‹åºåœ¨åŒä¸€æ—¶é—´ä¸‹åªä¼šè¿è¡Œä¸€ä¸ªã€‚å¦‚æœå…·ä½“å¤„ç†ç¨‹åºæ€»æ˜¯é£å¿«åœ°å®Œæˆï¼Œæ²¡æœ‰é˜»å¡çš„å¿§è™‘ï¼Œé‚£ä¹ˆBumper Loopæ¨¡å¼å°†ä¼šæ˜¯ä¸€ä¸ªéå¸¸å¥½çš„æ¶ˆè´¹æ¨¡å¼ã€‚\n1 2 3 4 5 6 7 8 func (w *Worker) runLoop() { for { switch{ case ev:=\u0026lt;-fileWatcherCh: onFileChanged(ev) } } } å¯¹äºä½é¢‘äº‹ä»¶çš„åˆ†å‘å’Œç®€åŒ–å¹¶åœ¨æ­¤åŒæ—¶å»é™¤åŠ é”éœ€æ±‚ã€æå‡æ€§èƒ½æ¥è¯´ï¼Œå¾ªç¯æ³µæ¨¡å¼æ˜¯ä¸€æ—¶ä¹‹é€‰ã€‚åœ¨è¯¸å¦‚ TCP/IP æœåŠ¡å™¨çš„ incoming data å¤„ç†ä¸Šé€šå¸¸Bumper Loop æ˜¯æœ€ä½³é€‰æ‹©ï¼š\nå¯¹æ–°è¿›è¿æ¥è¯·æ±‚é‡‡å– Entry æ¨¡å¼åˆ¶ä½œä¸€ä¸ªç‹¬ç«‹çš„å¤„ç†å™¨ connectionProcessorï¼Œè¯¥å¤„ç†å™¨ä¸­ä»¥å¾ªç¯æ³µæ¨¡å¼æ¥å—è¾“å…¥æ•°æ®ï¼Œè¯†åˆ«è¾“å…¥æ•°æ®çš„æ¨¡å¼ä¸ºè§„çº¦å‘½ä»¤ï¼Œç„¶ååˆ†å‘ç»™å…·ä½“çš„è§„çº¦å‘½ä»¤å¤„ç†å™¨ã€‚\né—®é¢˜ Bumper Loop çš„é—®é¢˜åœ¨äºï¼Œä¸€ä¸ªé˜»å¡ä¼šç ´åæ•´ä¸ªå¾ªç¯ï¼Œä¸€ä¸ªè¿‡æ…¢çš„å¤„ç†ä¼šå¸¦æ¥ä¸å¯çŸ¥çš„ä¸‹ä¸€äº‹ä»¶çš„å¤„ç†å»¶è¿Ÿï¼Œé«˜é¢‘ç‡çš„äº‹ä»¶ä¼šåœ¨åˆ†å‘ç‚¹ä¸Šé˜»å¡ã€å †ç§¯ï¼Œç”šè‡³æ˜¯ä¸¢å¤±ã€‚å°½ç®¡ Bumper Loop ä¼¼ä¹å¾ˆæ˜æ˜¾åœ°æœ‰ä¸²è¡ŒåŒ–çš„æ•ˆç‡åŠ£åŠ¿ï¼Œä½†å®ƒä»è¢«å¹¿æ³›åœ°ç”¨äº TCP/IP server/client ç¼–ç¨‹ä¸­ã€‚\nStructure Copy ä¸ Bumper Loop ç»“åˆ Bumper Loop çš„é—®é¢˜ä¹‹ä¸€æ˜¯ä¸å¤ªé€‚åˆé«˜é¢‘äº‹ä»¶åœºæ™¯ï¼Œä¸€èˆ¬æ¥è¯´äº‹ä»¶é¢‘ç‡åœ¨80msä»¥ä¸Šæ—¶æ‰æ¯”è¾ƒå¥½ç”¨ã€‚è¿™ç§å°ºåº¦çš„éšå–»æ˜¯è¯´å•æ¬¡äº‹ä»¶å¤„ç†å¹³å‡è€—æ—¶åº”è¯¥å°äº 80msã€‚\nåœ¨ä¸é‚£ä¹ˆä¸¥æ ¼çš„åœºæ™¯ä¸­ï¼ˆä¾‹å¦‚éé‡‘èé«˜é¢‘äº¤æ˜“ï¼‰ï¼Œæœ‰æ—¶å€™å¯ä»¥åœ¨è€—æ—¶çš„äº‹ä»¶å¤„ç†å™¨ä¸­å¯åŠ¨ä¸€ä¸ª gorountine å»å¼‚æ­¥åœ°æ…¢æ…¢å¤„ç†ï¼Œè€Œä¸»ä½“çš„ bumpper loop åˆ™ç»§ç»­å»åˆ†å‘åç»§äº‹ä»¶ã€‚è¿™æ—¶å€™å¼‚æ­¥ go routine åˆå¯ä»¥ç”¨åˆ° Entry æ¨¡å¼ï¼Œé€‚å½“åœ°å¤åˆ¶å°‘è®¸çŠ¶æ€ä»¥ä¾¿è§£è€¦ç«æ€æ¡ä»¶ã€‚\n","date":"2024-10-19T12:03:18+08:00","permalink":"https://huizhou92.com/zh-cn/p/go-%E9%AB%98%E6%80%A7%E8%83%BD%E7%BC%96%E7%A8%8B-ep9-%E4%B8%A4%E4%B8%AA%E6%9C%89%E7%94%A8%E7%9A%84-golang-%E6%97%A0%E9%94%81%E7%BC%96%E7%A8%8B%E6%8A%80%E5%B7%A7/","title":"Go é«˜æ€§èƒ½ç¼–ç¨‹ EP9: ä¸¤ä¸ªæœ‰ç”¨çš„ Golang æ— é”ç¼–ç¨‹æŠ€å·§"},{"content":"2022å¹´ï¼Œå­—èŠ‚è·³åŠ¨ç»™Golangæäº†issueå»ºè®®æŠŠmapçš„åº•å±‚å®ç°æ”¹æˆSwissTableçš„ã€‚2023å¹´ï¼Œdoltå†™äº†ä¸€ç¯‡åšå®¢SwissMap: A smaller, faster Golang Hash Table åˆ†äº«ä»–ä»¬ è®¾è®¡äº†ä¸€ä¸ªåŸºäºSwissTable çš„ Map ,å¼•èµ·äº†å¹¿æ³›çš„å…³æ³¨ã€‚ç›®å‰ Go æ ¸å¿ƒå›¢é˜Ÿå·²ç»å¼€å§‹é‡æ–°å®¡è§† swisstable è®¾è®¡ï¼Œåœ¨runtimeä¸­ä¹Ÿæ·»åŠ äº†éƒ¨åˆ†ä»£ç ï¼Œè¶ç€å‡æœŸï¼Œåˆšå¥½æœ‰æ—¶é—´æ·±å…¥äº†è§£ä¸€ä¸‹åŸç†ï¼Œè·Ÿruntime map ç›¸æ¯”æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Œä»¥åŠä¸ºä»€ä¹ˆå®ƒå¯èƒ½ä¼šæˆä¸ºmapçš„æ ‡å‡†å®ç°ã€‚\nThis article was first published in the Medium MPP plan. If you are a Medium user, please follow me on Medium. Thank you very much.\næœ¬æ–‡ä¸ä¼šå®Œå…¨è§£é‡Šhashtableæˆ–è€…swisstableçš„åŸç†ã€‚æ‚¨éœ€è¦å¯¹hashtable æœ‰ä¸€å®šçš„äº†è§£ã€‚\nå“ˆå¸Œè¡¨æä¾›äº†ä¸€ä¸ªkeyåˆ°å¯¹åº”valueçš„æ˜ å°„ï¼Œé€šè¿‡ä¸€ä¸ªhashå‡½æ•°æŠŠkeyè½¬æ¢æˆæŸä¸ªâ€œä½ç½®â€œï¼Œä»è¿™ä¸ªä½ç½®ä¸Šå¯ä»¥ç›´æ¥æ‹¿åˆ°æˆ‘ä»¬æƒ³è¦çš„valueï¼Œ\nä¼ ç»Ÿ hashtable å“ˆå¸Œè¡¨æä¾›äº†ä¸€ä¸ªkeyåˆ°å¯¹åº”valueçš„æ˜ å°„ï¼Œé€šè¿‡ä¸€ä¸ªhashå‡½æ•°æŠŠkeyè½¬æ¢æˆæŸä¸ªâ€œä½ç½®â€œï¼Œä»è¿™ä¸ªä½ç½®ä¸Šå¯ä»¥ç›´æ¥æ‹¿åˆ°æˆ‘ä»¬æƒ³è¦çš„valueã€‚ä¸è¿‡ï¼Œå³ä½¿hashå‡½æ•°å†å®Œç¾ï¼ŒæŠŠæ— é™çš„keyæ˜ å°„åˆ°ä¸€ä¸ªæœ‰é™å¤§å°çš„å†…å­˜ç©ºé—´å†…ä¹Ÿè¿˜æ˜¯ä¸å¯é¿å…å¾—ä¼šäº§ç”Ÿå†²çªï¼šä¸¤ä¸ªä¸åŒçš„keyä¼šè¢«æ˜ å°„åˆ°åŒä¸€ä¸ªä½ç½®ã€‚ ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä¼ ç»Ÿçš„hashtableæœ‰å¥½å‡ ä¸ªè§£å†³æ–¹æ¡ˆï¼Œæœ€å¸¸è§çš„è§£å†³å†²çªçš„åŠæ³•æœ‰â€œé“¾è¡¨æ³•â€å’Œâ€œçº¿æ€§æ¢æµ‹æ³•â€ã€‚\né“¾è¡¨æ³• é“¾è¡¨æ³•æ˜¯æœ€å¸¸è§çš„ï¼Œå®ƒçš„ä¸­å¿ƒæ€æƒ³åœ¨äºå¦‚æœkeyæ˜ å°„åˆ°äº†ç›¸åŒçš„ä½ç½®ï¼Œé‚£ä¹ˆå°±æŠŠè¿™äº›keyå’Œvalueå­˜åœ¨ä¸€å¼ é“¾è¡¨é‡Œã€‚æŸ¥æ‰¾çš„æ—¶å€™å…ˆç”¨hashå‡½æ•°è®¡ç®—å¾—åˆ°ä½ç½®ï¼Œç„¶åå†ä»å­˜æ”¾åœ¨è¯¥ä½ç½®ä¸Šçš„é“¾è¡¨é‡Œä¸€ä¸ªä¸ªéå†æ‰¾åˆ°keyç›¸ç­‰çš„æ¡ç›®ã€‚å®ƒçš„ç»“æ„ç±»ä¼¼è¿™æ ·ï¼š\nfigure 1: æ‹‰é“¾æ³•å®ç° hashtable\né“¾è¡¨æ³•å®ç°å¾ˆç®€å•ï¼Œæ²¡é‚£ä¹ˆå¤šè¾¹ç•Œæ¡ä»¶è¦è€ƒè™‘,æ’å…¥æ•°æ®å’Œåˆ é™¤æ•°æ®å¾ˆå¿«ï¼Œæ’å…¥ç”¨é“¾è¡¨çš„å¤´æ’æ³•ï¼Œåˆ é™¤åªéœ€è¦ç§»åŠ¨éƒ¨åˆ†èŠ‚ç‚¹çš„nextæŒ‡é’ˆã€‚æ­¤å¤–ï¼Œé“¾è¡¨æ³•èƒ½é‡‡å–æ‰©å®¹ä¹‹å¤–çš„æ‰‹æ®µé˜»æ­¢æŸ¥è¯¢æ€§èƒ½é€€åŒ–ï¼Œæ¯”å¦‚æŠŠè¿‡é•¿é“¾è¡¨è½¬æ¢æˆæœç´¢æ ‘ç­‰ã€‚é“¾è¡¨æ³•çš„ç¼ºç‚¹æ˜¯æœ¬èº«å¯¹ç¼“å­˜ä¸å¤Ÿå‹å¥½ï¼Œå†²çªè¾ƒå¤šçš„æ—¶å€™ç¼“å­˜å‘½ä¸­ç‡è¾ƒä½ä»è€Œå½±å“æ€§èƒ½ã€‚ä¸åŒçš„slotä¹‹é—´æ•°æ®åœ¨å†…å­˜é‡Œçš„è·¨åº¦è¾ƒå¤§ï¼Œæ•°æ®ç»“æ„æ•´ä½“çš„ç©ºé—´å±€éƒ¨æ€§è¾ƒå·®ã€‚\nçº¿æ€§æ¢æµ‹æ³• çº¿æ€§æ¢æµ‹æ˜¯å¦ä¸€ç§å¸¸è§çš„å“ˆå¸Œè¡¨å†²çªè§£å†³æ–¹æ³•ã€‚å®ƒè§£å†³å†²çªçš„æ–¹å¼äºé“¾è¡¨æ³•ä¸åŒï¼Œåœ¨é‡åˆ°hashå†²çªçš„æ—¶å€™ï¼Œå®ƒä¼šä»å†²çªçš„ä½ç½®å¼€å§‹å‘åä¸€ä¸ªä¸ªæŸ¥æ‰¾ï¼Œç›´åˆ°æ‰¾åˆ°ä¸€ä¸ªç©ºä½ï¼Œæˆ–è€…æ²¡æ‰¾åˆ°ç„¶åç´¢å¼•å›åˆ°äº†å†²çªå‘ç”Ÿçš„ä½ç½®ï¼Œè¿™æ—¶ä¼šè¿›è¡Œæ‰©å®¹ç„¶åå†é‡æ–°æ‰§è¡Œä¸Šè¿°æ’å…¥æµç¨‹ã€‚\nFigure 2 ï¼šçº¿æ€§æ¢æµ‹æ³•æ·»åŠ æ•°æ® åŠ¨ç”»æ¼”ç¤º\næŸ¥æ‰¾ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œé¦–å…ˆé€šè¿‡hashå‡½æ•°è®¡ç®—å¾—åˆ°å…ƒç´ åº”è¯¥åœ¨çš„ä½ç½®ï¼Œç„¶åä»è¿™ä¸ªä½ç½®å¼€å§‹ä¸€ä¸ªä¸ªæ¯”è¾ƒkeyæ˜¯å¦ç›¸ç­‰ï¼Œé‡åˆ°è¢«åˆ é™¤çš„å…ƒç´ å°±è·³è¿‡ï¼Œé‡åˆ°ç©ºçš„slotå°±åœæ­¢æœç´¢ï¼Œè¿™è¡¨ç¤ºå…ƒç´ ä¸åœ¨è¿™ä¸ªå“ˆå¸Œè¡¨ä¸­ã€‚æ‰€ä»¥åˆ é™¤å…ƒç´ çš„æ—¶å€™ï¼Œä½¿ç”¨çš„æ˜¯æ ‡è®°åˆ é™¤ã€‚\nFigure 3: çº¿æ€§æ¢æµ‹æ³•æŸ¥æ‰¾æ•°æ®æ¼”ç¤º\nçº¿æ€§æ¢æµ‹æ³• çš„æ—¶é—´å¤æ‚åº¦è·Ÿé“¾è¡¨æ³•å·®ä¸å¤šï¼Œå®ƒçš„ä¼˜ç‚¹æ˜¯å¯¹ç¼“å­˜å‹å¥½ï¼Œç°åœ¨å¯ä»¥ç”¨æ•°ç»„ä¹‹ç±»çš„ç´§å¯†æ•°æ®ç»“æ„å®ç°ã€‚åŒæ—¶ï¼Œå®ƒçš„ç¼ºç‚¹ä¹Ÿå¾ˆæ˜æ˜¾ï¼š\nå®ç°å¤æ‚ï¼Œä¸€ä¸ªslotæœ‰å…ƒç´ ã€ç©ºã€è¢«åˆ é™¤è¿™ä¸‰ç§çŠ¶æ€ hashå†²çªæ˜¯è¿é”å¼çš„ï¼Œä¸€å¤„å†²çªå¯èƒ½ä¼šè¿ç»­å½±å“å¤šå¤„ï¼Œæœ€ç»ˆå¯¼è‡´æ’å…¥åŒæ ·çš„æ•°æ®ï¼Œå®ƒæ‰©å®¹çš„æ¬¡æ•°ä¼šæ¯”é“¾è¡¨æ³•æ›´å¤šï¼Œæœ€ç»ˆå¯èƒ½ä¼šç”¨æ‰æ›´å¤šçš„å†…å­˜ã€‚ å› ä¸ºå†²çªä¼šé€ æˆåç»­æ’å…¥å’Œåˆ é™¤çš„è¿é”ååº”ï¼Œæ‰€ä»¥æŸ¥æ‰¾è¿‡ç¨‹é€€åŒ–åˆ°O(n)çš„æ¦‚ç‡æ›´å¤§ï¼Œè€Œä¸”æ²¡æ³•åƒé“¾è¡¨æ³•é‚£æ ·æŠŠæœ‰å¤§é‡å†²çªçš„åœ°æ–¹è½¬æ¢æˆæœç´¢æ ‘ä¹‹ç±»çš„ç»“æ„ã€‚\nå› ä¸ºåˆ é™¤å…ƒç´ éº»çƒ¦ï¼ŒåŠ ä¸Šå†²çªä¼šæœ‰è¿é”å½±å“ï¼Œæ‰€ä»¥å¾ˆå¤šåº“å®ç°çš„hashtableéƒ½æ˜¯ç”¨çš„é“¾è¡¨æ³•ã€‚ä¸è¿‡å³ä½¿æœ‰è¿™ä¹ˆå¤šç¼ºç‚¹ï¼Œå…‰ç¼“å­˜å‹å¥½å’Œå†…å­˜åˆ©ç”¨ç‡é«˜åœ¨ç°ä»£è®¡ç®—æœºä¸Šå°±æ˜¯éå¸¸å¤§çš„æ€§èƒ½ä¼˜åŠ¿äº†ï¼Œæ‰€ä»¥åƒgolangå’Œpythonéƒ½ä¼šä½¿ç”¨çº¿æ€§æ¢æµ‹æ³•çš„è¿‘ä¼¼å˜ç§æ¥å®ç°å“ˆå¸Œè¡¨ã€‚ go hashmap å¦‚ä½•å­˜å‚¨æ•°æ® æˆ‘ä»¬é¦–å…ˆæ¥å›å¿†ä¸€ä¸‹ Go Map æ˜¯å¦‚ä½•å­˜å‚¨æ•°æ®çš„ã€‚\nfigure 4: go map ç¤ºæ„å›¾\nå¿«é€Ÿæ€»ç»“ä¸€ä¸‹ï¼š\nGo map åº•å±‚é€šè¿‡å“ˆå¸Œå‡½æ•°å°† key æ˜ å°„åˆ°å¤šä¸ª bucketä¸­ã€‚æ¯ä¸ª bucket å…·æœ‰å›ºå®šæ•°é‡çš„é”®å€¼å¯¹slotï¼Œç”¨äºå­˜å‚¨ key å’Œå¯¹åº”çš„ valueã€‚ æ¯ä¸ª bucket èƒ½å­˜å‚¨ 8ä¸ªé”®å€¼å¯¹ã€‚å½“å†²çªå‘ç”Ÿæ—¶ï¼ˆå³å¤šä¸ª key è¢«æ˜ å°„åˆ°åŒä¸€ä¸ª bucketï¼‰ï¼Œè¿™äº› key å’Œ value ä¼šåœ¨åŒä¸€ä¸ª bucket å†…å­˜å‚¨ã€‚ map é€šè¿‡å“ˆå¸Œå‡½æ•°è®¡ç®— key çš„å“ˆå¸Œå€¼ï¼Œå¹¶æ ¹æ®å“ˆå¸Œå€¼æ‰¾åˆ°å¯¹åº”çš„ bucketã€‚ å¦‚æœæŸä¸ª bucket è¢«å¡«æ»¡ï¼ˆ8 ä¸ªslotå·²ç”¨å®Œï¼‰ï¼Œä¼šç”Ÿæˆä¸€ä¸ª overflow bucketï¼Œç»§ç»­å­˜å‚¨æ–°çš„é”®å€¼å¯¹ã€‚ æŸ¥æ‰¾æ—¶æ•°æ®æ—¶ï¼Œé¦–å…ˆè®¡ç®—è¦æŸ¥æ‰¾çš„ key çš„å“ˆå¸Œå€¼ï¼Œç„¶åç¡®å®šè¯¥å“ˆå¸Œå€¼æ˜ å°„åˆ°çš„ bucketã€‚Go ä¼šæ£€æŸ¥æ¯ä¸ªslotï¼Œå¦‚æœ bucket ä¸­å­˜åœ¨overflow bucketï¼Œä¼šé¡ºåºæ£€æŸ¥overflow bucketä¸­çš„ keyã€‚ SwissTableï¼Œä¸€ç§é«˜æ•ˆçš„ hashtable å®ç°æ–¹å¼ SwissTable æ˜¯ä¸€ç§åŸºäºæ”¹è¿›çš„çº¿æ€§æ¢æµ‹æ³•çš„å“ˆå¸Œè¡¨å®ç°ï¼Œå…¶æ ¸å¿ƒæ€æƒ³æ˜¯é€šè¿‡æ”¹è¿›å“ˆå¸Œè¡¨çš„ç»“æ„å’Œå…ƒæ•°æ®å­˜å‚¨ï¼Œä¼˜åŒ–äº†æ€§èƒ½å’Œå†…å­˜ä½¿ç”¨ã€‚SwissTable é‡‡ç”¨äº†ä¸€ç§æ–°çš„å…ƒæ•°æ®æ§åˆ¶æœºåˆ¶ï¼Œå¤§å¹…å‡å°‘äº†ä¸å¿…è¦çš„é”®æ¯”è¾ƒæ“ä½œï¼ŒåŒæ—¶åˆ©ç”¨ SIMD æŒ‡ä»¤æå‡ååé‡ã€‚\næˆ‘ä»¬å›é¡¾äº†ä¸€ä¸‹ä¸¤ç§å¸¸è§çš„å“ˆå¸Œè¡¨å®ç°ï¼Œå®ƒä»¬è¦ä¹ˆæµªè´¹å†…å­˜ä¸”å¯¹ç¼“å­˜ä¸å‹å¥½ï¼›è¦ä¹ˆå‘ç”Ÿå†²çªåä¼šæ›´å®¹æ˜“å¯¼è‡´æŸ¥æ‰¾ã€æ’å…¥ã€åˆ é™¤æ“ä½œæ€§èƒ½ä¸‹é™ã€‚è¿™è¿˜æ˜¯åœ¨æœ‰â€œå®Œç¾å“ˆå¸Œå‡½æ•°â€çš„æƒ…å†µä¸‹ï¼Œå¦‚æœä½ ç”¨äº†ä¸ªä¸é‚£ä¹ˆå¥½çš„å“ˆå¸Œå‡½æ•°ï¼Œé‚£ä¼šå¯¼è‡´keyå†²çªçš„æ¦‚ç‡å¤§å¤§ä¸Šå‡ï¼Œæ€§èƒ½é—®é¢˜ä¼šæ›´åŠ æ˜æ˜¾ï¼Œæœ€åçš„æƒ…å†µä¸‹æ€§èƒ½ç”šè‡³ä¼šä¸å¦‚åœ¨æ•°ç»„é‡Œè¿›è¡Œçº¿æ€§æœç´¢ã€‚\nä¸šç•Œå¼€å§‹å¯»æ‰¾ä¸€ç§æ—¢å¯¹ç¼“å­˜å‹å¥½åˆä¸ä¼šè®©æŸ¥æ‰¾æ€§èƒ½é€€åŒ–çš„å¤ªå‰å®³çš„å“ˆå¸Œè¡¨ç®—æ³•ã€‚å¤§å¤šæ•°äººçš„ç ”ç©¶æ–¹å‘æ˜¯å¼€å‘æ›´å¥½çš„å“ˆå¸Œå‡½æ•°ï¼Œåœ¨è®©å“ˆå¸Œå‡½æ•°ä¸æ–­æ¥è¿‘â€œå®Œç¾å“ˆå¸Œå‡½æ•°â€çš„å“è´¨çš„åŒæ—¶ç”¨å„ç§æ‰‹æ®µä¼˜åŒ–è®¡ç®—æ€§èƒ½ï¼›å¦å¤–ä¸€äº›äººåœ¨æ”¹è¿›å“ˆå¸Œè¡¨æœ¬èº«çš„ç»“æ„åŠ›æ±‚åœ¨ç¼“å­˜å‹å¥½ã€æ€§èƒ½å’Œå†…å­˜ç”¨é‡ä¸Šæ‰¾åˆ°å¹³è¡¡ã€‚swisstableå°±å±äºåè€…ã€‚\nswisstableçš„æ—¶é—´å¤æ‚åº¦å’Œçº¿æ€§æ¢æµ‹æ³•çš„å·®ä¸å¤šï¼Œç©ºé—´å¤æ‚åº¦ä»‹äºé“¾è¡¨æ³•å’Œçº¿æ€§æ¢æµ‹ä¹‹é—´ã€‚ swisstableçš„å®ç°æœ‰å¾ˆå¤šï¼Œæˆ‘ä¸»è¦åŸºäºdolthub/swissè¿™ä¸ªå®ç°è¿›è¡Œç®€è¦çš„ä»‹ç»ã€‚\nSwissTable çš„åŸºæœ¬ç»“æ„ è™½ç„¶åå­—å˜äº†ï¼Œå®é™…ä¸Šswisstableä¾ç„¶æ˜¯hashtableï¼Œè€Œä¸”ä½¿ç”¨æ”¹è¿›çš„çº¿æ€§æ¢æµ‹æ³•æ¥è§£å†³hashå†²çªã€‚ æ‰€ä»¥å¤§å®¶åº”è¯¥èƒ½æƒ³è±¡åˆ°ï¼Œswisstableçš„åº•å±‚åº”è¯¥ä¹Ÿæ˜¯ä¸ªç±»ä¼¼æ•°ç»„çš„ç»“æ„ã€‚æœ‰äº†è¿™æ ·å¤§è‡´çš„æ¨¡ç³Šå°è±¡å°±å¯ä»¥äº†ï¼Œç°åœ¨æˆ‘ä»¬å¯ä»¥æ¥çœ‹çœ‹swisstableçš„ç»“æ„äº†:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 type Map[K comparable, V any] struct { ctrl []metadata groups []group[K, V] hash maphash.Hasher[K] resident uint32 //currently occupied slots in the hash map dead uint32 //A tombstone indicates a slot that was previously occupied but has been deleted limit uint32 // This field represents the maximum number of elements that can be added to the hash map before it needs to be resized. It is calculated based on the load factor and the number of groups. } // metadata is the h2 metadata array for a group. // find operations first probe the controls bytes // to filter candidates before matching keys type metadata [groupSize]int8 // group is a group of 16 key-value pairstype group[K comparable, V any] struct { keys [groupSize]K values [groupSize]V } åœ¨swisstable çš„å®ç°ä¸­ï¼Œctrl æ˜¯ä¸€ä¸ª []metadata ï¼Œ[]metadata è·Ÿ []group[K, V] æ•°é‡å¯¹åº” ã€‚æ¯ä¸ªgroupæœ‰8ä¸ªslot\nhashä¼šè¢«åˆ†æˆä¸¤éƒ¨åˆ†ï¼š57bitsé•¿åº¦çš„ä¸ºH1ï¼Œç”¨äºç¡®å®šä»å“ªä¸ªgroupså¼€å§‹æ¢æµ‹ï¼Œå‰©ä¸‹çš„7bitså«åšH2ï¼Œåˆšå¥½æ”¾åœ¨metadataä¸­ï¼Œ è¢«ç”¨ä½œæ˜¯å½“å‰keyçš„å“ˆå¸Œç‰¹å¾å€¼ï¼Œç”¨äºåé¢çš„æŸ¥æ‰¾å’Œè¿‡æ»¤ã€‚\nswisstableæ¯”ä¼ ç»Ÿå“ˆå¸Œè¡¨æ›´å¿«çš„ç§˜è¯€å°±åœ¨äºè¿™äº›è¢«å«åšctrlçš„metadataã€‚æ§åˆ¶ä¿¡æ¯ä¸»è¦æ˜¯ä¸‹é¢è¿™å‡ ç§ï¼š\nslotæ˜¯å¦ä¸ºç©º: 0b10000000 sloté‡Œçš„å…ƒç´ æ˜¯å¦å·²ç»è¢«åˆ é™¤: 0b11111110 sloté‡Œå­˜çš„é”®å€¼å¯¹çš„keyçš„å“ˆå¸Œç‰¹å¾ï¼ˆH2ï¼‰0bh2\nå¯¹äºç©ºã€åˆ é™¤è¿™å‡ ç§ç‰¹æ®ŠçŠ¶æ€ï¼Œå¯¹åº”çš„å€¼éƒ½æ˜¯ç‰¹æ„è®¾ç½®çš„ï¼Œç›®çš„æ˜¯ä¸ºäº†èƒ½å¤Ÿåœ¨åé¢çš„åŒ¹é…ä¸­ä½¿ç”¨SIMDæŒ‡ä»¤ï¼Œè·å¾—æœ€é«˜çš„æ€§èƒ½ã€‚ æŸ¥æ‰¾ã€æ’å…¥ã€åˆ é™¤éƒ½æ˜¯åŸºäºè¿™äº›ctrlçš„ï¼Œå®ƒä»¬éå¸¸å°ï¼Œå¯ä»¥å°½é‡å¤šçš„è¢«æ”¾å…¥CPUçš„é«˜é€Ÿç¼“å­˜ï¼ŒåŒæ—¶åˆåŒ…å«äº†è¶³å¤Ÿçš„ä¿¡æ¯ä»¥æ»¡è¶³å“ˆå¸Œè¡¨çš„å¢åˆ æ”¹æŸ¥ã€‚è€Œslotå°±åªç”¨æ¥å­˜æ•°æ®ï¼Œctrlå’Œslotä¸€ä¸€å¯¹åº”ï¼Œæ§åˆ¶ä¿¡æ¯åœ¨ctrlé‡Œçš„ç´¢å¼•å°±æ˜¯å¯¹åº”çš„æ•°æ®åœ¨sloté‡Œçš„ç´¢å¼•ï¼Œä¸‹é¢ä»¥æ·»åŠ æ•°æ®ä¸ºä¾‹ï¼ŒæŸ¥æ‰¾ï¼Œåˆ é™¤ éƒ½å·®ä¸å¤šã€‚\næ·»åŠ æ•°æ® swisstable æ·»åŠ æ•°æ®çš„è¿‡ç¨‹åˆ†æˆå‡ ä¸ªæ­¥éª¤ã€‚\nè®¡ç®—å“ˆå¸Œå€¼å¹¶åˆ†å‰²ä¸º h1 å’Œ h2 , æ ¹æ® h1 ç¡®å®šå¼€å§‹æ¢æµ‹çš„groups , ä½¿ç”¨ metaMatchH2 æ£€æŸ¥å½“å‰ç»„ä¸­çš„ metadata æ˜¯å¦æœ‰åŒ¹é…çš„ h2ã€‚å¦‚æœæ‰¾åˆ°åŒ¹é…çš„ h2ï¼Œåˆ™è¿›ä¸€æ­¥æ£€æŸ¥å¯¹åº”æ§½ä½ä¸­çš„é”®æ˜¯å¦ä¸ç›®æ ‡é”®ç›¸åŒã€‚å¦‚æœç›¸åŒï¼Œåˆ™æ›´æ–°å€¼å¹¶è¿”å›ã€‚ å¦‚æœæ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„é”®ï¼Œä½¿ç”¨ metaMatchEmpty æ£€æŸ¥å½“å‰ç»„ä¸­æ˜¯å¦æœ‰ç©ºé—²slotã€‚å¦‚æœæœ‰slotï¼Œåˆ™æ’å…¥æ–°çš„é”®å€¼å¯¹ï¼Œå¹¶æ›´æ–° metadata å’Œ resident è®¡æ•°ã€‚ å¦‚æœå½“å‰ç»„æ²¡æœ‰ç©ºé—²æ§½ä½ï¼Œè¿›è¡Œçº¿æ€§æ¢æµ‹ï¼Œæ£€æŸ¥ä¸‹ä¸€ä¸ªgroupsã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 func (m *Map[K, V]) Put(key K, value V) { if m.resident \u0026gt;= m.limit { m.rehash(m.nextSize()) } hi, lo := splitHash(m.hash.Hash(key)) g := probeStart(hi, len(m.groups)) for { // inlined find loop matches := metaMatchH2(\u0026amp;m.ctrl[g], lo) for matches != 0 { s := nextMatch(\u0026amp;matches) if key == m.groups[g].keys[s] { // update m.groups[g].keys[s] = key m.groups[g].values[s] = value return } } // |key| is not in group |g|, // stop probing if we see an empty slot matches = metaMatchEmpty(\u0026amp;m.ctrl[g]) if matches != 0 { // insert s := nextMatch(\u0026amp;matches) m.groups[g].keys[s] = key m.groups[g].values[s] = value m.ctrl[g][s] = int8(lo) m.resident++ return } g += 1 // linear probing if g \u0026gt;= uint32(len(m.groups)) { g = 0 } } } func metaMatchH2(m *metadata, h h2) bitset { // https://graphics.stanford.edu/~seander/bithacks.html##ValueInWord return hasZeroByte(castUint64(m) ^ (loBits * uint64(h))) } func nextMatch(b *bitset) uint32 { s := uint32(bits.TrailingZeros64(uint64(*b))) *b \u0026amp;= ^(1 \u0026lt;\u0026lt; s) // clear bit |s| return s \u0026gt;\u0026gt; 3 // div by 8 } è™½ç„¶ï¼Œæ­¥éª¤å¾ˆå°‘ï¼Œä½†æ˜¯é‡Œé¢ä½¿ç”¨äº†æ¯”è¾ƒå¤æ‚çš„ä½è¿ç®—ï¼ŒæŒ‰ç…§æ­£å¸¸çš„æµç¨‹ï¼Œéœ€è¦æŠŠh2 è·Ÿæ‰€æœ‰çš„ å¯¹æ¯”ï¼Œç›´åˆ°æ‰¾åˆ°æˆ‘ä»¬è¦çš„ç›®æ ‡ã€‚swisstable ä½¿ç”¨äº†ä¸€ä¸ªå¾ˆå·§å¦™çš„æ–¹å¼æ¥å®ç°è¿™ä¸ªç›®æ ‡ã€‚\né¦–å…ˆå°†h2 * 0x0101010101010101 å¾—åˆ°ä¸€ä¸ªuint64ï¼Œè¿™æ ·å°±èƒ½ä¸€æ¬¡æ€§å¯¹æ¯” 8ä¸ª ctrl ç„¶åè·Ÿmeta åš xor è¿è¡Œã€‚ å¦‚æœ h2 å­˜åœ¨äº metadata ä¸­ã€‚é‚£ä¹ˆå¯¹åº”çš„bit å°±æ˜¯0b00000000 ï¼Œ metaMatchH2 çš„ä½œç”¨ï¼Œå¯ä»¥ç”¨ ä¸‹é¢çš„å•å…ƒæµ‹è¯•ç†è§£ï¼Œ nextMatch ç”¨äºç¡®å®š key åœ¨groupä¸­çš„çš„å…·ä½“ä½ç½®ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 func TestMetaMatchH2(t *testing.T) { metaData := make([]metadata, 2) metaData[0] = [8]int8{0x7f, 0, 0, 0x7f, 0, 0, 0, 0x7f} // Imitate ctrl m := \u0026amp;metaData[0] h := 0x7f metaUint64 := castUint64(m) h2Pattern := loBits * uint64(h) xorResult := metaUint64 ^ h2Pattern fmt.Printf(\u0026#34;metaUint64: %b\\n\u0026#34;, xorResult) r := hasZeroByte(xorResult) fmt.Printf(\u0026#34;r: %b\\n\u0026#34;, r) for r != 0 { fmt.Println(nextMatch(\u0026amp;r)) } } ---- output // metaUint64: 00000000 11111110 11111110 11111110 0000000 01111111 01111111 00000000 // r: 10000000 00000000 00000000 00000000 10000000 00000000 00000000 10000000 // 0 // 3 // 7 SwissTable çš„ä¼˜åŠ¿ çœ‹å®ŒSwissTableçš„å®ç°ï¼Œå¯ä»¥æ€»ç»“ä¸ºä¸‹é¢å‡ ç‚¹ï¼š\nå¯¹hashtableçš„æ“ä½œä»slotè½¬ç§»åˆ°äº†ctrlä¸Šï¼Œctrlæ›´å°æ›´å®¹æ˜“è¢«å¡«å…¥CPUçš„é«˜é€Ÿç¼“å­˜ï¼Œå› æ­¤æ¯”ç›´æ¥åœ¨slotä¸Šæ“ä½œæ›´å¿«ï¼Œå³ä½¿éœ€è¦å¤šä»˜å‡ºä¸€æ¬¡ä»ctrlå¾—åˆ°ç´¢å¼•åå†å»æŸ¥æ‰¾slotçš„ä»£ä»·ã€‚ è®°å½•å“ˆå¸Œç‰¹å¾å€¼ï¼Œå‡å°‘äº†æ— æ„ä¹‰çš„keyç­‰å€¼æ¯”è¾ƒï¼Œè¿™æ˜¯çº¿æ€§æ¢æµ‹æ³•æ€§èƒ½ä¸‹é™çš„ä¸»è¦å…ƒå‡¶ã€‚ å¯¹slotçš„æŸ¥æ‰¾å’Œæ“ä½œæ˜¯é€šè¿‡ctrlæ‰¹é‡è¿›è¡Œçš„ï¼Œå•ä½æ—¶é—´å†…ååé‡æœ‰æ˜¾è‘—æå‡ã€‚ æ ‡å¿—ä½çš„å€¼å’Œæ•´ä¸ªæ•°æ®ç»“æ„çš„å†…å­˜å¸ƒå±€éƒ½ä¸ºSIMDè¿›è¡Œäº†ä¼˜åŒ–ï¼Œå¯ä»¥å……åˆ†å‘æŒ¥æ€§èƒ½ä¼˜åŠ¿ã€‚ å¯¹slotä¹Ÿæœ‰ä¼˜åŒ–ï¼Œæ¯”å¦‚å¯¹å¤ªå¤§çš„æ•°æ®ä¼šå‹ç¼©å­˜å‚¨ä»¥æé«˜ç¼“å­˜å‘½ä¸­ç‡ã€‚\nswisstable è§£å†³äº†ç©ºé—´å±€éƒ¨æ€§é—®é¢˜çš„åŸºç¡€ä¸Šï¼Œè¿˜åˆ©ç”¨äº†ç°ä»£CPUçš„ç‰¹æ€§æ‰¹é‡æ“ä½œå…ƒç´ ï¼Œæ‰€ä»¥æ€§èƒ½ä¼šæœ‰é£è·ƒèˆ¬çš„æå‡ã€‚ æœ€ååœ¨æˆ‘æœ¬åœ°macbook m1 ï¼ˆä¸æ”¯æŒSIMDï¼‰ä¸Šè·‘benchmarkï¼Œç»“æœå¦‚ä¸‹ï¼Œåœ¨å¤§mapåœºæ™¯ä¸‹ï¼Œswisstable æ€§èƒ½æœ‰æ¯”è¾ƒæ˜æ˜¾çš„æå‡ã€‚\nFigure 5: swisstable å®˜æ–¹benchmark\næ€»ç»“ ç›®å‰go å®˜æ–¹è¿˜æ²¡æœ‰swisstable çš„å®ç°ï¼Œ ä½†æ˜¯å…³äºå®ƒçš„è®¨è®ºä¸€ç›´å†ç»§ç»­ï¼Œç›®å‰ç¤¾åŒºä¹Ÿæœ‰å‡ ç§å®ç°ã€‚æ¯”å¦‚concurrent-swiss-map ï¼Œswiss ç­‰ã€‚\nä¸è¿‡å®ç°éƒ½ä¸æ˜¯ç‰¹åˆ«å®Œç¾ï¼Œæ¯”å¦‚åœ¨å°map åœºæ™¯ä¸‹swisstable çš„æ€§èƒ½ç”šè‡³æ¯”ä¸ä¸Š runtime_map ç­‰ã€‚ä½†æ˜¯swisstable è¡¨ç°å‡ºæ¥çš„æ½œåŠ›å·²ç»åœ¨å…¶ä»–è¯­è¨€ä¸Šçš„è¡¨ç°ï¼Œè¯´æ˜å®ƒå€¼å¾—æˆ‘ä»¬æœŸå¾…ã€‚\nå‚è€ƒæ–‡æ¡£ dolthub https://www.dolthub.com/blog/2023-03-28-swiss-map/ swisstable åŸç† https://abseil.io/about/design/swisstables é¦–æ¬¡æå‡ºswisstableçš„cppconæ¼”è®²ï¼šhttps://www.youtube.com/watch?v=ncHmEUmJZf4 é’ˆå¯¹swisstableç®—æ³•çš„ä¸€äº›æ”¹è¿›ï¼šhttps://www.youtube.com/watch?v=JZE3_0qvrMg ä½è¿ç®—åŸç†: http://graphics.stanford.edu/~seander/bithacks.html##ValueInWord hash å‡½æ•°å¯¹æ¯”ï¼š https://aras-p.info/blog/2016/08/09/More-Hash-Function-Tests/ å¦å¤–ä¸€ç¯‡ä½è¿ç®—åŸç†çš„æ–‡ç«  https://lemire.me/blog/2016/06/27/a-fast-alternative-to-the-modulo-reduction/ ","date":"2024-09-30T11:25:51+08:00","image":"https://images.hxzhouh.com/blog-images/2024/09/f08c74aea8485d51d461d18494df416e.png","permalink":"https://huizhou92.com/zh-cn/p/swisstable-%E4%BC%9A%E6%88%90%E4%B8%BA-golang-std-map%E5%98%9B/","title":" SwissTable ä¼šæˆä¸º Golang std mapå˜›ï¼Ÿ"},{"content":"åœ¨è½¯ä»¶æ¶æ„ä¸­ï¼Œé™æµæ˜¯ä¸€ç§æ§åˆ¶èµ„æºä½¿ç”¨å’Œä¿æŠ¤ç³»ç»Ÿå®‰å…¨çš„é‡è¦æœºåˆ¶ã€‚å®ƒé€šè¿‡é™åˆ¶åœ¨ä¸€å®šæ—¶é—´å†…å¯ä»¥å¤„ç†çš„è¯·æ±‚æ•°é‡ï¼Œæ¥é˜²æ­¢ç³»ç»Ÿè¿‡è½½ï¼Œç¡®ä¿ç³»ç»Ÿåœ¨é«˜è´Ÿè½½æƒ…å†µä¸‹ä»èƒ½ä¿æŒç¨³å®šè¿è¡Œã€‚\næœ¬æ–‡çš„ç›®æ ‡æ˜¯åˆ†æå’Œå®ç°å‡ ç§å¸¸è§çš„é™æµç®—æ³•ï¼Œä»¥åŠåˆ†æä»–ä»¬ä¼˜ç¼ºç‚¹ã€‚æœ€åæˆ‘ä»¬æ¢è®¨ä¸€ä¸‹çœŸå®ä¸šåŠ¡ä»£ç ä¸­çš„ä¸€äº›é™æµè®¾è®¡ã€‚\nThis article was first published in the Medium MPP plan. If you are a Medium user, please follow me on Medium. Thank you very much.\nå‡è®¾æˆ‘ä»¬é€šè¿‡æ€§èƒ½æµ‹è¯•å¾—å‡ºæˆ‘ä»¬çš„ç³»ç»Ÿæœ€å¤§çš„è´Ÿè½½ä¸º10TPSã€‚\næµé‡è®¡æ•°å™¨æ¨¡å¼ æœ€ç®€å•çš„åšæ³•ï¼Œæˆ‘ä»¬åšä¸€ä¸ªè®¡æ—¶å™¨ï¼Œæ¯ç§’æœ€å¤šå…è®¸10ä¸ªè¯·æ±‚é€šè¿‡ï¼Œè¶…è¿‡è¿™ä¸ªæ•°é‡çš„æµé‡å°±æ‹’ç»ã€‚\nCode1 ï¼š windows limit run it\nhttps://gist.github.com/hxzhouh/51020e18622c2e38ebf21cd6a9dc5cc6\nä½†æ˜¯è¿™ä¸ªåšæ³•æ˜¯æœ‰é—®é¢˜çš„ï¼Œå‡è®¾æˆ‘ä»¬2ç§’å†…æ”¶åˆ°äº†éƒ½æ”¶åˆ°äº†10TPSè¯·æ±‚ï¼Œä½†æ˜¯æ˜¯åœ¨ 0.9s ä¸ 1.1s æ”¶åˆ°çš„ï¼Œè¿™æ ·è™½ç„¶æ¯ä¸ªå‘¨æœŸçš„æµé‡éƒ½ä¸è¶…è¿‡10 TPSè¯·æ±‚çš„é˜ˆå€¼ï¼Œä½†æ˜¯ç³»ç»Ÿç¡®å®æ›¾ç»åœ¨1så†…å‘ç”Ÿäº†è¶…è¿‡é˜ˆå€¼çš„20TPSè¯·æ±‚ã€‚\næµé‡è®¡æ•°å™¨çš„ç¼ºé™·æ ¹æºåœ¨äºå®ƒåªæ˜¯é’ˆå¯¹æ—¶é—´ç‚¹è¿›è¡Œç¦»æ•£çš„ç»Ÿè®¡ï¼Œä¸ºäº†å¼¥è¡¥è¯¥ç¼ºé™·ï¼Œä¸€ç§åä¸ºâ€œæ»‘åŠ¨æ—¶é—´çª—â€çš„é™æµæ¨¡å¼è¢«è®¾è®¡å‡ºæ¥ï¼Œå®ƒå¯ä»¥å®ç°å¹³æ»‘çš„åŸºäºæ—¶é—´ç‰‡æ®µç»Ÿè®¡ã€‚\næ»‘åŠ¨çª—å£æœºåˆ¶ æ»‘åŠ¨çª—å£ç®—æ³•(Sliding Window Algorithm)åœ¨è®¡ç®—æœºç§‘å­¦çš„å¾ˆå¤šé¢†åŸŸä¸­éƒ½æœ‰æˆåŠŸçš„åº”ç”¨ï¼Œè­¬å¦‚TCPåè®®çš„é˜»å¡æ§åˆ¶(Congestion Control)ä½¿ç”¨åˆ°æ»‘åŠ¨çª—å£ç®—æ³•\næ»‘åŠ¨çª—å£ç®—æ³•é€šè¿‡å°†æ—¶é—´åˆ†ä¸ºå¤šä¸ªå°çš„æ—¶é—´æ®µï¼Œæ¯ä¸ªæ—¶é—´æ®µå†…ç»´æŠ¤ä¸€ä¸ªç‹¬ç«‹çš„è®¡æ•°å™¨ã€‚å½“ä¸€ä¸ªè¯·æ±‚åˆ°è¾¾æ—¶ï¼Œå®ƒä¼šè¢«åˆ†é…åˆ°å½“å‰æ—¶é—´æ‰€åœ¨çš„å°æ—¶é—´æ®µï¼Œå¹¶æ£€æŸ¥è¯¥æ—¶é—´æ®µçš„è®¡æ•°å™¨æ˜¯å¦å·²è¾¾åˆ°é™åˆ¶ã€‚å¦‚æœæœªè¾¾åˆ°ï¼Œåˆ™å…è®¸è¯·æ±‚å¹¶å¢åŠ è®¡æ•°ï¼›å¦‚æœå·²è¾¾åˆ°ï¼Œåˆ™æ‹’ç»è¯·æ±‚ã€‚éšç€æ—¶é—´çš„æ¨ç§»ï¼Œæ—§çš„æ—¶é—´æ®µä¼šæ·¡å‡ºçª—å£ï¼Œæ–°çš„æ—¶é—´æ®µä¼šåŠ å…¥ã€‚\ncode2: sliding_windows try it\nhttps://gist.github.com/hxzhouh/c5c79ea4b80ea5a026052471de07107f\næ»‘åŠ¨çª—å£ç®—æ³•å…¶å®å°±æ˜¯æŠŠæµé‡è®¡æ•°å™¨ç®—æ³•çš„æ—¶é—´çª—å£åˆ’åˆ†å°ä¸€ç‚¹ï¼Œæä¾›æ›´ç»†è‡´çš„æµé‡æ§åˆ¶ï¼Œå¹¶ä¸èƒ½å®Œå…¨è§£å†³ç¬æ—¶å¤§æµé‡ã€‚ä¹Ÿå¾ˆéš¾åœ¨æ›´ç»†ç²’åº¦ä¸Šå¯¹æµé‡æ›²çº¿è¿›è¡Œæ•´å½¢ï¼Œèµ·ä¸åˆ°å‰Šå³°å¡«è°·çš„ä½œç”¨ã€‚ä¸‹é¢ç»§ç»­ä»‹ç»ä¸¤ç§é€‚ç”¨äºé˜»å¡å¼é™æµçš„é™æµæ¨¡å¼ã€‚\næ¼æ¡¶ç®—æ³• æ¼æ¡¶ç®—æ³•æ˜¯é€šè¿‡ä¸€ä¸ªå›ºå®šå®¹é‡çš„é˜Ÿåˆ—æ¥æ¨¡æ‹Ÿæ¡¶ï¼Œä»¥æ’å®šé€Ÿç‡ä»æ¡¶ä¸­å–å‡ºè¯·æ±‚è¿›è¡Œå¤„ç†ï¼Œæ— è®ºè¯·æ±‚åˆ°è¾¾çš„é¢‘ç‡å¦‚ä½•ï¼Œéƒ½ä¿è¯è¯·æ±‚ä»¥å‡åŒ€çš„é€Ÿåº¦è¢«å¤„ç†ï¼Œä»è€Œå¹³æ»‘æµé‡å¹¶é˜²æ­¢æµé‡çªå¢ã€‚\nCode3: leakBucket try it\nhttps://gist.github.com/hxzhouh/ba78993644ce58958127f64fc0976c55\næ¼æ¡¶ç®—æ³•é€‚ç”¨äºéœ€è¦å¼ºåˆ¶æ‰§è¡Œå›ºå®šé€Ÿç‡å¤„ç†çš„åœºæ™¯ï¼Œå¦‚ç½‘ç»œæµé‡æ§åˆ¶ã€APIè¯·æ±‚é™åˆ¶ç­‰ã€‚é€šè¿‡æ§åˆ¶ä»¤ç‰Œçš„æ·»åŠ é€Ÿç‡ï¼Œæ¼æ¡¶ç®—æ³•èƒ½å¤Ÿæœ‰æ•ˆåœ°é¿å…ç³»ç»Ÿå› ç¬æ—¶æµé‡é«˜å³°è€Œè¿‡è½½ã€‚æ¼æ¡¶å®ç°èµ·æ¥å¾ˆå®¹æ˜“ï¼Œéš¾ç‚¹åœ¨äºå¦‚ä½•ç¡®å®šæ¼æ¡¶çš„ä¸¤ä¸ªå‚æ•°ï¼šæ¡¶çš„å¤§å°å’Œæ°´çš„æµå‡ºé€Ÿç‡ã€‚å¦‚æœæ¡¶è®¾ç½®å¾—å¤ªå¤§ï¼Œé‚£æœåŠ¡ä¾ç„¶å¯èƒ½é­é‡æµé‡è¿‡å¤§çš„å†²å‡»ï¼Œä¸èƒ½å®Œå…¨å‘æŒ¥é™æµçš„ä½œç”¨ï¼›å¦‚æœè®¾ç½®å¾—å¤ªå°ï¼Œé‚£å¾ˆå¯èƒ½è¯¯æ€æ‰ä¸€éƒ¨åˆ†æ­£å¸¸çš„è¯·æ±‚ã€‚\nä»¤ç‰Œæ¡¶ç®—æ³• ä»¤ç‰Œæ¡¶ç®—æ³•è·Ÿæ¼æ¡¶ç®—æ³•æƒ³æ³•ï¼Œæ›´åƒç°å®ç”Ÿæ´»ä¸­çš„æ’é˜Ÿç®—æ³•ï¼Œç³»ç»Ÿä»¥å›ºå®šçš„é€Ÿç‡æ”¾å·ï¼Œæˆ‘ä»¬é¦–å…ˆè¦å–å·ï¼Œç„¶åå†è¿›è¡Œä¸šåŠ¡å¤„ç†ã€‚ å‡è®¾æˆ‘ä»¬è¦é™åˆ¶ç³»ç»Ÿåœ¨Xç§’å†…æœ€å¤§è¯·æ±‚æ¬¡æ•°ä¸è¶…è¿‡Yï¼Œé‚£å°±æ¯é—´éš”X/Yæ—¶é—´å¾€æ¡¶ä¸­æ”¾ä¸€ä¸ªä»¤ç‰Œï¼Œå½“æœ‰è¯·æ±‚è¿›æ¥æ—¶ï¼Œé¦–å…ˆè¦ä»æ¡¶ä¸­å–å¾—ä¸€ä¸ªå‡†å…¥çš„ä»¤ç‰Œï¼Œç„¶åæ‰èƒ½è¿›å…¥ç³»ç»Ÿè¿›è¡Œå¤„ç†ã€‚å¦‚æœè·å–ä¸åˆ°ä»¤ç‰Œå°±è¿”å›è¯·æ±‚å¤±è´¥ã€‚\nCode 4 ï¼štoken_limit try it https://gist.github.com/hxzhouh/0c172824334aeea5ef101bd682fef59e\nä»¤ç‰Œæ¡¶ç®—æ³•é€‚ç”¨äºéœ€è¦å¤„ç†çªå‘æµé‡çš„åœºæ™¯ï¼Œå¦‚ç½‘ç»œé€šä¿¡ã€APIè°ƒç”¨ç­‰ã€‚é€šè¿‡æ§åˆ¶ä»¤ç‰Œçš„å¡«å……é€Ÿç‡å’Œæ¡¶çš„å®¹é‡ï¼Œä»¤ç‰Œæ¡¶ç®—æ³•èƒ½å¤Ÿæœ‰æ•ˆåœ°å¹³è¡¡æµé‡ï¼Œé˜²æ­¢ç³»ç»Ÿè¿‡è½½ï¼ŒåŒæ—¶ å¦‚æœç³»ç»Ÿèµ„æºå¯Œè£•çš„æƒ…å†µä¸‹ï¼Œå…è®¸åœ¨çŸ­æœŸå†…å¤„ç†æ›´å¤šçš„è¯·æ±‚ã€‚è·Ÿæ¼æ¡¶ç®—æ³•ç±»ä¼¼ï¼Œä»¤ç‰Œç”Ÿæˆçš„é€Ÿåº¦ï¼Œä¹Ÿæ˜¯éœ€è¦é‡ç‚¹è€ƒè™‘çš„ã€‚\nå®é™…ä¸šåŠ¡ä¸­çš„é™æµç®—æ³• åˆ†å¸ƒå¼é™æµç®—æ³• ä¸Šé¢ä»‹ç»çš„å››ä¸ªé™æµç®—æ³•ï¼ŒçŠ¶æ€éƒ½æ˜¯å­˜å‚¨åœ¨å†…å­˜ä¸­çš„ï¼Œæˆ‘ä»¬å¯ä»¥ç†è§£ä¸ºå•æœºé™æµç®—æ³•ï¼Œå¾®æœåŠ¡æ¶æ„ä¸‹ï¼Œå®ƒä»¬å°±æœ€å¤šåªèƒ½åº”ç”¨äºé›†ç¾¤æœ€å…¥å£å¤„çš„ç½‘å…³ä¸Šï¼Œå¯¹æ•´ä¸ªæœåŠ¡é›†ç¾¤è¿›è¡Œæµé‡æ§åˆ¶ï¼Œæ— æ³•ç»†ç²’åº¦åœ°ç®¡ç†æµé‡åœ¨å†…éƒ¨å¾®æœåŠ¡èŠ‚ç‚¹ä¸­çš„æµè½¬æƒ…å†µã€‚å¦‚æœæˆ‘ä»¬éœ€è¦å®ç°ä¸€ä¸ªæœåŠ¡çš„å¤šä¸ªèŠ‚ç‚¹ä¹‹é—´ååŒé™æµï¼Œé‚£ä¹ˆæˆ‘ä»¬éœ€è¦å°†çŠ¶æ€ä¿å­˜åœ¨é›†ç¾¤ä¸­å…±äº«ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªä½¿ç”¨Redis å®ç°åˆ†å¸ƒå¼ ä»¤ç‰Œæ¡¶ç®—æ³•çš„å®ç°ã€‚å®é™…ä¸Šï¼Œæˆ‘åœ¨ä¸šåŠ¡ä¸­ä½¿ç”¨æ›´å¤šçš„æ˜¯è¿™ç§æ–¹å¼ã€‚\nä¼˜å…ˆçº§ æœåŠ¡å™¨èµ„æºæ˜¯å®è´µçš„ï¼Œå†èµ„æºç´§å¼ çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬æ›´åŠ å¸Œæœ›å®è´µçš„èµ„æºç”¨äºæœåŠ¡æˆ‘ä»¬çš„vipå®¢æˆ·ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥è®¾è®¡ä¸€ç§åŸºäºâ€œè´§å¸åŒ–é¢åº¦â€çš„åˆ†å¸ƒå¼é™æµæ–¹æ¡ˆã€‚ä¸åŒäºä¼ ç»Ÿä»¤ç‰Œæ¡¶ç®—æ³•ä¸­çš„â€œå‡†å…¥/æ‹’ç»â€äºŒå…ƒåˆ¤å®šæ–¹å¼ï¼Œè¿™é‡Œçš„â€œè´§å¸é¢åº¦â€æ˜¯ä¸€ç§æ›´çµæ´»çš„é™æµæ–¹å¼ã€‚ç”¨æˆ·åœ¨è®¿é—®é›†ç¾¤ä¸­çš„æœåŠ¡æ—¶ï¼Œæ¯æ¬¡éƒ½ä¼šæ¶ˆè€—ä¸€å®šçš„é¢åº¦ï¼Œç±»ä¼¼äºæ¶ˆè€—èµ„æºçš„â€œè´§å¸â€ï¼Œå¹¶ä¸”å¯ä»¥æ ¹æ®ç”¨æˆ·çš„ç­‰çº§åˆ†é…ä¸åŒçš„é¢åº¦ã€‚VIPç”¨æˆ·å¯èƒ½æ‹¥æœ‰æ›´é«˜çš„é¢åº¦ï¼Œæ™®é€šç”¨æˆ·åˆ™æœ‰ä¸€å®šçš„é¢åº¦é™åˆ¶ã€‚å½“é¢åº¦è€—å°½åï¼Œç”¨æˆ·éœ€è¦é‡æ–°å‘â€œä»¤ç‰Œæ¡¶â€ç”³è¯·é¢åº¦ï¼Œæ‰èƒ½ç»§ç»­è®¿é—®ã€‚\ncode 5: quota try it\nhttps://gist.github.com/hxzhouh/dc06a2947f4d436bdce9743d65b6c9e6\nç»“è®º æœ¬æ–‡ä»‹ç»äº†å‡ ç§å¸¸è§çš„é™æµç®—æ³•ï¼ŒåŒ…æ‹¬æµé‡è®¡æ•°å™¨ã€æ»‘åŠ¨çª—å£ã€æ¼æ¡¶ã€ä»¤ç‰Œæ¡¶ç­‰ï¼Œå¹¶åˆ†æäº†å®ƒä»¬åœ¨ä¸åŒåœºæ™¯ä¸‹çš„åº”ç”¨æ•ˆæœã€‚æµé‡è®¡æ•°å™¨ç®—æ³•ç®€å•æ˜“ç”¨ï¼Œä½†æ— æ³•åº”å¯¹ç¬æ—¶é«˜å³°æµé‡ï¼Œæ»‘åŠ¨çª—å£ç®—æ³•åœ¨ä¸€å®šç¨‹åº¦ä¸Šå¼¥è¡¥äº†è¿™ä¸€ç¼ºé™·ã€‚æ¼æ¡¶ç®—æ³•é€šè¿‡å›ºå®šé€Ÿç‡å¤„ç†è¯·æ±‚ï¼Œé€‚åˆéœ€è¦å¹³æ»‘æµé‡çš„åœºæ™¯ï¼Œè€Œä»¤ç‰Œæ¡¶ç®—æ³•åˆ™èƒ½å¤Ÿçµæ´»å¤„ç†çªå‘æµé‡ï¼Œå¹¶å…è®¸ç³»ç»Ÿåœ¨çŸ­æ—¶é—´å†…æ¥æ”¶æ›´å¤šè¯·æ±‚ã€‚\nåœ¨å®é™…ä¸šåŠ¡ä¸­ï¼Œå°¤å…¶æ˜¯å¾®æœåŠ¡æ¶æ„ä¸‹ï¼Œåˆ†å¸ƒå¼é™æµæ˜¯éå¸¸é‡è¦çš„ã€‚é€šè¿‡ Redis ç­‰ä¸­é—´ä»¶çš„ååŒï¼Œåˆ†å¸ƒå¼ä»¤ç‰Œæ¡¶ç®—æ³•èƒ½æœ‰æ•ˆç®¡ç†å¤šä¸ªèŠ‚ç‚¹çš„æµé‡ã€‚æ­¤å¤–ï¼ŒåŸºäºä¼˜å…ˆçº§çš„â€œè´§å¸åŒ–é¢åº¦â€æ–¹æ¡ˆä¸ºé™æµè®¾è®¡æä¾›äº†æ›´å¤šçµæ´»æ€§ï¼Œæœ‰åŠ©äºæå‡ VIP å®¢æˆ·ä½“éªŒã€‚é™æµæœºåˆ¶ä¸ä»…èƒ½å¤Ÿä¿æŠ¤ç³»ç»Ÿå…å—è¿‡è½½ï¼Œè¿˜èƒ½æå‡ç³»ç»Ÿçš„æ•´ä½“ç¨³å®šæ€§ä¸æ€§èƒ½ã€‚\nå‚è€ƒæ–‡æ¡£ [1] é™æµè®¾è®¡æ¨¡å¼\n","date":"2024-09-25T09:34:59+08:00","image":"https://images.hxzhouh.com/blog-images/2024/09/f146e1aedafc425732135df81c5cd244.png","permalink":"https://huizhou92.com/zh-cn/p/%E5%B8%B8%E8%A7%81%E9%99%90%E9%80%9F%E7%AE%97%E6%B3%95%E7%9A%84%E5%88%86%E6%9E%90%E4%B8%8E%E5%AE%9E%E7%8E%B0/","title":"å¸¸è§é™é€Ÿç®—æ³•çš„åˆ†æä¸å®ç°"},{"content":"èƒŒæ™¯ JSONæ˜¯ä¸€ç§è½»é‡çº§çš„æ•°æ®äº¤æ¢æ ¼å¼ï¼ŒGo è¯­è¨€çš„ encoding/json åŒ…è‡ªè¯ç”Ÿä»¥æ¥å·²æœ‰åå¹´ä¹‹ä¹…ï¼Œå®ƒå‡­å€Ÿå…¶çµæ´»çš„ç‰¹æ€§èµ¢å¾—äº†å¼€å‘è€…çš„é’çã€‚å¼€å‘è€…å¯ä»¥é€šè¿‡ç»“æ„ä½“æ ‡ç­¾è‡ªå®šä¹‰å­—æ®µçš„ JSON è¡¨ç°å½¢å¼ï¼Œä¹Ÿå¯ä»¥è®© Go ç±»å‹è‡ªå®šä¹‰å…¶åœ¨ JSON ä¸­çš„è¡¨ç°å½¢å¼ã€‚ç„¶è€Œï¼Œéšç€ Go è¯­è¨€å’Œ JSON æ ‡å‡†çš„å‘å±•ï¼Œä¸€äº›åŠŸèƒ½ä¸Šçš„ç¼ºå¤±å’Œæ€§èƒ½ä¸Šçš„é™åˆ¶é€æ¸æš´éœ²å‡ºæ¥ã€‚\nåŠŸèƒ½ç¼ºå¤±ï¼šæ¯”å¦‚ï¼Œä¸èƒ½æŒ‡å®šÂ time.TimeÂ ç±»å‹çš„è‡ªå®šä¹‰æ ¼å¼åŒ–ï¼Œä¸èƒ½åœ¨åºåˆ—åŒ–æ—¶çœç•¥ç‰¹å®šçš„ Go å€¼ç­‰ã€‚ API ç¼ºé™·ï¼šæ¯”å¦‚ï¼Œæ²¡æœ‰ç®€å•çš„æ–¹æ³•æ¥æ­£ç¡®åœ°ä»Â io.ReaderÂ ä¸­ååºåˆ—åŒ– JSONã€‚ æ€§èƒ½é™åˆ¶ï¼šæ ‡å‡†jsonåŒ…çš„æ€§èƒ½è¡¨ç°å¹¶ä¸å°½å¦‚äººæ„ï¼Œç‰¹åˆ«æ˜¯åœ¨å¤„ç†å¤§é‡æ•°æ®æ—¶ã€‚ è¡Œä¸ºç¼ºé™·ï¼šæ¯”å¦‚ï¼Œå¯¹ JSON è¯­æ³•çš„é”™è¯¯å¤„ç†ä¸å¤Ÿä¸¥æ ¼ï¼Œå¤§å°å†™ä¸æ•æ„Ÿçš„ååºåˆ—åŒ–ç­‰ã€‚ å°±åƒmath/v2ä¸€æ ·çš„ï¼ŒGo å®˜æ–¹æå‡ºencoding/json/v2 æ¥è§£å†³ä¸Šé¢çš„é‚£äº›é—®é¢˜ï¼Œæœ¬æ–‡ä¸»è¦ç›®æ ‡æ˜¯åˆ†æenable/jsonä¸­ å…³äºç©ºå€¼çš„ä¸€äº›é—®é¢˜ã€‚ä»¥åŠå®ƒåœ¨ encoding/json/v2ä¸­æ˜¯å¦‚ä½•è¢«è§£å†³çš„ã€‚æœ¬æ–‡ä¸æ¶‰åŠ encoding/json/v2 ä¸­å…¶ä»–çš„ä¿®æ”¹\nThis article was first published in the Medium MPP plan. If you are a Medium user, please follow me on Medium. Thank you very much.\nomitempty åœ¨encoding/jsonåŒ…ä¸­ï¼Œæœ‰è¿™æ ·å…³äºomitemptyçš„æè¿°:\nThe \u0026ldquo;omitempty\u0026rdquo; option specifies that the field should be omitted from the encoding if the field has an empty value, defined as false, 0, a nil pointer, a nil interface value, and any empty array, slice, map, or string.\nä½†æ˜¯ï¼Œè¿™ç§é¢„å®šä¹‰çš„â€ç©ºâ€å€¼åˆ¤æ–­é€»è¾‘å¹¶ä¸èƒ½æ»¡è¶³æ‰€æœ‰å®é™…åœºæ™¯çš„éœ€æ±‚ã€‚æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 type Post struct { Id int64 `json:\u0026#34;id,omitempty\u0026#34;` CreateTime time.Time `json:\u0026#34;create_time,omitempty\u0026#34;` TagList []Tag `json:\u0026#34;tag_list,omitempty\u0026#34;` Name string `json:\u0026#34;name,omitempty\u0026#34;` Score float64 `json:\u0026#34;score,omitempty\u0026#34;` Category Category `json:\u0026#34;category,omitempty\u0026#34;` LikePost map[string]Post `json:\u0026#34;like,omitempty\u0026#34;` } type Tag struct { ID string `json:\u0026#34;id\u0026#34;` Name string `json:\u0026#34;name\u0026#34;` } type Category struct { ID float64 `json:\u0026#34;id\u0026#34;` Name string `json:\u0026#34;name\u0026#34;` } func main() { b, _ := json.Marshal(new(Post)) fmt.Println(string(b)) } è¾“å‡ºç»“æœä¸ºï¼š\n1 {\u0026#34;create_time\u0026#34;:\u0026#34;0001-01-01T00:00:00Z\u0026#34;,\u0026#34;category\u0026#34;:{\u0026#34;id\u0026#34;:0,\u0026#34;name\u0026#34;:\u0026#34;\u0026#34;}} è™½ç„¶Post å„ä¸ªå­—æ®µéƒ½æ·»åŠ äº†omitempty ã€‚ä½†æ˜¯ç»“æœå¹¶ä¸åƒæˆ‘ä»¬é¢„æœŸä¸€æ ·ã€‚\nomitempty ä¸èƒ½å¤„ç†ç©º struct ï¼Œæ¯”å¦‚ Post.Category omitempty å¤„ç†time.Time çš„æ–¹å¼ä¸æ˜¯ æˆ‘ä»¬ç†è§£çš„UTC =0ï¼Œä¹Ÿå°±æ˜¯1970-01-01 00:00:00 ,è€Œæ˜¯ 0001-01-01T00:00:00Z ã€‚ omitzeroæ ‡ç­¾ åœ¨ encoding/json/v2 ä¸­ï¼Œä¼šæ·»åŠ ä¸€ä¸ªæ–°çš„æ ‡ç­¾ omitzeroï¼Œæ·»åŠ äº†ä¸¤ä¸ªåŠŸèƒ½ï¼Œæ¥è§£å†³ä¸Šé¢çš„ä¸¤ä¸ªé—®é¢˜ã€‚ï¼ˆç›®å‰è¿™ä¸ªåŠŸèƒ½è¿˜åœ¨å¼€å‘ä¸­ï¼Œä¸è¿‡å¯ä»¥é€šè¿‡go-json-experiment/jsonæå‰ä½“éªŒæ–°åŠŸèƒ½ï¼‰\næ›´å¥½çš„time.Time å¤„ç†ã€‚ æ”¯æŒè‡ªå®šä¹‰IsZeroå‡½æ•°ã€‚\næ¯”å¦‚ä¸‹é¢ä¸‹é¢çš„ä»£ç ï¼š 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 package main import ( \u0026#34;encoding/json\u0026#34; \u0026#34;fmt\u0026#34; v2_json \u0026#34;github.com/go-json-experiment/json\u0026#34; \u0026#34;math\u0026#34; \u0026#34;time\u0026#34;) type Post struct { Id int64 `json:\u0026#34;id,omitempty,omitzero\u0026#34;` CreateTime time.Time `json:\u0026#34;create_time,omitempty,omitzero\u0026#34;` TagList []Tag `json:\u0026#34;tag_list,omitempty\u0026#34;` Name string `json:\u0026#34;name,omitempty\u0026#34;` Score ScoreType `json:\u0026#34;score,omitempty,omitzero\u0026#34;` Category Category `json:\u0026#34;category,omitempty,omitzero\u0026#34;` LikePost map[string]Post `json:\u0026#34;like,omitempty\u0026#34;` } type ScoreType float64 func (s ScoreType) IsZero() bool { return s \u0026lt; math.MinInt64 } type Tag struct { ID string `json:\u0026#34;id\u0026#34;` Name string `json:\u0026#34;name\u0026#34;` } type Category struct { ID float64 `json:\u0026#34;id\u0026#34;` Name string `json:\u0026#34;name\u0026#34;` } func main() { v1String, _ := json.Marshal(new(Post)) fmt.Println(string(v1String)) v2String, _ := v2_json.Marshal(new(Post)) fmt.Println(string(v2String)) } è·Ÿencoding/json ç›¸æ¯” encoding/json/v2 è§£å†³äº†ä¸Šé¢æåˆ°çš„é—®é¢˜ã€‚\n1 2 {\u0026#34;create_time\u0026#34;:\u0026#34;0001-01-01T00:00:00Z\u0026#34;,\u0026#34;category\u0026#34;:{\u0026#34;id\u0026#34;:0,\u0026#34;name\u0026#34;:\u0026#34;\u0026#34;}} {\u0026#34;score\u0026#34;:0} ç»“è®º é€šè¿‡å¼•å…¥omitzeroæ ‡ç­¾ï¼ŒGoè¯­è¨€åœ¨è§£å†³JSONç¼–ç ä¸­â€ç©ºâ€å€¼å¤„ç†çš„ç—›ç‚¹ä¸Šè¿ˆå‡ºäº†é‡è¦ä¸€æ­¥ã€‚è¿™ä¸ªæ–¹æ¡ˆä¸ä»…æ»¡è¶³äº†å¼€å‘è€…å¯¹æ›´çµæ´»çš„â€ç©ºâ€å€¼å®šä¹‰çš„éœ€æ±‚ï¼Œè¿˜ä¿æŒäº†ä¸ç°æœ‰ç³»ç»Ÿçš„å…¼å®¹æ€§ã€‚ç›®å‰è¯¥omitzeroçš„è½åœ°æ—¶é—´å°šæœªç¡®å®šï¼Œæœ€æ—©ä¹Ÿè¦ç­‰åˆ°Go 1.24ç‰ˆæœ¬ã€‚æ­¤å¤–ï¼Œencoding/xmlç­‰ä¹Ÿä¼šæ•ˆä»¿jsonåŒ…ï¼Œå¢åŠ omitzeroæ ‡ç­¾ã€‚\nencoding/json/v2 è¿˜åŒ…æ‹¬ æ€§èƒ½ç­‰å…¶ä»–æ–¹é¢çš„æ›´æ–°ï¼Œ æœ‰å…´è¶£çš„Gopher å¯ä»¥ æå‰äº†è§£è¿™äº›æ”¹åŠ¨ï¼Œæœ¬åšå®¢ä¹Ÿä¼šä¸€ç›´å…³æ³¨è¿™ä¸ªproposal\nGoè¯­è¨€å¼€å§‹èµ°å‘æˆç†Ÿã€‚\n","date":"2024-09-15T10:05:57+08:00","image":"https://images.hxzhouh.com/blog-images/2024/09/5cfcc61c5e45994e3e35ceb82bfa6bc8.png","permalink":"https://huizhou92.com/zh-cn/p/go-%E6%8F%90%E6%A1%88-json-v2-%E6%9D%A5%E4%BA%86/","title":"Go ææ¡ˆ: JSON v2 æ¥äº†"},{"content":"åœ¨[ä¸Šä¸€ç¯‡](013 ä¸¤ä¸ªæœ‰ç”¨çš„ Golang æ— é”ç¼–ç¨‹æŠ€å·§.zh-cn)æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬è®¨è®ºäº†ä¸¤ä¸ªæ— é”ç¼–ç¨‹æ€æƒ³ã€‚æ€»ç»“å°±æ˜¯ï¼šé€šè¿‡ç²¾å¿ƒçš„è®¾è®¡æ¶ˆé™¤æ•°æ®å…±äº«æˆ–è€…æ¶ˆé™¤å¹¶å‘è®¿é—®åŒä¸€ä¸ªæ•°æ®ã€‚å°½ç®¡æˆ‘ä»¬ä¸€ç›´æƒ³è¿½æ±‚å®Œå…¨çš„æ— é”ç¼–ç¨‹ï¼Œä½†äº‹å®æ˜¯è¿™åŸºæœ¬ä¸å¯èƒ½ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œæˆ‘ä»¬è®¨è®ºlook-freeï¼Œæ˜¯å› ä¸ºæƒ³è¦é¿å…åŠ é”ï¼Œé‚£ä¹ˆä½¿ç”¨CASæ˜¯ä¸€ç§ä¸é”™çš„é€‰æ‹©ã€‚å¦‚æœCAS éƒ½ä¸èƒ½å¤Ÿæ»¡è¶³è¦æ±‚ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥å°½é‡å°†Mutex çš„ç²’åº¦ç¼©å°ï¼Œæˆ–è€…ä½¿ç”¨RWmutex æ›¿æ¢Mutexç­‰ã€‚\nlock-freeçš„ä¼˜åŠ¿ï¼š\nå‡å°‘çº¿ç¨‹é˜»å¡å’Œç­‰å¾…æ—¶é—´ é¿å…çº¿ç¨‹çš„ä¼˜å…ˆçº§åè½¬ æé«˜å¹¶å‘æ€§èƒ½ æ¶ˆé™¤ç«æ€æ¡ä»¶ï¼ˆrace conditionï¼‰ã€æ­»é”ã€é¥¿æ­»ç­‰æ½œåœ¨é—®é¢˜ ä»£ç æ›´åŠ æ¸…æ™°æ˜“æ‡‚\næœ¬æ–‡æˆ‘ä»¬å°†ä½¿ç”¨Goå®è·µä¸€ä¸‹å‡ ç§lock-freeç¼–ç¨‹çš„æ–¹æ¡ˆã€‚ channel Share Memory By Communicating æ˜¯Goè¯­è¨€å®˜æ–¹æ¨èçš„å…±äº«å†…å­˜æ–¹æ¡ˆï¼š\nä¸è¦é€šè¿‡å…±äº«å†…å­˜è¿›è¡Œé€šä¿¡ï¼›ç›¸åï¼Œé€šè¿‡é€šä¿¡æ¥å…±äº«å†…å­˜ã€‚\nchannelå®ç° lock-free çš„ åŸå› æ˜¯\nchannel å°†æ•°æ®æ‰€æœ‰å…¨äº¤å‡ºå»äº† channel å†…éƒ¨ä½¿ç”¨äº†é”\nåœ¨å®˜æ–¹åšå®¢çš„ä¾‹å­ä¸­ 1 2 3 4 5 6 7 8 9 type Resource string func Poller(in, out chan *Resource) { for r := range in { // poll the URL // send the processed Resource to out out \u0026lt;- r } } æ•°æ®é€šè¿‡ inï¼Œout ä¸¤ä¸ªchannel æµè½¬ï¼Œä¸å­˜åœ¨åŒä¸€ä¸ªæ—¶é—´æœ‰å¤šä¸ªgoroutine åŒæ—¶æ“ä½œä¸€ä»½æ•°æ®ï¼Œæ‰€ä»¥è¿™å°±æ˜¯lock-freeã€‚\nCAS ç°åœ¨å‡ ä¹æ‰€æœ‰çš„ CPU æŒ‡ä»¤éƒ½æ”¯æŒÂ CASÂ çš„åŸå­æ“ä½œï¼Œ\nCASÂ (compare and swap) æ˜¯åŸå­æ“ä½œçš„ä¸€ç§ï¼Œç”¨äºåœ¨å¤šçº¿ç¨‹ä¸­å®ç°åŸå­æ•°æ®äº¤æ¢ï¼Œé¿å…å¤šçº¿ç¨‹åŒæ—¶æ”¹å†™æŸä¸€å…±äº«æ•°æ®æ—¶ï¼Œç”±äºæ‰§è¡Œé¡ºåºä¸ç¡®å®šæ€§ä»¥åŠä¸­æ–­çš„ä¸å¯é¢„çŸ¥æ€§äº§ç”Ÿçš„æ•°æ®ä¸ä¸€è‡´é—®é¢˜ã€‚æˆ‘ä»¬å¯ä»¥ç›´æ¥ç”¨Â CASÂ æ¥å®ç°Â lock freeçš„æ•°æ®ç»“æ„ã€‚\nå¦‚æœæˆ‘ä»¬è¦å®ç°ä¸€ä¸ªstack æ•°æ®ç»“æ„ï¼Œæœ€å¸¸ç”¨çš„æ–¹æ¡ˆå°±æ˜¯ä½¿ç”¨slice+ RWmutex ,ä¿è¯å¹¶å‘å®‰å…¨ï¼Œ åŒæ—¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨CASæ¥å®ç° è¿™ä¸ªæ•°æ®ç»“æ„ï¼Œå®Œæ•´çš„ ä»£ç å¦‚ä¸‹ï¼š\né€šè¿‡ç®€å•çš„benchmark æµ‹è¯•ï¼Œ lock-free ç‰ˆæœ¬çš„ stack è¦æ¯” slice+ RWmutex å¿«å¤§çº¦20%ï¼Œå¦‚æœæ˜¯åœ¨å¹¶å‘åœºæ™¯ä¸‹ï¼Œlock-free çš„æ€§èƒ½è¡¨ç°å¯èƒ½è¿˜ä¼šæ›´å¥½ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 func BenchmarkConcurrentPushLockFree(b *testing.B) { stack := NewStackByLockFree() for i := 0; i \u0026lt; b.N; i++ { stack.Push(i) } } func BenchmarkConcurrentPushSlice(b *testing.B) { stack := NewStackBySlice() for i := 0; i \u0026lt; b.N; i++ { stack.Push(i) } } 1 2 3 4 âœ lock-free git:(main) âœ— go test --bench=. BenchmarkConcurrentPushLockFree-10 22657522 49.66 ns/op BenchmarkConcurrentPushSlice-10 29135671 59.04 ns/op Struct Copy ä»æœ¬è´¨ä¸Šè®²Struct Copy æ˜¯ä¸€ç§ç©ºé—´æ¢æ—¶é—´çš„ç­–ç•¥ã€‚å¦‚ä¸‹é¢çš„ä»£ç æ‰€ç¤ºï¼š\nSingleBuffer æ˜¯ä¸€ä¸ªå…±äº«èµ„æºï¼Œå¤–éƒ¨ä»£ç æ¯æ¬¡ä½¿ç”¨å®ƒçš„æ—¶å€™éœ€è¦åŠ é”ï¼Œ ä½†æ˜¯å¦‚æœç”¨ä¸€ä¸ªBufferWrapper å°†å®ƒåŒ…è£¹èµ·æ¥ï¼Œè®©æ¯ä¸ªgoroutine æŒæœ‰ä¸€ä¸ªå•ç‹¬çš„BufferWrapperï¼Œé‚£ä¹ˆæ˜¯ä¸æ˜¯ä¸ç”¨å»è€ƒè™‘dataracingäº†ï¼Ÿ ï¼ˆä½¿ç”¨sync.poolæ˜¯ä¸ºäº†å‡å°‘å†…å­˜åˆ†é…ï¼‰\næ€§èƒ½æµ‹è¯•\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 func BenchmarkSingleBuffer_print(b *testing.B) { for i := 0; i \u0026lt; b.N; i++ { run_buff_bench(singleBuff) } } func BenchmarkBufferWrapper_print(b *testing.B) { bufferWrapper := NewBufferWrapper() for i := 0; i \u0026lt; b.N; i++ { run_buff_bench(bufferWrapper) } } func run_buff_bench(buff printId) { wg := sync.WaitGroup{} f := func(id int) { defer wg.Done() for j := 0; j \u0026lt; 10000; j++ { buff.print(id) } } for j := 0; j \u0026lt; 100; j++ { wg.Add(1) go f(j) } wg.Wait() } 1 2 BenchmarkSingleBuffer_print-10 4 261640427 ns/op BenchmarkBufferWrapper_print-10 67 18320110 ns/op fastjson çš„ Parser ä¹Ÿæ˜¯å¦‚æ­¤åšçš„ï¼Œ æˆ‘ä»¬åœ¨å¾ˆå¤šæ€§èƒ½ä¼˜åŒ–åœºæ™¯ä¸‹éƒ½èƒ½è§åˆ°è¿™ç§æ“ä½œã€‚\næ€»ç»“ æœ¬ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬æ¢è®¨äº†ä¸‰ç§å®ç° lock-free ç¼–ç¨‹çš„æ–¹æ³•ï¼Œå¹¶é€šè¿‡å®é™…çš„ä»£ç å’Œæ€§èƒ½æµ‹è¯•éªŒè¯äº†å®ƒä»¬çš„æœ‰æ•ˆæ€§ã€‚å°½ç®¡å®Œå…¨å®ç°æ— é”ç¼–ç¨‹æ˜¯ä¸€ä¸ªè‰°éš¾çš„ç›®æ ‡ï¼Œä½†é€šè¿‡åˆç†çš„è®¾è®¡å’ŒæŠ€æœ¯é€‰å‹ï¼Œå¯ä»¥æ˜¾è‘—å‡å°‘é”çš„ä½¿ç”¨ï¼Œæé«˜ç³»ç»Ÿçš„å¹¶å‘æ€§èƒ½ã€‚åœ¨å®é™…å¼€å‘ä¸­ï¼Œåº”è¯¥æ ¹æ®å…·ä½“åœºæ™¯é€‰æ‹©åˆé€‚çš„æ–¹æ¡ˆï¼Œæ¯”å¦‚åœ¨æ€§èƒ½æ•æ„Ÿçš„åœºæ™¯ä¸‹ï¼Œå¯ä»¥ä¼˜å…ˆè€ƒè™‘ CAS å’Œ Struct Copyï¼›åœ¨æ•°æ®æµè½¬æ¸…æ™°ã€æ“ä½œç®€å•çš„åœºæ™¯ä¸­ï¼ŒChannel æ˜¯ä¸€ç§éå¸¸è‡ªç„¶çš„é€‰æ‹©ã€‚\n","date":"2024-09-09T09:46:47+08:00","permalink":"https://huizhou92.com/zh-cn/p/go-%E9%AB%98%E6%80%A7%E8%83%BD%E7%BC%96%E7%A8%8Bep11-lock-free-%E5%AE%9E%E8%B7%B5.zh-cn/","title":"go é«˜æ€§èƒ½ç¼–ç¨‹EP11 lock-free å®è·µ.zh-cn"},{"content":"æœ€è¿‘å‘ç° Golang æ ‡å‡†åº“ç«Ÿç„¶è‡ªå¸¦äº† varint çš„å®ç°ï¼Œä»£ç ä½ç½®åœ¨Â encoding/binary/varint.goï¼Œè¿™ä¸ªè·Ÿprotobufé‡Œé¢çš„varintå®ç°åŸºæœ¬æ˜¯ä¸€è‡´çš„ã€‚åˆšå¥½å€ŸåŠ© golang æ ‡å‡†åº“çš„ varint æºç ï¼Œæˆ‘ä»¬æ¥ç³»ç»Ÿåœ°å­¦ä¹ å’Œæ¢³ç†ä¸‹ varintã€‚\nç†Ÿæ‚‰ protobuf çš„äººè‚¯å®šå¯¹ varint ä¸é™Œç”Ÿï¼Œprotobuf é‡Œé¢é™¤äº†å¸¦ fix (å¦‚ fixed32ã€fixed64) ä¹‹å¤–çš„æ•´æ•°ç±»å‹, éƒ½æ˜¯ varint ç¼–ç ã€‚\nvarint çš„å‡ºç°ä¸»è¦æ˜¯ä¸ºäº†è§£å†³ä¸¤ä¸ªé—®é¢˜ï¼š\nç©ºé—´æ•ˆç‡ï¼šä»¥ uint64 ç±»å‹ä¸ºä¾‹ï¼Œå¯ä»¥è¡¨ç¤ºçš„æœ€å¤§å€¼ä¸º 18446744073709551615ã€‚ç„¶è€Œåœ¨å®é™…ä¸šåŠ¡åœºæ™¯ä¸­ï¼Œæˆ‘ä»¬é€šå¸¸å¤„ç†çš„æ•´æ•°å€¼è¿œå°äº uint64 çš„æœ€å¤§å€¼ã€‚å‡è®¾åœ¨æˆ‘ä»¬çš„ä¸šåŠ¡ä¸­ï¼Œéœ€è¦å¤„ç†çš„æ•´æ•°å€¼ä»…ä¸º 1ï¼Œä½†åœ¨ç½‘ç»œä¼ è¾“è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å´éœ€è¦ä½¿ç”¨ 8 ä¸ªå­—èŠ‚æ¥è¡¨ç¤ºè¿™ä¸ªå€¼ã€‚è¿™å°±å¯¼è‡´äº†å¤§é‡çš„ç©ºé—´æµªè´¹ï¼Œå› ä¸ºå¤§éƒ¨åˆ†å­—èŠ‚å¹¶æ²¡æœ‰å®é™…å­˜å‚¨æœ‰æ•ˆçš„ä¿¡æ¯ã€‚varint ç¼–ç é€šè¿‡ä½¿ç”¨å¯å˜é•¿åº¦çš„å­—èŠ‚åºåˆ—æ¥è¡¨ç¤ºæ•´æ•°ï¼Œä½¿å¾—å°çš„æ•´æ•°å¯ä»¥ç”¨æ›´å°‘çš„å­—èŠ‚è¡¨ç¤ºï¼Œæé«˜ç©ºé—´æ•ˆç‡ã€‚ å…¼å®¹æ€§ï¼švarint ä½¿å¾—æˆ‘ä»¬å¯ä»¥åœ¨ä¸æ”¹å˜ç¼–ç  / è§£ç é€»è¾‘çš„æƒ…å†µä¸‹ï¼Œå¤„ç†ä¸åŒå¤§å°çš„æ•´æ•°ã€‚è¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥åœ¨ä¸ç ´åå‘åå…¼å®¹æ€§çš„æƒ…å†µä¸‹ï¼Œå°†ä¸€ä¸ªå­—æ®µä»è¾ƒå°çš„æ•´æ•°ç±»å‹ï¼ˆå¦‚ uint32ï¼‰å‡çº§åˆ°è¾ƒå¤§çš„æ•´æ•°ç±»å‹ï¼ˆå¦‚ uint64ï¼‰ æœ¬æ–‡å°†é€šè¿‡åˆ†æ Golang æ ‡å‡†åº“è‡ªå¸¦çš„ varint æºç å®ç°ï¼Œä»‹ç» varint çš„è®¾è®¡åŸç†ä»¥åŠGolangæ ‡å‡†åº“æ˜¯å¦‚ä½•è§£å†³ varint åœ¨ç¼–ç è´Ÿæ•°æ—¶é‡åˆ°çš„é—®é¢˜ã€‚\nThis article was first published in the Medium MPP plan. If you are a Medium user, please follow me on Medium. Thank you very much.\nvarint çš„è®¾è®¡åŸç† varint çš„è®¾è®¡åŸç†éå¸¸ç®€å•ï¼š\n7bit ä¸ºä¸€ç»„ï¼šå°†æ•´æ•°çš„äºŒè¿›åˆ¶è¡¨ç¤ºåˆ†ä¸º 7 ä¸ª bit ä½ä¸€ç»„ã€‚ä»ä½ä½åˆ°é«˜ä½ï¼Œæ¯ 7 ä¸ª bit ä½ä½œä¸ºä¸€ä¸ªå•å…ƒã€‚ æœ€é«˜ä½è¡¨ç¤º â€œç»§ç»­â€ æ ‡å¿—ã€‚åœ¨æ¯ä¸ª 7 ä½çš„å•å…ƒå‰é¢æ·»åŠ ä¸€ä¸ªæ ‡å¿—ä½ï¼Œå½¢æˆä¸€ä¸ª 8 ä½çš„å­—èŠ‚ã€‚å¦‚æœåé¢è¿˜æœ‰æ›´å¤šçš„å­—èŠ‚ï¼Œè¿™ä¸ªæ ‡å¿—ä½å°±è®¾ç½®ä¸º 1ï¼Œå¦åˆ™è®¾ç½®ä¸º 0ã€‚\nä¾‹å¦‚ï¼šå¯¹äºä¸€ä¸ªæ•´æ•° uint64(300)ï¼Œå®ƒçš„äºŒè¿›åˆ¶è¡¨ç¤ºæ˜¯Â 100101100ã€‚æˆ‘ä»¬å¯ä»¥å°†å®ƒåˆ†ä¸ºä¸¤ç»„ï¼Œå³Â 10Â å’ŒÂ 0101100ã€‚ç„¶ååœ¨æ¯ç»„å‰é¢æ·»åŠ æ ‡å¿—ä½ï¼Œå¾—åˆ°ä¸¤ä¸ªå­—èŠ‚Â 00000010Â å’ŒÂ 10101100ï¼Œè¿™ä¸¤ä¸ªå­—èŠ‚å°±æ˜¯ 300 çš„ varint ç¼–ç ã€‚ç›¸æ¯”äºç”¨ uint64 çš„ 4 å­—èŠ‚è¡¨ç¤ºï¼Œå°‘äº† 75% çš„å­˜å‚¨ç©ºé—´ã€‚ 1 2 3 4 5 6 7 8 9 func main() { v := uint64(300) bytes := make([]byte, 0) bytes = binary.AppendUvarint(bytes, v) fmt.Println(len(bytes)) for i := len(bytes); i \u0026gt; 0; i-- { fmt.Printf(\u0026#34;%08b \u0026#34;, bytes[i-1]) } } æ— ç¬¦å·æ•´æ•°çš„ varint åœ¨ Golang æ ‡å‡†åº“ä¸­æœ‰ä¸¤å¥— varint çš„å‡½æ•°: åˆ†åˆ«ç”¨äºæ— ç¬¦å·æ•´æ•°çš„ PutUvarintå’Œ Uvarintï¼Œä»¥åŠç”¨äºæœ‰ç¬¦å·æ•´æ•°çš„ Varint å’Œ PutVarint\næˆ‘ä»¬å…ˆçœ‹ä¸‹æ— ç¬¦å·æ•´æ•°çš„ varint å®ç°ï¼Œä»£ç å¦‚ä¸‹ï¼š\nlist1: go src PutUvarint\n1 2 3 4 5 6 7 8 9 10 func PutUvarint(buf []byte, x uint64) int { i := 0 for x \u0026gt;= 0x80 { buf[i] = byte(x) | 0x80 x \u0026gt;\u0026gt;= 7 i++ } buf[i] = byte(x) return i + 1 } ä»£ç é‡Œæœ‰ä¸ªéå¸¸é‡è¦çš„å¸¸é‡ï¼š0x80ï¼Œå¯¹åº”äºäºŒè¿›åˆ¶ç¼–ç å°±æ˜¯Â 1000 0000ã€‚è¿™ä¸ªå¸¸é‡å¯¹æ¥ä¸‹æ¥çš„é€»è¾‘éå¸¸é‡è¦ï¼š\nx \u0026gt;= 0x80ã€‚è¿™æ„å‘³ç€ x çš„äºŒè¿›åˆ¶è¡¨ç¤ºå½¢å¼è‡³å°‘æœ‰ 8 ä½ï¼Œæˆ‘ä»¬åˆšæ‰è®²åˆ° 7 ä¸ª bit ä½ä¸ºä¸€ç»„ï¼Œé‚£ x å°±éœ€è¦è¢«æ‹†åˆ†äº†ã€‚ byte(x) | 0x80ã€‚å°† x çš„æœ€ä½ 8 ä½ä¸Â 1000 0000Â è¿›è¡ŒæŒ‰ä½æˆ–æ“ä½œï¼Œç„¶åå°†ç»“æœå­˜å‚¨åœ¨ buf[i] ä¸­ã€‚è¿™æ ·Â æ—¢å¯ä»¥å°†æœ€é«˜ä½è®¾ç½®ä¸º 1ï¼ŒåŒæ—¶ä¹Ÿæå–å‡ºäº† x çš„æœ€ä½ 7 ä½ã€‚ x \u0026gt;\u0026gt;= 7. å°† x å³ç§» 7 ä½ï¼Œå¤„ç†ä¸‹ä¸€ä¸ªåˆ†ç»„ã€‚ buf[i] = byte(x)ã€‚å½“ for å¾ªç¯ç»“æŸæ—¶ï¼Œå³æ„å‘³ç€ x çš„äºŒè¿›åˆ¶è¡¨ç¤ºå½¢å¼æœ€é«˜ä½å¿…ç„¶æ˜¯ 0ã€‚æ­¤æ—¶å°±ä¸ç”¨åšé¢å¤–çš„è¡¥é›¶æ“ä½œäº†ã€‚ UvarintÂ æ˜¯Â PutUvarintÂ çš„é€†è¿‡ç¨‹ã€‚\néœ€è¦æ³¨æ„çš„æ˜¯ï¼Œvarint å°†æ•´æ•°åˆ’åˆ†ä¸º 7 ä½ä¸€ç»„ã€‚è¿™æ„å‘³ç€ï¼Œå¯¹äºå¤§æ•´æ•° varint å°†ä¼šå‡ºç°è´Ÿå‘ä¼˜åŒ–ã€‚ä¾‹å¦‚å¯¹äº uint64 çš„æœ€å¤§å€¼æ¥è¯´ï¼Œæœ¬æ¥åªéœ€è¦ 8 ä¸ª byte æ¥è¡¨ç¤ºï¼Œä½†åœ¨ varint ä¸­å´éœ€è¦ 10 ä¸ªå­—èŠ‚æ¥è¡¨ç¤ºäº†ã€‚ï¼ˆ64/7 â‰ˆ 10ï¼‰\nè´Ÿæ•°çš„ç¼–ç ï¼šzigzag ç¼–ç  çœ‹ä¼¼ varint ç¼–ç å·²ç»å®Œç¾æ— ç¼ºäº†ï¼Œä½†ä»¥ä¸Šå¿½ç•¥äº†ä¸€ç‚¹ï¼šè´Ÿæ•°çš„å­˜åœ¨ã€‚\næˆ‘ä»¬çŸ¥é“ï¼Œåœ¨è®¡ç®—æœºä¸­æ•°å­—æ˜¯ç”¨è¡¥ç æ¥è¡¨ç¤ºçš„ï¼Œè€Œè´Ÿæ•°çš„è¡¥ç åˆ™æ˜¯å°†å…¶ç»å¯¹å€¼æŒ‰ä½å–åå†åŠ  1ã€‚è¿™å°±æ„å‘³ç€ä¸€ä¸ªå¾ˆå°çš„è´Ÿæ•°ï¼Œå®ƒçš„äºŒè¿›åˆ¶å½¢å¼å¯¹åº”äºä¸€ä¸ªéå¸¸å¤§çš„æ•´æ•°ã€‚\nä¾‹å¦‚ï¼šå¯¹äºä¸€ä¸ª 32 ä½çš„æ•´æ•°Â -5Â æ¥è¯´ï¼Œå…¶ç»å¯¹å€¼ 5 çš„äºŒè¿›åˆ¶å½¢å¼æ˜¯Â 101ã€‚ ä½†Â -5Â çš„äºŒè¿›åˆ¶å½¢å¼å´æ˜¯Â 11111111111111111111111111111011ï¼Œå¦‚æœä½¿ç”¨ varint å¯¹å…¶ç¼–ç , éœ€è¦ 5 ä¸ªå­—èŠ‚æ‰èƒ½è¡¨ç¤ºã€‚\nGolangæ ‡å‡†åº“å¼•å…¥äº† zigzag ç¼–ç æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œzigzag çš„åŸç†éå¸¸ç®€å•ï¼š\nå¯¹äºæ­£æ•° nï¼Œä¼šå°†å…¶æ˜ å°„ä¸ºÂ 2nã€‚ä¾‹å¦‚æ•´æ•° 2ï¼Œç»è¿‡ zigzag ç¼–ç ä¹‹åå˜æˆäº† 4ã€‚ å¯¹äºè´Ÿæ•°Â -nÂ æ¥è¯´ï¼Œä¼šå°†å…¶æ˜ å°„ä¸ºÂ 2n-1ã€‚ä¾‹å¦‚è´Ÿæ•°Â -3ï¼Œç»è¿‡ zigzag ç¼–ç ä¹‹åå˜æˆäº† 5ã€‚ è¿™æ ·è´Ÿæ•°å’Œæ­£æ•°åœ¨æ•°å€¼ä¸Šå®Œå…¨ä¸ä¼šå†²çªï¼Œæ­£æ•´æ•°å’Œè´Ÿæ•´æ•°äº¤é”™æ’åˆ—ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆå«åš zigzag ç¼–ç  (é”¯é½¿å½¢ç¼–ç ï¼‰çš„åŸå› ã€‚\nåŒæ—¶ï¼Œè´Ÿæ•°è¢«è½¬æ¢æˆæ­£æ•°ä¹‹åï¼ŒäºŒè¿›åˆ¶ç¼–ç ä¹Ÿç²¾ç®€äº†è®¸å¤šã€‚\nä¾‹å¦‚ï¼š å¯¹Â int32(-5)Â è¿›è¡Œ zigzag ç¼–ç åï¼Œå˜æˆäº† 9ï¼Œå¯¹åº”äºäºŒè¿›åˆ¶ä¸ºÂ 00000000000000000000000000001001ï¼Œä½¿ç”¨ 1 ä¸ªå­—èŠ‚å³å¯è¡¨ç¤º varintã€‚\næˆ‘ä»¬çœ‹ä¸‹ Golang æ ‡å‡†åº“çš„å®ç°ï¼Œä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 func PutVarint(buf []byte, x int64) int { ux := uint64(x) \u0026lt;\u0026lt; 1 if x \u0026lt; 0 { ux = ^ux } return PutUvarint(buf, ux) } ä»ä»£ç å¯ä»¥çœ‹å‡ºï¼Œå¯¹äºæœ‰ç¬¦å·æ•´æ•°çš„varintå®ç°ï¼Œgolangæ ‡å‡†åº“è¿™é‡Œåˆ†æˆäº†ä¸¤æ­¥ï¼š\nå…ˆå¯¹æ•´æ•°è¿›è¡Œ zigzag ç¼–ç è¿›è¡Œè½¬æ¢ å¯¹è½¬æ¢ä¹‹åçš„æ•°å€¼å†è¿›è¡Œ varint ç¼–ç \nå¯¹äºè´Ÿæ•°ï¼Œå¤šäº†ä¸€æ­¥ ux = ^ux ï¼Œè¿™å°±æœ‰äº›éš¾ä»¥ç†è§£äº†ï¼Œä¸ºä»€ä¹ˆè¿™ä¹ˆè½¬æ¢ä¹‹åå°±ç­‰äº2n - 1äº†ï¼Ÿ æˆ‘ä»¬å¯ä»¥å¤§æ¦‚æ¨å¯¼ä¸‹æ•´ä¸ªè¿‡ç¨‹ï¼Œå‡è®¾æˆ‘ä»¬æœ‰ä¸ªæ•´æ•°Â -nï¼š\nå¯¹åŸæ•°å€¼å…ˆå·¦ç§»ï¼Œå†è¿›è¡Œå–åã€‚å…¶å®å¯ä»¥çœ‹åšï¼šå¯¹åŸæ•°å€¼å…ˆå–åï¼Œå†å·¦ç§»ï¼Œç„¶å+1ã€‚ å³Â 2*(~(-n))+1 æˆ‘ä»¬çŸ¥é“è´Ÿæ•°çš„è¡¥ç =ç»å¯¹å€¼æŒ‰ä½å–å+1ï¼Œé‚£å¦‚ä½•æ ¹æ®è¡¥ç å†æ¨å¯¼å‡ºç»å¯¹å€¼ï¼Ÿè¿™é‡Œæœ‰ä¸ªå…¬å¼æ˜¯ï¼š|A| = ~A+1 æˆ‘ä»¬å°†è¿™ä¸ªå…¬å¼å¸¦åˆ°ç¬¬ä¸€æ­¥çš„å¼å­é‡Œé¢ï¼šÂ 2*(n-1) + 1 = 2n - 1ã€‚è¿™å°±å®Œç¾å¯¹åº”ä¸Šäº†è´Ÿæ•°çš„ ZigZag ç¼–ç  (æ•°å­¦å¤šä¹ˆç¾å¦™)ã€‚ åœ¨ Golang æ ‡å‡†åº“é‡Œé¢ï¼Œè°ƒç”¨ PutUvarint æ—¶åªä¼šä½¿ç”¨ varint ç¼–ç ï¼Œè°ƒç”¨ PutVarint ä¼šå…ˆè¿›è¡Œ zigzag ç¼–ç ï¼Œå†è¿›è¡Œ varint ç¼–ç ã€‚\nè€Œåœ¨ protobuf ä¸­ï¼Œå¦‚æœç±»å‹æ˜¯ int32ã€int64ã€uint32ã€uint64ï¼Œåªä¼šä½¿ç”¨ varint ç¼–ç ã€‚ä½¿ç”¨ sint32ã€sint64 å°†å…ˆè¿›è¡Œ zigzag ç¼–ç ï¼Œå†è¿›è¡Œ varint ç¼–ç \nvarint ä¸é€‚ç”¨çš„æƒ…å†µ è™½ç„¶ varint ç¼–ç è®¾è®¡éå¸¸ç²¾å¦™ï¼Œä½†å¹¶ä¸é€‚ç”¨äºæ‰€æœ‰çš„åœºæ™¯ï¼š\nå¤§æ•´æ•°ï¼šå¯¹äºéå¸¸å¤§çš„æ•´æ•°ï¼Œvarint ç¼–ç å¯èƒ½ä¼šæ¯”å›ºå®šé•¿åº¦çš„ç¼–ç æ›´æ¶ˆè€—ç©ºé—´ã€‚ä¾‹å¦‚å½“æ‰€æœ‰çš„æ•´æ•°å€¼åŸŸå¤§äºÂ 2^63ï¼Œé‚£ä½¿ç”¨ varint ä¼šç”¨åˆ° 10 å­—èŠ‚ã€‚ç›¸æ¯”äºä¼ ç»Ÿçš„å…«å­—èŠ‚æ•´æ•°ï¼Œåè€Œå¤šç”¨äº† 25% çš„ç©ºé—´ éœ€è¦å¿«é€Ÿéšæœºè®¿é—®çš„æ•°æ®ï¼šç”±äº varint æ˜¯å˜é•¿ç¼–ç ï¼Œæ‰€ä»¥æˆ‘ä»¬æ— æ³•ç›´æ¥é€šè¿‡ç´¢å¼•æ¥è®¿é—®ç‰¹å®šçš„æ•´æ•°ï¼Œå¿…é¡»ä»å¤´å¼€å§‹è§£ç ï¼Œç›´åˆ°æ‰¾åˆ°æˆ‘ä»¬éœ€è¦çš„æ•´æ•°ã€‚è¿™ä½¿å¾— varint ç¼–ç ä¸é€‚åˆç”¨äºéœ€è¦å¿«é€Ÿéšæœºè®¿é—®çš„æ•°æ®ã€‚ éœ€è¦é¢‘ç¹è¿›è¡Œæ•°å­¦è¿ç®—çš„æ•°æ®ï¼šç”±äº varint ç¼–ç çš„æ•°æ®éœ€è¦å…ˆè§£ç æ‰èƒ½è¿›è¡Œæ•°å­¦è¿ç®—ï¼Œæ‰€ä»¥å¦‚æœä¸€ä¸ªåº”ç”¨éœ€è¦é¢‘ç¹åœ°å¯¹æ•°æ®è¿›è¡Œæ•°å­¦è¿ç®—ï¼Œé‚£ä¹ˆä½¿ç”¨ varint ç¼–ç å¯èƒ½ä¼šå¯¼è‡´æ€§èƒ½ä¸‹é™ã€‚ å®‰å…¨æ•æ„Ÿçš„åº”ç”¨ï¼švarint ç¼–ç çš„æ•°æ®å¯èƒ½ä¼šæš´éœ²å‡ºä¸€äº›å…³äºåŸå§‹æ•´æ•°çš„ä¿¡æ¯ï¼Œä¾‹å¦‚å®ƒçš„å¤§å°ã€‚åœ¨æŸäº›å®‰å…¨æ•æ„Ÿçš„åº”ç”¨ä¸­ï¼Œè¿™å¯èƒ½æ˜¯ä¸å¯æ¥å—çš„ã€‚ ","date":"2024-09-06T15:33:15+08:00","permalink":"https://huizhou92.com/zh-cn/p/%E8%A7%A3%E6%9E%90go-varint-%E7%9A%84%E4%BD%BF%E7%94%A8%E4%B8%8E%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/","title":"è§£æGo: varint çš„ä½¿ç”¨ä¸å®ç°åŸç†"},{"content":"è§£æ å¦‚æœæˆ‘ä»¬å¸Œæœ›åœ¨ä¸€ä¸ªå¯¹è±¡è¢«gcä¹‹å‰ï¼Œåšä¸€äº›èµ„æºé‡Šæ”¾çš„å·¥ä½œï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ runtime.SetFinalizerã€‚å°±åƒå‡½æ•°è¿”å›ä¹‹å‰æ‰§è¡Œdeferé‡Šæ”¾èµ„æºä¸€æ ·ã€‚æ¯”å¦‚ä¸‹é¢çš„ä»£ç :\nThis article was first published in the Medium MPP plan. If you are a Medium user, please follow me on Medium. Thank you very much.\nList1: example By runtime.SetFinalizer\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 type MyStruct struct { Name string Other *MyStruct } func main() { x := MyStruct{Name: \u0026#34;X\u0026#34;} runtime.SetFinalizer(\u0026amp;x, func(x *MyStruct) { fmt.Printf(\u0026#34;Finalizer for %s is called\\n\u0026#34;, x.Name) }) runtime.GC() time.Sleep(1 * time.Second) runtime.GC() } å®˜æ–¹æ–‡æ¡£ä¸­å¯¹SetFinalizerçš„ä¸€äº›è§£é‡Šï¼Œä¸»è¦å«ä¹‰æ˜¯å¯¹è±¡å¯ä»¥å…³è”ä¸€ä¸ªSetFinalizerå‡½æ•°ï¼Œ å½“GCæ£€æµ‹åˆ°unreachableå¯¹è±¡æœ‰å…³è”çš„SetFinalizerå‡½æ•°æ—¶ï¼Œä¼šæ‰§è¡Œå…³è”çš„SetFinalizerå‡½æ•°ï¼Œ åŒæ—¶å–æ¶ˆå…³è”ã€‚ è¿™æ ·å½“ä¸‹ä¸€æ¬¡GCçš„æ—¶å€™ï¼Œå¯¹è±¡é‡æ–°å¤„äºunreachableçŠ¶æ€å¹¶ä¸”æ²¡æœ‰SetFinalizerå…³è”ï¼Œ å°±ä¼šè¢«å›æ”¶ã€‚\nä»”ç»†çœ‹æ–‡æ¡£ï¼Œè¿˜æœ‰å‡ ä¸ªéœ€è¦æ³¨æ„çš„ç‚¹ï¼š\nå³ä½¿ç¨‹åºæ­£å¸¸ç»“æŸæˆ–è€…å‘ç”Ÿé”™è¯¯ï¼Œ ä½†æ˜¯åœ¨å¯¹è±¡è¢« gc é€‰ä¸­å¹¶è¢«å›æ”¶ä¹‹å‰ï¼ŒSetFinalizer éƒ½ä¸ä¼šæ‰§è¡Œï¼Œ æ‰€ä»¥ä¸è¦åœ¨SetFinalizerä¸­æ‰§è¡Œå°†å†…å­˜ä¸­çš„å†…å®¹flushåˆ°ç£ç›˜è¿™ç§æ“ä½œã€‚ SetFinalizer æœ€å¤§çš„é—®é¢˜æ˜¯å»¶é•¿äº†å¯¹è±¡ç”Ÿå‘½å‘¨æœŸã€‚åœ¨ç¬¬ä¸€æ¬¡å›æ”¶æ—¶æ‰§è¡Œ Finalizer å‡½æ•°ï¼Œä¸”ç›®æ ‡å¯¹è±¡é‡æ–°å˜æˆå¯è¾¾çŠ¶æ€ï¼Œç›´åˆ°ç¬¬äºŒæ¬¡æ‰çœŸæ­£ â€œé”€æ¯â€ã€‚è¿™å¯¹äºæœ‰å¤§é‡å¯¹è±¡åˆ†é…çš„é«˜å¹¶å‘ç®—æ³•ï¼Œå¯èƒ½ä¼šé€ æˆå¾ˆå¤§éº»çƒ¦ æŒ‡é’ˆæ„æˆçš„ \u0026ldquo;å¾ªç¯å¼•â½¤\u0026rdquo; åŠ ä¸Š runtime.SetFinalizer ä¼šå¯¼è‡´å†…å­˜æ³„éœ²ã€‚ list 2ï¼š runtime.SetFinalizer memory leak\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 // MyStruct æ˜¯ä¸€ä¸ªç®€å•çš„ç»“æ„ä½“ï¼ŒåŒ…å«ä¸€ä¸ªæŒ‡é’ˆå­—æ®µã€‚ type MyStruct struct { Name string Other *MyStruct } func main() { x := MyStruct{Name: \u0026#34;X\u0026#34;} y := MyStruct{Name: \u0026#34;Y\u0026#34;} x.Other = \u0026amp;y y.Other = \u0026amp;x runtime.SetFinalizer(\u0026amp;x, func(x *MyStruct) { fmt.Printf(\u0026#34;Finalizer for %s is called\\n\u0026#34;, x.Name) }) time.Sleep(time.Second) runtime.GC() time.Sleep(time.Second) runtime.GC() } x æ°¸è¿œä¸ä¼šè¢«é‡Šæ”¾ã€‚æ­£ç¡®çš„åšæ³•åº”è¯¥æ˜¯ï¼Œ åœ¨ä¸éœ€è¦ä½¿ç”¨ å¯¹è±¡çš„æ—¶å€™ï¼Œæ˜¾å¼ç§»é™¤ Finalizer runtime.SetFinalizer(\u0026amp;x, nil)\nå®é™…åº”ç”¨ åœ¨ä¸šåŠ¡ä»£ç ä¸­å¾ˆå°‘ä½¿ç”¨runtime.SetFinalizer ï¼ˆæˆ‘æ²¡ä½¿ç”¨è¿‡ï¼‰ä½†æ˜¯å†Goæºç ä¸­ æœ‰æ¯”è¾ƒå¤šçš„ä½¿ç”¨ï¼Œ æ¯”å¦‚\nnet/http\n1 2 3 4 5 6 7 8 9 10 11 12 13 func (fd *netFD) setAddr(laddr, raddr Addr) { fd.laddr = laddr fd.raddr = raddr runtime.SetFinalizer(fd, (*netFD).Close) } func (fd *netFD) Close() error { if fd.fakeNetFD != nil { return fd.fakeNetFD.Close() } runtime.SetFinalizer(fd, nil) return fd.pfd.Close() } go-cacheåº“æä¾›äº†SetFinalizerçš„ä¸€ç§ç”¨æ³•ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 func New(defaultExpiration, cleanupInterval time.Duration) *Cache { items := make(map[string]Item) return newCacheWithJanitor(defaultExpiration, cleanupInterval, items) } func newCacheWithJanitor(de time.Duration, ci time.Duration, m map[string]Item) *Cache { c := newCache(de, m) C := \u0026amp;Cache{c} if ci \u0026gt; 0 { runJanitor(c, ci) runtime.SetFinalizer(C, stopJanitor) } return C } func runJanitor(c *cache, ci time.Duration) { j := \u0026amp;janitor{ Interval: ci, stop: make(chan bool), } c.janitor = j go j.Run(c) } func stopJanitor(c *Cache) { c.janitor.stop \u0026lt;- true } func (j *janitor) Run(c *cache) { ticker := time.NewTicker(j.Interval) for { select { case \u0026lt;-ticker.C: c.DeleteExpired() case \u0026lt;-j.stop: ticker.Stop() return } } } newCacheWithJanitoråœ¨ciå‚æ•°å¤§äº0æ—¶ï¼Œå°†å¼€å¯åå°åç¨‹ï¼Œé€šè¿‡tickerå®šæœŸæ¸…ç†è¿‡æœŸç¼“å­˜ã€‚ä¸€æ—¦ä»stop chanä¸­è¯»åˆ°å€¼ï¼Œåˆ™å¼‚æ­¥åç¨‹é€€å‡ºã€‚\nstopJanitorä¸ºæŒ‡å‘Cacheçš„æŒ‡é’ˆCå®šä¹‰äº†finalizerå‡½æ•°stopJanitorã€‚ä¸€æ—¦æˆ‘ä»¬åœ¨ä¸šåŠ¡ä»£ç ä¸­ä¸å†æœ‰æŒ‡å‘Cacheçš„å¼•ç”¨æ—¶ï¼Œcå°†ä¼šè¿›è¡ŒGCæµç¨‹ï¼Œé¦–å…ˆæ‰§è¡ŒstopJanitorå‡½æ•°ï¼Œå…¶ä½œç”¨æ˜¯ä¸ºå†…éƒ¨çš„stop channelå†™å…¥å€¼ï¼Œä»è€Œé€šçŸ¥ä¸Šä¸€æ­¥çš„å¼‚æ­¥æ¸…ç†åç¨‹ï¼Œä½¿å…¶é€€å‡ºã€‚è¿™æ ·å°±å®ç°äº†ä¸šåŠ¡ä»£ç æ— æ„ŸçŸ¥çš„å¼‚æ­¥åç¨‹å›æ”¶ï¼Œæ˜¯ä¸€ç§ä¼˜é›…çš„é€€å‡ºæ–¹å¼ã€‚\n","date":"2024-09-04T19:33:11+08:00","image":"https://images.hxzhouh.com/blog-images/2024/09/44dc3c5b905dd33169c691b6ec42b4cf.png","permalink":"https://huizhou92.com/zh-cn/p/go-runtime.setfinalizer/","title":"Go runtime.SetFinalizer"},{"content":"ä¸ç®¡ä½¿ç”¨ä»€ä¹ˆè¯­è¨€ï¼Œå†…å­˜æ³„éœ²æ˜¯ç»å¸¸é‡åˆ°çš„ä¸€ç±»é—®é¢˜ï¼Œç„¶è€Œä½¿ç”¨Goè¯­è¨€ç¼–å†™å†…å­˜æ³„éœ²çš„ä»£ç å´ä¸å®¹æ˜“ï¼Œæœ¬æ–‡å°†åˆ—ä¸¾å‡ ä¸ªå¯èƒ½å‡ºç°å†…å­˜æ³„éœ²çš„åœºæ™¯ï¼Œä»åä¾‹ä¸­å­¦ä¹ å¦‚ä½•é¿å…å†…å­˜æ³„éœ²ã€‚\nThis article was first published in the Medium MPP plan. If you are a Medium user, please follow me on Medium. Thank you very much.\nèµ„æºæ³„éœ² ä¸å…³é—­æ‰“å¼€çš„æ–‡ä»¶ å½“ä½ ä¸å†éœ€è¦ä¸€ä¸ªæ‰“å¼€çš„æ–‡ä»¶,æ­£å¸¸ä½ éœ€è¦è°ƒç”¨å®ƒçš„Closeæ–¹æ³•,å¦‚æœä½ ä¸è°ƒç”¨Closeï¼Œå°±æœ‰å¯èƒ½æ–‡ä»¶æè¿°ç¬¦è¾¾åˆ°æœ€å¤§é™åˆ¶ï¼Œæ— æ³•åœ¨æ‰“å¼€æ–°çš„æ–‡ä»¶æˆ–è€…è¿æ¥,ç¨‹åºä¼šæŠ¥too many open filesçš„é”™è¯¯ã€‚æ¯”å¦‚ä¸‹é¢çš„ä¾‹å­ï¼š\nCode 1: æ–‡ä»¶æ²¡å…³é—­å¯¼è‡´ è€—å°½æ–‡ä»¶æè¿°ç¬¦ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 func main() { files := make([]*os.File, 0) for i := 0; ; i++ { file, err := os.OpenFile(\u0026#34;test.log\u0026#34;, os.O_CREATE|os.O_APPEND|os.O_WRONLY, 0644) if err != nil { fmt.Printf(\u0026#34;Error at file %d: %v\\n\u0026#34;, i, err) break } else { _, _ = file.Write([]byte(\u0026#34;Hello, World!\u0026#34;)) files = append(files, file) } } } ---- âœ memory_leak git:(main) âœ— go run close_file.go Error at file 61437: open test.log: too many open files åœ¨æˆ‘çš„Mac ç”µè„‘ä¸Šä¸€ä¸ªè¿›ç¨‹èƒ½æ‰“å¼€çš„æ–‡ä»¶å¥æŸ„æ•°é‡æœ€å¤§æ˜¯61440ï¼Œä¹Ÿå¯ä»¥æ‰‹åŠ¨è®¾ç½®è¿™ä¸ªæ•°å€¼ã€‚go ç¨‹åºä¼šé»˜è®¤æ‰“å¼€ stderrï¼Œstdoutï¼Œstdin ä¸‰ä¸ªæ–‡ä»¶å¥æŸ„ï¼Œä¸€ä¸ªè¿›ç¨‹æœ€å¤šèƒ½å¤Ÿæ‰“å¼€61437 æ–‡ä»¶ï¼Œå¤šäº†å°±ä¼šæŠ¥é”™ã€‚\nhttp.Response.Body.Close() Go è¯­è¨€æœ‰ä¸€ä¸ª æ¯”è¾ƒâ€œçŸ¥åâ€çš„bugï¼Œç›¸ä¿¡æ‚¨ä¸€å®šçœ‹åˆ°è¿‡ï¼šå¦‚æœæˆ‘ä»¬å¿˜è®°å…³é—­ http è¯·æ±‚çš„body çš„è¯ï¼Œä¼šå¯¼è‡´å†…å­˜æ³„éœ²ï¼Œæ¯”å¦‚ä¸‹é¢çš„ä»£ç ã€‚\nhttps://gist.github.com/hxzhouh/1e63ef82a1088ac378384e30651b20c9\ncode 2ï¼š http body æ²¡æœ‰å…³é—­å¯¼è‡´å†…å­˜æ³„éœ²ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 func makeRequest() { client := \u0026amp;http.Client{} req, err := http.NewRequest(http.MethodGet, \u0026#34;http://localhost:8081\u0026#34;, nil) res, err := client.Do(req) if err != nil { fmt.Println(err) } _, err = ioutil.ReadAll(res.Body) // defer res.Body.Close() if err != nil { fmt.Println(err) } } å…³äºè¿™ä¸ªé—®é¢˜æ‚¨å¯ä»¥å‚è€ƒä¸‹é¢çš„æ–‡ç« äº†è§£æ›´å¤šä¿¡æ¯ï¼Œåé¢å¦‚æœæœ‰æ—¶é—´çš„è¯ï¼Œæˆ‘ä»¬ä»å¤´æ¢³ç†ä¸€ä¸‹ net/http\nis resp.Body.Close() necessary if we don\u0026rsquo;t read anything from the body? https://manishrjain.com/must-close-golang-http-response å­—ç¬¦ä¸²/slice å¯¼è‡´å†…å­˜æ³„éœ² è™½ç„¶ Go spec å¹¶æ²¡æœ‰è¯´æ˜ä¸€ä¸ªå­—ç¬¦ä¸²è¡¨è¾¾å¼çš„ç»“æœï¼ˆå­ï¼‰å­—ç¬¦ä¸²å’ŒåŸæ¥å­—ç¬¦ä¸²æ˜¯å¦å…±äº«ä¸€ä¸ªå†…å­˜å— ä½†ç¼–è¯‘å™¨ç¡®å®è®©å®ƒä»¬å…±äº«ä¸€ä¸ªå†…å­˜å—ï¼Œè€Œä¸”å¾ˆå¤šæ ‡å‡†åº“åŒ…çš„å‡½æ•°åŸå‹è®¾è®¡ä¹Ÿé»˜è®¤äº†è¿™ä¸€ç‚¹ã€‚è¿™æ˜¯ä¸€ä¸ªå¥½çš„è®¾è®¡ï¼Œå®ƒä¸ä»…èŠ‚çœå†…å­˜ï¼Œè€Œä¸”è¿˜å‡å°‘äº†CPUæ¶ˆè€—ã€‚ ä½†æ˜¯æœ‰æ—¶å€™å®ƒä¼šé€ æˆæš‚æ—¶æ€§çš„å†…å­˜æ³„éœ²ã€‚\nCode 3: å­—ç¬¦ä¸²å¯¼è‡´å†…å­˜æ³„éœ²ã€‚\nhttps://gist.github.com/hxzhouh/e09587195e2d7aa2d5f6676777c6cb16\n![[Pasted image 20240925174837.png]]\nä¸ºé˜²æ­¢createStringWithLengthOnHeap ä¸´æ—¶æ€§å†…å­˜æ³„éœ²ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨strings.Clone()\nCode 4 ï¼š ä½¿ç”¨strings.Clone() é¿å…ä¸´æ—¶å†…å­˜æ³„éœ²ã€‚\n1 2 3 4 5 6 func Demo1() { for i := 0; i \u0026lt; 10; i++ { s := createStringWithLengthOnHeap(1 \u0026lt;\u0026lt; 20) //1M packageStr1 = append(packageStr1, strings.Clone(s[:50])) } } è¿™æ ·å°±ä¸ä¼šå¯¼è‡´ä¸´æ—¶æ€§å†…å­˜æ³„éœ²äº†ã€‚\ngoroutine leak goroutine handler ç»å¤§éƒ¨åˆ†å†…å­˜æ³„éœ²çš„åŸå› æ˜¯å› ä¸ºgoroutineæ³„éœ²ï¼Œæ¯”å¦‚ä¸‹é¢çš„ä¾‹å­ï¼Œå¾ˆå¿«å°†ä¼šå†…å­˜è€—å°½ è€Œå¯¼è‡´OOM\nCode 5: goroutine handler\n1 2 3 4 5 6 for { go func() { time.Sleep(1 * time.Hour) }() } } channel channel çš„ä½¿ç”¨é”™è¯¯ä¹Ÿå¾ˆå®¹æ˜“å¯¼è‡´ goroutine æ³„éœ²ï¼Œ\nå¯¹äºæ— ç¼“å†²çš„channelï¼Œå¿…é¡»è¦ç­‰åˆ°ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…å…¨éƒ¨å°±ç»ªåï¼Œæ‰èƒ½å¾€channelå†™æ•°æ®ï¼Œå¦åˆ™å°†ä¼šé˜»å¡ã€‚ä¸‹é¢çš„ä¾‹å­å› ä¸ºExample æå‰é€€å‡ºå¯¼è‡´åç¨‹æ³„éœ²ã€‚\nCode 6: ä¸åˆç†ä½¿ç”¨æ— ç¼“å†²channel å¯¼è‡´goroutineæ³„éœ²\n1 2 3 4 5 6 7 8 9 10 11 12 13 func Example() { a := 1 c := make(chan error) go func() { c \u0026lt;- err return }() // Example åœ¨è¿™é‡Œé€€å‡ºï¼Œå¯¼è‡´åç¨‹æ³„éœ²ã€‚ if a \u0026gt; 0 { return } err := \u0026lt;-c } åªéœ€è¦æ”¹æˆæœ‰ç¼“å†²çš„channel å°±èƒ½è§£å†³è¿™ä¸ªé—®é¢˜ c:= make(chan error,1)\nè¿˜æœ‰ä¸€ä¸ªå…¸å‹çš„ä¾‹å­å°±æ˜¯channel range è¯¯ç”¨ã€‚\nCode 7: ä¸åˆç†ä½¿ç”¨range å¯¼è‡´goroutineæ³„éœ²\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 func main() { wg := \u0026amp;sync.WaitGroup{} c := make(chan any, 1) items := []int{1, 2, 3, 4, 5} for _, i := range items { wg.Add(1) go func() { c \u0026lt;- i }() } go func() { for data := range c { fmt.Println(data) wg.Done() } fmt.Println(\u0026#34;close\u0026#34;) }() wg.Wait() time.Sleep(1 * time.Second) } channel å¯ä»¥ä½¿ç”¨ range è¿­ä»£ .ä½†æ˜¯ä¸€æ—¦è¯»å–ä¸åˆ°å†…å®¹ï¼Œrange å°±ä¼šç­‰å¾… channel çš„å†™å…¥ï¼Œè€Œ range å¦‚æœæ­£å¥½åœ¨ goroutine å†…éƒ¨ï¼Œè¿™ä¸ª goroutine å°±ä¼šè¢«é˜»å¡ï¼Œé€ æˆæ³„éœ²ã€‚æ­£ç¡®çš„åšæ³•æ˜¯: åœ¨wg.Wait() åé¢ close channel.\nruntime.SetFinalizerè¯¯ç”¨ å¦‚æœä¸¤ä¸ªå¯¹è±¡éƒ½è®¾ç½®äº† runtime.SetFinalizer å¹¶ä¸”ä»–ä»¬ä¹‹é—´å­˜åœ¨ \u0026ldquo;å¾ªç¯å¼•â½¤\u0026rdquo; ï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªå¯¹è±¡å°†ä¼šæ³„éœ²ï¼Œå³æ—¶ä»–ä»¬ä¸å†ä½¿ç”¨ï¼ŒGC ä¹Ÿä¸ä¼šå›æ”¶ä»–ä»¬ã€‚\nå…³äº runtime.SetFinalizer çš„æ›´å¤šå†…å®¹ï¼Œå¯ä»¥å‚è€ƒæˆ‘çš„å¦å¤–ä¸€ç¯‡æ–‡ç« \ntime.Ticker è¿™æ˜¯go 1.23 ç‰ˆæœ¬ä¹‹å‰çš„é—®é¢˜äº†ï¼Œ å¦‚æœæˆ‘ä»¬ä¸è°ƒç”¨ticker.Stop().go 1.23 å·²ç»ä¸ä¼šé€ æˆæ³„éœ²äº† https://go.dev/doc/go1.23#timer-changes\ndefer æˆ‘ä»¬ä¸€èˆ¬ä¹ æƒ¯åœ¨defer ä¸­é‡Šæ”¾èµ„æº defer å‡½æ•°æœ¬èº«ä¸ä¼šå¯¼è‡´å†…å­˜æ³„éœ²ã€‚ä½†æ˜¯å®ƒçš„ä¸¤ä¸ªæœºåˆ¶å¯èƒ½ä¼šå¯¼è‡´å†…å­˜ä¸´æ—¶æ€§æ³„éœ²ã€‚\næ‰§è¡Œæ—¶é—´ï¼Œdefer æ€»æ˜¯åœ¨å‡½æ•°ç»“æŸçš„è¿è¡Œã€‚å¦‚æœæ‚¨çš„å‡½æ•°è¿è¡Œæ—¶é—´è¿‡é•¿ï¼Œæˆ–è€…æ°¸è¿œä¸ä¼šç»“æŸï¼Œé‚£ä¹ˆæ‚¨åœ¨defer ä¸­é‡Šæ”¾çš„èµ„æºå¯èƒ½ï¼Œå¾ˆä¹…éƒ½ä¸ä¼šè¢«é‡Šæ”¾ï¼Œæˆ–è€…æ°¸è¿œéƒ½ä¸è¢«é‡Šæ”¾ã€‚ defer æœ¬èº«ä¹Ÿéœ€è¦å ç”¨å†…å­˜ï¼Œæ¯ä¸ª defer éƒ½ä¼šåœ¨å†…å­˜ä¸­æ·»åŠ ä¸€ä¸ªè°ƒç”¨ç‚¹ã€‚å¦‚æœæ‚¨åœ¨å¾ªç¯ä¸­ä½¿ç”¨deferï¼Œæœ‰å¯èƒ½ä¼šå¯¼è‡´ä¸´æ—¶æ€§çš„å†…å­˜æ³„éœ²ã€‚\nCode 8: defer å¯¼è‡´ å†…å­˜ä¸´æ—¶æ³„éœ² 1 2 3 4 5 6 7 8 9 10 11 func ReadFile(files []string) { for _, file := range files { f, err := os.Open(file) if err != nil { fmt.Println(err) return } // do something defer f.Close() } } æ¯”å¦‚ä¸Šé¢çš„ä»£ç ï¼Œä¸ä»…ä»…å¯èƒ½ä¼šå¯¼è‡´ defer ä¸´æ—¶å†…å­˜æ³„éœ²ï¼Œè¿˜å¯èƒ½ä¼šå¯¼è‡´too many open files\nä¸è¦ç—´è¿·äºä½¿ç”¨defer é™¤éä½ è§‰å¾—ä»£ç ä½ çš„ä»£ç å¯èƒ½ä¼španic ï¼Œå¦åˆ™åŠæ—¶å…³é—­æ–‡ä»¶æ˜¯ä¸€ä¸ªæ›´å¥½çš„é€‰æ‹©ã€‚\næ€»ç»“ æœ¬æ–‡åˆ—ä¸¾äº†å‡ ç§å¯èƒ½ä¼šå¯¼è‡´go å†…å­˜æ³„éœ²çš„è¡Œä¸ºï¼ŒåŒæ—¶ Goroutine å†…å­˜æ³„æ¼æ˜¯ Go è¯­è¨€æœ€å®¹æ˜“å‘ç”Ÿçš„å†…å­˜æ³„æ¼æƒ…å†µï¼Œå®ƒé€šå¸¸ä¼´éšç€é”™è¯¯åœ°ä½¿ç”¨ goroutine å’Œ channelç­‰ã€‚è€Œ channel çš„ç‰¹æ®Šç”¨æ³•å¦‚ select å’Œ range åˆè®© channel é˜»å¡å˜å¾—æ›´åŠ éšè”½ä¸æ˜“å‘ç°ï¼Œè¿›è€Œå¢åŠ æ’æŸ¥å†…å­˜æ³„æ¼çš„éš¾åº¦ã€‚\né‡åˆ°å†…å­˜æ³„éœ²é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ pprof å¸®åŠ©æˆ‘ä»¬å¿«é€Ÿçš„å®šä½é—®é¢˜ï¼Œå¸Œæœ›æˆ‘ä»¬æ¯ä¸ªäººéƒ½èƒ½å†™å‡ºå¥å£®çš„ä»£ç ã€‚\nå‚è€ƒèµ„æ–™ https://go101.org/article/memory-leaking.html\n","date":"2024-09-04T14:39:36+08:00","permalink":"https://huizhou92.com/zh-cn/p/%E5%A6%82%E4%BD%95%E5%86%99%E5%87%BA%E5%86%85%E5%AD%98%E6%B3%84%E9%9C%B2%E7%9A%84%E7%A8%8B%E5%BA%8F/","title":"å¦‚ä½•å†™å‡ºå†…å­˜æ³„éœ²çš„ç¨‹åºï¼Ÿ"},{"content":" tmux æ˜¯ä¸€ä¸ªç»ˆç«¯å¤šè·¯å¤ç”¨å™¨ï¼šå®ƒå…è®¸ä»å•ä¸ªå±å¹•åˆ›å»ºã€è®¿é—®å’Œæ§åˆ¶å¤šä¸ªç»ˆç«¯ã€‚ tmux å¯èƒ½ä¼šä¸å±å¹•åˆ†ç¦»å¹¶ç»§ç»­åœ¨åå°è¿è¡Œï¼Œç„¶åé‡æ–°è¿æ¥ã€‚\nç¬¬ä¸€æ¬¡çœ‹åˆ°tmux çš„ä»‹ç»çš„æ—¶å€™ï¼Œæˆ‘å…¶å®æ²¡ä»€ä¹ˆæ„Ÿè§‰,è§‰å¾—æ²¡ä»€ä¹ˆ.åé¢ç”¨terminalå¤šäº†ï¼Œé‡åˆ°äº†ä¸€äº›é—®é¢˜ï¼Œå°è¯•è§£å†³ï¼Œç„¶åæˆ‘é‡æ–°è®¤çœŸå­¦ä¹ tmuxã€‚å®ƒæ”¹å˜äº†æˆ‘ç”µè„‘çš„ä¹ æƒ¯ã€‚\næœ¬æ–‡å°†ä¼šèŠ±ååˆ†é’Ÿä»‹ç»ï¼Œtmux çš„åŸºæœ¬ä½¿ç”¨åœºæ™¯\nä»€ä¹ˆæ˜¯ terminal session å›å¿†ä¸€ä¸‹ï¼Œä½ æ—¥å¸¸å·¥ä½œæ—¶å€™ä½¿ç”¨terminal çš„åœºæ™¯ï¼Œæ‰“å¼€ä¸€ä¸ª Iterm2Â çª—å£ï¼Œç„¶åä½¿ç”¨ssh è¿æ¥ä¸€å°è¿œç¨‹æœºå™¨ï¼Œç„¶åè¿›å…¥ç‰¹å®šç›®å½•ï¼Œå¼€å§‹å·¥ä½œï¼Œå®Œæˆå·¥ä½œåï¼Œå…³é—­Iterm2 çª—å£ã€‚ä¸Šé¢è¿™äº›æ­¥éª¤ï¼Œå°±æ˜¯ä¸€ä¸ª terminal session å®ƒçš„ç”Ÿå‘½å‘¨æœŸæ˜¯è·Ÿ terminal çš„ç”Ÿå‘½å‘¨æœŸç»‘å®šåœ¨ä¸€èµ·çš„ï¼Œå…³é—­çª—å£åsessionå°±ç»“æŸï¼Œç„¶åä¸‹æ¬¡æˆ‘ä»¬è¦å·¥ä½œçš„æ—¶å€™ï¼Œå°±é‡å¤ä¸Šé¢çš„æ­¥éª¤ã€‚\næœ‰ä»€ä¹ˆåŠæ³•ï¼Œå¯ä»¥å°†sessionè·Ÿterminal å¼€æ¥ï¼Œä¸‹æ¬¡å†æ“ä½œçš„æ—¶å€™ï¼Œå°±ä¸éœ€è¦é‡å¤ä¸Šé¢çš„æ­¥éª¤ï¼Ÿ tmuxå¯ä»¥å¸®åŠ©æˆ‘ä»¬å®ç°è¿™ä¸ªåŠŸèƒ½ã€‚\nThis article was first published in the Medium MPP plan. If you are a Medium user, please follow me on Medium. Thank you very much.\næˆ‘ä»¬çœ‹çœ‹å† tmux ä¸‹å¦‚ä½•å®ç°ä¸Šé¢è¿™ä¸ªåŠŸèƒ½æŠŠã€‚\nåœ¨è¿™ä¸ªæ¼”ç¤ºä¸­ï¼Œæˆ‘é¦–å…ˆç”¨tmux new -s test åˆ›å»ºäº†ä¸€ä¸ªtmux session ï¼Œç„¶åç™»å½•æˆ‘çš„ä¸€å°å¼€å‘æœºå™¨ï¼Œç„¶åå†å°†session å‰¥ç¦»ï¼Œå›åˆ°Iterm2 ç»ˆç«¯ï¼Œæœ€åæˆ‘åˆä½¿ç”¨ tmux attach-session å›åˆ°åŸæ¥çš„å¼€å‘æœºå™¨ï¼Œè·Ÿåˆšæ‰é€€å‡ºå»çš„æ—¶å€™ä¸€æ¨¡ä¸€æ ·ã€‚ è¿™å°±æ˜¯ tmux åŸºç¡€çš„åº”ç”¨äº†ï¼Œå‰¥ç¦»sessionï¼Œå¹¶ä¸”ä¿æŒsession çŠ¶æ€ã€‚\nTL;DR tmux å¯ä»¥å¸®åŠ©æˆ‘ä»¬å®ç°ï¼š\nå®ƒå…è®¸åœ¨å•ä¸ªçª—å£ä¸­ï¼ŒåŒæ—¶è®¿é—®å¤šä¸ªä¼šè¯ã€‚è¿™å¯¹äºåŒæ—¶è¿è¡Œå¤šä¸ªå‘½ä»¤è¡Œç¨‹åºå¾ˆæœ‰ç”¨ã€‚ å®ƒå¯ä»¥è®©æ–°çª—å£\u0026quot;æ¥å…¥\u0026quot;å·²ç»å­˜åœ¨çš„ä¼šè¯ã€‚ å®ƒå…è®¸æ¯ä¸ªä¼šè¯æœ‰å¤šä¸ªè¿æ¥çª—å£ï¼Œå› æ­¤å¯ä»¥å¤šäººå®æ—¶å…±äº«ä¼šè¯ã€‚ å®ƒè¿˜æ”¯æŒçª—å£ä»»æ„çš„å‚ç›´å’Œæ°´å¹³æ‹†åˆ†ã€‚ tmux åŸºæœ¬ç”¨æ³• å®‰è£… tmux åœ¨Macä¸Šï¼Œå¯ä»¥ä½¿ç”¨brew æ¥å®‰è£… tmux\n1 brew install tmux å…¶ä»–ç¯å¢ƒè¯·å‚è€ƒ:Installing tmux\nå¯åŠ¨tmux ä¸é€€å‡º tmux å®‰è£…å®Œæˆåï¼Œ åœ¨ terminalä¸­è¾“å…¥ tmux å°±å¯ä»¥å¯åŠ¨ä¸€ä¸ª tmux session ã€‚è¾“å…¥exit å°±ä¼šé€€å‡º tmux session ï¼Œè¿”å›åˆ°åŸæ¥çš„ terminal é¡µé¢ã€‚\nå‰ç¼€é”® è·Ÿå…¶ä»–è½¯ä»¶ä¸ä¸€æ ·çš„æ˜¯: tmux ä¸­æ‰€æœ‰çš„å¿«æ·é”®éƒ½éœ€è¦å’Œå‰ç¼€å¿«æ·é”®Â âŒƒbÂ æ¥ç»„åˆä½¿ç”¨ï¼ˆæ³¨ï¼šâŒƒ ä¸º Mac çš„ control é”®),è¿™æ ·å…¶å®æŒºå¥½çš„ï¼Œå‡å°‘äº†ä¸å…¶ä»–è½¯ä»¶å†²çªçš„æ¦‚ç‡ã€‚å¯ä»¥é€šè¿‡ âŒƒb+? æ¥æŸ¥è¯¢æ‰€æœ‰çš„å¿«æ·é”®ã€‚ä¸€èˆ¬æŠŠtmux çš„å¿«æ·é”®åˆ†æˆä¸‰ç±»:çª—å£ç®¡ç†ã€çª—æ ¼ç®¡ç†ã€ä»¥åŠsession ç®¡ç†ã€‚\nsession ç®¡ç† å¦‚æœè¿è¡Œäº†å¤šæ¬¡Â tmuxÂ å‘½ä»¤åˆ™ä¼šå¼€å¯å¤šä¸ª tmux ä¼šè¯ï¼ˆsessionï¼‰ã€‚åœ¨ tmux ä¼šè¯ä¸­ï¼Œä½¿ç”¨å‰ç¼€å¿«æ·é”®Â âŒƒbÂ é…åˆä»¥ä¸‹å¿«æ·é”®å¯æ“ä½œä¼šè¯ï¼š\nâŒƒb + $Â é‡å‘½åå½“å‰ä¼šè¯ âŒƒb + sÂ é€‰æ‹©ä¼šè¯åˆ—è¡¨ âŒƒb + dÂ detach å½“å‰ä¼šè¯ï¼Œè¿è¡Œåå°†ä¼šé€€å‡º tmux è¿›ç¨‹ï¼Œè¿”å›è‡³ terminal ä¸»é¡µé¢ã€‚\nåœ¨ terminal ä¸­ï¼Œå¯ä»¥è¿™æ ·æ“ä½œ session tmux new -s foo # æ–°å»ºåç§°ä¸º foo çš„ä¼šè¯ tmux ls # åˆ—å‡ºæ‰€æœ‰ tmux ä¼šè¯ tmux a # æ¢å¤è‡³ä¸Šä¸€æ¬¡çš„ä¼šè¯ tmux a -t foo # æ¢å¤åç§°ä¸º foo çš„ä¼šè¯ï¼Œä¼šè¯é»˜è®¤åç§°ä¸ºæ•°å­— tmux kill-session -t foo # åˆ é™¤åç§°ä¸º foo çš„ä¼šè¯ tmux kill-server # åˆ é™¤æ‰€æœ‰çš„ä¼šè¯\né…åˆ alias ä¼šå¾—åˆ°æ›´å¥½çš„ä½“éªŒï¼Œæ¯”å¦‚æˆ‘è‡ªå·±çš„é…ç½® 1 2 3 4 5 alias tnew=\u0026#39;tmux new -s\u0026#39; # æ–°å»ºä¸€ä¸ªä¼šè¯ alias tls=\u0026#39;tmux ls\u0026#39; alias td=\u0026#39;tmux detach\u0026#39; # åˆ†ç¦» ä¼šè¯ï¼Œä¼šä¿å­˜åˆ†ç¦»ä¹‹å‰çš„çŠ¶æ€ alias ta=\u0026#39;tmux attach -t\u0026#39; # è¿æ¥ä¼šè¯ alias tkss=\u0026#39;tmux kill-session -t\u0026#39; çª—æ ¼ç®¡ç† Tmux å¯ä»¥å°†çª—å£åˆ†æˆå¤šä¸ªçª—æ ¼ï¼ˆpaneï¼‰ï¼Œæ¯ä¸ªçª—æ ¼è¿è¡Œä¸åŒçš„å‘½ä»¤ã€‚ä»¥ä¸‹å‘½ä»¤éƒ½æ˜¯åœ¨ Tmux çª—å£ä¸­æ‰§è¡Œã€‚\nâŒƒb + %Â å·¦å³å¹³åˆ†å‡ºä¸¤ä¸ªçª—æ ¼ âŒƒb + \u0026quot;Â ä¸Šä¸‹å¹³åˆ†å‡ºä¸¤ä¸ªçª—æ ¼ âŒƒb + xÂ å…³é—­å½“å‰çª—æ ¼ âŒƒb + {Â å½“å‰çª—æ ¼å‰ç§» âŒƒb + }Â å½“å‰çª—æ ¼åç§» âŒƒb + ;Â é€‰æ‹©ä¸Šæ¬¡ä½¿ç”¨çš„çª—æ ¼ âŒƒb + oÂ é€‰æ‹©ä¸‹ä¸€ä¸ªçª—æ ¼ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ä¸Šä¸‹å·¦å³æ–¹å‘é”®æ¥é€‰æ‹© âŒƒb + spaceÂ åˆ‡æ¢çª—æ ¼å¸ƒå±€ï¼Œtmux å†…ç½®äº†äº”ç§çª—æ ¼å¸ƒå±€ï¼Œä¹Ÿå¯ä»¥é€šè¿‡Â âŒ¥1Â è‡³Â âŒ¥5æ¥åˆ‡æ¢ âŒƒb + zÂ æœ€å¤§åŒ–å½“å‰çª—æ ¼ï¼Œå†æ¬¡æ‰§è¡Œå¯æ¢å¤åŸæ¥å¤§å° âŒƒb + qÂ æ˜¾ç¤ºæ‰€æœ‰çª—æ ¼çš„åºå·ï¼Œåœ¨åºå·å‡ºç°æœŸé—´æŒ‰ä¸‹å¯¹åº”çš„æ•°å­—ï¼Œå³å¯è·³è½¬è‡³å¯¹åº”çš„çª—æ ¼ çª—å£ç®¡ç† tmux è¿˜æœ‰çª—å£ï¼ˆwindowï¼‰ çš„æ¦‚å¿µï¼Œå½“çª—æ ¼å˜å¾—æ‹¥æŒ¤çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥å†å¼€ä¸€ä¸ªçª—å£ï¼Œä¸‹é¢æ˜¯çª—å£ä¸€äº›å¸¸ç”¨çš„å¿«æ·é”®ã€‚\nâŒƒb + cÂ æ–°å»ºçª—å£ï¼Œæ­¤æ—¶å½“å‰çª—å£ä¼šåˆ‡æ¢è‡³æ–°çª—å£ï¼Œä¸å½±å“åŸæœ‰çª—å£çš„çŠ¶æ€ âŒƒb + pÂ åˆ‡æ¢è‡³ä¸Šä¸€çª—å£ âŒƒb + nÂ åˆ‡æ¢è‡³ä¸‹ä¸€çª—å£ âŒƒb + wÂ çª—å£åˆ—è¡¨é€‰æ‹©ï¼Œæ³¨æ„ macOS ä¸‹ä½¿ç”¨Â âŒƒpÂ å’ŒÂ âŒƒnÂ è¿›è¡Œä¸Šä¸‹é€‰æ‹© âŒƒb + \u0026amp;Â å…³é—­å½“å‰çª—å£ âŒƒb + ,Â é‡å‘½åçª—å£ï¼Œå¯ä»¥ä½¿ç”¨ä¸­æ–‡ï¼Œé‡å‘½ååèƒ½åœ¨ tmux çŠ¶æ€æ æ›´å¿«é€Ÿçš„è¯†åˆ«çª—å£ id âŒƒb + 0Â åˆ‡æ¢è‡³ 0 å·çª—å£ï¼Œä½¿ç”¨å…¶ä»–æ•°å­— id åˆ‡æ¢è‡³å¯¹åº”çª—å£ã€‚ âŒƒb + fÂ æ ¹æ®çª—å£åæœç´¢é€‰æ‹©çª—å£ï¼Œå¯æ¨¡ç³ŠåŒ¹é…ã€‚ æ€»ç»“ è¿™ç¯‡æ–‡ç« åªæ˜¯æ€»ç»“äº†ä¸€ä¸‹tmux çš„åŸºæœ¬ä½¿ç”¨ä»¥åŠå¿«æ·é”®ï¼Œè¿˜æœ‰å¾ˆå¤šåº”ç”¨åœºæ™¯æ²¡æœ‰æ¶‰åŠã€‚æ¯”å¦‚è·Ÿvim é…åˆå¦‚ä½•æ›´åŠ é«˜æ•ˆçš„åœ¨ vimä¸­å†™ä»£ç ã€‚å¸Œæœ›çœ‹è¿‡è¿™ç¯‡æ–‡ç« çš„æœ‹å‹ï¼Œèƒ½å¤Ÿä¸Šæ‰‹ä½“éªŒä¸€ä¸‹tmuxï¼Œ ä½¿ç”¨tmux ç”Ÿäº§åŠ›ã€‚\n","date":"2024-08-15T18:56:30+08:00","image":"https://images.hxzhouh.com/blog-images/2024/08/d46c392343d2c463c4744cc2259b42a7.png","permalink":"https://huizhou92.com/zh-cn/p/mac-tmux-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/","title":"Mac: tmux æœ€ä½³å®è·µ"},{"content":"RPCæ˜¯è¿œç¨‹è¿‡ç¨‹è°ƒç”¨çš„ç®€ç§°ï¼Œæ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ä¸åŒèŠ‚ç‚¹é—´æµè¡Œçš„é€šä¿¡æ–¹å¼ã€‚æ˜¯äº’è”ç½‘æ—¶ä»£çš„åŸºçŸ³æŠ€æœ¯ï¼ŒGoè¯­è¨€çš„æ ‡å‡†åº“ä¹Ÿæä¾›äº†ä¸€ä¸ªç®€å•çš„RPCå®ç°ï¼ŒGoè¯­è¨€çš„RPCåŒ…çš„è·¯å¾„ä¸ºnet/rpcï¼Œæœ¬ç¯‡æ–‡ç« çš„ç›®çš„æ˜¯åˆ©ç”¨net/rpc å®ç°ä¸€ä¸ªç®€å•çš„RPC æ¥å£ï¼Œå¸®åŠ©æˆ‘ä»¬æ‹¨å¼€RPC çš„è¿·é›¾ã€‚\nå¯¹Â net/rpcÂ è€Œè¨€ï¼Œä¸€ä¸ªå‡½æ•°éœ€è¦èƒ½å¤Ÿè¢«è¿œç¨‹è°ƒç”¨ï¼Œéœ€è¦æ»¡è¶³å¦‚ä¸‹äº”ä¸ªæ¡ä»¶ï¼š\nthe methodâ€™s type is exported. the method is exported. the method has two arguments, both exported (or builtin) types. the methodâ€™s second argument is a pointer. the method has return type error. ä¹Ÿå°±æ˜¯è¯´ï¼Œå¿…é¡»æ»¡è¶³ã€‚\n1 func (t *T) MethodName(argType T1, replyType *T2) error ç®€å•çš„RPCè¯·æ±‚ åŸºäºè¿™äº”ç‚¹è¦æ±‚ï¼Œæˆ‘ä»¬å¯ä»¥æ„å»ºä¸€ä¸ªç®€å•çš„RPCæ¥å£\n1 2 3 4 5 6 type HelloService struct{} func (p *HelloService) Hello(request string, reply *string) error { log.Println(\u0026#34;HelloService Hello\u0026#34;) *reply = \u0026#34;hello:\u0026#34; + request return nil } ç„¶åå°±å¯ä»¥å°†HelloServiceç±»å‹çš„å¯¹è±¡æ³¨å†Œä¸ºä¸€ä¸ªRPCæœåŠ¡ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 func main() { _ = rpc.RegisterName(\u0026#34;HelloService\u0026#34;, new(HelloService)) listener, err := net.Listen(\u0026#34;tcp\u0026#34;, \u0026#34;:1234\u0026#34;) if err != nil { log.Fatal(\u0026#34;ListenTCP error:\u0026#34;, err) } for { conn, err := listener.Accept() if err != nil { log.Fatal(\u0026#34;Accept error:\u0026#34;, err) } go rpc.ServeConn(conn) } } å®¢æˆ·ç«¯çš„å®ç°å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 func main() { conn, err := net.Dial(\u0026#34;tcp\u0026#34;, \u0026#34;:1234\u0026#34;) if err != nil { log.Fatal(\u0026#34;net.Dial:\u0026#34;, err) } client := rpc.NewClient(conn) var reply string err = client.Call(\u0026#34;HelloService.Hello\u0026#34;, \u0026#34;hello\u0026#34;, \u0026amp;reply) if err != nil { log.Fatal(err) } fmt.Println(reply) } é¦–å…ˆæ˜¯é€šè¿‡rpc.Dial Dail a RPCæœåŠ¡ï¼Œç„¶åå†é€šè¿‡client.Call()è°ƒç”¨å…·ä½“çš„RPCæ–¹æ³•ã€‚ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ç”¨ç‚¹å·é“¾æ¥çš„RPCæœåŠ¡åå­—å’Œæ–¹æ³•åå­—ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯å…¥å‚ï¼Œç¬¬ä¸‰ä¸ªä¸ºè¿”å›å€¼ï¼Œæ˜¯ä¸€ä¸ªæŒ‡é’ˆã€‚\nç”±è¿™ä¸ªä¾‹å­å¯ä»¥çœ‹å‡ºRPCçš„ä½¿ç”¨å…¶å®éå¸¸ç®€å•ã€‚\nåœ¨ Server ä¸Client çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬éƒ½éœ€è¦å»è®°å¿† RPC æœåŠ¡çš„åå­—HelloService ä»¥åŠï¼Œæ¥å£åå­—Helloã€‚è¿™åœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼Œå¾ˆå®¹æ˜“å‡ºé”™ï¼Œæˆ‘ä»¬å¯ä»¥ç¨å¾®å°è£…ä¸€ä¸‹ã€‚å°†å…¬å…±çš„éƒ¨åˆ†æŠ½å‡ºæ¥ï¼Œå®Œæ•´çš„ä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 // server.go const ServerName = \u0026#34;HelloService\u0026#34; type HelloServiceInterface = interface { Hello(request string, reply *string) error } func RegisterHelloService(srv HelloServiceInterface) error { return rpc.RegisterName(ServerName, srv) } type HelloService struct{} func (p *HelloService) Hello(request string, reply *string) error { log.Println(\u0026#34;HelloService Hello\u0026#34;) *reply = \u0026#34;hello:\u0026#34; + request return nil } func main() { _ = RegisterHelloService(new(HelloService)) listener, err := net.Listen(\u0026#34;tcp\u0026#34;, \u0026#34;:1234\u0026#34;) if err != nil { log.Fatal(\u0026#34;ListenTCP error:\u0026#34;, err) } for { conn, err := listener.Accept() if err != nil { log.Fatal(\u0026#34;Accept error:\u0026#34;, err) } go rpc.ServeConn(conn) } } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 // client.go type HelloServiceClient struct { *rpc.Client } var _ HelloServiceInterface = (*HelloServiceClient)(nil) const ServerName = \u0026#34;HelloService\u0026#34; func DialHelloService(network, address string) (*HelloServiceClient, error) { conn, err := net.Dial(network, address) client := rpc.NewClient(conn) if err != nil { return nil, err } return \u0026amp;HelloServiceClient{Client: client}, nil } func (p *HelloServiceClient) Hello(request string, reply *string) error { return p.Client.Call(ServerName+\u0026#34;.Hello\u0026#34;, request, reply) } func main() { client, err := DialHelloService(\u0026#34;tcp\u0026#34;, \u0026#34;localhost:1234\u0026#34;) if err != nil { log.Fatal(\u0026#34;net.Dial:\u0026#34;, err) } var reply string err = client.Hello(\u0026#34;hello\u0026#34;, \u0026amp;reply) if err != nil { log.Fatal(err) } fmt.Println(reply) } æ˜¯ä¸æ˜¯å·²ç»æœ‰ç‚¹çœ¼ç†Ÿäº†ï¼Ÿ\ncodec æ ‡å‡†åº“çš„RPCé»˜è®¤é‡‡ç”¨Goè¯­è¨€ç‰¹æœ‰çš„Gobç¼–ç ï¼Œä½†æ˜¯æˆ‘ä»¬å¾ˆå®¹æ˜“åœ¨ä¸Šé¢å®ç°å…¶ä»–ç¼–ç ï¼Œæ¯”å¦‚Protobufï¼ŒJSON ç­‰ã€‚æ ‡å‡†åº“ä¸­å·²ç»æ”¯æŒäº†jsonrpcç¼–ç ï¼Œæˆ‘ä»¬åªéœ€è¦ç¨å¾®æ”¹åŠ¨ä¸€ä¸‹æœåŠ¡ç«¯ä¸å®¢æˆ·ç«¯ä»£ç ï¼Œå°±èƒ½å®ç°JSONç¼–ç \n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 // server.go func main() { _ = rpc.RegisterName(\u0026#34;HelloService\u0026#34;, new(HelloService)) listener, err := net.Listen(\u0026#34;tcp\u0026#34;, \u0026#34;:1234\u0026#34;) if err != nil { log.Fatal(\u0026#34;ListenTCP error:\u0026#34;, err) } for { conn, err := listener.Accept() if err != nil { log.Fatal(\u0026#34;Accept error:\u0026#34;, err) } go rpc.ServeCodec(jsonrpc.NewServerCodec(conn)) //go rpc.ServeConn(conn) } } //client.go func DialHelloService(network, address string) (*HelloServiceClient, error) { conn, err := net.Dial(network, address) //client := rpc.NewClient(conn) client := rpc.NewClientWithCodec(jsonrpc.NewClientCodec(conn)) if err != nil { return nil, err } return \u0026amp;HelloServiceClient{Client: client}, nil } è¯·æ±‚çš„JSONæ•°æ®å¯¹è±¡åœ¨å†…éƒ¨å¯¹åº”ä¸¤ä¸ªç»“æ„ä½“ï¼šå®¢æˆ·ç«¯æ˜¯clientRequestï¼ŒæœåŠ¡å™¨ç«¯æ˜¯ serverRequest ã€‚clientRequestå’ŒserverRequestç»“æ„ä½“çš„å†…å®¹åŸºæœ¬æ˜¯ä¸€è‡´çš„ï¼š\n1 2 3 4 5 6 7 8 9 10 type clientRequest struct { Method string `json:\u0026#34;method\u0026#34;` Params [1]any `json:\u0026#34;params\u0026#34;` Id uint64 `json:\u0026#34;id\u0026#34;` } type serverRequest struct { Method string `json:\u0026#34;method\u0026#34;` Params *json.RawMessage `json:\u0026#34;params\u0026#34;` Id *json.RawMessage `json:\u0026#34;id\u0026#34;` } å…¶ä¸­ï¼ŒMethod è¡¨ç¤ºæœåŠ¡åå­—ï¼Œå®ƒæ˜¯ serviceName +Method ç»„æˆã€‚ paramséƒ¨åˆ†çš„ç¬¬ä¸€ä¸ªå…ƒç´ ä¸ºå‚æ•°ï¼Œidæ˜¯ç”±è°ƒç”¨æ–¹ç»´æŠ¤çš„å”¯ä¸€çš„è°ƒç”¨ç¼–å·ã€‚ç”¨äºåœ¨å¹¶å‘åœºåœºæ™¯ä¸‹åŒºåˆ†è¯·æ±‚ã€‚\næˆ‘ä»¬å¯ä»¥ç”¨nc æ¥æ¨¡æ‹ŸæœåŠ¡ç«¯ï¼Œç„¶åè¿è¡Œå®¢æˆ·ç«¯ä»£ç ï¼Œçœ‹çœ‹ä½¿ç”¨jsonç¼–ç çš„å®¢æˆ·ç«¯ä¼šç»™æœåŠ¡ç«¯å‘é€ä»€ä¹ˆä¿¡æ¯ï¼Œ\n1 nc -l 1234 nc æ”¶åˆ°çš„æ•°æ®ä¸ºï¼š\n1 {\u0026#34;method\u0026#34;:\u0026#34;HelloService.Hello\u0026#34;,\u0026#34;params\u0026#34;:[\u0026#34;hello\u0026#34;],\u0026#34;id\u0026#34;:0} è·Ÿ serverRequest ä¸€è‡´ã€‚\næˆ‘ä»¬ä¹Ÿå¯ä»¥è¿è¡Œ æœåŠ¡ç«¯ä»£ç ï¼Œç„¶åä½¿ç”¨ nc å‘é€è¯·æ±‚ã€‚\n1 2 3 echo -e \u0026#39;{\u0026#34;method\u0026#34;:\u0026#34;HelloService.Hello\u0026#34;,\u0026#34;params\u0026#34;:[\u0026#34;Hello\u0026#34;],\u0026#34;Id\u0026#34;:1}\u0026#39; | nc localhost 1234 --- {\u0026#34;id\u0026#34;:1,\u0026#34;result\u0026#34;:\u0026#34;hello:Hello\u0026#34;,\u0026#34;error\u0026#34;:null} æ€»ç»“ æœ¬æ–‡ä»‹ç»äº† Go æ ‡å‡†åº“ä¸­çš„rpcï¼Œå®ƒä½¿ç”¨éå¸¸ç®€å•ï¼Œæ€§èƒ½å¼‚å¸¸å¼ºå¤§ã€‚å¾ˆå¤šrpcçš„ç¬¬ä¸‰æ–¹åº“éƒ½æ˜¯å¯¹rpcçš„å°è£…ã€‚æ–‡ç« å¾ˆç®€å•ï¼Œç­‰äºæ˜¯ç»™RPCç ”ç©¶ç³»åˆ—å¼€äº†ä¸€ä¸ªå¤´ã€‚ä¸‹ä¸€ç¯‡æ–‡ç« ï¼Œæˆ‘ä»¬ä¼šå°†protobuf è·ŸRPCç»“åˆèµ·æ¥ï¼Œæœ€ç»ˆï¼Œæˆ‘ä»¬ä¼šå®ç°ä¸€ä¸ªè‡ªå·±çš„RPCæ¡†æ¶ã€‚\n","date":"2024-08-13T18:24:42+08:00","image":"https://images.hxzhouh.com/blog-images/2024/08/d4dddb722300af56ecbb03cefdf1aec1.png","permalink":"https://huizhou92.com/zh-cn/p/%E8%AE%A4%E8%AF%86rpc/","title":"è®¤è¯†RPC"},{"content":"åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ç”¨net/rpc åŒ…å®ç°äº†ä¸€ä¸ªç®€å•çš„ RPCæ¥å£ï¼Œå¹¶ä¸”å°è¯•äº†net/rpcè‡ªå¸¦çš„Gobç¼–ç ä»¥åŠJSONç¼–ç ï¼Œå­¦ä¹ äº†Golang RPC çš„ä¸€äº›åŸºæœ¬çŸ¥è¯†ã€‚æœ¬ç¯‡æ–‡ç« ï¼Œæˆ‘ä¼šå°†net/rpc è·Ÿ protobufç»“åˆèµ·æ¥ï¼Œç„¶ååœ¨äº†è§£ä¸€ä¸‹å¦‚ä½•ä½¿ç”¨Protobuf + æ’ä»¶ ç”Ÿæˆ gRPC çš„ä»£ç ã€‚ æœ€åä¼šå°è¯•åˆ›å»ºä¸€ä¸ªè‡ªå·±çš„protobufæ’ä»¶æ¥å¸®åŠ©æˆ‘ä»¬ç”Ÿæˆä»£ç ï¼Œå¼€å§‹å§ã€‚\nThis article was first published in the Medium MPP plan. If you are a Medium user, please follow me on Medium. Thank you very much.\næˆ‘ä»¬åœ¨å·¥ä½œè¿‡ç¨‹ä¸­ä¸€å®šä½¿ç”¨è¿‡gRPC + protobuf ,ä½†æ˜¯å®ƒä»¬ä¸¤ä¸ªå¹¶ä¸æ˜¯ç»‘å®šå…³ç³»ï¼ŒgRPCå¯ä»¥ä½¿ç”¨JSONç¼–ç ï¼Œprotobufä¹Ÿå¯ä»¥åœ¨å…¶ä»–è¯­è¨€ä¸­å®ç°ã€‚\nProtocol Buffers æ˜¯è°·æ­Œæ¨å‡ºçš„ç¼–ç æ ‡å‡†ï¼Œå®ƒåœ¨ä¼ è¾“æ•ˆç‡å’Œç¼–è§£ç æ€§èƒ½ä¸Šéƒ½è¦ä¼˜äº JSONã€‚ä½†å…¶ä»£ä»·åˆ™æ˜¯éœ€è¦ä¾èµ–ä¸­é—´æè¿°è¯­è¨€ï¼ˆIDLï¼‰æ¥å®šä¹‰æ•°æ®å’ŒæœåŠ¡çš„ç»“æ„ï¼ˆÂ *.protoÂ æ–‡ä»¶ï¼‰ï¼Œå¹¶ä¸”éœ€è¦ä¸€æ•´å¥—çš„å·¥å…·é“¾ï¼ˆprotoc åŠå…¶æ’ä»¶ï¼‰æ¥ç”Ÿæˆå¯¹åº”çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–ä»£ç ã€‚\né™¤äº†è°·æ­Œå®˜æ–¹æä¾›çš„å·¥å…·å’Œæ’ä»¶ï¼ˆæ¯”å¦‚ç”Ÿæˆ go ä»£ç çš„ protoc-gen-goï¼‰å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥å¼€å‘æˆ–å®šåˆ¶è‡ªå·±çš„æ’ä»¶ï¼Œæ ¹æ®ä¸šåŠ¡éœ€è¦æŒ‰ç…§ proto æ–‡ä»¶çš„å®šä¹‰ç”Ÿæˆä»£ç æˆ–è€…æ–‡æ¡£ã€‚ç”± IDL ç”Ÿæˆä»£ç æˆ–è€…æ–‡æ¡£æ˜¯å…ƒç¼–ç¨‹çš„ä¸€ç§å½¢å¼ï¼Œå¯ä»¥æå¤§çš„è§£æ”¾ç¨‹åºå‘˜çš„ç”Ÿäº§åŠ›ã€‚\nä¸€ä¸ªä½¿ç”¨protobuf çš„ä¾‹å­ é¦–å…ˆæˆ‘ä»¬å†™ä¸€ä¸ªproto æ–‡ä»¶ hello-service.protoï¼Œå®šä¹‰ä¸€ä¸ªmessage â€œStringâ€œ\n1 2 3 4 5 6 7 syntax = \u0026#34;proto3\u0026#34;; package api; option go_package=\u0026#34;api\u0026#34;; message String { string value = 1; } ç„¶åä½¿ç”¨protoc å·¥å…·ç”Ÿæˆmessage String çš„ Goä»£ç \n1 protoc --go_out=./api proto/hello.proto ç”Ÿæˆçš„ä»£ç  é‡Œé¢æœ‰ä¸€ä¸ª String struct\n1 2 3 4 5 6 type String struct { Value string `protobuf:\u0026#34;bytes,1,opt,name=value,proto3\u0026#34; json:\u0026#34;value,omitempty\u0026#34;` XXX_NoUnkeyedLiteral struct{} `json:\u0026#34;-\u0026#34;` XXX_unrecognized []byte `json:\u0026#34;-\u0026#34;` XXX_sizecache int32 `json:\u0026#34;-\u0026#34;` } æˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨å®ƒï¼Œä¿®æ”¹ä¸€ä¸‹å‡½æ•°çš„å‚æ•°ã€‚\n1 2 3 type HelloServiceInterface = interface { Hello(request api.String, reply *api.String) error } å…¶å®ä½¿ç”¨èµ·æ¥è·Ÿä»¥å‰æ²¡ä»€ä¹ˆåŒºåˆ«ã€‚ç”šè‡³è¿˜ä¸å¦‚ç›´æ¥ä½¿ç”¨stringæ–¹ä¾¿ã€‚\né‚£ä¹ˆæˆ‘ä»¬ä¸ºä»€ä¹ˆè¦ä½¿ç”¨Protobuf?\næ­£å¦‚å‰é¢æ‰€è¯´çš„ï¼Œç”¨Protobufå®šä¹‰ä¸è¯­è¨€æ— å…³çš„RPCæœåŠ¡æ¥å£ä»¥åŠmessageï¼Œç„¶åä½¿ç”¨protocå·¥å…·ç”Ÿæˆä¸åŒè¯­è¨€çš„ä»£ç ï¼Œæ‰æ˜¯å®ƒçœŸæ­£çš„ä»·å€¼æ‰€åœ¨ã€‚\nprotoc çš„æ’ä»¶ç³»ç»Ÿ protobufæ˜¯ä¸€ä¸ªä¸ç¼–ç¨‹è¯­è¨€æ— å…³çš„åè®®ã€‚å®ƒé€šè¿‡protocè·Ÿå„ç§ä¸åŒçš„æ’ä»¶æ¥å°†protobufæ–‡ä»¶ç¼–è¯‘æˆä¸åŒçš„ç¼–ç¨‹è¯­è¨€ï¼Œæˆ‘ä»¬ä»¥Golang+gRPC ä¸ºä¾‹å­ã€‚\n1 protoc --go_out=plugins=grpc. hello-service.proto è¿™é‡Œæœ‰ä¸€ä¸ªÂ --go_outÂ å‚æ•°ã€‚å› ä¸ºæˆ‘ä»¬è°ƒç”¨çš„æ’ä»¶æ˜¯protoc-gen-goï¼Œæ‰€ä»¥å‚æ•°åå­—å« go_outï¼›å¦‚æœåå­—å« XXXï¼Œé‚£å‚æ•°åå­—å°±å« XXX_outã€‚\nprotoc åœ¨è¿è¡Œçš„æ—¶å€™é¦–å…ˆä¼šè§£æ proto æ–‡ä»¶çš„æ‰€æœ‰å†…å®¹ï¼Œç”Ÿæˆä¸€ç»„ Protocol Buffers ç¼–ç çš„æè¿°æ•°æ®ï¼Œé¦–å…ˆä¼šåˆ¤æ–­protoc å†…éƒ¨æ˜¯å¦åŒ…å«goæ’ä»¶, ç„¶åä¼šå°è¯•åœ¨$PATH é‡Œé¢å¯»æ‰¾protoc-gen-goï¼Œæ‰¾ä¸åˆ°ä¼šæŠ¥é”™ï¼Œç„¶åè¿è¡Œprotoc-gen-go å‘½ä»¤ï¼Œå¹¶ä¸”é€šè¿‡ stdin å°†æè¿°æ•°æ®å‘é€ç»™æ’ä»¶å‘½ä»¤ã€‚æ’ä»¶ç”Ÿæˆå¥½æ–‡ä»¶å†…å®¹åå†å‘ stdout è¾“å…¥ Protocol Buffers ç¼–ç çš„æ•°æ®æ¥å‘Šè¯‰ protoc ç”Ÿæˆå…·ä½“çš„æ–‡ä»¶ã€‚\nplugins=grpc æ˜¯ ä¸ºäº†è°ƒç”¨protoc-gen-go è‡ªå¸¦çš„ä¸€ä¸ªæ’ä»¶ï¼Œå¦‚æœä¸ä½¿ç”¨å®ƒï¼Œé‚£ä¹ˆåªä¼šç”Ÿæˆ Go è¯­è¨€ çš„messageä¿¡æ¯ï¼Œä½¿ç”¨è¿™ä¸ªæ’ä»¶æ‰ä¼šç”Ÿæˆgrpc ç›¸å…³çš„ä»£ç ã€‚\nè‡ªå®šä¹‰ä¸€ä¸ª protoc æ’ä»¶ å¦‚æœåœ¨protobuf ä¸­æ·»åŠ Hello æ¥å£çš„å®šæ—¶ï¼Œæˆ‘ä»¬æ˜¯ä¸æ˜¯å¯ä»¥è‡ªå®šä¹‰ä¸€ä¸ª protoc æ’ä»¶ï¼Œç›´æ¥ç”Ÿæˆä»£ç ï¼Ÿ\n1 2 3 4 5 6 7 8 9 syntax = \u0026#34;proto3\u0026#34;; package api; option go_package=\u0026#34;./api\u0026#34;; service HelloService { rpc Hello (String) returns (String) {} } message String { string value = 1; } ç›®æ ‡ è¿™ç¯‡æ–‡ç« ï¼Œæˆ‘çš„ç›®æ ‡æ˜¯åˆ›å»ºä¸€ä¸ªæ’ä»¶ï¼Œç„¶åç”¨æ¥ç”ŸæˆRPC çš„æœåŠ¡ç«¯ä¸å®¢æˆ·ç«¯ä»£ç ï¼Œç”Ÿæˆçš„ä»£ç å¤§è‡´æ˜¯è¿™æ ·çš„ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 // HelloService_rpc.pb.go type HelloServiceInterface interface { Hello(String, *String) error } func RegisterHelloService( srv *rpc.Server, x HelloServiceInterface, ) error { if err := srv.RegisterName(\u0026#34;HelloService\u0026#34;, x); err != nil { return err } return nil } type HelloServiceClient struct { *rpc.Client } var _ HelloServiceInterface = (*HelloServiceClient)(nil) func DialHelloService(network, address string) ( *HelloServiceClient, error, ) { c, err := rpc.Dial(network, address) if err != nil { return nil, err } return \u0026amp;HelloServiceClient{Client: c}, nil } func (p *HelloServiceClient) Hello( in String, out *String, ) error { return p.Client.Call(\u0026#34;HelloService.Hello\u0026#34;, in, out) } è¿™æ ·æˆ‘ä»¬çš„ä¸šåŠ¡ä»£ç å°±èƒ½æ”¹æˆä¸‹é¢è¿™ä¸ªæ ·å­ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 // service func main() { listener, err := net.Listen(\u0026#34;tcp\u0026#34;, \u0026#34;:1234\u0026#34;) if err != nil { log.Fatal(\u0026#34;ListenTCP error:\u0026#34;, err) } _ = api.RegisterHelloService(rpc.DefaultServer, new(HelloService)) for { conn, err := listener.Accept() if err != nil { log.Fatal(\u0026#34;Accept error:\u0026#34;, err) } go rpc.ServeConn(conn) } } type HelloService struct{} func (p *HelloService) Hello(request api.String, reply *api.String) error { log.Println(\u0026#34;HelloService.proto Hello\u0026#34;) *reply = api.String{Value: \u0026#34;Hello:\u0026#34; + request.Value} return nil } // client.go func main() { client, err := api.DialHelloService(\u0026#34;tcp\u0026#34;, \u0026#34;localhost:1234\u0026#34;) if err != nil { log.Fatal(\u0026#34;net.Dial:\u0026#34;, err) } reply := \u0026amp;api.String{} err = client.Hello(api.String{Value: \u0026#34;Hello\u0026#34;}, reply) if err != nil { log.Fatal(err) } log.Println(reply) } åŸºäºç”Ÿæˆçš„ä»£ç ï¼Œæˆ‘ä»¬çš„å·¥ä½œé‡å·²ç»å°äº†å¾ˆå¤šï¼Œå¹¶ä¸”å‡ºé”™çš„å‡ ç‡å·²ç»å¾ˆå°äº†ã€‚ä¸€ä¸ªä¸é”™çš„å¼€å§‹ã€‚\næ ¹æ®ä¸Šé¢çš„apiä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥æŠ½å‡ºæ¥ä¸€ä¸ªæ¨¡æ¿æ–‡ä»¶ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 const tmplService = ` package {{.PackageName}} import ( \u0026#34;net/rpc\u0026#34;) {{$root := .}} type {{.ServiceName}}Interface interface { {{- range $_, $m := .MethodList}} {{$m.MethodName}}({{$m.InputTypeName}}, *{{$m.OutputTypeName}}) error {{- end}}} func Register{{.ServiceName}}( srv *rpc.Server, x {{.ServiceName}}Interface,) error { if err := srv.RegisterName(\u0026#34;{{.ServiceName}}\u0026#34;, x); err != nil { return err } return nil} type {{.ServiceName}}Client struct { *rpc.Client} var _ {{.ServiceName}}Interface = (*{{.ServiceName}}Client)(nil) func Dial{{.ServiceName}}(network, address string) ( *{{.ServiceName}}Client, error,) { c, err := rpc.Dial(network, address) if err != nil { return nil, err } return \u0026amp;{{.ServiceName}}Client{Client: c}, nil} {{range $_, $m := .MethodList}} func (p *{{$root.ServiceName}}Client) {{$m.MethodName}}( in {{$m.InputTypeName}}, out *{{$m.OutputTypeName}},) error { return p.Client.Call(\u0026#34;{{$root.ServiceName}}.{{$m.MethodName}}\u0026#34;, in, out)} {{end}} ` æ•´ä¸ªæ¨¡æ¿å¾ˆæ¸…æ™°ï¼Œé‡Œé¢æœ‰ä¸€äº›å ä½ç¬¦ï¼Œæ¯”å¦‚ MethodNameï¼ŒServiceName ç­‰ï¼Œæˆ‘ä»¬åé¢ä¼šä»‹ç»ã€‚\nå¦‚ä½•å¼€å‘ ä¸€ä¸ªæ’ä»¶ï¼Ÿ è°·æ­Œå‘å¸ƒäº† Go è¯­è¨€ API1ï¼Œå…¶ä¸­å¼•å…¥äº†ä¸€ä¸ªæ–°åŒ…Â google.golang.org/protobuf/compiler/protogen ï¼Œæå¤§çš„é™ä½äº†plugins å¼€å‘éš¾åº¦ï¼š\né¦–å…ˆæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªgo è¯­è¨€å·¥ç¨‹ï¼Œæ¯”å¦‚protoc-gen-go-spprpc ç„¶åæˆ‘ä»¬éœ€è¦å®šä¹‰ä¸€ä¸ªprotogen.Optionsï¼Œç„¶åè°ƒç”¨å®ƒçš„Runæ–¹æ³•ï¼Œå¹¶ä¼ å…¥ä¸€ä¸ªÂ func(*protogen.Plugin) errorå›è°ƒã€‚ä¸»æµç¨‹ä»£ç åˆ°æ­¤å°±ç»“æŸäº†ã€‚ æˆ‘ä»¬è¿˜å¯ä»¥è®¾ç½®protogen.Optionsçš„ParamFuncå‚æ•°ï¼Œè¿™æ · protogen ä¼šè‡ªåŠ¨ä¸ºæˆ‘ä»¬è§£æå‘½ä»¤è¡Œä¼ å…¥çš„å‚æ•°ã€‚è¯¸å¦‚ä»æ ‡å‡†è¾“å…¥è¯»å–å¹¶è§£ç  protobuf ä¿¡æ¯ï¼Œå°†è¾“å…¥ä¿¡æ¯ç¼–ç æˆ protobuf å†™å…¥ stdout ç­‰æ“ä½œå…¨éƒ¨ç”± protogen åŒ…åŠäº†ã€‚æˆ‘ä»¬è¦åšçš„å°±æ˜¯ä¸Â protogen.PluginÂ äº¤äº’å®ç°ä»£ç ç”Ÿæˆé€»è¾‘ã€‚ æ¯ä¸ªæœåŠ¡æœ€é‡è¦çš„æ˜¯æœåŠ¡çš„åå­—ï¼Œç„¶åæ¯ä¸ªæœåŠ¡æœ‰ä¸€ç»„æ–¹æ³•ã€‚è€Œå¯¹äºæœåŠ¡å®šä¹‰çš„æ–¹æ³•ï¼Œæœ€é‡è¦çš„æ˜¯æ–¹æ³•çš„åå­—ï¼Œè¿˜æœ‰è¾“å…¥å‚æ•°å’Œè¾“å‡ºå‚æ•°ç±»å‹çš„åå­—ã€‚æˆ‘ä»¬é¦–å…ˆå®šä¹‰ä¸€ä¸ªServiceDataï¼Œç”¨äºæè¿°æœåŠ¡çš„å…ƒä¿¡æ¯ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 // ServiceData ç»“æ„ä½“å®šä¹‰ type ServiceData struct { PackageName string ServiceName string MethodList []Method } // Method ç»“æ„ä½“å®šä¹‰ type Method struct { MethodName string InputTypeName string OutputTypeName string } ç„¶åå°±æ˜¯ä¸»é€»è¾‘ï¼Œä»¥åŠä»£ç ç”Ÿæˆé€»è¾‘ï¼Œæœ€åè°ƒç”¨tmplç”Ÿæˆä»£ç ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 func main() { protogen.Options{}.Run(func(gen *protogen.Plugin) error { for _, file := range gen.Files { if !file.Generate { continue } generateFile(gen, file) } return nil }) } // generateFile å‡½æ•°å®šä¹‰ func generateFile(gen *protogen.Plugin, file *protogen.File) { filename := file.GeneratedFilenamePrefix + \u0026#34;_rpc.pb.go\u0026#34; g := gen.NewGeneratedFile(filename, file.GoImportPath) tmpl, err := template.New(\u0026#34;service\u0026#34;).Parse(tmplService) if err != nil { log.Fatalf(\u0026#34;Error parsing template: %v\u0026#34;, err) } packageName := string(file.GoPackageName) // éå†æ¯ä¸ªæœåŠ¡ç”Ÿæˆä»£ç  for _, service := range file.Services { serviceData := ServiceData{ ServiceName: service.GoName, PackageName: packageName, } for _, method := range service.Methods { inputType := method.Input.GoIdent.GoName outputType := method.Output.GoIdent.GoName serviceData.MethodList = append(serviceData.MethodList, Method{ MethodName: method.GoName, InputTypeName: inputType, OutputTypeName: outputType, }) } // æ‰§è¡Œæ¨¡æ¿æ¸²æŸ“ err = tmpl.Execute(g, serviceData) if err != nil { log.Fatalf(\u0026#34;Error executing template: %v\u0026#34;, err) } } } è°ƒè¯•æ’ä»¶ æœ€åæˆ‘ä»¬å°†ç¼–è¯‘åçš„ äºŒè¿›åˆ¶æ‰§è¡Œæ–‡ä»¶protoc-gen-go-spprpcï¼Œæ”¾åœ¨$PATH é‡Œé¢ï¼Œ ç„¶åè¿è¡Œprotoc å°±èƒ½ç”Ÿæˆæˆ‘ä»¬æƒ³è¦çš„ä»£ç äº†ã€‚\n1 protoc --go_out=.. --go-spprpc_out=.. HelloService.proto å› ä¸ºprotoc-gen-go-spprpc å¿…é¡»ä¾èµ– protoc æ‰èƒ½è¿è¡Œï¼Œæ‰€ä»¥è°ƒè¯•èµ·æ¥æ¯”è¾ƒéº»çƒ¦ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨\nfmt.Fprintf(os.Stderr, \u0026quot;Fprintln: %v\\n\u0026quot;, err) æ‰“å°é”™è¯¯æ—¥å¿—çš„æ–¹å¼è°ƒè¯•ã€‚\næ€»ç»“ ä»¥ä¸Šå°±æ˜¯æœ¬æ–‡çš„å…¨éƒ¨å†…å®¹äº†ã€‚æˆ‘ä»¬é¦–å…ˆä½¿ç”¨protobuf å®ç°äº†ä¸€ä¸ªrpc callï¼Œç„¶ååˆ›å»ºäº†ä¸€ä¸ªprotobuf æ’ä»¶æ¥å¸®åŠ©æˆ‘ä»¬ç”Ÿæˆä»£ç ã€‚ä¸ºæˆ‘ä»¬æ‰“å¼€äº†ä¸€æ‰‡å­¦ä¹ protobuf + RPC çš„å¤§é—¨ï¼Œä¹Ÿæ˜¯æˆ‘ä»¬é€šå¾€å½»åº•ç†è§£gRPCçš„è·¯ã€‚å¸Œæœ›å¤§å®¶éƒ½èƒ½æŒæ¡è¿™ä¸ªæŠ€æœ¯ã€‚\nå‚è€ƒæ–‡æ¡£ https://taoshu.in/go/create-protoc-plugin.html https://chai2010.cn/advanced-go-programming-book/ch4-rpc/ch4-02-pb-intro.html ","date":"2024-08-13T16:10:53+08:00","permalink":"https://huizhou92.com/zh-cn/p/rpc%E5%AE%9E%E8%B7%B5-ep2-protobuf%E4%B8%8E-%E5%AE%83%E7%9A%84%E6%8F%92%E4%BB%B6%E7%B3%BB%E7%BB%9F/","title":"RPCå®è·µ EP2: Protobufä¸ å®ƒçš„æ’ä»¶ç³»ç»Ÿã€‚"},{"content":"ä»Go ç¼–è¯‘å™¨çš„è§’åº¦æ¥çœ‹ï¼Œå†…å­˜ä¼šè¢«åˆ†é…åˆ°ä¸¤ä¸ªåœ°æ–¹: stack å’Œ heapã€‚å¯¹äºä¸šåŠ¡å¼€å‘äººå‘˜æ¥è¯´ï¼Œè¿™ä¸¤ç§æ–¹å¼ï¼Œæ²¡ä»€ä¹ˆåŒºåˆ«ï¼Œé€šå¸¸å¼€å‘è€…å¹¶ä¸éœ€è¦å…³å¿ƒå†…å­˜åˆ†é…åœ¨æ ˆä¸Šï¼Œè¿˜æ˜¯å †ä¸Šï¼Œå› ä¸ºè¿™éƒ½æ˜¯ç¼–è¯‘å™¨è‡ªåŠ¨å®Œæˆçš„ã€‚ä½†æ˜¯ä»æ€§èƒ½çš„è§’åº¦å‡ºå‘ï¼Œåœ¨æ ˆä¸Šåˆ†é…å†…å­˜å’Œåœ¨å †ä¸Šåˆ†é…å†…å­˜ï¼Œæ€§èƒ½å·®å¼‚æ˜¯éå¸¸å¤§çš„ã€‚åœ¨å‡½æ•°ä¸­ç”³è¯·ä¸€ä¸ªå¯¹è±¡ï¼Œå¦‚æœåˆ†é…åœ¨æ ˆä¸­ï¼Œå‡½æ•°æ‰§è¡Œç»“æŸæ—¶è‡ªåŠ¨å›æ”¶ã€‚å¦‚æœåˆ†é…åœ¨å †ä¸­ï¼Œåˆ™æ˜¯ç”±GCç®—æ³•åœ¨æŸä¸ªæ—¶é—´ç‚¹è¿›è¡Œåƒåœ¾å›æ”¶ï¼Œå…¶ä¸­çš„åŸç†æ¯”è¾ƒå¤æ‚ã€‚æ€»ä¹‹ï¼Œåˆ†é…å †å†…å­˜æ¯”æ ˆå†…å­˜éœ€è¦æ›´å¤šçš„å¼€é”€ï¼Œè¿™ç§å°†å†…å­˜åˆ†é…åˆ°å †çš„ç°è±¡å°±æ˜¯å†…å­˜é€ƒé€¸ã€‚æˆ‘ä»¬åœ¨å†™ä»£ç çš„æ—¶å€™ï¼Œåº”å½“å°½é‡é¿å…å †å†…å­˜åˆ†é…ã€‚\nä¸ºä»€ä¹ˆä¼šæœ‰å†…å­˜é€ƒé€¸ï¼Ÿ åŸå› å…¶å®å¾ˆç®€å•ï¼Œç¼–è¯‘å™¨æ— æ³•ç¡®å®šå˜é‡çš„ç”Ÿå­˜å‘¨æœŸï¼Œæˆ–è€…æ ˆç©ºé—´æ”¾ä¸ä¸‹é‚£ä¹ˆå¤§çš„å†…å­˜ã€‚Go ç¼–è¯‘å™¨æ€ä¹ˆçŸ¥é“æŸä¸ªå˜é‡éœ€è¦åˆ†é…åœ¨æ ˆä¸Šï¼Œè¿˜æ˜¯å †ä¸Šå‘¢ï¼Ÿç¼–è¯‘å™¨å†³å®šå†…å­˜åˆ†é…ä½ç½®çš„æ–¹å¼ï¼Œå°±ç§°ä¹‹ä¸ºé€ƒé€¸åˆ†æ(escape analysis)ã€‚é€ƒé€¸åˆ†æç”±ç¼–è¯‘å™¨å®Œæˆï¼Œä½œç”¨äºç¼–è¯‘é˜¶æ®µã€‚å¯ä»¥ç”¨ -gcflags=-m æ¥è§‚å¯Ÿå˜é‡æ˜¯å¦é€ƒé€¸ã€‚\nå†…å­˜é€ƒé€¸å¯¹æ€§èƒ½çš„å½±å“ å¯ä»¥åšä¸€ä¸ªå¾ˆç®€å•çš„benchmarkæµ‹è¯•, BenchmarkInt æ˜¯ä¸€ä¸ªæŒ‡é’ˆæ•°ç»„ï¼Œ\u0026amp;j ä¼šäº§ç”Ÿå†…å­˜é€ƒé€¸ï¼Œ BenchmarkInt2 åˆ™ä¸ä¼šäº§ç”Ÿ å†…å­˜é€ƒé€¸ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 func BenchmarkInt(b *testing.B) { for i := 0; i \u0026lt; b.N; i++ { a := make([]*int, 100) for j := 0; j \u0026lt; 100; j++ { a[j] = \u0026amp;j } } } func BenchmarkInt2(b *testing.B) { for i := 0; i \u0026lt; b.N; i++ { a := make([]int, 100) for j := 0; j \u0026lt; 100; j++ { a[j] = j } } } è¿è¡Œç»“æœæ˜¯ï¼š\nBenchmarkInt2 çš„æ¯”BenchmarkInt å¿«30å€ï¼Œå¹¶ä¸”æ²¡æœ‰ä¸€æ¬¡å†…å­˜åˆ†é…ï¼ŒBenchmarkInt åˆ™æœ‰101æ¬¡å†…å­˜åˆ†é…ã€‚ ä»è¿™ä¸ªæµ‹è¯•æˆ‘ä»¬å°±çŸ¥é“ä¸ºä»€ä¹ˆæœ‰å¿…è¦è¿›è¡Œå†…å­˜é€ƒé€¸åˆ†æäº†ã€‚\nå†…å­˜é€ƒé€¸çš„å…¸å‹åœºæ™¯ å˜é‡é€ƒé€¸ \u0026amp; æŒ‡é’ˆé€ƒé€¸ å½“ä¸€ä¸ªå˜é‡çš„ç”Ÿå‘½å‘¨æœŸè¶…å‡ºå‡½æ•°èŒƒå›´æ—¶ï¼Œç¼–è¯‘å™¨ä¼šå°†å…¶åˆ†é…åˆ°å †ä¸Šï¼Œæˆ‘ä»¬å«è¿™ç§ç°è±¡ä¸ºå†…å­˜å˜é‡é€ƒé€¸ï¼Œæˆ–è€…æŒ‡é’ˆé€ƒé€¸ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 package main import \u0026#34;fmt\u0026#34; func main() { s := makeString() fmt.Println(s) } func makeString() *string { str := \u0026#34;Hello, World!\u0026#34; return \u0026amp;str } æ ˆæº¢å‡º æ“ä½œç³»ç»Ÿå¯¹å†…æ ¸çº¿ç¨‹ä½¿ç”¨çš„æ ˆç©ºé—´æ˜¯æœ‰å¤§å°é™åˆ¶çš„ï¼Œåœ¨64ä½æ“ä½œç³»ç»Ÿä¸Šé¢ï¼Œè¿™ä¸ªå¤§å°é€šå¸¸æ˜¯8 MBã€‚å¯ä»¥ä½¿ç”¨Â ulimit -aÂ å‘½ä»¤æŸ¥çœ‹è®¡ç®—æœºå…è®¸çš„æœ€å¤§çš„æ ˆå†…å­˜å¤§å°ã€‚Go runtime åœ¨ goroutine éœ€è¦çš„æ—¶å€™åŠ¨æ€åœ°åˆ†é…æ ˆç©ºé—´ï¼Œgoroutine çš„åˆå§‹æ ˆå¤§å°ä¸º 2 KBã€‚å½“ goroutine è¢«è°ƒåº¦æ—¶ï¼Œä¼šç»‘å®šå†…æ ¸çº¿ç¨‹æ‰§è¡Œï¼Œæ ˆç©ºé—´å¤§å°ä¹Ÿä¸ä¼šè¶…è¿‡æ“ä½œç³»ç»Ÿçš„é™åˆ¶ã€‚å¯¹äºgo çš„ç¼–è¯‘å™¨æ¥è¯´ï¼Œè¶…è¿‡ä¸€å®šå¤§å°çš„å±€éƒ¨å˜é‡å°†é€ƒé€¸åˆ°å †ä¸Šï¼Œä¸€èˆ¬æ˜¯64KBã€‚æ¯”å¦‚è¿™æ®µä»£ç å°è¯•åˆ›å»ºä¸€ä¸ªå ç”¨ 8193 å­—èŠ‚çš„æ•°ç»„ï¼š 8192 * 8 / 1024 = 64k\n1 2 3 4 5 6 func main() { a := make([]int64, 8176) b := make([]int64, 8192) c := make([]int64, 8193) println(a, b, c) } å½“æ•°ç»„å¤§äº 8192 çš„æ—¶å€™å°±é€ƒé€¸åˆ°äº†å †ä¸Šã€‚\nä¸ç¡®å®šå¤§å°çš„å˜é‡ 1 2 3 4 5 6 7 func main() { a := generate(3) println(a) } func generate(n int) []int { return make([]int, n) } generate çš„å‚æ•°æ˜¯åœ¨è¿è¡Œæ—¶ä¼ å…¥çš„ï¼Œæ‰€ä»¥ç¼–è¯‘å™¨ä¸èƒ½ç¡®å®šä»–çš„å¤§å°ï¼Œ é€ƒé€¸åˆ°å †ä¸Šï¼Œ\ninterface{} åŠ¨æ€ç±»å‹é€ƒé€¸ åœ¨Goè¯­è¨€ä¸­ï¼Œç©ºæ¥å£å³Â interface{}Â å¯ä»¥è¡¨ç¤ºä»»æ„çš„ç±»å‹ï¼Œå¦‚æœå‡½æ•°å‚æ•°ä¸ºÂ interface{}ï¼Œç¼–è¯‘æœŸé—´å¾ˆéš¾ç¡®å®šå…¶å‚æ•°çš„å…·ä½“ç±»å‹ï¼Œä¹Ÿä¼šå‘ç”Ÿé€ƒé€¸ã€‚\næ¯”å¦‚ï¼š\n1 2 3 4 func main() { v := \u0026#34;Hello,World\u0026#34; fmt.Printf(\u0026#34;addr of v in bar = %p\\n\u0026#34;, \u0026amp;v) } è¿è¡Œç»“æœæ˜¯ï¼š\nå› ä¸º fmt.Println çš„å‚æ•°æ˜¯ä¸€ä¸ªanyï¼ˆä¹Ÿå°±æ˜¯interface{}) æ‰€ä»¥vä¼šå‘ç”Ÿé€ƒé€¸\né—­åŒ… closure æ¯”å¦‚ä¸‹é¢çš„ä¾‹å­\n1 2 3 4 5 6 7 8 9 10 11 12 13 func Increase() func() int { n := 0 return func() int { n++ return n } } func main() { in := Increase() fmt.Println(in()) // 1 fmt.Println(in()) // 2 } Increase()Â è¿”å›å€¼æ˜¯ä¸€ä¸ªé—­åŒ…å‡½æ•°ï¼Œè¯¥é—­åŒ…å‡½æ•°è®¿é—®äº†å¤–éƒ¨å˜é‡ nï¼Œé‚£å˜é‡ n å°†ä¼šä¸€ç›´å­˜åœ¨ï¼Œç›´åˆ°Â inÂ è¢«é”€æ¯ã€‚å¾ˆæ˜¾ç„¶ï¼Œå˜é‡ n å ç”¨çš„å†…å­˜ä¸èƒ½éšç€å‡½æ•°Â Increase()Â çš„é€€å‡ºè€Œå›æ”¶ï¼Œå› æ­¤å°†ä¼šé€ƒé€¸åˆ°å †ä¸Šã€‚\næ‰‹åŠ¨å¼ºåˆ¶é¿å…é€ƒé€¸ åœ¨ interface{} åŠ¨æ€ç±»å‹é€ƒé€¸ çš„ä¾‹å­ä¸­ï¼Œ æˆ‘ä»¬å°±æ˜¯æ‰“å°äº†ä¸€ä¸ª\u0026quot;Hello,World\u0026quot;ï¼Œä½†æ˜¯è¿˜æ˜¯äº§ç”Ÿäº†å†…å­˜é€ƒé€¸ï¼Œæˆ‘ä»¬å¯ä»¥ç¡®å®šçš„ä¸€ç‚¹æ˜¯ï¼šv ä¸éœ€è¦é€ƒé€¸ï¼Œä½†è‹¥ä½¿ç”¨fmt.Printfï¼Œæˆ‘ä»¬æ— æ³•é˜»æ‹¦açš„é€ƒé€¸ã€‚é‚£æ˜¯å¦æœ‰ä¸€ç§æ–¹æ³•å¯ä»¥å¹²æ‰°é€ƒé€¸åˆ†æï¼Œä½¿é€ƒé€¸åˆ†æè®¤ä¸ºéœ€è¦åœ¨å †ä¸Šåˆ†é…çš„å†…å­˜å¯¹è±¡è€Œæˆ‘ä»¬ç¡®å®šè®¤ä¸ºä¸éœ€è¦é€ƒé€¸çš„å¯¹è±¡é¿å…é€ƒé€¸å‘¢ï¼Ÿåœ¨Go runtimeä»£ç ä¸­ï¼Œæˆ‘ä»¬å‘ç°äº†ä¸€ä¸ªå‡½æ•°ï¼š\n1 2 3 4 5 // $GOROOT/src/runtime/stubs.go func noescape(p unsafe.Pointer) unsafe.Pointer { x := uintptr(p) return unsafe.Pointer(x ^ 0) } åœ¨Goæ ‡å‡†åº“å’Œrruntimeå®ç°ä¸­ï¼Œè¯¥å‡½æ•°å¾—åˆ°å¤§é‡ä½¿ç”¨ã€‚è¯¥å‡½æ•°çš„å®ç°é€»è¾‘ä½¿å¾—æˆ‘ä»¬ä¼ å…¥çš„æŒ‡é’ˆå€¼ä¸å…¶è¿”å›çš„æŒ‡é’ˆå€¼æ˜¯ä¸€æ ·çš„ã€‚è¯¥å‡½æ•°åªæ˜¯é€šè¿‡uintptråšäº†ä¸€æ¬¡è½¬æ¢ï¼Œè€Œè¿™æ¬¡è½¬æ¢å°†æŒ‡é’ˆè½¬æ¢æˆäº†æ•°å€¼ï¼Œè¿™â€œåˆ‡æ–­â€äº†é€ƒé€¸åˆ†æçš„æ•°æ®æµè·Ÿè¸ªï¼Œå¯¼è‡´ä¼ å…¥çš„æŒ‡é’ˆé¿å…é€ƒé€¸ã€‚\næˆ‘ä»¬æ”¹ä¸€ä¸‹ä¸Šé¢çš„ä¾‹å­\n1 2 3 4 5 6 7 8 9 10 11 func noescape(p unsafe.Pointer) unsafe.Pointer { x := uintptr(p) return unsafe.Pointer(x ^ 0) } func main() { v := \u0026#34;Hello,World\u0026#34; v2 := \u0026#34;Hello,World1\u0026#34; fmt.Printf(\u0026#34;addr of v in bar = %p \\n\u0026#34;, (*int)(noescape(unsafe.Pointer(\u0026amp;v)))) fmt.Printf(\u0026#34;addr of v in bar = %p\\n\u0026#34;, \u0026amp;v2) } è¿è¡Œç»“æœå¦‚å›¾æ‰€ç¤ºï¼Œv æ²¡æœ‰å‘ç”Ÿå†…å­˜é€ƒé€¸ï¼Œv2æœ‰å†…å­˜é€ƒé€¸ã€‚\næ€»ç»“ åœ¨ä¸€èˆ¬çš„å¼€å‘è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¸€èˆ¬å¾ˆå°‘ä¼šæ¶‰åŠå†…å­˜é€ƒé€¸åˆ†æï¼Œæ ¹æ®ç»éªŒæ¥çœ‹ï¼Œä¼˜åŒ–ä¸€ä¸ªé”å¾—åˆ°çš„æ€§èƒ½æå‡ï¼Œæ¯”ä½ åšåæ¬¡å†…å­˜é€ƒé€¸åˆ†æç»“æœè¿˜è¦å¥½ã€‚åœ¨å¹³æ—¶çš„å¼€å‘è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬åªéœ€è¦æ˜ç™½ä¸€ä»¶äº‹å°±å¥½ï¼š\nä¼ å€¼ä¼šæ‹·è´æ•´ä¸ªå¯¹è±¡ï¼Œè€Œä¼ æŒ‡é’ˆåªä¼šæ‹·è´æŒ‡é’ˆåœ°å€ï¼ŒæŒ‡å‘çš„å¯¹è±¡æ˜¯åŒä¸€ä¸ªã€‚ä¼ æŒ‡é’ˆå¯ä»¥å‡å°‘å€¼çš„æ‹·è´ï¼Œä½†æ˜¯ä¼šå¯¼è‡´å†…å­˜åˆ†é…é€ƒé€¸åˆ°å †ä¸­ï¼Œå¢åŠ åƒåœ¾å›æ”¶(GC)çš„è´Ÿæ‹…ã€‚åœ¨å¯¹è±¡é¢‘ç¹åˆ›å»ºå’Œåˆ é™¤çš„åœºæ™¯ä¸‹ï¼Œä¼ é€’æŒ‡é’ˆå¯¼è‡´çš„ GC å¼€é”€å¯èƒ½ä¼šä¸¥é‡å½±å“æ€§èƒ½ã€‚\nä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå¯¹äºéœ€è¦ä¿®æ”¹åŸå¯¹è±¡å€¼ï¼Œæˆ–å ç”¨å†…å­˜æ¯”è¾ƒå¤§çš„ç»“æ„ä½“ï¼Œé€‰æ‹©ä¼ æŒ‡é’ˆã€‚å¯¹äºåªè¯»çš„å ç”¨å†…å­˜è¾ƒå°çš„ç»“æ„ä½“ï¼Œç›´æ¥ä¼ å€¼èƒ½å¤Ÿè·å¾—æ›´å¥½çš„æ€§èƒ½ã€‚ å‚è€ƒèµ„æ–™ https://dave.cheney.net/2014/06/07/five-things-that-make-go-fast http://www.wingtecher.com/themes/WingTecherResearch/assets/papers/ICSE20.pdf https://tonybai.com/2021/05/24/understand-go-escape-analysis-by-example/ https://docs.google.com/document/d/1CxgUBPlx9iJzkz9JWkb6tIpTe5q32QDmz8l0BouG0Cw/preview# https://dave.cheney.net/2018/01/08/gos-hidden-pragmas http://www.wingtecher.com/themes/WingTecherResearch/assets/papers/ICSE20.pdf ","date":"2024-08-08T11:28:58+08:00","image":"https://images.hxzhouh.com/blog-images/2024/08/317a5c9d3df72bec002eb7c0bd64c06d.png","permalink":"https://huizhou92.com/zh-cn/p/go-%E9%AB%98%E6%80%A7%E8%83%BD%E7%BC%96%E7%A8%8B-ep9-%E9%80%83%E9%80%B8%E5%88%86%E6%9E%90/","title":"Go é«˜æ€§èƒ½ç¼–ç¨‹ EP9: é€ƒé€¸åˆ†æ"},{"content":"\nBacklink | |Photo by Ambitious Studio* | Rick Barrett on Unsplash åŸæ–‡é“¾æ¥ï¼šhttps://www.dolthub.com/blog/2023-03-28-swiss-map/\nè¿™ç¯‡æ–‡ç« ä»‹ç»SwissMapï¼Œè¿™æ˜¯ä¸€ä¸ªåŸºäº SwissTable çš„æ–° Golang HashTableï¼Œæ¯” Golang å†…ç½®çš„Mapæ›´å¿«ï¼Œæ›´èŠ‚çº¦å†…å­˜ã€‚æˆ‘ä»¬å°†ä»‹ç»è¿™ä¸ªæ–°è½¯ä»¶åŒ…çš„åŠ¨æœºã€è®¾è®¡å’Œå®ç°ã€‚å¹¶ä¸ºæ‚¨æä¾›ä¸€äº›å°è¯•å®ƒçš„ç†ç”±ã€‚\nåœ¨ DoltHubï¼Œæˆ‘ä»¬çƒ­çˆ± Golangï¼Œå¹¶å·²å°†å…¶ç”¨äºæ„å»º DoltDBï¼Œè¿™æ˜¯ç¬¬ä¸€ä¸ªä¹Ÿæ˜¯å”¯ä¸€ä¸€ä¸ªå¯ä»¥è¿›è¡Œåˆ†æ”¯ã€å·®å¼‚å’Œåˆå¹¶çš„ SQL æ•°æ®åº“ã€‚é€šè¿‡æ„å»º Dolt çš„ç»éªŒï¼Œæˆ‘ä»¬åœ¨è¯­è¨€ä¸Šè·å¾—äº†ä¸€äº›ä¸“ä¸šçŸ¥è¯†ã€‚æˆ‘ä»¬å‘ç°äº†å¾ˆå¤šæˆ‘ä»¬å–œæ¬¢çš„åŠŸèƒ½ï¼Œä¹Ÿé‡åˆ°äº†ä¸€äº›æ¯”è¾ƒå°–é”çš„é—®é¢˜ã€‚Go è¯­è¨€çš„ä¸€ä¸ªé‡è¦çš„ç‰¹ç‚¹æ˜¯ç®€æ´æ€§ã€‚å®ƒæš´éœ²æœ€å°çš„æ¥å£ï¼Œå°†å¤æ‚æ€§è—åœ¨Runtimeä¸­ï¼ˆç®€æ´ä¸ç­‰äºç®€å•ï¼‰ã€‚Golang å†…ç½®çš„ map æ˜¯å…¶çš„ä¸€ä¸ªå¾ˆå¥½çš„ä¾‹å­ï¼šå†…ç½®åœ¨runtime ä¸­ï¼Œä½¿ç”¨ä¸“é—¨çš„æ¥å£è¿›è¡Œè¯»å†™ã€‚å¯¹äºå¤§å¤šæ•°ç”¨ä¾‹ï¼Œmap è¡¨ç°å‡ºè‰²ï¼Œä½†å…¶ä¸é€æ˜çš„å®ç°ä½¿å…¶å¾ˆéš¾æ‰©å±•ã€‚åœ¨æ²¡æœ‰æ›¿ä»£æ–¹æ¡ˆçš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å†³å®šè‡ªè¡Œç¼–å†™HashTableã€‚\nåŠ¨æœº HashTableåœ¨ Doltçš„ä»£ç åº“ä¸­è¢«å¹¿æ³›ä½¿ç”¨ï¼Œä½†åœ¨å¤„ç†æ•°æ®æŒä¹…æ€§å’Œæ£€ç´¢çš„åº•å±‚å †æ ˆä¸­å°¤ä¸ºé‡è¦ã€‚Dolt ä¸­è´Ÿè´£æ•°æ®æŒä¹…æ€§çš„æŠ½è±¡è¢«ç§°ä¸º ChunkStoreã€‚ ChunkStoreè®¸å¤šçš„å®ç°ï¼Œä½†å®ƒä»¬å…±äº«ä¸€ç»„æ™®é€šçš„è¯­ä¹‰ï¼šä½¿ç”¨ [20]byte å†…å®¹å¯å¯»å€å“ˆå¸Œæ¥å­˜å‚¨å’Œè·å–åä¸ºâ€œchunksâ€çš„å¯å˜é•¿åº¦å­—èŠ‚ç¼“å†²åŒºã€‚Dolt çš„è¡¨ç´¢å¼•å­˜å‚¨åœ¨Prolly Treesä¸­ï¼Œè¿™æ˜¯ä¸€ç§ç”±è¿™äº›å¯å˜å¤§å°å—ç»„æˆçš„åŸºäºæ ‘çš„æ•°æ®ç»“æ„ã€‚Prolly æ ‘ä¸­çš„è¾ƒé«˜èŠ‚ç‚¹é€šè¿‡å®ƒä»¬çš„å“ˆå¸Œå¼•ç”¨å­èŠ‚ç‚¹ã€‚ä¸ºäº†åè§£è¿™ä¸ªå“ˆå¸Œåœ°å€ï¼ŒChunkStore å¿…é¡»ä½¿ç”¨â€œå—ç´¢å¼•â€å°†å“ˆå¸Œåœ°å€æ˜ å°„åˆ°ç£ç›˜ä¸Šçš„ç‰©ç†ä½ç½®ã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼Œä¼ ç»Ÿçš„ B æ ‘ç´¢å¼•ä½¿ç”¨å›ºå®šå¤§å°çš„æ•°æ®é¡µï¼Œçˆ¶èŠ‚ç‚¹ç›´æ¥é€šè¿‡å®ƒä»¬åœ¨ç´¢å¼•æ–‡ä»¶ä¸­çš„ç‰©ç†ä½ç½®å¼•ç”¨å­èŠ‚ç‚¹ã€‚\nDolt ä¸­çš„å¤§å‹ Prolly Tree ç´¢å¼•å¯ä»¥è¾¾åˆ° 4 è‡³ 5 ä¸ªå±‚çº§ã€‚éå†æ¯ä¸ªçº§åˆ«éœ€è¦ä½¿ç”¨å—ç´¢å¼•æ¥è§£æçˆ¶èŠ‚ç‚¹å’Œå­èŠ‚ç‚¹ä¹‹é—´çš„å¼•ç”¨ã€‚ä¸ºäº†ä¸ä¼ ç»Ÿçš„ B æ ‘ç´¢å¼•ç«äº‰ï¼Œå—ç´¢å¼•å¿…é¡»å…·æœ‰éå¸¸ä½çš„å»¶è¿Ÿã€‚è¿™ä¸ªå—ç´¢å¼•çš„åŸå§‹è®¾è®¡æ˜¯ä¸€ç»„é™æ€çš„ã€æ’åºçš„æ•°ç»„ã€‚æŸ¥è¯¢ç´¢å¼•æ¶‰åŠå¯¹æ¯ä¸ªæ•°ç»„è¿›è¡ŒäºŒè¿›åˆ¶æœç´¢ï¼Œç›´åˆ°æ‰¾åˆ°æ‰€éœ€çš„åœ°å€ä¸ºæ­¢ã€‚è¿™ç§è®¾è®¡çš„å¥½å¤„åœ¨äºå®ƒçš„ç´§å‡‘æ€§ã€‚å—åœ°å€æœ¬èº«æ˜¯ 20 ä¸ªå­—èŠ‚ï¼Œå¹¶ä¸”ä¼´éšç€ä¸€ä¸ª uint64 æ–‡ä»¶åç§»å’Œä¸€ä¸ª uint32 å—é•¿åº¦ã€‚è¿™ç§æŸ¥æ‰¾ä¿¡æ¯æ¯”ä¼ ç»Ÿçš„ B-Tree ç´¢å¼•å­˜å‚¨çš„ 8 å­—èŠ‚æ–‡ä»¶åç§»æ˜æ˜¾æ›´è‡ƒè‚¿ã€‚å°†æŸ¥æ‰¾ç»“æœå­˜å‚¨åœ¨é™æ€æ•°ç»„ä¸­æœ€å¤§é™åº¦åœ°å‡å°äº†å—ç´¢å¼•çš„å†…å­˜å ç”¨ã€‚å…¶ç¼ºç‚¹æ˜¯æŸ¥è¯¢ç´¢å¼•çš„æ¸è¿‘å¤æ‚åº¦ä¸º m log(n)ï¼Œå…¶ä¸­ m æ˜¯æ•°ç»„çš„æ•°é‡ï¼Œn æ˜¯å®ƒä»¬çš„å¹³å‡å¤§å°ã€‚\nåœ¨è®¾è®¡æˆ‘ä»¬çš„æ–° ChunkStore å®ç° Chunk Journal æ—¶ï¼Œæˆ‘ä»¬å†³å®šç”¨HashTableæ›¿æ¢åŸºäºæ•°ç»„çš„å—ç´¢å¼•ã€‚åŸºäºHashTableçš„ç´¢å¼•å°†æ”¯æŒå¸¸æ•°æ—¶é—´çš„å“ˆå¸Œåœ°å€æŸ¥æ‰¾ï¼Œä»è€Œå‡å°‘ ChunkStore çš„å»¶è¿Ÿã€‚è¿™ç§æŠ˜è¡·æ–¹æ¡ˆæ˜¯HashTableä½¿ç”¨æ›´å¤šå†…å­˜ã€‚å®é™…ä¸Šï¼Œä½¿ç”¨å¤šå°‘å†…å­˜å–å†³äºæ‚¨ä½¿ç”¨çš„HashTableç±»å‹ã€‚æˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªå®ç°ä½¿ç”¨äº† Golang çš„å†…ç½®HashTable mapï¼Œå…¶\u0026quot;æœ€å¤§è´Ÿè½½å› å­\u0026quot;ä¸º 6.5/8ã€‚è¿™æ„å‘³ç€åœ¨æœ€ä½³æƒ…å†µä¸‹ï¼Œmap ä½¿ç”¨çš„å†…å­˜æ¯”åŸºäºæ•°ç»„çš„å—ç´¢å¼•å¤š 23%ã€‚ç„¶è€Œï¼Œå¹³å‡æƒ…å†µè¦ç³Ÿç³•å¾—å¤šã€‚é‚£ä¹ˆï¼Œå¦‚ä½•åœ¨ä¸è¶…å‡ºå†…å­˜é¢„ç®—çš„æƒ…å†µä¸‹å®ç°å¸¸æ•°æ—¶é—´çš„å—æŸ¥æ‰¾å‘¢ï¼Ÿè¿™å°±æ˜¯ SwissMap çš„ä½œç”¨ã€‚\nSwissTable è®¾è®¡ SwissMap åŸºäº Google çš„å¼€æº C++åº“ Abseil ä¸­çš„\u0026quot;SwissTable\u0026quot;HashTableå®¶æ—ã€‚è¿™äº›HashTableè¢«è®¾è®¡ä¸º C++æ ‡å‡†åº“ä¸­ std::unordered_map çš„æ›´å¿«é€Ÿã€æ›´å°å‹çš„æ›¿ä»£å“ã€‚ä¸ std::unordered_map ç›¸æ¯”ï¼Œå®ƒä»¬å…·æœ‰æ›´å¯†é›†ã€æ›´å‹å¥½çš„ç¼“å­˜å†…å­˜å¸ƒå±€ï¼Œå¹¶åˆ©ç”¨ SSE æŒ‡ä»¤åŠ é€Ÿé”®å€¼æŸ¥æ‰¾ã€‚è¯¥è®¾è®¡è¢«è¯æ˜éå¸¸æœ‰æ•ˆï¼Œç›®å‰å·²è¢«å…¶ä»–è¯­è¨€é‡‡ç”¨ã€‚Rust çš„ SwissTable ç§»æ¤ç‰ˆ Hashbrown å·²ç»è¢«çº³å…¥ Rust æ ‡å‡†åº“ï¼Œåœ¨ Rust 1.36 ä¸­æ¨å‡ºã€‚ç”šè‡³åœ¨ Golang ç¤¾åŒºå†…ï¼Œæ­£åœ¨è¿›è¡Œé‡‡çº³ SwissTable è®¾è®¡ä½œä¸ºè¿è¡Œæ—¶æ˜ å°„å®ç°çš„åŠªåŠ›ã€‚SwissTable è®¾è®¡éå¸¸é€‚ç”¨äºæˆ‘ä»¬çš„åˆ†å—ç´¢å¼•ç”¨ä¾‹ï¼šé€Ÿåº¦å¿«ï¼Œå¹¶æ”¯æŒæ›´é«˜çš„æœ€å¤§è´Ÿè½½å› å­ 14/16ã€‚\nå†…ç½®åœ°å›¾å’Œ SwissMap ä¹‹é—´çš„ä¸»è¦è®¾è®¡å·®å¼‚åœ¨äºå®ƒä»¬çš„å“ˆå¸Œæ–¹æ¡ˆã€‚å†…ç½®åœ°å›¾ä½¿ç”¨äº†ä¸€ç§â€œå¼€æ”¾å“ˆå¸Œâ€æ–¹æ¡ˆï¼Œå…¶ä¸­å…·æœ‰å†²çªå“ˆå¸Œçš„é”®å€¼å¯¹è¢«æ”¶é›†åˆ°å•ä¸ªâ€œæ¡¶â€ä¸­ã€‚è¦åœ¨åœ°å›¾ä¸­æŸ¥æ‰¾ä¸€ä¸ªå€¼ï¼Œé¦–å…ˆåŸºäºé”®çš„å“ˆå¸Œé€‰æ‹©ä¸€ä¸ªæ¡¶ï¼Œç„¶åéå†æ¡¶ä¸­çš„æ¯ä¸ªé”®å€¼å¯¹ï¼Œç›´åˆ°æ‰¾åˆ°åŒ¹é…çš„é”®ã€‚\n![[Pasted image 20240807102716.png]]\nå†…ç½®åœ°å›¾ä¸­çš„å…³é”®ä¼˜åŒ–æ˜¯ä½¿ç”¨â€œé¢å¤–æ•£åˆ—ä½â€ï¼Œè¿™å…è®¸åœ¨éå†å­˜å‚¨æ¡¶çš„æ’æ§½æ—¶å¿«é€Ÿè¿›è¡Œç›¸ç­‰æ€§æ£€æŸ¥ã€‚åœ¨ç›´æ¥å°†æŸ¥è¯¢é”®ä¸å€™é€‰é”®è¿›è¡Œæ¯”è¾ƒä¹‹å‰ï¼ŒæŸ¥æ‰¾ç®—æ³•é¦–å…ˆæ¯”è¾ƒæ¯ä¸ªé”®çš„ 8 ä½æ•£åˆ—ï¼ˆä¸å­˜å‚¨æ¡¶æ•£åˆ—ç‹¬ç«‹ï¼‰ä»¥æŸ¥çœ‹æ˜¯å¦å¯èƒ½å­˜åœ¨æ­£åŒ¹é…ã€‚è¿™ç§å¿«é€Ÿé¢„æ£€å…·æœ‰ 1/256 çš„è¯¯æŠ¥ç‡ï¼Œå¹¶ä¸”æå¤§åŠ é€Ÿäº†é€šè¿‡æ•£åˆ—è¡¨å­˜å‚¨æ¡¶è¿›è¡Œæœç´¢ã€‚è¦äº†è§£æœ‰å…³ Golang å†…ç½®åœ°å›¾çš„æ›´å¤šè®¾è®¡ç»†èŠ‚ï¼Œè¯·æŸ¥çœ‹ Keith Randall åœ¨ 2016 å¹´ GopherCon å¤§ä¼šä¸Šçš„æ¼”è®²â€œåœ°å›¾å®ç°å†…éƒ¨â€ã€‚\nSwissTable ä½¿ç”¨ä¸€ç§åä¸ºâ€œclosed-hashingâ€çš„ä¸åŒæ•£åˆ—æ–¹æ¡ˆã€‚ä¸å°†å…ƒç´ æ”¶é›†åˆ°æ¡¶ä¸­ä¸åŒï¼Œæ•£åˆ—è¡¨ä¸­çš„æ¯ä¸ªé”®-å€¼å¯¹è¢«åˆ†é…å…¶è‡ªå·±çš„â€œæ§½ä½â€ã€‚æ­¤æ§½ä½çš„ä½ç½®ç”±æ¢æµ‹ç®—æ³•å†³å®šï¼Œå…¶èµ·å§‹ç‚¹ç”±é”®çš„å“ˆå¸Œå†³å®šã€‚æœ€ç®€å•çš„ä¾‹å­æ˜¯çº¿æ€§æ¢æµ‹æœç´¢ï¼Œå®ƒä»æ§½ä½ hash(key) mod size å¼€å§‹ï¼Œå¹¶åœ¨æ‰¾åˆ°æ‰€éœ€é”®æˆ–åˆ°è¾¾ç©ºæ§½ä½æ—¶åœæ­¢ã€‚è¿™ç§æ¢æµ‹æ–¹æ³•ç”¨äºæŸ¥æ‰¾ç°æœ‰é”®å’Œä¸ºæ–°é”®æ‰¾åˆ°æ’å…¥ä½ç½®ã€‚ä¸å†…ç½®çš„ Golang map ç±»ä¼¼ï¼ŒSwissTable ä½¿ç”¨â€œçŸ­å“ˆå¸Œâ€æ¥åŠ é€Ÿæ¢æµ‹æœŸé—´çš„ç›¸ç­‰æ€§æ£€æŸ¥ã€‚ä½†ä¸å†…ç½®çš„ map ä¸åŒï¼Œå®ƒçš„å“ˆå¸Œå…ƒæ•°æ®ä¸é”®-å€¼æ•°æ®åˆ†å¼€å­˜å‚¨ã€‚\n![[Pasted image 20240807095909.png]]\nSwissTable çš„åˆ†æ®µå†…å­˜å¸ƒå±€æ˜¯å…¶æ€§èƒ½çš„å…³é”®é©±åŠ¨å› ç´ ã€‚åœ¨è¡¨ä¸­æ¢æµ‹åºåˆ—åªè®¿é—®å…ƒæ•°æ®æ•°ç»„ï¼Œç›´åˆ°æ‰¾åˆ°çŸ­å“ˆå¸ŒåŒ¹é…ä¸ºæ­¢ã€‚è¿™ç§è®¿é—®æ¨¡å¼åœ¨æ¢æµ‹è¿‡ç¨‹ä¸­æœ€å¤§åŒ–äº†ç¼“å­˜å±€éƒ¨æ€§ã€‚ä¸€æ—¦æ‰¾åˆ°å…ƒæ•°æ®åŒ¹é…ï¼Œç›¸åº”çš„é”®å‡ ä¹æ€»æ˜¯åŒ¹é…çš„ã€‚æ‹¥æœ‰ä¸“ç”¨çš„å…ƒæ•°æ®æ•°ç»„æ„å‘³ç€æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ SSE æŒ‡ä»¤å¹¶è¡Œæ¯”è¾ƒ 16 ä¸ªçŸ­å“ˆå¸Œï¼ä½¿ç”¨ SSE æŒ‡ä»¤ä¸ä»…æ›´å¿«ï¼Œè¿˜æ˜¯ SwissTable æ”¯æŒæœ€å¤§è´Ÿè½½å› å­ 14/16 çš„åŸå› ã€‚è§‚å¯Ÿè¡¨æ˜ï¼Œâ€œè´Ÿé¢â€æ¢æµ‹ï¼ˆæœç´¢è¡¨ä¸­ä¸å­˜åœ¨çš„é”®ï¼‰ä»…åœ¨é‡åˆ°ç©ºæ§½æ—¶ç»ˆæ­¢ã€‚è¡¨ä¸­ç©ºæ§½è¶Šå°‘ï¼Œå¹³å‡æ¢æµ‹åºåˆ—æ‰¾åˆ°å®ƒä»¬æ‰€éœ€çš„æ—¶é—´å°±è¶Šé•¿ã€‚ä¸ºäº†ä¿æŒHashTableçš„ Oï¼ˆ1ï¼‰è®¿é—®æ—¶é—´ï¼Œå¹³å‡æ¢æµ‹åºåˆ—çš„é•¿åº¦å¿…é¡»å—åˆ°ä¸€ä¸ªå°çš„æ’å®šå› å­çš„é™åˆ¶ã€‚æœ‰æ•ˆä½¿ç”¨ SSE æŒ‡ä»¤å…è®¸æˆ‘ä»¬å°†å¹³å‡æ¢æµ‹åºåˆ—çš„é•¿åº¦é™¤ä»¥ 16ã€‚ç»éªŒæµ‹é‡è¡¨æ˜ï¼Œå³ä½¿åœ¨æœ€å¤§è´Ÿè½½æ—¶ï¼Œå¹³å‡æ¢æµ‹åºåˆ—æ‰§è¡Œçš„ 16 è·¯æ¯”è¾ƒä¹Ÿä¸åˆ°ä¸¤æ¬¡ï¼ å¦‚æœæ‚¨å¯¹äº†è§£ SwissTable è®¾è®¡ï¼ˆæ›´å¤šï¼‰æ„Ÿå…´è¶£ï¼Œè¯·æŸ¥çœ‹ Matt Kulukundis åœ¨ 2017 å¹´ CppCon å¤§ä¼šä¸Šçš„æ¼”è®²ï¼Œâ€œé€æ­¥è®¾è®¡ä¸€ä¸ªå¿«é€Ÿã€é«˜æ•ˆã€å‹å¥½ç¼“å­˜çš„HashTableâ€ã€‚\nå°† SwissTable ç§»æ¤åˆ° Golang æœ‰äº†è®¾è®¡æ–¹æ¡ˆï¼Œå°±æ˜¯è¯¥åŠ¨æ‰‹å®æ–½äº†ã€‚ç¬¬ä¸€æ­¥æ˜¯ç¼–å†™ find() ç®—æ³•ã€‚æ­£å¦‚é©¬ç‰¹Â·åº“å¢æ˜†è¿ªæ–¯åœ¨ä»–çš„è®²åº§ä¸­æŒ‡å‡ºçš„é‚£æ ·ï¼Œfind() æ˜¯ SwissTable ä¸­æ‰€æœ‰æ ¸å¿ƒæ–¹æ³•çš„åŸºç¡€ï¼šGet()ã€Has()ã€Put() å’Œ Delete() çš„å®ç°éƒ½ä»â€œæŸ¥æ‰¾â€ç‰¹å®šæ§½å¼€å§‹ã€‚æ‚¨å¯ä»¥åœ¨æ­¤å¤„é˜…è¯»å®é™…å®ç°ï¼Œä½†ä¸ºç®€å•èµ·è§ï¼Œæˆ‘ä»¬å°†æŸ¥çœ‹ä¼ªä»£ç ç‰ˆæœ¬ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 func (m Map) find(key) (slot int, ok bool) { h1, h2 := hashOf(key) // high and low hash bits s := modulus(h1, len(m.keys)/16) // pick probe start for { // SSE probe for \u0026#34;short hash\u0026#34; matches matches := matchH2(m.metadata[s:s+16], h2) for _, idx := range matches { if m.keys[idx] == key { return idx, true // found |key| } } // SSE probe for empty slots matches = matchEmpty(m.metadata[s:s+16]) for _, idx := range matches { return idx, false // found empty slot } s += 16 } } æœç´¢å¾ªç¯æŒç»­è¿›è¡Œï¼Œç›´åˆ°è¾¾åˆ°ä¸¤ç§é€€å‡ºæ¡ä»¶ä¹‹ä¸€ã€‚ å¯¹äºè°ƒç”¨ Get()ã€Has() å’Œ Delete() çš„æˆåŠŸè°ƒç”¨ï¼Œå½“çŸ­å“ˆå¸Œå’Œé”®å€¼éƒ½ä¸æŸ¥è¯¢é”®åŒ¹é…æ—¶ï¼Œä¼šåœ¨ç¬¬ä¸€ä¸ªè¿”å›æ—¶ç»ˆæ­¢ã€‚ å¯¹äº Put() è°ƒç”¨å’ŒæœªæˆåŠŸæœç´¢çš„æƒ…å†µï¼Œä¼šåœ¨æ‰¾åˆ°ç©ºæ§½ä½æ—¶åœ¨ç¬¬äºŒä¸ªè¿”å›æ—¶ç»ˆæ­¢ã€‚ åœ¨å…ƒæ•°æ®æ•°ç»„ä¸­ï¼Œç©ºæ§½ä½ç”±ç‰¹æ®Šçš„çŸ­å“ˆå¸Œå€¼ç¼–ç ã€‚ matchEmpty æ–¹æ³•ä¸ºæ­¤å€¼æ‰§è¡Œ 16 è·¯ SSE æ¢æµ‹ã€‚\nGolang å¯¹ SSE æŒ‡ä»¤çš„æ”¯æŒä»¥åŠå¯¹ SIMD æŒ‡ä»¤çš„æ”¯æŒéƒ½å¾ˆæœ‰é™ã€‚ä¸ºäº†åˆ©ç”¨è¿™äº›åŸºæœ¬å‡½æ•°ï¼ŒSwissMap ä½¿ç”¨ä¼˜ç§€çš„ Avo è½¯ä»¶åŒ…ç”Ÿæˆå…·æœ‰ç›¸å…³ SSE æŒ‡ä»¤çš„æ±‡ç¼–å‡½æ•°ã€‚æ‚¨å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°ä»£ç ç”Ÿæˆæ–¹æ³•ã€‚\nå—ç´¢å¼•ç”¨ä¾‹éœ€è¦å°†å“ˆå¸Œé”®æ˜ å°„åˆ°å—æŸ¥æ‰¾æ•°æ®çš„ç‰¹å®šHashTableã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬å¸Œæœ› SwissMap æ˜¯ä¸€ä¸ªé€šç”¨æ•°æ®ç»“æ„ï¼Œå¯ä»¥åœ¨ä»»ä½•æ€§èƒ½æ•æ„Ÿçš„ä¸Šä¸‹æ–‡ä¸­é‡å¤ä½¿ç”¨ã€‚ä½¿ç”¨æ³›å‹ï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€ä¸ªHashTableï¼Œå®ƒå’Œå†…ç½®åœ°å›¾ä¸€æ ·çµæ´»\n1 2 3 4 5 6 package swiss type Map[K comparable, V any] struct { hash maphash.Hasher[K] ... } SwissMap çš„å“ˆå¸Œå‡½æ•°æ˜¯ maphashï¼Œè¿™æ˜¯å¦ä¸€ä¸ª DoltHub åŒ…ï¼Œå®ƒä½¿ç”¨ Golang çš„è¿è¡Œæ—¶å“ˆå¸Œç¨‹åºï¼Œå¯ä»¥å¯¹ä»»ä½•å¯æ¯”è¾ƒçš„æ•°æ®ç±»å‹è¿›è¡Œå“ˆå¸Œå¤„ç†ã€‚åœ¨æ”¯æŒçš„å¹³å°ä¸Šï¼Œè¿è¡Œæ—¶å“ˆå¸Œç¨‹åºå°†ä½¿ç”¨ AES æŒ‡ä»¤é«˜æ•ˆç”Ÿæˆå¼ºå“ˆå¸Œå€¼ã€‚åˆ©ç”¨åƒ SSE å’Œ AES è¿™æ ·çš„ç¡¬ä»¶ä¼˜åŒ–ä½¿ SwissMap èƒ½å¤Ÿå°†æŸ¥æ‰¾å»¶è¿Ÿæœ€å°åŒ–ï¼Œç”šè‡³åœ¨å¤„ç†æ›´å¤§çš„å¯†é’¥é›†æ—¶èƒœè¿‡ Golang çš„å†…ç½®æ˜ å°„å‡½æ•°ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 goos: darwin goarch: amd64 pkg: github.com/dolthub/swiss cpu: Intel(R) Core(TM) i7-9750H CPU @ 2.60GHz BenchmarkStringMaps num_keys=16 num_keys=16 runtime_map-12 112244895\t10.71 ns/op num_keys=16 swiss.Map-12 65813416\t16.50 ns/op num_keys=128 num_keys=128 runtime_map-12 94492519\t12.48 ns/op num_keys=128 swiss.Map-12 62943102\t16.09 ns/op num_keys=1024 num_keys=1024 runtime_map-12 63513327\t18.92 ns/op num_keys=1024 swiss.Map-12 70340458\t19.13 ns/op num_keys=8192 num_keys=8192 runtime_map-12 45350466\t24.77 ns/op num_keys=8192 swiss.Map-12 58187996\t21.29 ns/op num_keys=131072 num_keys=131072 runtime_map-12 35635282\t40.24 ns/op num_keys=131072 swiss.Map-12 36062179\t30.71 ns/op PASS æœ€åï¼Œè®©æˆ‘ä»¬æ¥çœ‹çœ‹ SwissMap çš„å†…å­˜æ¶ˆè€—ã€‚æˆ‘ä»¬æ„å»º SwissMap çš„æœ€åˆåŠ¨æœºæ˜¯ä¸ºäº†ä½¿æˆ‘ä»¬çš„å—ç´¢å¼•åœ¨æœ€å°åŒ–é¢å¤–å†…å­˜æ¶ˆè€—çš„åŒæ—¶è·å¾—å¸¸æ•°æ—¶é—´æŸ¥æ‰¾æ€§èƒ½ã€‚SwissMap æ”¯æŒæ¯”å†…ç½®åœ°å›¾æ›´é«˜çš„æœ€å¤§è´Ÿè½½å› å­ï¼ˆ87.5% å¯¹æ¯” 81.25%ï¼‰ï¼Œä½†ä»…å‡­è¿™ä¸€ç‚¹å¹¶ä¸èƒ½è®²è¿°æ•´ä¸ªæ•…äº‹ã€‚ä½¿ç”¨ Golang çš„ pprof åˆ†æå™¨ï¼Œæˆ‘ä»¬å¯ä»¥æµ‹é‡æ¯ä¸ªåœ°å›¾çš„å®é™…è´Ÿè½½å› å­ï¼Œé’ˆå¯¹ä¸€ç³»åˆ—é”®é›†å¤§å°ã€‚æµ‹é‡ä»£ç å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°ã€‚\n![[Pasted image 20240807100333.png]]\nåœ¨ä¸Šé¢çš„å›¾è¡¨ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ç‘å£«åœ°å›¾ï¼ˆSwissMapï¼‰å’Œå†…ç½®åœ°å›¾ä¹‹é—´å†…å­˜æ¶ˆè€—æ¨¡å¼æ˜æ˜¾ä¸åŒã€‚ä¸ºäº†æ¯”è¾ƒï¼Œæˆ‘ä»¬è¿˜åŒ…æ‹¬äº†å­˜å‚¨ç›¸åŒæ•°æ®é›†çš„æ•°ç»„çš„å†…å­˜æ¶ˆè€—ã€‚å†…ç½®åœ°å›¾çš„å†…å­˜æ¶ˆè€—éµå¾ªé˜¶æ¢¯å‡½æ•°ï¼Œå› ä¸ºå®ƒå§‹ç»ˆç”±ä¸¤çš„å¹‚æ¬¡æ•°ä¸ªå­˜å‚¨æ¡¶æ„å»ºè€Œæˆã€‚è¿™ç§æƒ…å†µçš„åŸå› æ¥è‡ªäºç»å…¸çš„ä½è¿ç®—ä¼˜åŒ–æ¨¡å¼ã€‚\nä»»ä½•HashTableæŸ¥æ‰¾ï¼ˆå¼€æ”¾æˆ–é—­åˆå“ˆå¸Œï¼‰éƒ½å¿…é¡»åŸºäºæŸ¥è¯¢é”®çš„å“ˆå¸Œé€‰æ‹©æ¢æµ‹åºåˆ—çš„èµ·å§‹ä½ç½®ã€‚å°†å“ˆå¸Œå€¼æ˜ å°„åˆ°æ¡¶æˆ–æ’æ§½æ˜¯é€šè¿‡ä½™æ•°é™¤æ³•å®Œæˆçš„ã€‚äº‹å®è¯æ˜ï¼Œä½™æ•°é™¤æ³•æ“ä½œç¬¦ï¼…åœ¨ CPU å‘¨æœŸä¸­æ˜¯ç›¸å½“æ˜‚è´µçš„ï¼Œä½†å¦‚æœé™¤æ•°æ˜¯ 2 çš„å¹‚ï¼Œåˆ™å¯ä»¥ç”¨æœ€ä½ n ä½çš„è¶…å¿«é€Ÿä½æ©ç æ›¿æ¢ï¼…æ“ä½œã€‚å› æ­¤ï¼Œè®¸å¤šHashTableè¢«é™åˆ¶åœ¨ 2 çš„å¹‚å¤§å°ã€‚é€šå¸¸è¿™ä¼šäº§ç”Ÿå¯å¿½ç•¥çš„å†…å­˜å¼€é”€ï¼Œä½†åœ¨åˆ†é…åŒ…å«æ•°ç™¾ä¸‡å…ƒç´ çš„HashTableæ—¶ï¼Œå½±å“ä¼šå¾ˆå¤§ï¼å¦‚ä¸Šå›¾æ‰€ç¤ºï¼ŒGolang çš„å†…ç½®æ˜ å°„å¹³å‡ä½¿ç”¨çš„å†…å­˜æ¯” SwissTable å¤š 63ï¼…ï¼\nä¸ºäº†é¿å…ä½™æ•°é™¤æ³•çš„é€Ÿåº¦ç¼“æ…¢ä»¥åŠäºŒæ¬¡å¹‚å¤§å°é€ æˆçš„å†…å­˜è†¨èƒ€ï¼Œæˆ‘ä»¬çš„ SwissMap å®ç°é‡‡ç”¨äº†ä¸€ç§ä¸åŒçš„æ¨¡æ˜ å°„ï¼Œæœ€åˆç”± Daniel Lemire æå‡ºã€‚è¿™ä¸ªæƒ³æ³•çœ‹ä¼¼ç®€å•ï¼š\n1 2 3 func fastModN(x, n uint32) uint32 { return uint32((uint64(x) * uint64(n)) \u0026gt;\u0026gt; 32) } è¿™ç§æ–¹æ³•æ¯”ç»å…¸çš„ä½æ©ç æŠ€æœ¯å¤šå‡ºçš„æ“ä½œå¾ˆå°‘ï¼Œå¾®åŸºå‡†æµ‹è¯•åªéœ€å››åˆ†ä¹‹ä¸€çº³ç§’ã€‚ä½¿ç”¨è¿™ç§æ¨¡æ•°æ–¹æ³•æ„å‘³ç€æˆ‘ä»¬å—é™äº uint32 çš„èŒƒå›´ï¼Œä½†ç”±äºè¿™ä¸ªæ•´æ•°å¯ä»¥ç´¢å¼• 16 ä¸ªå…ƒç´ çš„å­˜å‚¨æ¡¶ï¼ŒSwissMap å¯ä»¥å®¹çº³é«˜è¾¾ 2 ^ 36 ä¸ªå…ƒç´ ã€‚å¯¹äºå¤§å¤šæ•°ç”¨ä¾‹æ¥è¯´ï¼Œè¿™å·²ç»è¶³å¤Ÿäº†ï¼Œå¹¶ä¸”å¯ä»¥èŠ‚çœå†…å­˜ï¼Œéå¸¸å€¼å¾—ï¼\nå°è¯•ä¸€ä¸‹ SwissMap å¸Œæœ›è¿™æ˜¯ä¸€æ¬¡å…³äºHashTableè®¾è®¡å’Œé«˜æ€§èƒ½ Golang çš„æ·±å…¥äº†è§£ã€‚SwissMap å·²ç»è¯æ˜æ˜¯æˆ‘ä»¬åˆ†å—ç´¢å¼•é—®é¢˜çš„æœ‰æ•ˆè§£å†³æ–¹æ¡ˆï¼Œä½†æˆ‘ä»¬å¸Œæœ›å®ƒä¹Ÿèƒ½æˆä¸ºå…¶ä»–æ€§èƒ½æ•æ„Ÿç”¨ä¾‹çš„é€šç”¨åŒ…ã€‚è™½ç„¶å®ƒå¹¶ä¸é€‚åˆæ¯ç§æƒ…å†µï¼Œä½†æˆ‘ä»¬è®¤ä¸ºåœ¨å…³æ³¨å¤§å‹HashTableçš„å†…å­˜åˆ©ç”¨ç‡æ—¶ï¼Œå®ƒæ˜¯æœ‰ç”¨çš„ã€‚å¦‚æœæ‚¨å¯¹ SwissMap æœ‰ä»»ä½•åé¦ˆï¼Œè¯·éšæ—¶åœ¨å­˜å‚¨åº“ä¸­åˆ›å»ºä¸€ä¸ªé—®é¢˜ã€‚æˆ–è€…ï¼Œå¦‚æœæ‚¨æƒ³ç›´æ¥ä¸æˆ‘ä»¬äº¤æµï¼Œè¯·åŠ å…¥æˆ‘ä»¬çš„ Discordï¼\n","date":"2024-08-07T09:41:37+08:00","permalink":"https://huizhou92.com/zh-cn/p/%E8%AF%91swissmap%E4%B8%80%E4%B8%AA%E6%9B%B4%E5%B0%8F%E6%9B%B4%E5%BF%AB%E7%9A%84-golang-hashmap/","title":"ã€è¯‘ã€‘SwissMapï¼šä¸€ä¸ªæ›´å°ã€æ›´å¿«çš„ Golang HashMap"},{"content":"æˆ‘ä»¬åœ¨ç”¨golang å†™ç¨‹åºçš„æ—¶å€™ï¼Œä¸€èˆ¬ä¸ä¼šå»è¿‡åˆ†å…³æ³¨å†…å­˜ï¼Œå› ä¸ºgolang è¿è¡Œæ—¶èƒ½å¤Ÿå¾ˆå¥½çš„å¸®æˆ‘ä»¬å®ŒæˆGC å·¥ä½œï¼Œä½†æ˜¯å¦‚æœé‡åˆ°äº†éœ€è¦æ€§èƒ½ä¼˜åŒ–çš„åœºæ™¯ï¼Œæˆ‘ä»¬èƒ½å¤Ÿäº†è§£ä¸€äº›GC çš„çŸ¥è¯†ï¼Œä»¥åŠå¦‚ä½•ä¼˜åŒ–GCï¼Œä¼šæœ‰å¾ˆå¤§çš„æ”¶ç›Šã€‚ è¿™ç¯‡æ–‡ç« ï¼Œæˆ‘ä»¬é€šè¿‡ä¸€ä¸ªè§£æXMLæ–‡ä»¶çš„æœåŠ¡æ¥å­¦ä¹ ä¸€ä¸‹ã€‚å¦‚ä½•é€šè¿‡go trace æ¥ä¼˜åŒ–GCï¼Œæé«˜ä»£ç çš„æ€§èƒ½ã€‚\næ„Ÿè°¢ Arden Lions ä¼˜ç§€çš„æ¼”è®²Evaluating Performance In Goã€‚è¿™ç¯‡æ–‡ç« å¯ä»¥ç†è§£æˆæ¼”è®²çš„ blog ç‰ˆæœ¬ã€‚\nå¦‚æœæ‚¨å¯¹ go trace ä¸å¤ªç†Ÿæ‚‰ï¼Œå¯ä»¥å…ˆçœ‹ä¸€ä¸‹@Vincentçš„æ–‡ç« Go: Discovery of the Trace Package\næ‰€æœ‰çš„ä¾‹å­éƒ½åœ¨æˆ‘çš„MacBook Pro M1 ä¸Šè¿è¡Œï¼Œå®ƒæœ‰åä¸ªæ ¸å¿ƒã€‚\næˆ‘ä»¬çš„ç›®æ ‡æ˜¯å®ç°ä¸€ä¸ªä»å¤šä¸ªRSS XMLæ–‡ä»¶å¤„ç†ç¨‹åºï¼Œä»titleå¯»æ‰¾åŒ…å«goå…³é”®å­—çš„çš„itemï¼Œè¿™é‡Œï¼Œæˆ‘ä½¿ç”¨æˆ‘çš„åšå®¢çš„RSS XMLæ–‡ä»¶ä½œä¸ºç¤ºä¾‹ï¼Œè§£æè¿™ä¸ªæ–‡ä»¶100æ¬¡ï¼Œæ¨¡æ‹Ÿå‹åŠ›ã€‚\nå®Œæ•´çš„ä»£ç ï¼šhttps://github.com/hxzhouh/blog-example/tree/main/go/go_trace%20\nsingle list1: ä½¿ç”¨å•åç¨‹ç»Ÿè®¡key\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 func freq(docs []string) int { var count int for _, doc := range docs { f, err := os.OpenFile(doc, os.O_RDONLY, 0) if err != nil { return 0 } data, err := io.ReadAll(f) if err != nil { return 0 } var d document if err := xml.Unmarshal(data, \u0026amp;d); err != nil { log.Printf(\u0026#34;Decoding Document [Ns] : ERROR :%+v\u0026#34;, err) return 0 } for _, item := range d.Channel.Items { if strings.Contains(strings.ToLower(item.Title), \u0026#34;go\u0026#34;) { count++ } } } return count } func main() { trace.Start(os.Stdout) defer trace.Stop() files := make([]string, 0) for i := 0; i \u0026lt; 100; i++ { files = append(files, \u0026#34;index.xml\u0026#34;) } count := freq(files) log.Println(fmt.Sprintf(\u0026#34;find key word go %d count\u0026#34;, count)) } ä»£ç å¾ˆç®€å•ï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªforå¾ªç¯å°±å®Œæˆä»»åŠ¡äº†ã€‚ç„¶åè¿è¡Œ\n1 2 3 4 5 6 âœ go_trace git:(main) âœ— go build âœ go_trace git:(main) âœ— time ./go_trace 2 \u0026gt; trace_single.out -- result -- 2024/08/02 16:17:06 find key word go 2400 count ./go_trace 2 \u0026gt; trace_single.out 1.99s user 0.05s system 102% cpu 1.996 total ç„¶åæˆ‘ä»¬ä½¿ç”¨ go trace æŸ¥çœ‹ trace_single.out\nRunTime :2031ms, STW: 57ms, GC Occurrences :252ms ,GC STW AVE: 0.227ms\nGC æ—¶é—´ å ç”¨æ€»è¿è¡Œæ—¶é—´ä¸º: 57 / 2031 â‰ˆ 0.02\nä½¿ç”¨æœ€å¤§çš„å†…å­˜ä¸º11.28Må·¦å³\nFigure 1: single: run time\nFigure 2: single: GC\nFigure 3: single: max heap\næˆ‘ä»¬ç°åœ¨åªä½¿ç”¨äº†ä¸€ä¸ªæ ¸å¿ƒï¼Œèµ„æºåˆ©ç”¨ç‡å¤ªä½ï¼Œå¦‚æœæˆ‘ä»¬æƒ³åŠ é€Ÿè¿™ä¸ªç¨‹åºï¼Œæœ€å¥½æ˜¯ä½¿ç”¨å¹¶å‘ï¼Œè¿™ä¹Ÿæ˜¯goæœ€æ“…é•¿çš„éƒ¨åˆ†ã€‚\nconcurrent List 2: ä½¿ç”¨ FinOut æ–¹å¼ç»Ÿè®¡ keyã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 func concurrent(docs []string) int { var count int32 g := runtime.GOMAXPROCS(0) wg := sync.WaitGroup{} wg.Add(g) ch := make(chan string, 100) go func() { for _, v := range docs { ch \u0026lt;- v } close(ch) }() for i := 0; i \u0026lt; g; i++ { go func() { var iFound int32 defer func() { atomic.AddInt32(\u0026amp;count, iFound) wg.Done() }() for doc := range ch { f, err := os.OpenFile(doc, os.O_RDONLY, 0) if err != nil { return } data, err := io.ReadAll(f) if err != nil { return } var d document if err = xml.Unmarshal(data, \u0026amp;d); err != nil { log.Printf(\u0026#34;Decoding Document [Ns] : ERROR :%+v\u0026#34;, err) return } for _, item := range d.Channel.Items { if strings.Contains(strings.ToLower(item.Title), \u0026#34;go\u0026#34;) { iFound++ } } } }() } wg.Wait() return int(count) } ä½¿ç”¨åŒæ ·çš„æ–¹å¼è¿è¡Œ\n1 2 3 4 5 go build time ./go_trace 2 \u0026gt; trace_pool.out --- 2024/08/02 19:27:13 find key word go 2400 count ./go_trace 2 \u0026gt; trace_pool.out 2.83s user 0.13s system 673% cpu 0.439 total RunTime :425ms, STW: 154ms, GC Occurrences :39 ,GC STW AVE: 3.9ms\nGC æ—¶é—´ å ç”¨æ€»è¿è¡Œæ—¶é—´ä¸º: 154 /425 â‰ˆ 0.36\næœ€å¤§çš„å†…å­˜æ¶ˆè€—ä¸º91.60MB\nFigure 4: concurrent, GC count\nFigure 5: concurrent, Max heap\nconcurrent æ¯”single å¤§çº¦å¿«äº†5å€ï¼Œåœ¨go trace çš„ç»“æœä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° concurrent ç‰ˆæœ¬ä¸­GCå äº†36%çš„è¿è¡Œæ—¶é—´ã€‚æœ‰æ²¡æœ‰åŠæ³•èƒ½ä¼˜åŒ–è¿™ä¸ªæ—¶é—´å‘¢ï¼Ÿå¹¸è¿çš„æ˜¯åœ¨go 1.19 ç‰ˆæœ¬ä¸­æˆ‘ä»¬æœ‰ä¸¤ä¸ªå‚æ•°å¯ä»¥æ¥æ§åˆ¶GCã€‚\nGOGC \u0026amp; GOMEMLIMIT åœ¨go1.19 ä¸­æ·»åŠ äº†ä¸¤ä¸ªå‚æ•°ï¼Œå¯ä»¥ç”¨å®ƒæ¥æ§åˆ¶GCï¼ŒGOGC ç”¨äºæ§åˆ¶åƒåœ¾å›æ”¶çš„é¢‘ç‡ï¼Œè€Œ GOMEMLIMIT ç”¨äºé™åˆ¶ç¨‹åºçš„æœ€å¤§å†…å­˜ä½¿ç”¨é‡ã€‚å…³äº GOGCå’ŒGOMEMLIMIT è¯¦ç»†ç»†èŠ‚ï¼Œå¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£ gc-guide\nGOGC æ ¹æ®å®˜æ–¹æ–‡æ¡£ä¸­çš„è¿™ä¸ªå…¬å¼:\n$New heap memory = (Live heap + GC roots) * GOGC / 100$\næ ¹æ®å®˜æ–¹æ–‡æ¡£ï¼Œå¦‚æœæˆ‘ä»¬å°†GOGCè®¾ç½®ä¸º1000ï¼Œç†è®ºä¸Šï¼Œä¼šå°†GCè§¦å‘çš„é¢‘ç‡é™ä½10å€ï¼Œä»£ä»·æ˜¯å†…å­˜å ç”¨å¢åŠ åå€ã€‚ï¼ˆè¿™åªæ˜¯ä¸€ä¸ªç†è®ºæ¨¡å‹ï¼Œå®é™…ä¸Šå¾ˆå¤æ‚ï¼‰\nè¯•è¯•å‘—ï¼Ÿ\n1 2 3 âœ go_trace git:(main) âœ— time GOGC=1000 ./go_trace 2 \u0026gt; trace_gogc_1000.out 2024/08/05 16:57:29 find key word go 2400 count GOGC=1000 ./go_trace 2 \u0026gt; trace_gogc_1000.out 2.46s user 0.16s system 757% cpu 0.346 total RunTime :314ms, STW: 9.572ms, GC Occurrences: 5, GC STW AVE: 1.194ms\nGC æ—¶é—´ å ç”¨æ€»è¿è¡Œæ—¶é—´ä¸º: 9.572/314 â‰ˆ 0.02\næœ€å¤§å†…å­˜å ç”¨ä¸º 451MBã€‚\nFigure 6: GOGC, Max Heap\nFigure 7: GOGC, GC count\nGOMEMLIMIT GOMEMLIMIT ç”¨æ¥è®¾ç½®ç¨‹åºä½¿ç”¨çš„å†…å­˜ä¸Šé™ï¼Œä¸€èˆ¬åœ¨å…³é—­è‡ªåŠ¨GC çš„åœºæ™¯ä¸‹ä½¿ç”¨ï¼Œè®©æˆ‘ä»¬å¯ä»¥æ‰‹åŠ¨ç®¡ç†ç¨‹åºå ç”¨çš„å†…å­˜æ€»æ•°ã€‚å½“ç¨‹åºåˆ†é…çš„å†…å­˜åˆ°è¾¾ä¸Šé™çš„æ—¶å€™ï¼Œä¼šè§¦å‘GCã€‚éœ€è¦æ³¨æ„ï¼Œè™½ç„¶GCå·²ç»å¾ˆåŠªåŠ›çš„åœ¨å·¥ä½œäº†ï¼Œç¨‹åºä½¿ç”¨çš„å†…å­˜ä¸Šé™ï¼Œå¯èƒ½è¿˜æ˜¯ä¼šè¶…è¿‡GOMEMLIMIT çš„è®¾å®šã€‚\nåœ¨ single ç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬çš„ç¨‹åºä½¿ç”¨äº†11.28M å†…å­˜,concurrent ç‰ˆæœ¬æˆ‘ä»¬æœ‰åä¸ªåç¨‹ä¸€èµ·è¿è¡Œï¼ŒæŒ‰ç…§ gc-guide çš„æŒ‡å¯¼ï¼Œæˆ‘ä»¬éœ€è¦é¢„ç•™10%çš„å†…å­˜åº”å¯¹çªå‘æƒ…å†µã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥æŠŠGOMEMLIMIT è®¾ç½®ä¸º 11.28MB * 1.1 â‰ˆ 124MB\n1 2 3 âœ go_trace git:(main) âœ— time GOGC=off GOMEMLIMIT=124MiB ./go_trace 2 \u0026gt; trace_mem_limit.out 2024/08/05 18:10:55 find key word go 2400 count GOGC=off GOMEMLIMIT=124MiB ./go_trace 2 \u0026gt; trace_mem_limit.out 2.83s user 0.15s system 766% cpu 0.389 total RunTime :376.455 ms, STW: 41.578ms, GC Occurrences: 14, GC STW AVE: 2.969ms\nGC æ—¶é—´ å ç”¨æ€»è¿è¡Œæ—¶é—´ä¸º: 41.578/376.455 â‰ˆ 0.11\næœ€å¤§å†…å­˜å ç”¨ä¸º 120MB,æ¯”è¾ƒæ¥è¿‘æˆ‘ä»¬è®¾ç½®çš„ä¸Šé™ã€‚\nFigure 8: GOMEMLIMIT, GC Max Heap\nFigure 9: GOMEMLIMIT GC count\nå¦‚æœæˆ‘ä»¬ç»§ç»­å¢å¤§ GOMEMLIMITå‚æ•°ï¼Œä¼šå¾—åˆ°æ›´å¥½çš„ç»“æœï¼Œæ¯”å¦‚GOMEMLIMIT=248Mib å¾—åˆ°çš„trace ä¸ºä¸‹å›¾æ‰€ç¤º\nFigure 10: GOMEMLIMIT= 248Mib, GC\nRunTime :320.455 ms, STW: 11.429ms, GC Occurrences: 5, GC STW AVE: 2.285ms\nä½†æ˜¯ä»–ä¸æ˜¯æ²¡æœ‰è¾¹ç•Œçš„ï¼Œ æ¯”å¦‚ GOMEMLIMIT=1024Mib RunTime å·²ç»åˆ°äº†406ms\nFigure 11: GOMEMLIMIT= 1024Mib, GC\né£é™© åœ¨ Suggested_uses ä¸­å·²ç»ä¸ªç»™å‡ºäº†å¾ˆæ˜ç¡®çš„å»ºè®®ï¼Œé™¤éå¯¹è‡ªå·±çš„ç¨‹åºçš„è¿è¡Œç¯å¢ƒï¼Œé¢å¯¹çš„è´Ÿè½½ç‰¹åˆ«ç†Ÿæ‚‰ï¼Œå¦åˆ™ä¸è¦ä½¿ç”¨è¿™ä¸¤ä¸ªå‚æ•°ã€‚è¯·æ‚¨åŠ¡å¿…é˜…è¯» gc-guide\næ€»ç»“ æœ€åæˆ‘ä»¬æ€»ç»“ä¸€ä¸‹ä¸Šé¢çš„è¿‡ç¨‹ä¼˜åŒ–è¿‡ç¨‹ç»“æœ\nFigure 12: Result Compare\nåœ¨åˆé€‚çš„åœºæ™¯ä½¿ç”¨GOGCä»¥åŠGOMEMLIMITï¼Œèƒ½å¤Ÿæœ‰æ•ˆçš„æå‡æ€§èƒ½ã€‚å¹¶ä¸”æœ‰ä¸€ç§æŒæ§æŸç§ä¸ç¡®å®šä¸œè¥¿çš„æˆå°±æ„Ÿã€‚ä½†æ˜¯ä¸€å®šè¦åœ¨å—æ§ç¯å¢ƒä¸­åˆç†åº”ç”¨ï¼Œä»¥ç¡®ä¿æ€§èƒ½å’Œå¯é æ€§ï¼Œè€Œåœ¨èµ„æºå…±äº«æˆ–ä¸å—æ§åˆ¶çš„ç¯å¢ƒä¸­åº”è°¨æ…ï¼Œé¿å…å› è®¾ç½®ä¸å½“å¯¼è‡´æ€§èƒ½ä¸‹é™æˆ–ç¨‹åºå´©æºƒã€‚\nå‚è€ƒèµ„æ–™ [1]. https://www.youtube.com/watch?v=PYMs-urosXs\u0026t=2684s\n[2]. https://www.uber.com/en-TW/blog/how-we-saved-70k-cores-across-30-mission-critical-services/\n[3]. https://tip.golang.org/doc/gc-guide\n","date":"2024-08-06T18:22:18Z","image":"https://images.hxzhouh.com/blog-images/2024/08/42af44f7ae36f49965e3ad6452fca825.png","permalink":"https://huizhou92.com/zh-cn/p/go-%E9%AB%98%E6%80%A7%E8%83%BD%E7%BC%96%E7%A8%8B-ep8-%E5%A6%82%E4%BD%95%E9%80%9A%E8%BF%87%E4%BC%98%E5%8C%96gc%E6%9D%A5%E6%8F%90%E9%AB%98golang%E4%BB%A3%E7%A0%81%E7%9A%84%E6%80%A7%E8%83%BD/","title":"Go é«˜æ€§èƒ½ç¼–ç¨‹ EP8: å¦‚ä½•é€šè¿‡ä¼˜åŒ–GCæ¥æé«˜Golangä»£ç çš„æ€§èƒ½"},{"content":"åŸæ–‡:Avoiding high GC overhead with large heaps\nå½“åˆ†é…çš„å†…å­˜é‡ç›¸å¯¹è¾ƒå°æ—¶ï¼ŒGoåƒåœ¾æ”¶é›†å™¨ (GC) å·¥ä½œå¾—éå¸¸å¥½,ä½†æ˜¯å¦‚æœå †çš„å¤§å°è¾ƒå¤§ï¼ŒGCè¿‡ç¨‹å¯èƒ½ä¼šæ¶ˆè€—å¤§é‡ çš„CPUã€‚åœ¨æç«¯æƒ…å†µä¸‹ï¼Œå®ƒç”šè‡³å¯èƒ½æ— æ³•å®Œæˆä»»åŠ¡ï¼ˆGCç®—æ³•ä¿è¯GCä¸ä¼šä½¿ç”¨è¶…è¿‡50%çš„CPUæ—¶é—´ï¼Œå¦‚æœè¶…è¿‡è¿™é˜ˆå€¼ï¼Œä¼šå¯¼è‡´å†…å­˜æ³„éœ²ï¼‰ã€‚\næœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ GCçš„å·¥ä½œæ˜¯ç¡®å®šå“ªäº›å†…å­˜å—å¯è¢«é‡Šæ”¾ï¼Œå®ƒé€šè¿‡æ‰«æå†…å­˜ä¸­åˆ†é…çš„æŒ‡é’ˆæ¥å®Œæˆè¿™ä¸€ä»»åŠ¡ã€‚ç®€å•æ¥è¯´ï¼Œå¦‚æœæ²¡æœ‰æŒ‡é’ˆæŒ‡å‘æŸä¸ªå†…å­˜åˆ†é…ï¼Œåˆ™å¯é‡Šæ”¾è¯¥å†…å­˜åˆ†é…ã€‚è¿™ç§æ–¹æ³•éå¸¸æœ‰æ•ˆï¼Œä½†éœ€è¦æ‰«æçš„å†…å­˜è¶Šå¤šï¼Œæ‰€éœ€æ—¶é—´å°±è¶Šé•¿ã€‚\nè¿™æ˜¯ä¸€ä¸ªå¤§é—®é¢˜å—ï¼Ÿ æœ‰å¤šä¸¥é‡ï¼Ÿæˆ‘ä»¬æ¥æ­æ™“ï¼ä»¥ä¸‹æ˜¯ demonstrate çš„å°ç¨‹åºã€‚æˆ‘ä»¬åˆ†é… 1e9 ä¸ª 8 å­—èŠ‚æŒ‡é’ˆï¼Œå³çº¦ 8GB çš„å†…å­˜ã€‚æˆ‘ä»¬å¼ºåˆ¶æ‰§è¡Œ GCï¼Œå¹¶æµ‹é‡å®ƒéœ€è¦å¤šé•¿æ—¶é—´ã€‚æˆ‘ä»¬ä¼šé‡å¤å‡ æ¬¡ä»¥è·å¾—ä¸€ä¸ªç¨³å®šçš„å€¼ã€‚è¿˜è°ƒç”¨Â runtime.KeepAlive()Â ä»¥é˜²æ­¢ç¼–è¯‘å™¨ä¼˜åŒ–ã€‚\n1 2 3 4 5 6 7 8 9 10 11 func main() { a := make([]*int, 1e9) for i := 0; i \u0026lt; 10; i++ { start := time.Now() fmt.Printf(\u0026#34;GC took %s\\n\u0026#34;, time.Since(start)) } runtime.KeepAlive(a) } åœ¨æˆ‘çš„ 2015 å¹´ MBPä¸Šï¼Œè¾“å‡ºç»“æœå¦‚ä¸‹æ‰€ç¤ºã€‚\n1 2 3 4 5 6 7 8 9 10 GC took 4.275752421s GC took 1.465274593s GC took 652.591348ms GC took 648.295749ms GC took 574.027934ms GC took 560.615987ms GC took 555.199337ms GC took 1.071215002s GC took 544.226187ms GC took 545.682881ms GCéœ€è¦èŠ±è´¹0.5Sä»¥ä¸Šçš„æ—¶é—´ã€‚æˆ‘ä¸ºå®ƒåˆ†é…äº†10e9ä¸ªæŒ‡é’ˆã€‚äº‹å®ä¸Šï¼Œæ¯æ£€æŸ¥ä¸€ä¸ªæŒ‡é’ˆæ‰€èŠ±è´¹çš„æ—¶é—´ä¸åˆ°ä¸€çº³ç§’ã€‚å¯¹äºæ£€æŸ¥æŒ‡é’ˆçš„é€Ÿåº¦æ¥è¯´ï¼Œè¿™å·²ç»ç›¸å½“å¿«äº†ã€‚\nç„¶åå‘¢ï¼Ÿ å¦‚æœæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºçœŸçš„éœ€è¦åœ¨å†…å­˜ä¸­ç»´æŒä¸€ä¸ªå·¨å¤§çš„Mapæˆ–è€…æ•°ç»„ï¼Œé‚£å¯å°±éº»çƒ¦äº†ã€‚å¦‚æœGCåšæŒå®šæœŸæ‰«ææˆ‘ä»¬åˆ†é…çš„å…¨éƒ¨å†…å­˜ï¼Œæˆ‘ä»¬å°±ä¼šæŸå¤±å¤§é‡çš„CPUæ—¶é—´ã€‚æœ‰ä»€ä¹ˆåŠæ³•å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜å—ï¼Ÿ æˆ‘ä»¬åŸºæœ¬ä¸Šåªæœ‰ä¸¤ç§é€‰æ‹©:è¦ä¹ˆå¯¹ GC éšè—å†…å­˜ï¼Œè¦ä¹ˆä½¿GCå¯¹å…¶ä¸æ„Ÿå…´è¶£ï¼Œä¸æ‰«æå®ƒã€‚\nè®©GCä¸æ‰«æè¿™éƒ¨åˆ†å†…å­˜ æ€æ ·æ‰èƒ½è®©GCä¸æ‰«æè¿™éƒ¨åˆ†å†…å­˜ï¼ŸGCåœ¨å¯»æ‰¾æŒ‡é’ˆã€‚å¦‚æœæˆ‘ä»¬åˆ†é…çš„å¯¹è±¡çš„ç±»å‹ä¸åŒ…å«æŒ‡é’ˆï¼ŒGCè¿˜ä¼šæ‰«æå—ï¼Ÿ\næˆ‘ä»¬å¯ä»¥å°è¯•ä¸€ä¸‹ã€‚åœ¨ä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬åˆ†é…ä¸ä¹‹å‰å®Œå…¨ç›¸åŒæ•°é‡çš„å†…å­˜ï¼Œä½†è¿™æ¬¡æˆ‘ä»¬çš„åˆ†é…ä¸­æ²¡æœ‰æŒ‡é’ˆç±»å‹ã€‚æˆ‘ä»¬åˆ†é…äº†ä¸€å—åŒ…å«åäº¿ä¸ª 8 å­—èŠ‚æ•´æ•°ï¼ˆintsï¼‰çš„åˆ‡ç‰‡å†…å­˜ã€‚å†æ¬¡å¼ºè°ƒï¼Œè¿™æ˜¯å¤§çº¦8GBçš„å†…å­˜ã€‚\n1 2 3 4 5 6 7 8 9 func main() { a := make([]int, 1e9) for i := 0; i \u0026lt; 10; i++ { start := time.Now() runtime.GC() fmt.Printf(\u0026#34;GC took %s\\n\u0026#34;, time.Since(start)) } runtime.KeepAlive(a) } å†æ¬¡åœ¨æˆ‘çš„ 2015 å¹´æ¬¾ MBPä¸Šè¿è¡Œäº†è¿™ä¸ªç¨‹åºï¼Œç»“æœå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 GC took 350.941Âµs GC took 179.517Âµs GC took 169.442Âµs GC took 191.353Âµs GC took 126.585Âµs GC took 127.504Âµs GC took 111.425Âµs GC took 163.378Âµs GC took 145.257Âµs GC took 144.757Âµs GC çš„é€Ÿåº¦å¿«äº†è¶³è¶³ä¸€åƒå€ï¼Œè€Œæ‰€åˆ†é…çš„å†…å­˜æ•°é‡å´å®Œå…¨ä¸€æ ·ã€‚åŸæ¥ Go è¯­è¨€å†…å­˜ç®¡ç†å™¨èƒ½è¯†åˆ«æ¯ä¸€æ¬¡å†…å­˜åˆ†é…çš„ç±»å‹ï¼Œå¹¶ä¸”ä¼šç»™ä¸åŒ…å«æŒ‡é’ˆçš„å†…å­˜æ‰“ä¸Šæ ‡è®°ï¼Œè¿™æ · GC åœ¨æ‰«æå†…å­˜æ—¶å°±èƒ½è·³è¿‡å®ƒä»¬ã€‚å¦‚æœæˆ‘ä»¬èƒ½è®©å¤§å†…å­˜ä¸­ä¸åŒ…å«æŒ‡é’ˆçš„è¯ï¼Œé‚£å°±å¤ªæ£’äº†ã€‚\nå°†å†…å­˜éšè—èµ·æ¥ æˆ‘ä»¬å¯ä»¥åšå¦ä¸€ä»¶äº‹å°±æ˜¯å°†åˆ†é…çš„å†…å­˜éšè—èµ·æ¥ï¼Œè®©GCçœ‹ä¸è§ã€‚å¦‚æœæˆ‘ä»¬ç›´æ¥å‘æ“ä½œç³»ç»Ÿè¯·æ±‚å†…å­˜ï¼ŒGCå°±æ°¸è¿œä¸ä¼šçŸ¥é“å®ƒï¼Œä¹Ÿå°±ä¸ä¼šæ‰«æå®ƒã€‚ä¸æˆ‘ä»¬ä¹‹å‰ä¾‹å­çš„åšæ³•ç›¸æ¯”ï¼Œè¿™æ ·åšç¨å¾®æœ‰äº›å¤æ‚ï¼è¿™é‡Œæ˜¯æˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªç¨‹åºçš„ç­‰ä»·ç‰ˆæœ¬ï¼Œæˆ‘ä»¬ä½¿ç”¨ mmap ç³»ç»Ÿè°ƒç”¨ç›´æ¥ä»æ“ä½œç³»ç»Ÿå†…æ ¸åˆ†é…Â []*intÂ äº¿ï¼ˆ1e9ï¼‰ä¸ªæ¡ç›®ã€‚æ³¨æ„ï¼Œè¿™åªåœ¨ *unix ç³»ç»Ÿä¸Šæœ‰æ•ˆï¼Œä½†åœ¨ Windows ä¸Šä¹Ÿæœ‰ç±»ä¼¼çš„æ–¹æ³•ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 package main import ( \u0026#34;fmt\u0026#34; \u0026#34;reflect\u0026#34; \u0026#34;runtime\u0026#34; \u0026#34;syscall\u0026#34; \u0026#34;time\u0026#34; \u0026#34;unsafe\u0026#34; ) func main() { var example *int slice := makeSlice(1e9, unsafe.Sizeof(example)) a := *(*[]*int)(unsafe.Pointer(\u0026amp;slice)) for i := 0; i \u0026lt; 10; i++ { start := time.Now() runtime.GC() fmt.Printf(\u0026#34;GC took %s\\n\u0026#34;, time.Since(start)) } runtime.KeepAlive(a) } func makeSlice(len int, eltsize uintptr) reflect.SliceHeader { fd := -1 data, _, errno := syscall.Syscall6( syscall.SYS_MMAP, 0, // address uintptr(len)*eltsize, syscall.PROT_READ|syscall.PROT_WRITE, syscall.MAP_ANON|syscall.MAP_PRIVATE, uintptr(fd), // No file descriptor 0, // offset ) if errno != 0 { panic(errno) } return reflect.SliceHeader{ Data: data, Len: len, Cap: len, } } è¿™æ¬¡çš„GCè€—æ—¶ä¸ºï¼š\n1 2 3 4 5 6 7 8 9 10 GC took 460.777Âµs GC took 206.805Âµs GC took 174.58Âµs GC took 193.697Âµs GC took 184.325Âµs GC took 142.556Âµs GC took 132.48Âµs GC took 155.853Âµs GC took 138.54Âµs GC took 159.04Âµs å¦‚æœæ‚¨æƒ³äº†è§£Â a := *(*[]*int)(unsafe.Pointer(\u0026amp;slice))Â ï¼Œè¯·æµè§ˆ https://blog.gopheracademy.com/advent-2017/unsafe-pointer-and-system-calls/ã€‚\nç°åœ¨ï¼Œè¿™éƒ¨åˆ†å†…å­˜å¯¹GCæ˜¯ä¸å¯è§çš„ã€‚è¿™ä¼šå¸¦æ¥ä¸€ä¸ªæœ‰è¶£çš„åæœï¼Œå³å­˜å‚¨åœ¨è¿™ä¸€å†…å­˜ä¸­çš„æŒ‡é’ˆï¼Œä¸ä¼šé˜»æ­¢å®ƒä»¬æŒ‡å‘çš„â€˜æ­£å¸¸â€™åˆ†é…çš„å†…å­˜è¢«GCå›æ”¶ã€‚è€Œè¿™ä¼šå¸¦æ¥ç³Ÿç³•çš„åæœï¼Œæˆ‘ä»¬å¾ˆå®¹æ˜“å°±å¯è¯æ˜ã€‚\nåœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å°è¯•å°† 0ã€1 å’Œ 2 å­˜å…¥å †åˆ†é…çš„æ•´æ•°ä¸­ï¼Œå¹¶å°†æŒ‡å‘å®ƒä»¬çš„æŒ‡é’ˆå­˜å…¥mmapåˆ†é…çš„åˆ‡ç‰‡ä¸­ï¼ˆä¸å—GCç®¡æ§ï¼‰ã€‚åœ¨ä¸ºæ¯ä¸ªæ•´æ•°åˆ†é…å†…å­˜å¹¶å­˜å‚¨æŒ‡å‘å®ƒä»¬çš„æŒ‡é’ˆåï¼Œæˆ‘ä»¬å¼ºåˆ¶æ‰§è¡Œä¸€æ¬¡åƒåœ¾å›æ”¶ã€‚\næˆ‘ä»¬çš„è¾“å‡ºåœ¨è¿™é‡Œã€‚åœ¨æ¯æ¬¡åƒåœ¾å›æ”¶åï¼Œæ”¯æŒæˆ‘ä»¬æ•´æ•°çš„å†…å­˜éƒ½ä¼šè¢«é‡Šæ”¾å¹¶å¯èƒ½è¢«é‡æ–°ä½¿ç”¨ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬çš„æ•°æ®å¹¶ä¸åƒæˆ‘ä»¬é¢„æœŸçš„é‚£æ ·ï¼Œå¾ˆå¹¸è¿ç¨‹åºæ²¡æœ‰å´©æºƒã€‚\n1 2 3 4 5 6 7 8 9 10 a[0] is C000016090 *a[0] is 0 a[1] is C00008C030 *a[1] is 1 a[2] is C00008C030 *a[2] is 2 *a[0] is 0 *a[1] is 811295018 *a[2] is 811295018 è¿™æ ·æ˜¾ç„¶æ˜¯ä¸è¡Œçš„ã€‚å¦‚æœæˆ‘ä»¬ä¿®æ”¹æˆä½¿ç”¨é€šå¸¸åˆ†é…çš„Â []*intÂ ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼Œå°±å¯ä»¥å¾—åˆ°é¢„æœŸçš„ç»“æœã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 func main() { a := make([]*int, 3) for j := range a { a[j] = getMeAnInt(j) fmt.Printf(\u0026#34;a[%d] is %X\\n\u0026#34;, j, a[j]) fmt.Printf(\u0026#34;*a[%d] is %d\\n\u0026#34;, j, *a[j]) runtime.GC() } fmt.Println() for j := range a { fmt.Printf(\u0026#34;*a[%d] is %d\\n\u0026#34;, j, *a[j]) } } è¾“å‡ºå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 a[0] is C00009A000 *a[0] is 0 a[1] is C00009A040 *a[1] is 1 a[2] is C00009A050 *a[2] is 2 *a[0] is 0 *a[1] is 1 *a[2] is 2 é—®é¢˜çš„æœ¬è´¨ æ‰€ä»¥ï¼Œæœ€ç»ˆæˆ‘ä»¬è¯æ˜æŒ‡é’ˆæ˜¯æˆ‘ä»¬çš„æ•Œäººï¼Œæ— è®ºæˆ‘ä»¬åœ¨å †ä¸Šåˆ†é…äº†å¤§é‡å†…å­˜ï¼Œè¿˜æ˜¯è¯•å›¾é€šè¿‡å°†æ•°æ®ç§»åŠ¨åˆ°æˆ‘ä»¬è‡ªå·±çš„éå †å†…å­˜åˆ†é…æ¥è§„é¿è¿™ä¸ªé—®é¢˜ã€‚å¦‚æœæˆ‘ä»¬èƒ½åœ¨åˆ†é…çš„ç±»å‹ä¸­é¿å…ä½¿ç”¨æŒ‡é’ˆï¼Œå°±ä¸ä¼šé€ æˆGCçš„è´Ÿæ‹…ï¼Œä»è€Œæ— éœ€ä½¿ç”¨ä»»ä½•å¥‡æŠ€æ·«å·§ã€‚å¦‚æœæˆ‘ä»¬ä½¿ç”¨éå †å†…å­˜åˆ†é…ï¼Œåˆ™éœ€è¦é¿å…å­˜å‚¨å¯¹å †å†…å­˜çš„æŒ‡é’ˆï¼Œé™¤éè¿™äº›å†…å­˜ä¹Ÿè¢«GCå¯è®¿é—®å†…å­˜æ‰€å¼•ç”¨ã€‚\næˆ‘ä»¬å¦‚ä½•æ‰èƒ½é¿å…ä½¿ç”¨æŒ‡é’ˆï¼Ÿ åœ¨å¤§çš„å †å†…å­˜ä¸­ï¼ŒæŒ‡é’ˆæ˜¯é‚ªæ¶çš„ï¼Œå¿…é¡»é¿å…ã€‚ä½†æ˜¯è¦é¿å…å®ƒä»¬ï¼Œä½ å°±å¿…é¡»èƒ½è¯†åˆ«å‡ºæ¥ï¼Œè€Œå®ƒä»¬å¹¶ä¸æ€»æ˜¯å¾ˆæ˜æ˜¾ã€‚å­—ç¬¦ä¸²ã€åˆ‡ç‰‡å’Œ time.Time å‡åŒ…å«æŒ‡é’ˆã€‚å¦‚æœä½ åœ¨å†…å­˜ä¸­å­˜å‚¨äº†å¤§é‡è¿™äº›æ•°æ®ï¼Œå°±å¯èƒ½éœ€è¦é‡‡å–ä¸€äº›æªæ–½ã€‚\næˆ‘é‡åˆ°å¤§å †é—®é¢˜æ—¶ï¼Œä¸»è¦åŸå› æœ‰ä»¥ä¸‹å‡ ç‚¹ã€‚\nè®¸å¤šå­—ç¬¦ä¸² å°†å¯¹è±¡ä¸Šçš„æ—¶é—´æˆ³ä½¿ç”¨ time.Time è¿›è¡Œç¿»è¯‘ã€‚ å€¼ä¸ºslice çš„map key ä¸ºstringçš„ map\nå¯¹äºå¤„ç†è¿™äº›é—®é¢˜çš„ä¸åŒç­–ç•¥ï¼Œæœ‰å¾ˆå¤šè¯è¦è¯´ã€‚åœ¨æœ¬å¸–ä¸­ï¼Œæˆ‘åªè®¨è®ºä¸€ç§å¤„ç†å­—ç¬¦ä¸²çš„æ–¹æ³•ã€‚ å°†å­—ç¬¦ä¸²sliceå˜æˆä¸€ä¸ªå¸¦ç´¢å¼•çš„æ•°ç»„ã€‚ ä¸€æ¡å­—ç¬¦ä¸²ç”±ä¸¤ä¸ªéƒ¨åˆ†ç»„æˆã€‚ä¸€ä¸ªæ˜¯å­—ç¬¦ä¸²å¤´ï¼Œå®ƒä¼šå‘Šè¯‰ä½ å­—ç¬¦ä¸²çš„é•¿åº¦ä»¥åŠåœ¨å“ªé‡Œæ‰¾åˆ°åŸå§‹æ•°æ®ï¼›å¦ä¸€ä¸ªå°±æ˜¯å®é™…çš„å­—ç¬¦ä¸²æ•°æ®äº†ï¼Œå®ƒåªæ˜¯ä¸€ç³»åˆ—å­—èŠ‚çš„é¡ºåºã€‚\nå½“ä½ å°†ä¸€ä¸ªå­—ç¬¦ä¸²å˜é‡ä¼ é€’ç»™ä¸€ä¸ªå‡½æ•°æ—¶ï¼Œåªæœ‰å­—ç¬¦ä¸²çš„å¤´è¢«å†™å…¥æ ˆä¸­ï¼Œå¦‚æœä½ ä¿æŒä¸€ä¸ªå­—ç¬¦ä¸²åˆ‡ç‰‡ï¼Œé‚£ä¹ˆåˆ‡ç‰‡ä¸­çš„å­—ç¬¦ä¸²å¤´å°±ä¼šå‡ºç°ã€‚\nå­—ç¬¦ä¸²å¤´çš„å®šä¹‰æ˜¯Â reflect.StringHeaderÂ ï¼Œé•¿è¿™æ ·ï¼š\n1 2 3 4 type StringHeader struct { Data uintptr Len int } å­—ç¬¦ä¸²å¤´åŒ…å«æŒ‡é’ˆï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸æƒ³å­˜å‚¨å­—ç¬¦ä¸²ï¼\nå¦‚æœä½ çš„å­—ç¬¦ä¸²åªå–å‡ ç§å›ºå®šçš„å€¼ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨æ•´æ•°å¸¸é‡æ›¿ä»£ å°†æ—¥æœŸå’Œæ—¶é—´ä½œä¸ºå­—ç¬¦ä¸²å­˜å‚¨çš„è¯ï¼Œä¸å¦¨å°†å®ƒä»¬è§£æä¸ºæ•´æ•°å¹¶å­˜å‚¨èµ·æ¥ å¦‚æœä½ çœŸçš„éœ€è¦å¾ˆå¤šstringï¼Œé‚£å°±è¯·ç»§ç»­é˜…è¯»â€¦â€¦\nå‡è®¾æˆ‘ä»¬æ­£åœ¨å­˜å‚¨ä¸€äº¿æ¡è®°å½•ã€‚ä¸ºäº†ç®€å•èµ·è§ï¼Œæˆ‘ä»¬å‡å®šè¿™æ˜¯ä¸ªå·¨å¤§çš„å…¨å±€å˜é‡Â var mystrings []stringÂ ã€‚\nè¿™é‡Œæœ‰ä»€ä¹ˆï¼ŸÂ mystringsÂ çš„åŸºç¡€æ¶æ„æ˜¯ä¸€ä¸ªÂ reflect.SliceHeaderÂ ï¼Œå®ƒä¸æˆ‘ä»¬åˆšåˆšçœ‹åˆ°çš„Â reflect.StringHeaderÂ ç›¸ä¼¼ã€‚ 1 2 3 4 5 type SliceHeader struct { Data uintptr Len int Cap int } å¯¹äºÂ mystringsÂ ï¼ŒLen å’Œ Cap éƒ½æ˜¯ 10e8ï¼ŒData ä¼šæŒ‡å‘ä¸€ä¸ªè¶³å¤Ÿå®¹çº³ 10e8 ä¸ªÂ StringHeaderÂ çš„è¿ç»­å†…å­˜åŒºåŸŸã€‚è¿™ä¸€å—å†…å­˜åŒ…å«æŒ‡é’ˆï¼Œå› æ­¤ä¼šè¢«GCæ‰«æã€‚\nå­—ç¬¦ä¸²æœ¬èº«ç”±ä¸¤éƒ¨åˆ†ç»„æˆã€‚è¿™ä¸ªåˆ‡ç‰‡ä¸­åŒ…å«çš„æ˜¯StringHeadersï¼Œä»¥åŠæ¯ä¸ªå­—ç¬¦ä¸²çš„æ•°æ®ï¼Œè¿™äº›æ•°æ®æ˜¯å•ç‹¬çš„åˆ†é…ï¼Œæ•°æ®æœ¬èº«æ²¡æœ‰åŒ…å«æŒ‡é’ˆã€‚ä»åƒåœ¾å›æ”¶çš„è§’åº¦æ¥çœ‹ï¼Œé—®é¢˜åœ¨äºå­—ç¬¦ä¸²å¤´éƒ¨ï¼Œè€Œä¸æ˜¯å­—ç¬¦ä¸²æ•°æ®æœ¬èº«ã€‚å­—ç¬¦ä¸²æ•°æ®ä¸åŒ…å«æŒ‡é’ˆï¼Œå› æ­¤ä¸ä¼šè¢«æ‰«æã€‚åºå¤§çš„å­—ç¬¦ä¸²å¤´éƒ¨æ•°ç»„åŒ…å«æŒ‡é’ˆï¼Œå› æ­¤å¿…é¡»åœ¨æ¯ä¸ªåƒåœ¾å›æ”¶å‘¨æœŸä¸­è¿›è¡Œæ‰«æã€‚\nå¦‚æœæ‰€æœ‰å­—ç¬¦ä¸²çš„å­—èŠ‚éƒ½å­˜æ”¾åœ¨ä¸€å—å†…å­˜ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æ¯ä¸ªå­—ç¬¦ä¸²ç›¸å¯¹äºå†…å­˜èµ·å§‹å’Œç»ˆæ­¢ä½ç½®çš„åç§»é‡æ¥è·Ÿè¸ªå®ƒä»¬ã€‚é€šè¿‡è·Ÿè¸ªåç§»é‡ï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨å¤§å‹sliceä¸­æ¶ˆé™¤æŒ‡é’ˆï¼Œè·³è¿‡åƒåœ¾å›æ”¶çš„æ‰«æã€‚\nè¿™æ ·åšçš„åå¤„å°±æ˜¯ï¼Œä¸§å¤±äº†slice æ“ä½œçš„ä¾¿åˆ©æ€§ï¼Œslice çš„ä¿®æ”¹å˜å¾—ç‰¹åˆ«å¤æ‚ï¼Œæˆ‘ä»¬ä¸ºå°†å­—ç¬¦ä¸²ä½“å¤åˆ¶åˆ°å¤§çš„å­—èŠ‚åˆ‡ç‰‡ä¸Šå¢åŠ äº†å¼€é”€ã€‚\nè¿™é‡Œæœ‰ä¸€ä¸ªå°ç¨‹åºæ¥æ¼”ç¤ºè¿™ä¸ªæƒ³æ³•ã€‚æˆ‘ä»¬å°†åˆ›å»º 10e8ä¸ªå­—ç¬¦ä¸²ï¼Œå°†è¿™äº›å­—ç¬¦ä¸²çš„å­—èŠ‚å¤åˆ¶åˆ°ä¸€ä¸ªå¤§çš„å­—èŠ‚åˆ‡ç‰‡ä¸­ï¼Œå¹¶å­˜å‚¨åç§»é‡ã€‚å¯ä»¥çœ‹åˆ°GCè€—æ—¶éå¸¸å°‘ï¼Œç„¶åé€šè¿‡æ˜¾ç¤ºå‰ 10 ä¸ªå­—ç¬¦ä¸²æ¥è¯æ˜æˆ‘ä»¬å¯ä»¥æ£€ç´¢è¿™äº›å­—ç¬¦ä¸²ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 package main import ( \u0026#34;fmt\u0026#34; \u0026#34;runtime\u0026#34; \u0026#34;strconv\u0026#34; \u0026#34;time\u0026#34; \u0026#34;unsafe\u0026#34; ) func main() { var stringBytes []byte var stringOffsets []int for i := 0; i \u0026lt; 1e8; i++ { val := strconv.Itoa(i) stringBytes = append(stringBytes, val...) stringOffsets = append(stringOffsets, len(stringBytes)) } runtime.GC() start := time.Now() runtime.GC() fmt.Printf(\u0026#34;GC took %s\\n\u0026#34;, time.Since(start)) sStart := 0 for i := 0; i \u0026lt; 10; i++ { sEnd := stringOffsets[i] bytes := stringBytes[sStart:sEnd] stringVal := *(*string)(unsafe.Pointer(\u0026amp;bytes)) fmt.Println(stringVal) sStart = sEnd } } 1 2 3 4 5 6 7 8 9 10 11 GC took 187.082Âµs 0 1 2 3 4 5 6 7 8 9 å¦‚æœä½ æ°¸è¿œä¸éœ€è¦ä¿®æ”¹è¿™äº›å­—ç¬¦ä¸²ï¼Œå¯ä»¥å°†å®ƒè½¬æ¢ä¸ºä¸€ä¸ªæ›´å¤§æ•°æ®å—çš„ç´¢å¼•æ–¹å¼ï¼Œä»è€Œé¿å…å¤§é‡æŒ‡é’ˆã€‚å¦‚æœä½ æ„Ÿå…´è¶£ï¼Œæˆ‘å®ç°äº†ä¸€ä¸ªæ›´å¤æ‚ä¸€ç‚¹çš„ä¸œè¥¿ï¼Œå®ƒéµå¾ªè¿™ä¸€åŸåˆ™ã€‚\næˆ‘ä¹‹å‰å¤šæ¬¡åœ¨åšå®¢ä¸­æåˆ°è¿‡é‡åˆ°ç”±å¤§å †å¼•å‘çš„åƒåœ¾å›æ”¶ï¼ˆGCï¼‰é—®é¢˜ã€‚äº‹å®ä¸Šï¼Œæ¯å½“æˆ‘é‡åˆ°è¿™ä¸ªé—®é¢˜æ—¶ï¼Œæˆ‘éƒ½æ„Ÿåˆ°æƒŠè®¶ï¼Œå¹¶å†æ¬¡åœ¨åšå®¢ä¸­å†™é“å®ƒã€‚å¸Œæœ›çœ‹åˆ°è¿™é‡Œæ—¶ï¼Œå¦‚æœåœ¨ä½ é¡¹ç›®ä¸­å‘ç°è¿™ä¸ªé—®é¢˜çš„è¯ï¼Œä¸ä¼šè®©ä½ æ„Ÿåˆ°æƒŠè®¶ï¼Œä½ ç”šè‡³ä¼šæå‰æƒ³åˆ°è¿™ä¸ªé—®é¢˜ã€‚\nä»¥ä¸‹æ˜¯ä¸€äº›èµ„æºï¼Œå¸Œæœ›å¯¹ä½ è§£å†³è¿™äº›é—®é¢˜æœ‰æ‰€å¸®åŠ©ã€‚\næˆ‘ä¸Šé¢æåˆ°çš„string store interning libraryÂ ä¸€ä¸ªç”¨äº Go è¯­è¨€çš„å­—ç¬¦ä¸² interning åº“ï¼Œ variationÂ å°†å­—ç¬¦ä¸² ID è½¬æ¢ä¸ºæ•´æ•° IDï¼Œä»è€Œå¯ä»¥ç”¨äºå¿«é€Ÿæ¯”è¾ƒå’Œæ•°ç»„/åˆ‡ç‰‡æŸ¥æ‰¾ã€‚ ","date":"2024-07-24T10:16:50+08:00","permalink":"https://huizhou92.com/zh-cn/p/%E8%AF%91-go-action%E5%A6%82%E4%BD%95%E9%81%BF%E5%85%8D%E5%9B%A0%E4%B8%BA%E5%A4%A7%E5%A0%86%E4%BA%A7%E7%94%9F%E7%9A%84%E9%AB%98gc%E5%BC%80%E9%94%80/","title":"ã€è¯‘ã€‘ Go Actionï¼šå¦‚ä½•é¿å…å› ä¸ºå¤§å †äº§ç”Ÿçš„é«˜GCå¼€é”€"},{"content":"åœ¨å¼€å‘ä¸šåŠ¡ä»£ç è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸ä¼šä½¿ç”¨ç¼“å­˜DBæ•°æ®çš„æ–¹å¼æ¥åŠ é€ŸæŸ¥è¯¢ï¼Œè¿™æ ·çš„æ¶æ„ä¼šæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¸¸å¸¸éœ€è¦è§£å†³ç¼“å­˜ç©¿é€ã€ç¼“å­˜é›ªå´©å’Œç¼“å­˜å‡»ç©¿é—®é¢˜ã€‚ç¼“å­˜å‡»ç©¿é—®é¢˜æ˜¯æŒ‡ï¼Œåœ¨å¹³å¸¸é«˜å¹¶å‘çš„ç³»ç»Ÿä¸­ï¼Œå¤§é‡çš„è¯·æ±‚åŒæ—¶æŸ¥è¯¢ä¸€ä¸ª key æ—¶ï¼Œå¦‚æœè¿™ä¸ª key æ­£å¥½è¿‡æœŸå¤±æ•ˆäº†ï¼Œå°±ä¼šå¯¼è‡´å¤§é‡çš„è¯·æ±‚éƒ½æ‰“åˆ°æ•°æ®åº“ä¸Šï¼Œé€ æˆæ•°æ®åº“å‹åŠ›å¾ˆå¤§ï¼Œè¿™å°±æ˜¯ç¼“å­˜å‡»ç©¿ã€‚å¦‚æœèƒ½å¤Ÿå°†ä¸€æ®µæ—¶é—´çš„ç›¸åŒçš„Nä¸ªè¯·æ±‚åˆæˆä¸€ä¸ªï¼Œé‚£ä¹ˆç©¿é€åˆ°æ•°æ®åº“çš„å‹åŠ›æ˜¯ä¸æ˜¯å°±ä»Nå˜æˆäº†1ï¼Ÿ\nSingleFlight å°±æ˜¯è¿™æ ·çš„ä¸€ä¸ªå¹¶å‘åŸè¯­ã€‚æœ¬æ–‡ä»‹ç»äº†SingleFlight , çš„ä½¿ç”¨ä»¥åŠå®ƒçš„åŸºæœ¬åŸç†ï¼Œè¿˜æœ‰ä¸€äº›ä½¿ç”¨ä¸Šçš„ç»†èŠ‚ã€‚\nThis article was first published in the Medium MPP plan. If you are a Medium user, please follow me on Medium. Thank you very much.\nFigure 1ï¼šä½¿ç”¨ SingleFlight åˆå¹¶ç›¸åŒçš„è¯·æ±‚ã€‚\nSingleFlight ä½¿ç”¨ Go å®˜æ–¹å°† singleflightÂ ,æ”¾åœ¨äº†golang.org/x ä¸­ï¼Œè¯´æ˜ä»–å¯èƒ½è¿˜ä¼šæœ‰ä¸€äº›å˜åŒ–ã€‚å®ƒæä¾›äº†é‡å¤å‡½æ•°è°ƒç”¨æŠ‘åˆ¶æœºåˆ¶ï¼Œä½¿ç”¨å®ƒå¯ä»¥é¿å…åŒæ—¶è¿›è¡Œç›¸åŒçš„å‡½æ•°è°ƒç”¨ã€‚ç¬¬ä¸€ä¸ªè°ƒç”¨æœªå®Œæˆæ—¶åç»­çš„é‡å¤è°ƒç”¨ä¼šç­‰å¾…ï¼Œå½“ç¬¬ä¸€ä¸ªè°ƒç”¨å®Œæˆæ—¶åˆ™ä¼šä¸å®ƒä»¬åˆ†äº«ç»“æœï¼Œè¿™æ ·ä»¥æ¥è™½ç„¶åªæ‰§è¡Œäº†ä¸€æ¬¡å‡½æ•°è°ƒç”¨ä½†æ˜¯æ‰€æœ‰è°ƒç”¨éƒ½æ‹¿åˆ°äº†æœ€ç»ˆçš„è°ƒç”¨ç»“æœã€‚\nlist1: ä½¿ç”¨ SingleFlight åˆå¹¶DBè¯·æ±‚\nä»ç»“æœå¯ä»¥çœ‹å‡ºï¼Œæˆ‘ä»¬æˆ‘ä»¬æ¨¡æ‹Ÿäº†5ä¸ªè¯·æ±‚cache miss çš„æƒ…å†µï¼Œä½†æ˜¯åªæœ‰ä¸€ä¸ªè¯·æ±‚è°ƒç”¨äº†DBï¼Œäº”ä¸ªè¯·æ±‚éƒ½æ‹¿åˆ°äº†ç›¸åŒçš„ç»“æœã€‚è¿™å¯¹äºåç«¯æœåŠ¡æ¥è¯´ï¼Œæ˜¯å¾ˆå¯è§‚çš„ä¼˜åŒ–ã€‚ä»–é¿å…äº†æ•°æ®åº“è¢«ç¼“å­˜ç©¿é€ã€‚\nåœ¨go æºç ä¸­ï¼ŒåŒæ ·èƒ½çœ‹åˆ° SingleFlight çš„ä½¿ç”¨ï¼Œæ¯”å¦‚/src/net/lookup.go#L165/src/cmd/go/internal/vcs/vcs.go#L1385ï¼Œç¼“å­˜åº“ groupcache ä¹Ÿæ˜¯ä½¿ç”¨SingleFlight ç±»ä¼¼çš„å®ç°æ¥é˜²æ­¢ç¼“å­˜ç©¿é€ã€‚\nsingleflight åˆ†æ singleflightåŒ…ä¸­å®šä¹‰äº†ä¸€ä¸ªåä¸ºGroupçš„ç»“æ„ä½“ç±»å‹ï¼Œå®ƒè¡¨ç¤ºä¸€ç±»å·¥ä½œï¼Œå¹¶å½¢æˆä¸€ä¸ªå‘½åç©ºé—´ï¼Œåœ¨è¿™ä¸ªå‘½åç©ºé—´ä¸­ï¼Œå¯ä»¥ä½¿ç”¨é‡å¤æŠ‘åˆ¶æ¥æ‰§è¡Œå·¥ä½œå•å…ƒã€‚\nSingleFlight çš„æ•°æ®ç»“æ„æ˜¯ Groupï¼Œå®ƒæä¾›äº†ä¸‰ä¸ªæ–¹æ³•ã€‚\nDoï¼šè¿™ä¸ªæ–¹æ³•æ‰§è¡Œä¸€ä¸ªå‡½æ•°ï¼Œå¹¶è¿”å›å‡½æ•°æ‰§è¡Œçš„ç»“æœã€‚ä½ éœ€è¦æä¾›ä¸€ä¸ª keyï¼Œå¯¹äºåŒä¸€ä¸ª keyï¼Œåœ¨åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªåœ¨æ‰§è¡Œï¼ŒåŒä¸€ä¸ª key å¹¶å‘çš„è¯·æ±‚ä¼šç­‰å¾…ã€‚ç¬¬ä¸€ä¸ªæ‰§è¡Œçš„è¯·æ±‚è¿”å›çš„ç»“æœï¼Œå°±æ˜¯å®ƒçš„è¿”å›ç»“æœã€‚å‡½æ•° fn æ˜¯ä¸€ä¸ªæ— å‚çš„å‡½æ•°ï¼Œè¿”å›ä¸€ä¸ªç»“æœæˆ–è€… errorï¼Œè€Œ Do æ–¹æ³•ä¼šè¿”å›å‡½æ•°æ‰§è¡Œçš„ç»“æœæˆ–è€…æ˜¯ errorï¼Œshared ä¼šæŒ‡ç¤º v æ˜¯å¦è¿”å›ç»™å¤šä¸ªè¯·æ±‚ã€‚ DoChanï¼šç±»ä¼¼ Do æ–¹æ³•ï¼Œåªä¸è¿‡æ˜¯è¿”å›ä¸€ä¸ª chanï¼Œç­‰ fn å‡½æ•°æ‰§è¡Œå®Œï¼Œäº§ç”Ÿäº†ç»“æœä»¥åï¼Œå°±èƒ½ä»è¿™ä¸ª chan ä¸­æ¥æ”¶è¿™ä¸ªç»“æœã€‚ Forgetï¼šå‘Šè¯‰ Group å¿˜è®°è¿™ä¸ª keyã€‚è¿™æ ·ä¸€æ¥ï¼Œä¹‹åè¿™ä¸ª key è¯·æ±‚ä¼šæ‰§è¡Œ fnï¼Œè€Œä¸æ˜¯ç­‰å¾…å‰ä¸€ä¸ªæœªå®Œæˆçš„ fn å‡½æ•°çš„ç»“æœã€‚ ä½¿ç”¨ç»†èŠ‚ è¯·æ±‚é˜»å¡ singleflight å†…éƒ¨ä½¿ç”¨ waitGroup æ¥è®©åŒä¸€ä¸ª key çš„é™¤äº†ç¬¬ä¸€ä¸ªè¯·æ±‚çš„åç»­æ‰€æœ‰è¯·æ±‚éƒ½é˜»å¡ã€‚ç›´åˆ°ç¬¬ä¸€ä¸ªè¯·æ±‚æ‰§è¡Œ fn è¿”å›åï¼Œå…¶ä»–è¯·æ±‚æ‰ä¼šè¿”å›ã€‚\nè¿™æ„å‘³ç€ï¼Œå¦‚æœ fn æ‰§è¡Œéœ€è¦å¾ˆé•¿æ—¶é—´ï¼Œé‚£ä¹ˆåé¢çš„æ‰€æœ‰è¯·æ±‚éƒ½ä¼šè¢«ä¸€ç›´é˜»å¡ã€‚\nè¿™æ—¶å€™æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ DoChan ç»“åˆ ctx + select åšè¶…æ—¶æ§åˆ¶\nForget singleflight çš„å®ç°ä¸ºï¼Œå¦‚æœç¬¬ä¸€ä¸ªè¯·æ±‚å¤±è´¥äº†ï¼Œé‚£ä¹ˆåç»­æ‰€æœ‰ç­‰å¾…çš„è¯·æ±‚éƒ½ä¼šè¿”å›åŒä¸€ä¸ª errorã€‚\nå®é™…ä¸Šå¯ä»¥æ ¹æ®DBä½¿ç”¨æƒ…å†µå®šæ—¶ forget ä¸€ä¸‹ keyï¼Œè®©æ›´å¤šçš„è¯·æ±‚èƒ½æœ‰æœºä¼šèµ°åˆ°åç»­é€»è¾‘ã€‚\n1 2 3 4 go func() { time.Sleep(100 * time.Millisecond) g.Forget(name) }() æ¯”å¦‚1ç§’å†…æœ‰100ä¸ªè¯·æ±‚è¿‡æ¥ï¼Œæ­£å¸¸æ˜¯ç¬¬ä¸€ä¸ªè¯·æ±‚èƒ½æ‰§è¡Œ GetUserFromDBï¼Œåç»­99ä¸ªéƒ½ä¼šé˜»å¡ã€‚\nå¢åŠ è¿™ä¸ª Forget ä¹‹åï¼Œæ¯ 100ms å°±èƒ½æœ‰ä¸€ä¸ªè¯·æ±‚æ‰§è¡Œ GetUserFromDBï¼Œç›¸å½“äºæ˜¯å¤šäº†å‡ æ¬¡å°è¯•çš„æœºä¼šï¼Œç›¸å¯¹çš„ä¹Ÿç»™DBé€ æˆäº†æ›´å¤§çš„å‹åŠ›ï¼Œéœ€è¦æ ¹æ®å…·ä½“åœºæ™¯è¿›å»å–èˆã€‚\n","date":"2024-07-23T15:49:00+08:00","image":"https://images.hxzhouh.com/blog-images/2024/07/d516998be001327a93e663f8f504840a.png","permalink":"https://huizhou92.com/zh-cn/p/go%E9%AB%98%E6%80%A7%E8%83%BD%E7%BC%96%E7%A8%8B-ep7-%E4%BD%BF%E7%94%A8-singleflight-%E5%90%88%E5%B9%B6%E7%9B%B8%E5%90%8C%E7%9A%84%E8%AF%B7%E6%B1%82/","title":"Goé«˜æ€§èƒ½ç¼–ç¨‹ EP7:  ä½¿ç”¨ SingleFlight åˆå¹¶ç›¸åŒçš„è¯·æ±‚"},{"content":"å½“æˆ‘ä»¬å°è¯•å»ä¼˜åŒ–ä»£ç çš„æ€§èƒ½æ—¶ï¼Œé¦–å…ˆå¾—çŸ¥é“å½“å‰çš„æ€§èƒ½æ€ä¹ˆæ ·ï¼Œå¾—åˆ°ä¸€ä¸ªåŸºå‡†æ€§èƒ½ã€‚Goè¯­è¨€æ ‡å‡†åº“å†…ç½®çš„ testing æµ‹è¯•æ¡†æ¶æä¾›äº†benchmarkçš„èƒ½åŠ›ã€‚æœ¬æ–‡ä¸»è¦ä»‹ç» å¦‚ä½•ä½¿ç”¨benchmark è¿›è¡ŒåŸºå‡†æµ‹è¯•ï¼Œä»¥åŠå¦‚ä½•æé«˜benchmark çš„ç²¾å‡†åº¦ï¼Œæœ€åä»‹ç»äº†ä¸¤ä¸ªå·¥å…·ï¼Œå¸®åŠ©æˆ‘ä»¬æ›´åŠ æ–¹ä¾¿çš„è¿›è¡Œbenchmarkã€‚\nThis article was first published in the Medium MPP plan. If you are a Medium user, please follow me on Medium. Thank you very much.\nç¨³å®šçš„æµ‹è¯•ç¯å¢ƒ æ€§èƒ½æµ‹è¯•å—ç¯å¢ƒçš„å½±å“å¾ˆå¤§ï¼Œä¸ºäº†ä¿è¯æµ‹è¯•çš„å¯é‡å¤æ€§ï¼Œåœ¨è¿›è¡Œæ€§èƒ½æµ‹è¯•æ—¶ï¼Œå°½å¯èƒ½åœ°ä¿æŒæµ‹è¯•ç¯å¢ƒçš„ç¨³å®šã€‚\næœºå™¨å¤„äºé—²ç½®çŠ¶æ€ï¼Œæµ‹è¯•æ—¶ä¸è¦æ‰§è¡Œå…¶ä»–ä»»åŠ¡ï¼Œä¹Ÿä¸è¦å’Œå…¶ä»–äººå…±äº«ç¡¬ä»¶èµ„æºã€‚ æœºå™¨æ˜¯å¦å…³é—­äº†èŠ‚èƒ½æ¨¡å¼ï¼Œä¸€èˆ¬ç¬”è®°æœ¬ä¼šé»˜è®¤æ‰“å¼€è¿™ä¸ªæ¨¡å¼ï¼Œæµ‹è¯•æ—¶å…³é—­ã€‚ é¿å…ä½¿ç”¨è™šæ‹Ÿæœºå’Œäº‘ä¸»æœºè¿›è¡Œæµ‹è¯•ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä¸ºäº†å°½å¯èƒ½åœ°æé«˜èµ„æºçš„åˆ©ç”¨ç‡ï¼Œè™šæ‹Ÿæœºå’Œäº‘ä¸»æœº CPU å’Œå†…å­˜ä¸€èˆ¬ä¼šè¶…å”®ï¼Œè¶…å”®æœºå™¨çš„æ€§èƒ½è¡¨ç°ä¼šéå¸¸åœ°ä¸ç¨³å®šã€‚ ä¸€æ¬¡æµ‹è¯•æ˜¯æ²¡æœ‰æ„ä¹‰çš„ï¼Œç»Ÿè®¡æ„ä¹‰ä¸‹å¯å¯¹æ¯”çš„ç»“æœæ˜¯å…³é”®ï¼Œå¯¹äºä¸€èˆ¬çš„benchmarkï¼Œæˆ‘ä¸€èˆ¬ä¼šé‡å¤æ‰§è¡Œ20æ¬¡ã€‚ benchmark æ˜¯å¦‚ä½•å·¥ä½œçš„ benchmark å…¶å®å°±æ˜¯é‡å¤è°ƒç”¨æŸä¸ªå‡½æ•°ï¼Œç„¶åè®°å½•å‡½æ•°çš„æ‰§è¡Œæ—¶é—´ç­‰æŒ‡æ ‡ï¼Œæ¥åº¦é‡å®ƒçš„æ€§èƒ½ã€‚ä¸€ä¸ªå…¸å‹çš„benchamrk å‡½æ•°å¦‚ä¸‹æ‰€ç¤ºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 func fib(n int) int { if n \u0026lt; 2 { return n } return fib(n-1) + fib(n-2) } func BenchmarkFib20(b *testing.B) { for i := 0; i \u0026lt; b.N; i++ { // Call the function we\u0026#39;re benchmarking fib(20) } } benchmark å‡½æ•°å¿…é¡»ä»¥ Benchmark å¼€å§‹ æˆ‘ä»¬å¯ä»¥è¿™æ ·è¿è¡Œå®ƒ,éƒ½æ˜¯ç­‰æ•ˆçš„ã€‚\n1 2 go test -bench . go test -bench=\u0026#34;BenchmarkFib20\u0026#34; b.N benchmark ç”¨ä¾‹çš„å‚æ•°Â b *testing.Bï¼Œæœ‰ä¸ªå±æ€§Â b.NÂ è¡¨ç¤ºè¿™ä¸ªç”¨ä¾‹éœ€è¦è¿è¡Œçš„æ¬¡æ•°ã€‚b.NÂ å¯¹äºæ¯ä¸ªç”¨ä¾‹éƒ½æ˜¯ä¸ä¸€æ ·çš„ã€‚\né‚£è¿™ä¸ªå€¼æ˜¯å¦‚ä½•å†³å®šçš„å‘¢ï¼Ÿb.NÂ ä» 1 å¼€å§‹ï¼Œå¦‚æœè¯¥ç”¨ä¾‹èƒ½å¤Ÿåœ¨ 1s å†…å®Œæˆï¼Œb.NÂ çš„å€¼ä¾¿ä¼šå¢åŠ ï¼Œå†æ¬¡æ‰§è¡Œã€‚b.NÂ çš„å€¼å¤§æ¦‚ä»¥ 1, 2, 3, 5, 10, 20, 30, 50, 100 è¿™æ ·çš„åºåˆ—é€’å¢ï¼Œè¶Šåˆ°åé¢ï¼Œå¢åŠ å¾—è¶Šå¿«\nè¿›é˜¶å‚æ•° count æ§åˆ¶è¿è¡Œæ¬¡æ•°ï¼Œè€Œä¸å—ç”±b.N æ§åˆ¶ benchtime æ§åˆ¶è¿è¡Œæ—¶é—´ï¼Œè€Œå—1sæ§åˆ¶ benchmem åº¦é‡å†…å­˜åˆ†é…çš„æ¬¡æ•° cpu æŒ‡å®šä½¿ç”¨å‡ ä¸ªCPUæ ¸å¿ƒï¼Œé»˜è®¤ä½¿ç”¨çš„æ˜¯go\nåŒæ—¶ï¼Œbenchmark æµ‹è¯•æ”¯æŒgo test çš„å…¶ä»–å‚æ•°ï¼Œæ¯”å¦‚cpuprofile ã€memprofile ã€trace ç­‰ æå‡å‡†ç¡®åº¦ é™ä½ç³»ç»Ÿå™ªéŸ³:perflock perflockÂ ä½œç”¨æ˜¯é™åˆ¶ CPU æ—¶é’Ÿé¢‘ç‡ï¼Œä»è€Œä¸€å®šç¨‹åº¦ä¸Šæ¶ˆé™¤ç³»ç»Ÿå¯¹æ€§èƒ½æµ‹è¯•ç¨‹åºçš„å½±å“ï¼Œå‡å°‘ç»“æœçš„å™ªå£°ï¼Œè¿›è€Œæ€§èƒ½æµ‹é‡çš„ç»“æœæ–¹å·®æ›´å°ä¹Ÿæ›´åŠ å¯é ã€‚\nResetTimer å¦‚æœåœ¨ benchmark å¼€å§‹å‰ï¼Œéœ€è¦ä¸€äº›å‡†å¤‡å·¥ä½œï¼Œå¦‚æœå‡†å¤‡å·¥ä½œæ¯”è¾ƒè€—æ—¶ï¼Œåˆ™éœ€è¦å°†è¿™éƒ¨åˆ†ä»£ç çš„è€—æ—¶å¿½ç•¥æ‰ã€‚\nStopTimer \u0026amp; StartTimer StopTimer \u0026amp; StartTimer ä¹Ÿæ˜¯ç›¸åŒåŸç†ï¼Œæ¯æ¬¡å‡½æ•°è°ƒç”¨å‰åéœ€è¦ä¸€äº›å‡†å¤‡å·¥ä½œå’Œæ¸…ç†å·¥ä½œï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨Â StopTimerÂ æš‚åœè®¡æ—¶ä»¥åŠä½¿ç”¨Â StartTimerÂ å¼€å§‹è®¡æ—¶ã€‚\nåº¦é‡ benchmark benchstat æ˜¯å®˜æ–¹æä¾›çš„ä¸€ä¸ªå¯¹æ¯”å·¥å…·ï¼Œç”¨äºæ¯”è¾ƒä¸¤æ¬¡benchmarkä¹‹é—´çš„æ€§èƒ½å·®åˆ«\nBenchstat computes statistical summaries and A/B comparisons of Go benchmarks.\næˆ‘ä»¬ç”¨benchstatå¯¹æ¯”ä¸€ä¸‹ bubbleSort è·ŸquickSort çš„æ€§èƒ½\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 func softNums() { //bubbleSort(nums) //quickSort(nums) } func initNums(count int) { rand.Seed(time.Now().UnixNano()) nums = make([]int, count) for i := 0; i \u0026lt; count; i++ { nums[i] = rand.Intn(count) } } func BenchmarkSoftNums(b *testing.B) { initNums(10000) b.ResetTimer() for i := 0; i \u0026lt; b.N; i++ { softNums() } } 1 2 3 4 5 6 7 8 9 10 go test -bench=\u0026#34;BenchmarkSoftNums\u0026#34; -count=10 |tee quicksoft.txt go test -bench=\u0026#34;BenchmarkSoftNums\u0026#34; -count=10 |tee bubblesoft.txt âœ benchmark git:(main) âœ— benchstat bubblesoft.txt quicksoft.txt goos: darwin goarch: arm64 pkg: blog-example/go/benchmark â”‚ bubblesoft.txt â”‚ quicksoft.txt â”‚ â”‚ sec/op â”‚ sec/op vs base â”‚ SoftNums-10 31942.4Âµ Â± 1% 775.8Âµ Â± 2% -97.57% (p=0.000 n=10) è¿™æ ·çš„ç»“æœæ˜¯ä¸æ˜¯å¾ˆæ¸…æ™°ï¼Ÿæˆ‘ä»¬å¯ä»¥æŠŠä»–æ”¾åœ¨æŠ¥å‘Šæˆ–è€…github issue ä¸­ï¼Œå¾ˆä¸“ä¸šã€‚\nä¸€äº›ç¬¬ä¸‰æ–¹çš„å·¥å…· bench bench æ˜¯ä¸€ä¸ªä¸º Go ç¨‹åºæä¾›é›†æˆæ€§èƒ½æµ‹é‡ã€è‡ªåŠ¨æ€§èƒ½é”å®šã€ç»Ÿè®¡åˆ†æå’Œé¢œè‰²æŒ‡ç¤ºçš„åŸºå‡†æµ‹è¯•å·¥å…·ã€‚\nfuncbench funcbench æ˜¯ Prometheus é¡¹ç›®ä¸­ç”¨äºè‡ªåŠ¨åŒ– Go ä»£ç åŸºå‡†æµ‹è¯•å’Œæ€§èƒ½æ¯”è¾ƒçš„å·¥å…·ã€‚ä»¥ä¸‹æ˜¯å…¶ä¸»è¦ç‰¹ç‚¹å’ŒåŠŸèƒ½ï¼š\næ”¯æŒæ¯”è¾ƒæœ¬åœ°åˆ†æ”¯ä¸GitHub åˆ†æ”¯ã€æ€§èƒ½é”å®šã€æ€§èƒ½æ¯”è¾ƒ ç­‰ç‰¹ç‚¹ï¼Œæœ‰åˆ©äºæé«˜å¼€å‘æ•ˆç‡ã€‚å¦‚æœé¡¹ç›®æ¯”è¾ƒå¤§ï¼Œå¯ä»¥å‚è€ƒè¿™ç§æ–¹å¼ã€‚\nå‚è€ƒèµ„æ–™ https://dave.cheney.net/high-performance-go-workshop/gophercon-2019.html#welcome https://golang.design/under-the-hood/zh-cn/part3tools/ch09analysis/perf/ ","date":"2024-07-12T15:05:32+08:00","image":"https://images.hxzhouh.com/blog-images/2024/07/7c30776c74ed13c1b32cfd9ed3690a56.png","permalink":"https://huizhou92.com/zh-cn/p/go%E9%AB%98%E6%80%A7%E8%83%BD%E7%BC%96%E7%A8%8B-ep5-%E6%9B%B4%E7%B2%BE%E5%87%86%E7%9A%84benchmark/","title":"Goé«˜æ€§èƒ½ç¼–ç¨‹ EP5: æ›´ç²¾å‡†çš„benchmark"},{"content":"reflectÂ ä¸º Go è¯­è¨€æä¾›äº†è¿è¡Œæ—¶åŠ¨æ€è·å–å¯¹è±¡çš„ç±»å‹å’Œå€¼ä»¥åŠåŠ¨æ€åˆ›å»ºå¯¹è±¡çš„èƒ½åŠ›ã€‚åå°„å¯ä»¥å¸®åŠ©æŠ½è±¡å’Œç®€åŒ–ä»£ç ï¼Œæé«˜å¼€å‘æ•ˆç‡ã€‚Go è¯­è¨€æ ‡å‡†åº“ä»¥åŠå¾ˆå¤šå¼€æºè½¯ä»¶ä¸­éƒ½ä½¿ç”¨äº† Go è¯­è¨€çš„åå°„èƒ½åŠ›ï¼Œä¾‹å¦‚ç”¨äºåºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„Â jsonã€ORM æ¡†æ¶Â gorm/xormÂ ç­‰ã€‚æœ¬æ–‡çš„ç›®æ ‡æ˜¯å­¦ä¹ reflectï¼Œä»¥åŠå¦‚ä½•æé«˜reflectçš„æ€§èƒ½ã€‚\nThis article was first published in the Medium MPP plan. If you are a Medium user, please follow me on Medium. Thank you very much.\nExample Code å¦‚ä½•ä½¿ç”¨åå°„ç®€åŒ–ä»£ç  æˆ‘ä»¬åˆ©ç”¨åå°„å®ç°ä¸€ä¸ªç®€å•çš„åŠŸèƒ½ï¼Œæ¥çœ‹çœ‹åå°„å¦‚ä½•å¸®åŠ©æˆ‘ä»¬ç®€åŒ–ä»£ç çš„ã€‚\nå‡è®¾æœ‰ä¸€ä¸ªé…ç½®ç±» Configï¼Œæ¯ä¸ªå­—æ®µæ˜¯ä¸€ä¸ªé…ç½®é¡¹ã€‚æˆ‘ä»¬éœ€è¦ä»ç¯å¢ƒå˜é‡ä¸­ è¯»å– CONFIG_xxxx ã€‚ç„¶ååˆå§‹åŒ–Configã€‚\nlist 1 ï¼šMySQL config\n1 2 3 4 5 6 7 8 9 // https://github.com/go-sql-driver/mysql/blob/v1.8.1/dsn.go#L37 type Config struct { User string `json:\u0026#34;user\u0026#34;` // Username Passwd string `json:\u0026#34;passwd\u0026#34;` // Password (requires User) Net string `json:\u0026#34;net\u0026#34;` // Network (e.g. \u0026#34;tcp\u0026#34;, \u0026#34;tcp6\u0026#34;, \u0026#34;unix\u0026#34;. default: \u0026#34;tcp\u0026#34;) Addr string `json:\u0026#34;addr\u0026#34;` // Address (default: \u0026#34;127.0.0.1:3306\u0026#34; for \u0026#34;tcp\u0026#34; and \u0026#34;/tmp/mysql.sock\u0026#34; for \u0026#34;unix\u0026#34;) DBName string `json:\u0026#34;db_name\u0026#34;` // Database name // ã€‚ã€‚ã€‚ã€‚ã€‚ } Footguns æˆ‘ä»¬å¾ˆå®¹æ˜“å†™å‡ºè¿™æ ·çš„ä»£ç ï¼Œ\nlist2: ä½¿ç”¨ for å¾ªç¯åˆå§‹åŒ– Config\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 func InitConfig() *Config { cfg := \u0026amp;Config{} keys := []string{\u0026#34;CONFIG_MYSQL_USER\u0026#34;, \u0026#34;CONFIG_MYSQL_PASSWD\u0026#34;, \u0026#34;CONFIG_MYSQL_NET\u0026#34;, \u0026#34;CONFIG_MYSQL_ADDR\u0026#34;, \u0026#34;CONFIG_MYSQL_DB_NAME\u0026#34;} for _, key := range keys { if env, exist := os.LookupEnv(key); exist { switch key { case \u0026#34;CONFIG_MYSQL_USER\u0026#34;: cfg.User = env case \u0026#34;CONFIG_MYSQL_PASSWORD\u0026#34;: cfg.Passwd = env case \u0026#34;CONFIG_MYSQL_NET\u0026#34;: cfg.Net = env case \u0026#34;CONFIG_MYSQL_ADDR\u0026#34;: cfg.Addr = env case \u0026#34;CONFIG_MYSQL_DB_NAME\u0026#34;: cfg.DBName = env } } } return cfg } ä½†æ˜¯ä½¿ç”¨ç¡¬ç¼–ç çš„è¯ï¼Œå¦‚æœConfigÂ ç»“æ„å‘ç”Ÿæ”¹å˜ï¼Œæ¯”å¦‚äº†ä¿®æ”¹Â jsonÂ å¯¹åº”çš„å­—æ®µã€åˆ é™¤æˆ–æ–°å¢äº†ä¸€ä¸ªé…ç½®é¡¹ç­‰ï¼Œè¿™å—çš„é€»è¾‘ä¹Ÿéœ€è¦å‘ç”Ÿæ”¹å˜ã€‚è€Œæ›´å¤§çš„é—®é¢˜åœ¨äºï¼šéå¸¸å®¹æ˜“å‡ºé”™ï¼Œä¸å¥½æµ‹è¯•ã€‚\nå¦‚æœæˆ‘ä»¬æ”¹æˆä½¿ç”¨ åå°„å®ç°ï¼Œå®ç°çš„ä»£ç å°±æ˜¯è¿™æ ·çš„:\nlist3: ä½¿ç”¨reflect å®ç°åˆå§‹åŒ–Config\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 func InitConfig2() *Config { config := Config{} typ := reflect.TypeOf(config) value := reflect.Indirect(reflect.ValueOf(\u0026amp;config)) for i := 0; i \u0026lt; typ.NumField(); i++ { f := typ.Field(i) if v, ok := f.Tag.Lookup(\u0026#34;json\u0026#34;); ok { key := fmt.Sprintf(\u0026#34;CONFIG_MYSQL_%s\u0026#34;, strings.ToUpper(v)) if env, exist := os.LookupEnv(key); exist { value.FieldByName(f.Name).Set(reflect.ValueOf(env)) } } } return \u0026amp;config } å®ç°é€»è¾‘å…¶å®æ˜¯éå¸¸ç®€å•çš„ï¼š\nåœ¨è¿è¡Œæ—¶ï¼Œåˆ©ç”¨åå°„è·å–åˆ°Â ConfigÂ çš„æ¯ä¸ªå­—æ®µçš„Â TagÂ å±æ€§ï¼Œæ‹¼æ¥å‡ºå¯¹åº”çš„ç¯å¢ƒå˜é‡çš„åç§°ã€‚ æŸ¥çœ‹è¯¥ç¯å¢ƒå˜é‡æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨å°±å°†ç¯å¢ƒå˜é‡çš„å€¼èµ‹å€¼ç»™è¯¥å­—æ®µã€‚\nè¿™æ ·ï¼Œæ— è®ºConfig æ·»åŠ è¿˜æ˜¯åˆ é™¤å­—æ®µï¼ŒInitConfig å‡½æ•°éƒ½ä¸éœ€è¦ä¿®æ”¹ï¼Œæ˜¯ä¸æ˜¯æ¯”ä½¿ç”¨forå¾ªç¯çš„æ–¹å¼ç®€æ´å¤šäº†ï¼Ÿ åå°„çš„æ€§èƒ½ æˆ‘ä»¬åœ¨å¾ˆå¤šåœ°æ–¹éƒ½å¬è¯´è¿‡:åå°„çš„æ€§èƒ½å¾ˆå·®ï¼Œå¹¶ä¸”æˆ‘ä»¬åœ¨å¯¹æ¯”jsonè§£æåº“çš„æ—¶å€™ä¹ŸéªŒè¯äº†å®˜æ–¹åº“JSON Unmarshal çš„æ€§èƒ½æ¯”è¾ƒä½.å› ä¸ºä»–éœ€è¦æ‰§è¡Œæ›´å¤šçš„æŒ‡ä»¤ã€‚é‚£ä¹ˆåå°„çš„æ€§èƒ½åˆ°åº•æœ‰å¤šå·®å‘¢ï¼Ÿ æˆ‘ä»¬åšä¸€æ¬¡benchmarkå°±çŸ¥é“äº†ã€‚\nlist 4 : benchmark test New And Reflect Performance\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 func BenchmarkNew(b *testing.B) { var config *Config for i := 0; i \u0026lt; b.N; i++ { config = new(Config) } _ = config } func BenchmarkReflectNew(b *testing.B) { var config *Config typ := reflect.TypeOf(Config{}) b.ResetTimer() for i := 0; i \u0026lt; b.N; i++ { config, _ = reflect.New(typ).Interface().(*Config) } _ = config } ---- âœ go_reflect git:(main) âœ— go test --bench . goos: darwin goarch: arm64 pkg: blog-example/go/go_reflect BenchmarkNew-10 47675076 25.40 ns/op BenchmarkReflectNew-10 36163776 32.51 ns/op PASS ok blog-example/go/go_reflect 3.895s å¦‚æœåªæ˜¯åˆ›å»ºçš„åœºæ™¯ï¼Œä¸¤è€…çš„æ€§èƒ½å·®è·ä¸æ˜¯ç‰¹åˆ«å¤§ã€‚\næˆ‘ä»¬å†æµ‹è¯•ä¸€ä¸‹ä¿®æ”¹å­—æ®µåœºæ™¯ï¼Œé€šè¿‡åå°„ä¿®æ”¹å­—æ®µæœ‰ä¸¤ç§æ–¹å¼\nFieldByName\nField ä¸‹æ ‡æ¨¡å¼\næˆ‘ä»¬åˆ†åˆ«æµ‹è¯•ä¸¤ç§æ¨¡å¼çš„æ€§èƒ½\nlist5: æµ‹è¯•ä¿®æ”¹Field çš„æ€§èƒ½\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 func BenchmarkFieldSet(b *testing.B) { config := new(Config) b.ResetTimer() for i := 0; i \u0026lt; b.N; i++ { config.Net = \u0026#34;tcp4\u0026#34; config.Addr = \u0026#34;127.0.0.1:3306\u0026#34; config.Passwd = \u0026#34;123456\u0026#34; config.User = \u0026#34;admin\u0026#34; } } func BenchmarkFieldSetFieldByName(b *testing.B) { config := new(Config) value := reflect.ValueOf(config).Elem() b.ResetTimer() for i := 0; i \u0026lt; b.N; i++ { value.FieldByName(\u0026#34;Net\u0026#34;).SetString(\u0026#34;tcp4\u0026#34;) value.FieldByName(\u0026#34;Addr\u0026#34;).SetString(\u0026#34;127.0.0.1:3306\u0026#34;) value.FieldByName(\u0026#34;Passwd\u0026#34;).SetString(\u0026#34;123456\u0026#34;) value.FieldByName(\u0026#34;User\u0026#34;).SetString(\u0026#34;admin\u0026#34;) } } func BenchmarkFieldSetField(b *testing.B) { config := new(Config) value := reflect.Indirect(reflect.ValueOf(config)) b.ResetTimer() for i := 0; i \u0026lt; b.N; i++ { value.Field(0).SetString(\u0026#34;tcp4\u0026#34;) value.Field(1).SetString(\u0026#34;127.0.0.1:3306\u0026#34;) value.Field(2).SetString(\u0026#34;123456\u0026#34;) value.Field(3).SetString(\u0026#34;admin\u0026#34;) } } ---- âœ go_reflect git:(main) âœ— go test --bench=\u0026#34;BenchmarkFieldSet*\u0026#34; goos: darwin goarch: arm64 pkg: blog-example/go/go_reflect BenchmarkFieldSet-10 1000000000 0.3282 ns/op BenchmarkFieldSetFieldByName-10 6471114 185.3 ns/op BenchmarkFieldSetField-10 100000000 11.88 ns/op PASS ok blog-example/go/go_reflect 3.910s å·®è·å¾ˆå¤§ï¼Œéreflect æ–¹å¼è·Ÿ reflect Field ä¸‹æ ‡æ¨¡å¼ ï¼Œå·®ä¸¤ä¸ªæ•°é‡çº§ï¼Œè·Ÿreflect FieldByName æ¨¡å¼ ç”šè‡³è¾¾åˆ°äº†ä¸‰ä¸ªæ•°é‡çº§ï¼Œæ¯”è¾ƒç–‘é—®çš„ä¸€ä¸ªç‚¹æ˜¯FieldByName æ¨¡å¼ è·Ÿ Field ä¸‹æ ‡æ¨¡å¼ å·®è·ç«Ÿç„¶ä¹Ÿæœ‰ä¸€ä¸ªæ•°é‡çº§ã€‚ä¸è¿‡æˆ‘ä»¬èƒ½å¤Ÿä»æºç ä¸­æ‰¾åˆ°ç­”æ¡ˆã€‚\nlist 6: reflect/value.go\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 func (v Value) FieldByName(name string) Value { v.mustBe(Struct) if f, ok := toRType(v.typ()).FieldByName(name); ok { return v.FieldByIndex(f.Index) } return Value{} } // FieldByIndex returns the nested field corresponding to index.// It panics if evaluation requires stepping through a nil // pointer or a field that is not a struct. func (v Value) FieldByIndex(index []int) Value { if len(index) == 1 { return v.Field(index[0]) } v.mustBe(Struct) for i, x := range index { if i \u0026gt; 0 { if v.Kind() == Pointer \u0026amp;\u0026amp; v.typ().Elem().Kind() == abi.Struct { if v.IsNil() { panic(\u0026#34;reflect: indirection through nil pointer to embedded struct\u0026#34;) } v = v.Elem() } } v = v.Field(x) } return v } list 7ï¼šreflect/type.go\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 func (t *rtype) FieldByName(name string) (StructField, bool) { if t.Kind() != Struct { panic(\u0026#34;reflect: FieldByName of non-struct type \u0026#34; + t.String()) } tt := (*structType)(unsafe.Pointer(t)) return tt.FieldByName(name) } // FieldByName returns the struct field with the given name// and a boolean to indicate if the field was found. func (t *structType) FieldByName(name string) (f StructField, present bool) { // Quick check for top-level name, or struct without embedded fields. hasEmbeds := false if name != \u0026#34;\u0026#34; { for i := range t.Fields { tf := \u0026amp;t.Fields[i] if tf.Name.Name() == name { return t.Field(i), true } if tf.Embedded() { hasEmbeds = true } } } if !hasEmbeds { return } return t.FieldByNameFunc(func(s string) bool { return s == name }) } åœ¨åå°„çš„å†…éƒ¨ï¼Œå­—æ®µæ˜¯æŒ‰é¡ºåºå­˜å‚¨çš„ï¼Œå› æ­¤æŒ‰ç…§ä¸‹æ ‡è®¿é—®æŸ¥è¯¢æ•ˆç‡ä¸º O(1)ï¼Œè€ŒæŒ‰ç…§Â NameÂ è®¿é—®ï¼Œåˆ™éœ€è¦éå†æ‰€æœ‰å­—æ®µï¼ŒæŸ¥è¯¢æ•ˆç‡ä¸º O(N)ã€‚ç»“æ„ä½“æ‰€åŒ…å«çš„å­—æ®µ(åŒ…æ‹¬æ–¹æ³•)è¶Šå¤šï¼Œé‚£ä¹ˆä¸¤è€…ä¹‹é—´çš„æ•ˆç‡å·®è·åˆ™è¶Šå¤§ã€‚ä½†æ˜¯æˆ‘ä»¬éœ€è¦è®°å¿†å­—æ®µçš„é¡ºåºï¼Œè¿™å¾ˆå®¹æ˜“å‡ºé”™ã€‚\nå¦‚ä½•æé«˜æ€§èƒ½ å°½é‡é¿å…ä½¿ç”¨reflect ä½¿ç”¨åå°„èµ‹å€¼ï¼Œæ•ˆç‡éå¸¸ä½ä¸‹ï¼Œå¦‚æœæœ‰æ›¿ä»£æ–¹æ¡ˆï¼Œå°½å¯èƒ½é¿å…ä½¿ç”¨åå°„ï¼Œç‰¹åˆ«æ˜¯ä¼šè¢«åå¤è°ƒç”¨çš„çƒ­ç‚¹ä»£ç ã€‚ä¾‹å¦‚ RPC åè®®ä¸­ï¼Œéœ€è¦å¯¹ç»“æ„ä½“è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼Œè¿™ä¸ªæ—¶å€™é¿å…ä½¿ç”¨ Go è¯­è¨€è‡ªå¸¦çš„Â jsonÂ çš„Â MarshalÂ å’ŒÂ UnmarshalÂ æ–¹æ³•ï¼Œå› ä¸ºæ ‡å‡†åº“ä¸­çš„ json åºåˆ—åŒ–å’Œååºåˆ—åŒ–æ˜¯åˆ©ç”¨åå°„å®ç°çš„ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨fastjsonç­‰æ›¿ä»£æ ‡å‡†åº“ï¼Œåº”è¯¥èƒ½å¸¦æ¥åå€å·¦å³çš„æå‡ã€‚\nå°½é‡ä½¿ç”¨ Field ä¸‹æ ‡æ¨¡å¼ ä»å‰é¢çš„benchmark çœ‹æ¥ï¼Œ Field ä¸‹æ ‡æ¨¡å¼æ¯”FieldByName çš„æ–¹å¼å¿«æ¥è¿‘ä¸€ä¸ªæ•°é‡çº§ï¼Œåœ¨å­—æ®µæ•°é‡å¤šçš„æ—¶å€™ï¼Œæ›´åŠ æ˜æ˜¾ï¼Œä½†æ˜¯ä½¿ç”¨Field ä¸‹æ ‡æ¨¡å¼ä¼šæ¯”è¾ƒéº»çƒ¦ï¼Œæˆ‘ä»¬éœ€è¦è®°å¿†ä¸‹æ ‡ï¼Œå¹¶ä¸”å¾ˆéš¾ä¿®æ”¹ã€‚è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸€ä¸ªMap å°†Name è·Ÿä¸‹æ ‡ç¼“å­˜èµ·æ¥ã€‚\næ¯”å¦‚ï¼š\nlist8: cache FieldByName and Field index\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 func BenchmarkFieldSetFieldByNameCache(b *testing.B) { config := new(Config) typ := reflect.TypeOf(Config{}) value := reflect.ValueOf(config).Elem() cache := make(map[string]int) for i := 0; i \u0026lt; typ.NumField(); i++ { cache[typ.Field(i).Name] = i } b.ResetTimer() for i := 0; i \u0026lt; b.N; i++ { value.Field(cache[\u0026#34;Net\u0026#34;]).SetString(\u0026#34;tcp4\u0026#34;) value.Field(cache[\u0026#34;Addr\u0026#34;]).SetString(\u0026#34;127.0.0.1:3306\u0026#34;) value.Field(cache[\u0026#34;Passwd\u0026#34;]).SetString(\u0026#34;123456\u0026#34;) value.Field(cache[\u0026#34;User\u0026#34;]).SetString(\u0026#34;admin\u0026#34;) } } ---- BenchmarkFieldSetFieldByNameCache-10 32121740 36.85 ns/op æ¯”ç›´æ¥ä½¿ç”¨FieldByName æå‡äº†4å€ï¼Œå¾ˆå¯è§‚çš„æå‡ã€‚\næ€»ç»“ æœ¬æ–‡æ²¡æœ‰æ·±å…¥ä»‹ç» reflect çš„ç»†èŠ‚ï¼Œå¦‚æœæ‚¨æƒ³è¦è¿›ä¸€æ­¥å­¦ä¹ reflect å¯ä»¥å‚è€ƒä¸‹é¢çš„æ–‡ç« ï¼š https://medium.com/capital-one-tech/learning-to-use-go-reflection-822a0aed74b7 https://go101.org/article/reflection.html åœ¨å„ä¸ªåŸºç¡€åº“ä¸­ï¼Œå¤§é‡ä½¿ç”¨reflect ï¼Œåˆç†çš„ä½¿ç”¨reflect æœ‰åŠ©äºç®€åŒ–ä»£ç ï¼Œä½†æ˜¯reflect æœ‰æ€§èƒ½æŸè€—ï¼Œæœ€æç«¯çš„æƒ…å†µå¯èƒ½é™ä½3ä¸ªæ•°é‡çº§ã€‚ å¯ä»¥ç”¨ Field index + cache çš„æ–¹å¼æ¥ä¼˜åŒ– æ€§èƒ½ã€‚\nå¯¹äºreflect æ‚¨æœ‰ä»€ä¹ˆå…¶ä»–æƒ³æ³•å˜›ï¼Ÿç•™è¨€è·Ÿæˆ‘ä¸€èµ·è®¨è®ºã€‚ ","date":"2024-07-09T09:44:18+08:00","image":"https://images.hxzhouh.com/blog-images/2024/07/fafe2d9c964dbdd44c76d86834fd745b.png","permalink":"https://huizhou92.com/zh-cn/p/go%E9%AB%98%E6%80%A7%E8%83%BD%E7%BC%96%E7%A8%8B-ep4-%E5%8F%8D%E5%B0%84/","title":"Goé«˜æ€§èƒ½ç¼–ç¨‹ EP4: åå°„"},{"content":"Golangæœ€å¤§çš„ä½¿å‘½å°±æ˜¯ç®€åŒ–å¼‚æ­¥ç¼–ç¨‹ï¼Œå½“æˆ‘ä»¬é‡åˆ°é‚£ç§éœ€è¦æ‰¹é‡å¤„ç†ä¸”è€—æ—¶çš„æ“ä½œæ—¶ï¼Œä¼ ç»Ÿçš„å•çº¿ç¨‹æ‰§è¡Œå°±æ˜¾å¾—åƒåŠ›ï¼Œè¿™æ—¶å°±ä¼šæƒ³åˆ°å¼‚æ­¥å¹¶è¡Œå¤„ç†ã€‚æœ¬ç¯‡æ–‡ç« ä»‹ç»ä¸€äº›Golangå¼‚æ­¥ç¼–ç¨‹çš„æŠ€å·§ã€‚\nThis article was first published in the Medium MPP plan. If you are a Medium user, please follow me on Medium. Thank you very much.\né¦–å…ˆä»‹ç»ä¸€ä¸ªç®€åŒ–å¹¶å‘ç¼–ç¨‹çš„çš„åº“conc é‡Œé¢å°è£…äº†å¾ˆå¤šå®ç”¨çš„å·¥å…·ï¼Œæ¯”å¦‚WaitGroupï¼Œiter.Mapç­‰ã€‚æˆ‘ä»¬å¹¶ä¸ä¸€å®šè¦åœ¨ç”Ÿäº§ä»£ç ä¸­ä½¿ç”¨concï¼Œä½†æ˜¯å­¦ä¹ ä»–çš„ä¸€äº›æ€è·¯è¿˜æ˜¯å¯ä»¥çš„ã€‚\nä½¿ç”¨æ–¹å¼ go æœ€ç®€å•çš„æœ€å¸¸ç”¨çš„æ–¹å¼ï¼šä½¿ç”¨goå…³é”®è¯\n1 2 3 4 5 6 7 8 funcÂ main()Â { goÂ func()Â { fmt.Println(\u0026#34;helloÂ world1\u0026#34;) }() goÂ func()Â { fmt.Println(\u0026#34;helloÂ world2\u0026#34;) }() } æˆ–è€…ï¼š\n1 2 3 4 5 6 7 funcÂ main()Â { goÂ Announce(\u0026#34;helloÂ world1\u0026#34;) goÂ Announce(\u0026#34;helloÂ world2\u0026#34;) } funcÂ Announce(messageÂ string)Â { fmt.Println(message) } ä½¿ç”¨åŒ¿åå‡½æ•°ä¼ é€’å‚æ•°\n1 2 3 4 5 dataÂ :=Â \u0026#34;Hello,Â World!\u0026#34; goÂ func(msgÂ string)Â { // Use msg to perform asynchronous task logic processing fmt.Println(msg) }(data) è¿™ç§æ–¹å¼ä¸éœ€è¦è€ƒè™‘è¿”å›å€¼é—®é¢˜ï¼Œå¦‚æœè¦è€ƒè™‘è¿”å›å€¼ï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„æ–¹å¼ã€‚\né€šè¿‡goroutineå’Œchannelæ¥å®ç°è¶…æ—¶æ§åˆ¶ 1 2 3 4 5 6 7 8 9 10 11 12 13 ch := make(chan int, 1) timer := time.NewTimer(time.Second) go func() { time.Sleep(2 * time.Second) ch \u0026lt;- 1 close(ch) }() select { case \u0026lt;-timer.C: fmt.Println(\u0026#34;timeout\u0026#34;) case result := \u0026lt;-ch: fmt.Println(result) } ä½¿ç”¨sync.WaitGroup sync.WaitGroupç”¨äºç­‰å¾…ä¸€ç»„åç¨‹å®Œæˆå…¶ä»»åŠ¡ã€‚é€šè¿‡Add()æ–¹æ³•å¢åŠ ç­‰å¾…çš„åç¨‹æ•°é‡ï¼ŒDone()æ–¹æ³•æ ‡è®°åç¨‹å®Œæˆï¼ŒWait()æ–¹æ³•é˜»å¡ç›´åˆ°æ‰€æœ‰åç¨‹å®Œæˆã€‚\n1 2 3 4 5 6 7 8 9 10 11 var wg sync.WaitGroup // å¯åŠ¨å¤šä¸ªåç¨‹ for i := 0; i \u0026lt; 5; i++ { wg.Add(1) go func(index int) { defer wg.Done() // å¼‚æ­¥ä»»åŠ¡é€»è¾‘ }(i) } wg.Wait() } 1.4ã€ä½¿ç”¨errgroupå®ç°goroutine groupçš„é”™è¯¯å¤„ç† å¦‚æœæƒ³ç®€å•è·å–åç¨‹è¿”å›çš„é”™è¯¯ï¼ŒerrgroupåŒ…å¾ˆé€‚åˆï¼ŒerrgroupåŒ…æ˜¯Goè¯­è¨€æ ‡å‡†åº“ä¸­çš„ä¸€ä¸ªå®ç”¨å·¥å…·ï¼Œç”¨äºç®¡ç†ä¸€ç»„åç¨‹å¹¶å¤„ç†å®ƒä»¬çš„é”™è¯¯ã€‚å¯ä»¥ä½¿ç”¨errgroup.Groupç»“æ„æ¥è·Ÿè¸ªå’Œå¤„ç†åç¨‹ç»„çš„é”™è¯¯ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 varÂ egÂ errgroup.Group forÂ iÂ :=Â 0;Â iÂ \u0026lt;Â 5;Â i++Â { eg.Go(func()Â errorÂ { returnÂ errors.New(\u0026#34;error\u0026#34;) }) eg.Go(func()Â errorÂ { returnÂ nil }) } ifÂ errÂ :=Â eg.Wait();Â errÂ !=Â nilÂ { //Â å¤„ç†é”™è¯¯ } ä¸€äº›ä½¿ç”¨æŠ€å·§ ä½¿ç”¨channelçš„rangeå’Œcloseæ“ä½œ rangeæ“ä½œå¯ä»¥åœ¨æ¥æ”¶é€šé“ä¸Šè¿­ä»£å€¼ï¼Œç›´åˆ°é€šé“å…³é—­ã€‚å¯ä»¥ä½¿ç”¨closeå‡½æ•°å…³é—­é€šé“ï¼Œä»¥å‘æ¥æ”¶æ–¹æŒ‡ç¤ºæ²¡æœ‰æ›´å¤šçš„å€¼ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 chÂ :=Â make(chanÂ int) goÂ func()Â { forÂ iÂ :=Â 0;Â iÂ \u0026lt;Â 5;Â i++Â { chÂ \u0026lt;-Â iÂ //Â å‘é€å€¼åˆ°é€šé“ } close(ch)Â //Â å…³é—­é€šé“ }() //Â ä½¿ç”¨rangeè¿­ä»£æ¥æ”¶é€šé“çš„å€¼ forÂ valÂ :=Â rangeÂ chÂ { //Â å¤„ç†æ¥æ”¶åˆ°çš„å€¼ } // do somethings ä½¿ç”¨selectè¯­å¥å®ç°å¤šä¸ªå¼‚æ­¥æ“ä½œçš„ç­‰å¾… 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 ch1Â :=Â make(chanÂ int) ch2Â :=Â make(chanÂ string) goÂ func()Â { //Â å¼‚æ­¥ä»»åŠ¡1é€»è¾‘ ch1Â \u0026lt;-Â result1 }() goÂ func()Â { //Â å¼‚æ­¥ä»»åŠ¡2é€»è¾‘ ch2Â \u0026lt;-Â result2 }() //Â åœ¨ä¸»goroutineä¸­ç­‰å¾…å¤šä¸ªå¼‚æ­¥ä»»åŠ¡å®Œæˆ selectÂ { caseÂ res1Â :=Â \u0026lt;-ch1: //Â å¤„ç†ç»“æœ1 caseÂ res2Â :=Â \u0026lt;-ch2: //Â å¤„ç†ç»“æœ2 } ä½¿ç”¨selectå’Œtime.After()å®ç°è¶…æ—¶æ§åˆ¶ å¦‚æœéœ€è¦åœ¨å¼‚æ­¥æ“ä½œä¸­è®¾ç½®è¶…æ—¶ï¼Œå¯ä»¥ä½¿ç”¨selectè¯­å¥ç»“åˆtime.After()å‡½æ•°å®ç°ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 chÂ :=Â make(chanÂ int) goÂ func()Â { //Â å¼‚æ­¥ä»»åŠ¡é€»è¾‘ time.Sleep(2Â *Â time.Second) chÂ \u0026lt;-Â result }() //Â è®¾ç½®è¶…æ—¶æ—¶é—´ selectÂ { caseÂ resÂ :=Â \u0026lt;-ch: //Â å¤„ç†ç»“æœ caseÂ \u0026lt;-time.After(3Â *Â time.Second): //Â è¶…æ—¶å¤„ç† } ä½¿ç”¨time.Tick()å’Œtime.After()è¿›è¡Œå®šæ—¶æ“ä½œ time.Tick()å‡½æ•°è¿”å›ä¸€ä¸ªé€šé“ï¼Œå®šæœŸå‘é€æ—¶é—´å€¼ï¼Œå¯ä»¥ç”¨äºæ‰§è¡Œå®šæ—¶æ“ä½œã€‚time.After()å‡½æ•°è¿”å›ä¸€ä¸ªé€šé“ï¼Œåœ¨æŒ‡å®šçš„æ—¶é—´åå‘é€ä¸€ä¸ªæ—¶é—´å€¼ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 tickÂ :=Â time.Tick(1Â *Â time.Second)Â //Â æ¯ç§’æ‰§è¡Œä¸€æ¬¡æ“ä½œ forÂ { selectÂ { caseÂ \u0026lt;-tick: //Â æ‰§è¡Œå®šæ—¶æ“ä½œ } } selectÂ { caseÂ \u0026lt;-time.After(5Â *Â time.Second): //Â åœ¨5ç§’åæ‰§è¡Œæ“ä½œ } ä½¿ç”¨sync.Mutexæˆ–sync.RWMutexè¿›è¡Œå¹¶å‘å®‰å…¨è®¿é—® å½“å¤šä¸ªåç¨‹å¹¶å‘è®¿é—®å…±äº«æ•°æ®æ—¶ï¼Œéœ€è¦ç¡®ä¿æ•°æ®è®¿é—®çš„å®‰å…¨æ€§ã€‚sync.Mutexå’Œsync.RWMutexæä¾›äº†äº’æ–¥é”å’Œè¯»å†™é”ï¼Œç”¨äºåœ¨è®¿é—®å…±äº«èµ„æºä¹‹å‰è¿›è¡Œé”å®šï¼Œä»¥é¿å…æ•°æ®ç«äº‰ã€‚sync.RWMutexæ˜¯ä¸€ç§è¯»å†™é”ï¼Œå¯ä»¥åœ¨å¤šä¸ªåç¨‹ä¹‹é—´æä¾›å¯¹å…±äº«èµ„æºçš„å¹¶å‘è®¿é—®æ§åˆ¶ã€‚å¤šä¸ªåç¨‹å¯ä»¥åŒæ—¶è·å–è¯»é”ï¼Œä½†åªæœ‰ä¸€ä¸ªåç¨‹å¯ä»¥è·å–å†™é”ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 varÂ mutexÂ sync.Mutex varÂ dataÂ int //Â å†™æ“ä½œï¼Œä½¿ç”¨äº’æ–¥é”ä¿æŠ¤æ•°æ® mutex.Lock() dataÂ =Â 123 mutex.Unlock() //Â è¯»æ“ä½œï¼Œä½¿ç”¨è¯»é”ä¿æŠ¤æ•°æ® //RLock()åŠ è¯»é”æ—¶ï¼Œå¦‚æœå­˜åœ¨å†™é”ï¼Œåˆ™æ— æ³•åŠ è¯»é”ï¼›å½“åªæœ‰è¯»é”æˆ–è€…æ²¡æœ‰é”æ—¶ï¼Œå¯ä»¥åŠ è¯»é”ï¼Œè¯»é”å¯ä»¥åŠ è½½å¤šä¸ª mutex.RLock() valueÂ :=Â data mutex.RUnlock() varÂ rwMutexÂ sync.RWMutex varÂ sharedDataÂ map[string]string //Â è¯»æ“ä½œï¼Œä½¿ç”¨rwMutex.RLockè¯»é”ä¿æŠ¤æ•°æ® funcÂ readData(keyÂ string)Â stringÂ { rwMutex.RLock() deferÂ rwMutex.RUnlock() returnÂ sharedData[key] } //Â å†™æ“ä½œï¼Œä½¿ç”¨rwMutex.Lockå†™é”ä¿æŠ¤æ•°æ® funcÂ writeData(key,Â valueÂ string)Â { rwMutex.Lock() deferÂ rwMutex.Unlock() sharedData[key]Â =Â value } æ³¨æ„ï¼šsync.Mutex çš„é”æ˜¯ä¸å¯ä»¥åµŒå¥—ä½¿ç”¨çš„ sync.RWMutex çš„ RLock()æ˜¯å¯ä»¥åµŒå¥—ä½¿ç”¨çš„ sync.RWMutex çš„ mu.Lock() æ˜¯ä¸å¯ä»¥åµŒå¥—çš„ sync.RWMutex çš„ mu.Lock() ä¸­ä¸å¯ä»¥åµŒå¥— mu.RLock()\nä½¿ç”¨sync.Condè¿›è¡Œæ¡ä»¶å˜é‡æ§åˆ¶ sync.Condæ˜¯ä¸€ä¸ªæ¡ä»¶å˜é‡ï¼Œç”¨äºåœ¨åç¨‹ä¹‹é—´è¿›è¡Œé€šä¿¡å’ŒåŒæ­¥ã€‚å®ƒå¯ä»¥åœ¨æŒ‡å®šçš„æ¡ä»¶æ»¡è¶³ä¹‹å‰é˜»å¡ç­‰å¾…ï¼Œå¹¶åœ¨æ¡ä»¶æ»¡è¶³æ—¶å”¤é†’ç­‰å¾…çš„åç¨‹ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 varÂ condÂ =Â sync.NewCond(\u0026amp;sync.Mutex{}) varÂ readyÂ bool goÂ func()Â { //Â å¼‚æ­¥ä»»åŠ¡é€»è¾‘ readyÂ =Â true //Â é€šçŸ¥ç­‰å¾…çš„åç¨‹æ¡ä»¶å·²æ»¡è¶³ cond.Broadcast() }() //Â åœ¨æŸä¸ªåœ°æ–¹ç­‰å¾…æ¡ä»¶æ»¡è¶³ cond.L.Lock() forÂ !readyÂ { cond.Wait() } cond.L.Unlock() ä½¿ç”¨sync.Poolç®¡ç†å¯¹è±¡æ±  sync.Poolæ˜¯ä¸€ä¸ªå¯¹è±¡æ± ï¼Œç”¨äºç¼“å­˜å’Œå¤ç”¨ä¸´æ—¶å¯¹è±¡ï¼Œå¯ä»¥æé«˜å¯¹è±¡çš„åˆ†é…å’Œå›æ”¶æ•ˆç‡ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 typeÂ MyObjectÂ structÂ { //Â å¯¹è±¡ç»“æ„ } varÂ objectPoolÂ =Â sync.Pool{ New:Â func()Â interface{}Â { //Â åˆ›å»ºæ–°å¯¹è±¡ returnÂ \u0026amp;MyObject{} }, } //Â ä»å¯¹è±¡æ± è·å–å¯¹è±¡ objÂ :=Â objectPool.Get().(*MyObject) //Â ä½¿ç”¨å¯¹è±¡ //Â å°†å¯¹è±¡æ”¾å›å¯¹è±¡æ±  objectPool.Put(obj) ä½¿ç”¨sync.Onceå®ç°åªæ‰§è¡Œä¸€æ¬¡çš„æ“ä½œ sync.Onceç”¨äºç¡®ä¿æŸä¸ªæ“ä½œåªæ‰§è¡Œä¸€æ¬¡ï¼Œæ— è®ºæœ‰å¤šå°‘ä¸ªåç¨‹å°è¯•æ‰§è¡Œå®ƒï¼Œå¸¸ç”¨äºåˆå§‹åŒ–æˆ–åŠ è½½èµ„æºç­‰åœºæ™¯ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 varÂ onceÂ sync.Once varÂ resourceÂ *Resource funcÂ getResource()Â *ResourceÂ { once.Do(func()Â { //Â æ‰§è¡Œåˆå§‹åŒ–èµ„æºçš„æ“ä½œï¼Œä»…æ‰§è¡Œä¸€æ¬¡ resourceÂ =Â initResource() }) returnÂ resource } //Â åœ¨å¤šä¸ªåç¨‹ä¸­è·å–èµ„æº goÂ func()Â { resÂ :=Â getResource() //Â ä½¿ç”¨èµ„æº }() goÂ func()Â { resÂ :=Â getResource() //Â ä½¿ç”¨èµ„æº }() ä½¿ç”¨sync.Onceå’Œcontext.Contextå®ç°èµ„æºæ¸…ç† å¯ä»¥ç»“åˆä½¿ç”¨sync.Onceå’Œcontext.Contextæ¥ç¡®ä¿åœ¨å¤šä¸ªåç¨‹ä¹‹é—´åªæ‰§è¡Œä¸€æ¬¡èµ„æºæ¸…ç†æ“ä½œï¼Œå¹¶åœ¨å–æ¶ˆæˆ–è¶…æ—¶æ—¶è¿›è¡Œæ¸…ç†ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 varÂ onceÂ sync.Once funcÂ cleanup()Â { //Â æ‰§è¡Œèµ„æºæ¸…ç†æ“ä½œ } funcÂ doTask(ctxÂ context.Context)Â { goÂ func()Â { selectÂ { caseÂ \u0026lt;-ctx.Done(): once.Do(cleanup)Â //Â åªæ‰§è¡Œä¸€æ¬¡èµ„æºæ¸…ç† } }() //Â å¼‚æ­¥ä»»åŠ¡é€»è¾‘ } ä½¿ç”¨sync.Mapå®ç°å¹¶å‘å®‰å…¨çš„Map sync.Mapæ˜¯Goè¯­è¨€æ ‡å‡†åº“ä¸­æä¾›çš„å¹¶å‘å®‰å…¨çš„æ˜ å°„ç±»å‹ï¼Œå¯åœ¨å¤šä¸ªåç¨‹ä¹‹é—´å®‰å…¨åœ°è¿›è¡Œè¯»å†™æ“ä½œã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 varÂ mÂ sync.Map //Â å­˜å‚¨é”®å€¼å¯¹ m.Store(\u0026#34;key\u0026#34;,Â \u0026#34;value\u0026#34;) //Â è·å–å€¼ ifÂ val,Â okÂ :=Â m.Load(\u0026#34;key\u0026#34;);Â okÂ { //Â ä½¿ç”¨å€¼ } //Â åˆ é™¤é”® m.Delete(\u0026#34;key\u0026#34;) ä½¿ç”¨context.Contextè¿›è¡Œåç¨‹ç®¡ç†å’Œå–æ¶ˆ context.Contextç”¨äºåœ¨åç¨‹ä¹‹é—´ä¼ é€’ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œå¹¶å¯ç”¨äºå–æ¶ˆæˆ–è¶…æ—¶æ§åˆ¶ã€‚å¯ä»¥ä½¿ç”¨context.WithCancel()åˆ›å»ºä¸€ä¸ªå¯å–æ¶ˆçš„ä¸Šä¸‹æ–‡ï¼Œå¹¶ä½¿ç”¨context.WithTimeout()åˆ›å»ºä¸€ä¸ªå¸¦æœ‰è¶…æ—¶çš„ä¸Šä¸‹æ–‡ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 ctx,Â cancelÂ :=Â context.WithCancel(context.Background()) goÂ func()Â { //Â å¼‚æ­¥ä»»åŠ¡é€»è¾‘ ifÂ someConditionÂ { cancel()Â //Â å–æ¶ˆä»»åŠ¡ } }() //Â ç­‰å¾…ä»»åŠ¡å®Œæˆæˆ–å–æ¶ˆ selectÂ { caseÂ \u0026lt;-ctx.Done(): //Â ä»»åŠ¡è¢«å–æ¶ˆæˆ–è¶…æ—¶ } ä½¿ç”¨context.WithDeadline()å’Œcontext.WithTimeout()è®¾ç½®æˆªæ­¢æ—¶é—´ context.WithDeadline()å’Œcontext.WithTimeout()å‡½æ•°å¯ä»¥ç”¨äºåˆ›å»ºå¸¦æœ‰æˆªæ­¢æ—¶é—´çš„ä¸Šä¸‹æ–‡ï¼Œä»¥é™åˆ¶å¼‚æ­¥ä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 funcÂ doTask(ctxÂ context.Context)Â { //Â å¼‚æ­¥ä»»åŠ¡é€»è¾‘ selectÂ { caseÂ \u0026lt;-time.After(5Â *Â time.Second): //Â è¶…æ—¶å¤„ç† caseÂ \u0026lt;-ctx.Done(): //Â ä¸Šä¸‹æ–‡å–æ¶ˆå¤„ç† } } funcÂ main()Â { ctxÂ :=Â context.Background() ctx,Â cancelÂ :=Â context.WithTimeout(ctx,Â 3*time.Second) deferÂ cancel() goÂ doTask(ctx) //Â ç»§ç»­å…¶ä»–æ“ä½œ } ä½¿ç”¨context.WithValue()ä¼ é€’ä¸Šä¸‹æ–‡å€¼ context.WithValue()å‡½æ•°å¯ç”¨äºåœ¨ä¸Šä¸‹æ–‡ä¸­ä¼ é€’é”®å€¼å¯¹ï¼Œä»¥åœ¨åç¨‹ä¹‹é—´å…±äº«å’Œä¼ é€’ä¸Šä¸‹æ–‡ç›¸å…³çš„å€¼ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 typeÂ keyContextValueÂ string funcÂ doTask(ctxÂ context.Context)Â { ifÂ valÂ :=Â ctx.Value(keyContextValue(\u0026#34;key\u0026#34;));Â valÂ !=Â nilÂ { //Â ä½¿ç”¨ä¸Šä¸‹æ–‡å€¼ } } funcÂ main()Â { ctxÂ :=Â context.WithValue(context.Background(),Â keyContextValue(\u0026#34;key\u0026#34;),Â \u0026#34;value\u0026#34;) goÂ doTask(ctx) //Â ç»§ç»­å…¶ä»–æ“ä½œ } ä½¿ç”¨atomicåŒ…è¿›è¡ŒåŸå­æ“ä½œ atomicåŒ…æä¾›äº†ä¸€ç»„å‡½æ•°ï¼Œç”¨äºå®ç°åŸå­æ“ä½œï¼Œä»¥ç¡®ä¿åœ¨å¹¶å‘ç¯å¢ƒä¸­å¯¹å…±äº«å˜é‡çš„è¯»å†™æ“ä½œæ˜¯åŸå­çš„ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 varÂ counterÂ int64 func increment() { atomic.AddInt64(\u0026amp;counter,Â 1) } func main() { var wg sync.WaitGroup forÂ iÂ :=Â 0;Â iÂ \u0026lt;Â 100;Â i++Â { wg.Add(1) goÂ func()Â { defer wg.Done() increment() }() } wg.Wait() fmt.Println(\u0026#34;Counter:\u0026#34;,Â counter) } æ€»ç»“ æœ¬ç¯‡æ–‡ç« ï¼Œæˆ‘ä»¬ä»‹ç»çš„æ˜¯ä¸€äº›å¸¸ç”¨çš„å…³é”®å­—ï¼ŒæŒæ¡è¿™äº›ï¼Œåº”å¯¹å¸¸ç”¨çš„å¹¶å‘ç¼–ç¨‹å·²ç»é—®é¢˜æ²¡æœ‰ä»€ä¹ˆé—®é¢˜äº†ã€‚ç›¸ä¿¡æ‚¨ä¹Ÿå·²ç»å‘ç°äº†ï¼Œgoæºç ä¸­æ²¡æœ‰æä¾›java ï¼Œc# ä¸­å¸¸ç”¨çš„ Barrier åŠŸèƒ½ï¼Œè™½ç„¶Barrier çš„åŠŸèƒ½æˆ‘ä»¬ä½¿ç”¨åŸºæœ¬çš„å¹¶å‘è¯­å¥ä¹Ÿèƒ½å®ç°ï¼Œä½†æ˜¯ä¸å¦‚è°ƒç”¨ç°æˆçš„APIæ¥å£æ–¹ä¾¿ã€‚å…¶å®åœ¨ golang.org/xä¸­æœ‰SingleFlight ä»¥åŠæ˜¯ç¬¬ä¸‰æ–¹[CyclicBarrier](https://github.com/marusama/cyclicbarrier)ã€‚ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°†ä»‹ç»è¿™ä¸¤ä¸ªå¹¶å‘åŸè¯­ã€‚\n","date":"2024-07-08T17:38:59+08:00","permalink":"https://huizhou92.com/zh-cn/p/go%E9%AB%98%E6%80%A7%E8%83%BD%E7%BC%96%E7%A8%8B-ep6-%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B%E7%9A%84%E6%8A%80%E5%B7%A7/","title":"Goé«˜æ€§èƒ½ç¼–ç¨‹ EP6: å¼‚æ­¥ç¼–ç¨‹çš„æŠ€å·§"},{"content":" æœ¬æ–‡å†™ä½œæ‰€æœ‰çš„ä¾‹å­ä»¥ macbookpro M1 ä¸ºä¾‹ï¼Œè¯¥CPUä¸º64ä½æ¶æ„\næœ¬æ–‡æ˜¯Goè¯­è¨€é«˜æ€§èƒ½ç¼–ç¨‹ç¬¬ä¸‰ç¯‡ï¼Œåˆ†æäº†ä¸ºä»€ä¹ˆéœ€è¦å†…å­˜å¯¹é½ï¼ŒGoè¯­è¨€å†…å­˜å¯¹é½çš„è§„åˆ™ï¼Œä»¥åŠå®é™…ä¾‹å­ä¸­å†…å­˜å¯¹é½çš„ä½¿ç”¨ï¼Œæœ€ååˆ†äº«äº†ä¸¤ä¸ªå·¥å…·ï¼Œå¸®åŠ©æˆ‘ä»¬åœ¨å¼€å‘è¿‡ç¨‹ä¸­å‘ç°å†…å­˜å¯¹é½é—®é¢˜ã€‚\nThis article was first published in the Medium MPP plan. If you are a Medium user, please follow me on Medium. Thank you very much.\nä»€ä¹ˆæ˜¯å†…å­˜å¯¹é½ï¼Ÿ åœ¨ç¨‹åºå‘˜çœ¼é‡Œï¼Œå†…å­˜å¯èƒ½å°±æ˜¯ä¸€ä¸ªå·¨å¤§çš„æ•°ç»„ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å†…å­˜ä¸­å†™ä¸€ä¸ªint16 ,å ç”¨ä¸¤ä¸ªå­—èŠ‚ã€‚ä¹Ÿå¯ä»¥å†™ä¸€ä¸ªint32ï¼Œå ç”¨å››ä¸ªå­—èŠ‚ã€‚ æ¯”å¦‚\n1 2 3 4 5 type T1 struct { a int8 b int64 c int16 } è¿™ä¸ª struce ä¸ç†Ÿæ‚‰Goè¯­è¨€çš„äººå¯èƒ½è®¤ä¸ºæ˜¯ä¸‹é¢è¿™ç§å¸ƒå±€ã€‚ æ€»å…±å ç”¨11å­—èŠ‚ç©ºé—´ã€‚\nFigure 1: Memory layout as understood by some people\nä¸€ä¸ªæŒ¨ç€ä¸€ä¸ªï¼Œå¾ˆç´§å‡‘ï¼Œå¾ˆå®Œç¾ã€‚\nä½†æ˜¯å®é™…ä¸Šå¹¶ä¸æ˜¯è¿™æ ·çš„ã€‚å¦‚æœæˆ‘ä»¬æ‰“å° T1 çš„å˜é‡åœ°å€ï¼Œä¼šå‘ç°ï¼Œä»–ä»¬å¤§æ¦‚é•¿è¿™æ ·ã€‚æ€»å…±å ç”¨ 24å­—èŠ‚ç©ºé—´ã€‚\nFigure 2: T1 çš„å®é™…å†…å­˜å¸ƒå±€\nList 1ï¼šT1 size\n1 2 3 4 5 6 7 8 9 10 func main() { t := T1{} fmt.Println(fmt.Sprintf(\u0026#34;%d %d %d %d\u0026#34;, unsafe.Sizeof(t.a), unsafe.Sizeof(t.b), unsafe.Sizeof(t.c), unsafe.Sizeof(t))) fmt.Println(fmt.Sprintf(\u0026#34;%p %p %p\u0026#34;, \u0026amp;t.a, \u0026amp;t.b, \u0026amp;t.c)) fmt.Println(unsafe.Alignof(t)) } // output // 1 8 2 24 // 0x14000114018 0x14000114020 0x14000114028 // 8 å› ä¸ºCPUä»å†…å­˜é‡Œé¢æ‹¿æ•°æ®ï¼Œæ˜¯æ ¹æ®word size æ¥æ‹¿çš„ï¼Œæ¯”å¦‚ 64 ä½çš„ CPU ï¼Œword size ä¸º 8å­—èŠ‚ï¼Œé‚£ä¹ˆ CPU è®¿é—®å†…å­˜çš„å•ä½ä¹Ÿæ˜¯ 8 å­—èŠ‚ï¼Œæˆ‘ä»¬å°†å¤„ç†å™¨è®¿é—®å†…å­˜çš„å¤§å°ç§°ä¸ºå†…å­˜è®¿é—®ç²’åº¦ã€‚\nè¿™ç§ç°è±¡ï¼Œä¼šé€ æˆå‡ ä¸ªä¸¥é‡çš„é—®é¢˜\næ€§èƒ½é™ä½ï¼Œå› ä¸ºå¤šäº†ä¸€æ¬¡CPUæŒ‡ä»¤ åŸæœ¬è¯»ä¸€ä¸ªå˜é‡æ˜¯åŸå­æ“ä½œçš„ï¼Œç°åœ¨å˜å¾—ä¸åŸå­ ä¸€äº›å…¶ä»–æ„æƒ³ä¸åˆ°çš„æƒ…å†µã€‚\næ‰€ä»¥ä¸€èˆ¬ç¼–è¯‘å™¨éƒ½ä¼šå®ç°å†…å­˜å¯¹é½ï¼Œç”¨ç‰ºç‰²å†…å­˜ç©ºé—´çš„æ–¹å¼ï¼Œä¿è¯äº†ï¼š å¹³å°ï¼ˆç§»æ¤æ€§ï¼‰\nä¸æ˜¯æ‰€æœ‰çš„ç¡¬ä»¶å¹³å°éƒ½èƒ½å¤Ÿè®¿é—®ä»»æ„åœ°å€ä¸Šçš„ä»»æ„æ•°æ®ã€‚ä¾‹å¦‚ï¼šç‰¹å®šçš„ç¡¬ä»¶å¹³å°åªå…è®¸åœ¨ç‰¹å®šåœ°å€è·å–ç‰¹å®šç±»å‹çš„æ•°æ®ï¼Œå¦åˆ™ä¼šå¯¼è‡´å¼‚å¸¸æƒ…å†µã€‚ æ€§èƒ½\nè‹¥è®¿é—®æœªå¯¹é½çš„å†…å­˜ï¼Œå°†ä¼šå¯¼è‡´ CPU è¿›è¡Œä¸¤æ¬¡å†…å­˜è®¿é—®ï¼Œå¹¶ä¸”è¦èŠ±è´¹é¢å¤–çš„æ—¶é’Ÿå‘¨æœŸæ¥å¤„ç†å¯¹é½åŠè¿ç®—ã€‚è€Œæœ¬èº«å°±å¯¹é½çš„å†…å­˜ä»…éœ€è¦ä¸€æ¬¡è®¿é—®å°±å¯ä»¥å®Œæˆè¯»å–åŠ¨ä½œï¼Œè¿™æ˜¾ç„¶é«˜æ•ˆå¾ˆå¤šï¼Œæ˜¯æ ‡å‡†çš„ç©ºé—´æ¢æ—¶é—´åšæ³•ã€‚ GOè¯­è¨€å†…å­˜å¯¹é½ go spec ä¸­çº¦å®šäº† go å¯¹é½çš„è§„åˆ™ã€‚\n1 2 3 4 5 6 7 type size in bytes byte, uint8, int8 1 uint16, int16 2 uint32, int32, float32 4 uint64, int64, float64, complex64 8 complex128 16 For a variableÂ xÂ of any type:Â unsafe.Alignof(x)Â is at least 1. For a variableÂ xÂ of struct type:Â unsafe.Alignof(x)Â is the largest of all the valuesÂ unsafe.Alignof(x.f)Â for each fieldÂ fÂ ofÂ x, but at least 1. For a variableÂ xÂ of array type:Â unsafe.Alignof(x)Â is the same as the alignment of a variable of the array\u0026rsquo;s element type. ç»å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œgoç¼–è¯‘å™¨ä¼šå¸®æˆ‘ä»¬è‡ªåŠ¨å†…å­˜å¯¹é½ï¼Œæˆ‘ä»¬ä¸éœ€è¦å…³å¿ƒå†…å­˜æ˜¯å¦å¯¹é½ï¼Œä½†æ˜¯åœ¨æœ‰ä¸€ç§æƒ…å†µä¸‹ï¼Œéœ€è¦æ‰‹åŠ¨å¯¹é½ã€‚\nåœ¨ x86 å¹³å°ä¸ŠåŸå­æ“ä½œ 64bit æŒ‡é’ˆã€‚ä¹‹æ‰€ä»¥è¦å¼ºåˆ¶å¯¹é½ï¼Œæ˜¯å› ä¸ºåœ¨ 32bit å¹³å°ä¸‹è¿›è¡Œ 64bit åŸå­æ“ä½œè¦æ±‚å¿…é¡» 8 å­—èŠ‚å¯¹é½ï¼Œå¦åˆ™ç¨‹åºä¼š panicã€‚\næ¯”å¦‚ä¸‹é¢è¿™æ®µä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 package main import \u0026#34;sync/atomic\u0026#34; type T3 struct { b int64 c int32 d int64 } func main() { a := T3{} atomic.AddInt64(\u0026amp;a.d, 1) } åœ¨ amd64 æ¶æ„ä¸‹è¿è¡Œä¸ä¼šæŠ¥é”™ï¼Œä½†æ˜¯åœ¨i386 æ¶æ„ä¸‹é¢å°±ä¼španicã€‚\nFigure 3: T3 panic\nåŸå› å°±æ˜¯ T3 åœ¨ 32bit å¹³å°ä¸Šæ˜¯ 4 å­—èŠ‚å¯¹é½ï¼Œè€Œåœ¨ 64bit å¹³å°ä¸Šæ˜¯ 8 å­—èŠ‚å¯¹é½ã€‚åœ¨ 64bit å¹³å°ä¸Šå…¶å†…å­˜å¸ƒå±€ä¸ºï¼š\nFigure 4: T3åœ¨ amd64 çš„å†…å­˜å¸ƒå±€\nä½†æ˜¯åœ¨I386 çš„å¸ƒå±€ä¸ºï¼š\nFigure 5: T3åœ¨ i386çš„å†…å­˜å¸ƒå±€\nè¿™ä¸ªé—®é¢˜åœ¨ atomic çš„ æ–‡æ¡£ä¸­æœ‰å†™ã€‚\nOn 386, the 64-bit functions use instructions unavailable before the Pentium MMX.\nOn non-Linux ARM, the 64-bit functions use instructions unavailable before the ARMv6k core.\nOn ARM, 386, and 32-bit MIPS, it is the caller\u0026rsquo;s responsibility to arrange for 64-bit alignment of 64-bit words accessed atomically via the primitive atomic functions (typesÂ Int64Â andÂ Uint64Â are automatically aligned). The first word in an allocated struct, array, or slice; in a global variable; or in a local variable (because the subject of all atomic operations will escape to the heap) can be relied upon to be 64-bit aligned. ä¸ºäº†è§£å†³è¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬å¿…é¡»æ‰‹åŠ¨ padding T3ï¼Œè®©å…¶ â€œçœ‹èµ·æ¥â€ åƒæ˜¯ 8 å­—èŠ‚å¯¹é½çš„ï¼š\n1 2 3 4 5 6 type T3 struct { b int64 c int32 _ int32 d int64 } åœ¨goæºç å’Œå¼€æºåº“ä¸­ä¹Ÿèƒ½çœ‹åˆ°å¾ˆå¤šç±»ä¼¼çš„æ“ä½œã€‚\næ¯”å¦‚\nmgc groupcache æ‰€å¹¸çš„æ˜¯ï¼Œæˆ‘ä»¬å…¶å®æœ‰å¾ˆå¤šå·¥å…·æ¥å¸®åŠ©æˆ‘ä»¬è¯†åˆ«ä¸ä¼˜åŒ– è¿™äº›é—®é¢˜ã€‚\nå·¥ç¨‹å®è·µ fieldalignment fieldalignment æ˜¯golang å®˜æ–¹çš„å·¥å…·ï¼Œå®ƒä¼šå¸®æˆ‘ä»¬å‘ç°ä»£ç ä¸­å¯èƒ½çš„å†…å­˜å¯¹é½ä¼˜åŒ–ä»¥åŠè‡ªåŠ¨å¸®æˆ‘ä»¬å¯¹é½ã€‚ æ¯”å¦‚T1 å®ƒä¼šè‡ªåŠ¨ è½¬æˆå†…å­˜å¯¹é½çš„ã€‚\n1 2 3 4 5 6 7 8 9 âœ go_mem_alignment git:(main) âœ— fieldalignment -fix . /Users/hxzhouh/workspace/github/blog-example/go/go_mem_alignment/main.go:8:8: struct of size 24 could be 16 // change type T1 struct { b int64 c int16 a int8 } ä¹Ÿå¯ä»¥åœ¨ golangci-link ä¸­ä½¿ç”¨å®ƒï¼Œfieldalignment æ˜¯éš¶å±äº govet çš„ä¸€ä¸ªå­åŠŸèƒ½ï¼Œåœ¨ .golangci.yaml ä¸­å¯ä»¥è¿™æ ·å¯ç”¨å®ƒï¼š\nlist :\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 # .golangci.yml linters: disable-all: true enable: - govet fast: false linters-settings: govet: # report about shadowed variables check-shadowing: false fast: false # disable: # - fieldalignment # I\u0026#39;m ok to waste some bytes enable: - fieldalignment ä½†æ˜¯ï¼Œfieldalignment æœ‰ä¸€ä¸ªæ¯”è¾ƒæ¼ç«çš„åœ°æ–¹ï¼šå®ƒä¼šåœ¨é‡æ–°æ’å¸ƒç»“æ„ä½“æˆå‘˜çš„æ—¶å€™ï¼Œå°†æ‰€æœ‰ç©ºè¡Œã€æ³¨é‡Šé€šé€šåˆ å»ã€‚ æ‰€ä»¥æœ‰æ—¶å€™ï¼Œä½ åº”è¯¥ git commit ä¸€æ¬¡ï¼Œç„¶åç”¨ä¸€ä¸‹è¿™ä¸ªå·¥å…·ï¼Œç„¶åé€šè¿‡ git diff æ¥ review å®ƒæ‰€åšçš„å˜æ›´ï¼Œç„¶åè¿›è¡Œè‹¥å¹²åå¤„ç†ã€‚æ‰€ä»¥æˆ‘å†ç”Ÿäº§ç¯å¢ƒå¾ˆå°‘ä½¿ç”¨è¿™ä¸ª å·¥å…·ï¼Œä¸€èˆ¬ä½¿ç”¨structlayout\nstructlayout structlayout å¯ä»¥æ˜¾ç¤ºstructçš„å¸ƒå±€ä»¥åŠå¤§å°ï¼Œå¯ä»¥è¾“å‡ºsvgæˆ–è€…jsonæ ¼å¼çš„æ•°æ®ã€‚å¦‚æœä¸€ä¸ªstruct æ¯”è¾ƒå¤æ‚ï¼Œå¯ä»¥ç”¨è¿™ä¸ªå·¥å…·æ¥ä¼˜åŒ–ã€‚\nå®‰è£…æ–¹å¼\n1 2 3 4 go install honnef.co/go/tools/cmd/structlayout@latest go install honnef.co/go/tools/cmd/structlayout-pretty@latest go install honnef.co/go/tools/cmd/structlayout-optimize@latest go install github.com/ajstarks/svgo/structlayout-svg@latest ç”¨structlayout åˆ†æä¸€ä¸‹ T1\n1 structlayout -json ./main.go T1 | structlayout-svg \u0026gt;T1.svg Figure 6: T1 Structure Layout\næˆ‘ä»¬å¯ä»¥å¾ˆæ¸…æ¥šçš„çœ‹åˆ°æœ‰ä¸¤ä¸ªpaddingã€‚ 7 size å’Œ 6size\nä¼˜åŒ–åçš„T2ï¼š\n1 2 3 4 5 type T2 struct { a int8 c int16 b int64 } Figure 7: T2 Structure Layout\nåªæœ‰ä¹Ÿæœ‰ä¸¤ä¸ªåœ°æ–¹æœ‰paddingï¼Œä½†æ˜¯åªæœ‰5ä¸ªsizeã€‚\næ€»ç»“ åœ¨ç¨‹åºè®¾è®¡ä¸­ï¼Œå†…å­˜å¯¹é½æ˜¯ä¸€é¡¹å…³é”®æŠ€æœ¯ï¼Œæ—¨åœ¨æé«˜ç¨‹åºæ€§èƒ½å’Œå…¼å®¹æ€§ã€‚æœ¬æ–‡ä»¥Goè¯­è¨€ä¸ºä¾‹ï¼Œè¯¦ç»†è®²è§£äº†å†…å­˜å¯¹é½çš„åŸºæœ¬æ¦‚å¿µå’Œå¿…è¦æ€§ï¼Œå¹¶é€šè¿‡ä»£ç ç¤ºä¾‹å±•ç¤ºäº†ä¸åŒç»“æ„ä½“åœ¨å†…å­˜ä¸­çš„å®é™…å¸ƒå±€ã€‚\nGoè¯­è¨€ä¸­çš„å†…å­˜å¯¹é½è§„åˆ™ä¸»è¦ä½“ç°åœ¨ç»“æ„ä½“å­—æ®µçš„æ’åˆ—é¡ºåºä¸Šã€‚ç¼–è¯‘å™¨é€šè¿‡è‡ªåŠ¨å¯¹é½æ¥ä¿è¯æ€§èƒ½å’Œå¹³å°ç§»æ¤æ€§ï¼Œä½†åœ¨æŸäº›æƒ…å†µä¸‹éœ€è¦å¼€å‘è€…æ‰‹åŠ¨è°ƒæ•´ç»“æ„ä½“å­—æ®µä»¥é¿å…æ€§èƒ½é—®é¢˜å’Œæ½œåœ¨çš„é”™è¯¯ã€‚\nempty struct æ˜¯å†…å­˜å¯¹é½ä¼˜åŒ–çš„ä¸€ä¸ªå¥½å¸®æ‰‹ï¼Œå…·ä½“æ“ä½œå¯ä»¥å‚è€ƒæˆ‘çš„å¦å¤–ä¸€ç¯‡æ–‡ç« ï¼šGolang High-Performance Programming EP1: Empty Struct\nä¸ºå¸®åŠ©å¼€å‘è€…æ£€æµ‹å’Œä¼˜åŒ–å†…å­˜å¯¹é½é—®é¢˜ï¼Œæœ¬æ–‡ä»‹ç»äº†ä¸¤ä¸ªå®ç”¨å·¥å…·ï¼š\nfieldalignmentï¼šGoå®˜æ–¹å·¥å…·ï¼Œèƒ½è‡ªåŠ¨ä¼˜åŒ–ç»“æ„ä½“çš„å†…å­˜å¯¹é½ã€‚ structlayoutï¼šæ˜¾ç¤ºç»“æ„ä½“çš„å†…å­˜å¸ƒå±€ï¼Œå¸®åŠ©å¼€å‘è€…æ›´ç›´è§‚åœ°ç†è§£å’Œä¼˜åŒ–å†…å­˜ä½¿ç”¨ã€‚ é€šè¿‡åˆç†ä½¿ç”¨è¿™äº›å·¥å…·ï¼Œå¼€å‘è€…å¯ä»¥åœ¨ä¿è¯ç¨‹åºæ€§èƒ½å’Œç¨³å®šæ€§çš„åŒæ—¶ï¼Œå‡å°‘å†…å­˜æµªè´¹ï¼Œæå‡å¼€å‘æ•ˆç‡ã€‚\nå‚è€ƒèµ„æ–™ IBM DeveloperWorks: Data Alignment Go Specification: Size and Alignment Guarantees ","date":"2024-07-03T15:48:59+08:00","image":"https://images.hxzhouh.com/blog-images/2024/07/b3eca51256266ff32f8a27c85544e1c8.jpg","permalink":"https://huizhou92.com/zh-cn/p/go-%E9%AB%98%E6%80%A7%E8%83%BD%E7%BC%96%E7%A8%8Bep3-%E5%86%85%E5%AD%98%E5%AF%B9%E9%BD%90/","title":"go é«˜æ€§èƒ½ç¼–ç¨‹EP3: å†…å­˜å¯¹é½"},{"content":"æˆ‘ä»¬éƒ½çŸ¥é“ï¼ŒGoæœ‰ä¸€ä¸ªå¾ˆé‡è¦çš„ç‰¹ç‚¹ï¼Œé‚£å°±æ˜¯å®ƒçš„ç¼–è¯‘é€Ÿåº¦éå¸¸å¿«ï¼Œç¼–è¯‘é€Ÿåº¦æ˜¯Goè¯­è¨€è®¾è®¡çš„æ—¶å€™å°±é‡ç‚¹è€ƒè™‘çš„é—®é¢˜. ä½†æ˜¯æ‚¨æœ‰æ²¡æœ‰è§‚å¯Ÿè¿‡Goè¯­è¨€ç¼–è¯‘åçš„äºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶çš„å¤§å°ï¼Ÿæˆ‘ä»¬å…ˆç”¨ä¸€ä¸ªç®€å•çš„http server çš„ä¾‹å­æ¥çœ‹çœ‹ã€‚\nThis article was first published in the Medium MPP plan. If you are a Medium user, please follow me on Medium. Thank you very much.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 import ( \u0026#34;fmt\u0026#34; \u0026#34;net/http\u0026#34; ) func main() { // create a http server and create a handler hello, return hello world http.HandleFunc(\u0026#34;/\u0026#34;, func(w http.ResponseWriter, r *http.Request) { fmt.Fprintf(w, \u0026#34;Hello, World\\n\u0026#34;) }) // listen to port 8080 err := http.ListenAndServe(\u0026#34;:8080\u0026#34;, nil) if err != nil { return } } --- ç¼–è¯‘åçš„ä½“ç§¯è¾¾åˆ°äº†6.5M\n1 2 3 âœ binary-size git:(main) âœ— go build -o server main.go âœ binary-size git:(main) âœ— ls -lh server -rwxr-xr-x 1 hxzhouh staff 6.5M Jul 2 14:20 server Goè¯­è¨€çš„ç¼–è¯‘å™¨ä¼šå¯¹äºŒè¿›åˆ¶æ–‡ä»¶çš„å¤§å°è¿›è¡Œè£å‰ªï¼Œå¦‚æœæ‚¨å¯¹è¿™éƒ¨åˆ†çš„å†…å®¹æ„Ÿå…´è¶£ï¼Œè¯·é˜…è¯»æˆ‘çš„å¦å¤–ä¸€ç¯‡æ–‡ç« How Does the Go Compiler Reduce Binary File Size?\nç°åœ¨æˆ‘ä»¬æ¥å°è¯•ä¼˜åŒ–ä¸€ä¸‹server çš„å¤§å°ã€‚\næ¶ˆé™¤è°ƒè¯•ä¿¡æ¯ Go ç¼–è¯‘å™¨é»˜è®¤ç¼–è¯‘å‡ºæ¥çš„ç¨‹åºä¼šå¸¦æœ‰ç¬¦å·è¡¨å’Œè°ƒè¯•ä¿¡æ¯ï¼Œä¸€èˆ¬æ¥è¯´ release ç‰ˆæœ¬å¯ä»¥å»é™¤è°ƒè¯•ä¿¡æ¯ä»¥å‡å°äºŒè¿›åˆ¶ä½“ç§¯ã€‚\n1 2 3 âœ binary-size git:(main) âœ— go build -ldflags=\u0026#34;-s -w\u0026#34; -o server main.go âœ binary-size git:(main) âœ— ls -lh server -rwxr-xr-x 1 hxzhouh staff 4.5M Jul 2 14:30 server -sï¼šå¿½ç•¥ç¬¦å·è¡¨å’Œè°ƒè¯•ä¿¡æ¯ã€‚ -wï¼šå¿½ç•¥DWARFv3è°ƒè¯•ä¿¡æ¯ï¼Œä½¿ç”¨è¯¥é€‰é¡¹åå°†æ— æ³•ä½¿ç”¨gdbè¿›è¡Œè°ƒè¯•ã€‚\nä½“ç§¯ä» 6.5M ä¸‹é™åˆ° 4.5Mï¼Œä¸‹é™çº¦ 30%ã€‚è¿™æ˜¯å¾ˆå¥½çš„ç¬¬ä¸€æ­¥ã€‚ ä½¿ç”¨ upx UPX is an advanced executable file compressor. UPX will typically reduce the file size of programs and DLLs by around 50%-70%, thus reducing disk space, network load times, download times and other distribution and storage costs.\nåœ¨Mac ä¸Šå¯ä»¥é€šè¿‡brew å®‰è£…upx\n1 brew install upx å•ç‹¬ä½¿ç”¨upx å‹ç¼© upx æœ‰å¾ˆå¤šå‚æ•°ï¼Œæœ€é‡è¦çš„åˆ™æ˜¯å‹ç¼©ç‡ï¼Œ1-9ï¼Œ1Â ä»£è¡¨æœ€ä½å‹ç¼©ç‡ï¼Œ9Â ä»£è¡¨æœ€é«˜å‹ç¼©ç‡ã€‚\næ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹ï¼Œå¦‚æœåªä½¿ç”¨ upx å‹ç¼©ï¼ŒäºŒè¿›åˆ¶çš„ä½“ç§¯å¯ä»¥å‡å°å¤šå°‘å‘¢ã€‚\n1 2 âœ binary-size git:(main) âœ— go build -o server main.go \u0026amp;\u0026amp; upx -9 server \u0026amp;\u0026amp; ls -lh server -rwxr-xr-x 1 hxzhouh staff 3.9M Jul 2 14:38 server å‹ç¼©æ¯”ä¾‹è¾¾åˆ°äº† 60%\nupx + ç¼–è¯‘å™¨é€‰é¡¹ åŒæ—¶å¼€å¯ upx + -ldflags=\u0026quot;-s -w\u0026quot;\n1 2 âœ binary-size git:(main) âœ— go build -ldflags=\u0026#34;-s -w\u0026#34; -o server main.go \u0026amp;\u0026amp; upx --brute server \u0026amp;\u0026amp; ls -lh server -rwxr-xr-x 1 hxzhouh staff 1.4M Jul 2 14:40 server æœ€ç»ˆæˆ‘ä»¬å¾—åˆ°çš„çš„å¯æ‰§è¡Œæ–‡ä»¶çš„å¤§å°æ˜¯ 1.4M å¯¹æ¯”ä¸å¼€å¯ä»»ä½•å‹ç¼©çš„6.5Mï¼Œå¤§çº¦èŠ‚çº¦äº†80%çš„ç©ºé—´ï¼Œå¯¹äºå¤§å‹åº”ç”¨ï¼Œè¿˜æ˜¯æŒºå¯è§‚çš„ã€‚\nupx çš„åŸç† upx å‹ç¼©åçš„ç¨‹åºå’Œå‹ç¼©å‰çš„ç¨‹åºä¸€æ ·ï¼Œæ— éœ€è§£å‹ä»ç„¶èƒ½å¤Ÿæ­£å¸¸åœ°è¿è¡Œï¼Œè¿™ç§å‹ç¼©æ–¹æ³•ç§°ä¹‹ä¸ºå¸¦å£³å‹ç¼©ï¼Œå‹ç¼©åŒ…å«ä¸¤ä¸ªéƒ¨åˆ†ï¼š\nåœ¨ç¨‹åºå¼€å¤´æˆ–å…¶ä»–åˆé€‚çš„åœ°æ–¹æ’å…¥è§£å‹ä»£ç ï¼› å°†ç¨‹åºçš„å…¶ä»–éƒ¨åˆ†å‹ç¼©ã€‚ æ‰§è¡Œæ—¶ï¼Œä¹ŸåŒ…å«ä¸¤ä¸ªéƒ¨åˆ†ï¼š\né¦–å…ˆæ‰§è¡Œçš„æ˜¯ç¨‹åºå¼€å¤´çš„æ’å…¥çš„è§£å‹ä»£ç ï¼Œå°†åŸæ¥çš„ç¨‹åºåœ¨å†…å­˜ä¸­è§£å‹å‡ºæ¥ï¼› å†æ‰§è¡Œè§£å‹åçš„ç¨‹åºã€‚\nä¹Ÿå°±æ˜¯è¯´ï¼Œupx åœ¨ç¨‹åºæ‰§è¡Œæ—¶ï¼Œä¼šæœ‰é¢å¤–çš„è§£å‹åŠ¨ä½œï¼Œä¸è¿‡è¿™ä¸ªè€—æ—¶å‡ ä¹å¯ä»¥å¿½ç•¥ã€‚\nå¦‚æœå¯¹ç¼–è¯‘åçš„ä½“ç§¯æ²¡ä»€ä¹ˆè¦æ±‚çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥ä¸ä½¿ç”¨ upx æ¥å‹ç¼©ã€‚ä¸€èˆ¬åœ¨æœåŠ¡å™¨ç«¯ç‹¬ç«‹è¿è¡Œçš„åå°æœåŠ¡ï¼Œæ— éœ€å‹ç¼©ä½“ç§¯ã€‚ æœ€å https://stackoverflow.com/questions/3861634/how-to-reduce-go-compiled-file-size\nè¿™å¸–å­é‡Œé¢æœ‰å¾ˆå¤šæœ‰æ„æ€çš„ç­”æ¡ˆï¼Œ\næ¯”å¦‚ç”¨cè¯­è¨€è·Ÿgoè¯­è¨€å®ç°ç›¸åŒçš„åŠŸèƒ½ï¼ˆå°demoï¼‰cè¯­è¨€ç”Ÿæˆçš„å¯æ‰§è¡Œå¤§å°æ˜¯ go è¯­è¨€çš„1/20(ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ) åœ¨Goè¯­è¨€ä¸­æˆ‘ä»¬ä½¿ç”¨ println æ¥æ›¿ä»£ fmt.println å°±èƒ½é¿å…å¼•å…¥fmtåŒ…ï¼Œè¿›ä¸€æ­¥ç¼©å°ä½“ç§¯ã€‚ ","date":"2024-07-02T15:01:44+08:00","image":"https://images.yixiao9206.cn/blog-images/2024/07/5f408427cbeaa5018a5af3e3499fdb82.png","permalink":"https://huizhou92.com/zh-cn/p/go-%E9%AB%98%E6%80%A7%E8%83%BD%E7%BC%96%E7%A8%8Bep2-%E9%80%9A%E8%BF%87upx-%E7%BC%A9%E5%B0%8F%E5%8F%AF%E6%89%A7%E8%A1%8C%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%96%87%E4%BB%B6%E7%9A%84%E4%BD%93%E7%A7%AF/","title":"Go é«˜æ€§èƒ½ç¼–ç¨‹EP2:  é€šè¿‡upx ç¼©å°å¯æ‰§è¡ŒäºŒè¿›åˆ¶æ–‡ä»¶çš„ä½“ç§¯"},{"content":"gRPC ä¸€èˆ¬ä¸åœ¨ message ä¸­å®šä¹‰é”™è¯¯ã€‚\næ¯•ç«Ÿæ¯ä¸ª gRPC æœåŠ¡æœ¬èº«å°±å¸¦ä¸€ä¸ª error çš„è¿”å›å€¼ï¼Œè¿™æ˜¯ç”¨æ¥ä¼ è¾“é”™è¯¯çš„ä¸“ç”¨é€šé“ã€‚\ngRPC ä¸­æ‰€æœ‰çš„é”™è¯¯è¿”å›éƒ½åº”è¯¥æ˜¯ nil æˆ–è€… ç”± status.Status äº§ç”Ÿçš„ä¸€ä¸ªerrorã€‚è¿™æ ·errorå¯ä»¥ç›´æ¥è¢«è°ƒç”¨æ–¹Clientè¯†åˆ«ã€‚\nThis article is first published in the medium MPP plan. If you are a medium user, please follow me in medium. Thank you very much.\n1. å¸¸è§„ç”¨æ³• å½“é‡åˆ°ä¸€ä¸ªgoé”™è¯¯çš„æ—¶å€™ï¼Œç›´æ¥è¿”å›æ˜¯æ— æ³•è¢«ä¸‹æ¸¸clientè¯†åˆ«çš„ã€‚\næ°å½“çš„åšæ³•æ˜¯ï¼š\nè°ƒç”¨ status.New æ–¹æ³•ï¼Œå¹¶ä¼ å…¥ä¸€ä¸ªé€‚å½“çš„é”™è¯¯ç ï¼Œç”Ÿæˆä¸€ä¸ª status.Status å¯¹è±¡ è°ƒç”¨è¯¥ status.Err æ–¹æ³•ç”Ÿæˆä¸€ä¸ªèƒ½è¢«è°ƒç”¨æ–¹è¯†åˆ«çš„errorï¼Œç„¶åè¿”å› 1 2 st := status.New(codes.NotFound, \u0026#34;some description\u0026#34;) err := st.Err() ä¼ å…¥çš„é”™è¯¯ç æ˜¯ codes.Code ç±»å‹ã€‚\næ­¤å¤–è¿˜æœ‰æ›´ä¾¿æ·çš„åŠæ³•ï¼šä½¿ç”¨ status.Errorã€‚å®ƒé¿å…äº†æ‰‹åŠ¨è½¬æ¢çš„æ“ä½œã€‚\n1 err := status.Error(codes.NotFound, \u0026#34;some description\u0026#34;) 2. è¿›é˜¶ç”¨æ³• ä¸Šé¢çš„é”™è¯¯æœ‰ä¸ªé—®é¢˜ï¼Œå°±æ˜¯ code.Code å®šä¹‰çš„é”™è¯¯ç åªæœ‰å›ºå®šçš„å‡ ç§ï¼Œæ— æ³•è¯¦å°½åœ°è¡¨è¾¾ä¸šåŠ¡ä¸­é‡åˆ°çš„é”™è¯¯åœºæ™¯ã€‚\ngRPC æä¾›äº†åœ¨é”™è¯¯ä¸­è¡¥å……ä¿¡æ¯çš„æœºåˆ¶ï¼šstatus.WithDetails æ–¹æ³•\nClient é€šè¿‡å°† error é‡æ–°è½¬æ¢ä½ status.Status ï¼Œå°±å¯ä»¥é€šè¿‡ status.Details æ–¹æ³•ç›´æ¥è·å–å…¶ä¸­çš„å†…å®¹ã€‚\nstatus.Details è¿”å›çš„æ˜¯ä¸ªsliceï¼Œ æ˜¯interface{}çš„sliceï¼Œç„¶è€Œgoå·²ç»è‡ªåŠ¨åšäº†ç±»å‹è½¬æ¢ï¼Œå¯ä»¥é€šè¿‡æ–­è¨€ç›´æ¥ä½¿ç”¨ã€‚\næœåŠ¡ç«¯ç¤ºä¾‹æœåŠ¡ç«¯ç¤ºä¾‹ ç”Ÿæˆä¸€ä¸ª status.Status å¯¹è±¡ å¡«å……é”™è¯¯çš„è¡¥å……ä¿¡æ¯ // ç”Ÿæˆä¸€ä¸ª status.Status\n1 2 3 4 5 6 7 8 9 10 11 12 func ErrorWithDetails() error { st := status.Newf(codes.Internal, fmt.Sprintf(\u0026#34;something went wrong: %v\u0026#34;, \u0026#34;api.Getter\u0026#34;)) v := \u0026amp;errdetails.PreconditionFailure_Violation{ //errDetails Type: \u0026#34;test\u0026#34;, Subject: \u0026#34;12\u0026#34;, Description: \u0026#34;32\u0026#34;, } br := \u0026amp;errdetails.PreconditionFailure{} br.Violations = append(br.Violations, v) st, _ = st.WithDetails(br) return st.Err() } å®¢æˆ·ç«¯çš„ç¤ºä¾‹ è°ƒç”¨RPCé”™è¯¯åï¼Œè§£æé”™è¯¯ä¿¡æ¯ é€šè¿‡æ–­è¨€ç›´æ¥è·å–é”™è¯¯è¯¦æƒ… 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 resp, err := odinApp.CreatePlan(cli.StaffId.AssetId, gentRatePlanMeta(cli.StaffId)) â€‹ if status.Code(err) != codes.InvalidArgument { logger.Error(\u0026#34;create plan error:%v\u0026#34;, err) } else { for _, d := range status.Convert(err).Details() { // switch info := d.(type) { case *errdetails.QuotaFailure: logger.Info(\u0026#34;Quota failure: %s\u0026#34;, info) case *errdetails.PreconditionFailure: detail := d.(*errdetails.PreconditionFailure).Violations for _, v1 := range detail { logger.Info(fmt.Sprintf(\u0026#34;details: %+v\u0026#34;, v1)) } case *errdetails.ResourceInfo: logger.Info(\u0026#34;ResourceInfo: %s\u0026#34;, info) â€‹ case *errdetails.BadRequest: logger.Info(\u0026#34;ResourceInfo: %s\u0026#34;, info) â€‹ default: logger.Info(\u0026#34;Unexpected type: %s\u0026#34;, info) } } } logger.Infof(\u0026#34;create plan success,resp=%v\u0026#34;, resp) åŸç† è¿™ä¸ªé”™è¯¯æ˜¯å¦‚ä½•ä¼ é€’ç»™è°ƒç”¨æ–¹Clientçš„å‘¢ï¼Ÿ\næ˜¯æ”¾åˆ° metadataä¸­çš„ï¼Œè€Œmetadataæ˜¯æ”¾åˆ°HTTPçš„headerä¸­çš„ã€‚\nmetadataæ˜¯keyï¼švalueæ ¼å¼çš„æ•°æ®ã€‚é”™è¯¯çš„ä¼ é€’ä¸­ï¼Œkeyæ˜¯ä¸ªå›ºå®šå€¼ï¼šgrpc-status-details-binã€‚\nè€Œvalueï¼Œæ˜¯è¢«protoç¼–ç è¿‡çš„ï¼Œæ˜¯äºŒè¿›åˆ¶å®‰å…¨çš„ã€‚\nç›®å‰å¤§å¤šæ•°è¯­è¨€éƒ½å®ç°äº†è¿™ä¸ªæœºåˆ¶ã€‚\næ³¨æ„ gRPCå¯¹å“åº”å¤´åšäº†é™åˆ¶ï¼Œä¸Šé™ä¸º8Kï¼Œæ‰€ä»¥é”™è¯¯ä¸èƒ½å¤ªå¤§ã€‚\nå‚è€ƒèµ„æ–™\nhttps://protobuf.dev/getting-started/gotutorial/\nhttps://pkg.go.dev/google.golang.org/genproto/googleapis/rpc/errdetails ","date":"2024-06-29T21:38:00Z","permalink":"https://huizhou92.com/zh-cn/p/go-action-error-handling-in-grpc/","title":"gRPCä¸­çš„é”™è¯¯å¤„ç†"},{"content":"gRPC æ˜¯Googleå¼€å‘çš„ä¸€ä¸ªé«˜æ€§èƒ½RPCæ¡†æ¶ï¼ŒgRPC é»˜è®¤å†…ç½®äº†ä¸¤ç§è®¤è¯æ–¹å¼ï¼š\nSSL/TLS è®¤è¯æ–¹å¼ åŸºäº Token çš„è®¤è¯æ–¹å¼\næ²¡æœ‰å¯ç”¨è¯ä¹¦çš„gRPCæœåŠ¡å’Œå®¢æˆ·ç«¯è¿›è¡Œçš„æ˜¯æ˜æ–‡é€šä¿¡ï¼Œä¿¡æ¯é¢ä¸´è¢«ä»»ä½•ç¬¬ä¸‰æ–¹ç›‘å¬çš„é£é™©ã€‚ä¸ºäº†ä¿è¯gRPCé€šä¿¡ä¸è¢«ç¬¬ä¸‰æ–¹ç›‘å¬ã€ç¯¡æ”¹æˆ–ä¼ªé€ ï¼Œå¯ä»¥å¯¹æœåŠ¡å™¨å¯åŠ¨TLSåŠ å¯†ç‰¹æ€§ã€‚\nä» go 1.15 ç‰ˆæœ¬å¼€å§‹åºŸå¼ƒ CommonNameï¼Œå› æ­¤æ¨èä½¿ç”¨ SAN è¯ä¹¦ã€‚å¦‚æœæŒ‰ç…§ä¹‹å‰çš„æ­¥éª¤é€šè¿‡ OpenSSL æ¥ç”Ÿæˆå¯†é’¥ã€CSRã€è¯ä¹¦ï¼Œä¼šå‡ºç°è¿™æ ·çš„é”™è¯¯ï¼š 1 rpc error: code = Unavailable desc = connection error: desc = \u0026#34;transport: authentication handshake failed: x509: certificate relies on legacy Common Name field, use SANs instead\u0026#34;| This article was first published in the Medium MPP plan. If you are a Medium user, please follow me on Medium. Thank you very much.\nä»€ä¹ˆæ˜¯SAN SAN(Subject Alternative Name) æ˜¯Â SSLÂ æ ‡å‡†Â x509Â ä¸­å®šä¹‰çš„ä¸€ä¸ªæ‰©å±•ã€‚ä½¿ç”¨äº†Â SANÂ å­—æ®µçš„Â SSLÂ è¯ä¹¦ï¼Œå¯ä»¥æ‰©å±•æ­¤è¯ä¹¦æ”¯æŒçš„åŸŸåï¼Œä½¿å¾—ä¸€ä¸ªè¯ä¹¦å¯ä»¥æ”¯æŒå¤šä¸ªä¸åŒåŸŸåçš„è§£æã€‚\né€šä¿—ç‚¹å°±æ˜¯ï¼Œåœ¨ SAN è¯ä¹¦ä¸­ï¼Œå¯ä»¥æœ‰å¤šä¸ªå®Œæ•´çš„ CNï¼ˆCommonNameï¼‰ï¼Œè¿™æ ·åªéœ€è¦è´­ä¹°ä¸€ä¸ªè¯ä¹¦å°±å¯ä»¥ç”¨åœ¨å¤šä¸ª URLã€‚æ¯”å¦‚ skype.com çš„è¯ä¹¦ï¼Œå®ƒå°±æœ‰å¾ˆå¤š SANã€‚\nåœ¨æœ¬åœ°åˆ›å»ºSAN è¯ä¹¦ ä¸‹é¢ æˆ‘ä»¬å°†ç”¨ä¸€ä¸ªä¾‹å­åœ¨æœ¬åœ°ç”Ÿæˆ å®¢æˆ·ç«¯\u0026amp;æœåŠ¡ç«¯åŒå‘SAN è¯ä¹¦ã€‚\nå‡è®¾gRPCæœåŠ¡ç«¯çš„ä¸»æœºåä¸ºlocalhostï¼Œéœ€è¦ä¸ºgRPCæœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ä¹‹é—´çš„é€šä¿¡é…ç½®tlsåŒå‘è®¤è¯åŠ å¯†ã€‚\næ–°å»º openssl.conf æ¥æ”¾ç›¸å…³ä¿¡æ¯ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 [req] req_extensions = v3_req distinguished_name = req_distinguished_name prompt = no [req_distinguished_name] countryName = CN stateOrProvinceName = state localityName = city organizationName = huizhou92 commonName = hello-world [v3_req] subjectAltName = @alt_names [alt_names] DNS.1 = localhost å…¶ä¸­å†…å®¹ è·Ÿ ä»¥å‰åˆ›å»ºcaçš„æ—¶å€™å·®ä¸å¤šã€‚\n2. ç”Ÿæˆcaæ ¹è¯ä¹¦\n1 openssl req -x509 -newkey rsa:4096 -keyout ca.key -out ca.crt -subj \u0026#34;/CN=localhost\u0026#34; -days 3650 -nodes -nodes æ˜¯å¿½ç•¥å¯†ç ,æ–¹ä¾¿ä½¿ç”¨ï¼Œä½†æ˜¯è¯·æ³¨æ„ï¼Œè¿™å¯èƒ½ä¼šé™ä½ç§é’¥çš„å®‰å…¨æ€§ï¼Œå› ä¸ºä»»ä½•äººéƒ½å¯ä»¥è¯»å–æœªåŠ å¯†çš„ç§é’¥ã€‚\n3. ç”ŸæˆæœåŠ¡ç«¯è¯ä¹¦\n1 2 openssl req -newkey rsa:2048 -nodes -keyout server.key -out server.csr -subj \u0026#34;/CN=localhost\u0026#34; -config openssl.cnf openssl x509 -req -in server.csr -out server.crt -CA ca.crt -CAkey ca.key -CAcreateserial -days 365 -extensions v3_req -extfile openssl.cnf ç”Ÿæˆå®¢æˆ·ç«¯è¯ä¹¦ 1 2 3 openssl req -newkey rsa:2048 -nodes -keyout client.key -out client.csr -subj \u0026#34;/CN=localhost\u0026#34; -config openssl.cnf openssl x509 -req -in client.csr -out client.crt -CA ca.crt -CAkey ca.key -CAcreateserial -days 365 -extensions v3_req -extfile openssl.cnf æœ€ç»ˆç”Ÿæˆçš„ç»“æœå¦‚ä¸‹\n1 2 âœ keys git:(day1) âœ— ls ca.crt ca.key ca.srl client.crt client.csr client.key openssl.cnf server.crt server.csr server.key æµ‹è¯• æˆ‘ä»¬å®šä¹‰ä¸€ä¸ªæœ€ç®€å•çš„grpcæ¥å£\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 // helloworld.proto syntax = \u0026#34;proto3\u0026#34;; option go_package = \u0026#34;./api;api\u0026#34;; package api; // The greeting service definition. service Greeter { // Sends a greeting rpc SayHello (HelloRequest) returns (HelloReply) {} } // The request message containing the user\u0026#39;s name. message HelloRequest { string name = 1; } // The response message containing the greetings message HelloReply { string message = 1; } æœåŠ¡ç«¯å®ç° 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 package main import ( \u0026#34;context\u0026#34; \u0026#34;crypto/tls\u0026#34; \u0026#34;crypto/x509\u0026#34; \u0026#34;fmt\u0026#34; \u0026#34;google.golang.org/genproto/googleapis/rpc/errdetails\u0026#34; \u0026#34;google.golang.org/grpc\u0026#34; \u0026#34;google.golang.org/grpc/codes\u0026#34; \u0026#34;google.golang.org/grpc/credentials\u0026#34; \u0026#34;google.golang.org/grpc/status\u0026#34; \u0026#34;hello-world/api\u0026#34; \u0026#34;io\u0026#34; \u0026#34;log\u0026#34; \u0026#34;net\u0026#34; \u0026#34;os\u0026#34; \u0026#34;time\u0026#34; ) type server struct { api.UnimplementedGreeterServer } func (s *server) SayHello(ctx context.Context, in *api.HelloRequest) (*api.HelloReply, error) { log.Printf(\u0026#34;Received: %v\u0026#34;, in.GetName()) select { case \u0026lt;-ctx.Done(): log.Println(\u0026#34;client timeout return\u0026#34;) return nil, ErrorWithDetails() case \u0026lt;-time.After(3 * time.Second): return \u0026amp;api.HelloReply{Message: \u0026#34;Hello \u0026#34; + in.GetName()}, nil } } func main() { certificate, err := tls.LoadX509KeyPair(\u0026#34;./keys/server.crt\u0026#34;, \u0026#34;./keys/server.key\u0026#34;) if err != nil { log.Fatalf(\u0026#34;Failed to load key pair: %v\u0026#34;, err) } // é€šè¿‡CAåˆ›å»ºè¯ä¹¦æ±  certPool := x509.NewCertPool() ca, err := os.ReadFile(\u0026#34;./keys/ca.crt\u0026#34;) if err != nil { log.Fatalf(\u0026#34;Failed to read ca: %v\u0026#34;, err) } // å°†æ¥è‡ªCAçš„å®¢æˆ·ç«¯è¯ä¹¦é™„åŠ åˆ°è¯ä¹¦æ±  if ok := certPool.AppendCertsFromPEM(ca); !ok { log.Fatalf(\u0026#34;Failed to append ca certificate\u0026#34;) } opts := []grpc.ServerOption{ grpc.Creds( // ä¸ºæ‰€æœ‰ä¼ å…¥çš„è¿æ¥å¯ç”¨TLS credentials.NewTLS(\u0026amp;tls.Config{ ClientAuth: tls.RequireAndVerifyClientCert, Certificates: []tls.Certificate{certificate}, ClientCAs: certPool, }, )), } listen, err := net.Listen(\u0026#34;tcp\u0026#34;, fmt.Sprintf(\u0026#34;0.0.0.0:%d\u0026#34;, 50051)) if err != nil { log.Fatalf(\u0026#34;failed to listen %d port\u0026#34;, 50051) } // é€šè¿‡ä¼ å…¥çš„TLSæœåŠ¡å™¨å‡­è¯åˆ›å»ºæ–°çš„gRPCæœåŠ¡å®ä¾‹ s := grpc.NewServer(opts...) api.RegisterGreeterServer(s, \u0026amp;server{}) log.Printf(\u0026#34;server listening at %v\u0026#34;, listen.Addr()) if err := s.Serve(listen); err != nil { log.Fatalf(\u0026#34;Failed to serve: %v\u0026#34;, err) } } func ErrorWithDetails() error { st := status.Newf(codes.Internal, fmt.Sprintf(\u0026#34;something went wrong: %v\u0026#34;, \u0026#34;api.Getter\u0026#34;)) v := \u0026amp;errdetails.PreconditionFailure_Violation{ //errDetails Type: \u0026#34;test\u0026#34;, Subject: \u0026#34;12\u0026#34;, Description: \u0026#34;32\u0026#34;, } br := \u0026amp;errdetails.PreconditionFailure{} br.Violations = append(br.Violations, v) st, _ = st.WithDetails(br) return st.Err() } æˆ‘ä»¬ç›´æ¥è¿è¡ŒæœåŠ¡ç«¯ go run main.go\nå®¢æˆ·ç«¯ é¦–å…ˆæˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªä¸å¸¦è¯ä¹¦çš„è¯·æ±‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 func Test_server_SayHello_No_Cert(t *testing.T) { conn, err := grpc.Dial(\u0026#34;localhost:50051\u0026#34;, grpc.WithTransportCredentials(insecure.NewCredentials())) if err != nil { log.Fatalf(\u0026#34;Connect to %s failed\u0026#34;, \u0026#34;localhost:50051\u0026#34;) } defer conn.Close() client := api.NewGreeterClient(conn) // åˆ›å»ºå¸¦æœ‰è¶…æ—¶æ—¶é—´çš„ä¸Šä¸‹æ–‡, cancelå¯ä»¥å–æ¶ˆä¸Šä¸‹æ–‡ ctx, cancel := context.WithTimeout(context.Background(), time.Second*5) defer cancel() // ä¸šåŠ¡ä»£ç å¤„ç†éƒ¨åˆ† ... r, err := client.SayHello(ctx, \u0026amp;api.HelloRequest{Name: \u0026#34;Hello\u0026#34;}) if err != nil { log.Printf(\u0026#34;Failed to greet, error: %v\u0026#34;, err) } else { log.Printf(\u0026#34;Greeting: %v\u0026#34;, r.GetMessage()) } // Set up a connection to the server. log.Printf(\u0026#34;Greeting: %s\u0026#34;, r.GetMessage()) } è¾“å‡º\n1 2024/05/12 19:18:51 Failed to greet, error: rpc error: code = Unavailable desc = connection error: desc = \u0026#34;error reading server preface: EOF\u0026#34; æœåŠ¡ä¸å¯ç”¨\næˆ‘ä»¬å†ä½¿ç”¨ä¸€ä¸ªæºå¸¦è¯ä¹¦çš„è¯·è¯·æ±‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 func Test_server_SayHello(t *testing.T) { certificate, err := tls.LoadX509KeyPair(\u0026#34;./keys/client.crt\u0026#34;, \u0026#34;./keys/client.key\u0026#34;) if err != nil { log.Fatalf(\u0026#34;Failed to load client key pair, %v\u0026#34;, err) } certPool := x509.NewCertPool() ca, err := os.ReadFile(\u0026#34;./keys/ca.crt\u0026#34;) if err != nil { log.Fatalf(\u0026#34;Failed to read %s, error: %v\u0026#34;, \u0026#34;./keys/ca.crt\u0026#34;, err) } if ok := certPool.AppendCertsFromPEM(ca); !ok { log.Fatalf(\u0026#34;Failed to append ca certs\u0026#34;) } opts := []grpc.DialOption{ grpc.WithTransportCredentials(credentials.NewTLS( \u0026amp;tls.Config{ ServerName: \u0026#34;localhost\u0026#34;, Certificates: []tls.Certificate{certificate}, RootCAs: certPool, })), } // conn, err := grpc.Dial(*addr, grpc.WithTransportCredentials(insecure.NewCredentials())) conn, err := grpc.Dial(\u0026#34;localhost:50051\u0026#34;, opts...) if err != nil { log.Fatalf(\u0026#34;Connect to %s failed\u0026#34;, \u0026#34;localhost:50051\u0026#34;) } defer conn.Close() client := api.NewGreeterClient(conn) // åˆ›å»ºå¸¦æœ‰è¶…æ—¶æ—¶é—´çš„ä¸Šä¸‹æ–‡, cancelå¯ä»¥å–æ¶ˆä¸Šä¸‹æ–‡ ctx, cancel := context.WithTimeout(context.Background(), time.Second*5) defer cancel() // ä¸šåŠ¡ä»£ç å¤„ç†éƒ¨åˆ† ... r, err := client.SayHello(ctx, \u0026amp;api.HelloRequest{Name: \u0026#34;Hello\u0026#34;}) if err != nil { log.Printf(\u0026#34;Failed to greet, error: %v\u0026#34;, err) } else { log.Printf(\u0026#34;Greeting: %v\u0026#34;, r.GetMessage()) } // Set up a connection to the server. log.Printf(\u0026#34;Greeting: %s\u0026#34;, r.GetMessage()) } è¾“å‡º\n1 2 === RUN Test_server_SayHello 2024/05/12 19:20:17 Greeting: Hello Hello æ€»ç»“ æˆ‘ä»¬å¯ä»¥ä½¿ç”¨tlså®ç°gRPC çš„åŠ å¯†é€šä¿¡ï¼Œ ä»go1.15 å¼€å§‹ï¼Œgoä¸å»ºè®®ä½¿ç”¨CAè€Œæ˜¯ä½¿ç”¨SANè¯ä¹¦ ","date":"2024-06-29T21:41:50+08:00","image":"https://images.yixiao9206.cn/blog-images/2024/05/4976a194a8daca00ff6991a866c2ee53.png","permalink":"https://huizhou92.com/zh-cn/p/%E4%BD%BF%E7%94%A8%E8%87%AA%E7%AD%BE%E5%90%8D%E8%AF%81%E4%B9%A6san%E4%B8%BAgrpc%E5%BB%BA%E7%AB%8Btls-%E8%BF%9E%E6%8E%A5/","title":" ä½¿ç”¨è‡ªç­¾åè¯ä¹¦SANä¸ºgRPCå»ºç«‹TLS è¿æ¥"},{"content":"ç½‘é¡µè®¾è®¡å’Œå¼€å‘æ˜¯ä¸€ä¸ªä¸æ–­è¿›åŒ–çš„é¢†åŸŸï¼Œè®¾è®¡å¸ˆå’Œå‰ç«¯å¼€å‘è€…ä»¬ç»å¸¸é¢ä¸´ä¸€ä¸ªå…±åŒçš„æŒ‘æˆ˜ï¼šå¦‚ä½•å¿«é€Ÿã€é«˜æ•ˆåœ°å°†æ¦‚å¿µåŒ–çš„è®¾è®¡è‰å›¾è½¬åŒ–ä¸ºå®é™…å¯ç”¨çš„ HTML ä»£ç ã€‚è¿™ä¸€è¿‡ç¨‹ä¸ä»…è€—æ—¶è€Œä¸”å®¹æ˜“å‡ºé”™ï¼Œå°¤å…¶æ˜¯åœ¨å°†å¤æ‚çš„è®¾è®¡æƒ³æ³•å…·ä½“å®ç°æ—¶ã€‚åœ¨åˆæ­¥è®¾è®¡é˜¶æ®µï¼Œå¾€å¾€éœ€è¦é¢‘ç¹åœ°ä¿®æ”¹å’Œè°ƒæ•´ï¼Œå¦‚æœæ¯ä¸€æ¬¡ä¿®æ”¹éƒ½éœ€è¦æ‰‹åŠ¨ç¼–å†™ä»£ç ï¼Œæ— ç–‘ä¼šå¤§å¤§æ‹–æ…¢é¡¹ç›®çš„è¿›åº¦ï¼Œå¢åŠ é¡¹ç›®æˆæœ¬ã€‚\nThis article is first published in the medium MPP plan. If you are a medium user, please follow me in medium. Thank you very much.\nç›®å‰æˆ‘ä»¬æˆ‘ä»¬æœ‰ä¸¤ç§åŠæ³•è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œç¬¬ä¸€ç§æ˜¯ä½ä»£ç æ¨¡å¼ï¼Œç¬¬äºŒç§æ˜¯ä½¿ç”¨AIã€‚æˆ‘ä¸ªäººè®¤ä¸ºï¼ŒAiå°†ä¼šåˆå¹¶ä½ä»£ç æ¨¡å¼ï¼Œç›®å‰å·²ç»æœ‰å¾ˆå¤šå•†ä¸šå…¬å¸åœ¨åšè¿™ä»¶äº‹æƒ…äº†ï¼Œä»Šå¤©çš„ä¸»è§’æ˜¯ä¸€ä¸ªåœ¨GitHubä¸Šæœ‰ä¸€ä¸ªè¶…è¿‡13k star çš„é¡¹ç›®â draw-a-ui å®ƒæ˜¯è¿™æ ·æè¿°è‡ªå·±çš„\nDraw a mockup and generate html for it\ndraw-a-ui å®ƒæ˜¯åŸºäº tldraw å’Œ gpt-4-vision apiï¼Œæ—¨åœ¨é€šè¿‡ç”¨æˆ·ç»˜åˆ¶çš„çº¿æ¡†å›¾è‡ªåŠ¨ç”Ÿæˆ HTML ä»£ç ã€‚ç”¨æˆ·åªéœ€ç»˜åˆ¶ä¸€ä¸ªæ¨¡æ‹Ÿç•Œé¢çš„è‰å›¾ï¼Œdraw-a-uiÂ å°±èƒ½å°†å…¶è½¬æ¢ä¸ºé…å¤‡ Tailwind CSS çš„ HTML æ–‡ä»¶ï¼Œæå¤§ç¼©çŸ­ä»è®¾è®¡åˆ°å¼€å‘çš„æ—¶é—´ã€‚é¡¹ç›®ç›®å‰å°šå¤„äºå¼€å‘é˜¶æ®µï¼Œä½†æ ¸å¿ƒåŠŸèƒ½â€”â€”å°†ç»˜å›¾ç”»å¸ƒçš„ SVG è½¬æ¢ä¸º PNGï¼Œå†å°†è¯¥ PNG ä¼ é€ç»™ gpt-4-vision ä»¥æŒ‡ä»¤å½¢å¼è¿”å›å•ä¸ª HTML æ–‡ä»¶â€”â€”å·²ç»å®Œå–„ã€‚\nä½¿ç”¨è¿™ä¸ªé¡¹ç›®å¾ˆç®€å•ï¼Œ å…‹éš†ä¸‹æ¥ï¼Œç„¶åé…ç½®ä¸€ä¸‹ä½ çš„openai keyå°±å¥½\n1 2 3 echoÂ \u0026#34;OPENAI_API_KEY=sk-your-key\u0026#34;Â \u0026gt;Â .env.local npmÂ install npmÂ runÂ dev ç„¶åä½ å°±èƒ½ é€šè¿‡ http://localhost:3000 è®¿é—®äº†ã€‚\nhttps://github.com/SawyerHood/draw-a-ui/blob/main/demo.gif\nå®ƒæ”¯æŒåœ¨çº¿è®¾è®¡ï¼Œä¹Ÿæ”¯æŒä¸Šä¼ png å›¾åƒ, æ¯”å¦‚æˆ‘å°† medium ä¸»é¡µæˆªå›¾ï¼Œç„¶åä¸Šä¼ ä¸Šå»ã€‚ç­‰å¾…20s å·¦å³ï¼ˆå½•å±æœ‰åŠ é€Ÿï¼‰,æˆ‘ä»¬å°±èƒ½å¾—åˆ°ç»“æœã€‚\nå°½ç®¡ç›®å‰ draw-a-ui é¡¹ç›®æ ‡æ³¨ä¸ºæ¼”ç¤ºç”¨é€”ï¼Œå¹¶ä¸å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ç›´æ¥ä½¿ç”¨ï¼Œç›®å‰çœ‹æ¥ç”Ÿæˆçš„ä½†å…¶èƒŒåçš„ç†å¿µå’ŒæŠ€æœ¯å®ç°æ— ç–‘å±•ç°äº†æœªæ¥å¼€å‘çš„è¶‹åŠ¿ã€‚è¯¥é¡¹ç›®åˆ©ç”¨æœ€æ–°çš„äººå·¥æ™ºèƒ½æŠ€æœ¯ï¼ˆå¦‚ GPT-4ï¼‰ï¼Œä¸ºå‰ç«¯å¼€å‘å¸¦æ¥äº†é©å‘½æ€§çš„å·¥ä½œæ¨¡å¼æ”¹å˜ã€‚\næˆ‘çœŸçš„å¾ˆæœŸå¾…è¿™ä¸ªæŠ€æœ¯ï¼Œæ¯•ç«Ÿæˆ‘è®¨åŒå†™cssã€‚ğŸ¶\n","date":"2024-06-26T18:21:43+08:00","permalink":"https://huizhou92.com/zh-cn/p/%E8%AE%BE%E8%AE%A1%E7%A8%BF%E7%94%9F%E6%88%90%E4%BB%A3%E7%A0%81web%E5%BC%80%E5%8F%91%E7%9A%84%E6%9C%AA%E6%9D%A5/","title":"è®¾è®¡ç¨¿ç”Ÿæˆä»£ç ï¼Œwebå¼€å‘çš„æœªæ¥ï¼Ÿ"},{"content":"ä»€ä¹ˆæ˜¯ ä¸€è‡´æ€§hash ç®—æ³• é¦–å…ˆæ‘˜æŠ„ä¸€æ®µç»´åŸºç™¾ç§‘çš„å®šä¹‰\nä¸€è‡´å“ˆå¸Œ æ˜¯ä¸€ç§ç‰¹æ®Šçš„å“ˆå¸Œç®—æ³•ã€‚åœ¨ä½¿ç”¨ä¸€è‡´å“ˆå¸Œç®—æ³•åï¼Œå“ˆå¸Œè¡¨æ§½ä½æ•°ï¼ˆå¤§å°ï¼‰çš„æ”¹å˜å¹³å‡åªéœ€è¦å¯¹ğ¾/ğ‘› ä¸ªå…³é”®å­—é‡æ–°æ˜ å°„ï¼Œå…¶ä¸­ ğ¾ æ˜¯å…³é”®å­—çš„æ•°é‡ï¼Œğ‘›æ˜¯æ§½ä½æ•°é‡ã€‚ç„¶è€Œåœ¨ä¼ ç»Ÿçš„å“ˆå¸Œè¡¨ä¸­ï¼Œæ·»åŠ æˆ–åˆ é™¤ä¸€ä¸ªæ§½ä½çš„å‡ ä¹éœ€è¦å¯¹æ‰€æœ‰å…³é”®å­—è¿›è¡Œé‡æ–°æ˜ å°„ã€‚ \u0026mdash; wikipedia\nåˆ†å¸ƒå¼ç³»ç»Ÿä¸­, ä¸€è‡´æ€§hashæ— å¤„ä¸åœ¨ï¼ŒCDNï¼ŒKVï¼Œè´Ÿè½½å‡è¡¡ç­‰åœ°æ–¹éƒ½æœ‰å®ƒçš„å½±å­ï¼Œæ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿçš„åŸºçŸ³ç®—æ³•ä¹‹ä¸€ã€‚ä¸€è‡´æ€§hash æœ‰ä»¥ä¸‹å‡ ä¸ªä¼˜ç‚¹ã€‚\nå‡è¡¡è´Ÿè½½ï¼š ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•èƒ½å¤Ÿå°†æ•°æ®åœ¨èŠ‚ç‚¹ä¸Šå‡åŒ€åˆ†å¸ƒã€‚ æ‰©å±•æ€§ï¼š åœ¨ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•ä¸­ï¼Œå½“èŠ‚ç‚¹æ•°é‡å¢åŠ æˆ–å‡å°‘æ—¶ï¼Œåªæœ‰éƒ¨åˆ†æ•°æ®éœ€è¦é‡æ–°æ˜ å°„ï¼Œç³»ç»Ÿèƒ½å¤Ÿè¿›è¡Œæ°´å¹³æ‰©å±•æ›´å®¹æ˜“ï¼Œå¯ä»¥å¢åŠ èŠ‚ç‚¹æ•°é‡ä»¥åº”å¯¹æ›´å¤§çš„è´Ÿè½½éœ€æ±‚ï¼› å‡å°‘æ•°æ®è¿ç§»ï¼š ç›¸æ¯”ä¼ ç»Ÿçš„å“ˆå¸Œç®—æ³•ï¼Œä¸€è‡´æ€§å“ˆå¸Œç®—æ³•åœ¨èŠ‚ç‚¹å¢å‡æ—¶éœ€è¦é‡æ–°æ˜ å°„çš„æ•°æ®é‡è¾ƒå°‘ï¼Œå¯ä»¥å¤§å¹…é™ä½æ•°æ®è¿ç§»çš„å¼€é”€ï¼Œå‡å°‘ç³»ç»Ÿçš„ä¸ç¨³å®šæ€§å’Œå»¶è¿Ÿï¼›\næœ¬ç¯‡æ–‡ç« çš„ç›®æ ‡å°±æ˜¯å­¦ä¹ ä¸€è‡´æ€§hash ç®—æ³•ä»¥åŠå®ƒçš„ç®€å•å®ç°ã€‚ This article is first published in the medium MPP plan. If you are a medium user, please follow me in medium. Thank you very much.\nä¸€è‡´æ€§hashç®—æ³•çš„åŸç† åŸºæœ¬ä¸€è‡´æ€§hash ç®—æ³• æœ€åŸºç¡€çš„ä¸€è‡´æ€§ hash ç®—æ³•å°±æ˜¯æŠŠèŠ‚ç‚¹ç›´æ¥åˆ†å¸ƒåˆ°ç¯ä¸Šï¼Œä»è€Œåˆ’åˆ†å‡ºå€¼åŸŸï¼Œ key ç»è¿‡Â hash( x )Â ä¹‹åï¼Œè½åˆ°ä¸åŒçš„å€¼åŸŸï¼Œåˆ™ç”±å¯¹åº”çš„èŠ‚ç‚¹å¤„ç†ã€‚æœ€å¸¸è§çš„å€¼åŸŸç©ºé—´å¤§å°æ˜¯ï¼š2^32 - 1ï¼ŒèŠ‚ç‚¹è½åˆ°è¿™ä¸ªç©ºé—´ï¼Œæ¥åˆ’åˆ†ä¸åŒèŠ‚ç‚¹æ‰€å±çš„å€¼åŸŸã€‚å¦‚å›¾æ‰€ç¤ºã€‚\nNode A å­˜å‚¨ çš„ hash èŒƒå›´ä¸º [0,2^12) .\nNode B å­˜å‚¨ çš„ hash èŒƒå›´ä¸º [2^12,2^28) .\nNode C å­˜å‚¨ çš„ hash èŒƒå›´ä¸º [2^28,0) .\nä¸Šè¿°åŸºæœ¬çš„ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•æœ‰æ˜æ˜¾çš„ç¼ºç‚¹ï¼š\néšæœºåˆ†å¸ƒèŠ‚ç‚¹çš„æ–¹å¼ä½¿å¾—å¾ˆéš¾å‡åŒ€çš„åˆ†å¸ƒå“ˆå¸Œå€¼åŸŸï¼Œä»ä¸Šé¢å¯ä»¥çœ‹å‡ºï¼Œä¸‰ä¸ªèŠ‚ç‚¹å­˜å‚¨çš„æ•°æ®ä¸å‡åŒ€ã€‚ åœ¨åŠ¨æ€å¢åŠ èŠ‚ç‚¹åï¼ŒåŸå…ˆçš„åˆ†å¸ƒå°±ç®—å‡åŒ€ä¹Ÿå¾ˆéš¾å†ç»§ç»­ä¿è¯å‡åŒ€ï¼› å¢åˆ èŠ‚ç‚¹å¸¦æ¥çš„ä¸€ä¸ªè¾ƒä¸ºä¸¥é‡çš„ç¼ºç‚¹æ˜¯ï¼š å½“ä¸€ä¸ªèŠ‚ç‚¹å¼‚å¸¸æ—¶ï¼Œè¯¥èŠ‚ç‚¹çš„å‹åŠ›å…¨éƒ¨è½¬ç§»åˆ°ç›¸é‚»çš„ä¸€ä¸ªèŠ‚ç‚¹ï¼› å½“ä¸€ä¸ªæ–°èŠ‚ç‚¹åŠ å…¥æ—¶åªèƒ½ä¸ºä¸€ä¸ªç›¸é‚»èŠ‚ç‚¹åˆ†æ‘Šå‹åŠ›ï¼› è™šæ‹ŸèŠ‚ç‚¹ Goè¯­è¨€ä¹‹çˆ¶ rob pike æ›¾ä»Šè¯´è¿‡ è®¡ç®—æœºé¢†åŸŸé‡Œï¼Œæ²¡æœ‰ä»€ä¹ˆé—®é¢˜æ˜¯åŠ ä¸€å±‚é—´æ¥å¯»å€è§£å†³ä¸äº†çš„. ä¸€è‡´æ€§hash ä¹Ÿæ˜¯ä¸€æ ·ã€‚\nå¦‚æœä¸‰ä¸ªèŠ‚ç‚¹ å­˜åœ¨ä¸å‡è¡¡çš„é—®é¢˜ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±æŠŠä»–è™šæ‹ŸæˆNä¸ªèŠ‚ç‚¹ã€‚A[a1,a2\u0026hellip;.a1024], ç„¶åå°†ä»–ä»¬æ˜ å°„åˆ°hash_ring ä¸Šï¼Œå°±æ˜¯è¿™æ ·æ ·å­çš„ã€‚\næ¯ä¸ªè™šæ‹ŸèŠ‚ç‚¹éƒ½æœ‰å¯¹åº”çš„hashåŒºé—´ã€‚è´Ÿè´£ä¸€æ®µkeyï¼Œç„¶åæ ¹æ®è™šæ‹Ÿnode çš„åå­—æ‰¾åˆ°å¯¹åº”çš„ç‰©ç†nodeè¯»å†™æ•°æ®ã€‚\nå¼•å…¥è™šæ‹ŸèŠ‚ç‚¹åï¼Œå°±å®Œç¾çš„è§£å†³äº†ä¸Šé¢çš„ä¸‰ä¸ªé—®é¢˜ã€‚\nåªè¦æˆ‘ä»¬çš„è™šæ‹ŸèŠ‚ç‚¹è¶³å¤Ÿå¤šï¼Œå„ä¸ªèŠ‚ç‚¹çš„æ•°æ®å°±èƒ½å¹³è¡¡ï¼Œï¼ˆâš ï¸ï¼šè¿™ä¸ªå†å·¥ç¨‹ä¸Šæ˜¯æœ‰ä»£ä»·çš„ï¼‰ å¦‚æœä¸€ä¸ªèŠ‚ç‚¹å®•æœºäº†ï¼Œå®ƒçš„æ•°æ®ä¼šå‡è¡¡çš„åˆ†å¸ƒåˆ°æ•´ä¸ªé›†ç¾¤æ‰€æœ‰èŠ‚ç‚¹ï¼ŒåŒç†ï¼Œæ–°å¢çš„èŠ‚ç‚¹ ä¹Ÿèƒ½è´Ÿæ‹…æ‰€æœ‰èŠ‚ç‚¹çš„å‹åŠ›ã€‚ goè¯­è¨€å®ç° å®Œæ•´çš„ä»£ç ï¼šhttps://github.com/hxzhouh/blog-example/tree/main/Distributed/consistent_hashing\né¦–å…ˆå®šä¹‰ä¸€ä¸ªhash_ring, ä½¿ç”¨ crc32.ChecksumIEEE ä½œä¸ºé»˜è®¤çš„hash function\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 type VirtualNode struct { // è™šæ‹ŸèŠ‚ç‚¹ Hash uint32 Node *Node } type Node struct { // ç‰©ç†èŠ‚ç‚¹ ID string Addr string } type HashRing struct { Nodes map[string]*Node VirtualNodes []VirtualNode. mu sync.Mutex hash HashFunc } func NewHashRing(hash HashFunc) *HashRing { if hash == nil { hash = crc32.ChecksumIEEE } return \u0026amp;HashRing{ Nodes: make(map[string]*Node), VirtualNodes: make([]VirtualNode, 0), hash: hash, } } æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹æ€ä¹ˆæ·»åŠ èŠ‚ç‚¹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 func (hr *HashRing) AddNode(node *Node) { hr.mu.Lock() defer hr.mu.Unlock() hr.Nodes[node.ID] = node for i := 0; i \u0026lt; VirtualNodesPerNode; i++ { virtualNodeID := fmt.Sprintf(\u0026#34;%s-%d\u0026#34;, node.ID, i) hash := hr.hash([]byte(virtualNodeID)) hr.VirtualNodes = append(hr.VirtualNodes, VirtualNode{Hash: hash, Node: node}) } sort.Slice(hr.VirtualNodes, func(i, j int) bool { return hr.VirtualNodes[i].Hash \u0026lt; hr.VirtualNodes[j].Hash }) } æˆ‘ä»¬æ¯æ·»åŠ ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå°±è¦åˆ›å»ºå¯¹åº”æ•°é‡çš„è™šæ‹ŸèŠ‚ç‚¹ï¼Œå¹¶ä¸”è¦ä¿è¯è™šæ‹ŸèŠ‚ç‚¹æœ‰åºï¼ˆè¿™æ ·æ‰èƒ½æŸ¥æ‰¾ï¼‰\nåŒæ ·ï¼Œremove çš„æ—¶å€™ï¼Œä¹Ÿéœ€è¦åˆ é™¤è™šæ‹ŸèŠ‚ç‚¹\n1 2 3 4 5 6 7 8 9 10 11 12 13 func (hr *HashRing) RemoveNode(nodeID string) { hr.mu.Lock() defer hr.mu.Unlock() delete(hr.Nodes, nodeID) virtualNodes := make([]VirtualNode, 0) for _, vn := range hr.VirtualNodes { if vn.Node.ID != nodeID { virtualNodes = append(virtualNodes, vn) } } hr.VirtualNodes = virtualNodes } æŸ¥è¯¢çš„æ—¶å€™ï¼Œæˆ‘ä»¬å…ˆæ‰¾åˆ°å¯¹åº”çš„è™šæ‹ŸèŠ‚ç‚¹ï¼Œç„¶åå†æ ¹æ®è™šæ‹ŸèŠ‚ç‚¹æ‰¾åˆ°å¯¹åº”çš„ç‰©ç†èŠ‚ç‚¹\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 func (hr *HashRing) GetNode(key string) *Node { hr.mu.Lock() defer hr.mu.Unlock() if len(hr.VirtualNodes) == 0 { return nil } hash := hr.hash([]byte(key)) idx := sort.Search(len(hr.VirtualNodes), func(i int) bool { return hr.VirtualNodes[i].Hash \u0026gt;= hash }) if idx == len(hr.VirtualNodes) { idx = 0 } return hr.VirtualNodes[idx].Node } æœ€åæˆ‘ä»¬æ¥çœ‹çœ‹ï¼Œä¸šåŠ¡å¦‚ä½•ä½¿ç”¨ è¿™ä¸ªhash_ring\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 type KVSystem struct { hashRing *HashRing kvStores map[string]*kvstorage.KVStore } func NewKVSystem(nodes int) *KVSystem { hashRing := NewHashRing(crc32.ChecksumIEEE) for i := 0; i \u0026lt; nodes; i++ { // init node node := \u0026amp;Node{ ID: fmt.Sprintf(\u0026#34;Node%d\u0026#34;, i), Addr: fmt.Sprintf(\u0026#34;192.168.1.%d\u0026#34;, i+1), } hashRing.AddNode(node) } kvStores := make(map[string]*kvstorage.KVStore) //init storage for id := range hashRing.Nodes { kvStores[id] = kvstorage.NewKVStore() } return \u0026amp;KVSystem{ hashRing: hashRing, kvStores: kvStores, } } func (kv *KVSystem) Get(key string) (string, bool) { //get value node := kv.hashRing.GetNode(key) return kv.kvStores[node.ID].Get(key) } func (kv *KVSystem) Set(key string, value string) { // set value node := kv.hashRing.GetNode(key) kv.kvStores[node.ID].Set(key, value) } func (kv *KVSystem) Delete(key string) { node := kv.hashRing.GetNode(key) kv.kvStores[node.ID].Delete(key) } // DeleteNode éœ€è¦å°†å­˜å‚¨åœ¨èŠ‚ç‚¹ä¸Šçš„æ•°æ®é‡æ–°åˆ†é…ã€‚ func (kv *KVSystem) DeleteNode(nodeID string) { allData := kv.kvStores[nodeID].GetAll() kv.hashRing.RemoveNode(nodeID) delete(kv.kvStores, nodeID) for key, value := range allData { kv.Set(key, value) } } func (kv *KVSystem) AddNode() { node := \u0026amp;Node{ ID: fmt.Sprintf(\u0026#34;Node%d\u0026#34;, len(kv.hashRing.Nodes)), Addr: fmt.Sprintf(\u0026#34;192.168.1.%d\u0026#34;, len(kv.hashRing.Nodes)+1), } kv.hashRing.AddNode(node) kv.kvStores[node.ID] = kvstorage.NewKVStore() } è¿™æ ·æˆ‘ä»¬å°±å®ç°äº†ä¸€ä¸ªæœ€ç®€å•çš„åŸºäºä¸€è‡´æ€§hashçš„kv å­˜å‚¨ï¼Œæ˜¯ä¸æ˜¯ç‰¹åˆ«ç®€å•? ä½†æ˜¯å®ƒå´æ”¯æ’‘äº†æˆ‘ä»¬æ•´ä¸ªç½‘ç»œä¸–ç•Œçš„è¿è½¬ã€‚\nå‚è€ƒèµ„æ–™ Consistent_hashing\n","date":"2024-06-19T21:22:15+08:00","image":"https://images.yixiao9206.cn/blog-images/2024/06/f3b53488c2407a75d85406be58526010.png","permalink":"https://huizhou92.com/zh-cn/p/%E5%88%86%E5%B8%83%E5%BC%8F%E5%9F%BA%E7%9F%B3%E7%AE%97%E6%B3%951-%E4%B8%80%E8%87%B4%E6%80%A7hash/","title":"åˆ†å¸ƒå¼åŸºçŸ³ç®—æ³•1:  ä¸€è‡´æ€§hash"},{"content":"åœ¨ goè¯­è¨€ä¸­ï¼Œæ­£å¸¸çš„ struct ä¸€å®šæ˜¯éœ€è¦å ç”¨ä¸€å—å†…å­˜çš„ï¼Œä½†æ˜¯æœ‰ä¸€ç§ç‰¹æ®Šæƒ…å†µï¼Œå¦‚æœæ˜¯ä¸€ä¸ªç©ºstructï¼Œé‚£ä¹ˆå®ƒçš„å¤§å°ä¸º0. è¿™æ˜¯æ€ä¹ˆå›äº‹ï¼Œç©ºstruct åˆæœ‰ä»€ä¹ˆç”¨å‘¢ï¼Ÿ\nThis article is first published in the medium MPP plan. If you are a medium user, please follow me in medium. Thank you very much.\n1 2 3 4 5 6 7 8 9 10 11 12 13 type Test struct { A int B string } func main() { fmt.Println(unsafe.Sizeof(new(Test))) fmt.Println(unsafe.Sizeof(struct{}{})) } /* 8 0 */ Empty Struct çš„ ç§˜å¯† ç‰¹æ®Šå˜é‡ï¼šzerobase ç©ºç»“æ„ä½“æ˜¯æ²¡æœ‰å†…å­˜å¤§å°çš„ç»“æ„ä½“ã€‚è¿™å¥è¯æ˜¯æ²¡æœ‰é”™çš„ï¼Œä½†æ˜¯æ›´å‡†ç¡®çš„æ¥è¯´ï¼Œå…¶å®æ˜¯æœ‰ä¸€ä¸ªç‰¹æ®Šèµ·ç‚¹çš„ï¼Œé‚£å°±æ˜¯Â zerobaseÂ å˜é‡ï¼Œè¿™æ˜¯ä¸€ä¸ªÂ uintptrÂ å…¨å±€å˜é‡ï¼Œå ç”¨ 8 ä¸ªå­—èŠ‚ã€‚å½“åœ¨ä»»ä½•åœ°æ–¹å®šä¹‰æ— æ•°ä¸ªÂ struct {}Â ç±»å‹çš„å˜é‡ï¼Œç¼–è¯‘å™¨éƒ½åªæ˜¯æŠŠè¿™ä¸ªÂ zerobaseÂ å˜é‡çš„åœ°å€ç»™å‡ºå»ã€‚æ¢å¥è¯è¯´ï¼Œåœ¨ golang é‡Œé¢ï¼Œæ¶‰åŠåˆ°æ‰€æœ‰å†…å­˜ size ä¸º 0 çš„å†…å­˜åˆ†é…ï¼Œé‚£ä¹ˆå°±æ˜¯ç”¨çš„åŒä¸€ä¸ªåœ°å€Â \u0026amp;zerobaseÂ ã€‚\nä¾‹å¦‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 package main import \u0026#34;fmt\u0026#34; type emptyStruct struct {} func main() { a := struct{}{} b := struct{}{} c := emptyStruct{} fmt.Printf(\u0026#34;%p\\n\u0026#34;, \u0026amp;a) fmt.Printf(\u0026#34;%p\\n\u0026#34;, \u0026amp;b) fmt.Printf(\u0026#34;%p\\n\u0026#34;, \u0026amp;c) } // 0x58e360 // 0x58e360 // 0x58e360 ç©ºç»“æ„ä½“çš„å˜é‡çš„å†…å­˜åœ°å€éƒ½æ˜¯ä¸€æ ·çš„ã€‚è¿™æ˜¯å› ä¸ºç¼–è¯‘å™¨åœ¨ç¼–è¯‘æœŸé—´ï¼Œé‡åˆ°Â struct {}Â è¿™ç§ç‰¹æ®Šç±»å‹çš„å†…å­˜åˆ†é…ï¼Œä¼šç»™ä»–åˆ†é…\u0026amp;zerobaseï¼Œè¿™ä¸ªä»£ç é€»è¾‘æ˜¯åœ¨Â mallocgcÂ å‡½æ•°é‡Œé¢ï¼š\n1 2 3 4 5 6 7 //go:linkname mallocgc func mallocgc(size uintptr, typ *_type, needzero bool) unsafe.Pointer { .... if size == 0 { return unsafe.Pointer(\u0026amp;zerobase) } ..... è¿™å°±æ˜¯Empty struct çš„ç§˜å¯†æœ‰äº†è¿™ä¸ªç‰¹æ®Šçš„ å˜é‡ï¼Œæˆ‘ä»¬åˆ©ç”¨å®ƒå¯ä»¥å®Œæˆå¾ˆå¤šåŠŸèƒ½ã€‚\nEmpty struct ä¸å†…å­˜å¯¹å…¶\nä¸€èˆ¬æƒ…å†µä¸‹ï¼Œstruct ä¸­åŒ…å« empty struct ï¼Œè¿™ä¸ªå­—æ®µæ˜¯ä¸å ç”¨å†…å­˜ç©ºé—´çš„ï¼Œä½†æ˜¯æœ‰ä¸€ç§æƒ…å†µæ˜¯ç‰¹æ®Šçš„ï¼Œé‚£å°±æ˜¯ empty struct ä½äºæœ€åä¸€ä½ï¼Œå®ƒä¼šè§¦å‘å†…å­˜å¯¹é½ ã€‚\næ¯”å¦‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 type A struct { x int y string z struct{} } type B struct { x int z struct{} y string } func main() { println(unsafe.Alignof(A{})) println(unsafe.Alignof(B{})) println(unsafe.Sizeof(A{})) println(unsafe.Sizeof(B{})) } /** 8 8 32 24 **/ å› ä¸ºå¦‚æœæœ‰æŒ‡é’ˆæŒ‡å‘è¯¥å­—æ®µ, è¿”å›çš„åœ°å€å°†åœ¨ç»“æ„ä½“ä¹‹å¤–ï¼Œå¦‚æœæ­¤æŒ‡é’ˆä¸€ç›´å­˜æ´»ä¸é‡Šæ”¾å¯¹åº”çš„å†…å­˜ï¼Œå°±ä¼šæœ‰å†…å­˜æ³„éœ²çš„é—®é¢˜ï¼ˆè¯¥å†…å­˜ä¸å› ç»“æ„ä½“é‡Šæ”¾è€Œé‡Šæ”¾ï¼‰ã€‚\nå› æ­¤ï¼Œå½“Â struct{}Â ä½œä¸ºå…¶ä»– struct æœ€åä¸€ä¸ªå­—æ®µæ—¶ï¼Œéœ€è¦å¡«å……é¢å¤–çš„å†…å­˜ä¿è¯å®‰å…¨,å¦‚æœ empty struct åœ¨å¼€å§‹ä½ç½®ï¼Œæˆ–è€…ä¸­é—´ä½ç½®ï¼Œé‚£ä¹ˆå®ƒçš„åœ°å€æ˜¯ä¸‹ä¸€ä¸ªå˜é‡çš„åœ°å€\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 type A struct { x int y string z struct{} } type B struct { x int z struct{} y string } func main() { a := A{} b := B{} fmt.Printf(\u0026#34;%p\\n\u0026#34;, \u0026amp;a.y) fmt.Printf(\u0026#34;%p\\n\u0026#34;, \u0026amp;a.z) fmt.Printf(\u0026#34;%p\\n\u0026#34;, \u0026amp;b.y) fmt.Printf(\u0026#34;%p\\n\u0026#34;, \u0026amp;b.z) } /** 0x1400012c008 0x1400012c018 0x1400012e008 0x1400012e008 **/ Empty çš„ä½¿ç”¨åœºæ™¯ ç©ºç»“æ„ä½“Â struct{ }Â ä¸ºä»€ä¹ˆä¼šå­˜åœ¨çš„æ ¸å¿ƒç†ç”±å°±æ˜¯ä¸ºäº†èŠ‚çœå†…å­˜ã€‚å½“ä½ éœ€è¦ä¸€ä¸ªç»“æ„ä½“ï¼Œä½†æ˜¯å´ä¸æ¯«ä¸å…³ç³»é‡Œé¢çš„å†…å®¹ï¼Œé‚£ä¹ˆå°±å¯ä»¥è€ƒè™‘ç©ºç»“æ„ä½“ã€‚golang æ ¸å¿ƒçš„å‡ ä¸ªå¤åˆç»“æ„Â mapÂ ï¼ŒchanÂ ï¼ŒsliceÂ éƒ½èƒ½ç»“åˆÂ struct{}Â ä½¿ç”¨ã€‚\nmapÂ \u0026amp;Â struct{} 1 2 3 4 5 6 // åˆ›å»º map m := make(map[int]struct{}) // èµ‹å€¼ m[1] = struct{}{} // åˆ¤æ–­ key é”®å­˜ä¸å­˜åœ¨ _, ok := m[1] chanÂ \u0026amp;Â struct{} channelÂ å’ŒÂ struct{}Â ç»“åˆæ˜¯ä¸€ä¸ªæœ€ç»å…¸çš„åœºæ™¯ï¼Œstruct{}Â é€šå¸¸ä½œä¸ºä¸€ä¸ªä¿¡å·æ¥ä¼ è¾“ï¼Œå¹¶ä¸å…³æ³¨å…¶ä¸­å†…å®¹ã€‚chan çš„åˆ†æåœ¨å‰å‡ ç¯‡æ–‡ç« æœ‰è¯¦ç»†è¯´æ˜ã€‚chan æœ¬è´¨çš„æ•°æ®ç»“æ„æ˜¯ä¸€ä¸ªç®¡ç†ç»“æ„åŠ ä¸Šä¸€ä¸ª ringbuffer ï¼Œå¦‚æœÂ struct{}Â ä½œä¸ºå…ƒç´ çš„è¯ï¼Œringbuffer å°±æ˜¯ 0 åˆ†é…çš„ã€‚\nchanÂ å’ŒÂ struct{}Â ç»“åˆåŸºæœ¬åªæœ‰ä¸€ç§ç”¨æ³•ï¼Œå°±æ˜¯ä¿¡å·ä¼ é€’ï¼Œç©ºç»“æ„ä½“æœ¬èº«æºå¸¦ä¸äº†å€¼ï¼Œæ‰€ä»¥ä¹Ÿåªæœ‰è¿™ä¸€ç§ç”¨æ³•å•¦ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œé…åˆ no buffer çš„ channel ä½¿ç”¨ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 // åˆ›å»ºä¸€ä¸ªä¿¡å·é€šé“ waitc := make(chan struct{}) // ... goroutine 1: // å‘é€ä¿¡å·: æŠ•é€’å…ƒç´  waitc \u0026lt;- struct{} // å‘é€ä¿¡å·: å…³é—­ close(waitc) goroutine 2: select { // æ”¶åˆ°ä¿¡å·ï¼Œåšå‡ºå¯¹åº”çš„åŠ¨ä½œ case \u0026lt;-waitc: } è¿™ç§åœºæ™¯æˆ‘ä»¬æ€è€ƒä¸‹ï¼Œæ˜¯å¦ä¸€å®šæ˜¯éÂ struct{}Â ä¸å¯ï¼Ÿå…¶å®ä¸æ˜¯ï¼Œè€Œä¸”ä¹Ÿä¸å¤šè¿™å‡ ä¸ªå­—èŠ‚çš„å†…å­˜ï¼Œæ‰€ä»¥è¿™ç§æƒ…å†µçœŸçš„å°±åªæ˜¯ä¸å…³å¿ƒÂ chanÂ çš„å…ƒç´ å€¼è€Œå·²ï¼Œæ‰€ä»¥æ‰ç”¨çš„Â struct{}ã€‚\næ€»ç»“ ç©ºç»“æ„ä½“ä¹Ÿæ˜¯ç»“æ„ä½“ï¼Œåªæ˜¯ size ä¸º 0 çš„ç±»å‹è€Œå·²ï¼› æ‰€æœ‰çš„ç©ºç»“æ„ä½“éƒ½æœ‰ä¸€ä¸ªå…±åŒçš„åœ°å€ï¼šzerobaseÂ çš„åœ°å€ï¼› æˆ‘ä»¬å¯ä»¥åˆ©ç”¨empty struct ä¸å ç”¨å†…å­˜çš„ç‰¹æ€§ï¼Œæ¥ä¼˜åŒ–ä»£ç ï¼Œæ¯”å¦‚åˆ©ç”¨map å®ç°set ä»¥åŠ chan ç­‰ã€‚ å‚è€ƒé“¾æ¥ The empty struct, Dave Cheney Go æœ€ç»†èŠ‚ç¯‡â€” struct{} ç©ºç»“æ„ä½“ç©¶ç«Ÿæ˜¯å•¥ï¼Ÿ ","date":"2024-06-17T23:18:02+08:00","image":"https://images.yixiao9206.cn/blog-images/2024/06/c78d096394f1791445b7c10f88dd0378.jpg","permalink":"https://huizhou92.com/zh-cn/p/%E8%A7%A3%E5%AF%86go-empty-struct/","title":"è§£å¯†go: empty struct"},{"content":"åŸæ–‡é“¾æ¥how-quic-is-displacing-tcp-for-speed\nå¼•è¨€ åœ¨è¿‡å»çš„ä¸‰åå¹´ä¸­ï¼ŒHTTPï¼ˆè¶…æ–‡æœ¬ä¼ è¾“åè®®ï¼‰ä¸€ç›´æ˜¯äº’è”ç½‘çš„æ”¯æŸ±ã€‚æˆ‘ä»¬èƒ½å¤Ÿæµè§ˆç½‘é¡µã€ä¸‹è½½æ–‡ä»¶ã€æµå¼ä¼ è¾“ç”µå½±ç­‰ï¼Œéƒ½æ˜¯å› ä¸ºHTTPã€‚è¿™ä¸ªåè®®å¤šå¹´æ¥ä¸æ–­å‘å±•ï¼Œè§è¯äº†é‡å¤§çš„æ”¹è¿›ã€‚\nHTTPåè®®æ˜¯ä¸€ä¸ªåº”ç”¨å±‚åè®®ï¼Œå·¥ä½œåœ¨TCPï¼ˆä¼ è¾“æ§åˆ¶åè®®ï¼‰ä¹‹ä¸Šã€‚TCPåè®®æœ‰ä¸€äº›é™åˆ¶ï¼Œå¯¼è‡´ç½‘ç»œåº”ç”¨ç¨‹åºå“åº”æ€§è¾ƒå·®ã€‚\nè°·æ­Œå¼€å‘äº†ä¸€ç§æ”¹å˜æ¸¸æˆè§„åˆ™çš„ä¼ è¾“åè®®QUICï¼Œä»¥å…‹æœTCPçš„ç¼ºç‚¹ã€‚QUICå‡ å¹´å‰è¢«æ ‡å‡†åŒ–å¹¶åŠ å…¥åˆ°IETFï¼ˆäº’è”ç½‘å·¥ç¨‹ä»»åŠ¡ç»„ï¼‰ã€‚\nåœ¨è¿‡å»å‡ å¹´ä¸­ï¼ŒQUICçš„é‡‡ç”¨å‘ˆæŒ‡æ•°çº§å¢é•¿ã€‚å¤§å¤šæ•°ç§‘æŠ€å…¬å¸ï¼Œå¦‚è°·æ­Œã€Facebookã€Pinterestç­‰ï¼Œå·²ç»å¼€å§‹é‡‡ç”¨ä½¿ç”¨QUICä½œä¸ºä¼ è¾“å±‚çš„HTTP/3.0ã€‚è¿™äº›å…¬å¸åœ¨ä½¿ç”¨HTTP/3.0å’ŒQUICåï¼Œå…¶ç½‘ç«™æ€§èƒ½æœ‰äº†æ˜¾è‘—æå‡ã€‚\nè®©æˆ‘ä»¬å¼€å§‹æˆ‘ä»¬çš„æ—…ç¨‹ï¼Œäº†è§£QUICå¦‚ä½•å–ä»£TCPã€‚æˆ‘ä»¬é¦–å…ˆå°†äº†è§£ä¸€äº›åŸºæœ¬çš„TCPå’ŒUDPç½‘ç»œæ¦‚å¿µã€‚ä¹‹åï¼Œæˆ‘ä»¬å°†çœ‹çœ‹HTTPçš„æ¼”å˜ï¼Œä»¥åŠæ¯ä¸ªç‰ˆæœ¬æ˜¯å¦‚ä½•å…‹æœå‰ä¸€ä¸ªç‰ˆæœ¬çš„é™åˆ¶çš„ã€‚ç„¶åï¼Œæˆ‘ä»¬å°†äº†è§£QUICæ˜¯ä»€ä¹ˆä»¥åŠå®ƒçš„å·¥ä½œåŸç†ã€‚æˆ‘ä»¬å°†æ¢è®¨ä¸ºä»€ä¹ˆQUICçš„æ€§èƒ½æ¯”TCPé«˜ã€‚\nTCPå’ŒUDPæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ TCPï¼ˆä¼ è¾“æ§åˆ¶åè®®ï¼‰å’ŒUDPï¼ˆç”¨æˆ·æ•°æ®æŠ¥åè®®ï¼‰æ˜¯ä¼ è¾“å±‚åè®®ã€‚è¿™äº›åè®®ç®¡ç†äº’è”ç½‘æ•°æ®åŒ…æµå‘å’Œæ¥è‡ªä»»ä½•ç”µå­è®¾å¤‡çš„è¿‡ç¨‹ã€‚è®©æˆ‘ä»¬è¯¦ç»†äº†è§£è¿™ä¸¤ä¸ªåè®®æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚\nTCP TCPæ˜¯ä¸€ç§åŸºäºè¿æ¥çš„åè®®ã€‚å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨å»ºç«‹è¿æ¥ï¼Œç„¶åå‘é€æ•°æ®ã€‚TCPè¿æ¥æ˜¯é€šè¿‡ä¸€ç§ç§°ä¸ºä¸‰æ¬¡æ¡æ‰‹çš„æœºåˆ¶å»ºç«‹çš„ã€‚ä¸‹å›¾å±•ç¤ºäº†ä¸‰æ¬¡æ¡æ‰‹è¿‡ç¨‹ï¼š\nè¿™ä¸ªè¿‡ç¨‹åŒ…æ‹¬ä¸‰ä¸ªæ­¥éª¤ï¼š\nSYN - å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€ä¸€ä¸ªSYNæ•°æ®åŒ…ã€‚\nACK - æœåŠ¡å™¨æ¥æ”¶åˆ°SYNåï¼Œé€šè¿‡ACKæ•°æ®åŒ…å‘å®¢æˆ·ç«¯å‘é€ç¡®è®¤ã€‚\nSYN-ACK - å®¢æˆ·ç«¯æ”¶åˆ°æœåŠ¡å™¨çš„ACKæ•°æ®åŒ…åï¼Œæœ€ç»ˆé€šè¿‡SYN-ACKå‘æœåŠ¡å™¨å‘é€ç¡®è®¤ã€‚\nTCPæ˜¯ä¸€ä¸ªæœ‰çŠ¶æ€å’Œå¯é çš„åè®®ã€‚å®ƒä¿è¯ä»ä¸€å°è®¾å¤‡åˆ°å¦ä¸€å°è®¾å¤‡çš„æ‰€æœ‰æ•°æ®åŒ…çš„ä¼ è¾“ã€‚æ­¤å¤–ï¼Œå®ƒå…è®¸å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä½¿ç”¨ç›¸åŒçš„è¿æ¥è¿›è¡Œé€šä¿¡ã€‚\nUDP UDPæ˜¯ä¸€ç§æ— è¿æ¥åè®®ã€‚ä¸TCPä¸åŒï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´æ²¡æœ‰ä¸‰æ¬¡æ¡æ‰‹ã€‚å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€æ•°æ®åŒ…ï¼Œä¸ç­‰å¾…æœåŠ¡å™¨çš„ç¡®è®¤ã€‚\nUDPä¸èƒ½ä¿è¯100%çš„æ•°æ®åŒ…ä¼ è¾“ã€‚æ•°æ®åŒ…å¯èƒ½ä¼šä¸¢å¤±ï¼Œå¯èƒ½æ— æ³•åˆ°è¾¾å¦ä¸€å°è®¾å¤‡ã€‚UDPä¸åƒTCPé‚£æ ·å¯é ã€‚\nç”±äºæ²¡æœ‰åˆå§‹æ¡æ‰‹ï¼ŒUDPæ¯”TCPå¿«å¾—å¤šã€‚å‡ºäºæ€§èƒ½åŸå› ï¼ŒUDPä¸»è¦ç”¨äºæµå¼æ•°æ®åº”ç”¨ç¨‹åºï¼Œå¦‚éŸ³ä¹/è§†é¢‘ã€‚\nè¿™æ˜¯ä¸€ä¸ªæµè¡Œçš„äº’è”ç½‘æ¢—ï¼Œå¯¹TCP/UDPè¿›è¡Œäº†è°ƒä¾ƒï¼š\nåˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å·²ç»äº†è§£äº†TCPå’ŒUDPåè®®æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚ç°åœ¨è®©æˆ‘ä»¬æ¢ç´¢HTTPåè®®ï¼Œè¿™æ˜¯ä¸€ä¸ªåº”ç”¨å±‚åè®®ã€‚\nHTTPçš„æ¼”å˜ ç”±Tim Berners-Leeåœ¨CERNå¼€å‘çš„HTTPçš„ç¬¬ä¸€ä¸ªç‰ˆæœ¬æ˜¯åœ¨1989å¹´ã€‚ä»é‚£æ—¶èµ·ï¼Œè¯¥åè®®ç»å†äº†å¤šæ¬¡ä¼˜åŒ–å’Œæ€§èƒ½æ”¹è¿›ã€‚å¤§å¤šæ•°ç°ä»£è®¾å¤‡ä½¿ç”¨HTTP 1.1/ HTTP 2.0å’ŒHTTP 3.0ã€‚è®©æˆ‘ä»¬å›é¡¾ä¸€ä¸‹HTTPçš„å†å²ï¼Œäº†è§£åè®®ç»å†çš„é‡å¤§å˜åŒ–ã€‚\nHTTP/1.0 åœ¨æœ€åˆçš„HTTP/0.9ç‰ˆæœ¬ä¹‹åï¼ŒHTTP/1.0å¼€å§‹æ”¯æŒå¤´ã€è¯·æ±‚ä½“ã€æ–‡æœ¬æ–‡ä»¶ç­‰ã€‚å®¢æˆ·ç«¯æ¯æ¬¡ä½¿ç”¨HTTPä»æœåŠ¡å™¨è·å–æ•°æ®æ—¶ï¼Œéƒ½å¿…é¡»åˆ›å»ºä¸€ä¸ªTCPè¿æ¥ã€‚è¿™å¯¼è‡´åœ¨å»ºç«‹è¿æ¥æ—¶æ˜¾è‘—æµªè´¹èµ„æºã€‚\nHTTP/1.1 è¿™ä¸ªåè®®å¢åŠ äº†å¯¹é‡ç”¨å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´ç°æœ‰TCPè¿æ¥ä»¥è·å–æ–°æ•°æ®çš„æ”¯æŒã€‚è¿™æ˜¯é€šè¿‡HTTPå¤´keep-aliveå®ç°çš„ã€‚\nå¦‚æœå®¢æˆ·ç«¯æƒ³è¦è·å–10ä¸ªJavaScriptæ–‡ä»¶ï¼Œé‚£ä¹ˆå®ƒå°†ä¸æœåŠ¡å™¨å»ºç«‹ä¸€ä¸ªè¿æ¥ã€‚ç„¶åï¼Œå®ƒå°†é‡ç”¨ç›¸åŒçš„è¿æ¥æ¥è·å–è¿™10ä¸ªæ–‡ä»¶ï¼Œè€Œä¸æ˜¯ä¸ºæ¯ä¸ªæ–‡ä»¶åˆ›å»ºä¸€ä¸ªæ–°è¿æ¥ã€‚\nè¿™å¯¼è‡´èµ„æºæµªè´¹å‡å°‘å’Œæ€§èƒ½æå‡ï¼Œå› ä¸ºå®ƒé¿å…äº†åˆ›å»ºå¤šä½™çš„è¿æ¥ã€‚ç„¶è€Œï¼Œä¸€ä¸ªä¸»è¦çš„ç¼ºç‚¹æ˜¯ä¼—æ‰€å‘¨çŸ¥çš„_é˜Ÿå¤´é˜»å¡_é—®é¢˜ã€‚\nä¸‹å›¾å±•ç¤ºäº†_é˜Ÿå¤´é˜»å¡_é—®é¢˜ã€‚\nè®©æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªä¾‹å­æ¥ç†è§£è¿™ä¸ªæ¦‚å¿µã€‚å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œä½ æœ‰3ä¸ªæ–‡ä»¶ - å›¾åƒã€æ–‡æœ¬å’Œè§†é¢‘ã€‚è§†é¢‘æ–‡ä»¶ä½“ç§¯è¾ƒå¤§ï¼Œä¼ è¾“æ—¶é—´ä¼šæ›´é•¿ã€‚ç”±äºè§†é¢‘æ–‡ä»¶ä¼ è¾“æ—¶é—´è¾ƒé•¿ï¼Œå®ƒä¼šé˜»å¡å›¾åƒå’Œæ–‡æœ¬æ–‡ä»¶çš„å‘é€ã€‚\nHTTP/2.0 HTTP 2.0é€šè¿‡å¤šè·¯å¤ç”¨è§£å†³äº†_é˜Ÿå¤´é˜»å¡_é—®é¢˜ã€‚é€šè¿‡å¤šè·¯å¤ç”¨ï¼Œå¤šä¸ªæ–‡ä»¶å¯ä»¥é€šè¿‡åŒä¸€ä¸ªTCPè¿æ¥å‘é€ã€‚\nè¿™å¯¼è‡´äº†æ€§èƒ½æå‡ï¼Œå¹¶è§£å†³äº†åº”ç”¨å±‚é¢çš„é˜Ÿå¤´é˜»å¡é—®é¢˜ã€‚ç„¶è€Œï¼Œåœ¨TCPå±‚é¢ï¼Œå¦‚æœå‘ç”Ÿæ•°æ®åŒ…ä¸¢å¤±ï¼Œå®ƒå¿…é¡»ç­‰å¾…æ•°æ®åŒ…é‡ä¼ ã€‚\nå¤šè·¯å¤ç”¨è§£å†³æ–¹æ¡ˆåœ¨æ•°æ®åŒ…ä¸¢å¤±çš„æƒ…å†µä¸‹å¹¶ä¸åƒé¢„æœŸçš„é‚£æ ·æœ‰æ•ˆã€‚å®é™…ä¸Šï¼Œå¦‚æœæ•°æ®åŒ…ä¸¢å¤±è¶…è¿‡5%ï¼ŒHTTP 1.1çš„æ€§èƒ½æ¯”HTTP 2.0æ›´å¥½ã€‚_é˜Ÿå¤´é˜»å¡_é—®é¢˜ä»åº”ç”¨å±‚è½¬ç§»åˆ°äº†ä¼ è¾“å±‚ã€‚\nä¸‹å›¾å±•ç¤ºäº†å•ä¸ªæ•°æ®åŒ…ä¸¢å¤±å¦‚ä½•å¯¼è‡´å¤šä¸ªæµå»¶è¿Ÿï¼š\nå½“ä¸€ä¸ªæ•°æ®åŒ…ä¸¢å¤±æ—¶ï¼ŒTCPå°†å…¶åç»­æ•°æ®åŒ…å­˜å‚¨åœ¨å…¶ç¼“å†²åŒºä¸­ï¼Œç›´åˆ°æ”¶åˆ°ä¸¢å¤±çš„æ•°æ®åŒ…ã€‚ç„¶åTCPä½¿ç”¨é‡ä¼ æ¥è·å–ä¸¢å¤±çš„æ•°æ®åŒ…ã€‚HTTPæ— æ³•çœ‹åˆ°TCPé‡ä¼ ã€‚å› æ­¤ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¸åŒçš„æµä¼šçœ‹åˆ°ä¼ è¾“å»¶è¿Ÿã€‚\nä»€ä¹ˆæ˜¯QUICï¼Ÿ åœ¨è¿‡å»çš„å‡ ä¸ªéƒ¨åˆ†ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°äº†TCPæœ‰ä¸€äº›å›ºæœ‰çš„é™åˆ¶ï¼Œå¦‚ä¸‰æ¬¡æ¡æ‰‹å’Œé˜Ÿå¤´é˜»å¡ã€‚è¿™äº›é™åˆ¶å¯ä»¥é€šè¿‡å¢å¼ºTCPæˆ–ç”¨æ–°åè®®æ›¿æ¢TCPæ¥è§£å†³ã€‚\nå°½ç®¡å¢å¼ºTCPå¾ˆç®€å•ï¼Œä½†TCPå­˜åœ¨äºæœ€ä½å±‚ï¼Œä¸æ“ä½œç³»ç»Ÿç´§å¯†è€¦åˆã€‚ç®€å•æ¥è¯´ï¼ŒTCPçš„ä»£ç å­˜åœ¨äºå†…æ ¸å±‚è€Œä¸æ˜¯ç”¨æˆ·ç©ºé—´ã€‚è€ƒè™‘åˆ°å¤§é‡çš„è®¾å¤‡ï¼Œå®æ–½å†…æ ¸ç©ºé—´çš„æ›´æ”¹å°†éœ€è¦å¤§é‡çš„æ—¶é—´æ‰èƒ½åˆ°è¾¾æ‰€æœ‰ç”¨æˆ·ã€‚\nå› æ­¤ï¼Œè°·æ­Œæå‡ºäº†ä¸€ç§æ–°çš„åè®®QUICï¼Œä½œä¸ºTCPçš„æ›¿ä»£å“ã€‚åƒTCPä¸€æ ·ï¼ŒQUICä¹Ÿæ˜¯ä¸€ä¸ªä¼ è¾“å±‚åè®®ã€‚ç„¶è€Œï¼Œå®ƒä½äºç”¨æˆ·ç©ºé—´è€Œä¸æ˜¯å†…æ ¸ç©ºé—´ã€‚è¿™ä½¿å¾—å®ƒå®¹æ˜“æ›´æ”¹å’Œå¢å¼ºï¼Œä¸TCPä¸åŒã€‚\nQUICåœ¨UDPä¹‹ä¸Šå·¥ä½œã€‚å®ƒé€šè¿‡ä½¿ç”¨UDPå…‹æœäº†TCPçš„é™åˆ¶ã€‚å®ƒåªæ˜¯ä¸€ä¸ªåœ¨UDPä¹‹ä¸Šçš„å±‚æˆ–åŒ…è£…å™¨ã€‚è¯¥åŒ…è£…å™¨æ·»åŠ äº†TCPçš„åŠŸèƒ½ï¼Œå¦‚æ‹¥å¡æ§åˆ¶ã€æ•°æ®åŒ…é‡ä¼ ã€å¤šè·¯å¤ç”¨ç­‰ã€‚å®ƒå†…éƒ¨ä½¿ç”¨UDPï¼Œå¹¶åœ¨å…¶ä¸Šæ·»åŠ äº†TCPçš„æœ€ä½³åŠŸèƒ½ã€‚\nä¸‹å›¾æ˜¾ç¤ºäº†QUICå¦‚ä½•é€‚åº”ç½‘ç»œæ ˆï¼š\nç°åœ¨æˆ‘ä»¬å·²ç»äº†è§£äº†QUICçš„åŸºç¡€çŸ¥è¯†ï¼Œè®©æˆ‘ä»¬æ·±å…¥äº†è§£è¿™ä¸ªåè®®çš„å·¥ä½œåŸç†ã€‚\nQUICæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ QUICæ¡æ‰‹ QUICåœ¨UDPä¸Šå·¥ä½œï¼Œå®ƒä¸éœ€è¦ç»è¿‡ä¸‰æ¬¡æ¡æ‰‹è¿‡ç¨‹ã€‚ä¸‰æ¬¡æ¡æ‰‹è¿‡ç¨‹å¢åŠ äº†é¢å¤–çš„å¼€é”€ï¼Œå¢åŠ äº†å»¶è¿Ÿã€‚å› æ­¤ï¼ŒQUICé€šè¿‡å‡å°‘è¿æ¥å»¶è¿Ÿæ¥æé«˜æ€§èƒ½ã€‚\nåœ¨TCPçš„æƒ…å†µä¸‹ï¼Œè¿˜æœ‰ä¸€ä¸ªé¢å¤–çš„ç”¨äºTLSçš„æ¡æ‰‹ï¼Œè¿™ä¹Ÿå¢åŠ äº†å»¶è¿Ÿã€‚QUICå°†TLSæ¡æ‰‹å’ŒQUICæ¡æ‰‹åˆå¹¶ä¸ºä¸€ä¸ªè°ƒç”¨ã€‚å®ƒä¼˜åŒ–äº†æ¡æ‰‹è¿‡ç¨‹å¹¶æé«˜äº†æ€§èƒ½ã€‚\nå¯é æ€§ æ‚¨å¯èƒ½ä¼šæƒ³â€œæ—¢ç„¶QUICåœ¨UDPä¸Šå·¥ä½œï¼Œæ•°æ®åŒ…ä¼šä¸¢å¤±å—ï¼Ÿâ€ã€‚ç­”æ¡ˆæ˜¯ä¸ã€‚QUICåœ¨UDPå †æ ˆä¸Šæ·»åŠ äº†å¯é æ€§ã€‚å®ƒå®ç°äº†æ•°æ®åŒ…é‡ä¼ ï¼Œä»¥é˜²å®ƒæ²¡æœ‰æ”¶åˆ°å¿…è¦çš„æ•°æ®åŒ…ã€‚ä¾‹å¦‚ï¼šå¦‚æœæœåŠ¡å™¨æ²¡æœ‰æ”¶åˆ°æ¥è‡ªå®¢æˆ·ç«¯çš„ç¬¬5ä¸ªæ•°æ®åŒ…ï¼Œåè®®å°†æ£€æµ‹åˆ°å®ƒå¹¶è¦æ±‚å®¢æˆ·ç«¯é‡æ–°å‘é€ç›¸åŒçš„æ•°æ®åŒ…ã€‚\nå¤šè·¯å¤ç”¨ ä¸TCPç±»ä¼¼ï¼ŒQUICä¹Ÿå®ç°äº†å¤šè·¯å¤ç”¨ã€‚å®¢æˆ·ç«¯å¯ä»¥ä½¿ç”¨å•ä¸ªé€šé“åŒæ—¶ä¼ è¾“å¤šä¸ªæ–‡ä»¶ã€‚QUICä¸ºæ¯ä¸ªæµï¼ˆä¼ è¾“çš„æ–‡ä»¶ï¼‰åˆ›å»ºä¸€ä¸ªUUIDã€‚å®ƒä½¿ç”¨UUIDæ¥è¯†åˆ«æµã€‚ç„¶åï¼Œå¤šä¸ªæµé€šè¿‡å•ä¸ªé€šé“å‘é€ã€‚\nä¸‹å›¾å±•ç¤ºäº†QUICä¸­å¤šè·¯å¤ç”¨æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼š\nQUICè¿˜é€šè¿‡å…¶å¤šè·¯å¤ç”¨è§£å†³äº†TCPé¢ä¸´çš„é˜Ÿå¤´é˜»å¡é—®é¢˜ã€‚å¦‚æœä¸€ä¸ªæµé­å—æ•°æ®åŒ…ä¸¢å¤±ï¼Œåªæœ‰è¯¥æµä¼šå—åˆ°å½±å“ã€‚QUICä¸­çš„æµæ˜¯ç‹¬ç«‹çš„ï¼Œä¸ä¼šå½±å“å½¼æ­¤çš„å·¥ä½œã€‚\nå®‰å…¨æ€§ æ­¤å¤–ï¼ŒQUIC è¿˜æ”¯æŒ TLS 1.3ï¼ˆä¼ è¾“å±‚å®‰å…¨æ€§ï¼‰ã€‚è¿™ä¿è¯äº†æ•°æ®çš„å®‰å…¨æ€§å’Œä¿å¯†æ€§ã€‚TLS åŠ å¯†äº† QUIC åè®®çš„å¤§éƒ¨åˆ†å†…å®¹ï¼Œä¾‹å¦‚æ•°æ®åŒ…ç¼–å·å’Œè¿æ¥å…³é—­ä¿¡å·ã€‚\nä¸ºä»€ä¹ˆé€‰æ‹©QUICï¼Ÿ é™ä½å»¶è¿Ÿ - QUICé€šè¿‡å°†TLSæ¡æ‰‹ä¸è¿æ¥å»ºç«‹ç»“åˆèµ·æ¥ï¼Œæœ€å°åŒ–äº†å»¶è¿Ÿã€‚è¿™ä¹Ÿè¢«ç§°ä¸º0-RTTï¼ˆé›¶å¾€è¿”æ—¶é—´ï¼‰ã€‚å®ƒå®ç°äº†æ›´å¿«çš„è¿æ¥å»ºç«‹ï¼Œå¹¶æé«˜äº†ç½‘ç»œåº”ç”¨ç¨‹åºçš„æ€§èƒ½ã€‚ å¤šè·¯å¤ç”¨ - é€šè¿‡å¤šè·¯å¤ç”¨ï¼ŒQUICå¯ä»¥åœ¨å•ä¸ªé€šé“ä¸Šå‘é€å¤šä¸ªæ•°æ®æµã€‚è¿™å¯¹äºä¸‹è½½å¤šä¸ªæ–‡ä»¶ï¼ˆå¦‚å›¾åƒã€JavaScriptã€CSSç­‰ï¼‰çš„å®¢æˆ·ç«¯åº”ç”¨ç¨‹åºéå¸¸æœ‰ç”¨ã€‚ è¿æ¥è¿ç§» - ä½¿ç”¨QUICï¼Œæ‚¨å¯ä»¥åœ¨ä¸å‡ºç°ä»»ä½•é—®é¢˜çš„æƒ…å†µä¸‹ä»ä¸€ç§ç½‘ç»œæ¥å£åˆ‡æ¢åˆ°å¦ä¸€ç§ï¼ˆä¾‹å¦‚ä»Wi-Fiåˆ‡æ¢åˆ°ç§»åŠ¨æ•°æ®ï¼‰ã€‚è¿™å¯¹äºç§»åŠ¨è®¾å¤‡å¾ˆé‡è¦ï¼Œå¹¶æé«˜äº†ç”¨æˆ·ä½“éªŒã€‚ æé«˜å®‰å…¨æ€§ - QUICä½¿ç”¨TLS 1.3ï¼Œæä¾›æ›´å¥½çš„å®‰å…¨æ€§ã€‚æ­¤å¤–ï¼Œå®ƒè¿˜åŠ å¯†äº†åè®®çš„å¤§éƒ¨åˆ†ï¼Œä¸åªåŠ å¯†HTTPæœ‰æ•ˆè½½è·çš„TCPå’ŒTLSä¸åŒã€‚ä¸TCPç›¸æ¯”ï¼Œå®ƒæ›´èƒ½æŠµå¾¡å®‰å…¨æ”»å‡»ã€‚ å¹¿æ³›æ”¯æŒ - è‡ªå…¶è¯ç”Ÿä»¥æ¥ï¼Œå®ƒçš„é‡‡ç”¨ç‡ä¸€ç›´åœ¨ä¸Šå‡ã€‚è¿™è¿›ä¸€æ­¥åŠ å¼ºäº†å®ƒçš„æœ‰æ•ˆæ€§ã€‚ HTTP/3å’ŒQUIC HTTP/3æ˜¯è¶…æ–‡æœ¬ä¼ è¾“åè®®ï¼ˆHTTPï¼‰çš„æœ€æ–°ç‰ˆæœ¬ã€‚å®ƒå†…éƒ¨ä½¿ç”¨QUICè€Œä¸æ˜¯TCPã€‚å®ƒæ—¨åœ¨ä¸ºç°ä»£ç½‘ç»œæä¾›æ›´æœ‰æ•ˆå’Œå®‰å…¨çš„åŸºç¡€ã€‚å®ƒæ‹¥æœ‰QUICæä¾›çš„æ‰€æœ‰ä¼˜åŠ¿ã€‚\nHTTP/3ç”±IETFæ ‡å‡†åŒ–ã€‚ä»Šå¤©ï¼Œå¾ˆå¤§ä¸€éƒ¨åˆ†äº’è”ç½‘æµé‡ä¾èµ–äºHTTP/3ã€‚ä»¥ä¸‹æ˜¯æ˜¾ç¤ºHTTP/3é‡‡ç”¨ç‡çš„å›¾è¡¨ï¼š\nä»ä¸Šè¿°å›¾è¡¨ä¸­å¯ä»¥çœ‹å‡ºï¼Œé‡‡ç”¨ç‡å·²ç»é£™å‡è‡³30%ï¼Œå¹¶é€æ¸è¶…è¶Šäº†HTTP/1.1ã€‚æŒ‰ç…§ç›®å‰çš„å‘å±•é€Ÿåº¦ï¼ŒHTTP/3.0å°†åœ¨æœªæ¥å‡ å¹´é€æ¸è¶…è¶ŠHTTP/2.0ã€‚\nç»“è®º è‡ªä¸‰åå¹´å‰HTTPè¯ç”Ÿä»¥æ¥ï¼Œäº’è”ç½‘å·²ç»èµ°è¿‡äº†æ¼«é•¿çš„é“è·¯ã€‚HTTPçš„æ¼”å˜ä½¿åœ¨çº¿ä½“éªŒæ›´åŠ é«˜æ•ˆå’Œå“åº”è¿…é€Ÿã€‚éšç€ç°ä»£åº”ç”¨ç¨‹åºéœ€æ±‚çš„å¢é•¿ï¼Œæˆ‘ä»¬æ„è¯†åˆ°äº†åº•å±‚åè®®å¦‚TCPçš„å›ºæœ‰é™åˆ¶ã€‚\nè°·æ­Œå¼€å‘äº†æ”¹å˜æ¸¸æˆè§„åˆ™çš„åè®®QUICã€‚å®ƒåˆ©ç”¨UDPå¹¶è§£å†³äº†TCPçš„æ‰€æœ‰ä¸è¶³ã€‚é™ä½å»¶è¿Ÿã€å¤šè·¯å¤ç”¨ã€å¢å¼ºå®‰å…¨æ€§å’Œè¿æ¥è¿ç§»æ˜¯QUICçš„ä¸€äº›æ˜¾è‘—ç‰¹ç‚¹ã€‚QUICå¸¦æ¥çš„åˆ›æ–°è§£å†³äº†é˜Ÿå¤´é˜»å¡ç­‰é—®é¢˜ã€‚\nåƒè°·æ­Œå’ŒFacebookè¿™æ ·çš„å¤§å‹ç§‘æŠ€å…¬å¸é€šè¿‡åœ¨HTTP/3ä¸­é‡‡ç”¨QUICï¼Œåœ¨æ€§èƒ½ä¸Šå–å¾—äº†æ˜¾è‘—æå‡ã€‚éšç€é‡‡ç”¨ç‡çš„ä¸Šå‡å’Œæ—¥ç›Šå¢é•¿çš„æ”¯æŒï¼ŒHTTP/3å°†æˆä¸ºäº’è”ç½‘é€šä¿¡çš„æ ‡å‡†ã€‚åœ¨æœªæ¥å‡ å¹´ï¼Œäº’è”ç½‘å°†å‘å±•å¹¶è¿‡æ¸¡åˆ°HTTP/3ï¼Œä»¥å®ç°æ•ˆç‡ã€å¯é æ€§å’Œæ€§èƒ½ã€‚\nå‚è€ƒæ–‡çŒ® TCP VS UDP æ¢— ä¸ºä»€ä¹ˆHTTP/3.0æ­£åœ¨åå™¬ä¸–ç•Œï¼Ÿ Pinterestç°åœ¨ä½¿ç”¨HTTP/3.0 ä¸è°·æ­Œå¯¹ç­‰ - QUIC ","date":"2024-06-14T09:38:42+08:00","image":"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd0e30c17-275b-4a94-8883-74c546ead5e5_5955x3350.jpeg","permalink":"https://huizhou92.com/zh-cn/p/quic-%E5%A6%82%E4%BD%95%E5%9C%A8%E9%80%9F%E5%BA%A6%E5%92%8C%E5%AE%89%E5%85%A8%E6%80%A7%E6%96%B9%E9%9D%A2%E5%8F%96%E4%BB%A3-tcp/","title":"QUIC å¦‚ä½•åœ¨é€Ÿåº¦å’Œå®‰å…¨æ€§æ–¹é¢å–ä»£ TCPï¼Ÿ"},{"content":"å¯¹æ¯” fastjsonï¼Œgjsonï¼Œjsonparser çš„æ€§èƒ½ä»¥åŠä¼˜ç¼ºç‚¹ã€‚\nè¿™ç¯‡æ–‡ç« æ·±å…¥æºç åˆ†æä¸€ä¸‹åœ¨ Go ä¸­æ ‡å‡†åº“æ˜¯å¦‚ä½•è§£æ JSON çš„ï¼Œç„¶åå†çœ‹çœ‹æœ‰å“ªäº›æ¯”è¾ƒæµè¡Œçš„ Json è§£æåº“ï¼Œä»¥åŠè¿™äº›åº“éƒ½æœ‰ä»€ä¹ˆç‰¹ç‚¹ï¼Œåœ¨ä»€ä¹ˆåœºæ™¯ä¸‹èƒ½æ›´å¥½çš„å¸®åŠ©æˆ‘ä»¬è¿›è¡Œå¼€å‘ã€‚\nThis article is first published in the medium MPP plan. If you are a medium user, please follow me on the medium. Thank you very much.\nå…¶å®æœ¬æ¥æˆ‘æ˜¯æ²¡æ‰“ç®—å»çœ‹ JSON åº“çš„æ€§èƒ½é—®é¢˜çš„ï¼Œä½†æ˜¯æœ€è¿‘æˆ‘å¯¹æˆ‘çš„é¡¹ç›®åšäº†ä¸€æ¬¡ pprofï¼Œä»ä¸‹é¢çš„ç«ç„°å›¾ä¸­å¯ä»¥å‘ç°åœ¨ä¸šåŠ¡é€»è¾‘å¤„ç†ä¸­ï¼Œæœ‰ä¸€åŠå¤šçš„æ€§èƒ½æ¶ˆè€—éƒ½æ˜¯åœ¨ JSON è§£æè¿‡ç¨‹ä¸­ï¼Œæ‰€ä»¥å°±æœ‰äº†è¿™ç¯‡æ–‡ç« ã€‚\nè¿™ç¯‡æ–‡ç« æ·±å…¥æºç åˆ†æä¸€ä¸‹åœ¨ Go ä¸­æ ‡å‡†åº“æ˜¯å¦‚ä½•è§£æ JSON çš„ï¼Œç„¶åå†çœ‹çœ‹æœ‰å“ªäº›æ¯”è¾ƒæµè¡Œçš„ Json è§£æåº“ï¼Œä»¥åŠè¿™äº›åº“éƒ½æœ‰ä»€ä¹ˆç‰¹ç‚¹ï¼Œåœ¨ä»€ä¹ˆåœºæ™¯ä¸‹èƒ½æ›´å¥½çš„å¸®åŠ©æˆ‘ä»¬è¿›è¡Œå¼€å‘ã€‚\nä¸»è¦ä»‹ç»åˆ†æä»¥ä¸‹å‡ ä¸ªåº“ï¼ˆ2024-06-13ï¼‰ï¼š\nåº“å Star æ ‡å‡†åº“ JSON Unmarshal valyala/fastjson 2.2 k tidwall/gjson 13.8 k buger/jsonparser 5.4 k æ ‡å‡†åº“ JSON Unmarshal 1 func Unmarshal(data []byte, v interface{}) å®˜æ–¹çš„ JSON è§£æåº“éœ€è¦ä¼ ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯éœ€è¦è¢«åºåˆ—åŒ–çš„å¯¹è±¡ï¼Œå¦ä¸€ä¸ªæ˜¯è¡¨ç¤ºè¿™ä¸ªå¯¹è±¡çš„ç±»å‹ã€‚\nåœ¨çœŸæ­£æ‰§è¡Œ JSON è§£æä¹‹å‰ä¼šè°ƒç”¨ reflect.ValueOfæ¥è·å–å‚æ•° v çš„åå°„å¯¹è±¡ã€‚ç„¶åä¼šè·å–åˆ°ä¼ å…¥çš„ data å¯¹è±¡çš„å¼€å¤´éç©ºå­—ç¬¦æ¥ç•Œå®šè¯¥ç”¨å“ªç§æ–¹å¼æ¥è¿›è¡Œè§£æã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 func (d *decodeState) value(v reflect.Value) error { switch d.opcode { default: panic(phasePanicMsg) // æ•°ç»„ case scanBeginArray: ... // ç»“æ„ä½“æˆ–map case scanBeginObject: ... // å­—é¢é‡ï¼ŒåŒ…æ‹¬ intã€stringã€float ç­‰ case scanBeginLiteral: ... } return nil } å¦‚æœè¢«è§£æçš„å¯¹è±¡æ˜¯ä»¥[å¼€å¤´ï¼Œé‚£ä¹ˆè¡¨ç¤ºè¿™æ˜¯ä¸ªæ•°ç»„å¯¹è±¡ä¼šè¿›å…¥åˆ° scanBeginArray åˆ†æ”¯ï¼›å¦‚æœæ˜¯ä»¥{å¼€å¤´ï¼Œè¡¨æ˜è¢«è§£æçš„å¯¹è±¡æ˜¯ä¸€ä¸ªç»“æ„ä½“æˆ– mapï¼Œé‚£ä¹ˆè¿›å…¥åˆ° scanBeginObject åˆ†æ”¯ ç­‰ç­‰ã€‚\nå°ç»“ é€šè¿‡çœ‹ Unmarshal æºç ä¸­å¯ä»¥çœ‹åˆ°å…¶ä¸­ä½¿ç”¨äº†å¤§é‡çš„åå°„æ¥è·å–å­—æ®µå€¼ï¼Œå¦‚æœæ˜¯å¤šå±‚åµŒå¥—çš„ JSON çš„è¯ï¼Œé‚£ä¹ˆè¿˜éœ€è¦é€’å½’è¿›è¡Œåå°„è·å–å€¼ï¼Œå¯æƒ³è€ŒçŸ¥æ€§èƒ½æ˜¯éå¸¸å·®çš„äº†ã€‚\nä½†æ˜¯å¦‚æœå¯¹æ€§èƒ½ä¸æ˜¯é‚£ä¹ˆçœ‹é‡çš„è¯ï¼Œç›´æ¥ä½¿ç”¨å®ƒå…¶å®æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„é€‰æ‹©ï¼ŒåŠŸèƒ½å®Œå–„çš„åŒæ—¶å¹¶ä¸”å®˜æ–¹ä¹Ÿä¸€ç›´åœ¨è¿­ä»£ä¼˜åŒ–ï¼Œè¯´ä¸å®šåœ¨ä»¥åçš„ç‰ˆæœ¬ä¸­æ€§èƒ½ä¹Ÿä¼šå¾—åˆ°è´¨çš„é£è·ƒã€‚å¹¶ä¸”ä»–åº”è¯¥æ˜¯å”¯ä¸€ä¸€ä¸ªå¯ä»¥ç›´æ¥æŠŠJSONå¯¹è±¡è½¬æˆ go struct çš„ã€‚\nfastjson è¿™ä¸ªåº“çš„ç‰¹ç‚¹å’Œå®ƒçš„åå­—ä¸€æ ·å°±æ˜¯å¿«ï¼Œå®ƒçš„ä»‹ç»é¡µæ˜¯è¿™ä¹ˆè¯´çš„ï¼š\nFast. As usual, up to 15x faster than the standard encoding/json.\nå®ƒçš„ä½¿ç”¨ä¹Ÿæ˜¯éå¸¸çš„ç®€å•,å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 func main() { var p fastjson.Parser v, _ := p.Parse(`{ \u0026#34;str\u0026#34;: \u0026#34;bar\u0026#34;, \u0026#34;int\u0026#34;: 123, \u0026#34;float\u0026#34;: 1.23, \u0026#34;bool\u0026#34;: true, \u0026#34;arr\u0026#34;: [1, \u0026#34;foo\u0026#34;, {}] }`) fmt.Printf(\u0026#34;foo=%s\\n\u0026#34;, v.GetStringBytes(\u0026#34;str\u0026#34;)) fmt.Printf(\u0026#34;int=%d\\n\u0026#34;, v.GetInt(\u0026#34;int\u0026#34;)) fmt.Printf(\u0026#34;float=%f\\n\u0026#34;, v.GetFloat64(\u0026#34;float\u0026#34;)) fmt.Printf(\u0026#34;bool=%v\\n\u0026#34;, v.GetBool(\u0026#34;bool\u0026#34;)) fmt.Printf(\u0026#34;arr.1=%s\\n\u0026#34;, v.GetStringBytes(\u0026#34;arr\u0026#34;, \u0026#34;1\u0026#34;)) } // Output: // foo=bar // int=123 // float=1.230000 // bool=true // arr.1=foo ä½¿ç”¨ fastjson é¦–å…ˆè¦å°†è¢«è§£æçš„ JSON ä¸²äº¤ç»™ Parser è§£æå™¨è¿›è¡Œè§£æï¼Œç„¶åé€šè¿‡ Parse æ–¹æ³•è¿”å›çš„å¯¹è±¡æ¥è·å–ã€‚å¦‚æœæ˜¯åµŒå¥—å¯¹è±¡å¯ä»¥ç›´æ¥åœ¨ Get æ–¹æ³•ä¼ å‚çš„æ—¶å€™ä¼ å…¥ç›¸åº”çš„çˆ¶å­ key å³å¯ã€‚\nåˆ†æ fastjson åœ¨è®¾è®¡ä¸Šå’Œæ ‡å‡†åº“ Unmarshal ä¸åŒçš„æ˜¯ï¼Œå®ƒå°† JSON è§£æåˆ’åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼šParseã€Getã€‚\nParse è´Ÿè´£å°† JSON ä¸²è§£ææˆä¸ºä¸€ä¸ªç»“æ„ä½“å¹¶è¿”å›ï¼Œç„¶åé€šè¿‡è¿”å›çš„ç»“æ„ä½“æ¥è·å–æ•°æ®ã€‚åœ¨ Parse è§£æçš„è¿‡ç¨‹æ˜¯æ— é”çš„ï¼Œæ‰€ä»¥å¦‚æœæƒ³è¦åœ¨å¹¶å‘åœ°è°ƒç”¨ Parse è¿›è¡Œè§£æéœ€è¦ä½¿ç”¨ ParserPool\nfastjson æ˜¯ä»ä¸Šå¾€ä¸‹ä¾æ¬¡éå† JSON ï¼Œç„¶åè§£æå¥½çš„æ•°æ®å­˜æ”¾åœ¨ Value ç»“æ„ä½“ä¸­ï¼š\n1 type Value struct { o Object a []*Value s string t Type } è¿™ä¸ªç»“æ„ä½“éå¸¸ç®€æˆï¼š\no Objectï¼šè¡¨ç¤ºè¢«è§£æçš„ç»“æ„æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼› a []*Valueï¼šè¡¨ç¤ºè¡¨ç¤ºè¢«è§£æçš„ç»“æ„æ˜¯ä¸ªæ•°ç»„ï¼› s stringï¼šå¦‚æœè¢«è§£æçš„ç»“æ„ä¸æ˜¯å¯¹è±¡ä¹Ÿä¸æ˜¯æ•°ç»„ï¼Œé‚£ä¹ˆå…¶ä»–ç±»å‹çš„å€¼ä¼šä»¥å­—ç¬¦ä¸²çš„å½¢å¼å­˜æ”¾åœ¨è¿™ä¸ªå­—æ®µä¸­ï¼› t Typeï¼šè¡¨ç¤ºè¿™ä¸ªç»“æ„çš„ç±»å‹ï¼Œæœ‰ TypeObjectã€TypeArrayã€TypeStringã€TypeNumberç­‰ã€‚ 1 type Object struct { kvs []kv keysUnescaped bool } type kv struct { k string v *Value } è¿™ä¸ªç»“æ„å­˜æ”¾å¯¹è±¡çš„é€’å½’ç»“æ„ã€‚å¦‚æœæŠŠä¸Šé¢ä¾‹å­ä¸­çš„ JSON ä¸²è§£æå®Œæ¯•ä¹‹åå°±æ˜¯è¿™æ ·ä¸€ä¸ªç»“æ„ï¼š\nä»£ç  åœ¨ä»£ç å®ç°ä¸Šï¼Œç”±äºæ²¡æœ‰äº†åå°„éƒ¨åˆ†çš„ä»£ç ï¼Œæ‰€ä»¥æ•´ä¸ªè§£æè¿‡ç¨‹å˜å¾—éå¸¸çš„æ¸…çˆ½ã€‚æˆ‘ä»¬ç›´æ¥çœ‹çœ‹ä¸»å¹²éƒ¨åˆ†çš„è§£æï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 func parseValue(s string, c *cache, depth int) (*Value, string, error) { if len(s) == 0 { return nil, s, fmt.Errorf(\u0026#34;cannot parse empty string\u0026#34;) } depth++ // æœ€å¤§æ·±åº¦çš„jsonä¸²ä¸èƒ½è¶…è¿‡MaxDepth if depth \u0026gt; MaxDepth { return nil, s, fmt.Errorf(\u0026#34;too big depth for the nested JSON; it exceeds %d\u0026#34;, MaxDepth) } // è§£æå¯¹è±¡ if s[0] == \u0026#39;{\u0026#39; { v, tail, err := parseObject(s[1:], c, depth) if err != nil { return nil, tail, fmt.Errorf(\u0026#34;cannot parse object: %s\u0026#34;, err) } return v, tail, nil } // è§£ææ•°ç»„ if s[0] == \u0026#39;[\u0026#39; { ... } // è§£æå­—ç¬¦ä¸² if s[0] == \u0026#39;\u0026#34;\u0026#39; { ... } ... return v, tail, nil } parseValue ä¼šæ ¹æ®å­—ç¬¦ä¸²çš„ç¬¬ä¸€ä¸ªéç©ºå­—ç¬¦æ¥åˆ¤æ–­è¦è§£æçš„ç±»å‹ã€‚è¿™é‡Œç”¨ä¸€ä¸ªå¯¹è±¡ç±»å‹æ¥åšè§£æï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 func parseObject(s string, c *cache, depth int) (*Value, string, error) { ... o := c.getValue() o.t = TypeObject o.o.reset() for { var err error // è·å–Ojbectç»“æ„ä½“ä¸­çš„ kv å¯¹è±¡ kv := o.o.getKV() ... // è§£æ key å€¼ kv.k, s, err = parseRawKey(s[1:]) ... // é€’å½’è§£æ value å€¼ kv.v, s, err = parseValue(s, c, depth) ... // é‡åˆ° ï¼Œå·ç»§ç»­å¾€ä¸‹è§£æ if s[0] == \u0026#39;,\u0026#39; { s = s[1:] continue } // è§£æå®Œæ¯• if s[0] == \u0026#39;}\u0026#39; { return o, s[1:], nil } return nil, s, fmt.Errorf(\u0026#34;missing \u0026#39;,\u0026#39; after object value\u0026#34;) } } parseObject å‡½æ•°ä¹Ÿéå¸¸ç®€å•ï¼Œåœ¨å¾ªç¯ä½“ä¸­ä¼šè·å– key å€¼ï¼Œç„¶åè°ƒç”¨ parseValue é€’å½’è§£æ value å€¼ï¼Œä»ä¸Šå¾€ä¸‹ä¾æ¬¡è§£æ JSON å¯¹è±¡ï¼Œç›´åˆ°æœ€åé‡åˆ° }é€€å‡ºã€‚\nå°ç»“ é€šè¿‡ä¸Šé¢çš„åˆ†æå¯ä»¥çŸ¥é“ fastjson åœ¨å®ç°ä¸Šæ¯”æ ‡å‡†åº“ç®€å•ä¸å°‘ï¼Œæ€§èƒ½ä¹Ÿé«˜ä¸Šä¸å°‘ã€‚ä½¿ç”¨ Parse è§£æå¥½ JSON æ ‘ä¹‹åå¯ä»¥å¤šæ¬¡åå¤ä½¿ç”¨ï¼Œé¿å…äº†éœ€è¦åå¤è§£æè¿›è€Œæå‡æ€§èƒ½ã€‚\nä½†æ˜¯å®ƒçš„åŠŸèƒ½æ˜¯éå¸¸çš„ç®€é™‹çš„ï¼Œæ²¡æœ‰å¸¸ç”¨çš„å¦‚ JSON è½¬ Struct æˆ– JSON è½¬ map çš„æ“ä½œã€‚å¦‚æœåªæ˜¯æƒ³ç®€å•çš„è·å– JSON ä¸­çš„å€¼ï¼Œé‚£ä¹ˆä½¿ç”¨è¿™ä¸ªåº“æ˜¯éå¸¸æ–¹ä¾¿çš„ï¼Œä½†æ˜¯å¦‚æœæƒ³è¦æŠŠ JSON å€¼è½¬åŒ–æˆä¸€ä¸ªç»“æ„ä½“å°±éœ€è¦è‡ªå·±åŠ¨æ‰‹ä¸€ä¸ªä¸ªè®¾å€¼äº†ã€‚\nGJSON GJSON åœ¨æˆ‘çš„æµ‹è¯•ä¸­ï¼Œè™½ç„¶æ€§èƒ½æ˜¯æ²¡æœ‰ fastjson è¿™ä¹ˆæè‡´ï¼Œä½†æ˜¯åŠŸèƒ½æ˜¯éå¸¸å®Œå–„ï¼Œæ€§èƒ½ä¹Ÿæ˜¯ç›¸å½“ OK çš„ï¼Œä¸‹é¢å…ˆç®€å•ä»‹ç»ä¸€ä¸‹ GJSON çš„åŠŸèƒ½ã€‚\nGJSON çš„ä½¿ç”¨æ˜¯å’Œ fastjson å·®ä¸å¤šçš„ï¼Œä¹Ÿæ˜¯éå¸¸çš„ç®€å•ï¼Œåªè¦åœ¨å‚æ•°ä¸­ä¼ å…¥ json ä¸²ä»¥åŠéœ€è¦è·å–çš„å€¼å³å¯ï¼š\n1 2 json := `{\u0026#34;name\u0026#34;:{\u0026#34;first\u0026#34;:\u0026#34;li\u0026#34;,\u0026#34;last\u0026#34;:\u0026#34;dj\u0026#34;},\u0026#34;age\u0026#34;:18}` lastName := gjson.Get(json, \u0026#34;name.last\u0026#34;) é™¤äº†è¿™ä¸ªåŠŸèƒ½ä»¥å¤–è¿˜å¯ä»¥è¿›è¡Œç®€å•çš„æ¨¡ç³ŠåŒ¹é…ï¼Œæ”¯æŒåœ¨é”®ä¸­åŒ…å«é€šé…ç¬¦*å’Œ?ï¼Œ*åŒ¹é…ä»»æ„å¤šä¸ªå­—ç¬¦ï¼Œ?åŒ¹é…å•ä¸ªå­—ç¬¦ï¼Œå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 json := `{ \u0026#34;name\u0026#34;:{\u0026#34;first\u0026#34;:\u0026#34;Tom\u0026#34;, \u0026#34;last\u0026#34;: \u0026#34;Anderson\u0026#34;}, \u0026#34;age\u0026#34;: 37, \u0026#34;children\u0026#34;: [\u0026#34;Sara\u0026#34;, \u0026#34;Alex\u0026#34;, \u0026#34;Jack\u0026#34;] }` fmt.Println(\u0026#34;third child*:\u0026#34;, gjson.Get(json, \u0026#34;child*.2\u0026#34;)) fmt.Println(\u0026#34;first c?ild:\u0026#34;, gjson.Get(json, \u0026#34;c?ildren.0\u0026#34;)) child*.2ï¼šé¦–å…ˆchild*åŒ¹é…childrenï¼Œ.2è¯»å–ç¬¬ 3 ä¸ªå…ƒç´ ï¼› c?ildren.0ï¼šc?ildrenåŒ¹é…åˆ°childrenï¼Œ.0è¯»å–ç¬¬ä¸€ä¸ªå…ƒç´ ï¼› é™¤äº†æ¨¡ç³ŠåŒ¹é…ä»¥å¤–è¿˜æ”¯æŒä¿®é¥°ç¬¦æ“ä½œï¼š\n1 2 3 4 5 6 json := `{ \u0026#34;name\u0026#34;:{\u0026#34;first\u0026#34;:\u0026#34;Tom\u0026#34;, \u0026#34;last\u0026#34;: \u0026#34;Anderson\u0026#34;}, \u0026#34;age\u0026#34;: 37, \u0026#34;children\u0026#34;: [\u0026#34;Sara\u0026#34;, \u0026#34;Alex\u0026#34;, \u0026#34;Jack\u0026#34;] }` fmt.Println(\u0026#34;third child*:\u0026#34;, gjson.Get(json, \u0026#34;children|@reverse\u0026#34;)) children|@reverse å…ˆè¯»å–æ•°ç»„childrenï¼Œç„¶åä½¿ç”¨ä¿®é¥°ç¬¦@reverseç¿»è½¬ä¹‹åè¿”å›ï¼Œè¾“å‡ºã€‚\n1 nestedJSON := `{\u0026#34;nested\u0026#34;: [\u0026#34;one\u0026#34;, \u0026#34;two\u0026#34;, [\u0026#34;three\u0026#34;, \u0026#34;four\u0026#34;]]}` fmt.Println(gjson.Get(nestedJSON, \u0026#34;nested|@flatten\u0026#34;)) @flattenå°†æ•°ç»„nestedçš„å†…å±‚æ•°ç»„å¹³å¦åˆ°å¤–å±‚åè¿”å›ï¼š\n1 [\u0026#34;one\u0026#34;,\u0026#34;two\u0026#34;,\u0026#34;three\u0026#34;, \u0026#34;four\u0026#34;] ç­‰ç­‰è¿˜æœ‰ä¸€äº›å…¶ä»–æœ‰æ„æ€çš„åŠŸèƒ½ï¼Œå¤§å®¶å¯ä»¥å»æŸ¥é˜…ä¸€ä¸‹å®˜æ–¹æ–‡æ¡£ã€‚\nåˆ†æ GJSON çš„ Get æ–¹æ³•å‚æ•°æ˜¯ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼Œä¸€ä¸ªæ˜¯ JSON ä¸²ï¼Œå¦ä¸€ä¸ªå«åš Path è¡¨ç¤ºéœ€è¦è·å–çš„ JSON å€¼çš„åŒ¹é…è·¯å¾„ã€‚\nåœ¨ GJSON ä¸­å› ä¸ºè¦æ»¡è¶³å¾ˆå¤šçš„å®šä¹‰çš„è§£æåœºæ™¯ï¼Œæ‰€ä»¥è§£ææ˜¯åˆ†ä¸ºä¸¤éƒ¨åˆ†çš„ï¼Œéœ€è¦å…ˆè§£æå¥½ Path ä¹‹åæ‰å»éå†è§£æ JSON ä¸²ã€‚\nåœ¨è§£æè¿‡ç¨‹ä¸­å¦‚æœé‡åˆ°å¯ä»¥åŒ¹é…ä¸Šçš„å€¼ï¼Œé‚£ä¹ˆä¼šç›´æ¥è¿”å›ï¼Œä¸éœ€è¦ç»§ç»­å¾€ä¸‹éå†ï¼Œå¦‚æœæ˜¯åŒ¹é…å¤šä¸ªå€¼ï¼Œé‚£ä¹ˆä¼šä¸€ç›´éå†å®Œæ•´ä¸ª JSON ä¸²ã€‚å¦‚æœé‡åˆ°æŸä¸ª Path åœ¨ JSON ä¸²ä¸­åŒ¹é…ä¸åˆ°ï¼Œé‚£ä¹ˆä¹Ÿæ˜¯éœ€è¦éå†å®Œæ•´ä¸ª JSON ä¸²ã€‚\nåœ¨è§£æçš„è¿‡ç¨‹ä¸­ä¹Ÿä¸ä¼šåƒ fastjson ä¸€æ ·å°†è§£æçš„å†…å®¹ä¿å­˜åœ¨ä¸€ä¸ªç»“æ„ä½“ä¸­ï¼Œå¯ä»¥åå¤çš„åˆ©ç”¨ã€‚æ‰€ä»¥å½“è°ƒç”¨ GetMany æƒ³è¦è¿”å›å¤šä¸ªå€¼çš„æ—¶å€™ï¼Œå…¶å®ä¹Ÿæ˜¯éœ€è¦éå† JSON ä¸²å¤šæ¬¡ï¼Œå› æ­¤æ•ˆç‡ä¼šæ¯”è¾ƒä½ã€‚\né™¤æ­¤ä¹‹å¤–ï¼Œåœ¨è§£æ JSON çš„æ—¶å€™å¹¶ä¸ä¼šå¯¹å®ƒè¿›è¡Œæ ¡éªŒï¼Œå³ä½¿è¿™ä¸ªæ”¾å…¥çš„å­—ç¬¦ä¸²ä¸æ˜¯ä¸ª JSON ä¹Ÿä¼šç…§æ ·è§£æï¼Œæ‰€ä»¥éœ€è¦ç”¨æˆ·è‡ªå·±å»ç¡®ä¿æ”¾å…¥çš„æ˜¯ JSON ã€‚\nä»£ç  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 func Get(json, path string) Result { // è§£æ path if len(path) \u0026gt; 1 { ... } var i int var c = \u0026amp;parseContext{json: json} if len(path) \u0026gt;= 2 \u0026amp;\u0026amp; path[0] == \u0026#39;.\u0026#39; \u0026amp;\u0026amp; path[1] == \u0026#39;.\u0026#39; { c.lines = true parseArray(c, 0, path[2:]) } else { // æ ¹æ®ä¸åŒçš„å¯¹è±¡è¿›è¡Œè§£æ,è¿™é‡Œä¼šä¸€ç›´å¾ªç¯ï¼Œç›´åˆ°æ‰¾åˆ° \u0026#39;{\u0026#39; æˆ– \u0026#39;[\u0026#39; for ; i \u0026lt; len(c.json); i++ { if c.json[i] == \u0026#39;{\u0026#39; { i++ parseObject(c, i, path) break } if c.json[i] == \u0026#39;[\u0026#39; { i++ parseArray(c, i, path) break } } } if c.piped { res := c.value.Get(c.pipe) res.Index = 0 return res } fillIndex(json, c) return c.value } Get æ–¹æ³•é‡Œé¢å¯ä»¥çœ‹åˆ°æœ‰å¾ˆé•¿ä¸€ä¸²çš„ä»£ç æ˜¯ç”¨æ¥è§£æå„ç§ Pathï¼Œç„¶åä¸€ä¸ª for å¾ªç¯ä¸€ç›´éå† JSON ç›´åˆ°æ‰¾åˆ° â€˜{â€˜ æˆ– â€˜[â€˜ï¼Œç„¶åæ‰è¿›è¡Œç›¸åº”çš„é€»è¾‘è¿›è¡Œå¤„ç†ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 func parseObject(c *parseContext, i int, path string) (int, bool) { var pmatch, kesc, vesc, ok, hit bool var key, val string rp := parseObjectPath(path) if !rp.more \u0026amp;\u0026amp; rp.piped { c.pipe = rp.pipe c.piped = true } // åµŒå¥—ä¸¤ä¸ª for å¾ªç¯ å¯»æ‰¾ key å€¼ for i \u0026lt; len(c.json) { for ; i \u0026lt; len(c.json); i++ { if c.json[i] == \u0026#39;\u0026#34;\u0026#39; { i++ var s = i for ; i \u0026lt; len(c.json); i++ { if c.json[i] \u0026gt; \u0026#39;\\\\\u0026#39; { continue } // æ‰¾åˆ° key å€¼è·³è½¬åˆ° parse_key_string_done if c.json[i] == \u0026#39;\u0026#34;\u0026#39; { i, key, kesc, ok = i+1, c.json[s:i], false, true goto parse_key_string_done } ... } key, kesc, ok = c.json[s:], false, false // ç›´æ¥break parse_key_string_done: break } if c.json[i] == \u0026#39;}\u0026#39; { return i + 1, false } } if !ok { return i, false } // æ ¡éªŒæ˜¯å¦æ˜¯æ¨¡ç³ŠåŒ¹é… if rp.wild { if kesc { pmatch = match.Match(unescape(key), rp.part) } else { pmatch = match.Match(key, rp.part) } } else { if kesc { pmatch = rp.part == unescape(key) } else { pmatch = rp.part == key } } // è§£æ value hit = pmatch \u0026amp;\u0026amp; !rp.more for ; i \u0026lt; len(c.json); i++ { switch c.json[i] { default: continue case \u0026#39;\u0026#34;\u0026#39;: i++ i, val, vesc, ok = parseString(c.json, i) if !ok { return i, false } if hit { if vesc { c.value.Str = unescape(val[1 : len(val)-1]) } else { c.value.Str = val[1 : len(val)-1] } c.value.Raw = val c.value.Type = String return i, true } case \u0026#39;{\u0026#39;: if pmatch \u0026amp;\u0026amp; !hit { i, hit = parseObject(c, i+1, rp.path) if hit { return i, true } } else { i, val = parseSquash(c.json, i) if hit { c.value.Raw = val c.value.Type = JSON return i, true } } ... break } } return i, false } åœ¨ä¸Šé¢çœ‹ parseObject è¿™æ®µä»£ç çš„æ—¶å€™å…¶å®ä¸æ˜¯æƒ³è®©å¤§å®¶å­¦ä¹ å¦‚ä½•è§£æ JSONï¼Œä»¥åŠéå†å­—ç¬¦ä¸²ï¼Œè€Œæ˜¯æƒ³è¦è®©å¤§å®¶çœ‹çœ‹ä¸€ä¸ª bad case æ˜¯æ€æ ·çš„ã€‚for å¾ªç¯ä¸€å±‚å¥—ä¸€å±‚ï¼Œif ä¸€ä¸ªæ¥ä»¥ä¸€ä¸ªçœ‹å¾—æˆ‘ San å€¼ç‹‚æ‰ï¼Œè¿™ç‰‡ä»£ç å¤§å®¶æ˜¯ä¸æ˜¯çœ‹èµ·æ¥å¾ˆçœ¼ç†Ÿï¼Ÿæ˜¯ä¸æ˜¯æœ‰ç‚¹åƒå·¥ä½œä¸­é‡åˆ°çš„æŸä¸ªåŒäº‹å†™çš„ä»£ç ï¼Ÿ\nå°ç»“ ä¼˜ç‚¹ï¼š\næ€§èƒ½ç›¸å¯¹æ ‡å‡†åº“æ¥è¯´è¿˜ç®—ä¸é”™ï¼› å¯ç©æ€§é«˜ï¼Œå¯ä»¥å„ç§æ£€ç´¢ã€è‡ªå®šä¹‰è¿”å›å€¼ï¼Œè¿™ç‚¹éå¸¸æ–¹ä¾¿ï¼›\nç¼ºç‚¹ï¼š ä¸ä¼šæ ¡éªŒ JSON çš„æ­£ç¡®æ€§ï¼› ä»£ç çš„ Code smell å¾ˆé‡ã€‚ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœéœ€è¦è§£æè¿”å› JSON çš„å€¼çš„è¯ï¼ŒGetMany å‡½æ•°ä¼šæ ¹æ®æŒ‡å®šçš„ key å€¼æ¥ä¸€æ¬¡æ¬¡éå† JSON å­—ç¬¦ä¸²ï¼Œè§£æä¸º map å¯ä»¥å‡å°‘éå†æ¬¡æ•°ã€‚\njsonparser è¿™ä¹Ÿæ˜¯ä¸€ä¸ªæ¯”è¾ƒçƒ­é—¨ï¼Œå¹¶ä¸”å·ç§°é«˜æ€§èƒ½ï¼Œèƒ½æ¯”æ ‡å‡†åº“å¿«åå€çš„è§£æé€Ÿåº¦ã€‚\nåˆ†æ jsonparser ä¹Ÿæ˜¯ä¼ å…¥ä¸€ä¸ª JSON çš„ byte åˆ‡ç‰‡ï¼Œä»¥åŠå¯ä»¥é€šè¿‡ä¼ å…¥å¤šä¸ª key å€¼æ¥å¿«é€Ÿå®šä½åˆ°ç›¸åº”çš„å€¼ï¼Œå¹¶è¿”å›ã€‚\nå’Œ GJSON ä¸€æ ·ï¼Œåœ¨è§£æè¿‡ç¨‹ä¸­æ˜¯ä¸ä¼šåƒ fastjson ä¸€æ ·æœ‰ä¸ªæ•°æ®ç»“æ„ç¼“å­˜å·²è§£æè¿‡çš„ JSONå­—ç¬¦ä¸²ï¼Œä½†æ˜¯é‡åˆ°éœ€è¦è§£æå¤šä¸ªå€¼çš„æƒ…å†µå¯ä»¥ä½¿ç”¨ EachKey å‡½æ•°æ¥è§£æå¤šä¸ªå€¼ï¼Œåªéœ€è¦éå†ä¸€æ¬¡ JSONå­—ç¬¦ä¸²å³å¯å®ç°è·å–å¤šä¸ªå€¼çš„æ“ä½œã€‚\nå¦‚æœé‡åˆ°å¯ä»¥åŒ¹é…ä¸Šçš„å€¼ï¼Œé‚£ä¹ˆä¼šç›´æ¥è¿”å›ï¼Œä¸éœ€è¦ç»§ç»­å¾€ä¸‹éå†ï¼Œå¦‚æœæ˜¯åŒ¹é…å¤šä¸ªå€¼ï¼Œé‚£ä¹ˆä¼šä¸€ç›´éå†å®Œæ•´ä¸ª JSON ä¸²ã€‚å¦‚æœé‡åˆ°æŸä¸ª Path åœ¨ JSON ä¸²ä¸­åŒ¹é…ä¸åˆ°ï¼Œé‚£ä¹ˆä¹Ÿæ˜¯éœ€è¦éå†å®Œæ•´ä¸ª JSON ä¸²ã€‚\nå¹¶ä¸”åœ¨éå† JSON ä¸²çš„æ—¶å€™é€šè¿‡å¾ªç¯çš„æ–¹å¼æ¥å‡å°‘é€’å½’çš„ä½¿ç”¨ï¼Œå‡å°‘äº†è°ƒç”¨æ ˆçš„æ·±åº¦ï¼Œä¸€å®šç¨‹åº¦ä¸Šä¹Ÿæ˜¯å¯ä»¥æå‡æ€§èƒ½ã€‚\nåœ¨åŠŸèƒ½æ€§ä¸Š ArrayEachã€ObjectEachã€EachKey ç­‰ä¸‰ä¸ªå‡½æ•°éƒ½å¯ä»¥ä¼ å…¥ä¸€ä¸ªè‡ªå®šä¹‰çš„å‡½æ•°ï¼Œé€šè¿‡å‡½æ•°æ¥å®ç°ä¸ªæ€§åŒ–çš„éœ€æ±‚ï¼Œä½¿å¾—å®ç”¨æ€§å¤§å¤§å¢å¼ºã€‚\nå¯¹äº jsonparser æ¥è¯´ï¼Œä»£ç æ²¡ä»€ä¹ˆå¯åˆ†æçš„ï¼Œéå¸¸çš„æ¸…æ™°ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥è‡ªå·±å»çœ‹çœ‹ã€‚\nå°ç»“ å¯¹äº jsonparser æ¥è¯´ç›¸å¯¹æ ‡å‡†åº“æ¯”è¾ƒè€Œè¨€æ€§èƒ½å¦‚æ­¤é«˜çš„åŸå› å¯ä»¥æ€»ç»“ä¸ºï¼š\nä½¿ç”¨ for å¾ªç¯æ¥å‡å°‘é€’å½’çš„ä½¿ç”¨ï¼› ç›¸æ¯”æ ‡å‡†åº“è€Œè¨€æ²¡æœ‰ä½¿ç”¨åå°„ï¼› åœ¨æŸ¥æ‰¾ç›¸åº”çš„ key å€¼æ‰¾åˆ°äº†ä¾¿ç›´æ¥é€€å‡ºï¼Œå¯ä»¥ä¸ç”¨ç»§ç»­å¾€ä¸‹é€’å½’ï¼› æ‰€æ“ä½œçš„ JSON ä¸²éƒ½æ˜¯å·²è¢«ä¼ å…¥çš„ï¼Œä¸ä¼šå»é‡æ–°å†å»ç”³è¯·æ–°çš„ç©ºé—´ï¼Œå‡å°‘äº†å†…å­˜åˆ†é…ï¼› é™¤æ­¤ä¹‹å¤–åœ¨ api çš„è®¾è®¡ä¸Šä¹Ÿæ˜¯éå¸¸çš„å®ç”¨ï¼ŒArrayEachã€ObjectEachã€EachKey ç­‰ä¸‰ä¸ªå‡½æ•°éƒ½å¯ä»¥ä¼ å…¥ä¸€ä¸ªè‡ªå®šä¹‰çš„å‡½æ•°åœ¨å®é™…çš„ä¸šåŠ¡å¼€å‘ä¸­è§£å†³äº†ä¸å°‘é—®é¢˜ã€‚\nç¼ºç‚¹ä¹Ÿæ˜¯éå¸¸çš„æ˜æ˜¾ï¼Œä¸èƒ½å¯¹ JSON è¿›è¡Œæ ¡éªŒï¼Œå³ä½¿è¿™ä¸ª ä¼ å…¥çš„ä¸æ˜¯ JSONã€‚\næ€§èƒ½å¯¹æ¯” è§£æå° JSON å­—ç¬¦ä¸²\nè§£æä¸€ä¸ªç»“æ„ç®€å•ï¼Œå¤§å°çº¦ 190 bytes çš„å­—ç¬¦ä¸²\nåº“å æ“ä½œ æ¯æ¬¡è¿­ä»£è€—æ—¶ å ç”¨å†…å­˜æ•° åˆ†é…å†…å­˜æ¬¡æ•° æ€§èƒ½ æ ‡å‡†åº“ è§£æä¸ºmap 724 ns/op 976 B/op 51 allocs/op æ…¢ è§£æä¸ºstruct 297 ns/op 256 B/op 5 allocs/op ä¸€èˆ¬ fastjson get 68.2 ns/op 0 B/op 0 allocs/op æœ€å¿« parse 35.1 ns/op 0 B/op 0 allocs/op æœ€å¿« GJSON è½¬map 255 ns/op 1009 B/op 11 allocs/op ä¸€èˆ¬ get 232 ns/op 448 B/op 1 allocs/op ä¸€èˆ¬ jsonparser get 106 ns/op 232 B/op 3 allocs/op å¿« è§£æä¸­ç­‰å¤§å° JSON å­—ç¬¦ä¸²\nè§£æä¸€ä¸ªå…·æœ‰ä¸€å®šå¤æ‚åº¦ï¼Œå¤§å°çº¦ 2.3KB çš„å­—ç¬¦ä¸²\nåº“å æ“ä½œ æ¯æ¬¡è¿­ä»£è€—æ—¶ å ç”¨å†…å­˜æ•° åˆ†é…å†…å­˜æ¬¡æ•° æ€§èƒ½ æ ‡å‡†åº“ è§£æä¸ºmap 4263 ns/op 10212 B/op 208 allocs/op æ…¢ è§£æä¸ºstruct 4789 ns/op 9206 B/op 259 allocs/op æ…¢ fastjson get 285 ns/op 0 B/op 0 allocs/op æœ€å¿« parse 302 ns/op 0 B/op 0 allocs/op æœ€å¿« GJSON è½¬map 2571 ns/op 8539 B/op 83 allocs/op ä¸€èˆ¬ get 1489 ns/op 448 B/op 1 allocs/op ä¸€èˆ¬ jsonparser get 878 ns/op 2728 B/op 5 allocs/op å¿« è§£æå¤§ JSON å­—ç¬¦ä¸²\nè§£æå¤æ‚åº¦æ¯”è¾ƒé«˜ï¼Œå¤§å°çº¦ 2.2MB çš„å­—ç¬¦ä¸²\nåº“å æ“ä½œ æ¯æ¬¡è¿­ä»£è€—æ—¶ å ç”¨å†…å­˜æ•° åˆ†é…å†…å­˜æ¬¡æ•° æ€§èƒ½ æ ‡å‡†åº“ è§£æä¸ºmap 2292959 ns/op 5214009 B/op 95402 allocs/op æ…¢ è§£æä¸ºstruct 1165490 ns/op 2023 B/op 76 allocs/op ä¸€èˆ¬ fastjson get 368056 ns/op 0 B/op 0 allocs/op å¿« parse 371397 ns/op 0 B/op 0 allocs/op å¿« GJSON è½¬map 1901727 ns/op 4788894 B/op 54372 allocs/op ä¸€èˆ¬ get 1322167 ns/op 448 B/op 1 allocs/op ä¸€èˆ¬ jsonparser get 233090 ns/op 1788865 B/op 376 allocs/op æœ€å¿« æ€»ç»“ åœ¨è¿™æ¬¡çš„åˆ†äº«è¿‡ç¨‹ä¸­ï¼Œæˆ‘æ‰¾äº†å¾ˆå¤š JSON çš„è§£æåº“åˆ†åˆ«è¿›è¡Œå¯¹æ¯”åˆ†æï¼Œå¯ä»¥å‘ç°è¿™äº›é«˜æ€§èƒ½çš„è§£æåº“åŸºæœ¬ä¸Šéƒ½æœ‰ä¸€äº›å…±åŒçš„ç‰¹ç‚¹ï¼š\nä¸ä½¿ç”¨åå°„ï¼› é€šè¿‡éå† JSON å­—ç¬¦ä¸²çš„å­—èŠ‚æ¥æŒ¨ä¸ªè§£æï¼› å°½é‡ä½¿ç”¨ä¼ å…¥çš„ JSON å­—ç¬¦ä¸²æ¥è¿›è¡Œè§£æéå†ï¼Œå‡å°‘å†…å­˜åˆ†é…ï¼› ç‰ºç‰²äº†ä¸€å®šçš„å…¼å®¹æ€§ï¼› å°½ç®¡å¦‚æ­¤ï¼Œä½†æ˜¯åŠŸèƒ½ä¸Šï¼Œæ¯ä¸ªéƒ½æœ‰ä¸€å®šçš„ç‰¹è‰² fastjson çš„ api æ“ä½œæœ€ç®€å•ï¼›GJSON æä¾›äº†æ¨¡ç³ŠæŸ¥æ‰¾çš„åŠŸèƒ½ï¼Œè‡ªå®šä¹‰ç¨‹åº¦æœ€é«˜ï¼›jsonparser åœ¨å®ç°é«˜æ€§èƒ½çš„è§£æè¿‡ç¨‹ä¸­ï¼Œè¿˜å¯ä»¥æ’å…¥å›è°ƒå‡½æ•°æ‰§è¡Œï¼Œæä¾›äº†ä¸€å®šç¨‹åº¦ä¸Šçš„ä¾¿åˆ©ã€‚\nç»¼ä¸Šï¼Œå›åˆ°æ–‡ç« çš„å¼€å¤´ä¸­ï¼Œå¯¹äºæˆ‘è‡ªå·±çš„ä¸šåŠ¡æ¥è¯´ï¼Œä¸šåŠ¡ä¹Ÿåªæ˜¯ç®€å•çš„è§£æ http è¯·æ±‚è¿”å›çš„ JSON ä¸²çš„éƒ¨åˆ†å­—æ®µï¼Œå¹¶ä¸”å­—æ®µéƒ½æ˜¯ç¡®å®šçš„ï¼Œæ— éœ€æœç´¢åŠŸèƒ½ï¼Œä½†æ˜¯æœ‰æ—¶å€™éœ€è¦åšä¸€äº›è‡ªå®šä¹‰çš„æ“ä½œï¼Œæ‰€ä»¥å¯¹æˆ‘æ¥è¯´ jsonparser æ˜¯æœ€åˆé€‚çš„ã€‚\næ‰€ä»¥å¦‚æœå„ä½å¯¹æ€§èƒ½æœ‰ä¸€å®šè¦æ±‚ï¼Œä¸å¦¨ç»“åˆè‡ªå·±çš„ä¸šåŠ¡æƒ…å†µæ¥æŒ‘é€‰ä¸€æ¬¾ JSON è§£æå™¨ã€‚\nReference https://github.com/buger/jsonparser\nhttps://github.com/tidwall/gjson\nhttps://github.com/valyala/fastjson\nhttps://github.com/json-iterator/go\nhttps://github.com/mailru/easyjson\nhttps://github.com/Jeffail/gabs\nhttps://github.com/bitly/go-simplejson\n","date":"2024-06-13T17:10:25+08:00","permalink":"https://huizhou92.com/zh-cn/p/%E6%B7%B1%E5%85%A5-go-%E4%B8%AD%E5%90%84%E4%B8%AA%E9%AB%98%E6%80%A7%E8%83%BD-json-%E8%A7%A3%E6%9E%90%E5%BA%93/","title":"æ·±å…¥ Go ä¸­å„ä¸ªé«˜æ€§èƒ½ JSON è§£æåº“"},{"content":"ä¸Šå‘¨ï¼ŒGo 1.23 è¿›å…¥å†»ç»“æœŸï¼Œè¿™æ„å‘³ç€ä¸ä¼šæ·»åŠ ä»»ä½•æ–°åŠŸèƒ½ï¼Œå¹¶ä¸”ä»»ä½•å·²æ·»åŠ çš„åŠŸèƒ½ä¸å¤ªå¯èƒ½è¢«åˆ é™¤ã€‚è¿™æ˜¯ä¸€ä¸ªé¢„è§ˆå³å°†å‘ç”Ÿçš„å˜åŒ–çš„å¥½æœºä¼šã€‚\nè¿™ç¯‡æ–‡ç« ï¼Œæ¥äº†è§£ä¸€ä¸‹ 1.23 è½¬æ­£çš„ iter åŒ…ã€‚\nThis article is first published in the medium MPP plan. If you are a medium user, please follow me in medium. Thank you very much.\nåœ¨Go 1.22ä¸­ï¼Œå¼•å…¥äº†range over funcå®éªŒæ€§åŠŸèƒ½ï¼Œä½†éœ€è¦é€šè¿‡å‚æ•°GOEXPERIMENT=rangefuncå¯ç”¨ã€‚åœ¨Go 1.23ä¸­ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ä»£ç å®ç°è¿™ç§è¿­ä»£æ–¹å¼ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 func Backward(s []string) func(yield func(string) bool) { return func(yield func(string) bool) { for i := len(s) - 1; i \u0026gt;= 0; i-- { yield(strings.ToUpper(s[i])) } } } â€‹ func ToUpperByIter() { sl := []string{\u0026#34;hello\u0026#34;, \u0026#34;world\u0026#34;, \u0026#34;golang\u0026#34;} for v := range Backward(sl) { // do business } } yieldæ˜¯ä¼ é€’ç»™è¿­ä»£å™¨çš„å¯è°ƒç”¨å‡½æ•°çš„å¸¸è§„åç§°ã€‚\næˆ‘ä»¬è€ƒè™‘ä¸€ä¸‹å¦‚ä½•åœ¨ä¸ä½¿ç”¨â€œiterâ€åŒ…çš„æƒ…å†µä¸‹ç¼–å†™ä»£ç æ¥å®ç°ç›¸åŒçš„åŠŸèƒ½ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 func Convert[S any, D any](src []S, mapFn func(s S) D) []D { r := make([]D, 0, len(src)) for _, i := range src { r = append(r, mapFn(i)) } return r } func ToUpByString() { sl := []string{\u0026#34;hello\u0026#34;, \u0026#34;world\u0026#34;, \u0026#34;golang\u0026#34;} s0 := Convert(sl, func(v string) string { return strings.ToUpper(v) }) for _, v := range s0 { // do business } } æ€§èƒ½å¯¹æ¯” 1 2 3 4 5 6 7 8 9 10 11 12 13 âœ huizhou92 git:(master) âœ— go test -bench . -count=3 goos: darwin goarch: arm64 pkg: huizhou92 cpu: Apple M1 Pro BenchmarkToUpByString-10 8568332 128.7 ns/op BenchmarkToUpByString-10 9310351 128.6 ns/op BenchmarkToUpByString-10 9344986 128.5 ns/op BenchmarkToUpByIter-10 12440120 96.22 ns/op BenchmarkToUpByIter-10 12436645 96.25 ns/op BenchmarkToUpByIter-10 12371175 96.64 ns/op PASS ok huizhou92 8.162s ç»“æœå¾ˆæ˜æ˜¾ï¼šToUpperByIter æ€§èƒ½æ›´å¥½ï¼Œå› ä¸ºå®ƒä¸ä¼šé‡æ–°åˆ†é…æ–°çš„sliceï¼Œä½¿å¾—å®ƒæ¯”ä»¥å‰çš„æ–¹æ³•æ›´é«˜æ•ˆã€‚\niter çš„ç›®æ ‡ iter åŒ…æ—¨åœ¨æä¾›ç»Ÿä¸€ä¸”é«˜æ•ˆçš„è¿­ä»£æ–¹æ³•ã€‚å®ƒä¸ºè‡ªå®šä¹‰å®¹å™¨ç±»ï¼ˆå°¤å…¶æ˜¯åœ¨å¼•å…¥æ³›å‹ä¹‹åï¼‰æä¾›äº†æ ‡å‡†çš„è¿­ä»£æ¥å£ï¼Œå¹¶å¯ä»¥æ›¿æ¢ä¸€äº›è¿”å›åˆ‡ç‰‡çš„ç°æœ‰ APIã€‚é€šè¿‡ä½¿ç”¨è¿­ä»£å™¨å¹¶åˆ©ç”¨ç¼–è¯‘å™¨ä¼˜åŒ–ï¼Œå¯ä»¥æé«˜æ€§èƒ½ã€‚æ­¤å¤–ï¼Œå®ƒè¿˜æä¾›äº†é€‚åˆå‡½æ•°å¼ç¼–ç¨‹é£æ ¼çš„æ ‡å‡†è¿­ä»£æœºåˆ¶ã€‚\nå¦‚ä½•ä½¿ç”¨ iter iteræ”¯æŒä¸¤ç§ç±»å‹çš„è¿­ä»£å™¨ï¼š\n1 2 3 4 5 6 7 8 9 // Seq is an iterator over sequences of individual values. // When called as seq(yield), seq calls yield(v) for each value v in the sequence, // stopping early if yield returns false. type Seq[V any] func(yield func(V) bool) // Seq2 is an iterator over sequences of pairs of values, most commonly key-value pairs. // When called as seq(yield), seq calls yield(k, v) for each pair (k, v) in the sequence, // stopping early if yield returns false. type Seq2[K, V any] func(yield func(K, V) bool) map åŒ…å·²ç»ä½¿ç”¨ iter æ¥æ·»åŠ äº†è¯¸å¦‚ All å’Œ Keys ç­‰æ–¹æ³•ã€‚è¿™é‡Œæ˜¯å®ƒçš„å®ç°å‚è€ƒï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 //https://go.googlesource.com/go/blob/c83b1a7013784098c2061ae7be832b2ab7241424/src/maps/iter.go#L12 // All returns an iterator over key-value pairs from m. // The iteration order is not specified and is not guaranteed // to be the same from one call to the next. func All[Map ~map[K]V, K comparable, V any](m Map) iter.Seq2[K, V] { return func(yield func(K, V) bool) { for k, v := range m { if !yield(k, v) { return } } } } // Keys returns an iterator over keys in m. // The iteration order is not specified and is not guaranteed // to be the same from one call to the next. func Keys[Map ~map[K]V, K comparable](m Map) iter.Seq[K] { return func(yield func(K) bool) { for k := range m { if !yield(k) { return } } } } äº‰è®º â€œåœ¨æˆ‘çœ‹æ¥ï¼Œyield æ˜¯ä¸€ä¸ªè¶³å¤Ÿå¤æ‚çš„æ¦‚å¿µï¼Œä¼šå¯¼è‡´å‡ºç°å¤§é‡ç³Ÿç³•çš„ã€éš¾ä»¥ç†è§£çš„ä»£ç ã€‚è¿™ä¸ªå»ºè®®åªæä¾›äº†è¯­æ³•ç³–ï¼Œç”¨äºç¼–å†™è¯­è¨€ä¸­å·²ç»è¶…å‡ºå¯èƒ½èŒƒå›´çš„å†…å®¹ã€‚æˆ‘è®¤ä¸ºè¿™è¿èƒŒäº†â€œä¸€ä¸ªé—®é¢˜ - ä¸€ä¸ªè§£å†³æ–¹æ¡ˆâ€çš„è§„åˆ™ã€‚æ‹œæ‰˜ï¼Œè®© Go ä¿æŒæ— èŠã€‚â€ æ¥æº\nè¿™æ˜¯ç¤¾åŒºå†…å¸¸è§çš„åå¯¹æ„è§ã€‚yield ä¸å®¹æ˜“ç†è§£ï¼Œå¹¶ä¸”æˆ‘ä»¬å¯ä»¥é€šè¿‡å¤šç§æ–¹å¼å®ç°è¿­ä»£å™¨ã€‚\nç»“è®º æˆ‘æ”¯æŒæ·»åŠ iterã€‚\niteråŒ…ä¸ºå¼€å‘äººå‘˜æä¾›äº†è®¸å¤šå¯èƒ½æ€§ï¼Œæ—¨åœ¨ç®€åŒ–ä»£ç å¹¶é‡‡ç”¨æ›´å¤šçš„å‡½æ•°å¼ç¼–ç¨‹å®è·µã€‚ç„¶è€Œï¼Œç”±äºå¯¹æ€§èƒ½ã€å¤æ‚æ€§å’Œå­¦ä¹ æ›²çº¿çš„æ‹…å¿§ï¼Œå®ƒçš„æ¥å—åº¦å­˜åœ¨åˆ†æ­§ã€‚\nä¸ä»»ä½•æ–°å·¥å…·ä¸€æ ·ï¼Œå…³é”®æ˜¯åœ¨æä¾›æ˜æ˜¾å¥½å¤„çš„åœ°æ–¹å¹³è¡¡å…¶ä½¿ç”¨ï¼Œå¹¶åŒæ—¶æ³¨æ„æ½œåœ¨ç¼ºç‚¹ã€‚æ¯«æ— ç–‘é—®ï¼ŒGoç¤¾åŒºå°†ç»§ç»­æ¢ç´¢å’Œè¾©è®ºå¦‚ä½•åˆ©ç”¨iterçš„åŠ›é‡è€Œä¸æŸå®³è¯¥è¯­è¨€çš„åŸºæœ¬åŸåˆ™ã€‚\nå‚è€ƒèµ„æ–™ 61405 56413 iterators_in_go_123 ","date":"2024-06-11T17:33:16+08:00","permalink":"https://huizhou92.com/zh-cn/p/go-1.23-new-iter-package/","title":"Go 1.23: æ–°åŒ… Iter"},{"content":"ä¸Šå‘¨ï¼ŒGo 1.23 è¿›å…¥å†»ç»“æœŸï¼Œè¿™æ„å‘³ç€ä¸ä¼šæ·»åŠ ä»»ä½•æ–°åŠŸèƒ½ï¼Œå¹¶ä¸”ä»»ä½•å·²æ·»åŠ çš„åŠŸèƒ½ä¸å¤ªå¯èƒ½è¢«åˆ é™¤ã€‚è¿™æ˜¯ä¸€ä¸ªé¢„è§ˆå³å°†å‘ç”Ÿçš„å˜åŒ–çš„å¥½æœºä¼šã€‚\nè¿™ç¯‡æ–‡ç« ï¼Œæˆ‘ä»¬æ¥ä»‹ç»å¼•å…¥çš„æ–°åŒ…unique\nThis article is first published in the medium MPP plan. If you are a medium user, please follow me in medium. Thank you very much.\næ ¹æ®wikipediaçš„æè¿°ï¼Œinterningæ˜¯æŒ‰éœ€é‡å¤ä½¿ç”¨å…·æœ‰åŒç­‰å€¼å¯¹è±¡çš„æŠ€æœ¯ï¼Œå‡å°‘åˆ›å»ºæ–°å¯¹è±¡çš„åŠ¨ä½œã€‚è¿™ç§åˆ›å»ºæ¨¡å¼ç»å¸¸ç”¨äºä¸åŒç¼–ç¨‹è¯­è¨€ä¸­çš„æ•°å’Œå­—ç¬¦ä¸²ï¼Œå¯ä»¥é¿å…ä¸å¿…è¦çš„å¯¹è±¡é‡å¤åˆ†é…çš„å¼€é”€ã€‚\nunique å‚è€ƒäº†go4.org/intern ,å°†å®ƒç§»åŠ¨åˆ°äº† å®˜æ–¹åº“ï¼Œå¹¶ä¸”åšäº†ç›¸åº”çš„ä¿®æ”¹ã€‚ issue #62483\nå°±åƒå®˜æ–¹æè¿°çš„ä¸€æ · unique è¿™ä¸ªåŒ…æä¾›äº†ä¸€ç§è½»é‡åŒ–ï¼ˆuniqueä»…ä»…å…«ä¸ªå­—èŠ‚ï¼‰çš„æ¯”è¾ƒä¸¤ä¸ªå˜é‡æ˜¯å¦ç›¸ç­‰çš„å®ç°ã€‚æ¯”å¦‚ä¸‹é¢è¿™æ®µä»£ç \næ€§èƒ½æå‡è¿˜æ˜¯å¾ˆæ˜æ˜¾çš„\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 âœ unique git:(master) âœ— /Users/hxzhouh/workspace/googlesource/go/bin/go test -bench=\u0026#39;BenchmarkMake1\u0026#39; -count=5 goos: darwin goarch: arm64 pkg: unique cpu: Apple M1 Pro BenchmarkMake1-10 122033748 9.692 ns/op BenchmarkMake1-10 123878858 9.688 ns/op BenchmarkMake1-10 123927121 9.706 ns/op BenchmarkMake1-10 123849468 9.759 ns/op BenchmarkMake1-10 123306187 9.673 ns/op PASS ok unique 11.055s âœ unique git:(master) âœ— /Users/hxzhouh/workspace/googlesource/go/bin/go test -bench=\u0026#39;BenchmarkMake2\u0026#39; -count=5 goos: darwin goarch: arm64 pkg: unique cpu: Apple M1 Pro BenchmarkMake2-10 1000000000 0.3118 ns/op BenchmarkMake2-10 1000000000 0.3114 ns/op BenchmarkMake2-10 1000000000 0.3119 ns/op BenchmarkMake2-10 1000000000 0.3136 ns/op BenchmarkMake2-10 1000000000 0.3115 ns/op PASS ok unique 1.875s ä½†æ˜¯ ä½ ä¸åº”è¯¥æŠŠä»–å½“ä½œä¸€ä¸ªå…¨å±€å˜é‡æ¥ç”¨,å­˜å‚¨å…±äº«æ•°æ®ï¼Œunique çš„åº•å±‚å®ç°å…¶å®æ˜¯ä¸€ä¸ªmap,æŸ¥è¯¢çš„æˆæœ¬ä¹Ÿæ˜¯å¾ˆé«˜çš„ã€‚\næ¯”å¦‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 âœ huizhou92_test git:(master) âœ— /Users/hxzhouh/workspace/googlesource/go/bin/go test --bench=BenchmarkBusinessUnique --count=5 goos: darwin goarch: arm64 pkg: huizhou92_test cpu: Apple M1 Pro BenchmarkBusinessUnique-10 3114 373867 ns/op BenchmarkBusinessUnique-10 3280 390818 ns/op BenchmarkBusinessUnique-10 2941 376503 ns/op BenchmarkBusinessUnique-10 3291 389665 ns/op BenchmarkBusinessUnique-10 2954 398610 ns/op PASS ok huizhou92_test 6.320s âœ huizhou92_test git:(master) âœ— /Users/hxzhouh/workspace/googlesource/go/bin/go test --bench=BenchmarkBusinessString --count=5 goos: darwin goarch: arm64 pkg: huizhou92_test cpu: Apple M1 Pro BenchmarkBusinessString-10 526721706 2.185 ns/op BenchmarkBusinessString-10 548612287 2.183 ns/op BenchmarkBusinessString-10 549425077 2.188 ns/op BenchmarkBusinessString-10 549012100 2.182 ns/op BenchmarkBusinessString-10 548929644 2.183 ns/op PASS ok huizhou92_test 7.237s æ­£æ˜¯å› ä¸ºè¿™æ ·ï¼Œå…³äºuniqueçš„è®¨è®ºå…¶å®è¿˜åœ¨ç»§ç»­ï¼Œå¯èƒ½æ˜¯å› ä¸ºç”¨åˆ°çš„åœ°æ–¹ä¸æ˜¯å¾ˆå¤šï¼Ÿä¸ç®¡æ€ä¹ˆæ ·ï¼Œ è¿™ä¸ªæ–°çš„åŒ…è¿›å…¥æ ‡å‡†åº“å·²ç»æ˜¯äº‹å®äº†ã€‚net/netip å·²ç»ç”¨unique é‡æ„äº†å®ƒï¼Œç”¨æ¥æ¯”å¯¹IPåœ°å€çš„è¯¦ç»†ä¿¡æ¯ã€‚\n","date":"2024-06-04T09:54:42+08:00","image":"https://images.yixiao9206.cn/blog-images/2024/06/0a8a9a271b2db6d5922f8e58e589b187.png","permalink":"https://huizhou92.com/zh-cn/p/golang-1.23-%E6%96%B0%E7%9A%84-unique-%E5%8C%85/","title":"Golang 1.23: æ–°çš„ unique åŒ…"},{"content":"ä¼—æ‰€å‘¨çŸ¥ï¼ŒHTTPSå¯ä»¥è§£å†³HTTPæ˜æ–‡ä¼ è¾“è¿‡ç¨‹ä¸­çš„å®‰å…¨æ€§é—®é¢˜ï¼Œå°¤å…¶æ˜¯ä¸­é—´äººæ”»å‡»é—®é¢˜ã€‚å…¶æœ€åˆçš„å…¨ç§°æ˜¯HTTP over SSLï¼ˆæˆ–è€…è¯´ http Securityï¼‰ã€‚å…¶ä¸­çš„SSLæ˜¯æŒ‡Secure Sockets Layerï¼Œåæ¥SSLè¢«TLSï¼ˆTransport Layer Security ï¼‰æ‰€å–ä»£ã€‚ä»Šå¤©æˆ‘ä»¬å°±æ¥æ€»ç»“ä¸€ä¸‹HTTPSçš„è¦ç‚¹\nThis article is first published in the medium MPP plan. If you are a medium user, please follow me in medium. Thank you very much.\nHTTPS ç‰ˆæœ¬ å½“å‰äººä»¬ä¸€èˆ¬å°†SSL,TLSè¿™ä¸¤ä¸ªåè®®ç»Ÿç§°ä¸ºSSL/TLSåè®®ï¼Œä½†å¤§å®¶æ—¥å¸¸è¯´SSLçš„æ—¶ï¼Œé»˜è®¤è¿˜æ˜¯æŒ‡TLSåè®®ã€‚\nTLS åè®®åœ¨ç‰ˆæœ¬ä¸Šæœ‰1.1ã€1.2ã€1.3ï¼Œå…¶ä¸­1.2æ›¾ç»æ˜¯ä¸»æµï¼Œç°åœ¨æ¨èä½¿ç”¨æ”¹è¿›åçš„ TLS 1.3ï¼Œå®ƒå‡çº§äº†HandShakeå’ŒRecordåè®®ï¼Œä¼šä½¿å¾—é€šä¿¡æ›´åŠ å®‰å…¨å’Œé«˜æ•ˆã€‚\nå®‰å…¨ä¸Šï¼ŒTLS 1.3 ç§»é™¤äº†ä¸€äº›åœ¨ TLS 1.2 ä¸­è¢«è®¤ä¸ºæ˜¯ä¸å®‰å…¨çš„åŠ å¯†ç®—æ³•ï¼Œå¦‚ RC4ã€DESã€3DESã€AES-CBC å’Œ MD5 ç­‰ï¼Œè¿™æ ·å¯ä»¥å‡å°‘å®‰å…¨æ¼æ´çš„é£é™©ã€‚\næ€§èƒ½ä¸Šï¼ŒTLS 1.3 å‡å°‘äº†æ¡æ‰‹è¿‡ç¨‹ä¸­çš„å¾€è¿”æ¬¡æ•°ï¼ˆRTTï¼‰ï¼Œä»è€ŒåŠ å¿«äº†è¿æ¥çš„å»ºç«‹é€Ÿåº¦ã€‚åœ¨æœ€ä½³æƒ…å†µä¸‹ï¼ŒTLS 1.3 åªéœ€è¦ä¸€æ¬¡å¾€è¿”å°±å¯ä»¥å®Œæˆæ¡æ‰‹ï¼ŒåŒæ—¶æ”¯æŒ0-RTTæ‰©å±•ï¼Œè€Œ TLS 1.2 éœ€è¦ä¸¤æ¬¡æˆ–æ›´å¤šã€‚\nå½“ç„¶ï¼Œä½œä¸ºè®¾è®¡ç²¾è‰¯çš„äº’è”ç½‘åè®®ï¼ŒTLS 1.3ä¹Ÿé€šè¿‡helloæ¡æ‰‹æ¶ˆæ¯çš„æ‰©å±•åè®®è€ƒè™‘äº†æœ€å¤§åŒ–å‘å‰å…¼å®¹ï¼Œè¿™ç‚¹ä¸å†èµ˜è¿°ã€‚\nHTTPS æ ¸å¿ƒæµç¨‹ ä¾æ®ä¸åŒç‰ˆæœ¬çš„å·®å¼‚ï¼Œç»†èŠ‚æµç¨‹ä¼šç•¥æœ‰ä¸åŒï¼Œä¸è¿½æ±‚ä¸¥è°¨ç»†è‡´çš„æƒ…å†µä¸‹ï¼ŒHTTPSå·¥ä½œæµç¨‹å¦‚ä¸‹ã€‚\nbytebytego çš„è¿™ä¸ªå›¾éå¸¸å…·æœ‰è¡¨ç°åŠ›ï¼Œå±•ç¤ºäº†å…³é”®çš„äº¤äº’å’Œæ ¸å¿ƒçš„åŠ å¯†æµç¨‹ã€‚æœ€å…³é”®çš„å‡ æ­¥åœ¨äºå¦‚ä½•å»ºç«‹TCPé“¾æ¥ï¼Œå¦‚ä½•é€šè¿‡éå¯¹ç§°åŠ å¯†åå•†è·å–å¯¹ç§°åŠ å¯†çš„å¯†é’¥ï¼Œä»¥åŠæœ€åé€šè¿‡å¯¹ç§°åŠ å¯†è¿›è¡Œé€šä¿¡ã€‚\nHTTPSï¼Œå‡†ç¡®æ¥è¯´æ˜¯TLSï¼Œè®¾è®¡ä¸¥å¯†ï¼Œå…¶ä¸­æœ€å…³é”®çš„æ˜¯Record Layerå’Œå‡ ç§Protocolï¼Œå‰è€…æ˜¯æ•°æ®æ‰¿è½½ç®¡é“ï¼Œå„ç§å­Protocoléƒ½è·‘åœ¨å®ƒä¸Šé¢ ï¼Œå…¶ä¸­çš„Recordæ˜¯TLSæ•°æ®æ”¶å‘ä¼ è¾“çš„åŸºæœ¬å•ä½ï¼Œç±»ä¼¼TCPçš„segmentï¼ŒIPçš„Packetï¼Œè¿™ä¹Ÿæ˜¯ä¸‹é¢è¿™å¹…å›¾çš„å«ä¹‰ã€‚\nä¸Šå›¾ä¸­Protocolé‡Œæœ€é‡è¦çš„æ˜¯Handshakeåè®®ï¼Œé’ˆå¯¹Client Helloè¿›è¡ŒæŠ“åŒ…åï¼Œåœ¨Wiresharkä¸­ä½“ç°å¾—ä¼šæ›´æ¸…æ™°ã€‚\nHTTPS SNI æ‰©å±• äº’è”ç½‘æ—©æœŸï¼Œå•æœºæœåŠ¡å™¨æ²¡é‚£ä¹ˆå¼ºå¤§ï¼Œé…å¥—çš„HTTPSæ¯”å¦‚SSL v2ä¹Ÿæœ‰è®¾è®¡ç¼ºé™·ã€‚é‚£æ—¶æœ‰ä¸€ä¸ªå‡å®šï¼Œè®¤ä¸ºæ‹¥æœ‰ä¸€ä¸ªIPçš„å•å°æœåŠ¡å™¨åªä¼šæ‰˜ç®¡ä¸€ä¸ªåŸŸåæœåŠ¡ï¼Œæ‰€ä»¥DNSè§£æä»¥åï¼Œç›´è¿IPæ—¶å°±èƒ½éå¸¸ç¡®å®šè¦ä½¿ç”¨å…·ä½“æŸä¸ªåŸŸåçš„è¯ä¹¦ã€‚ä½†åé¢äº‘è®¡ç®—ã€è™šæ‹Ÿä¸»æœºå¤§çˆ†å‘ï¼Œä»¥åŠIPv4ä¸­IPçš„ç¨€ç¼ºæ€§ï¼Œä¸€å°æœåŠ¡å™¨æ‰˜ç®¡å¤šä¸ªåŸŸåçš„åœºæ™¯æ— å¯é¿å…ï¼Œè¿™æ—¶æœåŠ¡å™¨é¢ä¸´æ— æ³•çŸ¥é“å®¢æˆ·ç«¯åˆ°åº•æƒ³è¦è®¿é—®å“ªä¸ªåŸŸåçš„SSLè¯ä¹¦çš„é—®é¢˜ï¼Œä»è€Œå¯¼è‡´äº†HTTPS SNIçš„å‡ºç°ã€‚\nSNIï¼ˆServer Name Indicationï¼‰æ˜¯TLSåè®®çš„ä¸€ä¸ªæ‰©å±•ï¼Œå®ƒå…è®¸å®¢æˆ·ç«¯åœ¨æ¡æ‰‹è¿‡ç¨‹ä¸­å‘æœåŠ¡å™¨å‘é€ç›®æ ‡ä¸»æœºåä¿¡æ¯ã€‚è¿™æ ·ï¼ŒæœåŠ¡å™¨å°±å¯ä»¥åœ¨åŒä¸€ä¸ªIPåœ°å€ä¸Šæ‰˜ç®¡å¤šä¸ªåŸŸåçš„HTTPSæœåŠ¡ï¼Œå¹¶ä¸ºæ¯ä¸ªåŸŸåæä¾›æ­£ç¡®çš„è¯ä¹¦ã€‚\nè¿™ä¸ªé—®é¢˜çœ‹ä¼¼ç®€å•ï¼Œåœ¨HTTPSé€æ¸æ™®åŠï¼Œå„äº’è”ç½‘æœåŠ¡å•†èµ°å‘å…¨ç«™HTTPSåŒ–çš„æ—©æœŸï¼Œå¾ˆå¤šCDNå‚å•†ç”šè‡³éƒ½æ˜¯ä¸æ”¯æŒSNIçš„ã€‚å½“ç„¶åœ¨2024å¹´çš„ä»Šå¤©ï¼Œæ— è®ºæ˜¯Nginxç­‰è½¯ä»¶ç”Ÿæ€ï¼Œè¿˜æ˜¯å„å‚å•†ï¼Œéƒ½å·²ç»æ”¯æŒäº†çš„ã€‚\nSNIä¿¡æ¯æ˜¯é€šè¿‡TLSæ¡æ‰‹åè®®ä¼ è¾“çš„ï¼ŒæŠ“åŒ…ç¤ºæ„å¤§æ¦‚æ˜¯ä¸‹é¢è¿™æ ·å­ã€‚\nå…·ä½“åˆ°å®æ“ï¼Œå¯ä»¥ä½¿ç”¨openssl s_clientå­å‘½ä»¤ä¸­çš„-servernameé€‰é¡¹æ¥æŒ‡å®šSNIï¼š\n1 openssl s_client -connect example.com:443 -servername example.com å¦‚æœä½¿ç”¨OpenSSL Libraryï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨SSL_set_tlsext_host_nameå’ŒBIO_set_conn_hostnameç­‰å‡½æ•°æ¥åœ¨ä»£ç ä¸­è®¾ç½®ã€‚\nHTTPS è¯ä¹¦æœºåˆ¶ HTTPSé€šè¿‡å…¬é’¥ ä½“ç³»é‡Œçš„éå¯¹ç§°ã€å¯¹ç§°åŠæ‘˜è¦ç®—æ³•ï¼Œå®ç°äº†ä¸€ç³»åˆ—çš„åŠ è§£å¯†ã€ç­¾åã€éªŒç­¾ç­‰åŠŸèƒ½ï¼ŒåŸºæœ¬å®ç°äº†å®‰å…¨å››å¤§ç‰¹æ€§ï¼šæœºå¯†æ€§ã€å®Œæ•´æ€§ï¼Œèº«ä»½è®¤è¯å’Œä¸å¯å¦è®¤ã€‚å¦‚å…¸å‹çš„ä¸­é—´äººæ”»å‡»ï¼ˆMan-in-the-middle attackï¼ŒMITMï¼‰ï¼Œä¹Ÿéƒ½æœ‰äº†è§£å†³æ–¹æ¡ˆã€‚\nè¿™é‡Œä¸ºäº†è§£å†³å…¬é’¥çš„ä¿¡ä»»é—®é¢˜ï¼Œåˆå¼•å…¥äº†è¯ä¹¦å’Œä¿¡ä»»é“¾æœºåˆ¶ã€‚è¯ä¹¦ï¼ˆCertificateï¼‰æ˜¯ç”±ç¬¬ä¸‰æ–¹CAï¼ˆCertificate Authorityï¼Œè¯ä¹¦è®¤è¯æœºæ„ï¼‰é¢å‘çš„ï¼Œæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªæ–‡ä»¶ï¼Œé€šå¸¸æ˜¯.crtã€.cer æˆ– .pem ç­‰æ‰©å±•åå­˜å‚¨ã€‚è¿™ä¸ªæ–‡ä»¶æŒ‰ç…§ä¸€å®šçš„æ ‡å‡†ï¼ˆå¦‚X.509ï¼‰ç¼–ç ï¼ŒåŒ…å«äº†å…¬é’¥ã€è¯ä¹¦æŒæœ‰è€…ä¿¡æ¯ã€é¢å‘æœºæ„ä¿¡æ¯ã€æœ‰æ•ˆæœŸå’Œæ•°å­—ç­¾åç­‰ä¿¡æ¯ã€‚\næœ‰ä¸€äº›ä¸–ç•ŒçŸ¥åçš„ CA æœºæ„ï¼Œæ¯”å¦‚ DigiCertã€VeriSignã€Entrustã€Letâ€™s Encrypt ç­‰ï¼Œå®ƒä»¬ç­¾å‘çš„è¯ä¹¦åˆ† DVã€OVã€EV ä¸‰ç§ï¼Œå¯¹åº”ä¸åŒçš„å¯ä¿¡ç¨‹åº¦ã€‚ä½†CAè‡ªå·±ä¹Ÿæœ‰ä¿¡ä»»é—®é¢˜ï¼Œå°CAçš„ä¿¡ä»»é å¤§CAç­¾åè®¤è¯ï¼Œä½†é€å±‚å‘ä¸Šåˆ°äº†é“¾æ¡çš„æœ€åï¼Œå°±æ˜¯ Root CAï¼Œå°±åªèƒ½ç”¨â€œè‡ªç­¾åè¯ä¹¦â€ï¼ˆSelf-Signed Certificateï¼‰æˆ–è€…â€œæ ¹è¯ä¹¦â€ï¼ˆRoot Certificateï¼‰äº†ã€‚\nå¤§éƒ¨åˆ†æ“ä½œç³»ç»Ÿå’Œæµè§ˆå™¨éƒ½å†…ç½®äº†å„å¤§ CA çš„æ ¹è¯ä¹¦ï¼ŒHTTPSé€šä¿¡æ—¶ä¼šé¡ºç€è¯ä¹¦é“¾ï¼ˆCertificate Chainï¼‰é€å±‚éªŒè¯åˆ°æ ¹è¯ä¹¦ã€‚\nHTTPS è½¯ä»¶ç”Ÿæ€ HTTPSï¼Œæˆ–æ˜¯è¯´TLSï¼Œç”Ÿæ€è™½ç„¶ä¸°å¯Œï¼Œä½†OpenSSLä¸€å®¶ç‹¬å¤§ã€‚å®ƒå‡ ä¹æ”¯æŒæ‰€æœ‰å…¬å¼€çš„åŠ å¯†ç®—æ³•å’Œåè®®ï¼Œå·²ç»æˆä¸ºäº†äº‹å®ä¸Šçš„æ ‡å‡†ï¼Œè®¸å¤šåº”ç”¨è½¯ä»¶éƒ½ä¼šä½¿ç”¨å®ƒä½œä¸ºåº•å±‚åº“æ¥å®ç° TLS åŠŸèƒ½ï¼Œæ¯”å¦‚è‘—åçš„ Apacheã€Nginx ç­‰ã€‚\nOpenSSLæºäºSSLeayï¼Œå…¶åå¼€ææ•£å¶ï¼Œå½¢æˆä¼—å¤šåˆ†æ”¯ï¼Œå¦‚ Google çš„ BoringSSLã€OpenBSD çš„ LibreSSLã€‚OpenSSLçš„å†…å®¹ä¹Ÿæå…¶åºæ‚ï¼Œå¯ä»¥ä¼˜å…ˆä½¿ç”¨opensslå‘½ä»¤è¿›è¡Œå­¦ä¹ ï¼Œå…·ä½“å¯ä»¥å‚è€ƒChatGPTã€‚\nHTTPS åŠ é€Ÿæ–¹æ¡ˆ HTTPSå¾ˆç¾å¥½ï¼Œä½†ç¾å¥½çš„äº‹ç‰©éƒ½æœ‰æˆæœ¬ã€‚æ‰€ä»¥å…³äºHTTPSå…¨ç«™é“ºå¼€åçš„å„ç§ä¼˜åŒ–ï¼ŒåŸºæœ¬ä¸Šå¯ä»¥å†™æˆç‹¬ç«‹çš„ä¸€ç¯‡æ–‡ç« ï¼Œè¿™é‡Œå…ˆç®€å•æä¸‹ã€‚\né¦–å…ˆæ˜¯ä¼˜åŒ–RTTï¼Œè¿™ä¸ªåœ¨IOå¯†é›†å‹çš„äº’è”ç½‘åœºæ™¯ä¸‹å°¤ä¸ºé‡è¦ï¼Œä¸»è¦æ˜¯é€šè¿‡å‡çº§åè®®ï¼Œå¦‚å‡çº§HTTP/3ï¼Œå‡çº§TLS 1.3ï¼Œéƒ½å¯ä»¥é€šè¿‡ä¸åŒåŸç†æ¥ä¼˜åŒ–RTTã€‚å…¶æ¬¡æ˜¯ä¼˜åŒ–å•æ­¥éª¤æ€§èƒ½ï¼Œå¦‚å¢åŠ TLSåŠ é€Ÿå¡ï¼Œè®¾ç½®å•ç‹¬çš„TLSé›†ç¾¤æˆ–æ¨¡å—ç­‰ï¼Œè¿˜æœ‰ä¸€äº›TLS session resumptionç­‰åè¯ä¹Ÿå¯ä»¥å…³æ³¨ã€‚\næˆ‘ä»¥å‰å†™è¿‡ä¸€ç¯‡æ–‡ç« åˆ†äº«ä¸ºä»€ä¹ˆHTTPSä¸ºä»€ä¹ˆè¿™ä¹ˆæ…¢çš„æ–‡ç« ï¼Œæœ‰å…´è¶£å¯ä»¥é˜…è¯»ä¸€ä¸‹ã€‚\nWhy does HTTPS need 7 handshakes and 9 times delay?\nå‚è€ƒèµ„æ–™ What\u0026rsquo;s the difference between HTTP and HTTPS?\nhow-does-https-work\n","date":"2024-05-27T18:30:32+08:00","image":"https://images.yixiao9206.cn/blog-images/2024/05/9113c36ee94b362ffe79a997b75c8efe.png","permalink":"https://huizhou92.com/zh-cn/p/the-key-points-of-https/","title":"äº†è§£ HTTPSï¼šå…³é”®ç‚¹å’Œæµç¨‹è¯¦è§£"},{"content":"ä¸Šå‘¨ go1.23 å·²ç»è¿›å…¥å†»ç»“æœŸäº†ï¼Œåº”è¯¥ä¸ä¼šå†æ·»åŠ æ–°åŠŸèƒ½ï¼Œç›¸åº”çš„å·²ç»æ·»åŠ äº†çš„åŠŸèƒ½ ä¹Ÿä¸å¤ªå¯èƒ½ä¼šè¢«ç§»é™¤ã€‚\nè¿™æ­£å¥½å¯ä»¥è®©æˆ‘ä»¬æå‰å°é²œè¿™äº›å³å°†åˆ°æ¥çš„æ–°ç‰¹æ€§ã€‚\nhttps://groups.google.com/g/golang-dev/c/vXE304_MnKM\nThis article is first published in the medium MPP plan. If you are a medium user, please follow me in medium. Thank you very much.\nä»Šå¤©è¦è¯´çš„å°±æ˜¯1.23ä¸­å¯¹//go:linknameæŒ‡ä»¤çš„å˜æ›´ã€‚\nç›¸å…³è®¨è®ºçš„issue åœ¨è¿™é‡Œï¼š\nhttps://github.com/golang/go/issues/67401\nTL;DR //go:linknameæŒ‡ä»¤å®˜æ–¹å¹¶ä¸æ¨èä½¿ç”¨ï¼Œä¸”ä¸ä¿è¯ä»»ä½•å‘å‰æˆ–è€…å‘åå…¼å®¹æ€§ï¼Œå› æ­¤æ˜æ™ºçš„åšæ³•æ˜¯å°½é‡åˆ«ç”¨\nç‰¢è®°è¿™ä¸€ç‚¹ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥æ¥ç€å¾€ä¸‹çœ‹äº†ã€‚è‡³äºä¸ºå•¥å’Œâ€œæˆ‘â€ä¹Ÿå°±æ˜¯æœ¬æ–‡çš„ä½œè€…æœ‰å…³ï¼Œæˆ‘ä»¬å…ˆçœ‹å®Œæ–°ç‰ˆæœ¬å¸¦æ¥çš„æ–°å˜åŒ–å†è¯´ã€‚\nlinknameæŒ‡ä»¤æ˜¯åšä»€ä¹ˆçš„ ç®€å•çš„è¯´ï¼ŒlinknameæŒ‡ä»¤ç”¨äºå‘ç¼–è¯‘å™¨å’Œé“¾æ¥å™¨ä¼ é€’ä¿¡æ¯ã€‚å…·ä½“çš„å«ä¹‰æ ¹æ®ç”¨æ³•å¯ä»¥åˆ†ä¸ºä¸‰ç±»ã€‚\nç¬¬ä¸€ç±»å«åšâ€œpullâ€ï¼Œæ„æ€æ˜¯æ‹‰å–ï¼Œä½¿ç”¨æ–¹å¼å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 import _ \u0026#34;unsafe\u0026#34; // å¿…é¡»æœ‰è¿™è¡Œæ‰èƒ½ç”¨linkname import _ \u0026#34;fmt\u0026#34; // è¢«æ‹‰å–çš„åŒ…éœ€è¦æ˜¾å¼å¯¼å…¥ï¼ˆé™¤äº†runtimeåŒ…ï¼‰ //go:linkname my_func fmt.Println func my_func(...any) (n int, err error) è¿™ç§ç”¨æ³•çš„æŒ‡ä»¤æ ¼å¼æ˜¯//go:linkname \u0026lt;æŒ‡ä»¤ä¸‹æ–¹çš„åªæœ‰å£°æ˜çš„å‡½æ•°æˆ–åŒ…çº§åˆ«å˜é‡å\u0026gt; \u0026lt;æœ¬åŒ…æˆ–è€…å…¶ä»–åŒ…ä¸­çš„æœ‰å®Œæ•´å®šä¹‰çš„å‡½æ•°æˆ–å˜é‡\u0026gt;ã€‚\nè¿™ä¸ªæŒ‡ä»¤çš„ä½œç”¨å°±æ˜¯å‘Šè¯‰ç¼–è¯‘å™¨å’Œè¿æ¥å™¨ï¼Œmy_funcçš„å‡½æ•°ä½“ç›´æ¥ä½¿ç”¨fmt.Printlnçš„ï¼Œmy_funcç±»ä¼¼fmt.Printlnçš„åˆ«åï¼Œå’Œå®ƒå…±äº«åŒä¸€ä»½ä»£ç ï¼Œå°±åƒæŠŠæŒ‡ä»¤ç¬¬äºŒä¸ªå‚æ•°æŒ‡å®šçš„å‡½æ•°å’Œå˜é‡æ‹‰å–ä¸‹æ¥ç»™ç¬¬ä¸€ä¸ªå‚æ•°ä½¿ç”¨ä¸€æ ·ã€‚\næ­£å› å¦‚æ­¤ï¼ŒæŒ‡ä»¤ä¸‹æ–¹ç»™å‡ºçš„å£°æ˜å¿…é¡»å’Œè¢«æ‹‰å–çš„å‡½æ•°/å˜é‡å®Œå…¨ä¸€è‡´ï¼Œå¦åˆ™å¾ˆå®¹æ˜“å› ä¸ºç±»å‹ä¸åŒ¹é…å¯¼è‡´panicï¼ˆæ˜¯çš„æ²¡é”™ï¼Œé™¤éæ‹‰å–çš„å¯¹è±¡ä¸å­˜åœ¨ï¼Œå¦åˆ™éƒ½ä¸ä¼šå‡ºç°ç¼–è¯‘é”™è¯¯ï¼‰ã€‚\nè¿™ä¸ªæŒ‡ä»¤æœ€ææ€–çš„åœ°æ–¹åœ¨äºå®ƒèƒ½æ— è§†å‡½æ•°æˆ–è€…å˜é‡æ˜¯å¦æ˜¯exportçš„ï¼ŒåŒ…ç§æœ‰çš„ä¸œè¥¿ä¹Ÿèƒ½è¢«æ‹‰å–å‡ºæ¥ä½¿ç”¨ã€‚å› ä¸ºè¿™ä¸€ç‚¹è¿™ç§ç”¨æ³•åœ¨æ—©æœŸçš„ç¤¾åŒºä¸­å¾ˆå¸¸è§ï¼Œæ¯”å¦‚å¾ˆå¤šäººå–œæ¬¢è¿™ä¹ˆå¹²ï¼š//go:linkname myRand runtime.fastrandï¼Œå› ä¸ºruntimeæä¾›äº†ä¸€ä¸ªæ€§èƒ½è¿˜ä¸é”™çš„éšæœºæ•°å®ç°ï¼Œä½†æ²¡æœ‰å…¬å¼€å‡ºæ¥ï¼Œæ‰€ä»¥æœ‰äººä¼šç”¨linknameæŒ‡ä»¤æŠŠå®ƒå¯¼å‡ºä¸ºå·±æ‰€ç”¨ï¼Œå½“ç„¶éšç€1.21çš„å‘å¸ƒè¿™ç§ç”¨æ³•ä¸å†æœ‰ä»»ä½•æ„ä¹‰äº†ï¼Œè¯·æ°¸è¿œéƒ½ä¸è¦å»æ¨¡ä»¿ã€‚\nç¬¬äºŒç§ç”¨æ³•å«åšâ€œpushâ€ï¼Œå³æ¨é€ã€‚å½¢å¼ä¸Šæ˜¯ä¸‹é¢è¿™æ ·ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 import _ \u0026#34;unsafe\u0026#34; // å¿…é¡»æœ‰è¿™è¡Œæ‰èƒ½ç”¨linkname //go:linkname main.fastHandle func fastHandle(input io.Writer) error { ... } // package main func fastHandle(input io.Writer) error // åé¢mainåŒ…ä¸­å¯ä»¥ç›´æ¥ä½¿ç”¨fastHandle // è¿™ç§æƒ…å†µä¸‹éœ€è¦åœ¨mainåŒ…ä¸‹åˆ›å»ºä¸€ä¸ªç©ºçš„asmæ–‡ä»¶ï¼ˆé€šå¸¸ä»¥.sä½œä¸ºæ‰©å±•åï¼‰ï¼Œä»¥å‘Šè¯‰ç¼–è¯‘å™¨fastHandleçš„å®šä¹‰åœ¨åˆ«å¤„ åœ¨è¿™ç§ç”¨æ³•ä¸­ï¼Œæˆ‘ä»¬åªéœ€è¦æŠŠå‡½æ•°/å˜é‡åå½“ä½œç¬¬ä¸€ä¸ªå‚æ•°ä¼ ç»™æŒ‡ä»¤ï¼Œæ³¨æ„éœ€è¦ç»™å‡ºæƒ³ç”¨è¿™ä¸ªå‡½æ•°/å˜é‡çš„åŒ…çš„åå­—ï¼Œè¿™é‡Œæ˜¯mainã€‚åŒæ—¶æŒ‡ä»¤å£°æ˜çš„å˜é‡æˆ–å‡½æ•°å¿…é¡»è¦åœ¨åŒåŒ…å†…æœ‰å®Œæ•´çš„å®šä¹‰ï¼Œé€šå¸¸æ¨èç›´æ¥æŠŠå®Œæ•´å®šä¹‰å†™åœ¨linknameæŒ‡ä»¤ä¸‹æ–¹ã€‚\nè¿™ç§ç”¨æ³•æ˜¯å‘Šè¯‰ç¼–è¯‘å™¨å’Œé“¾æ¥å™¨è¿™ä¸ªå‡½æ•°/å˜é‡çš„åå­—å°±æ˜¯xxx.yyyï¼Œå¦‚æœé‡åˆ°è¿™ä¸ªå‡½æ•°å°±ä½¿ç”¨linknameæŒ‡å®šçš„å‡½æ•°/å˜é‡çš„ä»£ç ï¼Œè¿™ä¸ªæ¨¡å¼ä¸‹ç”šè‡³èƒ½åœ¨æœ¬åŒ…å®šä¹‰åˆ«çš„åŒ…é‡Œçš„å‡½æ•°ã€‚\nå½“ç„¶è¿™ç§ç”¨æ³•çš„è¯­ä¹‰ä½œç”¨æ›´æ˜æ˜¾ï¼Œå®ƒæ„å‘³ç€è¿™ä¸ªå‡½æ•°ä¼šåœ¨ä»»ä½•åœ°æ–¹è¢«ä½¿ç”¨ï¼Œä¿®æ”¹å®ƒéœ€è¦å°å¿ƒï¼Œå› ä¸ºæ”¹å˜äº†å‡½æ•°çš„è¡Œä¸ºå¯èƒ½ä¼šè®©å…¶ä»–è°ƒç”¨å®ƒçš„ä»£ç å‡ºbugï¼›ä¿®æ”¹äº†å‡½æ•°çš„ç­¾ååˆ™å¾ˆå¯èƒ½å¯¼è‡´è¿è¡Œæ—¶panicï¼›åˆ é™¤äº†è¿™ä¸ªå‡½æ•°åˆ™ä¼šå¯¼è‡´ä»£ç æ— æ³•ç¼–è¯‘ã€‚\næœ€åä¸€ç±»å«åšâ€œhandshakeâ€ï¼Œå³æ¡æ‰‹ã€‚ä»–æ˜¯æŠŠç¬¬ä¸€ç±»å’Œç¬¬äºŒç±»æ–¹æ³•ç»“åˆä½¿ç”¨ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 package mypkg import _ \u0026#34;unsafe\u0026#34; // å¿…é¡»æœ‰è¿™è¡Œæ‰èƒ½ç”¨linkname //go:linkname fastHandle func fastHandle(input io.Writer) error { ... } package main import _ \u0026#34;unsafe\u0026#34; // å¿…é¡»æœ‰è¿™è¡Œæ‰èƒ½ç”¨linkname //go:linkname fastHandle mypkg.fastHandle func fastHandle(input io.Writer) error â€œpullâ€çš„ä¸€æ–¹æ²¡ä»€ä¹ˆåŒºåˆ«ï¼Œä½†â€œpushâ€çš„ä¸€æ–¹ä¸ç”¨å†å†™åŒ…åï¼ŒåŒæ—¶ç”¨æ¥å‘Šè¯‰ç¼–è¯‘å™¨å‡½æ•°å®šä¹‰åœ¨åˆ«çš„åœ°æ–¹çš„ç©ºçš„asmæ–‡ä»¶ä¹Ÿä¸éœ€è¦äº†ã€‚è¿™ç§å°±åƒé€šè®¯åè®®ä¸­çš„â€œæ¡æ‰‹â€ï¼Œä¸€æ–¹å‘Šè¯‰ç¼–è¯‘å™¨è¿™è¾¹å…è®¸æŸä¸ªå‡½æ•°/å˜é‡è¢«linknameæ“ä½œï¼Œå¦ä¸€è¾¹åˆ™æ˜ç¡®åƒç¼–è¯‘å™¨è¦æ±‚å®ƒè¦ä½¿ç”¨æŸä¸ªåŒ…çš„æŸä¸ªå‡½æ•°/å˜é‡ã€‚\né€šå¸¸â€œpullâ€å’Œâ€œpushâ€åº”è¯¥æˆå¯¹å‡ºç°ï¼Œä¹Ÿå°±æ˜¯ä½ åªåº”è¯¥ä½¿ç”¨â€œhandshakeâ€æ¨¡å¼ã€‚\nç„¶è€Œä¸å¹¸çš„æ˜¯ï¼Œå½“å‰ï¼ˆ1.22ï¼‰çš„goè¯­è¨€æ”¯æŒâ€œpull-onlyâ€çš„ç”¨æ³•ï¼Œå³å¯ä»¥éšä¾¿æ‹‰å–ä»»ä½•åŒ…é‡Œçš„ä»»ä½•å‡½æ•°/å˜é‡ï¼Œä½†ä¸éœ€è¦è¢«æ‹‰å–çš„å¯¹è±¡ä½¿ç”¨â€œpushâ€æ ‡è®°è‡ªå·±ã€‚è€Œè¢«linknameæ‹‰å–çš„ä¸€æ–¹æ˜¯å®Œå…¨æ— æ„ŸçŸ¥çš„ã€‚\nè¿™å°±å¯¼è‡´äº†éå¸¸å¤§çš„éšæ‚£ã€‚\nlinknameå¸¦æ¥çš„éšæ‚£ æœ€å¤§çš„éšæ‚£åœ¨äºè¿™ä¸ªæŒ‡ä»¤å¯ä»¥åœ¨ä¸é€šçŸ¥è¢«æ‹‰å–çš„packagesçš„æƒ…å†µä¸‹éšæ„ä½¿ç”¨åŒ…ä¸­ç§æœ‰çš„å‡½æ•°/å˜é‡ã€‚\nä¸¾ä¸ªä¾‹å­ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 // pkg/mymath/mymath.go package mymath func uintPow(n uint) uint { return n*n } // main.go package main import ( \u0026#34;fmt\u0026#34; _ \u0026#34;linkname/pkg/mymath\u0026#34; _ \u0026#34;unsafe\u0026#34; ) //go:linkname pow linkname/pkg/mymath.uintPow func pow(n uint) uint func main() { fmt.Println(pow(6)) // 36 } æ­£å¸¸æ¥è¯´ï¼ŒuintPowæ˜¯ä¸å¯èƒ½è¢«å¤–éƒ¨ä½¿ç”¨çš„ï¼Œç„¶è€Œé€šè¿‡linknameæŒ‡ä»¤æˆ‘ä»¬ç›´æ¥æ— è§†äº†æ¥å£çš„å…¬å¼€å’Œç§æœ‰ï¼Œæœ‰ä»€ä¹ˆå°±èƒ½ç”¨ä»€ä¹ˆäº†ã€‚\nè¿™å½“ç„¶æ˜¯éå¸¸å±é™©çš„ï¼Œæ¯”å¦‚æˆ‘ä»¬æŠŠuintPowçš„å‚æ•°ç±»å‹æ”¹æˆstringï¼š\n1 2 3 4 5 package mymath func uintPow(n string) string { return n + n } è¿™æ—¶å€™ç¼–è¯‘è¿˜æ˜¯èƒ½æ­£å¸¸ç¼–è¯‘ï¼Œä½†è¿è¡Œçš„æ—¶å€™å°±ä¼šå‡ºç°å„ç§bugï¼Œåœ¨æˆ‘çš„æœºå™¨ä¸Šè¡¨ç°æ˜¯å¡æ­»å’Œæ®µé”™è¯¯ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿå› ä¸ºæˆ‘ä»¬æŠŠuintå¼ºè¡Œä¼ é€’äº†è¿‡å»ï¼Œä½†å‚æ•°éœ€è¦æ˜¯stringï¼Œç±»å‹å¯¹ä¸ä¸Šï¼Œè‡ªç„¶ä¼šå‡ºç°ç¨€å¥‡å¤æ€ªçš„bugã€‚è¿™ç§åœ¨åˆ«çš„è¯­è¨€é‡Œæ˜¯ä¸¥é‡çš„ç±»å‹ç›¸å…³çš„å†…å­˜é”™è¯¯ã€‚\nå¦å¤–å¦‚æœæˆ‘ä»¬ç›´æ¥åˆ äº†uintPowæˆ–è€…ç»™ä»–æ”¹ä¸ªåï¼Œé“¾æ¥å™¨ä¼šåœ¨ç¼–è¯‘æœŸé—´æŠ¥é”™ï¼š\n1 2 3 4 $ go build # linkname main.main: relocation target linkname/pkg/mymath.uintPow not defined è€Œä¸”æˆ‘ä»¬å¯¼å‡ºçš„æ˜¯ç§æœ‰å‡½æ•°ï¼Œé€šå¸¸æ²¡äººä¼šè®¤ä¸ºè‡ªå·±å†™çš„ç§æœ‰çº§åˆ«çš„å¸®åŠ©å‡½æ•°ä¼šè¢«å¯¼å‡ºåˆ°åŒ…å¤–å¹¶è¢«ä½¿ç”¨ï¼Œå› æ­¤åœ¨å¼€å‘æ—¶å¤§å®¶éƒ½æ˜¯ä¿è¯å…¬å¼€æ¥å£çš„ç¨³å®šæ€§ï¼Œç§æœ‰çš„å‡½æ•°/å˜é‡æ˜¯éšæ—¶å¯ä»¥è¢«å¤§è§„æ¨¡ä¿®æ”¹ç”šè‡³åˆ é™¤çš„ã€‚\nè€Œlinknameå°†è¿™ç§åœ¨åˆ«çš„è¯­è¨€é‡Œæœ€åŸºæœ¬çš„è§„çŸ©ç»™ç²‰ç¢äº†ã€‚\nè€Œä¸”äº‹å®ä¸Šä¹Ÿæ˜¯å¦‚æ­¤ï¼Œä»1.18å¼€å§‹å‡ ä¹æ¯ä¸ªç‰ˆæœ¬éƒ½æœ‰å› ä¸ºç¼–è¯‘å™¨æˆ–è€…æ ‡å‡†åº“å†…éƒ¨çš„ç§æœ‰å‡½æ•°è¢«ä¿®æ”¹/åˆ é™¤ä»è€Œå¯¼è‡´æŸäº›ç¬¬ä¸‰æ–¹åº“åœ¨æ–°ç‰ˆæœ¬æ— æ³•ä½¿ç”¨çš„é—®é¢˜ï¼Œå› ä¸ºè¿™äº›åº“åœ¨å†…éƒ¨æ‚„æ‚„ç”¨//go:linknameç”¨äº†ä¸€äº›æœªå…¬å¼€çš„åŠŸèƒ½ã€‚æœ€è¿‘ä¸€æ¬¡å‘ç”Ÿåœ¨å¹¿æ³›ä½¿ç”¨çš„çŸ¥åjsonåº“ä¸Šç±»ä¼¼çš„é—®é¢˜å¯ä»¥åœ¨è¿™é‡Œçœ‹åˆ°ã€‚\nlinknameçš„æ­£é¢ä½œç”¨ æ—¢ç„¶è¿™ä¸ªæŒ‡ä»¤å¦‚æ­¤å±é™©ï¼Œä¸ºä»€ä¹ˆè¿˜ä¸€ç›´å­˜åœ¨å‘¢ï¼Ÿç­”æ¡ˆæ˜¯æœ‰ä¸å¾—ä¸ç”¨çš„ç†ç”±ï¼Œå…¶ä¸­ä¸€ä¸ªå°±åœ¨å¯åŠ¨goç¨‹åºçš„æ—¶å€™ã€‚\næˆ‘ä»¬æ¥çœ‹ä¸‹goçš„runtimeé‡Œæ˜¯æ€ä¹ˆç”¨linknameçš„ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 // runtime/proc.go //go:linkname main_main main.main func main_main() // runtime.main // æ‰€æœ‰goç¨‹åºçš„å…¥å£ func main() { // åˆå§‹åŒ–runtime // è°ƒç”¨main.main fn := main_main // make an indirect call, as the linker doesn\u0026#39;t know the address of the main package when laying down the runtime fn() // mainé€€å‡ºååšæ¸…ç†å·¥ä½œ } å› ä¸ºç¨‹åºçš„å…¥å£åœ¨runtimeé‡Œï¼ˆè¦åˆå§‹åŒ–runtimeï¼Œæ¯”å¦‚gcç­‰ï¼‰ï¼Œæ‰€ä»¥å…¥å£å‡½æ•°å¿…é¡»åœ¨runtimeåŒ…é‡Œã€‚è€Œæˆ‘ä»¬åˆéœ€è¦è°ƒç”¨ç”¨æˆ·å®šä¹‰åœ¨mainåŒ…é‡Œçš„mainå‡½æ•°ï¼Œä½†mainåŒ…ä¸èƒ½è¢«importï¼Œå› æ­¤åªèƒ½é linknameæŒ‡ä»¤è®©é“¾æ¥å™¨ç»•è¿‡æ‰€æœ‰ç¼–è¯‘å™¨é™„åŠ çš„é™åˆ¶æ¥è°ƒç”¨mainå‡½æ•°ã€‚\nè¿™æ˜¯ç›®å‰åœ¨goè‡ªèº«çš„æºä»£ç é‡Œçœ‹åˆ°çš„å”¯ä¸€ä¸€å¤„ä¸å¾—ä¸ä½¿ç”¨â€œpull-onlyâ€æ¨¡å¼çš„åœ°æ–¹ã€‚\nå¦å¤–â€œhandshakeâ€æ¨¡å¼ä¹Ÿæœ‰å­˜åœ¨çš„å¿…è¦æ€§ï¼Œå› ä¸ºåƒruntimeå’Œreflectéœ€è¦å…±äº«å¾ˆå¤šå®ç°ä¸Šçš„ç»†èŠ‚ï¼Œå› æ­¤reflectä½œä¸ºpullçš„ä¸€æ–¹ï¼Œruntimeä½œä¸ºpushçš„ä¸€æ–¹ï¼Œå¯ä»¥æå¤§å‡å°‘ä»£ç ç»´æŠ¤çš„å¤æ‚åº¦ã€‚\né™¤äº†ä¸Šè¿°è¿™äº›æƒ…å†µï¼Œç»å¤§æ•°linknameçš„ä½¿ç”¨éƒ½å¯ä»¥ç®—ä½œ_abuse_ã€‚\ngolang1.23å¯¹linknameæŒ‡ä»¤çš„æ”¹åŠ¨ é‰´äºä¸Šè¿°æƒ…å†µï¼Œgolangæ ¸å¿ƒå›¢é˜Ÿå†³å®šé™åˆ¶linknameçš„ä½¿ç”¨ã€‚\nç¬¬ä¸€ä¸ªæ”¹åŠ¨æ˜¯æ ‡å‡†åº“é‡Œæ–°æ·»åŠ çš„åŒ…å…¨éƒ¨ç¦æ­¢ä½¿ç”¨linknameå¯¼å‡ºå…¶ä¸­çš„å†…å®¹ï¼Œç›®å‰æ˜¯é€šè¿‡é»‘åå•å®ç°çš„ï¼Œ1.23ä¸­æ–°æ·»åŠ çš„å‡ ä¸ªåŒ…ä»¥åŠå®ƒä»¬çš„internalä¾èµ–éƒ½åœ¨åå•ä¸Šï¼Œè¿™æ ·å¯ä»¥é˜²æ­¢å·²æœ‰çš„linknameé—®é¢˜ç»§ç»­æ‰©å¤§ã€‚è¿™å¯¹å·²æœ‰çš„ä»£ç ä¹Ÿæ˜¯å®Œå…¨æ— å®³çš„ã€‚\nç¬¬äºŒä¸ªå˜æ›´æ—¶æ·»åŠ äº†æ–°çš„ldflags: -checklinkname=1ã€‚1ä»£è¡¨å¼€å¯å¯¹linknameçš„é™åˆ¶ï¼Œ0ä»£è¡¨ç»´æŒ1.22çš„è¡Œä¸ºä¸å˜ã€‚ç›®å‰é»˜è®¤æ˜¯0ï¼Œä½†å®˜æ–¹å†³å®šåœ¨1.23å‘å¸ƒæ—¶é»˜è®¤å€¼ä¸º1å¼€å¯é™åˆ¶ã€‚ä¸ªäººå»ºè®®å°½é‡ä¸è¦å…³é—­è¿™ä¸ªé™åˆ¶ã€‚è¿™ä¸ªé™åˆ¶çœ¼ä¸‹åªé’ˆå¯¹æ ‡å‡†åº“ï¼Œä½†æŒ‰å®˜æ–¹çš„è¯´æ³•æ•ˆæœå¥½çš„è¯ä»¥åæ‰€æœ‰çš„ä»£ç ä¸ç®¡æ ‡å‡†åº“è¿˜æ˜¯ç¬¬ä¸‰æ–¹éƒ½ä¼šå¯ç”¨é™åˆ¶ã€‚\næœ€åä¹Ÿæ˜¯æœ€å¤§çš„å˜åŠ¨ï¼Œç¦æ­¢å¯¹æ ‡å‡†åº“çš„ â€œpull-onlyâ€ linknameæŒ‡ä»¤ï¼Œä½†å…è®¸â€œhandshakeâ€æ¨¡å¼ã€‚\nè™½ç„¶goä»æ¥ä¸ä¿è¯linknameçš„å‘åå…¼å®¹æ€§ï¼Œä½†è¿™æ ·è¿˜æ˜¯ä¼šå¤§é‡è¾ƒå¤§çš„ç ´åï¼Œå› æ­¤å®˜æ–¹å·²ç»å¯¹å¸¸è§çš„goç¬¬ä¸‰æ–¹åº“åšäº†æ‰«æï¼Œä¼šæŠŠä¸€äº›ç»å¸¸è¢«äººç”¨linknameæ‹‰å–çš„æ¥å£æ”¹æˆç¬¦åˆâ€œhandshakeâ€æ¨¡å¼çš„å½¢å¼ï¼Œè¿™ç§æ”¹åŠ¨åªç”¨åŠ ä¸€è¡ŒæŒ‡ä»¤å³å¯ã€‚è€Œä¸”è¯¥é™åˆ¶ç›®å‰åªé’ˆå¯¹æ ‡å‡†åº“ï¼Œå…¶ä»–ç¬¬ä¸‰æ–¹åº“æš‚æ—¶ä¸å—å½±å“ã€‚\nå› ä¸ºè¿™ä¸ªå˜æ›´ï¼Œä¸‹é¢çš„ä»£ç åœ¨1.23æ˜¯æ— æ³•ç¼–è¯‘é€šè¿‡çš„ï¼š\n1 2 3 4 5 6 7 8 package main import _ \u0026#34;unsafe\u0026#34; //go:linkname corostart runtime.corostart func corostart() func main() { corostart() } å› ä¸ºruntime.corostartå¹¶ä¸ç¬¦åˆhandshakeæ¨¡å¼ï¼Œæ‰€ä»¥å¯¹å®ƒçš„linknameè¢«ç¦æ­¢äº†ï¼š\n1 2 3 4 5 $ go version go version devel go1.23-13d36a9b46 Wed May 27 21:51:49 2024 +0000 windows/amd64 $ go build -ldflags=-checklinkname=1 # linkname link: main: invalid reference to runtime.corostart linknameæŒ‡ä»¤ä»Šåçš„å‘å±• å¤§è¶‹åŠ¿è‚¯å®šæ˜¯ä»¥ååªå…è®¸handshakeæ¨¡å¼ã€‚ä¸è¿‡ä½œä¸ºè¿‡æ¸¡ç›®å‰è¿˜æ˜¯å…è®¸pushæ¨¡å¼çš„ï¼Œå¹¶ä¸”å®˜æ–¹åº”è¯¥ä¼šåœ¨è¿›å…¥åŠŸèƒ½å†»ç»“åæŠŠä¹‹å‰è¯´çš„æ‰«æåˆ°çš„å¸¸ç”¨çš„å†…éƒ¨å‡½æ•°æ·»åŠ ä¸ŠlinknameæŒ‡ä»¤ã€‚\nè¿™é‡Œæ¯”è¾ƒé‡è¦çš„æ˜¯ä½œä¸ºå¼€å‘è€…çš„æˆ‘ä»¬åº”è¯¥æ€ä¹ˆåŠï¼š\n1.23å‘å¸ƒä¹‹åæˆ–è€…ç°åœ¨å°±å¼€å§‹åˆ©ç”¨-checklinkname=1æ’æŸ¥ä»£ç ï¼ŒåŠæ—¶æ¸…é™¤ä¸å¿…è¦çš„linknameæŒ‡ä»¤ã€‚ å¦‚æœlinknameæŒ‡ä»¤éç”¨ä¸å¯ï¼Œå»ºè®®é©¬ä¸Šæissueæˆ–è€…ç†Ÿæ‚‰goå¼€å‘æµç¨‹çš„ç«‹åˆ»æprè¡¥ä¸Šhandshakeæ¨¡å¼éœ€è¦çš„æŒ‡ä»¤ï¼Œä¸è¿‡æˆ‘ä¸æ€ä¹ˆæ¨èè¿™ç§åšæ³•ï¼Œå› ä¸ºå†…éƒ¨apiå°¤å…¶æ˜¯runtimeä»¥å¤–çš„åº“çš„æœ¬æ¥å°±ä¸è¯¥éšä¾¿è¢«å¯¼å‡ºä½¿ç”¨ï¼Œæ²¡æœ‰ä¸€ä¸ªå¼ºåŠ›çš„èƒ½è¯´æœæ‰€æœ‰äººçš„ç†ç”±ï¼Œè¿™äº›issueå’Œprå¤šåŠä¸ä¼šè¢«æ¥å—ã€‚ å‘å®˜æ–¹ææ¡ˆï¼Œå°è¯•æŠŠä½ è¦ç”¨çš„ç§æœ‰apiå˜æˆå…¬å¼€æ¥å£ï¼Œè¿™ä¸€æ­¥éš¾åº¦ä¹Ÿå¾ˆé«˜ï¼Œç§æœ‰apiä¹‹æ‰€ä»¥å½“åˆä¸å…¬å¼€ä¸€å®šæ˜¯æœ‰åŸå› çš„ï¼Œç°åœ¨å†æƒ³å…¬å¼€å¯èƒ½æ€§ä¹Ÿä¸é«˜ã€‚ ä½ çš„è¿½æ±‚æ¯”è¾ƒä½ï¼Œåªè¦ä»£ç èƒ½è·‘å°±è¡Œï¼Œé‚£å¯ä»¥åœ¨æ„å»ºè„šæœ¬é‡ŒåŠ ä¸Š-ldflags=-checklinkname=0å…³é—­é™åˆ¶ï¼Œè¿™æ ·ä¹Ÿè®¸èƒ½å²æœˆé™å¥½å‡ ä¸ªç‰ˆæœ¬ï¼Œç›´åˆ°æŸä¸€å¤©ç¨‹åºçªç„¶æ²¡æ³•ç¼–è¯‘æˆ–è€…è¿è¡Œäº†ä¸€åŠè¢«è«åå…¶å¦™çš„panicæ‰“æ–­ã€‚ 4æ˜¯ä¸‡ä¸å¾—å·²æ—¶çš„ä¿åº•æ–¹æ¡ˆï¼ŒæŒ‰ä¼˜å…ˆåº¦æˆ‘æ¨è1 \u0026gt; 3 \u0026gt; 2çš„é¡ºåºå»é€‚é…go1.23ã€‚2å’Œ3ä¸ä»…ä»…é€‚ç”¨äºgoæ ‡å‡†åº“ï¼Œå¸¸ç”¨çš„ç¬¬ä¸‰æ–¹åº“ä¹Ÿå¯ä»¥ã€‚é€šè¿‡è¿™äº›é€‚é…å·¥ä½œè¯´ä¸å®šä¹Ÿæœ‰æœºä¼šè®©ä½ æˆä¸ºgoæˆ–è€…çŸ¥åç¬¬ä¸‰æ–¹åº“çš„è´¡çŒ®è€…ã€‚\nä»ç°åœ¨å¼€å§‹å®Œå…¨æ˜¯æ¥å¾—åŠçš„ï¼Œæ¯•ç«Ÿç¦»1.23çš„ç¬¬ä¸€ä¸ªæµ‹è¯•ç‰ˆå‘å¸ƒè¿˜æœ‰ä¸€ä¸ªæœˆå·¦å³ï¼Œç¦»æ­£å¼ç‰ˆå‘å¸ƒè¿˜æœ‰ä¸¤ä¸ªæœˆã€‚è€Œä¸”æ–¹æ¡ˆ2çš„ä¿®æ”¹å¹¶ä¸ç®—ä½œæ–°åŠŸèƒ½ï¼Œä¸å—åŠŸèƒ½å†»ç»“çš„å½±å“ã€‚\nå½“ç„¶ï¼Œå¤§éƒ¨åˆ†å¼€å‘è€…åº”è¯¥ä¸ç”¨æ‹…å¿ƒï¼Œæ¯”è¾ƒlinknameçš„ä½¿ç”¨æ˜¯å°‘æ•°ï¼Œä¸€äº›ä¸»åŠ¨ä½¿ç”¨linknameçš„åº“æ¯”å¦‚quic-goä¹ŸçŸ¥é“å…¼å®¹æ€§é—®é¢˜ï¼Œå¾ˆå°å¿ƒåœ°åšäº†ä¸åŒç‰ˆæœ¬çš„é€‚é…ï¼ŒåŠ ä¸Šå®˜æ–¹æ‰¿è¯ºçš„å…œåº•è¿™ä¸€å¯¹linknameæŒ‡ä»¤çš„æ”¹åŠ¨çš„å½±å“åº”è¯¥æ¯”æƒ³è±¡ä¸­å°ï¼Œä½†æ˜¯æ˜¯æé«˜ä»£ç å®‰å…¨æ€§çš„ä¸€å¤§æ­¥ã€‚\næ€»ç»“ æœ€åæ€»ç»“å°±ä¸€å¥è¯ï¼šæ²¡äº‹åˆ«ç”¨//go:linkname å¯èƒ½ä¼šç•™ä¸‹ä¸å¯é¢„çŸ¥çš„éšæ‚£ã€‚\n","date":"2024-05-27T09:37:25+08:00","permalink":"https://huizhou92.com/zh-cn/p/%23-golang-1.23-changes-to-/golinkname-and-what-it-means-for-developers/","title":"Golang 1.23ï¼š`//go:linkname` çš„å˜æ›´åŠå…¶å¯¹å¼€å‘äººå‘˜çš„æ„ä¹‰"},{"content":"\nBacklink | |Photo by Anna Demianenko on Unsplash èƒŒæ™¯ gRPCæ˜¯googleå¼€æºçš„é«˜æ€§èƒ½è·¨è¯­è¨€çš„RPCæ–¹æ¡ˆã€‚gRPCçš„è®¾è®¡ç›®æ ‡æ˜¯åœ¨ä»»ä½•ç¯å¢ƒä¸‹è¿è¡Œï¼Œæ”¯æŒå¯æ’æ‹”çš„è´Ÿè½½å‡è¡¡ï¼Œè·Ÿè¸ªï¼Œè¿è¡ŒçŠ¶å†µæ£€æŸ¥å’Œèº«ä»½éªŒè¯ã€‚å®ƒä¸ä»…æ”¯æŒæ•°æ®ä¸­å¿ƒå†…éƒ¨å’Œè·¨æ•°æ®ä¸­å¿ƒçš„æœåŠ¡è°ƒç”¨ï¼Œå®ƒä¹Ÿé€‚ç”¨äºåˆ†å¸ƒå¼è®¡ç®—çš„æœ€åä¸€å…¬é‡Œï¼Œå°†è®¾å¤‡ï¼Œç§»åŠ¨åº”ç”¨ç¨‹åºå’Œæµè§ˆå™¨è¿æ¥åˆ°åç«¯æœåŠ¡ã€‚\nå…³äº GRPCè®¾è®¡çš„åŠ¨æœºå’ŒåŸåˆ™ æˆ‘ä»¬å¯ä»¥ä»è¿™ç¯‡æ–‡ç« é‡Œé¢æ‰¾åˆ°ç­”æ¡ˆï¼ŒgRPC Motivation and Design Principles\nThis article is first published in the medium MPP plan. If you are a medium user, please follow me in medium. Thank you very much.\nå®˜æ–¹çš„æ–‡ç« ä»¤äººå°è±¡æ·±åˆ»çš„ç‚¹ï¼š\nå†…éƒ¨æœ‰Stubbyçš„æ¡†æ¶ï¼Œä½†æ˜¯å®ƒä¸æ˜¯åŸºäºä»»ä½•ä¸€ä¸ªæ ‡å‡†çš„ æ”¯æŒä»»æ„ç¯å¢ƒä½¿ç”¨ï¼Œæ”¯æŒç‰©è”ç½‘ã€æ‰‹æœºã€æµè§ˆå™¨ æ”¯æŒstreamå’Œæµæ§ å®é™…ä¸Šï¼šæ€§èƒ½ä¸æ˜¯gRPC è®¾è®¡çš„ç¬¬ä¸€ç›®æ ‡ã€‚é‚£ä¹ˆä¸ºä»€ä¹ˆé€‰æ‹©HTTP/2?\nHTTP/2æ˜¯ä»€ä¹ˆ åœ¨æ­£å¼è®¨è®ºgRPCä¸ºä»€ä¹ˆé€‰æ‹©HTTP/2ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥ç®€å•äº†è§£ä¸‹HTTP/2ã€‚\nHTTP/2å¯ä»¥ç®€å•ç”¨ä¸€ä¸ªå›¾ç‰‡æ¥ä»‹ç»ï¼š\næ¥è‡ªï¼šhttps://hpbn.co/\nHTTP/1é‡Œçš„headerå¯¹åº”HTTP/2é‡Œçš„ HEADERS frame HTTP/1é‡Œçš„payloadå¯¹åº”HTTP/2é‡Œçš„ DATA frame\nåœ¨Chromeæµè§ˆå™¨é‡Œï¼Œæ‰“å¼€chrome://net-internals/#http2ï¼Œå¯ä»¥çœ‹åˆ°http2é“¾æ¥çš„ä¿¡æ¯ã€‚\nç›®å‰å¾ˆå¤šç½‘ç«™éƒ½å·²ç»è·‘åœ¨HTTP/2ä¸Šäº†ã€‚\ngRPC Over HTTP/2 å‡†ç¡®æ¥è¯´gRPCè®¾è®¡ä¸Šæ˜¯åˆ†å±‚çš„ï¼Œåº•å±‚æ”¯æŒä¸åŒçš„åè®®ï¼Œç›®å‰gRPCæ”¯æŒï¼š\ngRPC over HTTP2 gRPC Web ä½†æ˜¯å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œè®¨è®ºéƒ½æ˜¯åŸºäºgRPC over HTTP2ã€‚\nä¸‹é¢ä»ä¸€ä¸ªçœŸå®çš„gRPC SayHelloè¯·æ±‚ï¼ŒæŸ¥çœ‹å®ƒåœ¨HTTP/2ä¸Šæ˜¯æ€æ ·å®ç°çš„ã€‚ç”¨WiresharkæŠ“åŒ…ï¼š\nå¯ä»¥çœ‹åˆ°ä¸‹é¢è¿™äº›Headerï¼š\n1 2 3 4 5 6 Header: :authority: localhost:50051 Header: :path: /helloworld.Greeter/SayHello Header: :method: POST Header: :scheme: http Header: content-type: application/grpc Header: user-agent: grpc-java-netty/1.11.0 ç„¶åè¯·æ±‚çš„å‚æ•°åœ¨DATA frameé‡Œï¼š\nGRPC Message: /helloworld.Greeter/SayHello, Request\nç®€è€Œè¨€ä¹‹ï¼ŒgGRPCæŠŠå…ƒæ•°æ®æ”¾åˆ°HTTP/2 Headersé‡Œï¼Œè¯·æ±‚å‚æ•°åºåˆ—åŒ–ä¹‹åæ”¾åˆ° DATA frameé‡Œã€‚\nåŸºäºHTTP/2 åè®®çš„ä¼˜ç‚¹ HTTP/2 æ˜¯ä¸€ä¸ªå…¬å¼€çš„æ ‡å‡† Googleæœ¬èº«æŠŠè¿™ä¸ªäº‹æƒ…æƒ³æ¸…æ¥šäº†ï¼Œå®ƒå¹¶æ²¡æœ‰æŠŠå†…éƒ¨çš„Stubbyå¼€æºï¼Œè€Œæ˜¯é€‰æ‹©é‡æ–°åšã€‚ç°åœ¨æŠ€æœ¯è¶Šæ¥è¶Šå¼€æ”¾ï¼Œç§æœ‰åè®®çš„ç©ºé—´è¶Šæ¥è¶Šå°ã€‚\nHTTP/2 æ˜¯ä¸€ä¸ªç»è¿‡å®è·µæ£€éªŒçš„æ ‡å‡† HTTP/2æ˜¯å…ˆæœ‰å®è·µå†æœ‰æ ‡å‡†ï¼Œè¿™ä¸ªå¾ˆé‡è¦ã€‚å¾ˆå¤šä¸æˆåŠŸçš„æ ‡å‡†éƒ½æ˜¯å…ˆæœ‰ä¸€å¤§å †å‚å•†è®¨è®ºå‡ºæ ‡å‡†åæœ‰å®ç°ï¼Œå¯¼è‡´æ··ä¹±è€Œä¸å¯ç”¨ï¼Œæ¯”å¦‚CORBAã€‚HTTP/2çš„å‰èº«æ˜¯Googleçš„SPDYï¼Œæ²¡æœ‰Googleçš„å®è·µå’Œæ¨åŠ¨ï¼Œå¯èƒ½éƒ½ä¸ä¼šæœ‰HTTP/2ã€‚\nHTTP/2 å¤©ç„¶æ”¯æŒç‰©è”ç½‘ã€æ‰‹æœºã€æµè§ˆå™¨ å®é™…ä¸Šå…ˆç”¨ä¸ŠHTTP/2çš„ä¹Ÿæ˜¯æ‰‹æœºå’Œæ‰‹æœºæµè§ˆå™¨ã€‚ç§»åŠ¨äº’è”ç½‘æ¨åŠ¨äº†HTTP/2çš„å‘å±•å’Œæ™®åŠã€‚\nåŸºäºHTTP/2 å¤šè¯­è¨€çš„å®ç°å®¹æ˜“ åªè®¨è®ºåè®®æœ¬èº«çš„å®ç°ï¼Œä¸è€ƒè™‘åºåˆ—åŒ–ã€‚\næ¯ä¸ªæµè¡Œçš„ç¼–ç¨‹è¯­è¨€éƒ½ä¼šæœ‰æˆç†Ÿçš„HTTP/2 Client HTTP/2 Clientæ˜¯ç»è¿‡å……åˆ†æµ‹è¯•ï¼Œå¯é çš„ ç”¨Clientå‘é€HTTP/2è¯·æ±‚çš„éš¾åº¦è¿œä½äºç”¨socketå‘é€æ•°æ®åŒ…/è§£ææ•°æ®åŒ… HTTP/2æ”¯æŒStreamå’Œæµæ§ åœ¨ä¸šç•Œï¼Œæœ‰å¾ˆå¤šæ”¯æŒstreamçš„æ–¹æ¡ˆï¼Œæ¯”å¦‚åŸºäºwebsocketçš„ï¼Œæˆ–è€…rsocketã€‚ä½†æ˜¯è¿™äº›æ–¹æ¡ˆéƒ½ä¸æ˜¯é€šç”¨çš„ã€‚\nHTTP/2é‡Œçš„Streamè¿˜å¯ä»¥è®¾ç½®ä¼˜å…ˆçº§ï¼Œå°½ç®¡åœ¨rpcé‡Œå¯èƒ½ç”¨çš„æ¯”è¾ƒå°‘ï¼Œä½†æ˜¯ä¸€äº›å¤æ‚çš„åœºæ™¯å¯èƒ½ä¼šç”¨åˆ°ã€‚\nåŸºäºHTTP/2 åœ¨Gateway/Proxyå¾ˆå®¹æ˜“æ”¯æŒ nginxå¯¹gRPCçš„æ”¯æŒ envoyå¯¹gRPCçš„æ”¯æŒ HTTP/2 å®‰å…¨æ€§æœ‰ä¿è¯ HTTP/2 å¤©ç„¶æ”¯æŒSSLï¼Œå½“ç„¶gRPCå¯ä»¥è·‘åœ¨clear textåè®®ï¼ˆå³ä¸åŠ å¯†ï¼‰ä¸Šã€‚ å¾ˆå¤šç§æœ‰åè®®çš„rpcå¯èƒ½è‡ªå·±åŒ…è£…äº†ä¸€å±‚TLSæ”¯æŒï¼Œä½¿ç”¨èµ·æ¥ä¹Ÿéå¸¸å¤æ‚ã€‚å¼€å‘è€…æ˜¯å¦æœ‰è¶³å¤Ÿçš„å®‰å…¨çŸ¥è¯†ï¼Ÿä½¿ç”¨è€…æ˜¯å¦é…ç½®å¯¹äº†ï¼Ÿè¿ç»´è€…æ˜¯å¦èƒ½æ­£ç¡®ç†è§£ï¼Ÿ HTTP/2 åœ¨å…¬æœ‰ç½‘ç»œä¸Šçš„ä¼ è¾“ä¸Šæœ‰ä¿è¯ã€‚æ¯”å¦‚è¿™ä¸ªCRIMEæ”»å‡»ï¼Œç§æœ‰åè®®å¾ˆéš¾ä¿è¯æ²¡æœ‰è¿™æ ·å­çš„æ¼æ´ã€‚ HTTP/2 é‰´æƒæˆç†Ÿ ä»HTTP/1å‘å±•èµ·æ¥çš„é‰´æƒç³»ç»Ÿå·²ç»å¾ˆæˆç†Ÿäº†ï¼Œå¯ä»¥æ— ç¼ç”¨åœ¨HTTP/2ä¸Š å¯ä»¥ä»å‰ç«¯åˆ°åç«¯å®Œå…¨æ‰“é€šçš„é‰´æƒï¼Œä¸éœ€è¦åšä»»ä½•è½¬æ¢é€‚é…\næ¯”å¦‚ä¼ ç»Ÿçš„rpc dubboï¼Œéœ€è¦å†™ä¸€ä¸ªdubbo filterï¼Œè¿˜è¦è€ƒè™‘æŠŠé‰´æƒç›¸å…³çš„ä¿¡æ¯é€šè¿‡thread localä¼ é€’è¿›å»ã€‚rpcåè®®æœ¬èº«ä¹Ÿéœ€è¦æ”¯æŒã€‚æ€»ä¹‹ï¼Œéå¸¸å¤æ‚ã€‚å®é™…ä¸Šç»å¤§éƒ¨åˆ†å…¬å¸é‡Œçš„rpcéƒ½æ˜¯æ²¡æœ‰é‰´æƒçš„ï¼Œå¯ä»¥éšä¾¿è°ƒã€‚ åŸºäºHTTP/2 çš„ç¼ºç‚¹ rpcçš„å…ƒæ•°æ®çš„ä¼ è¾“ä¸å¤Ÿé«˜æ•ˆ å°½ç®¡HPACå¯ä»¥å‹ç¼©HTTP Headerï¼Œä½†æ˜¯å¯¹äºrpcæ¥è¯´ï¼Œç¡®å®šä¸€ä¸ªå‡½æ•°è°ƒç”¨ï¼Œå¯ä»¥ç®€åŒ–ä¸ºä¸€ä¸ªintï¼Œåªè¦ä¸¤ç«¯å»åå•†è¿‡ä¸€æ¬¡ï¼Œåé¢ç›´æ¥æŸ¥è¡¨å°±å¯ä»¥äº†ï¼Œä¸éœ€è¦åƒHPACé‚£æ ·ç¼–ç è§£ç ã€‚\nå¯ä»¥è€ƒè™‘ä¸“é—¨å¯¹gRPCåšä¸€ä¸ªä¼˜åŒ–è¿‡çš„HTTP/2è§£æå™¨ï¼Œå‡å°‘ä¸€äº›é€šç”¨çš„å¤„ç†ï¼Œæ„Ÿè§‰å¯ä»¥æå‡æ€§èƒ½ã€‚\nHTTP/2 é‡Œä¸€æ¬¡gRPCè°ƒç”¨éœ€è¦è§£ç ä¸¤æ¬¡ ä¸€æ¬¡æ˜¯HEADERS frameï¼Œä¸€æ¬¡æ˜¯DATA frameã€‚\nHTTP/2 æ ‡å‡†æœ¬èº«æ˜¯åªæœ‰ä¸€ä¸ªTCPè¿æ¥ï¼Œä½†æ˜¯å®é™…åœ¨gRPCé‡Œæ˜¯ä¼šæœ‰å¤šä¸ªTCPè¿æ¥ï¼Œä½¿ç”¨æ—¶éœ€è¦æ³¨æ„ã€‚\ngRPCé€‰æ‹©åŸºäºHTTP/2ï¼Œé‚£ä¹ˆå®ƒçš„æ€§èƒ½è‚¯å®šä¸ä¼šæ˜¯æœ€é¡¶å°–çš„ã€‚ä½†æ˜¯å¯¹äºrpcæ¥è¯´ä¸­åº¸çš„qpså¯ä»¥æ¥å—ï¼Œé€šç”¨å’Œå…¼å®¹æ€§æ‰æ˜¯æœ€é‡è¦çš„äº‹æƒ…ã€‚æˆ‘ä»¬å¯ä»¥å‚è€ƒä¸€ä¸‹å®˜æ–¹çš„benchmarkï¼šhttps://grpc.io/docs/guides/benchmarking.html\nhttps://github.com/hank-whu/rpc-benchmark\nå¦‚æœæ‚¨çš„åœºæ™¯æ˜¯æ Googleåˆ¶å®šæ ‡å‡†çš„èƒ½åŠ› è¿‘10å¹´æ¥ï¼ŒGoogleåˆ¶å®šæ ‡å‡†çš„èƒ½åŠ›è¶Šæ¥è¶Šå¼ºã€‚ä¸‹é¢åˆ—ä¸¾ä¸€äº›æ ‡å‡†ï¼š\nHTTP/2 WebPå›¾ç‰‡æ ¼å¼ WebRTC ç½‘é¡µå³æ—¶é€šä¿¡ VP9/AV1 è§†é¢‘ç¼–ç æ ‡å‡† Service Worker/PWA QUIC/ HTTP/3\nå½“ç„¶googleä¹Ÿå¹¶ä¸éƒ½ä¼šæˆåŠŸï¼Œå¾ˆå¤šäº‹æƒ…å®ƒæƒ³æ¨ä¹Ÿå¤±è´¥äº†ï¼Œæ¯”å¦‚Chromeçš„Native Clientã€‚ gRPCç›®å‰æ˜¯k8sç”Ÿæ€é‡Œçš„äº‹å®æ ‡å‡†ã€‚ gRPCæ˜¯å¦ä¼šæˆä¸ºæ›´å¤šåœ°æ–¹ï¼Œæ›´å¤§é¢†åŸŸçš„RPCæ ‡å‡†ï¼Ÿ\nä¸ºä»€ä¹ˆä¼šå‡ºç°gRPC å‡†ç¡®æ¥è¯´ä¸ºä»€ä¹ˆä¼šå‡ºç°åŸºäºHTTP/2çš„RPCï¼Ÿ\nä¸ªäººè®¤ä¸ºä¸€ä¸ªé‡è¦çš„åŸå› æ˜¯ï¼Œåœ¨Cloud Nativeçš„æ½®æµä¸‹ï¼Œå¼€æ”¾äº’é€šçš„éœ€æ±‚å¿…ç„¶ä¼šäº§ç”ŸåŸºäºHTTP/2çš„RPCã€‚å³ä½¿æ²¡æœ‰gRPCï¼Œä¹Ÿä¼šæœ‰å…¶å®ƒåŸºäºHTTP/2çš„RPCã€‚\ngRPCåœ¨Googleçš„å†…éƒ¨ä¹Ÿæ˜¯å…ˆç”¨åœ¨Google Cloud Platformå’Œå…¬å¼€çš„APIä¸Šï¼šhttps://opensource.google.com/projects/grpc\næ€»ç»“ å°½ç®¡gRPCå®ƒå¯èƒ½æ›¿æ¢ä¸äº†å†…éƒ¨çš„RPCå®ç°ï¼Œä½†æ˜¯åœ¨å¼€æ”¾äº’é€šçš„æ—¶ä»£ï¼Œä¸æ­¢åœ¨k8sä¸Šï¼ŒgRPCä¼šæœ‰è¶Šæ¥è¶Šå¤šçš„èˆå°å¯ä»¥æ–½å±•ã€‚\nå‚è€ƒèµ„æ–™ https://grpc.io/ https://hpbn.co/ https://grpc.io/blog/loadbalancing https://http2.github.io/faq https://github.com/grpc/grpc ","date":"2024-05-23T10:25:02+08:00","permalink":"https://huizhou92.com/zh-cn/p/why-did-google-choose-to-implement-grpc-using-http2/","title":"ä¸ºä»€ä¹ˆ Google é€‰æ‹©ä½¿ç”¨HTTP 2 å®ç° gRPC"},{"content":"æ‘˜è¦ wireshark æ˜¯ä¸€ä¸ª æµè¡Œçš„æŠ“å–ç½‘ç»œæŠ¥æ–‡çš„å·¥å…·,ä»–ä¸ä»…è‡ªå·±å¯ä»¥æŠ“åŒ…ï¼Œä¹Ÿå¯ä»¥è§£ætcpdumpæŠ“åŒ…çš„æ–‡ä»¶ã€‚\ngRPC æ˜¯Googleå¼€å‘çš„ä¸€ä¸ªé«˜æ€§èƒ½RPCæ¡†æ¶ï¼ŒåŸºäºHTTP/2åè®®+protobufåºåˆ—åŒ–åè®®.\næœ¬æ–‡ä¸»è¦ä»‹ç»å¦‚ä½•ä½¿ç”¨wiresharkæŠ“å–gRPCçš„æŠ¥æ–‡ï¼Œå¹¶è§£ææŠ¥æ–‡å†…å®¹ã€‚\nThis article is first published in the medium MPP plan. If you are a medium user, please follow me in medium. Thank you very much.\nWireshark version: 4.2.2\né…ç½® å› ä¸ºgRPC æ˜¯åŸºäºprotobufåºåˆ—åŒ–åè®®ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å…ˆæ·»åŠ protobufçš„æ–‡ä»¶åœ°å€ã€‚\nç‚¹å‡» Wireshark -\u0026gt; Preferences\u0026hellip; -\u0026gt; Protocols -\u0026gt; Protobuf -\u0026gt; Protobuf search paths -\u0026gt; Edit\u0026hellip;\nç‚¹å‡»+ æ·»åŠ æ‚¨è¦æŠ“åŒ…çš„protobuf æ–‡ä»¶è·¯å¾„ï¼Œä¸è¦å¿˜è®°å‹¾é€‰å³è¾¹çš„ Load all files\nå…·ä½“æ“ä½œ é¦–å…ˆæˆ‘ä»¬å†™ä¸€ä¸ªæœ€ç®€å•çš„gRPCæœåŠ¡ï¼Œ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 syntax = \u0026#34;proto3\u0026#34;; option go_package = \u0026#34;example.com/hxzhouh/go-example/grpc/helloworld/api\u0026#34;; package api; // The greeting service definition. service Greeter { // Sends a greeting rpc SayHello (HelloRequest) returns (HelloReply) {} } // The request message containing the user\u0026#39;s name. message HelloRequest { string name = 1; } // The response message containing the greetings message HelloReply { string message = 1; } å®ƒä»…ä»…å°±ä¸€ä¸ªå‡½æ•° Greeter ,è¡¥å……å®ŒæœåŠ¡ç«¯ä»£ç ï¼ŒæŠŠå®ƒè¿è¡Œèµ·æ¥ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 type server struct { api.UnimplementedGreeterServer } func (s *server) SayHello(ctx context.Context, in *api.HelloRequest) (*api.HelloReply, error) { log.Printf(\u0026#34;Received: %v\u0026#34;, in.GetName()) return \u0026amp;api.HelloReply{Message: \u0026#34;Hello \u0026#34; + in.GetName()}, nil } func main() { lis, err := net.Listen(\u0026#34;tcp\u0026#34;, \u0026#34;:50051\u0026#34;) if err != nil { log.Fatalf(\u0026#34;failed to listen: %v\u0026#34;, err) } s := grpc.NewServer() api.RegisterGreeterServer(s, \u0026amp;server{}) if err := s.Serve(lis); err != nil { log.Fatalf(\u0026#34;failed to serve: %v\u0026#34;, err) } } ç„¶åæˆ‘ä»¬æ‰“å¼€ wireshark ï¼Œé€‰æ‹©æœ¬åœ°ç½‘å¡ï¼Œç›‘å¬ tcp.port == 50051\nå¦‚æœæ‚¨ä»¥å‰æ²¡æ¥è§¦è¿‡ wiresharkï¼Œæˆ‘å»ºè®®æ‚¨å…ˆçœ‹çœ‹è¿™ç¯‡æ–‡ç« ï¼šhttps://www.lifewire.com/wireshark-tutorial-4143298\nä¸€å…ƒå‡½æ•° ç°åœ¨æˆ‘ä»¬æœ‰ä¸€ä¸ªgRPC æœåŠ¡è¿è¡Œå†æœ¬åœ°çš„50051 ç«¯å£ï¼Œ æˆ‘ä»¬å¯ä»¥ä½¿ç”¨BloomRPC æˆ–è€…å…¶ä»–æ‚¨ä»»ä½•å–œæ¬¢çš„å·¥å…·å¯¹æœåŠ¡ç«¯å‘èµ·ä¸€ä¸ªRPCè¯·æ±‚,æˆ–è€…ç›´æ¥åƒæˆ‘ä¸€æ ·ä½¿ç”¨ä¸‹é¢çš„ä»£ç \n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 func Test_server_SayHello(t *testing.T) { // Set up a connection to the server. conn, err := grpc.Dial(\u0026#34;localhost:50051\u0026#34;, grpc.WithInsecure(), grpc.WithBlock()) if err != nil { log.Fatalf(\u0026#34;did not connect: %v\u0026#34;, err) } defer conn.Close() c := api.NewGreeterClient(conn) // Contact the server and print out its response. name := \u0026#34;Hello\u0026#34; ctx, cancel := context.WithTimeout(context.Background(), time.Second) defer cancel() r, err := c.SayHello(ctx, \u0026amp;api.HelloRequest{Name: name}) if err != nil { log.Fatalf(\u0026#34;could not greet: %v\u0026#34;, err) } log.Printf(\u0026#34;Greeting: %s\u0026#34;, r.GetMessage()) } è¿™ä¸ªæ—¶å€™ï¼Œwireshark åº”è¯¥å°±èƒ½æŠ“åˆ°æµé‡åŒ…äº†ã€‚\nå‰é¢æˆ‘ä»¬è¯´è¿‡ï¼ŒgRPC = http2+protobuf, å¹¶ä¸”æˆ‘ä»¬å‰é¢å·²ç»åŠ è½½äº†protobuf æ–‡ä»¶ï¼Œç†è®ºä¸Šæˆ‘ä»¬ç°åœ¨å·²ç»èƒ½è§£ææŠ¥æ–‡äº†ã€‚\nä½¿ç”¨wiresharkå¿«æ·é”® shift+command+U æˆ–è€… ç”¨é¼ æ ‡ç‚¹å‡» Analyze -\u0026gt; Decode As... ç„¶åè®¾ç½®ä¸€ä¸‹å°†æŠ¥æ–‡è§£ææˆHTTP2 æ ¼å¼ã€‚\nè¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å°±èƒ½å¾ˆæ¸…æ™°çš„çœ‹åˆ°è¿™ä¸ªè¯·æ±‚äº†\nmetadata æˆ‘ä»¬çŸ¥é“ gRPC çš„metadata æ˜¯é€šè¿‡ http2 çš„header æ¥ä¼ é€’çš„ã€‚ ç°åœ¨æˆ‘ä»¬é€šè¿‡æŠ“åŒ…æ¥éªŒè¯ä¸€ä¸‹ã€‚\nç¨å¾®æ”¹é€ ä¸€ä¸‹å®¢æˆ·ç«¯ä»£ç \n1 2 3 4 5 6 7 8 9 10 11 12 func Test_server_SayHello(t *testing.T) { // Set up a connection to the server. ..... // add md md := map[string][]string{\u0026#34;timestamp\u0026#34;: {time.Now().Format(time.Stamp)}} md[\u0026#34;testmd\u0026#34;] = []string{\u0026#34;testmd\u0026#34;} ctx := metadata.NewOutgoingContext(context.Background(), md) // Contact the server and print out its response. name := \u0026#34;Hello\u0026#34; ctx, cancel := context.WithTimeout(ctx, time.Second) .... } ç„¶åé‡æ–°æŠ“åŒ…ã€‚ æˆ‘ä»¬å°±èƒ½çœ‹åˆ° md ç¡®å®æ”¾åœ¨ header é‡Œé¢ã€‚\nå¹¶ä¸”æˆ‘ä»¬è¿˜åœ¨header çœ‹åˆ°äº†grpc-timeout å¯è§è¯·æ±‚è¶…æ—¶æ“ä½œä¹Ÿæ˜¯æˆ¿å­å•Šheader é‡Œé¢çš„ã€‚é‡Œé¢æ¶‰åŠçš„å…·ä½“ç»†èŠ‚ï¼Œæˆ‘å¯èƒ½ä¼šå‡ºä¸€ç¯‡ä¸“é—¨çš„æ–‡ç« æ¥è¯´æ˜ï¼Œä»Šå¤©æˆ‘ä»¬åªå…³æ³¨æŠ“åŒ…ã€‚\nTLS ä¸Šé¢ä½¿ç”¨çš„ä¾‹å­éƒ½æ˜¯æ˜æ–‡ ä¼ è¾“çš„ æˆ‘ä»¬å†Dial çš„æ—¶å€™ä½¿ç”¨äº† grpc.WithInsecure() ,ä½†æ˜¯åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä½¿ç”¨TLS å¯¹è¿›è¡ŒåŠ å¯†ä¼ è¾“ã€‚å…·ä½“çš„ç»†èŠ‚å¯ä»¥å‚è€ƒæˆ‘ä»¥å‰å†™çš„æ–‡ç« ã€‚\nhttps://medium.com/gitconnected/secure-communication-with-grpc-from-ssl-tls-certification-to-san-certification-d9464c3d706f\næˆ‘ä»¬æ”¹é€ ä¸€ä¸‹ æœåŠ¡ç«¯ä»£ç \nhttps://gist.github.com/hxzhouh/e08546cf0457d28a614d59ec28870b11 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 func main() { certificate, err := tls.LoadX509KeyPair(\u0026#34;./keys/server.crt\u0026#34;, \u0026#34;./keys/server.key\u0026#34;) if err != nil { log.Fatalf(\u0026#34;Failed to load key pair: %v\u0026#34;, err) } certPool := x509.NewCertPool() ca, err := os.ReadFile(\u0026#34;./keys/ca.crt\u0026#34;) if err != nil { log.Fatalf(\u0026#34;Failed to read ca: %v\u0026#34;, err) } if ok := certPool.AppendCertsFromPEM(ca); !ok { log.Fatalf(\u0026#34;Failed to append ca certificate\u0026#34;) } opts := []grpc.ServerOption{ grpc.Creds( // ä¸ºæ‰€æœ‰ä¼ å…¥çš„è¿æ¥å¯ç”¨TLS credentials.NewTLS(\u0026amp;tls.Config{ ClientAuth: tls.RequireAndVerifyClientCert, Certificates: []tls.Certificate{certificate}, ClientCAs: certPool, }, )), } listen, err := net.Listen(\u0026#34;tcp\u0026#34;, fmt.Sprintf(\u0026#34;0.0.0.0:%d\u0026#34;, 50051)) if err != nil { log.Fatalf(\u0026#34;failed to listen %d port\u0026#34;, 50051) } // é€šè¿‡ä¼ å…¥çš„TLSæœåŠ¡å™¨å‡­è¯åˆ›å»ºæ–°çš„gRPCæœåŠ¡å®ä¾‹ s := grpc.NewServer(opts...) api.RegisterGreeterServer(s, \u0026amp;server{}) log.Printf(\u0026#34;server listening at %v\u0026#34;, listen.Addr()) if err := s.Serve(listen); err != nil { log.Fatalf(\u0026#34;Failed to serve: %v\u0026#34;, err) } } client\nhttps://gist.github.com/hxzhouh/46a7a31e2696b87fe6fb83c8ce7e036c 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 func Test_server_SayHello(t *testing.T) { certificate, err := tls.LoadX509KeyPair(\u0026#34;./keys/client.crt\u0026#34;, \u0026#34;./keys/client.key\u0026#34;) if err != nil { log.Fatalf(\u0026#34;Failed to load client key pair, %v\u0026#34;, err) } certPool := x509.NewCertPool() ca, err := os.ReadFile(\u0026#34;./keys/ca.crt\u0026#34;) if err != nil { log.Fatalf(\u0026#34;Failed to read %s, error: %v\u0026#34;, \u0026#34;./keys/ca.crt\u0026#34;, err) } if ok := certPool.AppendCertsFromPEM(ca); !ok { log.Fatalf(\u0026#34;Failed to append ca certs\u0026#34;) } opts := []grpc.DialOption{ grpc.WithTransportCredentials(credentials.NewTLS( \u0026amp;tls.Config{ ServerName: \u0026#34;localhost\u0026#34;, Certificates: []tls.Certificate{certificate}, RootCAs: certPool, })), } // conn, err := grpc.Dial(*addr, grpc.WithTransportCredentials(insecure.NewCredentials())) conn, err := grpc.Dial(\u0026#34;localhost:50051\u0026#34;, opts...) if err != nil { log.Fatalf(\u0026#34;Connect to %s failed\u0026#34;, \u0026#34;localhost:50051\u0026#34;) } defer conn.Close() client := api.NewGreeterClient(conn) ctx, cancel := context.WithTimeout(context.Background(), time.Second*5) defer cancel() r, err := client.SayHello(ctx, \u0026amp;api.HelloRequest{Name: \u0026#34;Hello\u0026#34;}) if err != nil { log.Printf(\u0026#34;Failed to greet, error: %v\u0026#34;, err) } else { log.Printf(\u0026#34;Greeting: %v\u0026#34;, r.GetMessage()) } } è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å†æŠ“åŒ…ï¼Œç„¶åä½¿ç”¨ç›¸åŒçš„æ–¹å¼è§£æã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬ä¼šå‘ç°ï¼Œä½¿ç”¨HTTP2 å·²ç»æ— æ³•è§£å¯†äº†ï¼Œä½†æ˜¯å¯ä»¥è§£ç æˆ TLS1.3\næ€»ç»“ è¿™ç¯‡æ–‡ç« ï¼Œé¦–å…ˆæ€»ç»“äº†ä½¿ç”¨ Wireshark æŠ“gRPC åŒ…çš„ä¸€ä¸ªåŸºæœ¬æµç¨‹ã€‚\nç„¶åæˆ‘ä»¬é€šè¿‡æŠ“åŒ…çŸ¥é“äº†gRPCçš„å‚æ•°ä¼ é€’æ˜¯é€šè¿‡ HTTP2 çš„data-frameï¼ŒCTX ç­‰meta æ˜¯é€šè¿‡ header ä¼ é€’çš„ã€‚è¿™äº›çŸ¥è¯†æˆ‘ä»¬ä»¥å‰è‚¯å®šå¬è¿‡ï¼Œä½†æ˜¯åªæœ‰åŠ¨æ‰‹å®éªŒæ‰èƒ½åŠ æ·±ç†è§£ã€‚\né€šè¿‡TLS æˆ‘ä»¬å¯ä»¥å®ç° å®‰å…¨çš„gRPC é€šä¿¡ï¼Œä¸‹ä¸€ç¯‡æ–‡ç« ï¼Œæˆ‘ä»¬å°†å°è¯•è§£å¯†TLS æŠ¥æ–‡ã€‚\nå‚è€ƒèµ„æ–™ Wireshark Tutorial https://grpc.io/blog/wireshark/ https://www.lifewire.com/wireshark-tutorial-4143298 ","date":"2024-05-19T21:36:25Z","image":"https://images.yixiao9206.cn/blog-images/2024/05/a8ca43282aece789e1e0b1d2a2db7a5f.png","permalink":"https://huizhou92.com/zh-cn/p/how-to-capture-and-analyze-grpc-packets/","title":"ä½¿ç”¨ wireshark æŠ“åŒ…GRPC"},{"content":"æˆ‘æœ€è¿‘å‡ å¹´ä¸€ç›´å†æ‰“é€ è‡ªå·±çš„ç¬¬äºŒå¤§è„‘ï¼Œä¸‹é¢æ˜¯æˆ‘çš„å‡ ä¸ªç»éªŒæ•™è®­ã€‚\né¢‘ç¹åˆ‡æ¢ç¬”è®°è½¯ä»¶/åšå®¢ç³»ç»Ÿ æˆ‘å…ˆåä½¿ç”¨è¿‡ EverNoteï¼ŒWizNoteï¼ŒVNoteï¼ŒCSDN blogï¼ŒGoogle blogspot, WordPressï¼Œæœ€ç»ˆåªé€ æˆåšå®¢æ•£è½åœ¨å¤šä¸ªäº’è”ç½‘è§’è½ã€‚è§£å†³åŠæ³•å°±æ˜¯ all in one ã€‚æˆ‘ç°åœ¨é€‰æ‹©çš„æ˜¯Obsidian\né¢‘ç¹åˆ‡æ¢ç¬”è®°æ ¼å¼ æˆ‘å…ˆåä½¿ç”¨è¿‡ txt, orgmode, markdownï¼Œå¯Œæ–‡æœ¬ç­‰å¤šç§æ ¼å¼ï¼Œæœ€ç»ˆåªé€ æˆå„ç§æ ¼å¼è½¬æ¢çƒ¦æ¼ï¼Œè·Ÿç¬¬ä¸€æ¡ä¸€æ ·ï¼Œæ¯ä¸ªç¬”è®°ç³»ç»Ÿçš„æ ¼å¼å¯èƒ½ä¸é€šç”¨ï¼Œé€‰æ‹©Obsidiançš„åŸå› å°±æ˜¯å®ƒçš„markdownè¯­æ³•ã€‚å¦‚æœæˆ‘éœ€è¦ï¼Œæˆ‘å¯ä»¥è½»æ˜“çš„å°†å®ƒè¿ç§»åˆ°ä»»ä½•ç¬”è®°ç³»ç»Ÿï¼Œ\né—ªå¿µç¬”è®°å’ŒçœŸæ­£æœ‰ç”¨çš„ç¬”è®°æ··æ‚ é—ªå¿µç¬”è®°ç”¨äºå¿«é€Ÿæ•æ‰ä¸€ç¬é—´çš„çµæ„Ÿï¼Œä½†åªæœ‰ä½ åœ¨ä¸€ä¸¤å¤©å†…å›é¡¾å®ƒå¹¶æŠŠå®ƒå˜æˆæœ‰ç”¨çš„åˆé€‚çš„ç¬”è®°æ‰æœ‰æ„ä¹‰ã€‚å¦‚æœä¸åŠæ—¶å›é¡¾ï¼Œå¥½çš„æƒ³æ³•å°†æ·¹æ²¡åœ¨å¤§é‡çš„çªå‘å¥‡æƒ³ä¸­ã€‚æˆ‘ä»¬æ¯å¤©å¤§å¤šæ•°çš„æƒ³æ³•æ²¡æœ‰å¤ªå¤§æ„ä¹‰åº”è¯¥è¢«ä¸¢å¼ƒï¼Œè€Œé‚£äº›å¯ä»¥æˆä¸ºé‡å¤§æœ‰æ„ä¹‰çš„æƒ³æ³•æˆ‘ä»¬å¿…é¡»å°†ä»–ä»¬è¯†åˆ«å‡ºæ¥ã€‚\né¡¹ç›®ç¬”è®°å’ŒçŸ¥è¯†ç¬”è®°æ··æ‚ åªè®°å½•ç‰¹å®šé¡¹ç›®ç›¸å…³çš„ç¬”è®°ï¼Œå°†å¯¼è‡´é¡¹ç›®æœŸé—´æœ‰è¶£çš„è§‚ç‚¹æˆ–è€…æƒ³æ³•ä¿¡æ¯ä¸¢å¤±ã€‚æ­£ç¡®çš„åšæ³•æ˜¯åœ¨é¡¹ç›®ä¸­æå–é€šç”¨çš„çŸ¥è¯†ã€‚æˆ‘æ¨èä½¿ç”¨P.A.R.A æ–¹æ³•æ¥æ•´ç†ç¬”è®°ï¼Œæœ‰å…³P.A.R.A æ‚¨å¯ä»¥å‚è€ƒ è¿™ä¸ªç½‘é¡µ\né¢‘ç¹æ•´ç†ç¬”è®°çš„ã€Œæ´ç™–ã€ å¤§é‡å †ç§¯çš„ç¬”è®°å°†é€ æˆçŸ¥è¯†æ•´ç†å†²åŠ¨ï¼Œå¤šæ¥å‡ æ¬¡å°±ä¼šå½±å“åšæŒè®°å½•çš„ä¿¡å¿ƒã€‚è§£å†³æ–¹æ³•æ˜¯ï¼Œç¡®å®šè‡ªå·±å…³æ³¨çš„é¢†åŸŸå’Œè´Ÿè´£çš„è´£ä»»èŒƒå›´ï¼Œå¹¶ä¸å®Œå…¨é‡‡ç”¨è‡ªä¸‹è€Œä¸Šçš„çŸ¥è¯†ç®¡ç†æ–¹æ³•ã€‚åœ¨è¾¾åˆ°å¿ƒç†æŒ¤å‹ç‚¹æ—¶ï¼Œä½¿ç”¨ MOCSï¼ˆMaps of Contentï¼‰çš„æ–¹æ³•æ•´ç†ç¬”è®°ï¼ˆåŒé“¾ç»å¯¹æ˜¯ä½ å€¼å¾—å°è¯•çš„ã€‚ï¼‰ã€‚çŸ¥è¯†ç®¡ç†ç³»ç»Ÿæœ€é‡è¦çš„æ˜¯åœ¨åŒä¸€ä¸ªåœ°æ–¹ï¼Œç”¨åŒæ ·çš„æ ¼å¼å’Œä¸€è‡´çš„æ ‡å‡†è®°å½•ä½ çš„æ´è§ã€‚\n","date":"2024-05-06T10:19:00+08:00","image":"https://images.yixiao9206.cn/blog-images/2024/05/5ab6b54893dc2241704444526269572a.jpg","permalink":"https://huizhou92.com/zh-cn/p/crafting-your-second-brain-lessons-learned-from-my-note-taking-journey/","title":"çŸ¥è¯†ç®¡ç†çš„å‡ ä¸ªè¯¯åŒº"},{"content":"è¿›ç¨‹æ˜¯æ“ä½œç³»ç»Ÿçš„ä¼Ÿå¤§å‘æ˜ä¹‹ä¸€ï¼Œå¯¹åº”ç”¨ç¨‹åºå±è”½äº†CPUè°ƒåº¦ã€å†…å­˜ç®¡ç†ç­‰ç¡¬ä»¶ç»†èŠ‚ï¼Œè€ŒæŠ½è±¡å‡ºä¸€ä¸ªè¿›ç¨‹çš„æ¦‚å¿µï¼Œè®©åº”ç”¨ç¨‹åºä¸“å¿ƒäºå®ç°è‡ªå·±çš„ä¸šåŠ¡é€»è¾‘æ—¢å¯ï¼Œè€Œä¸”åœ¨æœ‰é™çš„CPUä¸Šå¯ä»¥â€œåŒæ—¶â€è¿›è¡Œè®¸å¤šä¸ªä»»åŠ¡ã€‚ä½†æ˜¯å®ƒä¸ºç”¨æˆ·å¸¦æ¥æ–¹ä¾¿çš„åŒæ—¶ï¼Œä¹Ÿå¼•å…¥äº†ä¸€äº›é¢å¤–çš„å¼€é”€ã€‚å¦‚ä¸‹å›¾ï¼Œåœ¨è¿›ç¨‹è¿è¡Œä¸­é—´çš„æ—¶é—´é‡Œï¼Œè™½ç„¶CPUä¹Ÿåœ¨å¿™äºå¹²æ´»ï¼Œä½†æ˜¯å´æ²¡æœ‰å®Œæˆä»»ä½•çš„ç”¨æˆ·å·¥ä½œï¼Œè¿™å°±æ˜¯è¿›ç¨‹æœºåˆ¶å¸¦æ¥çš„é¢å¤–å¼€é”€ã€‚\nåœ¨è¿›ç¨‹Aåˆ‡æ¢åˆ°è¿›ç¨‹Bçš„è¿‡ç¨‹ä¸­ï¼Œå…ˆä¿å­˜Aè¿›ç¨‹çš„ä¸Šä¸‹æ–‡ï¼Œä»¥ä¾¿äºç­‰Aæ¢å¤è¿è¡Œçš„æ—¶å€™ï¼Œèƒ½å¤ŸçŸ¥é“Aè¿›ç¨‹çš„ä¸‹ä¸€æ¡æŒ‡ä»¤æ˜¯å•¥ã€‚ç„¶åå°†è¦è¿è¡Œçš„Bè¿›ç¨‹çš„ä¸Šä¸‹æ–‡æ¢å¤åˆ°å¯„å­˜å™¨ä¸­ã€‚è¿™ä¸ªè¿‡ç¨‹è¢«ç§°ä¸ºä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚ä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€åœ¨è¿›ç¨‹ä¸å¤šã€åˆ‡æ¢ä¸é¢‘ç¹çš„åº”ç”¨åœºæ™¯ä¸‹é—®é¢˜ä¸å¤§ã€‚ä½†æ˜¯ç°åœ¨Linuxæ“ä½œç³»ç»Ÿè¢«ç”¨åˆ°äº†é«˜å¹¶å‘çš„ç½‘ç»œç¨‹åºåç«¯æœåŠ¡å™¨ã€‚åœ¨å•æœºæ”¯æŒæˆåƒä¸Šä¸‡ä¸ªç”¨æˆ·è¯·æ±‚çš„æ—¶å€™ï¼Œè¿™ä¸ªå¼€é”€å°±å¾—æ‹¿å‡ºæ¥è¯´é“è¯´é“äº†ã€‚å› ä¸ºç”¨æˆ·è¿›ç¨‹åœ¨è¯·æ±‚Redisã€Mysqlæ•°æ®ç­‰ç½‘ç»œIOé˜»å¡æ‰çš„æ—¶å€™ï¼Œæˆ–è€…åœ¨è¿›ç¨‹æ—¶é—´ç‰‡åˆ°äº†ï¼Œéƒ½ä¼šå¼•å‘ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚\nä¸€ä¸ªç®€å•çš„è¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€æµ‹è¯•å®éªŒ åºŸè¯ä¸å¤šè¯´ï¼Œæˆ‘ä»¬å…ˆç”¨ä¸ªå®éªŒæµ‹è¯•ä¸€ä¸‹ï¼Œåˆ°åº•ä¸€æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢éœ€è¦å¤šé•¿çš„CPUæ—¶é—´ï¼å®éªŒæ–¹æ³•æ˜¯åˆ›å»ºä¸¤ä¸ªè¿›ç¨‹å¹¶åœ¨å®ƒä»¬ä¹‹é—´ä¼ é€ä¸€ä¸ªä»¤ç‰Œã€‚å…¶ä¸­ä¸€ä¸ªè¿›ç¨‹åœ¨è¯»å–ä»¤ç‰Œæ—¶å°±ä¼šå¼•èµ·é˜»å¡ã€‚å¦ä¸€ä¸ªè¿›ç¨‹å‘é€ä»¤ç‰Œåç­‰å¾…å…¶è¿”å›æ—¶ä¹Ÿå¤„äºé˜»å¡çŠ¶æ€ã€‚å¦‚æ­¤å¾€è¿”ä¼ é€ä¸€å®šçš„æ¬¡æ•°ï¼Œç„¶åç»Ÿè®¡ä»–ä»¬çš„å¹³å‡å•æ¬¡åˆ‡æ¢æ—¶é—´å¼€é”€ã€‚\ntest04\n1 2 3 4 # gcc main.c -o main # ./main./main Before Context Switch Time1565352257 s, 774767 us After Context SWitch Time1565352257 s, 842852 us æ¯æ¬¡æ‰§è¡Œçš„æ—¶é—´ä¼šæœ‰å·®å¼‚ï¼Œå¤šæ¬¡è¿è¡Œåå¹³å‡æ¯æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢è€—æ—¶3.5uså·¦å³ã€‚å½“ç„¶äº†è¿™ä¸ªæ•°å­—å› æœºå™¨è€Œå¼‚ï¼Œè€Œä¸”å»ºè®®åœ¨å®æœºä¸Šæµ‹è¯•ã€‚\nå‰é¢æˆ‘ä»¬æµ‹è¯•ç³»ç»Ÿè°ƒç”¨çš„æ—¶å€™ï¼Œæœ€ä½å€¼æ˜¯200nsã€‚å¯è§ï¼Œä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€è¦æ¯”ç³»ç»Ÿè°ƒç”¨çš„å¼€é”€è¦å¤§ã€‚ç³»ç»Ÿè°ƒç”¨åªæ˜¯åœ¨è¿›ç¨‹å†…å°†ç”¨æˆ·æ€åˆ‡æ¢åˆ°å†…æ ¸æ€ï¼Œç„¶åå†åˆ‡å›æ¥ï¼Œè€Œä¸Šä¸‹æ–‡åˆ‡æ¢å¯æ˜¯ç›´æ¥ä»è¿›ç¨‹Aåˆ‡æ¢åˆ°äº†è¿›ç¨‹Bã€‚æ˜¾ç„¶è¿™ä¸ªä¸Šä¸‹æ–‡åˆ‡æ¢éœ€è¦å®Œæˆçš„å·¥ä½œé‡æ›´å¤§ã€‚\nè¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€éƒ½æœ‰å“ªäº› é‚£ä¹ˆä¸Šä¸‹æ–‡åˆ‡æ¢çš„æ—¶å€™ï¼ŒCPUçš„å¼€é”€éƒ½å…·ä½“æœ‰å“ªäº›å‘¢ï¼Ÿå¼€é”€åˆ†æˆä¸¤ç§ï¼Œä¸€ç§æ˜¯ç›´æ¥å¼€é”€ã€ä¸€ç§æ˜¯é—´æ¥å¼€é”€ã€‚\nç›´æ¥å¼€é”€å°±æ˜¯åœ¨åˆ‡æ¢æ—¶ï¼Œcpuå¿…é¡»åšçš„äº‹æƒ…ï¼ŒåŒ…æ‹¬ï¼š\n1ã€==åˆ‡æ¢é¡µè¡¨å…¨å±€ç›®å½•== 2ã€==åˆ‡æ¢å†…æ ¸æ€å †æ ˆ== 3ã€==åˆ‡æ¢ç¡¬ä»¶ä¸Šä¸‹æ–‡==ï¼ˆè¿›ç¨‹æ¢å¤å‰ï¼Œå¿…é¡»è£…å…¥å¯„å­˜å™¨çš„æ•°æ®ç»Ÿç§°ä¸ºç¡¬ä»¶ä¸Šä¸‹æ–‡ï¼‰ ip(instruction pointer)ï¼šæŒ‡å‘å½“å‰æ‰§è¡ŒæŒ‡ä»¤çš„ä¸‹ä¸€æ¡æŒ‡ä»¤ bp(base pointer): ç”¨äºå­˜æ”¾æ‰§è¡Œä¸­çš„å‡½æ•°å¯¹åº”çš„æ ˆå¸§çš„æ ˆåº•åœ°å€ sp(stack poinger): ç”¨äºå­˜æ”¾æ‰§è¡Œä¸­çš„å‡½æ•°å¯¹åº”çš„æ ˆå¸§çš„æ ˆé¡¶åœ°å€ cr3:é¡µç›®å½•åŸºå€å¯„å­˜å™¨ï¼Œä¿å­˜é¡µç›®å½•è¡¨çš„ç‰©ç†åœ°å€ \u0026hellip;\u0026hellip; 4ã€åˆ·æ–°TLB 5ã€ç³»ç»Ÿè°ƒåº¦å™¨çš„ä»£ç æ‰§è¡Œ é—´æ¥å¼€é”€ä¸»è¦æŒ‡çš„æ˜¯è™½ç„¶åˆ‡æ¢åˆ°ä¸€ä¸ªæ–°è¿›ç¨‹åï¼Œ==ç”±äºå„ç§ç¼“å­˜å¹¶ä¸çƒ­ï¼Œé€Ÿåº¦è¿è¡Œä¼šæ…¢ä¸€äº›==ã€‚å¦‚æœè¿›ç¨‹å§‹ç»ˆéƒ½åœ¨ä¸€ä¸ªCPUä¸Šè°ƒåº¦è¿˜å¥½ä¸€äº›ï¼Œå¦‚æœè·¨CPUçš„è¯ï¼Œä¹‹å‰çƒ­èµ·æ¥çš„TLBã€L1ã€L2ã€L3å› ä¸ºè¿è¡Œçš„è¿›ç¨‹å·²ç»å˜äº†ï¼Œæ‰€ä»¥ä»¥å±€éƒ¨æ€§åŸç†cacheèµ·æ¥çš„ä»£ç ã€æ•°æ®ä¹Ÿéƒ½æ²¡æœ‰ç”¨äº†ï¼Œå¯¼è‡´æ–°è¿›ç¨‹ç©¿é€åˆ°å†…å­˜çš„IOä¼šå˜å¤šã€‚ å…¶å®æˆ‘ä»¬ä¸Šé¢çš„å®éªŒå¹¶æ²¡æœ‰å¾ˆå¥½åœ°æµ‹é‡åˆ°è¿™ç§æƒ…å†µï¼Œæ‰€ä»¥å®é™…çš„ä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€å¯èƒ½æ¯”3.5usè¦å¤§ã€‚\næƒ³äº†è§£æ›´è¯¦ç»†æ“ä½œè¿‡ç¨‹çš„åŒå­¦è¯·å‚è€ƒã€Šæ·±å…¥ç†è§£Linuxå†…æ ¸ã€‹ä¸­çš„ç¬¬ä¸‰ç« å’Œç¬¬ä¹ç« ã€‚\nä¸€ä¸ªæ›´ä¸ºä¸“ä¸šçš„æµ‹è¯•å·¥å…·-lmbench lmbenchç”¨äºè¯„ä»·ç³»ç»Ÿç»¼åˆæ€§èƒ½çš„å¤šå¹³å°å¼€æºbenchmarkï¼Œèƒ½å¤Ÿæµ‹è¯•åŒ…æ‹¬æ–‡æ¡£è¯»å†™ã€å†…å­˜æ“ä½œã€è¿›ç¨‹åˆ›å»ºé”€æ¯å¼€é”€ã€ç½‘ç»œç­‰æ€§èƒ½ã€‚ä½¿ç”¨æ–¹æ³•ç®€å•ï¼Œä½†å°±æ˜¯è·‘æœ‰ç‚¹æ…¢ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥è‡ªå·±è¯•ä¸€è¯•ã€‚\nè¿™ä¸ªå·¥å…·çš„ä¼˜åŠ¿æ˜¯æ˜¯è¿›è¡Œäº†å¤šç»„å®éªŒï¼Œæ¯ç»„2ä¸ªè¿›ç¨‹ã€8ä¸ªã€16ä¸ªã€‚æ¯ä¸ªè¿›ç¨‹ä½¿ç”¨çš„æ•°æ®å¤§å°ä¹Ÿåœ¨å˜ï¼Œå……åˆ†æ¨¡æ‹Ÿcache missé€ æˆçš„å½±å“ã€‚æˆ‘ç”¨ä»–æµ‹äº†ä¸€ä¸‹ç»“æœå¦‚ä¸‹ï¼š\n1 2 3 4 5 ------------------------------------------------------------------------- Host OS 2p/0K 2p/16K 2p/64K 8p/16K 8p/64K 16p/16K 16p/64K ctxsw ctxsw ctxsw ctxsw ctxsw ctxsw ctxsw --------- ------------- ------ ------ ------ ------ ------ ------- ------- bjzw_46_7 Linux 2.6.32- 2.7800 2.7800 2.7000 4.3800 4.0400 4.75000 5.48000 lmbenchæ˜¾ç¤ºçš„è¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢è€—æ—¶ä»2.7usåˆ°5.48ä¹‹é—´ã€‚\nçº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢è€—æ—¶ å‰é¢æˆ‘ä»¬æµ‹è¯•äº†è¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢çš„å¼€é”€ï¼Œæˆ‘ä»¬å†ç»§ç»­åœ¨Linuxæµ‹è¯•ä¸€ä¸‹çº¿ç¨‹ã€‚çœ‹çœ‹ç©¶ç«Ÿæ¯”è¿›ç¨‹èƒ½ä¸èƒ½å¿«ä¸€äº›ï¼Œå¿«çš„è¯èƒ½å¿«å¤šå°‘ã€‚\nåœ¨Linuxä¸‹å…¶å®æœ¬å¹¶æ²¡æœ‰çº¿ç¨‹ï¼Œåªæ˜¯ä¸ºäº†è¿åˆå¼€å‘è€…å£å‘³ï¼Œæäº†ä¸ªè½»é‡çº§è¿›ç¨‹å‡ºæ¥å°±å«åšäº†çº¿ç¨‹ã€‚è½»é‡çº§è¿›ç¨‹å’Œè¿›ç¨‹ä¸€æ ·ï¼Œéƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„task_structè¿›ç¨‹æè¿°ç¬¦ï¼Œä¹Ÿéƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„pidã€‚ä»æ“ä½œç³»ç»Ÿè§†è§’çœ‹ï¼Œè°ƒåº¦ä¸Šå’Œè¿›ç¨‹æ²¡æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Œéƒ½æ˜¯åœ¨ç­‰å¾…é˜Ÿåˆ—çš„åŒå‘é“¾è¡¨é‡Œé€‰æ‹©ä¸€ä¸ªtask_structåˆ‡åˆ°è¿è¡Œæ€è€Œå·²ã€‚åªä¸è¿‡è½»é‡çº§è¿›ç¨‹å’Œæ™®é€šè¿›ç¨‹çš„åŒºåˆ«æ˜¯å¯ä»¥å…±äº«åŒä¸€å†…å­˜åœ°å€ç©ºé—´ã€ä»£ç æ®µã€å…¨å±€å˜é‡ã€åŒä¸€æ‰“å¼€æ–‡ä»¶é›†åˆè€Œå·²ã€‚\nåŒä¸€è¿›ç¨‹ä¸‹çš„çº¿ç¨‹ä¹‹æ‰€æœ‰getpid()çœ‹åˆ°çš„pidæ˜¯ä¸€æ ·çš„ï¼Œå…¶å®task_structé‡Œè¿˜æœ‰ä¸€ä¸ªtgidå­—æ®µã€‚ å¯¹äºå¤šçº¿ç¨‹ç¨‹åºæ¥è¯´ï¼Œgetpid()ç³»ç»Ÿè°ƒç”¨è·å–çš„å®é™…ä¸Šæ˜¯è¿™ä¸ªtgidï¼Œå› æ­¤éš¶å±åŒä¸€è¿›ç¨‹çš„å¤šçº¿ç¨‹çœ‹èµ·æ¥PIDç›¸åŒã€‚\næˆ‘ä»¬ç”¨ä¸€ä¸ªå®éªŒæ¥æµ‹è¯•ä¸€ä¸‹test06ã€‚å…¶åŸç†å’Œè¿›ç¨‹æµ‹è¯•å·®ä¸å¤šï¼Œåˆ›å»ºäº†20ä¸ªçº¿ç¨‹ï¼Œåœ¨çº¿ç¨‹ä¹‹é—´é€šè¿‡ç®¡é“æ¥ä¼ é€’ä¿¡å·ã€‚æ¥åˆ°ä¿¡å·å°±å”¤é†’ï¼Œç„¶åå†ä¼ é€’ä¿¡å·ç»™ä¸‹ä¸€ä¸ªçº¿ç¨‹ï¼Œè‡ªå·±ç¡çœ ã€‚ è¿™ä¸ªå®éªŒé‡Œå•ç‹¬è€ƒè™‘äº†ç»™ç®¡é“ä¼ é€’ä¿¡å·çš„é¢å¤–å¼€é”€ï¼Œå¹¶åœ¨ç¬¬ä¸€æ­¥å°±ç»Ÿè®¡äº†å‡ºæ¥ã€‚\n1 2 3 # gcc -lpthread main.c -o main 0.508250 4.363495 æ¯æ¬¡å®éªŒç»“æœä¼šæœ‰ä¸€äº›å·®å¼‚ï¼Œä¸Šé¢çš„ç»“æœæ˜¯å–äº†å¤šæ¬¡çš„ç»“æœä¹‹åç„¶åå¹³å‡çš„ï¼Œå¤§çº¦æ¯æ¬¡çº¿ç¨‹åˆ‡æ¢å¼€é”€å¤§çº¦æ˜¯3.8uså·¦å³ã€‚ä»ä¸Šä¸‹æ–‡åˆ‡æ¢çš„è€—æ—¶ä¸Šæ¥çœ‹ï¼ŒLinuxçº¿ç¨‹ï¼ˆè½»é‡çº§è¿›ç¨‹ï¼‰å…¶å®å’Œè¿›ç¨‹å·®åˆ«ä¸å¤ªå¤§ã€‚\nLinuxç›¸å…³å‘½ä»¤ æ—¢ç„¶æˆ‘ä»¬çŸ¥é“äº†ä¸Šä¸‹æ–‡åˆ‡æ¢æ¯”è¾ƒçš„æ¶ˆè€—CPUæ—¶é—´ï¼Œé‚£ä¹ˆæˆ‘ä»¬é€šè¿‡ä»€ä¹ˆå·¥å…·å¯ä»¥æŸ¥çœ‹ä¸€ä¸‹Linuxé‡Œç©¶ç«Ÿåœ¨å‘ç”Ÿå¤šå°‘åˆ‡æ¢å‘¢ï¼Ÿå¦‚æœä¸Šä¸‹æ–‡åˆ‡æ¢å·²ç»å½±å“åˆ°äº†ç³»ç»Ÿæ•´ä½“æ€§èƒ½ï¼Œæˆ‘ä»¬æœ‰æ²¡æœ‰åŠæ³•æŠŠæœ‰é—®é¢˜çš„è¿›ç¨‹æªå‡ºæ¥ï¼Œå¹¶æŠŠå®ƒä¼˜åŒ–æ‰å‘¢ï¼Ÿ\n1 2 3 4 5 6 7 8 # vmstat 1 procs -----------memory---------- ---swap-- -----io---- --system-- -----cpu----- r b swpd free buff cache si so bi bo in cs us sy id wa st 2 0 0 595504 5724 190884 0 0 295 297 0 0 14 6 75 0 4 5 0 0 593016 5732 193288 0 0 0 92 19889 29104 20 6 67 0 7 3 0 0 591292 5732 195476 0 0 0 0 20151 28487 20 6 66 0 8 4 0 0 589296 5732 196800 0 0 116 384 19326 27693 20 7 67 0 7 4 0 0 586956 5740 199496 0 0 216 24 18321 24018 22 8 62 0 8 æˆ–è€…æ˜¯\n1 2 3 4 5 6 7 8 9 10 11 12 13 # sar -w 1 proc/s Total number of tasks created per second. cswch/s Total number of context switches per second. 11:19:20 AM proc/s cswch/s 11:19:21 AM 110.28 23468.22 11:19:22 AM 128.85 33910.58 11:19:23 AM 47.52 40733.66 11:19:24 AM 35.85 30972.64 11:19:25 AM 47.62 24951.43 11:19:26 AM 47.52 42950.50 ...... ä¸Šå›¾çš„ç¯å¢ƒæ˜¯ä¸€å°ç”Ÿäº§ç¯å¢ƒæœºå™¨ï¼Œé…ç½®æ˜¯8æ ¸8Gçš„KVMè™šæœºï¼Œç¯å¢ƒæ˜¯åœ¨nginx+fpmçš„ï¼Œfpmæ•°é‡ä¸º1000ï¼Œå¹³å‡æ¯ç§’å¤„ç†çš„ç”¨æˆ·æ¥å£è¯·æ±‚å¤§çº¦100å·¦å³ã€‚å…¶ä¸­csåˆ—è¡¨ç¤ºçš„å°±æ˜¯åœ¨1så†…ç³»ç»Ÿå‘ç”Ÿçš„ä¸Šä¸‹æ–‡åˆ‡æ¢æ¬¡æ•°ï¼Œå¤§çº¦1såˆ‡æ¢æ¬¡æ•°éƒ½è¾¾åˆ°4Wæ¬¡äº†ã€‚ç²—ç•¥ä¼°ç®—ä¸€ä¸‹ï¼Œæ¯æ ¸å¤§çº¦æ¯ç§’éœ€è¦åˆ‡æ¢5Kæ¬¡ï¼Œåˆ™1så†…éœ€è¦èŠ±å°†è¿‘20msåœ¨ä¸Šä¸‹æ–‡åˆ‡æ¢ä¸Šã€‚è¦çŸ¥é“è¿™æ˜¯è™šæœºï¼Œæœ¬èº«åœ¨è™šæ‹ŸåŒ–ä¸Šè¿˜ä¼šæœ‰ä¸€äº›é¢å¤–å¼€é”€ï¼Œè€Œä¸”è¿˜è¦çœŸæ­£æ¶ˆè€—CPUåœ¨ç”¨æˆ·æ¥å£é€»è¾‘å¤„ç†ã€ç³»ç»Ÿè°ƒç”¨å†…æ ¸é€»è¾‘å¤„ç†ã€ä»¥åŠç½‘ç»œè¿æ¥çš„å¤„ç†ä»¥åŠè½¯ä¸­æ–­ï¼Œæ‰€ä»¥20msçš„å¼€é”€å®é™…ä¸Šä¸ä½äº†ã€‚\né‚£ä¹ˆè¿›ä¸€æ­¥ï¼Œæˆ‘ä»¬çœ‹ä¸‹åˆ°åº•æ˜¯å“ªäº›è¿›ç¨‹å¯¼è‡´äº†é¢‘ç¹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Ÿ\n1 2 3 4 5 6 # pidstat -w 1 11:07:56 AM PID cswch/s nvcswch/s Command 11:07:56 AM 32316 4.00 0.00 php-fpm 11:07:56 AM 32508 160.00 34.00 php-fpm 11:07:56 AM 32726 131.00 8.00 php-fpm ...... ç”±äºfpmæ˜¯åŒæ­¥é˜»å¡çš„æ¨¡å¼ï¼Œæ¯å½“è¯·æ±‚Redisã€Memcacheã€Mysqlçš„æ—¶å€™å°±ä¼šé˜»å¡å¯¼è‡´cswch/sè‡ªæ„¿ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œè€Œåªæœ‰æ—¶é—´ç‰‡åˆ°äº†ä¹‹åæ‰ä¼šè§¦å‘nvcswch/séè‡ªæ„¿åˆ‡æ¢ã€‚å¯è§fpmè¿›ç¨‹å¤§éƒ¨åˆ†çš„åˆ‡æ¢éƒ½æ˜¯è‡ªæ„¿çš„ã€éè‡ªæ„¿çš„æ¯”è¾ƒå°‘ã€‚\nå¦‚æœæƒ³æŸ¥çœ‹å…·ä½“æŸä¸ªè¿›ç¨‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢æ€»æƒ…å†µï¼Œå¯ä»¥åœ¨/procæ¥å£ä¸‹ç›´æ¥çœ‹ï¼Œä¸è¿‡è¿™ä¸ªæ˜¯æ€»å€¼ã€‚\n1 2 3 grep ctxt /proc/32583/status voluntary_ctxt_switches: 573066 nonvoluntary_ctxt_switches: 89260 ç»“è®º ä¸Šä¸‹æ–‡åˆ‡æ¢å…·ä½“åšå“ªäº›äº‹æƒ…æˆ‘ä»¬æ²¡æœ‰å¿…è¦è®°ï¼Œåªéœ€è¦è®°ä½ä¸€ä¸ªç»“è®ºæ—¢å¯ï¼Œåœ¨æˆ‘çš„å·¥ä½œæœºä¸Šä¸‹æ–‡åˆ‡æ¢çš„å¼€é”€å¤§çº¦æ˜¯2.7-5.48uså·¦å³ï¼Œä½ è‡ªå·±çš„æœºå™¨å¯ä»¥ç”¨æˆ‘æä¾›çš„ä»£ç æˆ–å·¥å…·è¿›è¡Œä¸€ç•ªæµ‹è¯•ã€‚ å¯ä»¥ä½¿ç”¨ vmstat sar ç­‰å·¥å…·æŸ¥çœ‹è¿›ç¨‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œè¿›è€Œå®šä½æ€§èƒ½é—®é¢˜ã€‚ lmbenchç›¸å¯¹æ›´å‡†ç¡®ä¸€äº›ï¼Œå› ä¸ºè€ƒè™‘äº†åˆ‡æ¢åCache misså¯¼è‡´çš„é¢å¤–å¼€é”€ã€‚ ","date":"2024-03-19T18:45:00Z","permalink":"https://huizhou92.com/zh-cn/p/the-time-in-the-computers-context-switching/","title":"è®¡ç®—æœºä¸­çš„æ—¶é—´ çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ä¼šç”¨æ‰ä½ å¤šå°‘CPUï¼Ÿ"}]